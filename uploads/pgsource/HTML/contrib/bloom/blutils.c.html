<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\bloom\blutils.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\bloom\blutils.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:24 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * blutils.c 
 *      Bloom index utilities. 
 * 
 * Portions Copyright (c) 2016-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1990-1993, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    contrib/bloom/blutils.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/amapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/generic_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/indexfsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/freespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/indexfsm.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"bloom.h"</span> 
 
<span class='Comment_Multi_Line'>/* Signature dealing macros - note i is assumed to be of type int */ 
</span><a name="LN30"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>GETWORD</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>i</span><span class='Parentheses'>) (</span> <span class='Operator'>*</span><span class='Parentheses'>(</span> <span class='Parentheses'>(</span><a href="bloom.h.html#LN82"><span class='Ref_to_Typedef'>BloomSignatureWord</span></a> <span class='Operator'>*</span><span class='Parentheses'>)(</span><a href="blutils.c.html#LN30"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Parentheses'>(</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN30"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a> <span class='Parentheses'>)</span> <span class='Parentheses'>)</span> <span class='Parentheses'>)</span> 
<a name="LN31"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>CLRBIT</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>i</span><span class='Parentheses'>)</span>   <a href="blutils.c.html#LN30"><span class='Ref_to_Macro'>GETWORD</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN31"><span class='Ref_to_Parameter'>x</span></a><span class='Delimiter'>,</span><a href="blutils.c.html#LN31"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>&= ~</span><span class='Parentheses'>(</span> <span class='Number'>0x01</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN31"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a> <span class='Parentheses'>)</span> <span class='Parentheses'>)</span> 
<a name="LN32"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SETBIT</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>i</span><span class='Parentheses'>)</span>   <a href="blutils.c.html#LN30"><span class='Ref_to_Macro'>GETWORD</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN32"><span class='Ref_to_Parameter'>x</span></a><span class='Delimiter'>,</span><a href="blutils.c.html#LN32"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>|=</span>  <span class='Parentheses'>(</span> <span class='Number'>0x01</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN32"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a> <span class='Parentheses'>)</span> <span class='Parentheses'>)</span> 
<a name="LN33"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>GETBIT</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>i</span><span class='Parentheses'>) (</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN30"><span class='Ref_to_Macro'>GETWORD</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN33"><span class='Ref_to_Parameter'>x</span></a><span class='Delimiter'>,</span><a href="blutils.c.html#LN33"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT;&GT; </span><span class='Parentheses'>(</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN33"><span class='Ref_to_Parameter'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a> <span class='Parentheses'>))</span> <span class='Operator'>& </span><span class='Number'>0x01</span> <span class='Parentheses'>)</span> 
 
<a name="LN35"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="blutils.c.html#LN103"><span class='Ref_to_Func'>blhandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Kind of relation options for bloom index */ 
</span><a name="LN38"></a><span class='Keyword'>static </span><a href="../../src/include/access/reloptions.h.html#LN37"><span class='Ref_to_Enum'>relopt_kind</span></a> <span class='Declare_Var'>bl_relopt_kind</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* parse table for fillRelOptions */ 
</span><a name="LN41"></a><span class='Keyword'>static </span><a href="../../src/include/access/reloptions.h.html#LN122"><span class='Ref_to_Typedef'>relopt_parse_elt</span></a> <span class='Declare_Var'>bl_relopt_tab</span><span class='Delimiter'>[</span><a href="../../src/include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
<a name="LN43"></a><span class='Keyword'>static </span><a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Prototype'>myRand</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN44"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>mySrand</span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>seed</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Module initialize function: initialize info about Bloom relation options. 
 * 
 * Note: keep this in sync with makeDefaultBloomOptions(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN52"></a><span class='Declare_Function'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN54"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN55"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span> 
    <a href="blutils.c.html#LN38"><span class='Ref_to_Global_Var'>bl_relopt_kind</span></a> <span class='Operator'>= </span><a href="../../src/include/access/reloptions.h.html#LN247"><span class='Ref_to_Proto'>add_reloption_kind</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Option for length of signature */ 
</span>    <a href="../../src/include/access/reloptions.h.html#LN250"><span class='Ref_to_Proto'>add_int_reloption</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN38"><span class='Ref_to_Global_Var'>bl_relopt_kind</span></a><span class='Delimiter'>, </span><span class='String'>"length"</span><span class='Delimiter'>, 
</span>                      <span class='String'>"Length of signature in bits"</span><span class='Delimiter'>, 
</span>                      <a href="bloom.h.html#LN89"><span class='Ref_to_Const'>DEFAULT_BLOOM_LENGTH</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="bloom.h.html#LN90"><span class='Ref_to_Const'>MAX_BLOOM_LENGTH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/access/reloptions.h.html#LN124"><span class='Ref_to_Member'>optname</span></a> <span class='Operator'>= </span><span class='String'>"length"</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/access/reloptions.h.html#LN125"><span class='Ref_to_Member'>opttype</span></a> <span class='Operator'>= </span><a href="../../src/include/access/reloptions.h.html#LN31"><span class='Ref_to_EnumConst'>RELOPT_TYPE_INT</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/access/reloptions.h.html#LN126"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>= </span><a href="../../src/include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Delimiter'>, </span>bloomLength<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Number of bits for each possible index column: col1, col2, ... */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../src/include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>; </span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN55"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="blutils.c.html#LN55"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"col%d"</span><span class='Delimiter'>, </span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/access/reloptions.h.html#LN250"><span class='Ref_to_Proto'>add_int_reloption</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN38"><span class='Ref_to_Global_Var'>bl_relopt_kind</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN55"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                          <span class='String'>"Number of bits generated for each index column"</span><span class='Delimiter'>, 
</span>                          <a href="bloom.h.html#LN95"><span class='Ref_to_Const'>DEFAULT_BLOOM_BITS</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="bloom.h.html#LN96"><span class='Ref_to_Const'>MAX_BLOOM_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/access/reloptions.h.html#LN124"><span class='Ref_to_Member'>optname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                                           <a href="blutils.c.html#LN55"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/access/reloptions.h.html#LN125"><span class='Ref_to_Member'>opttype</span></a> <span class='Operator'>= </span><a href="../../src/include/access/reloptions.h.html#LN31"><span class='Ref_to_EnumConst'>RELOPT_TYPE_INT</span></a><span class='Delimiter'>; 
</span>        <a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/access/reloptions.h.html#LN126"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>= </span><a href="../../src/include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Delimiter'>, </span>bitSize<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="blutils.c.html#LN54"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end _PG_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct a default set of Bloom options. 
 */ 
</span><span class='Keyword'>static </span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>* 
</span><a name="LN85"></a><span class='Declare_Function'>makeDefaultBloomOptions</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN87"></a>    <a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opts</span><span class='Delimiter'>; 
</span><a name="LN88"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN87"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Convert DEFAULT_BLOOM_LENGTH from # of bits to # of words */ 
</span>    <a href="blutils.c.html#LN87"><span class='Ref_To_Local'>opts</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN102"><span class='Ref_to_Member'>bloomLength</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="bloom.h.html#LN89"><span class='Ref_to_Const'>DEFAULT_BLOOM_LENGTH</span></a> <span class='Operator'>+ </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN88"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="blutils.c.html#LN88"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../src/include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>; </span><a href="blutils.c.html#LN88"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="blutils.c.html#LN87"><span class='Ref_To_Local'>opts</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN103"><span class='Ref_to_Member'>bitSize</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN88"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="bloom.h.html#LN95"><span class='Ref_to_Const'>DEFAULT_BLOOM_BITS</span></a><span class='Delimiter'>; 
</span>    <a href="../../src/include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN87"><span class='Ref_To_Local'>opts</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="blutils.c.html#LN87"><span class='Ref_To_Local'>opts</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Bloom handler function: return IndexAmRoutine with access method parameters 
 * and callbacks. 
 */ 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN104"></a><span class='Declare_Function'>blhandler</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN106"></a>    <a href="../../src/include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amroutine</span> <span class='Operator'>= </span><a href="../../src/include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../src/include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN166"><span class='Ref_to_Member'>amstrategies</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN28"><span class='Ref_to_Const'>BLOOM_NSTRATEGIES</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN168"><span class='Ref_to_Member'>amsupport</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN24"><span class='Ref_to_Const'>BLOOM_NPROC</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN172"><span class='Ref_to_Member'>amcanorderbyop</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN174"><span class='Ref_to_Member'>amcanbackward</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN176"><span class='Ref_to_Member'>amcanunique</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN178"><span class='Ref_to_Member'>amcanmulticol</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN180"><span class='Ref_to_Member'>amoptionalkey</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN182"><span class='Ref_to_Member'>amsearcharray</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN184"><span class='Ref_to_Member'>amsearchnulls</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN186"><span class='Ref_to_Member'>amstorage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN188"><span class='Ref_to_Member'>amclusterable</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN190"><span class='Ref_to_Member'>ampredlocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN192"><span class='Ref_to_Member'>amcanparallel</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN194"><span class='Ref_to_Member'>amkeytype</span></a> <span class='Operator'>= </span><a href="../../src/include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN197"><span class='Ref_to_Member'>ambuild</span></a> <span class='Operator'>= </span><a href="blinsert.c.html#LN113"><span class='Ref_to_Func'>blbuild</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN198"><span class='Ref_to_Member'>ambuildempty</span></a> <span class='Operator'>= </span><a href="blinsert.c.html#LN157"><span class='Ref_to_Func'>blbuildempty</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN199"><span class='Ref_to_Member'>aminsert</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN189"><span class='Ref_to_Proto'>blinsert</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN200"><span class='Ref_to_Member'>ambulkdelete</span></a> <span class='Operator'>= </span><a href="blvacuum.c.html#LN32"><span class='Ref_to_Func'>blbulkdelete</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN201"><span class='Ref_to_Member'>amvacuumcleanup</span></a> <span class='Operator'>= </span><a href="blvacuum.c.html#LN167"><span class='Ref_to_Func'>blvacuumcleanup</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN202"><span class='Ref_to_Member'>amcanreturn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN203"><span class='Ref_to_Member'>amcostestimate</span></a> <span class='Operator'>= </span><a href="blcost.c.html#LN23"><span class='Ref_to_Func'>blcostestimate</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN204"><span class='Ref_to_Member'>amoptions</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN206"><span class='Ref_to_Proto'>bloptions</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN205"><span class='Ref_to_Member'>amproperty</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN206"><span class='Ref_to_Member'>amvalidate</span></a> <span class='Operator'>= </span><a href="blvalidate.c.html#LN31"><span class='Ref_to_Func'>blvalidate</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN207"><span class='Ref_to_Member'>ambeginscan</span></a> <span class='Operator'>= </span><a href="blscan.c.html#LN27"><span class='Ref_to_Func'>blbeginscan</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN208"><span class='Ref_to_Member'>amrescan</span></a> <span class='Operator'>= </span><a href="blscan.c.html#LN47"><span class='Ref_to_Func'>blrescan</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN209"><span class='Ref_to_Member'>amgettuple</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN210"><span class='Ref_to_Member'>amgetbitmap</span></a> <span class='Operator'>= </span><a href="blscan.c.html#LN80"><span class='Ref_to_Func'>blgetbitmap</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN211"><span class='Ref_to_Member'>amendscan</span></a> <span class='Operator'>= </span><a href="blscan.c.html#LN67"><span class='Ref_to_Func'>blendscan</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN212"><span class='Ref_to_Member'>ammarkpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN213"><span class='Ref_to_Member'>amrestrpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN216"><span class='Ref_to_Member'>amestimateparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN217"><span class='Ref_to_Member'>aminitparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/amapi.h.html#LN218"><span class='Ref_to_Member'>amparallelrescan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN106"><span class='Ref_To_Local'>amroutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end blhandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fill BloomState structure for particular index. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN152"></a><span class='Declare_Function'>initBloomState</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN136"><span class='Ref_to_Struct'>BloomState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN154"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN140"><span class='Ref_to_Member'>nColumns</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize hash function for each attribute */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN154"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="blutils.c.html#LN154"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="blutils.c.html#LN154"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN138"><span class='Ref_to_Member'>hashFn</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN154"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../src/include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN154"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="bloom.h.html#LN23"><span class='Ref_to_Const'>BLOOM_HASH_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../src/backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize amcache if needed with options from metapage */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN169"></a>        <a href="../../src/include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN170"></a>        <a href="../../src/include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN171"></a>        <a href="bloom.h.html#LN119"><span class='Ref_to_Struct'>BloomMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>meta</span><span class='Delimiter'>; 
</span><a name="LN172"></a>        <a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opts</span><span class='Delimiter'>; 
</span> 
        <a href="blutils.c.html#LN172"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN178"><span class='Ref_to_Member'>rd_indexcxt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="blutils.c.html#LN169"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../src/include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="bloom.h.html#LN76"><span class='Ref_to_Const'>BLOOM_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN169"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="blutils.c.html#LN170"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../src/include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN169"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="bloom.h.html#LN60"><span class='Ref_to_Macro'>BloomPageIsMeta</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN170"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"Relation is not a bloom index"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="blutils.c.html#LN171"><span class='Ref_To_Local'>meta</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN134"><span class='Ref_to_Macro'>BloomPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../src/include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN169"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN171"><span class='Ref_To_Local'>meta</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN121"><span class='Ref_to_Member'>magickNumber</span></a> <span class='Operator'>!= </span><a href="bloom.h.html#LN129"><span class='Ref_to_Const'>BLOOM_MAGICK_NUMBER</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"Relation is not a bloom index"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>*</span><a href="blutils.c.html#LN172"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN171"><span class='Ref_To_Local'>meta</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN124"><span class='Ref_to_Member'>opts</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN169"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="blutils.c.html#LN172"><span class='Ref_To_Local'>opts</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !index-&GT;rd_amcache &raquo; </span> 
 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN139"><span class='Ref_to_Member'>opts</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN139"><span class='Ref_to_Member'>opts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN146"><span class='Ref_to_Member'>sizeOfBloomTuple</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN163"><span class='Ref_to_Const'>BLOOMTUPLEHDRSZ</span></a> <span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN82"><span class='Ref_to_Typedef'>BloomSignatureWord</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="blutils.c.html#LN152"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN139"><span class='Ref_to_Member'>opts</span></a><span class='Operator'>.</span><a href="bloom.h.html#LN102"><span class='Ref_to_Member'>bloomLength</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initBloomState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Random generator copied from FreeBSD.  Using own random generator here for 
 * two reasons: 
 * 
 * 1) In this case random numbers are used for on-disk storage.  Usage of 
 *    PostgreSQL number generator would obstruct it from all possible changes. 
 * 2) Changing seed of PostgreSQL random generator would be undesirable side 
 *    effect. 
 */ 
</span><a name="LN209"></a><span class='Keyword'>static </span><a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Var'>next</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static </span><a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> 
<a name="LN212"></a><span class='Declare_Function'>myRand</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/*---------- 
     * Compute x = (7^5 * x) mod (2^31 - 1) 
     * without overflowing 31 bits: 
     *      (2^31 - 1) = 127773 * (7^5) + 2836 
     * From "Random number generators: good ones are hard to find", 
     * Park and Miller, Communications of the ACM, vol. 31, no. 10, 
     * October 1988, p. 1195. 
     *---------- 
     */ 
</span><a name="LN223"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>hi</span><span class='Delimiter'>, 
</span><a name="LN224"></a>                <span class='Declare_Local'>lo</span><span class='Delimiter'>, 
</span><a name="LN225"></a>                <span class='Declare_Local'>x</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be in [1, 0x7ffffffe] range at this point. */ 
</span>    <a href="blutils.c.html#LN223"><span class='Ref_To_Local'>hi</span></a> <span class='Operator'>= </span><a href="../../src/backend/regex/regcomp.c.html#LN84"><span class='Ref_to_Proto'>next</span></a> <span class='Operator'>/ </span><span class='Number'>127773</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN224"><span class='Ref_To_Local'>lo</span></a> <span class='Operator'>= </span><a href="../../src/backend/regex/regcomp.c.html#LN84"><span class='Ref_to_Proto'>next</span></a> <span class='Operator'>% </span><span class='Number'>127773</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN225"><span class='Ref_To_Local'>x</span></a> <span class='Operator'>= </span><span class='Number'>16807</span> <span class='Operator'>* </span><a href="blutils.c.html#LN224"><span class='Ref_To_Local'>lo</span></a> <span class='Operator'>- </span><span class='Number'>2836</span> <span class='Operator'>* </span><a href="blutils.c.html#LN223"><span class='Ref_To_Local'>hi</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN225"><span class='Ref_To_Local'>x</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="blutils.c.html#LN225"><span class='Ref_To_Local'>x</span></a> <span class='Operator'>+= </span><span class='Number'>0x7fffffff</span><span class='Delimiter'>; 
</span>    <a href="../../src/backend/regex/regcomp.c.html#LN84"><span class='Ref_to_Proto'>next</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN225"><span class='Ref_To_Local'>x</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Transform to [0, 0x7ffffffd] range. */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN225"><span class='Ref_To_Local'>x</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end myRand &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN239"></a><span class='Declare_Function'>mySrand</span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>seed</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../src/backend/regex/regcomp.c.html#LN84"><span class='Ref_to_Proto'>next</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN239"><span class='Ref_to_Parameter'>seed</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Transform to [1, 0x7ffffffe] range. */ 
</span>    <a href="../../src/backend/regex/regcomp.c.html#LN84"><span class='Ref_to_Proto'>next</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/backend/regex/regcomp.c.html#LN84"><span class='Ref_to_Proto'>next</span></a> <span class='Operator'>% </span><span class='Number'>0x7ffffffe</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add bits of given value to the signature. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN250"></a><span class='Declare_Function'>signValue</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN136"><span class='Ref_to_Struct'>BloomState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="bloom.h.html#LN82"><span class='Ref_to_Typedef'>BloomSignatureWord</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sign</span><span class='Delimiter'>, </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN252"></a>    <a href="../../src/include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashVal</span><span class='Delimiter'>; 
</span><a name="LN253"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nBit</span><span class='Delimiter'>, 
</span><a name="LN254"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * init generator with "column's" number to get "hashed" seed for new 
     * value. We don't want to map the same numbers from different columns 
     * into the same bits! 
     */ 
</span>    <a href="blutils.c.html#LN44"><span class='Ref_to_Proto'>mySrand</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Init hash sequence to map our value into bits. the same values in 
     * different columns will be mapped into different bits because of step 
     * above 
     */ 
</span>    <a href="blutils.c.html#LN252"><span class='Ref_To_Local'>hashVal</span></a> <span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN601"><span class='Ref_to_Macro'>FunctionCall1</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN138"><span class='Ref_to_Member'>hashFn</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], </span><span class='Keyword'>value</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN44"><span class='Ref_to_Proto'>mySrand</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN252"><span class='Ref_To_Local'>hashVal</span></a> <span class='Operator'>^ </span><a href="blutils.c.html#LN43"><span class='Ref_to_Proto'>myRand</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN254"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="blutils.c.html#LN254"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN139"><span class='Ref_to_Member'>opts</span></a><span class='Operator'>.</span><a href="bloom.h.html#LN103"><span class='Ref_to_Member'>bitSize</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>]; </span><a href="blutils.c.html#LN254"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* prevent multiple evaluation in SETBIT macro */ 
</span>        <a href="blutils.c.html#LN253"><span class='Ref_To_Local'>nBit</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN43"><span class='Ref_to_Proto'>myRand</span></a><span class='Parentheses'>() </span><span class='Operator'>% </span><span class='Parentheses'>(</span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN139"><span class='Ref_to_Member'>opts</span></a><span class='Operator'>.</span><a href="bloom.h.html#LN102"><span class='Ref_to_Member'>bloomLength</span></a> <span class='Operator'>* </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="blutils.c.html#LN32"><span class='Ref_to_Macro'>SETBIT</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN250"><span class='Ref_to_Parameter'>sign</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN253"><span class='Ref_To_Local'>nBit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end signValue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Make bloom tuple from values. 
 */ 
</span><a href="bloom.h.html#LN157"><span class='Ref_to_Struct'>BloomTuple</span></a> <span class='Operator'>* 
</span><a name="LN283"></a><span class='Declare_Function'>BloomFormTuple</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN136"><span class='Ref_to_Struct'>BloomState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../src/include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>iptr</span><span class='Delimiter'>, </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN285"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN286"></a>    <a href="bloom.h.html#LN157"><span class='Ref_to_Struct'>BloomTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="bloom.h.html#LN157"><span class='Ref_to_Struct'>BloomTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN283"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN146"><span class='Ref_to_Member'>sizeOfBloomTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN286"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN159"><span class='Ref_to_Member'>heapPtr</span></a> <span class='Operator'>= *</span><a href="blutils.c.html#LN283"><span class='Ref_to_Parameter'>iptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Blooming each column */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="blutils.c.html#LN285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="blutils.c.html#LN283"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN140"><span class='Ref_to_Member'>nColumns</span></a><span class='Delimiter'>; </span><a href="blutils.c.html#LN285"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* skip nulls */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN283"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="bloom.h.html#LN181"><span class='Ref_to_Proto'>signValue</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN283"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN286"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN160"><span class='Ref_to_Member'>sign</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN283"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="blutils.c.html#LN285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="blutils.c.html#LN285"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="blutils.c.html#LN286"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BloomFormTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add new bloom tuple to the page.  Returns true if new tuple was successfully 
 * added to the page.  Returns false if it doesn't fit on the page. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN308"></a><span class='Declare_Function'>BloomPageAddItem</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN136"><span class='Ref_to_Struct'>BloomState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../src/include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="bloom.h.html#LN157"><span class='Ref_to_Struct'>BloomTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN310"></a>    <a href="bloom.h.html#LN157"><span class='Ref_to_Struct'>BloomTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN311"></a>    <a href="bloom.h.html#LN41"><span class='Ref_to_Typedef'>BloomPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN312"></a>    <a href="../../src/include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We shouldn't be pointed to an invalid page */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../src/include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="bloom.h.html#LN62"><span class='Ref_to_Macro'>BloomPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Does new tuple fit on the page? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bloom.h.html#LN149"><span class='Ref_to_Macro'>BloomPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN146"><span class='Ref_to_Member'>sizeOfBloomTuple</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy new tuple to the end of page */ 
</span>    <a href="blutils.c.html#LN311"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN58"><span class='Ref_to_Macro'>BloomPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN310"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN69"><span class='Ref_to_Macro'>BloomPageGetTuple</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN311"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN33"><span class='Ref_to_Member'>maxoff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>((</span><a href="../../src/include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN310"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN146"><span class='Ref_to_Member'>sizeOfBloomTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Adjust maxoff and pd_lower */ 
</span>    <a href="blutils.c.html#LN311"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN33"><span class='Ref_to_Member'>maxoff</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN312"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="bloom.h.html#LN69"><span class='Ref_to_Macro'>BloomPageGetTuple</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN311"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN33"><span class='Ref_to_Member'>maxoff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>((</span><a href="../../src/include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>= </span><a href="blutils.c.html#LN312"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>- </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert we didn't overrun available space */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(((</span><a href="../../src/include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>&LT;= </span><span class='Parentheses'>((</span><a href="../../src/include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN308"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BloomPageAddItem &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate a new page (either by recycling, or by extending the index file) 
 * The returned buffer is already pinned and exclusive-locked 
 * Caller is responsible for initializing the page by calling BloomInitBuffer 
 */ 
</span><a href="../../src/include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN343"></a><span class='Declare_Function'>BloomNewBuffer</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN345"></a>    <a href="../../src/include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN346"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needLock</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First, try to get a page from FSM */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN351"></a>        <a href="../../src/include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../src/include/storage/indexfsm.h.html#LN19"><span class='Ref_to_Proto'>GetFreeIndexPage</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN343"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN351"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="../../src/include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../src/include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN343"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN351"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have to guard against the possibility that someone else already 
         * recycled this page; the buffer may be locked if so. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN364"></a>            <a href="../../src/include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../src/include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN364"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OK to use, if never initialized */ 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bloom.h.html#LN62"><span class='Ref_to_Macro'>BloomPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN364"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OK to use */ 
</span> 
            <a href="../../src/include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Can't use it, so release buffer and try again */ 
</span>        <a href="../../src/include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Must extend the file */ 
</span>    <a href="blutils.c.html#LN346"><span class='Ref_To_Local'>needLock</span></a> <span class='Operator'>= !</span><a href="../../src/include/utils/rel.h.html#LN523"><span class='Ref_to_Macro'>RELATION_IS_LOCAL</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN343"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN346"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN343"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../src/include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN343"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="blutils.c.html#LN346"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN343"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="blutils.c.html#LN345"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BloomNewBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize any page of a bloom index. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN397"></a><span class='Declare_Function'>BloomInitPage</span><span class='Parentheses'>(</span><a href="../../src/include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN399"></a>    <a href="bloom.h.html#LN41"><span class='Ref_to_Typedef'>BloomPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN397"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN31"><span class='Ref_to_Struct'>BloomPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="blutils.c.html#LN399"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN58"><span class='Ref_to_Macro'>BloomPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN397"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="blutils.c.html#LN399"><span class='Ref_To_Local'>opaque</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN31"><span class='Ref_to_Struct'>BloomPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN399"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN34"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN397"><span class='Ref_to_Parameter'>flags</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN399"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN38"><span class='Ref_to_Member'>bloom_page_id</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN55"><span class='Ref_to_Const'>BLOOM_PAGE_ID</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fill in metapage for bloom index. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN413"></a><span class='Declare_Function'>BloomFillMetapage</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../src/include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>metaPage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN415"></a>    <a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opts</span><span class='Delimiter'>; 
</span><a name="LN416"></a>    <a href="bloom.h.html#LN119"><span class='Ref_to_Struct'>BloomMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Choose the index's options.  If reloptions have been assigned, use 
     * those, otherwise create default options. 
     */ 
</span>    <a href="blutils.c.html#LN415"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="blutils.c.html#LN413"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN155"><span class='Ref_to_Member'>rd_options</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="blutils.c.html#LN415"><span class='Ref_To_Local'>opts</span></a><span class='Parentheses'>) 
</span>        <a href="blutils.c.html#LN415"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>= </span><a href="blutils.c.html#LN84"><span class='Ref_to_Func'>makeDefaultBloomOptions</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize contents of meta page, including a copy of the options, 
     * which are now frozen for the life of the index. 
     */ 
</span>    <a href="bloom.h.html#LN179"><span class='Ref_to_Proto'>BloomInitPage</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN413"><span class='Ref_to_Parameter'>metaPage</span></a><span class='Delimiter'>, </span><a href="bloom.h.html#LN44"><span class='Ref_to_Const'>BLOOM_META</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN416"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN134"><span class='Ref_to_Macro'>BloomPageGetMeta</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN413"><span class='Ref_to_Parameter'>metaPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="blutils.c.html#LN416"><span class='Ref_To_Local'>metadata</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN119"><span class='Ref_to_Struct'>BloomMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN416"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN121"><span class='Ref_to_Member'>magickNumber</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN129"><span class='Ref_to_Const'>BLOOM_MAGICK_NUMBER</span></a><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN416"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN124"><span class='Ref_to_Member'>opts</span></a> <span class='Operator'>= *</span><a href="blutils.c.html#LN415"><span class='Ref_To_Local'>opts</span></a><span class='Delimiter'>; 
</span>    <span class='Parentheses'>((</span><a href="../../src/include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN413"><span class='Ref_to_Parameter'>metaPage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN119"><span class='Ref_to_Struct'>BloomMetaPageData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If this fails, probably FreeBlockNumberArray size calc is wrong: */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(((</span><a href="../../src/include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN413"><span class='Ref_to_Parameter'>metaPage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>&LT;= </span><span class='Parentheses'>((</span><a href="../../src/include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="blutils.c.html#LN413"><span class='Ref_to_Parameter'>metaPage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BloomFillMetapage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize metapage for bloom index. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN445"></a><span class='Declare_Function'>BloomInitMetapage</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN447"></a>    <a href="../../src/include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metaBuffer</span><span class='Delimiter'>; 
</span><a name="LN448"></a>    <a href="../../src/include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metaPage</span><span class='Delimiter'>; 
</span><a name="LN449"></a>    <a href="../../src/backend/access/transam/generic_xlog.c.html#LN61"><span class='Ref_to_Struct'>GenericXLogState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a new page; since it is first page it should be associated with 
     * block number 0 (BLOOM_METAPAGE_BLKNO). 
     */ 
</span>    <a href="blutils.c.html#LN447"><span class='Ref_To_Local'>metaBuffer</span></a> <span class='Operator'>= </span><a href="bloom.h.html#LN180"><span class='Ref_to_Proto'>BloomNewBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN445"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../src/include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN447"><span class='Ref_To_Local'>metaBuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="bloom.h.html#LN76"><span class='Ref_to_Const'>BLOOM_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize contents of meta page */ 
</span>    <a href="blutils.c.html#LN449"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="../../src/include/access/generic_xlog.h.html#LN32"><span class='Ref_to_Proto'>GenericXLogStart</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN445"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN448"><span class='Ref_To_Local'>metaPage</span></a> <span class='Operator'>= </span><a href="../../src/include/access/generic_xlog.h.html#LN33"><span class='Ref_to_Proto'>GenericXLogRegisterBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN449"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN447"><span class='Ref_To_Local'>metaBuffer</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../src/include/access/generic_xlog.h.html#LN25"><span class='Ref_to_Const'>GENERIC_XLOG_FULL_IMAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bloom.h.html#LN177"><span class='Ref_to_Proto'>BloomFillMetapage</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN445"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN448"><span class='Ref_To_Local'>metaPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/access/generic_xlog.h.html#LN35"><span class='Ref_to_Proto'>GenericXLogFinish</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN449"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN447"><span class='Ref_To_Local'>metaBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BloomInitMetapage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Parse reloptions for bloom index, producing a BloomOptions struct. 
 */ 
</span><a href="../../src/include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>* 
</span><a name="LN472"></a><span class='Declare_Function'>bloptions</span><span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>validate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN474"></a>    <a href="../../src/include/access/reloptions.h.html#LN73"><span class='Ref_to_Struct'>relopt_value</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span><span class='Delimiter'>; 
</span><a name="LN475"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numoptions</span><span class='Delimiter'>; 
</span><a name="LN476"></a>    <a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rdopts</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse the user-given reloptions */ 
</span>    <a href="blutils.c.html#LN474"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>= </span><a href="../../src/include/access/reloptions.h.html#LN263"><span class='Ref_to_Proto'>parseRelOptions</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN472"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN472"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN38"><span class='Ref_to_Global_Var'>bl_relopt_kind</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="blutils.c.html#LN475"><span class='Ref_To_Local'>numoptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="blutils.c.html#LN476"><span class='Ref_To_Local'>rdopts</span></a> <span class='Operator'>= </span><a href="../../src/include/access/reloptions.h.html#LN265"><span class='Ref_to_Proto'>allocateReloptStruct</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="blutils.c.html#LN474"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN475"><span class='Ref_To_Local'>numoptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/access/reloptions.h.html#LN267"><span class='Ref_to_Proto'>fillRelOptions</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="blutils.c.html#LN476"><span class='Ref_To_Local'>rdopts</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bloom.h.html#LN99"><span class='Ref_to_Struct'>BloomOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="blutils.c.html#LN474"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN475"><span class='Ref_To_Local'>numoptions</span></a><span class='Delimiter'>, 
</span>                   <a href="blutils.c.html#LN472"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="blutils.c.html#LN41"><span class='Ref_to_Global_Var'>bl_relopt_tab</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert signature length from # of bits to # to words, rounding up */ 
</span>    <a href="blutils.c.html#LN476"><span class='Ref_To_Local'>rdopts</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN102"><span class='Ref_to_Member'>bloomLength</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="blutils.c.html#LN476"><span class='Ref_To_Local'>rdopts</span></a><span class='Operator'>-&GT;</span><a href="bloom.h.html#LN102"><span class='Ref_to_Member'>bloomLength</span></a> <span class='Operator'>+ </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="bloom.h.html#LN84"><span class='Ref_to_Const'>SIGNWORDBITS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="blutils.c.html#LN476"><span class='Ref_To_Local'>rdopts</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>