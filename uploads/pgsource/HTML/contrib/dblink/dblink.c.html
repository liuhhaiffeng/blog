<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\dblink\dblink.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\dblink\dblink.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:25 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * dblink.c 
 * 
 * Functions returning results from a remote database 
 * 
 * Joe Conway &LT;mail@joeconway.com&GT; 
 * And contributors: 
 * Darko Prenosil &LT;Darko.Prenosil@finteh.hr&GT; 
 * Shridhar Daithankar &LT;shridhar_daithankar@persistent.co.in&GT; 
 * 
 * contrib/dblink/dblink.c 
 * Copyright (c) 2001-2017, PostgreSQL Global Development Group 
 * ALL RIGHTS RESERVED; 
 * 
 * Permission to use, copy, modify, and distribute this software and its 
 * documentation for any purpose, without fee, and without a written agreement 
 * is hereby granted, provided that the above copyright notice and this 
 * paragraph and the following two paragraphs appear in all copies. 
 * 
 * IN NO EVENT SHALL THE AUTHOR OR DISTRIBUTORS BE LIABLE TO ANY PARTY FOR 
 * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING 
 * LOST PROFITS, ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS 
 * DOCUMENTATION, EVEN IF THE AUTHOR OR DISTRIBUTORS HAVE BEEN ADVISED OF THE 
 * POSSIBILITY OF SUCH DAMAGE. 
 * 
 * THE AUTHOR AND DISTRIBUTORS SPECIFICALLY DISCLAIMS ANY WARRANTIES, 
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS 
 * ON AN "AS IS" BASIS, AND THE AUTHOR AND DISTRIBUTORS HAS NO OBLIGATIONS TO 
 * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS. 
 * 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_foreign_data_wrapper.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_foreign_server.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_user_mapping.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"foreign/foreign.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/scansup.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/varlena.h"</span> 
 
<a href="../../src/include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<a name="LN65"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>remoteConn</span> 
<span class='Delimiter'>{ 
</span><a name="LN67"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>conn</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Hold the remote connection */ 
</span><a name="LN68"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>openCursorCount</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* The number of open cursors */ 
</span><a name="LN69"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>newXactForCursor</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Opened a transaction for a cursor */ 
</span><a name="LN70"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>remoteConn</span><span class='Delimiter'>; 
</span> 
<a name="LN72"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>storeInfo</span> 
<span class='Delimiter'>{ 
</span><a name="LN74"></a>    <a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Member'>fcinfo</span><span class='Delimiter'>; 
</span><a name="LN75"></a>    <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tuplestore</span><span class='Delimiter'>; 
</span><a name="LN76"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Member'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN77"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>tmpcontext</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Member'>cstrs</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* temp storage for results to avoid leaks on exception */ 
</span><a name="LN80"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>last_res</span><span class='Delimiter'>; 
</span><a name="LN81"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>cur_res</span><span class='Delimiter'>; 
</span><a name="LN82"></a>} <span class='Declare_Typedef'>storeInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Internal declarations 
 */ 
</span><a name="LN87"></a><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>dblink_record_internal</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_async</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>prepTuplestoreResult</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN89"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>materializeResult</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN90"></a>                  <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN91"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>materializeQueryResult</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN92"></a>                       <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN93"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conname</span><span class='Delimiter'>, 
</span><a name="LN94"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sql</span><span class='Delimiter'>, 
</span><a name="LN95"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>fail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN96"></a><span class='Keyword'>static </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>storeQueryResult</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="dblink.c.html#LN72"><span class='Ref_to_Struct'>storeInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sinfo</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sql</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>storeRow</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="dblink.c.html#LN72"><span class='Ref_to_Struct'>storeInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sinfo</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>first</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN98"></a><span class='Keyword'>static </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>getConnectionByName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN99"></a><span class='Keyword'>static </span><a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>createConnHash</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN100"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>createNewConnection</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rconn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN101"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>deleteConnection</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN102"></a><span class='Keyword'>static char </span><span class='Operator'>**</span><span class='Declare_Prototype'>get_pkey_attnames</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numatts</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN103"></a><span class='Keyword'>static char </span><span class='Operator'>**</span><span class='Declare_Prototype'>get_text_array_contents</span><span class='Parentheses'>(</span><a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>numitems</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN104"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>get_sql_insert</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>src_pkattvals</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>tgt_pkattvals</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN105"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>get_sql_delete</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>tgt_pkattvals</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN106"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>get_sql_update</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>src_pkattvals</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>tgt_pkattvals</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN107"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>quote_ident_cstr</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rawstr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN108"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>get_attnum_pk_pos</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN109"></a><span class='Keyword'>static </span><a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Prototype'>get_tuple_of_interest</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>src_pkattvals</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN110"></a><span class='Keyword'>static </span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Prototype'>get_rel_from_relname</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relname_text</span><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN69"><span class='Ref_to_Typedef'>AclMode</span></a> <span class='Declare_Parameter'>aclmode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN111"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>generate_relation_name</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN112"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dblink_connstr_check</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>connstr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN113"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dblink_security_check</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rconn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN114"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dblink_res_error</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conname</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, 
</span><a name="LN115"></a>                 <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dblink_context_msg</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>fail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN116"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>get_connect_string</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>servername</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN117"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>escape_param_str</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>from</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>validate_pkattnums</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN119"></a>                   <a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums_arg</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>pknumatts_arg</span><span class='Delimiter'>, 
</span><a name="LN120"></a>                   <span class='Keyword'>int </span><span class='Operator'>**</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pknumatts</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN121"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>is_valid_dblink_option</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, 
</span><a name="LN122"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>option</span><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN123"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>applyRemoteGucs</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN124"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>restoreLocalGucs</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nestlevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Global */ 
</span><a name="LN127"></a><span class='Keyword'>static </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN128"></a><span class='Keyword'>static </span><a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>remoteConnHash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Following is list that holds multiple remote connections. 
 *  Calling convention of each dblink function changes to accept 
 *  connection name as the first parameter. The connection list is 
 *  much like ecpg e.g. a mapping between a name and a PGconn object. 
 */ 
</span> 
<a name="LN137"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>remoteConnHashEnt</span> 
<span class='Delimiter'>{ 
</span><a name="LN139"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>name</span><span class='Delimiter'>[</span><a href="../../src/interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span><a name="LN140"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Member'>rconn</span><span class='Delimiter'>; 
</span><a name="LN141"></a>} <span class='Declare_Typedef'>remoteConnHashEnt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* initial number of connection hashes */ 
</span><a name="LN144"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NUMCONN</span> <span class='Number'>16</span> 
 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN147"></a><span class='Declare_Function'>xpstrdup</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>in</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN147"><span class='Ref_to_Parameter'>in</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN147"><span class='Ref_to_Parameter'>in</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN155"></a><span class='Declare_Function'>pg_attribute_noreturn</span><span class='Parentheses'>() 
</span>dblink_res_internalerror<span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><a href="../../src/bin/pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span>res<span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span>p2<span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN158"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>res<span class='Parentheses'>) 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span>res<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"%s: %s"</span><span class='Delimiter'>, </span>p2<span class='Delimiter'>, </span><a href="dblink.c.html#LN158"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN166"></a><span class='Declare_Function'>pg_attribute_noreturn</span><span class='Parentheses'>() 
</span>dblink_conn_not_avail<span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span>conname<span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>conname<span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONNECTION_DOES_NOT_EXIST<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"connection \"%s\" not available"</span><span class='Delimiter'>, </span>conname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONNECTION_DOES_NOT_EXIST<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"connection not available"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN180"></a><span class='Declare_Function'>dblink_get_conn</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conname_or_str</span><span class='Delimiter'>, 
</span><a name="LN181"></a>      <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Operator'>* </span><span class='Declare_Parameter'>conn_p</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>conname_p</span><span class='Delimiter'>, </span><span class='Keyword'>volatile bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>freeconn_p</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN183"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN180"><span class='Ref_to_Parameter'>conname_or_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN184"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN185"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span><span class='Delimiter'>; 
</span><a name="LN186"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>freeconn</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN183"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN183"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN185"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN180"><span class='Ref_to_Parameter'>conname_or_str</span></a><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN186"><span class='Ref_To_Local'>freeconn</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN196"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>connstr</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN196"><span class='Ref_To_Local'>connstr</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN116"><span class='Ref_to_Proto'>get_connect_string</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN180"><span class='Ref_to_Parameter'>conname_or_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN196"><span class='Ref_To_Local'>connstr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN196"><span class='Ref_To_Local'>connstr</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN180"><span class='Ref_to_Parameter'>conname_or_str</span></a><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN112"><span class='Ref_to_Proto'>dblink_connstr_check</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN196"><span class='Ref_To_Local'>connstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN260"><span class='Ref_to_Proto'>PQconnectdb</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN196"><span class='Ref_To_Local'>connstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN205"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SQLCLIENT_UNABLE_TO_ESTABLISH_SQLCONNECTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not establish connection"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../../src/backend/utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN205"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="dblink.c.html#LN113"><span class='Ref_to_Proto'>dblink_security_check</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN183"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN328"><span class='Ref_to_Proto'>PQclientEncoding</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>())</span> 
            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN329"><span class='Ref_to_Proto'>PQsetClientEncoding</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="../../src/include/mb/pg_wchar.h.html#LN546"><span class='Ref_to_Proto'>GetDatabaseEncodingName</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN186"><span class='Ref_To_Local'>freeconn</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN185"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Operator'>*</span><a href="dblink.c.html#LN181"><span class='Ref_to_Parameter'>conn_p</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN184"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="dblink.c.html#LN181"><span class='Ref_to_Parameter'>conname_p</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN185"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="dblink.c.html#LN181"><span class='Ref_to_Parameter'>freeconn_p</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN186"><span class='Ref_To_Local'>freeconn</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_get_conn &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>* 
</span><a name="LN226"></a><span class='Declare_Function'>dblink_get_named_conn</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN228"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN226"><span class='Ref_to_Parameter'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN228"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="dblink.c.html#LN228"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span> 
    dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN226"><span class='Ref_to_Parameter'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN238"></a><span class='Declare_Function'>dblink_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN68"><span class='Ref_to_Member'>openCursorCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN69"><span class='Ref_to_Member'>newXactForCursor</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a persistent connection to another database 
 */ 
</span><a name="LN252"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN253"><span class='Ref_to_Func'>dblink_connect</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN254"></a><span class='Declare_Function'>dblink_connect</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN256"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname_or_str</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN257"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>connstr</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN258"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>connname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN259"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN260"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN261"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN256"><span class='Ref_To_Local'>conname_or_str</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN258"><span class='Ref_To_Local'>connname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="dblink.c.html#LN256"><span class='Ref_To_Local'>conname_or_str</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN258"><span class='Ref_To_Local'>connname</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN261"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                                  <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* first check for valid foreign data server */ 
</span>    <a href="dblink.c.html#LN257"><span class='Ref_To_Local'>connstr</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN116"><span class='Ref_to_Proto'>get_connect_string</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN256"><span class='Ref_To_Local'>conname_or_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN257"><span class='Ref_To_Local'>connstr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN257"><span class='Ref_To_Local'>connstr</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN256"><span class='Ref_To_Local'>conname_or_str</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check password in connection string if not superuser */ 
</span>    <a href="dblink.c.html#LN112"><span class='Ref_to_Proto'>dblink_connstr_check</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN257"><span class='Ref_To_Local'>connstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN260"><span class='Ref_to_Proto'>PQconnectdb</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN257"><span class='Ref_To_Local'>connstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN259"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN261"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN261"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SQLCLIENT_UNABLE_TO_ESTABLISH_SQLCONNECTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not establish connection"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN259"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* check password actually used if not superuser */ 
</span>    <a href="dblink.c.html#LN113"><span class='Ref_to_Proto'>dblink_security_check</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN261"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* attempt to set client encoding to match server encoding, if needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN328"><span class='Ref_to_Proto'>PQclientEncoding</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>())</span> 
        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN329"><span class='Ref_to_Proto'>PQsetClientEncoding</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="../../src/include/mb/pg_wchar.h.html#LN546"><span class='Ref_to_Proto'>GetDatabaseEncodingName</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN258"><span class='Ref_To_Local'>connname</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN261"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN100"><span class='Ref_to_Proto'>createNewConnection</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN258"><span class='Ref_To_Local'>connname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN261"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN260"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"OK"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_connect &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Clear a persistent connection to another database 
 */ 
</span><a name="LN324"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN325"><span class='Ref_to_Func'>dblink_disconnect</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN326"></a><span class='Declare_Function'>dblink_disconnect</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN328"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN329"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN330"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN328"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN329"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN328"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN329"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN330"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN329"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="dblink.c.html#LN330"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN330"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) 
</span>        dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN328"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN330"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN329"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN101"><span class='Ref_to_Proto'>deleteConnection</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN328"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN329"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"OK"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_disconnect &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * opens a cursor using a persistent connection 
 */ 
</span><a name="LN362"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN363"><span class='Ref_to_Func'>dblink_open</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN364"></a><span class='Declare_Function'>dblink_open</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN366"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN367"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN368"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN369"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN370"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN371"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN372"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN373"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>fail</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* default to backward compatible behavior */ 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN371"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text,text */ 
</span>        <a href="dblink.c.html#LN368"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN369"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* might be text,text,text or text,text,bool */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN368"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN369"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN373"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN370"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN368"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN369"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN370"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>4</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text,text,text,bool */ 
</span>        <a href="dblink.c.html#LN370"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN368"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN369"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN373"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN370"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>|| !</span><a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Parentheses'>) 
</span>        dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN370"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN367"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we are not in a transaction, start one */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN318"><span class='Ref_to_Proto'>PQtransactionStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN367"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN102"><span class='Ref_to_EnumConst'>PQTRANS_IDLE</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN367"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"BEGIN"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
            dblink_res_internalerror<span class='Parentheses'>(</span><a href="dblink.c.html#LN367"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='String'>"begin error"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN69"><span class='Ref_to_Member'>newXactForCursor</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Since transaction state was IDLE, we force cursor count to 
         * initially be 0. This is needed as a previous ABORT might have wiped 
         * out our transaction without maintaining the cursor count for us. 
         */ 
</span>        <a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN68"><span class='Ref_to_Member'>openCursorCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* if we started a transaction, increment cursor count */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN69"><span class='Ref_to_Member'>newXactForCursor</span></a><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dblink.c.html#LN372"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN68"><span class='Ref_to_Member'>openCursorCount</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN371"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"DECLARE %s CURSOR FOR %s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN368"><span class='Ref_To_Local'>curname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN369"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN367"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN371"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN114"><span class='Ref_to_Proto'>dblink_res_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN367"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN370"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='String'>"could not open cursor"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN373"><span class='Ref_To_Local'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"ERROR"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN366"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"OK"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_open &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * closes a cursor 
 */ 
</span><a name="LN454"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN455"><span class='Ref_to_Func'>dblink_close</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN456"></a><span class='Declare_Function'>dblink_close</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN458"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN459"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN460"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN461"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN462"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN463"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN464"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>fail</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* default to backward compatible behavior */ 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN462"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text */ 
</span>        <a href="dblink.c.html#LN460"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* might be text,text or text,bool */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN460"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN464"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN461"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN460"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN461"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text,text,bool */ 
</span>        <a href="dblink.c.html#LN461"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN460"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN464"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN461"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>|| !</span><a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Parentheses'>) 
</span>        dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN461"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN458"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN462"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"CLOSE %s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN460"><span class='Ref_To_Local'>curname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* close the cursor */ 
</span>    <a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN458"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN462"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN114"><span class='Ref_to_Proto'>dblink_res_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN458"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN461"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='String'>"could not close cursor"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN464"><span class='Ref_To_Local'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"ERROR"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if we started a transaction, decrement cursor count */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN69"><span class='Ref_to_Member'>newXactForCursor</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN68"><span class='Ref_to_Member'>openCursorCount</span></a><span class='Parentheses'>)</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if count is zero, commit the transaction */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN68"><span class='Ref_to_Member'>openCursorCount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN463"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN69"><span class='Ref_to_Member'>newXactForCursor</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN458"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"COMMIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
                dblink_res_internalerror<span class='Parentheses'>(</span><a href="dblink.c.html#LN458"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='String'>"commit error"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN459"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"OK"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_close &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch results from an open cursor 
 */ 
</span><a name="LN540"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN541"><span class='Ref_to_Func'>dblink_fetch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN542"></a><span class='Declare_Function'>dblink_fetch</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN544"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN545"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN546"></a>    <a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN547"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN548"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN549"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN550"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>howmany</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN551"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>fail</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* default to backward compatible */ 
</span> 
    <a href="dblink.c.html#LN88"><span class='Ref_to_Proto'>prepTuplestoreResult</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>4</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text,text,int,bool */ 
</span>        <a href="dblink.c.html#LN545"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN549"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN550"><span class='Ref_To_Local'>howmany</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN551"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN546"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN545"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN546"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN546"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text,text,int or text,int,bool */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN549"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN550"><span class='Ref_To_Local'>howmany</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN551"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN545"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN549"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN550"><span class='Ref_To_Local'>howmany</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN546"><span class='Ref_To_Local'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN98"><span class='Ref_to_Proto'>getConnectionByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN545"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN546"><span class='Ref_To_Local'>rconn</span></a><span class='Parentheses'>) 
</span>                <a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN546"><span class='Ref_To_Local'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PG_NARGS()==3 &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* text,int */ 
</span>        <a href="dblink.c.html#LN549"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN550"><span class='Ref_To_Local'>howmany</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) 
</span>        dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN545"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN548"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN548"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"FETCH %d FROM %s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN550"><span class='Ref_To_Local'>howmany</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN549"><span class='Ref_To_Local'>curname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to execute the query.  Note that since libpq uses malloc, the 
     * PGresult will be long-lived even though we are still in a short-lived 
     * memory context. 
     */ 
</span>    <a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN548"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a> <span class='Operator'>&& 
</span>         <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN114"><span class='Ref_to_Proto'>dblink_res_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN545"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"could not fetch from cursor"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN551"><span class='Ref_To_Local'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* cursor does not exist - closed already or bad name */ 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_CURSOR_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cursor \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN549"><span class='Ref_To_Local'>curname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="dblink.c.html#LN89"><span class='Ref_to_Proto'>materializeResult</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><a href="dblink.c.html#LN547"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN544"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_fetch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Note: this is the new preferred version of dblink 
 */ 
</span><a name="LN634"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN635"><span class='Ref_to_Func'>dblink_record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN636"></a><span class='Declare_Function'>dblink_record</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="dblink.c.html#LN87"><span class='Ref_to_Proto'>dblink_record_internal</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN641"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN642"><span class='Ref_to_Func'>dblink_send_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN643"></a><span class='Declare_Function'>dblink_send_query</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN645"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN646"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span><span class='Delimiter'>; 
</span><a name="LN647"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN645"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN646"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong number of arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* async query send */ 
</span>    <a href="dblink.c.html#LN647"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN401"><span class='Ref_to_Proto'>PQsendQuery</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN645"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN646"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN647"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, </span><span class='String'>"could not send query: %s"</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN645"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN313"><span class='Ref_to_Macro'>PG_RETURN_INT32</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN647"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_send_query &raquo; </span> 
 
<a name="LN666"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN667"><span class='Ref_to_Func'>dblink_get_result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN668"></a><span class='Declare_Function'>dblink_get_result</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="dblink.c.html#LN87"><span class='Ref_to_Proto'>dblink_record_internal</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN674"></a><span class='Declare_Function'>dblink_record_internal</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_async</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN676"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN677"></a>    <span class='Keyword'>volatile bool </span><span class='Declare_Local'>freeconn</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN88"><span class='Ref_to_Proto'>prepTuplestoreResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN674"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN685"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN686"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN687"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>fail</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* default to backward compatible */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN674"><span class='Ref_to_Parameter'>is_async</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* text,text,bool */ 
</span>                <a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN685"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN687"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN179"><span class='Ref_to_Func'>dblink_get_conn</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN677"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* text,text or text,bool */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN674"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="dblink.c.html#LN685"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="dblink.c.html#LN687"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="dblink.c.html#LN685"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="dblink.c.html#LN179"><span class='Ref_to_Func'>dblink_get_conn</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN677"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* text */ 
</span>                <a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN685"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>                <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong number of arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !is_async &raquo; </span> 
        <span class='Control'>else</span>    <span class='Comment_Single_Line'>/* is_async */ 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* get async result */ 
</span>            <a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* text,bool */ 
</span>                <a href="dblink.c.html#LN687"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* text */ 
</span>                <a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>                <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong number of arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) 
</span>            dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN674"><span class='Ref_to_Parameter'>is_async</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* synchronous query, use efficient tuple collection method */ 
</span>            <a href="dblink.c.html#LN91"><span class='Ref_to_Proto'>materializeQueryResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN674"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN685"><span class='Ref_To_Local'>sql</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN687"><span class='Ref_To_Local'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* async result retrieval, do it the old way */ 
</span><a name="LN757"></a>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* NULL means we're all done with the async results */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN757"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN757"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a> <span class='Operator'>&& 
</span>                    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN757"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="dblink.c.html#LN114"><span class='Ref_to_Proto'>dblink_res_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN686"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN757"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"could not execute query"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN687"><span class='Ref_To_Local'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* if fail isn't set, we'll return an empty query result */ 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="dblink.c.html#LN89"><span class='Ref_to_Proto'>materializeResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN674"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN757"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* if needed, close the connection to the database */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN677"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if needed, close the connection to the database */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN677"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN676"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_record_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Verify function caller can handle a tuplestore result, and set up for that. 
 * 
 * Note: if the caller returns without actually creating a tuplestore, the 
 * executor will treat the function result as an empty set. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN799"></a><span class='Declare_Function'>prepTuplestoreResult</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN801"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dblink.c.html#LN799"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/fmgr.h.html#LN80"><span class='Ref_to_Member'>resultinfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see if query supports us returning a tuplestore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN801"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../src/include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN801"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN801"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"materialize mode required, but it is not allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* let the executor know we're sending back a tuplestore */ 
</span>    <a href="dblink.c.html#LN801"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* caller must fill these to return a non-empty result */ 
</span>    <a href="dblink.c.html#LN801"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN801"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end prepTuplestoreResult &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Copy the contents of the PGresult into a tuplestore to be returned 
 * as the result of the current function. 
 * The PGresult will be released in this function. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN827"></a><span class='Declare_Function'>materializeResult</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN829"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/fmgr.h.html#LN80"><span class='Ref_to_Member'>resultinfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prepTuplestoreResult must have been called previously */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN829"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>== </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN836"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN837"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_sql_cmd</span><span class='Delimiter'>; 
</span><a name="LN838"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ntuples</span><span class='Delimiter'>; 
</span><a name="LN839"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nfields</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN837"><span class='Ref_To_Local'>is_sql_cmd</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * need a tuple descriptor representing one TEXT column to return 
             * the command status string as our result tuple 
             */ 
</span>            <a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/backend/access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"status"</span><span class='Delimiter'>, 
</span>                               <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN838"><span class='Ref_To_Local'>ntuples</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN839"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN837"><span class='Ref_To_Local'>is_sql_cmd</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get a tuple descriptor for our result type */ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../src/include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* success */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../src/include/funcapi.h.html#LN153"><span class='Ref_to_EnumConst'>TYPEFUNC_RECORD</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* failed to determine actual type of RECORD */ 
</span>                    <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context "</span> 
                               <span class='String'>"that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* result type isn't composite */ 
</span>                    <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"return type must be a row type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* make sure we have a persistent copy of the tupdesc */ 
</span>            <a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN838"><span class='Ref_To_Local'>ntuples</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN839"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * check result and tuple descriptor have the same number of columns 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN839"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"remote query result rowtype does not match "</span> 
                            <span class='String'>"the specified FROM clause rowtype"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN838"><span class='Ref_To_Local'>ntuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN897"></a>            <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN898"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nestlevel</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN899"></a>            <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span><span class='Delimiter'>; 
</span><a name="LN900"></a>            <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN901"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>row</span><span class='Delimiter'>; 
</span><a name="LN902"></a>            <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN897"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Set GUCs to ensure we read GUC-sensitive data types correctly */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN837"><span class='Ref_To_Local'>is_sql_cmd</span></a><span class='Parentheses'>) 
</span>                <a href="dblink.c.html#LN898"><span class='Ref_To_Local'>nestlevel</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN123"><span class='Ref_to_Proto'>applyRemoteGucs</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN900"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>( 
</span>                                    <a href="dblink.c.html#LN829"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN899"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN829"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN899"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN829"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN836"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span>            <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN900"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN902"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN839"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* put all tuples into the tuplestore */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN901"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN901"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN838"><span class='Ref_To_Local'>ntuples</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN901"><span class='Ref_To_Local'>row</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN922"></a>                <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN837"><span class='Ref_To_Local'>is_sql_cmd</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN926"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN839"><span class='Ref_To_Local'>nfields</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN901"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
                            <a href="dblink.c.html#LN902"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                        <span class='Control'>else</span> 
                            <a href="dblink.c.html#LN902"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN901"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="dblink.c.html#LN902"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN484"><span class='Ref_to_Proto'>PQcmdStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* build the tuple and put it into the tuplestore. */ 
</span>                <a href="dblink.c.html#LN922"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN897"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN902"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN899"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN922"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for row=0;row&LT;ntuples;row... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* clean up GUC settings, if we changed any */ 
</span>            <a href="dblink.c.html#LN124"><span class='Ref_to_Proto'>restoreLocalGucs</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN898"><span class='Ref_To_Local'>nestlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* clean up and return the tuplestore */ 
</span>            <a href="../../src/include/utils/tuplestore.h.html#LN59"><span class='Ref_to_Macro'>tuplestore_donestoring</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN899"><span class='Ref_To_Local'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ntuples&GT;0 &raquo; </span> 
 
        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* be sure to release the libpq result */ 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN827"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end materializeResult &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Execute the given SQL command and store its results into a tuplestore 
 * to be returned as the result of the current function. 
 * 
 * This is equivalent to PQexec followed by materializeResult, but we make 
 * use of libpq's single-row mode to avoid accumulating the whole result 
 * inside libpq before it gets transferred to the tuplestore. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN973"></a><span class='Declare_Function'>materializeQueryResult</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN974"></a>                       <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN975"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conname</span><span class='Delimiter'>, 
</span><a name="LN976"></a>                       <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sql</span><span class='Delimiter'>, 
</span><a name="LN977"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>fail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN979"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dblink.c.html#LN973"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/fmgr.h.html#LN80"><span class='Ref_to_Member'>resultinfo</span></a><span class='Delimiter'>; 
</span><a name="LN980"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN981"></a>    <span class='Keyword'>volatile </span><a href="dblink.c.html#LN72"><span class='Ref_to_Struct'>storeInfo</span></a> <span class='Declare_Local'>sinfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prepTuplestoreResult must have been called previously */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN979"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>== </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize storeInfo to empty */ 
</span>    memset<span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN74"><span class='Ref_to_Member'>fcinfo</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN973"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Create short-lived memory context for data conversions */ 
</span>        <a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN77"><span class='Ref_to_Member'>tmpcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                                 <span class='String'>"dblink temporary context"</span><span class='Delimiter'>, 
</span>                                                 <a href="../../src/include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* execute query, collecting any tuples into the tuplestore */ 
</span>        <a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN96"><span class='Ref_to_Proto'>storeQueryResult</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN974"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN976"><span class='Ref_to_Parameter'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a> <span class='Operator'>&& 
</span>             <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * dblink_res_error will clear the passed PGresult, so we need 
             * this ugly dance to avoid doing so twice during error exit 
             */ 
</span><a name="LN1008"></a>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res1</span> <span class='Operator'>= </span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN114"><span class='Ref_to_Proto'>dblink_res_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN974"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN975"><span class='Ref_to_Parameter'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1008"><span class='Ref_To_Local'>res1</span></a><span class='Delimiter'>, 
</span>                             <span class='String'>"could not execute query"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN977"><span class='Ref_to_Parameter'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* if fail isn't set, we'll return an empty query result */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * storeRow didn't get called, so we need to convert the command 
             * status string to a tuple manually 
             */ 
</span><a name="LN1021"></a>            <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1022"></a>            <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN1023"></a>            <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span><span class='Delimiter'>; 
</span><a name="LN1024"></a>            <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1025"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1026"></a>            <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * need a tuple descriptor representing one TEXT column to return 
             * the command status string as our result tuple 
             */ 
</span>            <a href="dblink.c.html#LN1021"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/backend/access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1021"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"status"</span><span class='Delimiter'>, 
</span>                               <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1022"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1021"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN1026"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>( 
</span>                                    <a href="dblink.c.html#LN979"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1023"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN979"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1023"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN979"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1021"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span>            <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1026"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN1025"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN484"><span class='Ref_to_Proto'>PQcmdStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* build the tuple and put it into the tuplestore. */ 
</span>            <a href="dblink.c.html#LN1024"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1022"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1025"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1023"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1024"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PQresultStatus(res)==... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* storeRow should have created a tuplestore */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN979"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* clean up data conversion short-lived memory context */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN77"><span class='Ref_to_Member'>tmpcontext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN77"><span class='Ref_to_Member'>tmpcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN77"><span class='Ref_to_Member'>tmpcontext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* be sure to release any libpq result we collected */ 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN981"><span class='Ref_To_Local'>sinfo</span></a><span class='Operator'>.</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* and clear out any pending data in libpq */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN974"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN980"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end materializeQueryResult &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Execute query, and send any result rows to sinfo-&GT;tuplestore. 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>* 
</span><a name="LN1091"></a><span class='Declare_Function'>storeQueryResult</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="dblink.c.html#LN72"><span class='Ref_to_Struct'>storeInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sinfo</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sql</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1093"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>first</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN1094"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nestlevel</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1095"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN401"><span class='Ref_to_Proto'>PQsendQuery</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sql</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not send query: %s"</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN420"><span class='Ref_to_Proto'>PQsetSingleRowMode</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span>      <span class='Comment_Single_Line'>/* shouldn't fail */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to set single-row mode for dblink query"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN97"><span class='Ref_to_EnumConst'>PGRES_SINGLE_TUPLE</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* got one row from possibly-bigger resultset */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Set GUCs to ensure we read GUC-sensitive data types correctly. 
             * We shouldn't do this until we have a row in hand, to ensure 
             * libpq has seen any earlier ParameterStatus protocol messages. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1093"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>&& </span><a href="dblink.c.html#LN1094"><span class='Ref_To_Local'>nestlevel</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="dblink.c.html#LN1094"><span class='Ref_To_Local'>nestlevel</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN123"><span class='Ref_to_Proto'>applyRemoteGucs</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dblink.c.html#LN97"><span class='Ref_to_Proto'>storeRow</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1093"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1093"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* if empty resultset, fill tuplestore header */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1093"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>&& </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
                <a href="dblink.c.html#LN97"><span class='Ref_to_Proto'>storeRow</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1093"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* store completed result at last_res */ 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN81"><span class='Ref_to_Member'>cur_res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1093"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* clean up GUC settings, if we changed any */ 
</span>    <a href="dblink.c.html#LN124"><span class='Ref_to_Proto'>restoreLocalGucs</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1094"><span class='Ref_To_Local'>nestlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* return last_res */ 
</span>    <a href="dblink.c.html#LN1095"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1091"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN80"><span class='Ref_to_Member'>last_res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="dblink.c.html#LN1095"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end storeQueryResult &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send single row to sinfo-&GT;tuplestore. 
 * 
 * If "first" is true, create the tuplestore using PGresult's metadata 
 * (in this case the PGresult might contain either zero or one row). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1159"></a><span class='Declare_Function'>storeRow</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="dblink.c.html#LN72"><span class='Ref_to_Struct'>storeInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sinfo</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>first</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1161"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nfields</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1162"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1163"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1164"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>first</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Prepare for new result set */ 
</span><a name="LN1169"></a>        <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN74"><span class='Ref_to_Member'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/fmgr.h.html#LN80"><span class='Ref_to_Member'>resultinfo</span></a><span class='Delimiter'>; 
</span><a name="LN1170"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * It's possible to get more than one result set if the query string 
         * contained multiple SQL commands.  In that case, we follow PQexec's 
         * traditional behavior of throwing away all but the last result. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN75"><span class='Ref_to_Member'>tuplestore</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/tuplestore.h.html#LN88"><span class='Ref_to_Proto'>tuplestore_end</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN75"><span class='Ref_to_Member'>tuplestore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN75"><span class='Ref_to_Member'>tuplestore</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* get a tuple descriptor for our result type */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN74"><span class='Ref_to_Member'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1170"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../src/include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* success */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../src/include/funcapi.h.html#LN153"><span class='Ref_to_EnumConst'>TYPEFUNC_RECORD</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* failed to determine actual type of RECORD */ 
</span>                <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context "</span> 
                                <span class='String'>"that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* result type isn't composite */ 
</span>                <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"return type must be a row type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* make sure we have a persistent copy of the tupdesc */ 
</span>        <a href="dblink.c.html#LN1170"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1170"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check result and tuple descriptor have the same number of columns */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1161"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN1170"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"remote query result rowtype does not match "</span> 
                            <span class='String'>"the specified FROM clause rowtype"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prepare attinmeta for later data conversions */ 
</span>        <a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN76"><span class='Ref_to_Member'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1170"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create a new, empty tuplestore */ 
</span>        <a href="dblink.c.html#LN1164"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1169"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN75"><span class='Ref_to_Member'>tuplestore</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1169"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN75"><span class='Ref_to_Member'>tuplestore</span></a><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1169"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1170"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1164"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done if empty resultset */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Set up sufficiently-wide string pointers array; this won't change 
         * in size so it's easy to preallocate. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN78"><span class='Ref_to_Member'>cstrs</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN78"><span class='Ref_to_Member'>cstrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN78"><span class='Ref_to_Member'>cstrs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1161"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if first &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Should have a single-row result if we get here */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the following work in a temp context that we reset after each tuple. 
     * This cleans up not only the data we have direct access to, but any 
     * cruft the I/O functions might leak. 
     */ 
</span>    <a href="dblink.c.html#LN1164"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN77"><span class='Ref_to_Member'>tmpcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fill cstrs with null-terminated strings of column values. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN1161"><span class='Ref_To_Local'>nfields</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
            <a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN78"><span class='Ref_to_Member'>cstrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN78"><span class='Ref_to_Member'>cstrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN1163"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Convert row to a tuple, and add it to the tuplestore */ 
</span>    <a href="dblink.c.html#LN1162"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN76"><span class='Ref_to_Member'>attinmeta</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN78"><span class='Ref_to_Member'>cstrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN75"><span class='Ref_to_Member'>tuplestore</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1162"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up */ 
</span>    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1164"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1159"><span class='Ref_to_Parameter'>sinfo</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN77"><span class='Ref_to_Member'>tmpcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end storeRow &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * List all open dblink connections by name. 
 * Returns an array of all connection names. 
 * Takes no params 
 */ 
</span><a name="LN1269"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1270"><span class='Ref_to_Func'>dblink_get_connections</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1271"></a><span class='Declare_Function'>dblink_get_connections</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1273"></a>    <a href="../../src/include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1274"></a>    <a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN1275"></a>    <a href="../../src/include/utils/array.h.html#LN167"><span class='Ref_to_Struct'>ArrayBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>astate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN1273"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dblink.c.html#LN1274"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN1273"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* stash away current value */ 
</span>            <a href="dblink.c.html#LN1275"><span class='Ref_To_Local'>astate</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN390"><span class='Ref_to_Proto'>accumArrayResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1275"><span class='Ref_To_Local'>astate</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../src/include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1274"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN139"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1275"><span class='Ref_To_Local'>astate</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/array.h.html#LN245"><span class='Ref_to_Macro'>PG_RETURN_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/array.h.html#LN394"><span class='Ref_to_Proto'>makeArrayResult</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1275"><span class='Ref_To_Local'>astate</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../src/backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_get_connections &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Checks if a given remote connection is busy 
 * 
 * Returns 1 if the connection is busy, 0 otherwise 
 * Params: 
 *  text connection_name - name of the connection to check 
 * 
 */ 
</span><a name="LN1304"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1305"><span class='Ref_to_Func'>dblink_is_busy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1306"></a><span class='Declare_Function'>dblink_is_busy</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1308"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1308"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1308"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN313"><span class='Ref_to_Macro'>PG_RETURN_INT32</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN424"><span class='Ref_to_Proto'>PQisBusy</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1308"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Cancels a running request on a connection 
 * 
 * Returns text: 
 *  "OK" if the cancel request has been sent correctly, 
 *      an error message otherwise 
 * 
 * Params: 
 *  text connection_name - name of the connection to check 
 * 
 */ 
</span><a name="LN1328"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1329"><span class='Ref_to_Func'>dblink_cancel_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1330"></a><span class='Declare_Function'>dblink_cancel_query</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1332"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN1333"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN1334"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN152"><span class='Ref_to_Typedef'>PGcancel</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cancel</span><span class='Delimiter'>; 
</span><a name="LN1335"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>errbuf</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1333"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1334"><span class='Ref_To_Local'>cancel</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN298"><span class='Ref_to_Proto'>PQgetCancel</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1333"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN1332"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN304"><span class='Ref_to_Proto'>PQcancel</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1334"><span class='Ref_To_Local'>cancel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1335"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Number'>256</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN301"><span class='Ref_to_Proto'>PQfreeCancel</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1334"><span class='Ref_To_Local'>cancel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1332"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"OK"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1335"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_cancel_query &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Get error message from a connection 
 * 
 * Returns text: 
 *  "OK" if no error, an error message otherwise 
 * 
 * Params: 
 *  text connection_name - name of the connection to check 
 * 
 */ 
</span><a name="LN1361"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1362"><span class='Ref_to_Func'>dblink_error_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1363"></a><span class='Declare_Function'>dblink_error_message</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1365"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN1366"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1366"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN1365"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1366"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1365"><span class='Ref_To_Local'>msg</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="dblink.c.html#LN1365"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"OK"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1365"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Execute an SQL non-SELECT command 
 */ 
</span><a name="LN1381"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1382"><span class='Ref_to_Func'>dblink_exec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1383"></a><span class='Declare_Function'>dblink_exec</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1385"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>sql_cmd_status</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1386"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>conn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1387"></a>    <span class='Keyword'>volatile bool </span><span class='Declare_Local'>freeconn</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1393"></a>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1394"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1395"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>conname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1396"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>fail</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* default to backward compatible behavior */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* must be text,text,bool */ 
</span>            <a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1394"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1396"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN179"><span class='Ref_to_Func'>dblink_get_conn</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1387"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* might be text,text or text,bool */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="dblink.c.html#LN1394"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN1396"><span class='Ref_To_Local'>fail</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN238"><span class='Ref_to_Macro'>PG_GETARG_BOOL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN1394"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN179"><span class='Ref_to_Func'>dblink_get_conn</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1387"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* must be single text argument */ 
</span>            <a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN1394"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>            <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong number of arguments"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>) 
</span>            dblink_conn_not_avail<span class='Parentheses'>(</span><a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN380"><span class='Ref_to_Proto'>PQexec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1394"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a> <span class='Operator'>&& 
</span>             <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN114"><span class='Ref_to_Proto'>dblink_res_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1395"><span class='Ref_To_Local'>conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, 
</span>                             <span class='String'>"could not execute command"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN1396"><span class='Ref_To_Local'>fail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * and save a copy of the command status string to return as our 
             * result tuple 
             */ 
</span>            <a href="dblink.c.html#LN1385"><span class='Ref_To_Local'>sql_cmd_status</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><span class='String'>"ERROR"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * and save a copy of the command status string to return as our 
             * result tuple 
             */ 
</span>            <a href="dblink.c.html#LN1385"><span class='Ref_To_Local'>sql_cmd_status</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN484"><span class='Ref_to_Proto'>PQcmdStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1393"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_R_E_PROHIBITED_SQL_STATEMENT_ATTEMPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"statement returning results not allowed"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* if needed, close the connection to the database */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1387"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if needed, close the connection to the database */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1387"><span class='Ref_To_Local'>freeconn</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1386"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1385"><span class='Ref_To_Local'>sql_cmd_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_exec &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * dblink_get_pkey 
 * 
 * Return list of primary key fields for the supplied relation, 
 * or NULL if none exists. 
 */ 
</span><a name="LN1489"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1490"><span class='Ref_to_Func'>dblink_get_pkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1491"></a><span class='Declare_Function'>dblink_get_pkey</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1493"></a>    <a href="../../src/include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>numatts</span><span class='Delimiter'>; 
</span><a name="LN1494"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>results</span><span class='Delimiter'>; 
</span><a name="LN1495"></a>    <a href="../../src/include/funcapi.h.html#LN56"><span class='Ref_to_Struct'>FuncCallContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcctx</span><span class='Delimiter'>; 
</span><a name="LN1496"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>call_cntr</span><span class='Delimiter'>; 
</span><a name="LN1497"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>max_calls</span><span class='Delimiter'>; 
</span><a name="LN1498"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN1499"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* stuff done only on the first call of the function */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN284"><span class='Ref_to_Macro'>SRF_IS_FIRSTCALL</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1504"></a>        <a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1505"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* create a function context for cross-call persistence */ 
</span>        <a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN286"><span class='Ref_to_Macro'>SRF_FIRSTCALL_INIT</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * switch to memory context appropriate for multiple function calls 
         */ 
</span>        <a href="dblink.c.html#LN1499"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* open target relation */ 
</span>        <a href="dblink.c.html#LN1504"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN110"><span class='Ref_to_Proto'>get_rel_from_relname</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* get the array of attnums */ 
</span>        <a href="dblink.c.html#LN1494"><span class='Ref_To_Local'>results</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN102"><span class='Ref_to_Proto'>get_pkey_attnames</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1504"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1493"><span class='Ref_To_Local'>numatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1504"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * need a tuple descriptor representing one INT and one TEXT column 
         */ 
</span>        <a href="dblink.c.html#LN1505"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/backend/access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1505"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"position"</span><span class='Delimiter'>, 
</span>                           <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1505"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='String'>"colname"</span><span class='Delimiter'>, 
</span>                           <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Generate attribute metadata needed later to produce tuples from raw 
         * C strings 
         */ 
</span>        <a href="dblink.c.html#LN1498"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1505"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN98"><span class='Ref_to_Member'>attinmeta</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1498"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dblink.c.html#LN1494"><span class='Ref_To_Local'>results</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1493"><span class='Ref_To_Local'>numatts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN73"><span class='Ref_to_Member'>max_calls</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1493"><span class='Ref_To_Local'>numatts</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* got results, keep track of them */ 
</span>            <a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1494"><span class='Ref_To_Local'>results</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* fast track when no results */ 
</span>            <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1499"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1499"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SRF_IS_FIRSTCALL() &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* stuff done on every call of the function */ 
</span>    <a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN288"><span class='Ref_to_Macro'>SRF_PERCALL_SETUP</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize per-call variables 
     */ 
</span>    <a href="dblink.c.html#LN1496"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN64"><span class='Ref_to_Member'>call_cntr</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1497"><span class='Ref_To_Local'>max_calls</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN73"><span class='Ref_to_Member'>max_calls</span></a><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN1494"><span class='Ref_To_Local'>results</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1498"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN98"><span class='Ref_to_Member'>attinmeta</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1496"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN1497"><span class='Ref_To_Local'>max_calls</span></a><span class='Parentheses'>)</span>  <span class='Comment_Single_Line'>/* do when there is more left to send */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1570"></a>        <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN1571"></a>        <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1572"></a>        <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN1570"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1570"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN1496"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN1570"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dblink.c.html#LN1494"><span class='Ref_To_Local'>results</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN1496"><span class='Ref_To_Local'>call_cntr</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* build the tuple */ 
</span>        <a href="dblink.c.html#LN1571"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1498"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1570"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* make the tuple into a datum */ 
</span>        <a href="dblink.c.html#LN1572"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN221"><span class='Ref_to_Macro'>HeapTupleGetDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1571"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/funcapi.h.html#LN290"><span class='Ref_to_Macro'>SRF_RETURN_NEXT</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1572"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* do when there is no more left */ 
</span>        <a href="../../src/include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1495"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end dblink_get_pkey &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * dblink_build_sql_insert 
 * 
 * Used to generate an SQL insert statement 
 * based on an existing tuple in a local relation. 
 * This is useful for selectively replicating data 
 * to another server via dblink. 
 * 
 * API: 
 * &LT;relname&GT; - name of local table of interest 
 * &LT;pkattnums&GT; - an int2vector of attnums which will be used 
 * to identify the local tuple of interest 
 * &LT;pknumatts&GT; - number of attnums in pkattnums 
 * &LT;src_pkattvals_arry&GT; - text array of key values which will be used 
 * to identify the local tuple of interest 
 * &LT;tgt_pkattvals_arry&GT; - text array of key values which will be used 
 * to build the string for execution remotely. These are substituted 
 * for their counterparts in src_pkattvals_arry 
 */ 
</span><a name="LN1613"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1614"><span class='Ref_to_Func'>dblink_build_sql_insert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1615"></a><span class='Declare_Function'>dblink_build_sql_insert</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1617"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>relname_text</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1618"></a>    <a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pkattnums_arg</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1619"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pknumatts_arg</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1620"></a>    <a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>src_pkattvals_arry</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1621"></a>    <a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tgt_pkattvals_arry</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1622"></a>    <a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1623"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>pkattnums</span><span class='Delimiter'>; 
</span><a name="LN1624"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pknumatts</span><span class='Delimiter'>; 
</span><a name="LN1625"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>src_pkattvals</span><span class='Delimiter'>; 
</span><a name="LN1626"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>tgt_pkattvals</span><span class='Delimiter'>; 
</span><a name="LN1627"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>src_nitems</span><span class='Delimiter'>; 
</span><a name="LN1628"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tgt_nitems</span><span class='Delimiter'>; 
</span><a name="LN1629"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open target relation. 
     */ 
</span>    <a href="dblink.c.html#LN1622"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN110"><span class='Ref_to_Proto'>get_rel_from_relname</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1617"><span class='Ref_To_Local'>relname_text</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process pkattnums argument. 
     */ 
</span>    <a href="dblink.c.html#LN118"><span class='Ref_to_Proto'>validate_pkattnums</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1622"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1618"><span class='Ref_To_Local'>pkattnums_arg</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1619"><span class='Ref_To_Local'>pknumatts_arg</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="dblink.c.html#LN1623"><span class='Ref_To_Local'>pkattnums</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1624"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Source array is made up of key values that will be used to locate the 
     * tuple of interest from the local system. 
     */ 
</span>    <a href="dblink.c.html#LN1625"><span class='Ref_To_Local'>src_pkattvals</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN103"><span class='Ref_to_Proto'>get_text_array_contents</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1620"><span class='Ref_To_Local'>src_pkattvals_arry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1627"><span class='Ref_To_Local'>src_nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be one source array key value for each key attnum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1627"><span class='Ref_To_Local'>src_nitems</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN1624"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"source key array length must match number of key "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"attributes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Target array is made up of key values that will be used to build the 
     * SQL string for use on the remote system. 
     */ 
</span>    <a href="dblink.c.html#LN1626"><span class='Ref_To_Local'>tgt_pkattvals</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN103"><span class='Ref_to_Proto'>get_text_array_contents</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1621"><span class='Ref_To_Local'>tgt_pkattvals_arry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1628"><span class='Ref_To_Local'>tgt_nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be one target array key value for each key attnum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1628"><span class='Ref_To_Local'>tgt_nitems</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN1624"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"target key array length must match number of key "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"attributes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prep work is finally done. Go get the SQL string. 
     */ 
</span>    <a href="dblink.c.html#LN1629"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN104"><span class='Ref_to_Proto'>get_sql_insert</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1622"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1623"><span class='Ref_To_Local'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1624"><span class='Ref_To_Local'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1625"><span class='Ref_To_Local'>src_pkattvals</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1626"><span class='Ref_To_Local'>tgt_pkattvals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we can close the relation. 
     */ 
</span>    <a href="../../src/include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1622"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And send it 
     */ 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1629"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_build_sql_insert &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * dblink_build_sql_delete 
 * 
 * Used to generate an SQL delete statement. 
 * This is useful for selectively replicating a 
 * delete to another server via dblink. 
 * 
 * API: 
 * &LT;relname&GT; - name of remote table of interest 
 * &LT;pkattnums&GT; - an int2vector of attnums which will be used 
 * to identify the remote tuple of interest 
 * &LT;pknumatts&GT; - number of attnums in pkattnums 
 * &LT;tgt_pkattvals_arry&GT; - text array of key values which will be used 
 * to build the string for execution remotely. 
 */ 
</span><a name="LN1704"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1705"><span class='Ref_to_Func'>dblink_build_sql_delete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1706"></a><span class='Declare_Function'>dblink_build_sql_delete</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1708"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>relname_text</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1709"></a>    <a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pkattnums_arg</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1710"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pknumatts_arg</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1711"></a>    <a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tgt_pkattvals_arry</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1712"></a>    <a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1713"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>pkattnums</span><span class='Delimiter'>; 
</span><a name="LN1714"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pknumatts</span><span class='Delimiter'>; 
</span><a name="LN1715"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>tgt_pkattvals</span><span class='Delimiter'>; 
</span><a name="LN1716"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tgt_nitems</span><span class='Delimiter'>; 
</span><a name="LN1717"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open target relation. 
     */ 
</span>    <a href="dblink.c.html#LN1712"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN110"><span class='Ref_to_Proto'>get_rel_from_relname</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1708"><span class='Ref_To_Local'>relname_text</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process pkattnums argument. 
     */ 
</span>    <a href="dblink.c.html#LN118"><span class='Ref_to_Proto'>validate_pkattnums</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1712"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1709"><span class='Ref_To_Local'>pkattnums_arg</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1710"><span class='Ref_To_Local'>pknumatts_arg</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="dblink.c.html#LN1713"><span class='Ref_To_Local'>pkattnums</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1714"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Target array is made up of key values that will be used to build the 
     * SQL string for use on the remote system. 
     */ 
</span>    <a href="dblink.c.html#LN1715"><span class='Ref_To_Local'>tgt_pkattvals</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN103"><span class='Ref_to_Proto'>get_text_array_contents</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1711"><span class='Ref_To_Local'>tgt_pkattvals_arry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1716"><span class='Ref_To_Local'>tgt_nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be one target array key value for each key attnum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1716"><span class='Ref_To_Local'>tgt_nitems</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN1714"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"target key array length must match number of key "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"attributes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prep work is finally done. Go get the SQL string. 
     */ 
</span>    <a href="dblink.c.html#LN1717"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN105"><span class='Ref_to_Proto'>get_sql_delete</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1712"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1713"><span class='Ref_To_Local'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1714"><span class='Ref_To_Local'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1715"><span class='Ref_To_Local'>tgt_pkattvals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we can close the relation. 
     */ 
</span>    <a href="../../src/include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1712"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And send it 
     */ 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1717"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_build_sql_delete &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * dblink_build_sql_update 
 * 
 * Used to generate an SQL update statement 
 * based on an existing tuple in a local relation. 
 * This is useful for selectively replicating data 
 * to another server via dblink. 
 * 
 * API: 
 * &LT;relname&GT; - name of local table of interest 
 * &LT;pkattnums&GT; - an int2vector of attnums which will be used 
 * to identify the local tuple of interest 
 * &LT;pknumatts&GT; - number of attnums in pkattnums 
 * &LT;src_pkattvals_arry&GT; - text array of key values which will be used 
 * to identify the local tuple of interest 
 * &LT;tgt_pkattvals_arry&GT; - text array of key values which will be used 
 * to build the string for execution remotely. These are substituted 
 * for their counterparts in src_pkattvals_arry 
 */ 
</span><a name="LN1781"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1782"><span class='Ref_to_Func'>dblink_build_sql_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1783"></a><span class='Declare_Function'>dblink_build_sql_update</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1785"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>relname_text</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1786"></a>    <a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pkattnums_arg</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1787"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pknumatts_arg</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1788"></a>    <a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>src_pkattvals_arry</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1789"></a>    <a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tgt_pkattvals_arry</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1790"></a>    <a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1791"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>pkattnums</span><span class='Delimiter'>; 
</span><a name="LN1792"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pknumatts</span><span class='Delimiter'>; 
</span><a name="LN1793"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>src_pkattvals</span><span class='Delimiter'>; 
</span><a name="LN1794"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>tgt_pkattvals</span><span class='Delimiter'>; 
</span><a name="LN1795"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>src_nitems</span><span class='Delimiter'>; 
</span><a name="LN1796"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tgt_nitems</span><span class='Delimiter'>; 
</span><a name="LN1797"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open target relation. 
     */ 
</span>    <a href="dblink.c.html#LN1790"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN110"><span class='Ref_to_Proto'>get_rel_from_relname</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1785"><span class='Ref_To_Local'>relname_text</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process pkattnums argument. 
     */ 
</span>    <a href="dblink.c.html#LN118"><span class='Ref_to_Proto'>validate_pkattnums</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1790"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1786"><span class='Ref_To_Local'>pkattnums_arg</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1787"><span class='Ref_To_Local'>pknumatts_arg</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="dblink.c.html#LN1791"><span class='Ref_To_Local'>pkattnums</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1792"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Source array is made up of key values that will be used to locate the 
     * tuple of interest from the local system. 
     */ 
</span>    <a href="dblink.c.html#LN1793"><span class='Ref_To_Local'>src_pkattvals</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN103"><span class='Ref_to_Proto'>get_text_array_contents</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1788"><span class='Ref_To_Local'>src_pkattvals_arry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1795"><span class='Ref_To_Local'>src_nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be one source array key value for each key attnum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1795"><span class='Ref_To_Local'>src_nitems</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN1792"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"source key array length must match number of key "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"attributes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Target array is made up of key values that will be used to build the 
     * SQL string for use on the remote system. 
     */ 
</span>    <a href="dblink.c.html#LN1794"><span class='Ref_To_Local'>tgt_pkattvals</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN103"><span class='Ref_to_Proto'>get_text_array_contents</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1789"><span class='Ref_To_Local'>tgt_pkattvals_arry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN1796"><span class='Ref_To_Local'>tgt_nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be one target array key value for each key attnum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1796"><span class='Ref_To_Local'>tgt_nitems</span></a> <span class='Operator'>!= </span><a href="dblink.c.html#LN1792"><span class='Ref_To_Local'>pknumatts</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"target key array length must match number of key "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"attributes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prep work is finally done. Go get the SQL string. 
     */ 
</span>    <a href="dblink.c.html#LN1797"><span class='Ref_To_Local'>sql</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN106"><span class='Ref_to_Proto'>get_sql_update</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1790"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1791"><span class='Ref_To_Local'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1792"><span class='Ref_To_Local'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1793"><span class='Ref_To_Local'>src_pkattvals</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1794"><span class='Ref_To_Local'>tgt_pkattvals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we can close the relation. 
     */ 
</span>    <a href="../../src/include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1790"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And send it 
     */ 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1797"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_build_sql_update &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * dblink_current_query 
 * return the current query string 
 * to allow its use in (among other things) 
 * rewrite rules 
 */ 
</span><a name="LN1862"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1863"><span class='Ref_to_Func'>dblink_current_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1864"></a><span class='Declare_Function'>dblink_current_query</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* This is now just an alias for the built-in function current_query() */ 
</span>    <a href="../../src/include/fmgr.h.html#LN312"><span class='Ref_to_Macro'>PG_RETURN_DATUM</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/adt/misc.c.html#LN189"><span class='Ref_to_Func'>current_query</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Retrieve async notifications for a connection. 
 * 
 * Returns a setof record of notifications, or an empty set if none received. 
 * Can optionally take a named connection as parameter, but uses the unnamed 
 * connection per default. 
 * 
 */ 
</span><a name="LN1878"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DBLINK_NOTIFY_COLS</span>      <span class='Number'>3</span> 
 
<a name="LN1880"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1881"><span class='Ref_to_Func'>dblink_get_notify</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1882"></a><span class='Declare_Function'>dblink_get_notify</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1884"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN1885"></a>    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN160"><span class='Ref_to_Typedef'>PGnotify</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>notify</span><span class='Delimiter'>; 
</span><a name="LN1886"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN1887"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1888"></a>    <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span><span class='Delimiter'>; 
</span><a name="LN1889"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN1890"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN88"><span class='Ref_to_Proto'>prepTuplestoreResult</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN237"><span class='Ref_to_Func'>dblink_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="dblink.c.html#LN1884"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN225"><span class='Ref_to_Func'>dblink_get_named_conn</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dblink.c.html#LN1884"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN127"><span class='Ref_to_Global_Var'>pconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create the tuplestore in per-query memory */ 
</span>    <a href="dblink.c.html#LN1889"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1886"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1890"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1889"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN1887"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/backend/access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1878"><span class='Ref_to_Const'>DBLINK_NOTIFY_COLS</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1887"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"notify_name"</span><span class='Delimiter'>, 
</span>                       <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1887"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='String'>"be_pid"</span><span class='Delimiter'>, 
</span>                       <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1887"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='String'>"extra"</span><span class='Delimiter'>, 
</span>                       <a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN1888"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1886"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1888"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN1886"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1887"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1890"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1884"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN428"><span class='Ref_to_Proto'>PQnotifies</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1884"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1921"></a>        <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="dblink.c.html#LN1878"><span class='Ref_to_Const'>DBLINK_NOTIFY_COLS</span></a><span class='Delimiter'>]; 
</span><a name="LN1922"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="dblink.c.html#LN1878"><span class='Ref_to_Const'>DBLINK_NOTIFY_COLS</span></a><span class='Delimiter'>]; 
</span> 
        memset<span class='Parentheses'>(</span><a href="dblink.c.html#LN1921"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1921"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="dblink.c.html#LN1922"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1922"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN162"><span class='Ref_to_Member'>relname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN1921"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN162"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dblink.c.html#LN1922"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN1921"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN163"><span class='Ref_to_Member'>be_pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN164"><span class='Ref_to_Member'>extra</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN1921"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN164"><span class='Ref_to_Member'>extra</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dblink.c.html#LN1922"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/tuplestore.h.html#LN55"><span class='Ref_to_Proto'>tuplestore_putvalues</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1888"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1887"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1921"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1922"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1885"><span class='Ref_To_Local'>notify</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1884"><span class='Ref_To_Local'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (notify=PQnotifies(co... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* clean up and return the tuplestore */ 
</span>    <a href="../../src/include/utils/tuplestore.h.html#LN59"><span class='Ref_to_Macro'>tuplestore_donestoring</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1888"><span class='Ref_To_Local'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_get_notify &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Validate the options given to a dblink foreign server or user mapping. 
 * Raise an error if any option is invalid. 
 * 
 * We just check the names of options here, so semantic errors in options, 
 * such as invalid numeric format, will be detected at the attempt to connect. 
 */ 
</span><a name="LN1958"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN1959"><span class='Ref_to_Func'>dblink_fdw_validator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1960"></a><span class='Declare_Function'>dblink_fdw_validator</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1962"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>options_list</span> <span class='Operator'>= </span><a href="../../src/include/access/reloptions.h.html#LN260"><span class='Ref_to_Proto'>untransformRelOptions</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1963"></a>    <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>context</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN239"><span class='Ref_to_Macro'>PG_GETARG_OID</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1964"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
<a name="LN1966"></a>    <span class='Keyword'>static const </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get list of valid libpq options. 
     * 
     * To avoid unnecessary work, we get the list once and use it throughout 
     * the lifetime of this backend process.  We don't need to care about 
     * memory context issues, because PQconndefaults allocates with malloc. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN1966"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN1966"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN275"><span class='Ref_to_Proto'>PQconndefaults</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN1966"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>)</span>           <span class='Comment_Single_Line'>/* assume reason for failure is OOM */ 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FDW_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"could not get libpq's default connection options"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Validate each supplied option. */ 
</span>    <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1964"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1962"><span class='Ref_To_Local'>options_list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1988"></a>        <a href="../../src/include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>def</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1964"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN121"><span class='Ref_to_Proto'>is_valid_dblink_option</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1966"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1988"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1963"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Unknown option, or invalid option for the context specified, so 
             * complain about it.  Provide a hint with list of valid options 
             * for the context. 
             */ 
</span><a name="LN1997"></a>            <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1998"></a>            <span class='Keyword'>const </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opt</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN1997"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN1998"><span class='Ref_To_Local'>opt</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN1966"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN1998"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN1998"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN121"><span class='Ref_to_Proto'>is_valid_dblink_option</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN1966"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1998"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN1963"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>))</span> 
                    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN1997"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s%s"</span><span class='Delimiter'>, 
</span>                                     <span class='Parentheses'>(</span><a href="dblink.c.html#LN1997"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='String'>", "</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                                     <a href="dblink.c.html#LN1998"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FDW_OPTION_NAME_NOT_FOUND<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid option \"%s\""</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN1988"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Valid options in this context are: %s"</span><span class='Delimiter'>, 
</span>                             <a href="dblink.c.html#LN1997"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !is_valid_dblink_opti... &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/fmgr.h.html#LN308"><span class='Ref_to_Macro'>PG_RETURN_VOID</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_fdw_validator &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/************************************************************* 
 * internal functions 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_pkey_attnames 
 * 
 * Get the primary key attnames for the given relation. 
 * Return NULL, and set numatts = 0, if no primary key exists. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>** 
</span><a name="LN2032"></a><span class='Declare_Function'>get_pkey_attnames</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numatts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2034"></a>    <a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRelation</span><span class='Delimiter'>; 
</span><a name="LN2035"></a>    <a href="../../src/include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>; 
</span><a name="LN2036"></a>    <a href="../../src/include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN2037"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>indexTuple</span><span class='Delimiter'>; 
</span><a name="LN2038"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2039"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2040"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize numatts to 0 in case no primary key exists */ 
</span>    <span class='Operator'>*</span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>numatts</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2040"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare to scan pg_index for entries having indrelid = this rel. */ 
</span>    <a href="dblink.c.html#LN2034"><span class='Ref_To_Local'>indexRelation</span></a> <span class='Operator'>= </span><a href="../../src/include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../src/include/catalog/pg_index.h.html#LN28"><span class='Ref_to_Const'>IndexRelationId</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/backend/access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2035"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>, 
</span>                <a href="../../src/include/catalog/pg_index.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_index_indrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../src/include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../src/include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2036"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../src/include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2034"><span class='Ref_To_Local'>indexRelation</span></a><span class='Delimiter'>, </span><a href="../../src/include/catalog/indexing.h.html#LN161"><span class='Ref_to_Const'>IndexIndrelidIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN2035"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../src/include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2037"><span class='Ref_To_Local'>indexTuple</span></a> <span class='Operator'>= </span><a href="../../src/include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2036"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2059"></a>        <a href="../../src/include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a> <span class='Declare_Local'>index</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a><span class='Parentheses'>) </span><a href="../../src/include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2037"><span class='Ref_To_Local'>indexTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we're only interested if it is the primary key */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2059"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span>indisprimary<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>numatts</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2059"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span>indnatts<span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>numatts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="dblink.c.html#LN2039"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>numatts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2038"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2038"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; *</span><a href="dblink.c.html#LN2032"><span class='Ref_to_Parameter'>numatts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2038"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                    <a href="dblink.c.html#LN2039"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2038"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN124"><span class='Ref_to_Proto'>SPI_fname</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2040"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2059"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span>indkey<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="dblink.c.html#LN2038"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2036"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2034"><span class='Ref_To_Local'>indexRelation</span></a><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2039"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_pkey_attnames &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Deconstruct a text[] into C-strings (note any NULL elements will be 
 * returned as NULL pointers) 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>** 
</span><a name="LN2087"></a><span class='Declare_Function'>get_text_array_contents</span><span class='Parentheses'>(</span><a href="../../src/include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>numitems</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2089"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndim</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2090"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>dims</span> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2091"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nitems</span><span class='Delimiter'>; 
</span><a name="LN2092"></a>    <a href="../../src/include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>typlen</span><span class='Delimiter'>; 
</span><a name="LN2093"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typbyval</span><span class='Delimiter'>; 
</span><a name="LN2094"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>typalign</span><span class='Delimiter'>; 
</span><a name="LN2095"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN2096"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN2097"></a>    <a href="../../src/include/c.h.html#LN274"><span class='Ref_to_Typedef'>bits8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>bitmap</span><span class='Delimiter'>; 
</span><a name="LN2098"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bitmask</span><span class='Delimiter'>; 
</span><a name="LN2099"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../src/include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>numitems</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2091"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/adt/arrayutils.c.html#LN73"><span class='Ref_to_Func'>ArrayGetNItems</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2089"><span class='Ref_To_Local'>ndim</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2090"><span class='Ref_To_Local'>dims</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/lsyscache.h.html#LN136"><span class='Ref_to_Proto'>get_typlenbyvalalign</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="dblink.c.html#LN2092"><span class='Ref_To_Local'>typlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN2093"><span class='Ref_To_Local'>typbyval</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN2094"><span class='Ref_To_Local'>typalign</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2095"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2091"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2097"><span class='Ref_To_Local'>bitmap</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/array.h.html#LN280"><span class='Ref_to_Macro'>ARR_NULLBITMAP</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2087"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2098"><span class='Ref_To_Local'>bitmask</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2099"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2099"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2091"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2099"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2097"><span class='Ref_To_Local'>bitmap</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dblink.c.html#LN2097"><span class='Ref_To_Local'>bitmap</span></a> <span class='Operator'>& </span><a href="dblink.c.html#LN2098"><span class='Ref_To_Local'>bitmask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN2095"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2099"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN2095"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2099"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupmacs.h.html#LN171"><span class='Ref_to_Macro'>att_addlength_pointer</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2092"><span class='Ref_To_Local'>typlen</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/access/tupmacs.h.html#LN143"><span class='Ref_to_Macro'>att_align_nominal</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2096"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2094"><span class='Ref_To_Local'>typalign</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* advance bitmap pointer if any */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2097"><span class='Ref_To_Local'>bitmap</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dblink.c.html#LN2098"><span class='Ref_To_Local'>bitmask</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2098"><span class='Ref_To_Local'>bitmask</span></a> <span class='Operator'>== </span><span class='Number'>0x100</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="dblink.c.html#LN2097"><span class='Ref_To_Local'>bitmap</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="dblink.c.html#LN2098"><span class='Ref_To_Local'>bitmask</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nitems;i++ &raquo; </span> 
 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2095"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_text_array_contents &raquo; </span> 
 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2143"></a><span class='Declare_Function'>get_sql_insert</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>src_pkattvals</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>tgt_pkattvals</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2145"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span><span class='Delimiter'>; 
</span><a name="LN2146"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN2147"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN2148"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span><span class='Delimiter'>; 
</span><a name="LN2149"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2150"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN2151"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN2152"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2153"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needComma</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get relation name including any needed schema prefix and quoting */ 
</span>    <a href="dblink.c.html#LN2145"><span class='Ref_To_Local'>relname</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN111"><span class='Ref_to_Proto'>generate_relation_name</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2147"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2148"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2147"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2146"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN109"><span class='Ref_to_Proto'>get_tuple_of_interest</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>src_pkattvals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN2146"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CARDINALITY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"source row not found"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"INSERT INTO %s("</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2145"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2153"><span class='Ref_To_Local'>needComma</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2148"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2147"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2153"><span class='Ref_To_Local'>needComma</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                      <a href="dblink.c.html#LN107"><span class='Ref_to_Proto'>quote_ident_cstr</span></a><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2147"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN2153"><span class='Ref_To_Local'>needComma</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>") VALUES("</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: i is physical column number (counting from 0). 
     */ 
</span>    <a href="dblink.c.html#LN2153"><span class='Ref_To_Local'>needComma</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2148"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2147"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2153"><span class='Ref_To_Local'>needComma</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN2151"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN108"><span class='Ref_to_Proto'>get_attnum_pk_pos</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2151"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN2150"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2151"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>] </span><span class='Operator'>? </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2143"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2151"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dblink.c.html#LN2150"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2146"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2147"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2150"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2150"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2150"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN2153"><span class='Ref_To_Local'>needComma</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;natts;i++ &raquo; </span> 
    <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>')'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2149"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_sql_insert &raquo; </span> 
 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2221"></a><span class='Declare_Function'>get_sql_delete</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>tgt_pkattvals</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2223"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span><span class='Delimiter'>; 
</span><a name="LN2224"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN2225"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2226"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get relation name including any needed schema prefix and quoting */ 
</span>    <a href="dblink.c.html#LN2223"><span class='Ref_To_Local'>relname</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN111"><span class='Ref_to_Proto'>generate_relation_name</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2221"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2224"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2221"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"DELETE FROM %s WHERE "</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2223"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2221"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2238"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pkattnum</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2221"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" AND "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>               <a href="dblink.c.html#LN107"><span class='Ref_to_Proto'>quote_ident_cstr</span></a><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2224"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2238"><span class='Ref_To_Local'>pkattnum</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2221"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" = %s"</span><span class='Delimiter'>, 
</span>                             <a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2221"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2226"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" IS NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2225"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_sql_delete &raquo; </span> 
 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2257"></a><span class='Declare_Function'>get_sql_update</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>src_pkattvals</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>tgt_pkattvals</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2259"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span><span class='Delimiter'>; 
</span><a name="LN2260"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN2261"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN2262"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span><span class='Delimiter'>; 
</span><a name="LN2263"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2264"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN2265"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN2266"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2267"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needComma</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get relation name including any needed schema prefix and quoting */ 
</span>    <a href="dblink.c.html#LN2259"><span class='Ref_To_Local'>relname</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN111"><span class='Ref_to_Proto'>generate_relation_name</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2261"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2262"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2261"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2260"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN109"><span class='Ref_to_Proto'>get_tuple_of_interest</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>src_pkattvals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN2260"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CARDINALITY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"source row not found"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"UPDATE %s SET "</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2259"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: i is physical column number (counting from 0). 
     */ 
</span>    <a href="dblink.c.html#LN2267"><span class='Ref_To_Local'>needComma</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2262"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2261"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2267"><span class='Ref_To_Local'>needComma</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s = "</span><span class='Delimiter'>, 
</span>                      <a href="dblink.c.html#LN107"><span class='Ref_to_Proto'>quote_ident_cstr</span></a><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2261"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN2265"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN108"><span class='Ref_to_Proto'>get_attnum_pk_pos</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2265"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2265"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>] </span><span class='Operator'>? </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2265"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2260"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2261"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN2267"><span class='Ref_To_Local'>needComma</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;natts;i++ &raquo; </span> 
 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" WHERE "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2321"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pkattnum</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" AND "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>               <a href="dblink.c.html#LN107"><span class='Ref_to_Proto'>quote_ident_cstr</span></a><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2261"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2321"><span class='Ref_To_Local'>pkattnum</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2257"><span class='Ref_to_Parameter'>tgt_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" = %s"</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2264"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" IS NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2263"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_sql_update &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return a properly quoted identifier. 
 * Uses quote_ident in quote.c 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2345"></a><span class='Declare_Function'>quote_ident_cstr</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rawstr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2347"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>rawstr_text</span><span class='Delimiter'>; 
</span><a name="LN2348"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>result_text</span><span class='Delimiter'>; 
</span><a name="LN2349"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2347"><span class='Ref_To_Local'>rawstr_text</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2345"><span class='Ref_to_Parameter'>rawstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2348"><span class='Ref_To_Local'>result_text</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN255"><span class='Ref_to_Macro'>DatumGetTextPP</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/adt/quote.c.html#LN22"><span class='Ref_to_Func'>quote_ident</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../src/include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2347"><span class='Ref_To_Local'>rawstr_text</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2349"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2348"><span class='Ref_To_Local'>result_text</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2349"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN2360"></a><span class='Declare_Function'>get_attnum_pk_pos</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2362"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Not likely a long list anyway, so just scan for the value 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2362"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2362"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2360"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2362"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2360"><span class='Ref_to_Parameter'>key</span></a> <span class='Operator'>== </span><a href="dblink.c.html#LN2360"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2362"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="dblink.c.html#LN2362"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN2375"></a><span class='Declare_Function'>get_tuple_of_interest</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pknumatts</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>src_pkattvals</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2377"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span><span class='Delimiter'>; 
</span><a name="LN2378"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN2379"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span><span class='Delimiter'>; 
</span><a name="LN2380"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2381"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN2382"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN2383"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Connect to SPI manager 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dblink.c.html#LN2381"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>())</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI connect failure - returned %d"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2381"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get relation name including any needed schema prefix and quoting */ 
</span>    <a href="dblink.c.html#LN2377"><span class='Ref_To_Local'>relname</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN111"><span class='Ref_to_Proto'>generate_relation_name</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2375"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2378"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2375"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2379"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2378"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build sql statement to look up tuple of interest, ie, the one matching 
     * src_pkattvals.  We used to use "SELECT *" here, but it's simpler to 
     * generate a result tuple that matches the table's physical structure, 
     * with NULLs for any dropped columns.  Otherwise we have to deal with two 
     * different tupdescs and everything's very confusing. 
     */ 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2379"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2378"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                      <a href="dblink.c.html#LN107"><span class='Ref_to_Proto'>quote_ident_cstr</span></a><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2378"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" FROM %s WHERE "</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2377"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2375"><span class='Ref_to_Parameter'>pknumatts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2425"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pkattnum</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2375"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" AND "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>               <a href="dblink.c.html#LN107"><span class='Ref_to_Proto'>quote_ident_cstr</span></a><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2378"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2425"><span class='Ref_To_Local'>pkattnum</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2375"><span class='Ref_to_Parameter'>src_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" = %s"</span><span class='Delimiter'>, 
</span>                             <a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2375"><span class='Ref_to_Parameter'>src_pkattvals</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2383"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" IS NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Retrieve the desired tuple 
     */ 
</span>    <a href="dblink.c.html#LN2381"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2380"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Only allow one qualifying tuple 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dblink.c.html#LN2381"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CARDINALITY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"source criteria matched more than one record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2381"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a> <span class='Operator'>&& </span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2456"></a>        <a href="../../src/include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tuptable</span> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN2382"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN119"><span class='Ref_to_Proto'>SPI_copytuple</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2456"><span class='Ref_To_Local'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="dblink.c.html#LN2382"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * no qualifying tuples 
         */ 
</span>        <a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * never reached, but keep compiler quiet 
     */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_tuple_of_interest &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Open the relation named by relname_text, acquire specified type of lock, 
 * verify we have specified permissions. 
 * Caller must close rel when done with it. 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN2485"></a><span class='Declare_Function'>get_rel_from_relname</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relname_text</span><span class='Delimiter'>, </span><a href="../../src/include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN69"><span class='Ref_to_Typedef'>AclMode</span></a> <span class='Declare_Parameter'>aclmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2487"></a>    <a href="../../src/include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>relvar</span><span class='Delimiter'>; 
</span><a name="LN2488"></a>    <a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN2489"></a>    <a href="../../src/include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2487"><span class='Ref_To_Local'>relvar</span></a> <span class='Operator'>= </span><a href="../../src/include/catalog/namespace.h.html#LN119"><span class='Ref_to_Proto'>makeRangeVarFromNameList</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/varlena.h.html#LN28"><span class='Ref_to_Proto'>textToQualifiedNameList</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2485"><span class='Ref_to_Parameter'>relname_text</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2488"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../src/include/access/heapam.h.html#LN92"><span class='Ref_to_Proto'>heap_openrv</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2487"><span class='Ref_To_Local'>relvar</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2485"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2489"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/acl.h.html#LN283"><span class='Ref_to_Proto'>pg_class_aclcheck</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2488"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                  <a href="dblink.c.html#LN2485"><span class='Ref_to_Parameter'>aclmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2489"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../src/include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2489"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, 
</span>                       <a href="../../src/include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2488"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2488"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * generate_relation_name - copied from ruleutils.c 
 *      Compute the name to display for a relation 
 * 
 * The result includes all necessary quoting and schema-prefixing. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2510"></a><span class='Declare_Function'>generate_relation_name</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2512"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nspname</span><span class='Delimiter'>; 
</span><a name="LN2513"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Qualify the name if not visible in search path */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/catalog/namespace.h.html#LN65"><span class='Ref_to_Proto'>RelationIsVisible</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2510"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span> 
        <a href="dblink.c.html#LN2512"><span class='Ref_To_Local'>nspname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dblink.c.html#LN2512"><span class='Ref_To_Local'>nspname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2510"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2513"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN78"><span class='Ref_to_Proto'>quote_qualified_identifier</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2512"><span class='Ref_To_Local'>nspname</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2510"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2513"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Keyword'>static </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>* 
</span><a name="LN2528"></a><span class='Declare_Function'>getConnectionByName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2530"></a>    <a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN2531"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN99"><span class='Ref_to_Proto'>createConnHash</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2531"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2528"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/parser/scansup.h.html#LN25"><span class='Ref_to_Proto'>truncate_identifier</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2531"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="dblink.c.html#LN2531"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2530"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Delimiter'>, 
</span>                                               <a href="dblink.c.html#LN2531"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2530"><span class='Ref_To_Local'>hentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2530"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN140"><span class='Ref_to_Member'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>* 
</span><a name="LN2548"></a><span class='Declare_Function'>createConnHash</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2550"></a>    <a href="../../src/include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2550"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2550"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../src/include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Remote Con hash"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN144"><span class='Ref_to_Const'>NUMCONN</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN2550"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN2559"></a><span class='Declare_Function'>createNewConnection</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rconn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2561"></a>    <a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN2562"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN2563"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN99"><span class='Ref_to_Proto'>createConnHash</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2563"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2559"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/parser/scansup.h.html#LN25"><span class='Ref_to_Proto'>truncate_identifier</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2563"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="dblink.c.html#LN2563"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2561"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2563"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                                               <a href="../../src/include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN2562"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2562"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2559"><span class='Ref_to_Parameter'>rconn</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN67"><span class='Ref_to_Member'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2559"><span class='Ref_to_Parameter'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate connection name"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="dblink.c.html#LN2561"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN140"><span class='Ref_to_Member'>rconn</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2559"><span class='Ref_to_Parameter'>rconn</span></a><span class='Delimiter'>; 
</span>    <a href="../../src/port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2561"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN139"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2559"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN2561"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dblink.c.html#LN139"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end createNewConnection &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN2588"></a><span class='Declare_Function'>deleteConnection</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2590"></a>    <a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN2591"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN2592"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN99"><span class='Ref_to_Proto'>createConnHash</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2592"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2588"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/parser/scansup.h.html#LN25"><span class='Ref_to_Proto'>truncate_identifier</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2592"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="dblink.c.html#LN2592"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2590"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dblink.c.html#LN137"><span class='Ref_to_Struct'>remoteConnHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN128"><span class='Ref_to_Global_Var'>remoteConnHash</span></a><span class='Delimiter'>, 
</span>                                               <a href="dblink.c.html#LN2592"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dblink.c.html#LN2591"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN2590"><span class='Ref_To_Local'>hentry</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"undefined connection name"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end deleteConnection &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN2610"></a><span class='Declare_Function'>dblink_security_check</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN65"><span class='Ref_to_Struct'>remoteConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rconn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../src/backend/utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN327"><span class='Ref_to_Proto'>PQconnectionUsedPassword</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2610"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2610"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2610"><span class='Ref_to_Parameter'>rconn</span></a><span class='Parentheses'>) 
</span>                <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2610"><span class='Ref_to_Parameter'>rconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_R_E_PROHIBITED_SQL_STATEMENT_ATTEMPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"password is required"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Non-superuser cannot connect if the server does not request a password."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../src/backend/utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Target server's authentication method must be changed."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * For non-superusers, insist that the connstr specify a password.  This 
 * prevents a password from being picked up from .pgpass, a service file, 
 * the environment, etc.  We don't want the postgres user's passwords 
 * to be accessible to non-superusers. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2636"></a><span class='Declare_Function'>dblink_connstr_check</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>connstr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../src/backend/utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2640"></a>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span><span class='Delimiter'>; 
</span><a name="LN2641"></a>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>option</span><span class='Delimiter'>; 
</span><a name="LN2642"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>connstr_gives_password</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN2640"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN278"><span class='Ref_to_Proto'>PQconninfoParse</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2636"><span class='Ref_to_Parameter'>connstr</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2640"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2641"><span class='Ref_To_Local'>option</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2640"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2641"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2641"><span class='Ref_To_Local'>option</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dblink.c.html#LN2641"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><span class='String'>"password"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2641"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="dblink.c.html#LN2641"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="dblink.c.html#LN2642"><span class='Ref_To_Local'>connstr_gives_password</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN284"><span class='Ref_to_Proto'>PQconninfoFree</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2640"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN2642"><span class='Ref_To_Local'>connstr_gives_password</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_R_E_PROHIBITED_SQL_STATEMENT_ATTEMPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"password is required"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Non-superusers must provide a password in the connection string."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !superuser() &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end dblink_connstr_check &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN2670"></a><span class='Declare_Function'>dblink_res_error</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conname</span><span class='Delimiter'>, </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, 
</span><a name="LN2671"></a>                 <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dblink_context_msg</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>fail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2673"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>level</span><span class='Delimiter'>; 
</span><a name="LN2674"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pg_diag_sqlstate</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN56"><span class='Ref_to_Const'>PG_DIAG_SQLSTATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2675"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pg_diag_message_primary</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN57"><span class='Ref_to_Const'>PG_DIAG_MESSAGE_PRIMARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2676"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pg_diag_message_detail</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN58"><span class='Ref_to_Const'>PG_DIAG_MESSAGE_DETAIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2677"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pg_diag_message_hint</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN59"><span class='Ref_to_Const'>PG_DIAG_MESSAGE_HINT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2678"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pg_diag_context</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN472"><span class='Ref_to_Proto'>PQresultErrorField</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN63"><span class='Ref_to_Const'>PG_DIAG_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2679"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>sqlstate</span><span class='Delimiter'>; 
</span><a name="LN2680"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>message_primary</span><span class='Delimiter'>; 
</span><a name="LN2681"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>message_detail</span><span class='Delimiter'>; 
</span><a name="LN2682"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>message_hint</span><span class='Delimiter'>; 
</span><a name="LN2683"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>message_context</span><span class='Delimiter'>; 
</span><a name="LN2684"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>dblink_context_conname</span> <span class='Operator'>= </span><span class='String'>"unnamed"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2671"><span class='Ref_to_Parameter'>fail</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN2673"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dblink.c.html#LN2673"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2674"><span class='Ref_To_Local'>pg_diag_sqlstate</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN2679"><span class='Ref_To_Local'>sqlstate</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/elog.h.html#LN61"><span class='Ref_to_Macro'>MAKE_SQLSTATE</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2674"><span class='Ref_To_Local'>pg_diag_sqlstate</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                                 <a href="dblink.c.html#LN2674"><span class='Ref_To_Local'>pg_diag_sqlstate</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                                 <a href="dblink.c.html#LN2674"><span class='Ref_To_Local'>pg_diag_sqlstate</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], 
</span>                                 <a href="dblink.c.html#LN2674"><span class='Ref_To_Local'>pg_diag_sqlstate</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>], 
</span>                                 <a href="dblink.c.html#LN2674"><span class='Ref_To_Local'>pg_diag_sqlstate</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dblink.c.html#LN2679"><span class='Ref_To_Local'>sqlstate</span></a> <span class='Operator'>= </span>ERRCODE_CONNECTION_FAILURE<span class='Delimiter'>; 
</span> 
    <a href="dblink.c.html#LN2680"><span class='Ref_To_Local'>message_primary</span></a> <span class='Operator'>= </span><a href="../tablefunc/tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2675"><span class='Ref_To_Local'>pg_diag_message_primary</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2681"><span class='Ref_To_Local'>message_detail</span></a> <span class='Operator'>= </span><a href="../tablefunc/tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2676"><span class='Ref_To_Local'>pg_diag_message_detail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2682"><span class='Ref_To_Local'>message_hint</span></a> <span class='Operator'>= </span><a href="../tablefunc/tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2677"><span class='Ref_To_Local'>pg_diag_message_hint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2683"><span class='Ref_To_Local'>message_context</span></a> <span class='Operator'>= </span><a href="../tablefunc/tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2678"><span class='Ref_To_Local'>pg_diag_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we don't get a message from the PGresult, try the PGconn.  This is 
     * needed because for connection-level failures, PQexec may just return 
     * NULL, not a PGresult at all. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2680"><span class='Ref_To_Local'>message_primary</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN2680"><span class='Ref_To_Local'>message_primary</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>conname</span></a><span class='Parentheses'>) 
</span>        <a href="dblink.c.html#LN2684"><span class='Ref_To_Local'>dblink_context_conname</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2670"><span class='Ref_to_Parameter'>conname</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2673"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2679"><span class='Ref_To_Local'>sqlstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="dblink.c.html#LN2680"><span class='Ref_To_Local'>message_primary</span></a> <span class='Operator'>? </span><a href="../../src/backend/utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2680"><span class='Ref_To_Local'>message_primary</span></a><span class='Parentheses'>) </span><span class='Operator'>: 
</span>             <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not obtain message string for remote error"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="dblink.c.html#LN2681"><span class='Ref_To_Local'>message_detail</span></a> <span class='Operator'>? </span><a href="../../src/backend/utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2681"><span class='Ref_To_Local'>message_detail</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>             <a href="dblink.c.html#LN2682"><span class='Ref_To_Local'>message_hint</span></a> <span class='Operator'>? </span><a href="../../src/backend/utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2682"><span class='Ref_To_Local'>message_hint</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>             <a href="dblink.c.html#LN2683"><span class='Ref_To_Local'>message_context</span></a> <span class='Operator'>? </span>errcontext<span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2683"><span class='Ref_To_Local'>message_context</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>          errcontext<span class='Parentheses'>(</span><span class='String'>"Error occurred on dblink connection named \"%s\": %s."</span><span class='Delimiter'>, 
</span>                     <a href="dblink.c.html#LN2684"><span class='Ref_To_Local'>dblink_context_conname</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2671"><span class='Ref_to_Parameter'>dblink_context_msg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dblink_res_error &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Obtain connection string for a foreign server 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2734"></a><span class='Declare_Function'>get_connect_string</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>servername</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2736"></a>    <a href="../../src/include/foreign/foreign.h.html#LN44"><span class='Ref_to_Struct'>ForeignServer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>foreign_server</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2737"></a>    <a href="../../src/include/foreign/foreign.h.html#LN55"><span class='Ref_to_Struct'>UserMapping</span></a> <span class='Operator'>*</span><span class='Declare_Local'>user_mapping</span><span class='Delimiter'>; 
</span><a name="LN2738"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN2739"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2740"></a>    <a href="../../src/include/foreign/foreign.h.html#LN34"><span class='Ref_to_Struct'>ForeignDataWrapper</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fdw</span><span class='Delimiter'>; 
</span><a name="LN2741"></a>    <a href="../../src/include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span><a name="LN2742"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>srvname</span><span class='Delimiter'>; 
</span> 
<a name="LN2744"></a>    <span class='Keyword'>static const </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2739"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get list of valid libpq options. 
     * 
     * To avoid unnecessary work, we get the list once and use it throughout 
     * the lifetime of this backend process.  We don't need to care about 
     * memory context issues, because PQconndefaults allocates with malloc. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN2744"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dblink.c.html#LN2744"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN275"><span class='Ref_to_Proto'>PQconndefaults</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dblink.c.html#LN2744"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>)</span>           <span class='Comment_Single_Line'>/* assume reason for failure is OOM */ 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FDW_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"could not get libpq's default connection options"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* first gather the server connstr options */ 
</span>    <a href="dblink.c.html#LN2742"><span class='Ref_To_Local'>srvname</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2734"><span class='Ref_to_Parameter'>servername</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/parser/scansup.h.html#LN25"><span class='Ref_to_Proto'>truncate_identifier</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2742"><span class='Ref_To_Local'>srvname</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="dblink.c.html#LN2742"><span class='Ref_To_Local'>srvname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dblink.c.html#LN2736"><span class='Ref_To_Local'>foreign_server</span></a> <span class='Operator'>= </span><a href="../../src/include/foreign/foreign.h.html#LN72"><span class='Ref_to_Proto'>GetForeignServerByName</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2742"><span class='Ref_To_Local'>srvname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2736"><span class='Ref_To_Local'>foreign_server</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2772"></a>        <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>serverid</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2736"><span class='Ref_To_Local'>foreign_server</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/foreign/foreign.h.html#LN46"><span class='Ref_to_Member'>serverid</span></a><span class='Delimiter'>; 
</span><a name="LN2773"></a>        <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fdwid</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2736"><span class='Ref_To_Local'>foreign_server</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/foreign/foreign.h.html#LN47"><span class='Ref_to_Member'>fdwid</span></a><span class='Delimiter'>; 
</span><a name="LN2774"></a>        <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>userid</span> <span class='Operator'>= </span><a href="../../src/backend/utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="dblink.c.html#LN2737"><span class='Ref_To_Local'>user_mapping</span></a> <span class='Operator'>= </span><a href="../../src/include/foreign/foreign.h.html#LN73"><span class='Ref_to_Proto'>GetUserMapping</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2774"><span class='Ref_To_Local'>userid</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2772"><span class='Ref_To_Local'>serverid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dblink.c.html#LN2740"><span class='Ref_To_Local'>fdw</span></a> <span class='Operator'>= </span><a href="../../src/backend/foreign/foreign.c.html#LN33"><span class='Ref_to_Func'>GetForeignDataWrapper</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2773"><span class='Ref_To_Local'>fdwid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check permissions, user must have usage on the server. */ 
</span>        <a href="dblink.c.html#LN2741"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/acl.h.html#LN292"><span class='Ref_to_Proto'>pg_foreign_server_aclcheck</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2772"><span class='Ref_To_Local'>serverid</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2774"><span class='Ref_To_Local'>userid</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/parsenodes.h.html#LN79"><span class='Ref_to_Const'>ACL_USAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2741"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../src/include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2741"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/acl.h.html#LN199"><span class='Ref_to_EnumConst'>ACL_KIND_FOREIGN_SERVER</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2736"><span class='Ref_To_Local'>foreign_server</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/foreign/foreign.h.html#LN49"><span class='Ref_to_Member'>servername</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2738"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2740"><span class='Ref_To_Local'>fdw</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/foreign/foreign.h.html#LN41"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2786"></a>            <a href="../../src/include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>def</span> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2738"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN121"><span class='Ref_to_Proto'>is_valid_dblink_option</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2744"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2786"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><a href="../../src/include/catalog/pg_foreign_data_wrapper.h.html#LN28"><span class='Ref_to_Const'>ForeignDataWrapperRelationId</span></a><span class='Parentheses'>))</span> 
                <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2739"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s='%s' "</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2786"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, 
</span>                                 <a href="dblink.c.html#LN117"><span class='Ref_to_Proto'>escape_param_str</span></a><span class='Parentheses'>(</span><a href="../../src/include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2786"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2738"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2736"><span class='Ref_To_Local'>foreign_server</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/foreign/foreign.h.html#LN52"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2795"></a>            <a href="../../src/include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>def</span> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2738"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN121"><span class='Ref_to_Proto'>is_valid_dblink_option</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2744"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2795"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><a href="../../src/include/catalog/pg_foreign_server.h.html#LN26"><span class='Ref_to_Const'>ForeignServerRelationId</span></a><span class='Parentheses'>))</span> 
                <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2739"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s='%s' "</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2795"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, 
</span>                                 <a href="dblink.c.html#LN117"><span class='Ref_to_Proto'>escape_param_str</span></a><span class='Parentheses'>(</span><a href="../../src/include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2795"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2738"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2737"><span class='Ref_To_Local'>user_mapping</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/foreign/foreign.h.html#LN60"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span> 
<a name="LN2805"></a>            <a href="../../src/include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>def</span> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2738"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN121"><span class='Ref_to_Proto'>is_valid_dblink_option</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2744"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2805"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><a href="../../src/include/catalog/pg_user_mapping.h.html#LN26"><span class='Ref_to_Const'>UserMappingRelationId</span></a><span class='Parentheses'>))</span> 
                <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2739"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s='%s' "</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2805"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, 
</span>                                 <a href="dblink.c.html#LN117"><span class='Ref_to_Proto'>escape_param_str</span></a><span class='Parentheses'>(</span><a href="../../src/include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2805"><span class='Ref_To_Local'>def</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>return</span> <a href="dblink.c.html#LN2739"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if foreign_server &raquo; </span> 
    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_connect_string &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Escaping libpq connect parameter strings. 
 * 
 * Replaces "'" with "\'" and "\" with "\\". 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2824"></a><span class='Declare_Function'>escape_param_str</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2826"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>cp</span><span class='Delimiter'>; 
</span><a name="LN2827"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2827"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2826"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2824"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>; </span><span class='Operator'>*</span><a href="dblink.c.html#LN2826"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2826"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dblink.c.html#LN2826"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>== </span><span class='String'>'\\'</span> <span class='Operator'>|| *</span><a href="dblink.c.html#LN2826"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>== </span><span class='String'>'\''</span><span class='Parentheses'>) 
</span>            <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2827"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'\\'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dblink.c.html#LN2827"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="dblink.c.html#LN2826"><span class='Ref_To_Local'>cp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2827"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Validate the PK-attnums argument for dblink_build_sql_insert() and related 
 * functions, and translate to the internal representation. 
 * 
 * The user supplies an int2vector of 1-based logical attnums, plus a count 
 * argument (the need for the separate count argument is historical, but we 
 * still check it).  We check that each attnum corresponds to a valid, 
 * non-dropped attribute of the rel.  We do *not* prevent attnums from being 
 * listed twice, though the actual use-case for such things is dubious. 
 * Note that before Postgres 9.0, the user's attnums were interpreted as 
 * physical not logical column numbers; this was changed for future-proofing. 
 * 
 * The internal representation is a palloc'd int array of 0-based physical 
 * attnums. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2857"></a><span class='Declare_Function'>validate_pkattnums</span><span class='Parentheses'>(</span><a href="../../src/include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN2858"></a>                   <a href="../../src/include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pkattnums_arg</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>pknumatts_arg</span><span class='Delimiter'>, 
</span><a name="LN2859"></a>                   <span class='Keyword'>int </span><span class='Operator'>**</span><span class='Declare_Parameter'>pkattnums</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>pknumatts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2861"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2857"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span><a name="LN2862"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2861"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN2863"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't take more array elements than there are */ 
</span>    <a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pknumatts_arg</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pknumatts_arg</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pkattnums_arg</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/c.h.html#LN472"><span class='Ref_to_Member'>dim1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must have at least one pk attnum selected */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pknumatts_arg</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"number of key attributes must be &GT; 0"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate output array */ 
</span>    <span class='Operator'>*</span><a href="dblink.c.html#LN2859"><span class='Ref_to_Parameter'>pkattnums</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pknumatts_arg</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="dblink.c.html#LN2859"><span class='Ref_to_Parameter'>pknumatts</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pknumatts_arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Validate attnums and convert to internal form */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2863"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2863"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pknumatts_arg</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2863"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2881"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pkattnum</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2858"><span class='Ref_to_Parameter'>pkattnums_arg</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/c.h.html#LN474"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2863"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2882"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>lnum</span><span class='Delimiter'>; 
</span><a name="LN2883"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can throw error immediately if out of range */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2881"><span class='Ref_To_Local'>pkattnum</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="dblink.c.html#LN2881"><span class='Ref_To_Local'>pkattnum</span></a> <span class='Operator'>&GT; </span><a href="dblink.c.html#LN2862"><span class='Ref_To_Local'>natts</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid attribute number %d"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2881"><span class='Ref_To_Local'>pkattnum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Identify which physical column has this logical number */ 
</span>        <a href="dblink.c.html#LN2882"><span class='Ref_To_Local'>lnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2883"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2883"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2862"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2883"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* dropped columns don't count */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2861"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2883"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="dblink.c.html#LN2882"><span class='Ref_To_Local'>lnum</span></a> <span class='Operator'>== </span><a href="dblink.c.html#LN2881"><span class='Ref_To_Local'>pkattnum</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2883"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="dblink.c.html#LN2862"><span class='Ref_To_Local'>natts</span></a><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dblink.c.html#LN2859"><span class='Ref_to_Parameter'>pkattnums</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><a href="dblink.c.html#LN2863"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dblink.c.html#LN2883"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid attribute number %d"</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN2881"><span class='Ref_To_Local'>pkattnum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;pknumatts_arg;i... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end validate_pkattnums &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if the specified connection option is valid. 
 * 
 * We basically allow whatever libpq thinks is an option, with these 
 * restrictions: 
 *      debug options: disallowed 
 *      "client_encoding": disallowed 
 *      "user": valid only in USER MAPPING options 
 *      secure options (eg password): valid only in USER MAPPING options 
 *      others: valid only in FOREIGN SERVER options 
 * 
 * We disallow client_encoding because it would be overridden anyway via 
 * PQclientEncoding; allowing it to be specified would merely promote 
 * confusion. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2928"></a><span class='Declare_Function'>is_valid_dblink_option</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>option</span><span class='Delimiter'>, 
</span><a name="LN2929"></a>                       <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2931"></a>    <span class='Keyword'>const </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up the option in libpq result */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a> <span class='Operator'>= </span><a href="dblink.c.html#LN2928"><span class='Ref_to_Parameter'>options</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>; </span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2928"><span class='Ref_to_Parameter'>option</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Disallow debug options (particularly "replication") */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN207"><span class='Ref_to_Member'>dispchar</span></a><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Disallow "client_encoding" */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><span class='String'>"client_encoding"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the option is "user" or marked secure, it should be specified only 
     * in USER MAPPING.  Others should be specified only in SERVER. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><span class='String'>"user"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strchr<span class='Parentheses'>(</span><a href="dblink.c.html#LN2931"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>-&GT;</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN207"><span class='Ref_to_Member'>dispchar</span></a><span class='Delimiter'>, </span><span class='String'>'*'</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2929"><span class='Ref_to_Parameter'>context</span></a> <span class='Operator'>!= </span><a href="../../src/include/catalog/pg_user_mapping.h.html#LN26"><span class='Ref_to_Const'>UserMappingRelationId</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2929"><span class='Ref_to_Parameter'>context</span></a> <span class='Operator'>!= </span><a href="../../src/include/catalog/pg_foreign_server.h.html#LN26"><span class='Ref_to_Const'>ForeignServerRelationId</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end is_valid_dblink_option &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Copy the remote session's values of GUCs that affect datatype I/O 
 * and apply them locally in a new GUC nesting level.  Returns the new 
 * nestlevel (which is needed by restoreLocalGucs to undo the settings), 
 * or -1 if no new nestlevel was needed. 
 * 
 * We use the equivalent of a function SET option to allow the settings to 
 * persist only until the caller calls restoreLocalGucs.  If an error is 
 * thrown in between, guc.c will take care of undoing the settings. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2979"></a><span class='Declare_Function'>applyRemoteGucs</span><span class='Parentheses'>(</span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2981"></a>    <span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Local'>GUCsAffectingIO</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='String'>"DateStyle"</span><span class='Delimiter'>, 
</span>        <span class='String'>"IntervalStyle"</span> 
    <span class='Delimiter'>}; 
</span> 
<a name="LN2986"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nestlevel</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN2987"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2987"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2987"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../src/include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2981"><span class='Ref_To_Local'>GUCsAffectingIO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="dblink.c.html#LN2987"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2991"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>gucName</span> <span class='Operator'>= </span><a href="dblink.c.html#LN2981"><span class='Ref_To_Local'>GUCsAffectingIO</span></a><span class='Delimiter'>[</span><a href="dblink.c.html#LN2987"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2992"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>remoteVal</span> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/libpq-fe.h.html#LN319"><span class='Ref_to_Proto'>PQparameterStatus</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2979"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2991"><span class='Ref_To_Local'>gucName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2993"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>localVal</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the remote server is pre-8.4, it won't have IntervalStyle, but 
         * that's okay because its output format won't be ambiguous.  So just 
         * skip the GUC if we don't get a value for it.  (We might eventually 
         * need more complicated logic with remote-version checks here.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2992"><span class='Ref_To_Local'>remoteVal</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Avoid GUC-setting overhead if the remote and local GUCs already 
         * have the same value. 
         */ 
</span>        <a href="dblink.c.html#LN2993"><span class='Ref_To_Local'>localVal</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/guc.h.html#LN346"><span class='Ref_to_Proto'>GetConfigOption</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2991"><span class='Ref_To_Local'>gucName</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dblink.c.html#LN2993"><span class='Ref_To_Local'>localVal</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dblink.c.html#LN2992"><span class='Ref_To_Local'>remoteVal</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2993"><span class='Ref_To_Local'>localVal</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create new GUC nest level if we didn't already */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN2986"><span class='Ref_To_Local'>nestlevel</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="dblink.c.html#LN2986"><span class='Ref_To_Local'>nestlevel</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/guc.h.html#LN354"><span class='Ref_to_Proto'>NewGUCNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Apply the option (this will throw error on failure) */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../src/include/utils/guc.h.html#LN361"><span class='Ref_to_Proto'>set_config_option</span></a><span class='Parentheses'>(</span><a href="dblink.c.html#LN2991"><span class='Ref_To_Local'>gucName</span></a><span class='Delimiter'>, </span><a href="dblink.c.html#LN2992"><span class='Ref_To_Local'>remoteVal</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../src/include/utils/guc.h.html#LN75"><span class='Ref_to_EnumConst'>PGC_USERSET</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/guc.h.html#LN119"><span class='Ref_to_EnumConst'>PGC_S_SESSION</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../src/include/utils/guc.h.html#LN195"><span class='Ref_to_EnumConst'>GUC_ACTION_SAVE</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;lengthof(GUCsAf... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="dblink.c.html#LN2986"><span class='Ref_To_Local'>nestlevel</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end applyRemoteGucs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Restore local GUCs after they have been overlaid with remote settings. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3031"></a><span class='Declare_Function'>restoreLocalGucs</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nestlevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Do nothing if no new nestlevel was created */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dblink.c.html#LN3031"><span class='Ref_to_Parameter'>nestlevel</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="dblink.c.html#LN3031"><span class='Ref_to_Parameter'>nestlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>