<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\pg_standby\pg_standby.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\pg_standby\pg_standby.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:26 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * contrib/pg_standby/pg_standby.c 
 * 
 * 
 * pg_standby.c 
 * 
 * Production-ready example of how to create a Warm Standby 
 * database server using continuous archiving as a 
 * replication mechanism 
 * 
 * We separate the parameters for archive and nextWALfile 
 * so that we can check the archive exists, even if the 
 * WAL file doesn't (yet). 
 * 
 * This program will be executed once in full for each file 
 * requested by the warm standby server. 
 * 
 * It is designed to cater to a variety of needs, as well 
 * providing a customizable section. 
 * 
 * Original author:     Simon Riggs  simon@2ndquadrant.com 
 * Current maintainer:  Simon Riggs 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;dirent.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"pg_getopt.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
 
<a name="LN36"></a><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Var'>progname</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Options and defaults */ 
</span><a name="LN39"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>sleeptime</span> <span class='Operator'>= </span><span class='Number'>5</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* amount of time to sleep between file checks */ 
</span><a name="LN40"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>waittime</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Multi_Line'>/* how long we have been waiting, -1 no wait 
                                 * yet */ 
</span><a name="LN42"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>maxwaittime</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* how long are we prepared to wait for? */ 
</span><a name="LN43"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>keepfiles</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* number of WAL files to keep, 0 keep all */ 
</span><a name="LN44"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>maxretries</span> <span class='Operator'>= </span><span class='Number'>3</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* number of retries on restore command */ 
</span><a name="LN45"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>debug</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* are we debugging? */ 
</span><a name="LN46"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>need_cleanup</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>       <span class='Comment_Multi_Line'>/* do we need to remove files from 
                                         * archive? */ 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN50"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>signaled</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN53"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>archiveLocation</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* where to find the archive? */ 
</span><a name="LN54"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>triggerPath</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* where to find the trigger file? */ 
</span><a name="LN55"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>xlogFilePath</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* where we are going to restore to */ 
</span><a name="LN56"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>nextWALFileName</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* the file we need to get from archive */ 
</span><a name="LN57"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>restartWALFileName</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* the file from which we can restart restore */ 
</span><a name="LN58"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>priorWALFileName</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* the file we need to get from archive */ 
</span><a name="LN59"></a><span class='Keyword'>char</span>        <span class='Declare_Var'>WALFilePath</span><span class='Delimiter'>[</span><a href="../../src/include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; </span><span class='Comment_Single_Line'>/* the file path including archive */ 
</span><a name="LN60"></a><span class='Keyword'>char</span>        <span class='Declare_Var'>restoreCommand</span><span class='Delimiter'>[</span><a href="../../src/include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>];</span>  <span class='Comment_Single_Line'>/* run this to restore */ 
</span><a name="LN61"></a><span class='Keyword'>char</span>        <span class='Declare_Var'>exclusiveCleanupFileName</span><span class='Delimiter'>[</span><a href="../../src/include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>];</span>      <span class='Comment_Multi_Line'>/* the file we need to 
                                                         * get from archive */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Two types of failover are supported (smart and fast failover). 
 * 
 * The content of the trigger file determines the type of failover. If the 
 * trigger file contains the word "smart" (or the file is empty), smart 
 * failover is chosen: pg_standby acts as cp or ln command itself, on 
 * successful completion all the available WAL records will be applied 
 * resulting in zero data loss. But, it might take a long time to finish 
 * recovery if there's a lot of unapplied WAL. 
 * 
 * On the other hand, if the trigger file contains the word "fast", the 
 * recovery is finished immediately even if unapplied WAL files remain. Any 
 * transactions in the unapplied WAL files are lost. 
 * 
 * An empty trigger file performs smart failover. SIGUSR or SIGINT triggers 
 * fast failover. A timeout causes fast failover (smart failover would have 
 * the same effect, since if the timeout is reached there is no unapplied WAL). 
 */ 
</span><a name="LN82"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NoFailover</span>      <span class='Number'>0</span> 
<a name="LN83"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SmartFailover</span>   <span class='Number'>1</span> 
<a name="LN84"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FastFailover</span>    <span class='Number'>2</span> 
 
<a name="LN86"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>Failover</span> <span class='Operator'>= </span><a href="pg_standby.c.html#LN82"><span class='Ref_to_Const'>NoFailover</span></a><span class='Delimiter'>; 
</span> 
<a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RESTORE_COMMAND_COPY</span> <span class='Number'>0</span> 
<a name="LN89"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RESTORE_COMMAND_LINK</span> <span class='Number'>1</span> 
<a name="LN90"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>restoreCommandType</span><span class='Delimiter'>; 
</span> 
<a name="LN92"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>XLOG_DATA</span>            <span class='Number'>0</span> 
<a name="LN93"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>XLOG_HISTORY</span>         <span class='Number'>1</span> 
<a name="LN94"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>XLOG_BACKUP_LABEL</span>    <span class='Number'>2</span> 
<a name="LN95"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>nextWALFileType</span><span class='Delimiter'>; 
</span> 
<a name="LN97"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SET_RESTORE_COMMAND</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>cmd</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>arg1</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>arg2</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN60"><span class='Ref_to_Global_Var'>restoreCommand</span></a><span class='Delimiter'>, </span><a href="../../src/include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN97"><span class='Ref_to_Parameter'>cmd</span></a> <span class='String'>" \"%s\" \"%s\""</span><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN97"><span class='Ref_to_Parameter'>arg1</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN97"><span class='Ref_to_Parameter'>arg2</span></a><span class='Parentheses'>) 
</span> 
<a name="LN100"></a><span class='Control'>struct</span> <a href="../../src/include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Var'>stat_buf</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ===================================================================== 
 * 
 *        Customizable section 
 * 
 * ===================================================================== 
 * 
 *  Currently, this section assumes that the Archive is a locally 
 *  accessible directory. If you want to make other assumptions, 
 *  such as using a vendor-specific archive and access API, these 
 *  routines are the ones you'll need to change. You're 
 *  encouraged to submit any changes to pgsql-hackers@postgresql.org 
 *  or personally to the current maintainer. Those changes may be 
 *  folded in to later versions of this program. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Initialize allows customized commands into the warm standby program. 
 * 
 *  As an example, and probably the common case, we use either 
 *  cp/ln commands on *nix, or copy/move command on Windows. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN124"></a><span class='Declare_Function'>CustomizableInitialize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="../../src/include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s\\%s"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN90"><span class='Ref_to_Global_Var'>restoreCommandType</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="pg_standby.c.html#LN89"><span class='Ref_to_Const'>RESTORE_COMMAND_LINK</span></a><span class='Operator'>: 
</span>            <a href="pg_standby.c.html#LN97"><span class='Ref_to_Macro'>SET_RESTORE_COMMAND</span></a><span class='Parentheses'>(</span><span class='String'>"mklink"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN55"><span class='Ref_to_Global_Var'>xlogFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="pg_standby.c.html#LN88"><span class='Ref_to_Const'>RESTORE_COMMAND_COPY</span></a><span class='Operator'>: 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pg_standby.c.html#LN97"><span class='Ref_to_Macro'>SET_RESTORE_COMMAND</span></a><span class='Parentheses'>(</span><span class='String'>"copy"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN55"><span class='Ref_to_Global_Var'>xlogFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="../../src/include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN90"><span class='Ref_to_Global_Var'>restoreCommandType</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="pg_standby.c.html#LN89"><span class='Ref_to_Const'>RESTORE_COMMAND_LINK</span></a><span class='Operator'>: 
</span><span class='Directive'>#if</span> <a href="../../src/include/pg_config_manual.h.html#LN126"><span class='Ref_to_Const'>HAVE_WORKING_LINK</span></a> 
            <a href="pg_standby.c.html#LN97"><span class='Ref_to_Macro'>SET_RESTORE_COMMAND</span></a><span class='Parentheses'>(</span><span class='String'>"ln -s -f"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN55"><span class='Ref_to_Global_Var'>xlogFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>case</span> <a href="pg_standby.c.html#LN88"><span class='Ref_to_Const'>RESTORE_COMMAND_COPY</span></a><span class='Operator'>: 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pg_standby.c.html#LN97"><span class='Ref_to_Macro'>SET_RESTORE_COMMAND</span></a><span class='Parentheses'>(</span><span class='String'>"cp"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN55"><span class='Ref_to_Global_Var'>xlogFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * This code assumes that archiveLocation is a directory You may wish to 
     * add code to check for tape libraries, etc.. So, since it is a 
     * directory, we use stat to test if it's accessible 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_standby.c.html#LN100"><span class='Ref_to_Global_Var'>stat_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: archive location \"%s\" does not exist\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end CustomizableInitialize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CustomizableNextWALFileReady() 
 * 
 *    Is the requested file ready yet? 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN173"></a><span class='Declare_Function'>CustomizableNextWALFileReady</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_standby.c.html#LN100"><span class='Ref_to_Global_Var'>stat_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If it's a backup file, return immediately. If it's a regular file 
         * return only if it's the right size already. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/access/xlog_internal.h.html#LN196"><span class='Ref_to_Macro'>IsBackupHistoryFileName</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_standby.c.html#LN95"><span class='Ref_to_Global_Var'>nextWALFileType</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN94"><span class='Ref_to_Const'>XLOG_BACKUP_LABEL</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN100"><span class='Ref_to_Global_Var'>stat_buf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>== </span>XLOG_SEG_SIZE<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
            <span class='Comment_Multi_Line'>/* 
             * Windows 'cp' sets the final file size before the copy is 
             * complete, and not yet ready to be opened by pg_standby. So we 
             * wait for sleeptime secs before attempting to restore. If that 
             * is not enough, we will rely on the retry/holdoff mechanism. 
             * GNUWin32's cp does not have this problem. 
             */ 
</span>            <a href="../../src/port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>* </span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <a href="pg_standby.c.html#LN95"><span class='Ref_to_Global_Var'>nextWALFileType</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN92"><span class='Ref_to_Const'>XLOG_DATA</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If still too small, wait until it is the correct size 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN100"><span class='Ref_to_Global_Var'>stat_buf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>&GT; </span>XLOG_SEG_SIZE<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"file size greater than expected\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stat(WALFilePath,&sta... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CustomizableNextWALFileReady &raquo; </span> 
 
<a name="LN220"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MaxSegmentsPerLogFile</span> <span class='Parentheses'>( </span><span class='Number'>0xFFFFFFFF</span> <span class='Operator'>/ </span>XLOG_SEG_SIZE <span class='Parentheses'>) 
</span> 
<span class='Keyword'>static void 
</span><a name="LN223"></a><span class='Declare_Function'>CustomizableCleanupPriorWALFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Work out name of prior file from current filename 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN95"><span class='Ref_to_Global_Var'>nextWALFileType</span></a> <span class='Operator'>== </span><a href="pg_standby.c.html#LN92"><span class='Ref_to_Const'>XLOG_DATA</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN230"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN231"></a>        <a href="../../src/port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>xldir</span><span class='Delimiter'>; 
</span><a name="LN232"></a>        <span class='Control'>struct</span> <a href="../../src/include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlde</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Assume it's OK to keep failing. The failure situation may change 
         * over time, so we'd rather keep going on the main processing than 
         * fail because we couldn't clean up yet. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_standby.c.html#LN231"><span class='Ref_To_Local'>xldir</span></a> <span class='Operator'>= </span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN18"><span class='Ref_to_Proto'>opendir</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span>errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN232"><span class='Ref_To_Local'>xlde</span></a> <span class='Operator'>= </span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN19"><span class='Ref_to_Proto'>readdir</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN231"><span class='Ref_To_Local'>xldir</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * We ignore the timeline part of the XLOG segment identifiers 
                 * in deciding whether a segment is still needed.  This 
                 * ensures that we won't prematurely remove a segment from a 
                 * parent timeline. We could probably be a little more 
                 * proactive about removing segments of non-parent timelines, 
                 * but that would be a whole lot more complicated. 
                 * 
                 * We use the alphanumeric sorting property of the filenames 
                 * to decide which ones are earlier than the 
                 * exclusiveCleanupFileName file. Note that this means files 
                 * are not removed in the order they were originally written, 
                 * in case this worries you. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/access/xlog_internal.h.html#LN150"><span class='Ref_to_Macro'>IsXLogFileName</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN232"><span class='Ref_To_Local'>xlde</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                  strcmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN232"><span class='Ref_To_Local'>xlde</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN35"><span class='Ref_to_Global_Var'>exclusiveCleanupFileName</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
                    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s\\%s"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN232"><span class='Ref_To_Local'>xlde</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN232"><span class='Ref_To_Local'>xlde</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>                        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"\nremoving file \"%s\""</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="pg_standby.c.html#LN230"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../src/timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN230"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"\n%s: ERROR: could not remove file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                                <a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsXLogFileName(xlde-&GT;... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while errno=0,(xlde=readdir... &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno<span class='Parentheses'>) 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: could not read archive location \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                        <a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (xldir=opendir(archiv... &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: could not open archive location \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/port/win32_msvc/dirent.h.html#LN20"><span class='Ref_to_Proto'>closedir</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN231"><span class='Ref_To_Local'>xldir</span></a><span class='Parentheses'>))</span> 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: could not close archive location \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nextWALFileType==XLOG... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CustomizableCleanupPriorWALFiles &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ===================================================================== 
 *        End of Customizable section 
 * ===================================================================== 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SetWALFileNameForCleanup() 
 * 
 *    Set the earliest WAL filename that we want to keep on the archive 
 *    and decide whether we need_cleanup 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN309"></a><span class='Declare_Function'>SetWALFileNameForCleanup</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN311"></a>    <a href="../../src/include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>tli</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>, 
</span><a name="LN312"></a>                <span class='Declare_Local'>log</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN313"></a>                <span class='Declare_Local'>seg</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN314"></a>    <a href="../../src/include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>log_diff</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN315"></a>                <span class='Declare_Local'>seg_diff</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN316"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>cleanup</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN33"><span class='Ref_to_Global_Var'>restartWALFileName</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Don't do cleanup if the restartWALFileName provided is later than 
         * the xlog file requested. This is an error and we must not remove 
         * these files from archive. This shouldn't happen, but better safe 
         * than sorry. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN33"><span class='Ref_to_Global_Var'>restartWALFileName</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN35"><span class='Ref_to_Global_Var'>exclusiveCleanupFileName</span></a><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN33"><span class='Ref_to_Global_Var'>restartWALFileName</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN35"><span class='Ref_to_Global_Var'>exclusiveCleanupFileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN43"><span class='Ref_to_Global_Var'>keepfiles</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        sscanf<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Delimiter'>, </span><span class='String'>"%08X%08X%08X"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_standby.c.html#LN311"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_standby.c.html#LN312"><span class='Ref_To_Local'>log</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN311"><span class='Ref_To_Local'>tli</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_standby.c.html#LN314"><span class='Ref_To_Local'>log_diff</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN43"><span class='Ref_to_Global_Var'>keepfiles</span></a> <span class='Operator'>/ </span><a href="pg_standby.c.html#LN220"><span class='Ref_to_Const'>MaxSegmentsPerLogFile</span></a><span class='Delimiter'>; 
</span>            <a href="pg_standby.c.html#LN315"><span class='Ref_To_Local'>seg_diff</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN43"><span class='Ref_to_Global_Var'>keepfiles</span></a> <span class='Operator'>% </span><a href="pg_standby.c.html#LN220"><span class='Ref_to_Const'>MaxSegmentsPerLogFile</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN315"><span class='Ref_To_Local'>seg_diff</span></a> <span class='Operator'>&GT; </span><a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_standby.c.html#LN314"><span class='Ref_To_Local'>log_diff</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN220"><span class='Ref_to_Const'>MaxSegmentsPerLogFile</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN315"><span class='Ref_To_Local'>seg_diff</span></a> <span class='Operator'>- </span><a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>-= </span><a href="pg_standby.c.html#LN315"><span class='Ref_To_Local'>seg_diff</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN312"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>&GT;= </span><a href="pg_standby.c.html#LN314"><span class='Ref_To_Local'>log_diff</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_standby.c.html#LN312"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>-= </span><a href="pg_standby.c.html#LN314"><span class='Ref_To_Local'>log_diff</span></a><span class='Delimiter'>; 
</span>                <a href="pg_standby.c.html#LN316"><span class='Ref_To_Local'>cleanup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="pg_standby.c.html#LN312"><span class='Ref_To_Local'>log</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tli&GT;0&&seg&GT;0 &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if keepfiles&GT;0 &raquo; </span> 
 
    <a href="../../src/include/access/xlog_internal.h.html#LN147"><span class='Ref_to_Macro'>XLogFileNameById</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN35"><span class='Ref_to_Global_Var'>exclusiveCleanupFileName</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN311"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN312"><span class='Ref_To_Local'>log</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN313"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_standby.c.html#LN316"><span class='Ref_To_Local'>cleanup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetWALFileNameForCleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CheckForExternalTrigger() 
 * 
 *    Is there a trigger file? Sets global 'Failover' variable to indicate 
 *    what kind of a trigger file it was. A "fast" trigger file is turned 
 *    into a "smart" file as a side-effect. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN374"></a><span class='Declare_Function'>CheckForExternalTrigger</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN376"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN377"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN378"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look for a trigger file, if that option has been selected 
     * 
     * We use stat() here because triggerPath is always a file rather than 
     * potentially being in an archive 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a> <span class='Operator'>|| </span><a href="../../src/include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_standby.c.html#LN100"><span class='Ref_to_Global_Var'>stat_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * An empty trigger file performs smart failover. There's a little race 
     * condition here: if the writer of the trigger file has just created the 
     * file, but not yet written anything to it, we'll treat that as smart 
     * shutdown even if the other process was just about to write "fast" to 
     * it. But that's fine: we'll restore one more WAL file, and when we're 
     * invoked next time, we'll see the word "fast" and fail over immediately. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN100"><span class='Ref_to_Global_Var'>stat_buf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN83"><span class='Ref_to_Const'>SmartFailover</span></a><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"trigger file found: smart failover\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../src/include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Delimiter'>, </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"WARNING: could not open \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                <a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_standby.c.html#LN378"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../src/interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN376"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN376"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"WARNING: could not read \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                <a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_standby.c.html#LN376"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><a href="pg_standby.c.html#LN378"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN376"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"smart"</span><span class='Delimiter'>, </span><span class='Number'>5</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN83"><span class='Ref_to_Const'>SmartFailover</span></a><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"trigger file found: smart failover\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN376"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"fast"</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN84"><span class='Ref_to_Const'>FastFailover</span></a><span class='Delimiter'>; 
</span> 
        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"trigger file found: fast failover\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Turn it into a "smart" trigger by truncating the file. Otherwise if 
         * the server asks us again to restore a segment that was restored 
         * already, we would return "not found" and upset the server. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/port/win32.h.html#LN58"><span class='Ref_to_Macro'>ftruncate</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"WARNING: could not read \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                    <a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Delimiter'>, </span><a href="../../src/port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../src/interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strncmp(buf,"fast",4)... &raquo; </span> 
    <a href="../../src/interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN377"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"WARNING: invalid content in \"%s\"\n"</span><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckForExternalTrigger &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RestoreWALFileForRecovery() 
 * 
 *    Perform the action required to restore the file from archive 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN467"></a><span class='Declare_Function'>RestoreWALFileForRecovery</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN469"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN470"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numretries</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"running restore:      "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN470"><span class='Ref_To_Local'>numretries</span></a> <span class='Operator'>&LT;= </span><a href="pg_standby.c.html#LN44"><span class='Ref_to_Global_Var'>maxretries</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN469"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../src/include/port.h.html#LN312"><span class='Ref_to_Macro'>system</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN60"><span class='Ref_to_Global_Var'>restoreCommand</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN469"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"OK\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../src/port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN470"><span class='Ref_To_Local'>numretries</span></a><span class='Operator'>++ * </span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>* </span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow caller to add additional info 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"not restored\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RestoreWALFileForRecovery &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN502"></a><span class='Declare_Function'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"%s allows PostgreSQL warm standby servers to be configured.\n\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Usage:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  %s [OPTION]... ARCHIVELOCATION NEXTWALFILE XLOGFILEPATH [RESTARTWALFILE]\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\nOptions:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -c                 copy file from archive (default)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -d                 generate lots of debugging output (testing only)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -k NUMFILESTOKEEP  if RESTARTWALFILE is not used, remove files prior to limit\n"</span> 
           <span class='String'>"                     (0 keeps all)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -l                 does nothing; use of link is now deprecated\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -r MAXRETRIES      max number of times to retry, with progressive wait\n"</span> 
           <span class='String'>"                     (default=3)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -s SLEEPTIME       seconds to wait between file checks (min=1, max=60,\n"</span> 
           <span class='String'>"                     default=5)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -t TRIGGERFILE     trigger file to initiate failover (no default)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -V, --version      output version information, then exit\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -w MAXWAITTIME     max seconds to wait for a file (0=no limit) (default=0)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"  -?, --help         show this help, then exit\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\n"</span> 
           <span class='String'>"Main intended use as restore_command in recovery.conf:\n"</span> 
           <span class='String'>"  restore_command = 'pg_standby [OPTION]... ARCHIVELOCATION %%f %%p %%r'\n"</span> 
           <span class='String'>"e.g.\n"</span> 
    <span class='String'>"  restore_command = 'pg_standby /mnt/server/archiverdir %%f %%p %%r'\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\nReport bugs to &LT;pgsql-bugs@postgresql.org&GT;.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end usage &raquo; </span> 
 
<span class='Directive'>#ifndef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static void 
</span><a name="LN531"></a><span class='Declare_Function'>sighandler</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sig</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_standby.c.html#LN50"><span class='Ref_to_Global_Var'>signaled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* We don't want SIGQUIT to core dump */ 
</span><span class='Keyword'>static void 
</span><a name="LN538"></a><span class='Declare_Function'>sigquit_handler</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>sig</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../src/port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="../../src/include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>, </span>SIGINT<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/*------------ MAIN ----------------------------------------*/ 
</span><span class='Keyword'>int 
</span><a name="LN547"></a><span class='Declare_Function'>main</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN549"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a> <span class='Operator'>= </span><a href="../../src/include/port.h.html#LN49"><span class='Ref_to_Proto'>get_progname</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--help"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-?"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../src/bin/psql/help.h.html#LN10"><span class='Ref_to_Proto'>usage</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--version"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-V"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            puts<span class='Parentheses'>(</span><span class='String'>"pg_standby (PostgreSQL) "</span> PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * You can send SIGUSR1 to trigger failover. 
     * 
     * Postmaster uses SIGQUIT to request immediate shutdown. The default 
     * action is to core dump, but we don't want that, so trap it and commit 
     * suicide without core dump. 
     * 
     * We used to use SIGINT and SIGQUIT to trigger failover, but that turned 
     * out to be a bad idea because postmaster uses SIGQUIT to request 
     * immediate shutdown. We still trap SIGINT, but that may change in a 
     * future release. 
     * 
     * There's no way to trigger failover via signal on Windows. 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../src/port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN530"><span class='Ref_to_Func'>sighandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../src/port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="pg_standby.c.html#LN530"><span class='Ref_to_Func'>sighandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* deprecated, use SIGUSR1 */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../src/port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN537"><span class='Ref_to_Func'>sigquit_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_standby.c.html#LN549"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="../../src/include/pg_getopt.h.html#LN42"><span class='Ref_to_Proto'>getopt</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"cdk:lr:s:t:w:"</span><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN549"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'c'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Use copy */ 
</span>                <a href="pg_standby.c.html#LN90"><span class='Ref_to_Global_Var'>restoreCommandType</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN88"><span class='Ref_to_Const'>RESTORE_COMMAND_COPY</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'d'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Debug mode */ 
</span>                <a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'k'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* keepfiles */ 
</span>                <a href="pg_standby.c.html#LN43"><span class='Ref_to_Global_Var'>keepfiles</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN43"><span class='Ref_to_Global_Var'>keepfiles</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: -k keepfiles must be &GT;= 0\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'l'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Use link */ 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Link feature disabled, possibly permanently. Linking causes 
                 * a problem after recovery ends that is not currently 
                 * resolved by PostgreSQL. 25 Jun 2009 
                 */ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
                <a href="pg_standby.c.html#LN90"><span class='Ref_to_Global_Var'>restoreCommandType</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN89"><span class='Ref_to_Const'>RESTORE_COMMAND_LINK</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'r'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Retries */ 
</span>                <a href="pg_standby.c.html#LN44"><span class='Ref_to_Global_Var'>maxretries</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN44"><span class='Ref_to_Global_Var'>maxretries</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: -r maxretries must be &GT;= 0\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'s'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Sleep time */ 
</span>                <a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>&GT; </span><span class='Number'>60</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: -s sleeptime incorrectly set\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'t'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Trigger file */ 
</span>                <a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'w'</span><span class='Operator'>:</span>           <span class='Comment_Single_Line'>/* Max wait time */ 
</span>                <a href="pg_standby.c.html#LN42"><span class='Ref_to_Global_Var'>maxwaittime</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN42"><span class='Ref_to_Global_Var'>maxwaittime</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: -w maxwaittime incorrectly set\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch c &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (c=getopt(argc,argv,"... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Parameter checking - after checking to see if trigger file present 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: not enough command-line arguments\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We will go to the archiveLocation to get nextWALFileName. 
     * nextWALFileName may not exist yet, which would not be an error, so we 
     * separate the archiveLocation and nextWALFileName so we can check 
     * separately whether archiveLocation exists, if not that is an error 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN32"><span class='Ref_to_Global_Var'>archiveLocation</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]; 
</span>        <a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: must specify archive location\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]; 
</span>        <a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: must specify WAL file name as second non-option argument (use \"%%f\")\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN55"><span class='Ref_to_Global_Var'>xlogFilePath</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]; 
</span>        <a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: must specify xlog destination as third non-option argument (use \"%%p\")\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN33"><span class='Ref_to_Global_Var'>restartWALFileName</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN547"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]; 
</span>        <a href="../../src/port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_standby.c.html#LN123"><span class='Ref_to_Func'>CustomizableInitialize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_standby.c.html#LN46"><span class='Ref_to_Global_Var'>need_cleanup</span></a> <span class='Operator'>= </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN185"><span class='Ref_to_Func'>SetWALFileNameForCleanup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Trigger file:         %s\n"</span><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a> <span class='Operator'>? </span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a> <span class='Operator'>: </span><span class='String'>"&LT;not set&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Waiting for WAL file: %s\n"</span><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"WAL file path:        %s\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN34"><span class='Ref_to_Global_Var'>WALFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Restoring to:         %s\n"</span><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN55"><span class='Ref_to_Global_Var'>xlogFilePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Sleep interval:       %d second%s\n"</span><span class='Delimiter'>, 
</span>                <a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>? </span><span class='String'>"s"</span> <span class='Operator'>: </span><span class='String'>" "</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Max wait interval:    %d %s\n"</span><span class='Delimiter'>, 
</span>                <a href="pg_standby.c.html#LN42"><span class='Ref_to_Global_Var'>maxwaittime</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN42"><span class='Ref_to_Global_Var'>maxwaittime</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? </span><span class='String'>"seconds"</span> <span class='Operator'>: </span><span class='String'>"forever"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Command for restore:  %s\n"</span><span class='Delimiter'>, </span><a href="pg_standby.c.html#LN60"><span class='Ref_to_Global_Var'>restoreCommand</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Keep archive history: "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN46"><span class='Ref_to_Global_Var'>need_cleanup</span></a><span class='Parentheses'>) 
</span>            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s and later\n"</span><span class='Delimiter'>, </span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN35"><span class='Ref_to_Global_Var'>exclusiveCleanupFileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"no cleanup required\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for initial history file: always the first file to be requested 
     * It's OK if the file isn't there - all other files need to wait 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/access/xlog_internal.h.html#LN180"><span class='Ref_to_Macro'>IsTLHistoryFileName</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN56"><span class='Ref_to_Global_Var'>nextWALFileName</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_standby.c.html#LN95"><span class='Ref_to_Global_Var'>nextWALFileType</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN93"><span class='Ref_to_Const'>XLOG_HISTORY</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN466"><span class='Ref_to_Func'>RestoreWALFileForRecovery</span></a><span class='Parentheses'>())</span> 
            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"history file not found\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Main wait loop 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Check for trigger file or signal first */ 
</span>        <a href="pg_standby.c.html#LN373"><span class='Ref_to_Func'>CheckForExternalTrigger</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> <a href="../../src/include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN50"><span class='Ref_to_Global_Var'>signaled</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN84"><span class='Ref_to_Const'>FastFailover</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"signaled to exit: fast failover\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Check for fast failover immediately, before checking if the 
         * requested WAL file is available 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>== </span><a href="pg_standby.c.html#LN84"><span class='Ref_to_Const'>FastFailover</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN172"><span class='Ref_to_Func'>CustomizableNextWALFileReady</span></a><span class='Parentheses'>())</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Once we have restored this file successfully we can remove some 
             * prior WAL files. If this restore fails we mustn't remove any 
             * file because some of them will be requested again immediately 
             * after the failed restore, or when we restart recovery. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN466"><span class='Ref_to_Func'>RestoreWALFileForRecovery</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN46"><span class='Ref_to_Global_Var'>need_cleanup</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_standby.c.html#LN222"><span class='Ref_to_Func'>CustomizableCleanupPriorWALFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Something went wrong in copying the file */ 
</span>                <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if CustomizableNextWALFi... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Check for smart failover if the next WAL file was not available */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>== </span><a href="pg_standby.c.html#LN83"><span class='Ref_to_Const'>SmartFailover</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>&LT;= </span><span class='Number'>60</span><span class='Parentheses'>) 
</span>            <a href="../../src/port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a> <span class='Operator'>* </span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_standby.c.html#LN40"><span class='Ref_to_Global_Var'>waittime</span></a> <span class='Operator'>+= </span><a href="pg_standby.c.html#LN39"><span class='Ref_to_Global_Var'>sleeptime</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN40"><span class='Ref_to_Global_Var'>waittime</span></a> <span class='Operator'>&GT;= </span><a href="pg_standby.c.html#LN42"><span class='Ref_to_Global_Var'>maxwaittime</span></a> <span class='Operator'>&& </span><a href="pg_standby.c.html#LN42"><span class='Ref_to_Global_Var'>maxwaittime</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_standby.c.html#LN86"><span class='Ref_to_Global_Var'>Failover</span></a> <span class='Operator'>= </span><a href="pg_standby.c.html#LN84"><span class='Ref_to_Const'>FastFailover</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"Timed out after %d seconds: fast failover\n"</span><span class='Delimiter'>, 
</span>                        <a href="pg_standby.c.html#LN40"><span class='Ref_to_Global_Var'>waittime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/bin/pg_archivecleanup/pg_archivecleanup.c.html#LN28"><span class='Ref_to_Global_Var'>debug</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"WAL file not present yet."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_standby.c.html#LN54"><span class='Ref_to_Global_Var'>triggerPath</span></a><span class='Parentheses'>) 
</span>                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>" Checking for trigger file..."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end main &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>