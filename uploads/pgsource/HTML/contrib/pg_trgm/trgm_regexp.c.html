<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\pg_trgm\trgm_regexp.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\pg_trgm\trgm_regexp.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:26 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * trgm_regexp.c 
 *    Regular expression matching using trigrams. 
 * 
 * The general idea of trigram index support for a regular expression (regex) 
 * search is to transform the regex into a logical expression on trigrams. 
 * For example: 
 * 
 *   (ab|cd)efg  =&GT;  ((abe & bef) | (cde & def)) & efg 
 * 
 * If a string matches the regex, then it must match the logical expression on 
 * trigrams.  The opposite is not necessarily true, however: a string that 
 * matches the logical expression might not match the original regex.  Such 
 * false positives are removed via recheck, by running the regular regex match 
 * operator on the retrieved heap tuple. 
 * 
 * Since the trigram expression involves both AND and OR operators, we can't 
 * expect the core index machinery to evaluate it completely.  Instead, the 
 * result of regex analysis is a list of trigrams to be sought in the index, 
 * plus a simplified graph that is used by trigramsMatchGraph() to determine 
 * whether a particular indexed value matches the expression. 
 * 
 * Converting a regex to a trigram expression is based on analysis of an 
 * automaton corresponding to the regex.  The algorithm consists of four 
 * stages: 
 * 
 * 1) Compile the regexp to NFA form.  This is handled by the PostgreSQL 
 *    regexp library, which provides accessors for its opaque regex_t struct 
 *    to expose the NFA state graph and the "colors" (sets of equivalent 
 *    characters) used as state transition labels. 
 * 
 * 2) Transform the original NFA into an expanded graph, where arcs 
 *    are labeled with trigrams that must be present in order to move from 
 *    one state to another via the arcs.  The trigrams used in this stage 
 *    consist of colors, not characters, as in the original NFA. 
 * 
 * 3) Expand the color trigrams into regular trigrams consisting of 
 *    characters.  If too many distinct trigrams are produced, trigrams are 
 *    eliminated and the graph is simplified until it's simple enough. 
 * 
 * 4) Finally, the resulting graph is packed into a TrgmPackedGraph struct, 
 *    and returned to the caller. 
 * 
 * 1) Compile the regexp to NFA form 
 * --------------------------------- 
 * The automaton returned by the regexp compiler is a graph where vertices 
 * are "states" and arcs are labeled with colors.  Each color represents 
 * a set of characters, so that all characters assigned to the same color 
 * are interchangeable, so far as matching the regexp is concerned.  There 
 * are two special states: "initial" and "final".  A state can have multiple 
 * outgoing arcs labeled with the same color, which makes the automaton 
 * non-deterministic, because it can be in many states simultaneously. 
 * 
 * Note that this NFA is already lossy compared to the original regexp, 
 * since it ignores some regex features such as lookahead constraints and 
 * backref matching.  This is OK for our purposes since it's still the case 
 * that only strings matching the NFA can possibly satisfy the regexp. 
 * 
 * 2) Transform the original NFA into an expanded graph 
 * ---------------------------------------------------- 
 * In the 2nd stage, the automaton is transformed into a graph based on the 
 * original NFA.  Each state in the expanded graph represents a state from 
 * the original NFA, plus a prefix identifying the last two characters 
 * (colors, to be precise) seen before entering the state.  There can be 
 * multiple states in the expanded graph for each state in the original NFA, 
 * depending on what characters can precede it.  A prefix position can be 
 * "unknown" if it's uncertain what the preceding character was, or "blank" 
 * if the character was a non-word character (we don't need to distinguish 
 * which non-word character it was, so just think of all of them as blanks). 
 * 
 * For convenience in description, call an expanded-state identifier 
 * (two prefix colors plus a state number from the original NFA) an 
 * "enter key". 
 * 
 * Each arc of the expanded graph is labelled with a trigram that must be 
 * present in the string to match.  We can construct this from an out-arc of 
 * the underlying NFA state by combining the expanded state's prefix with the 
 * color label of the underlying out-arc, if neither prefix position is 
 * "unknown".  But note that some of the colors in the trigram might be 
 * "blank".  This is OK since we want to generate word-boundary trigrams as 
 * the regular trigram machinery would, if we know that some word characters 
 * must be adjacent to a word boundary in all strings matching the NFA. 
 * 
 * The expanded graph can also have fewer states than the original NFA, 
 * because we don't bother to make a separate state entry unless the state 
 * is reachable by a valid arc.  When an enter key is reachable from a state 
 * of the expanded graph, but we do not know a complete trigram associated 
 * with that transition, we cannot make a valid arc; instead we insert the 
 * enter key into the enterKeys list of the source state.  This effectively 
 * means that the two expanded states are not reliably distinguishable based 
 * on examining trigrams. 
 * 
 * So the expanded graph resembles the original NFA, but the arcs are 
 * labeled with trigrams instead of individual characters, and there may be 
 * more or fewer states.  It is a lossy representation of the original NFA: 
 * any string that matches the original regexp must match the expanded graph, 
 * but the reverse is not true. 
 * 
 * We build the expanded graph through a breadth-first traversal of states 
 * reachable from the initial state.  At each reachable state, we identify the 
 * states reachable from it without traversing a predictable trigram, and add 
 * those states' enter keys to the current state.  Then we generate all 
 * out-arcs leading out of this collection of states that have predictable 
 * trigrams, adding their target states to the queue of states to examine. 
 * 
 * When building the graph, if the number of states or arcs exceed pre-defined 
 * limits, we give up and simply mark any states not yet processed as final 
 * states.  Roughly speaking, that means that we make use of some portion from 
 * the beginning of the regexp.  Also, any colors that have too many member 
 * characters are treated as "unknown", so that we can't derive trigrams 
 * from them. 
 * 
 * 3) Expand the color trigrams into regular trigrams 
 * -------------------------------------------------- 
 * The trigrams in the expanded graph are "color trigrams", consisting 
 * of three consecutive colors that must be present in the string. But for 
 * search, we need regular trigrams consisting of characters. In the 3rd 
 * stage, the color trigrams are expanded into regular trigrams. Since each 
 * color can represent many characters, the total number of regular trigrams 
 * after expansion could be very large. Because searching the index for 
 * thousands of trigrams would be slow, and would likely produce so many 
 * false positives that we would have to traverse a large fraction of the 
 * index, the graph is simplified further in a lossy fashion by removing 
 * color trigrams. When a color trigram is removed, the states connected by 
 * any arcs labelled with that trigram are merged. 
 * 
 * Trigrams do not all have equivalent value for searching: some of them are 
 * more frequent and some of them are less frequent. Ideally, we would like 
 * to know the distribution of trigrams, but we don't. But because of padding 
 * we know for sure that the empty character is more frequent than others, 
 * so we can penalize trigrams according to presence of whitespace. The 
 * penalty assigned to each color trigram is the number of simple trigrams 
 * it would produce, times the penalties[] multiplier associated with its 
 * whitespace content. (The penalties[] constants were calculated by analysis 
 * of some real-life text.) We eliminate color trigrams starting with the 
 * highest-penalty one, until we get to a total penalty of no more than 
 * WISH_TRGM_PENALTY. However, we cannot remove a color trigram if that would 
 * lead to merging the initial and final states, so we may not be able to 
 * reach WISH_TRGM_PENALTY. It's still okay so long as we have no more than 
 * MAX_TRGM_COUNT simple trigrams in total, otherwise we fail. 
 * 
 * 4) Pack the graph into a compact representation 
 * ----------------------------------------------- 
 * The 2nd and 3rd stages might have eliminated or merged many of the states 
 * and trigrams created earlier, so in this final stage, the graph is 
 * compacted and packed into a simpler struct that contains only the 
 * information needed to evaluate it. 
 * 
 * ALGORITHM EXAMPLE: 
 * 
 * Consider the example regex "ab[cd]".  This regex is transformed into the 
 * following NFA (for simplicity we show colors as their single members): 
 * 
 *                    4# 
 *                  c/ 
 *       a     b    / 
 *   1* --- 2 ---- 3 
 *                  \ 
 *                  d\ 
 *                    5# 
 * 
 * We use * to mark initial state and # to mark final state. It's not depicted, 
 * but states 1, 4, 5 have self-referencing arcs for all possible characters, 
 * because this pattern can match to any part of a string. 
 * 
 * As the result of stage 2 we will have the following graph: 
 * 
 *        abc    abd 
 *   2# &LT;---- 1* ----&GT; 3# 
 * 
 * The process for generating this graph is: 
 * 1) Create state 1 with enter key (UNKNOWN, UNKNOWN, 1). 
 * 2) Add key (UNKNOWN, "a", 2) to state 1. 
 * 3) Add key ("a", "b", 3) to state 1. 
 * 4) Create new state 2 with enter key ("b", "c", 4).  Add an arc 
 *    from state 1 to state 2 with label trigram "abc". 
 * 5) Mark state 2 final because state 4 of source NFA is marked as final. 
 * 6) Create new state 3 with enter key ("b", "d", 5).  Add an arc 
 *    from state 1 to state 3 with label trigram "abd". 
 * 7) Mark state 3 final because state 5 of source NFA is marked as final. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    contrib/pg_trgm/trgm_regexp.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"trgm.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"regex/regexport.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tsearch/ts_locale.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Uncomment (or use -DTRGM_REGEXP_DEBUG) to print debug info, 
 * for exploring and debugging the algorithm implementation. 
 * This produces three graph files in /tmp, in Graphviz .dot format. 
 * Some progress information is also printed to postmaster stderr. 
 */ 
/* #define TRGM_REGEXP_DEBUG */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * These parameters are used to limit the amount of work done. 
 * Otherwise regex processing could be too slow and memory-consuming. 
 * 
 *  MAX_EXPANDED_STATES - How many states we allow in expanded graph 
 *  MAX_EXPANDED_ARCS - How many arcs we allow in expanded graph 
 *  MAX_TRGM_COUNT - How many simple trigrams we allow to be extracted 
 *  WISH_TRGM_PENALTY - Maximum desired sum of color trigram penalties 
 *  COLOR_COUNT_LIMIT - Maximum number of characters per color 
 */ 
</span><a name="LN219"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_EXPANDED_STATES</span> <span class='Number'>128</span> 
<a name="LN220"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_EXPANDED_ARCS</span>   <span class='Number'>1024</span> 
<a name="LN221"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_TRGM_COUNT</span>      <span class='Number'>256</span> 
<a name="LN222"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WISH_TRGM_PENALTY</span>   <span class='Number'>16</span> 
<a name="LN223"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>COLOR_COUNT_LIMIT</span>   <span class='Number'>256</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Penalty multipliers for trigram counts depending on whitespace contents. 
 * Numbers based on analysis of real-life texts. 
 */ 
</span><a name="LN229"></a><span class='Keyword'>static const </span><a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Declare_Var'>penalties</span><span class='Delimiter'>[</span><span class='Number'>8</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* "aaa" */ 
</span>    <span class='Number'>3</span><span class='Operator'>.</span><span class='Number'>5f</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* "aa " */ 
</span>    <span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* "a a" (impossible) */ 
</span>    <span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* "a  " (impossible) */ 
</span>    <span class='Number'>4</span><span class='Operator'>.</span><span class='Number'>2f</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* " aa" */ 
</span>    <span class='Number'>2</span><span class='Operator'>.</span><span class='Number'>1f</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* " a " */ 
</span>    <span class='Number'>25</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>,</span>                      <span class='Comment_Single_Line'>/* "  a" */ 
</span>    <span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span>                        <span class='Comment_Single_Line'>/* "   " (impossible) */ 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* Struct representing a single pg_wchar, converted back to multibyte form */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN243"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>bytes</span><span class='Delimiter'>[</span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN244"></a>} <span class='Declare_Typedef'>trgm_mb_char</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Attributes of NFA colors: 
 * 
 *  expandable              - we know the character expansion of this color 
 *  containsNonWord         - color contains non-word characters 
 *                            (which will not be extracted into trigrams) 
 *  wordCharsCount          - count of word characters in color 
 *  wordChars               - array of this color's word characters 
 *                            (which can be extracted into trigrams) 
 * 
 * When expandable is false, the other attributes don't matter; we just 
 * assume this color represents unknown character(s). 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN261"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>expandable</span><span class='Delimiter'>; 
</span><a name="LN262"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>containsNonWord</span><span class='Delimiter'>; 
</span><a name="LN263"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>wordCharsCount</span><span class='Delimiter'>; 
</span><a name="LN264"></a>    <a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Operator'>*</span><span class='Declare_Member'>wordChars</span><span class='Delimiter'>; 
</span><a name="LN265"></a>} <span class='Declare_Typedef'>TrgmColorInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * A "prefix" is information about the colors of the last two characters read 
 * before reaching a specific NFA state.  These colors can have special values 
 * COLOR_UNKNOWN and COLOR_BLANK.  COLOR_UNKNOWN means that we have no 
 * information, for example because we read some character of an unexpandable 
 * color.  COLOR_BLANK means that we read a non-word character. 
 * 
 * We call a prefix ambiguous if at least one of its colors is unknown.  It's 
 * fully ambiguous if both are unknown, partially ambiguous if only the first 
 * is unknown.  (The case of first color known, second unknown is not valid.) 
 * 
 * Wholly- or partly-blank prefixes are mostly handled the same as regular 
 * color prefixes.  This allows us to generate appropriate partly-blank 
 * trigrams when the NFA requires word character(s) to appear adjacent to 
 * non-word character(s). 
 */ 
</span><a name="LN283"></a><span class='Control'>typedef</span> <span class='Keyword'>int </span><span class='Declare_Typedef'>TrgmColor</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* We assume that colors returned by the regexp engine cannot be these: */ 
</span><a name="LN286"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>COLOR_UNKNOWN</span>   <span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>) 
</span><a name="LN287"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>COLOR_BLANK</span>     <span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>2</span><span class='Parentheses'>) 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN291"></a>    <a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a>   <span class='Declare_Member'>colors</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN292"></a>} <span class='Declare_Typedef'>TrgmPrefix</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Color-trigram data type.  Note that some elements of the trigram can be 
 * COLOR_BLANK, but we don't allow COLOR_UNKNOWN. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN300"></a>    <a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a>   <span class='Declare_Member'>colors</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN301"></a>} <span class='Declare_Typedef'>ColorTrgm</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Key identifying a state of our expanded graph: color prefix, and number 
 * of the corresponding state in the underlying regex NFA.  The color prefix 
 * shows how we reached the regex state (to the extent that we know it). 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN310"></a>    <a href="trgm_regexp.c.html#LN289"><span class='Ref_to_Typedef'>TrgmPrefix</span></a>  <span class='Declare_Member'>prefix</span><span class='Delimiter'>; 
</span><a name="LN311"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nstate</span><span class='Delimiter'>; 
</span><a name="LN312"></a>} <span class='Declare_Typedef'>TrgmStateKey</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * One state of the expanded graph. 
 * 
 *  stateKey - ID of this state 
 *  arcs     - outgoing arcs of this state (List of TrgmArc) 
 *  enterKeys - enter keys reachable from this state without reading any 
 *             predictable trigram (List of TrgmStateKey) 
 *  flags    - flag bits 
 *  snumber  - number of this state (initially assigned as -1, -2, etc, 
 *             for debugging purposes only; then at the packaging stage, 
 *             surviving states are renumbered with positive numbers) 
 *  parent   - parent state, if this state has been merged into another 
 *  tentFlags - flags this state would acquire via planned merges 
 *  tentParent - planned parent state, if considering a merge 
 */ 
</span><a name="LN329"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TSTATE_INIT</span>     <span class='Number'>0x01</span>    <span class='Comment_Single_Line'>/* flag indicating this state is initial */ 
</span><a name="LN330"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TSTATE_FIN</span>      <span class='Number'>0x02</span>    <span class='Comment_Single_Line'>/* flag indicating this state is final */ 
</span> 
<a name="LN332"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TrgmState</span> 
<span class='Delimiter'>{ 
</span><a name="LN334"></a>    <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Declare_Member'>stateKey</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* hashtable key: must be first field */ 
</span><a name="LN335"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>arcs</span><span class='Delimiter'>; 
</span><a name="LN336"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>enterKeys</span><span class='Delimiter'>; 
</span><a name="LN337"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>flags</span><span class='Delimiter'>; 
</span><a name="LN338"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>snumber</span><span class='Delimiter'>; 
</span><a name="LN339"></a>    <span class='Control'>struct</span> <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>parent</span><span class='Delimiter'>; 
</span><a name="LN340"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>tentFlags</span><span class='Delimiter'>; 
</span><a name="LN341"></a>    <span class='Control'>struct</span> <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tentParent</span><span class='Delimiter'>; 
</span><a name="LN342"></a>} <span class='Declare_Typedef'>TrgmState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * One arc in the expanded graph. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN349"></a>    <a href="trgm_regexp.c.html#LN298"><span class='Ref_to_Typedef'>ColorTrgm</span></a>   <span class='Declare_Member'>ctrgm</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* trigram needed to traverse arc */ 
</span><a name="LN350"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>target</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* next state */ 
</span><a name="LN351"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TrgmArc</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Information about arc of specific color trigram (used in stage 3) 
 * 
 * Contains pointers to the source and target states. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN360"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>source</span><span class='Delimiter'>; 
</span><a name="LN361"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>target</span><span class='Delimiter'>; 
</span><a name="LN362"></a>} <span class='Declare_Typedef'>TrgmArcInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Information about color trigram (used in stage 3) 
 * 
 * ctrgm    - trigram itself 
 * cnumber  - number of this trigram (used in the packaging stage) 
 * count    - number of simple trigrams created from this color trigram 
 * expanded - indicates this color trigram is expanded into simple trigrams 
 * arcs     - list of all arcs labeled with this color trigram. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN375"></a>    <a href="trgm_regexp.c.html#LN298"><span class='Ref_to_Typedef'>ColorTrgm</span></a>   <span class='Declare_Member'>ctrgm</span><span class='Delimiter'>; 
</span><a name="LN376"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>cnumber</span><span class='Delimiter'>; 
</span><a name="LN377"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>count</span><span class='Delimiter'>; 
</span><a name="LN378"></a>    <a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Member'>penalty</span><span class='Delimiter'>; 
</span><a name="LN379"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>expanded</span><span class='Delimiter'>; 
</span><a name="LN380"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>arcs</span><span class='Delimiter'>; 
</span><a name="LN381"></a>} <span class='Declare_Typedef'>ColorTrgmInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Data structure representing all the data we need during regex processing. 
 * 
 *  regex           - compiled regex 
 *  colorInfo       - extracted information about regex's colors 
 *  ncolors         - number of colors in colorInfo[] 
 *  states          - hashtable of TrgmStates (states of expanded graph) 
 *  initState       - pointer to initial state of expanded graph 
 *  queue           - queue of to-be-processed TrgmStates 
 *  keysQueue       - queue of to-be-processed TrgmStateKeys 
 *  arcsCount       - total number of arcs of expanded graph (for resource 
 *                    limiting) 
 *  overflowed      - we have exceeded resource limit for transformation 
 *  colorTrgms      - array of all color trigrams present in graph 
 *  colorTrgmsCount - count of those color trigrams 
 *  totalTrgmCount  - total count of extracted simple trigrams 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Source regexp, and color information extracted from it (stage 1) */ 
</span><a name="LN403"></a>    <a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>regex</span><span class='Delimiter'>; 
</span><a name="LN404"></a>    <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Member'>colorInfo</span><span class='Delimiter'>; 
</span><a name="LN405"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>ncolors</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Expanded graph (stage 2) */ 
</span><a name="LN408"></a>    <a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>states</span><span class='Delimiter'>; 
</span><a name="LN409"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>initState</span><span class='Delimiter'>; 
</span><a name="LN410"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nstates</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Workspace for stage 2 */ 
</span><a name="LN413"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>queue</span><span class='Delimiter'>; 
</span><a name="LN414"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>keysQueue</span><span class='Delimiter'>; 
</span><a name="LN415"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>arcsCount</span><span class='Delimiter'>; 
</span><a name="LN416"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>overflowed</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Information about distinct color trigrams in the graph (stage 3) */ 
</span><a name="LN419"></a>    <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Member'>colorTrgms</span><span class='Delimiter'>; 
</span><a name="LN420"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>colorTrgmsCount</span><span class='Delimiter'>; 
</span><a name="LN421"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>totalTrgmCount</span><span class='Delimiter'>; 
</span><a name="LN422"></a>}<span class='Auto_Annotations'> &laquo; end {anonTrgmNFA} &raquo; </span> <span class='Declare_Typedef'>TrgmNFA</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Final, compact representation of expanded graph. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN429"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>targetState</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* index of target state (zero-based) */ 
</span><a name="LN430"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>colorTrgm</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* index of color trigram for transition */ 
</span><a name="LN431"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TrgmPackedArc</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN435"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>arcsCount</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* number of out-arcs for this state */ 
</span><a name="LN436"></a>    <a href="trgm_regexp.c.html#LN427"><span class='Ref_to_Typedef'>TrgmPackedArc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>arcs</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* array of arcsCount packed arcs */ 
</span><a name="LN437"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TrgmPackedState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* "typedef struct TrgmPackedGraph TrgmPackedGraph" appears in trgm.h */ 
</span><a name="LN440"></a><span class='Control'>struct</span> <span class='Declare_Struct'>TrgmPackedGraph</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * colorTrigramsCount and colorTrigramsGroups contain information about 
     * how trigrams are grouped into color trigrams.  "colorTrigramsCount" is 
     * the count of color trigrams and "colorTrigramGroups" contains number of 
     * simple trigrams for each color trigram.  The array of simple trigrams 
     * (stored separately from this struct) is ordered so that the simple 
     * trigrams for each color trigram are consecutive, and they're in order 
     * by color trigram number. 
     */ 
</span><a name="LN451"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>colorTrigramsCount</span><span class='Delimiter'>; 
</span><a name="LN452"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Member'>colorTrigramGroups</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* array of size colorTrigramsCount */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The states of the simplified NFA.  State number 0 is always initial 
     * state and state number 1 is always final state. 
     */ 
</span><a name="LN458"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>statesCount</span><span class='Delimiter'>; 
</span><a name="LN459"></a>    <a href="trgm_regexp.c.html#LN433"><span class='Ref_to_Typedef'>TrgmPackedState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>states</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* array of size statesCount */ 
</span> 
    <span class='Comment_Multi_Line'>/* Temporary work space for trigramsMatchGraph() */ 
</span><a name="LN462"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Member'>colorTrigramsActive</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* array of size colorTrigramsCount */ 
</span><a name="LN463"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Member'>statesActive</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* array of size statesCount */ 
</span><a name="LN464"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Member'>statesQueue</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* array of size statesCount */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end TrgmPackedGraph &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Temporary structure for representing an arc during packaging. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN472"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>sourceState</span><span class='Delimiter'>; 
</span><a name="LN473"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>targetState</span><span class='Delimiter'>; 
</span><a name="LN474"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>colorTrgm</span><span class='Delimiter'>; 
</span><a name="LN475"></a>} <span class='Declare_Typedef'>TrgmPackArcInfo</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* prototypes for private functions */ 
</span><a name="LN479"></a><span class='Keyword'>static </span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>createTrgmNFAInternal</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>graph</span><span class='Delimiter'>, 
</span><a name="LN480"></a>                      <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN481"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RE_compile</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>text_re</span><span class='Delimiter'>, 
</span><a name="LN482"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>cflags</span><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN483"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>getColorInfo</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN484"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>convertPgWchar</span><span class='Parentheses'>(</span><a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a> <span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN485"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>transformGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN486"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>processState</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN487"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>addKey</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN488"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>addKeyToQueue</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN489"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>addArcs</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN490"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>addArc</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN491"></a>       <a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a> <span class='Declare_Parameter'>co</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>destKey</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN492"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>validArcLabel</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a> <span class='Declare_Parameter'>co</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN493"></a><span class='Keyword'>static </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>getState</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN494"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>prefixContains</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN289"><span class='Ref_to_Typedef'>TrgmPrefix</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prefix1</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN289"><span class='Ref_to_Typedef'>TrgmPrefix</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prefix2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN495"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>selectColorTrigrams</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN496"></a><span class='Keyword'>static </span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>expandColorTrigrams</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN497"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>fillTrgm</span><span class='Parentheses'>(</span><a href="trgm.h.html#LN37"><span class='Ref_to_Typedef'>trgm</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ptrgm</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Declare_Parameter'>s</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN498"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>mergeStates</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state1</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN499"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>colorTrgmInfoCmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN500"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>colorTrgmInfoPenaltyCmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN501"></a><span class='Keyword'>static </span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>packGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN502"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>packArcInfoCmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
<a name="LN505"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>printSourceNFA</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colors</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ncolors</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN506"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>printTrgmNFA</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN507"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>printTrgmColor</span><span class='Parentheses'>(</span><a href="../../src/include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a> <span class='Declare_Parameter'>co</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN508"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>printTrgmPackedGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>packedGraph</span><span class='Delimiter'>, </span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigrams</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Main entry point to process a regular expression. 
 * 
 * Returns an array of trigrams required by the regular expression, or NULL if 
 * the regular expression was too complex to analyze.  In addition, a packed 
 * graph representation of the regex is returned into *graph.  The results 
 * must be allocated in rcontext (which might or might not be the current 
 * context). 
 */ 
</span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>* 
</span><a name="LN522"></a><span class='Declare_Function'>createTrgmNFA</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>text_re</span><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Delimiter'>, 
</span><a name="LN523"></a>              <a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>graph</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN525"></a>    <a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>trg</span><span class='Delimiter'>; 
</span><a name="LN526"></a>    <a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a>     <span class='Declare_Local'>regex</span><span class='Delimiter'>; 
</span><a name="LN527"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tmpcontext</span><span class='Delimiter'>; 
</span><a name="LN528"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This processing generates a great deal of cruft, which we'd like to 
     * clean up before returning (since this function may be called in a 
     * query-lifespan memory context).  Make a temp context we can work in so 
     * that cleanup is easy. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN527"><span class='Ref_To_Local'>tmpcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                       <span class='String'>"createTrgmNFA temporary context"</span><span class='Delimiter'>, 
</span>                                       <a href="../../src/include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN528"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN527"><span class='Ref_To_Local'>tmpcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Stage 1: Compile the regexp into a NFA, using the regexp library. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="trgm.h.html#LN24"><span class='Ref_to_Const'>IGNORECASE</span></a> 
    <a href="trgm_regexp.c.html#LN481"><span class='Ref_to_Proto'>RE_compile</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN526"><span class='Ref_To_Local'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN522"><span class='Ref_to_Parameter'>text_re</span></a><span class='Delimiter'>, </span><a href="../../src/include/regex/regex.h.html#LN102"><span class='Ref_to_Const'>REG_ADVANCED</span></a> <span class='Operator'>| </span><a href="../../src/include/regex/regex.h.html#LN105"><span class='Ref_to_Const'>REG_ICASE</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN522"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="trgm_regexp.c.html#LN481"><span class='Ref_to_Proto'>RE_compile</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN526"><span class='Ref_To_Local'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN522"><span class='Ref_to_Parameter'>text_re</span></a><span class='Delimiter'>, </span><a href="../../src/include/regex/regex.h.html#LN102"><span class='Ref_to_Const'>REG_ADVANCED</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN522"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Since the regexp library allocates its internal data structures with 
     * malloc, we need to use a PG_TRY block to ensure that pg_regfree() gets 
     * done even if there's an error. 
     */ 
</span>    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="trgm_regexp.c.html#LN525"><span class='Ref_To_Local'>trg</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN479"><span class='Ref_to_Proto'>createTrgmNFAInternal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN526"><span class='Ref_To_Local'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN523"><span class='Ref_to_Parameter'>graph</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN523"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/backend/regex/regfree.c.html#LN47"><span class='Ref_to_Func'>pg_regfree</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN526"><span class='Ref_To_Local'>regex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/regex/regfree.c.html#LN47"><span class='Ref_to_Func'>pg_regfree</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN526"><span class='Ref_To_Local'>regex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up all the cruft we created */ 
</span>    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN528"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN527"><span class='Ref_To_Local'>tmpcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="trgm_regexp.c.html#LN525"><span class='Ref_To_Local'>trg</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end createTrgmNFA &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Body of createTrgmNFA, exclusive of regex compilation/freeing. 
 */ 
</span><span class='Keyword'>static </span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>* 
</span><a name="LN579"></a><span class='Declare_Function'>createTrgmNFAInternal</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>graph</span><span class='Delimiter'>, 
</span><a name="LN580"></a>                      <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN582"></a>    <a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>trg</span><span class='Delimiter'>; 
</span><a name="LN583"></a>    <a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a>     <span class='Declare_Local'>trgmNFA</span><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN579"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Collect color information from the regex */ 
</span>    <a href="trgm_regexp.c.html#LN483"><span class='Ref_to_Proto'>getColorInfo</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN579"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
    <a href="trgm_regexp.c.html#LN505"><span class='Ref_to_Proto'>printSourceNFA</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN579"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN405"><span class='Ref_to_Member'>ncolors</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Stage 2: Create an expanded graph from the source NFA. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN485"><span class='Ref_to_Proto'>transformGraph</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
    <a href="trgm_regexp.c.html#LN506"><span class='Ref_to_Proto'>printTrgmNFA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Fail if we were unable to make a nontrivial graph, ie it is possible to 
     * get from the initial state to the final state without reading any 
     * predictable trigram. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN409"><span class='Ref_to_Member'>initState</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Stage 3: Select color trigrams to expand.  Fail if too many trigrams. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN495"><span class='Ref_to_Proto'>selectColorTrigrams</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Stage 4: Expand color trigrams and pack graph into final 
     * representation. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN582"><span class='Ref_To_Local'>trg</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN496"><span class='Ref_to_Proto'>expandColorTrigrams</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN580"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="trgm_regexp.c.html#LN579"><span class='Ref_to_Parameter'>graph</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN501"><span class='Ref_to_Proto'>packGraph</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN583"><span class='Ref_To_Local'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN580"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
    <a href="trgm_regexp.c.html#LN508"><span class='Ref_to_Proto'>printTrgmPackedGraph</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="trgm_regexp.c.html#LN579"><span class='Ref_to_Parameter'>graph</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN582"><span class='Ref_To_Local'>trg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="trgm_regexp.c.html#LN582"><span class='Ref_To_Local'>trg</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end createTrgmNFAInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Main entry point for evaluating a graph during index scanning. 
 * 
 * The check[] array is indexed by trigram number (in the array of simple 
 * trigrams returned by createTrgmNFA), and holds TRUE for those trigrams 
 * that are present in the index entry being checked. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN640"></a><span class='Declare_Function'>trigramsMatchGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>graph</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>check</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN642"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN643"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>, 
</span><a name="LN644"></a>                <span class='Declare_Local'>k</span><span class='Delimiter'>, 
</span><a name="LN645"></a>                <span class='Declare_Local'>queueIn</span><span class='Delimiter'>, 
</span><a name="LN646"></a>                <span class='Declare_Local'>queueOut</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset temporary working areas. 
     */ 
</span>    memset<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN462"><span class='Ref_to_Member'>colorTrigramsActive</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN463"><span class='Ref_to_Member'>statesActive</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN458"><span class='Ref_to_Member'>statesCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check which color trigrams were matched.  A match for any simple 
     * trigram associated with a color trigram counts as a match of the color 
     * trigram. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN643"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN663"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>cnt</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN452"><span class='Ref_to_Member'>colorTrigramGroups</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN644"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN643"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN644"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN643"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><a href="trgm_regexp.c.html#LN663"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN644"><span class='Ref_To_Local'>k</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>check</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN644"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Found one matched trigram in the group. Can skip the rest 
                 * of them and go to the next group. 
                 */ 
</span>                <a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN462"><span class='Ref_to_Member'>colorTrigramsActive</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="trgm_regexp.c.html#LN643"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN643"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><a href="trgm_regexp.c.html#LN663"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the statesQueue to hold just the initial state.  Note: 
     * statesQueue has room for statesCount entries, which is certainly enough 
     * since no state will be put in the queue more than once. The 
     * statesActive array marks which states have been queued. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN463"><span class='Ref_to_Member'>statesActive</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN464"><span class='Ref_to_Member'>statesQueue</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN645"><span class='Ref_To_Local'>queueIn</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN646"><span class='Ref_To_Local'>queueOut</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process queued states as long as there are any. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN645"><span class='Ref_To_Local'>queueIn</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN646"><span class='Ref_To_Local'>queueOut</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN694"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>stateno</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN464"><span class='Ref_to_Member'>statesQueue</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN645"><span class='Ref_To_Local'>queueIn</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span><a name="LN695"></a>        <a href="trgm_regexp.c.html#LN433"><span class='Ref_to_Typedef'>TrgmPackedState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN459"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN694"><span class='Ref_To_Local'>stateno</span></a><span class='Delimiter'>]; 
</span><a name="LN696"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>cnt</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN695"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN435"><span class='Ref_to_Member'>arcsCount</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Loop over state's out-arcs */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN696"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN701"></a>            <a href="trgm_regexp.c.html#LN427"><span class='Ref_to_Typedef'>TrgmPackedArc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN695"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN436"><span class='Ref_to_Member'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If corresponding color trigram is present then activate the 
             * corresponding state.  We're done if that's the final state, 
             * otherwise queue the state if it's not been queued already. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN462"><span class='Ref_to_Member'>colorTrigramsActive</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN701"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN430"><span class='Ref_to_Member'>colorTrgm</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN710"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>nextstate</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN701"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN429"><span class='Ref_to_Member'>targetState</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN710"><span class='Ref_To_Local'>nextstate</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* success: final state is reachable */ 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN463"><span class='Ref_to_Member'>statesActive</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN710"><span class='Ref_To_Local'>nextstate</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN463"><span class='Ref_to_Member'>statesActive</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN710"><span class='Ref_To_Local'>nextstate</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN640"><span class='Ref_to_Parameter'>graph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN464"><span class='Ref_to_Member'>statesQueue</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN646"><span class='Ref_To_Local'>queueOut</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN710"><span class='Ref_To_Local'>nextstate</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;cnt;i++ &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while queueIn&LT;queueOut &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Queue is empty, so match fails. */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end trigramsMatchGraph &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compile regex string into struct at *regex. 
 * NB: pg_regfree must be applied to regex if this completes successfully. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN733"></a><span class='Declare_Function'>RE_compile</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>text_re</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cflags</span><span class='Delimiter'>, </span><a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN735"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>text_re_len</span> <span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN339"><span class='Ref_to_Macro'>VARSIZE_ANY_EXHDR</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN733"><span class='Ref_to_Parameter'>text_re</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN736"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>text_re_val</span> <span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN346"><span class='Ref_to_Macro'>VARDATA_ANY</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN733"><span class='Ref_to_Parameter'>text_re</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN737"></a>    <a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>pattern</span><span class='Delimiter'>; 
</span><a name="LN738"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pattern_len</span><span class='Delimiter'>; 
</span><a name="LN739"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>regcomp_result</span><span class='Delimiter'>; 
</span><a name="LN740"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>errMsg</span><span class='Delimiter'>[</span><span class='Number'>100</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert pattern string to wide characters */ 
</span>    <a href="trgm_regexp.c.html#LN737"><span class='Ref_To_Local'>pattern</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN735"><span class='Ref_To_Local'>text_re_len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN738"><span class='Ref_To_Local'>pattern_len</span></a> <span class='Operator'>= </span><a href="../../src/include/mb/pg_wchar.h.html#LN510"><span class='Ref_to_Proto'>pg_mb2wchar_with_len</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN736"><span class='Ref_To_Local'>text_re_val</span></a><span class='Delimiter'>, 
</span>                                       <a href="trgm_regexp.c.html#LN737"><span class='Ref_To_Local'>pattern</span></a><span class='Delimiter'>, 
</span>                                       <a href="trgm_regexp.c.html#LN735"><span class='Ref_To_Local'>text_re_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compile regex */ 
</span>    <a href="trgm_regexp.c.html#LN739"><span class='Ref_To_Local'>regcomp_result</span></a> <span class='Operator'>= </span><a href="../../src/include/regex/regex.h.html#LN169"><span class='Ref_to_Proto'>pg_regcomp</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN733"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, 
</span>                                <a href="trgm_regexp.c.html#LN737"><span class='Ref_To_Local'>pattern</span></a><span class='Delimiter'>, 
</span>                                <a href="trgm_regexp.c.html#LN738"><span class='Ref_To_Local'>pattern_len</span></a><span class='Delimiter'>, 
</span>                                <a href="trgm_regexp.c.html#LN733"><span class='Ref_to_Parameter'>cflags</span></a><span class='Delimiter'>, 
</span>                                <a href="trgm_regexp.c.html#LN733"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN737"><span class='Ref_To_Local'>pattern</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN739"><span class='Ref_To_Local'>regcomp_result</span></a> <span class='Operator'>!= </span><a href="../../src/include/regex/regex.h.html#LN136"><span class='Ref_to_Const'>REG_OKAY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* re didn't compile (no need for pg_regfree, if so) */ 
</span>        <a href="../../src/backend/regex/regerror.c.html#LN58"><span class='Ref_to_Func'>pg_regerror</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN739"><span class='Ref_To_Local'>regcomp_result</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN733"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN740"><span class='Ref_To_Local'>errMsg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN740"><span class='Ref_To_Local'>errMsg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_REGULAR_EXPRESSION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid regular expression: %s"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN740"><span class='Ref_To_Local'>errMsg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end RE_compile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*--------------------- 
 * Subroutines for pre-processing the color map (stage 1). 
 *--------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fill TrgmColorInfo structure for each color using regex export functions. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN777"></a><span class='Declare_Function'>getColorInfo</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN779"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>colorsCount</span> <span class='Operator'>= </span><a href="../../src/include/regex/regexport.h.html#LN49"><span class='Ref_to_Proto'>pg_reg_getnumcolors</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN777"><span class='Ref_to_Parameter'>regex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN780"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN777"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN405"><span class='Ref_to_Member'>ncolors</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN779"><span class='Ref_To_Local'>colorsCount</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN777"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN779"><span class='Ref_To_Local'>colorsCount</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop over colors, filling TrgmColorInfo about each. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN780"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN780"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN779"><span class='Ref_To_Local'>colorsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN780"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN791"></a>        <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>colorInfo</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN777"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN780"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN792"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>charsCount</span> <span class='Operator'>= </span><a href="../../src/include/regex/regexport.h.html#LN52"><span class='Ref_to_Proto'>pg_reg_getnumcharacters</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN777"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN780"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN793"></a>        <a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>chars</span><span class='Delimiter'>; 
</span><a name="LN794"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN792"><span class='Ref_To_Local'>charsCount</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="trgm_regexp.c.html#LN792"><span class='Ref_To_Local'>charsCount</span></a> <span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN223"><span class='Ref_to_Const'>COLOR_COUNT_LIMIT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Non expandable, or too large to work with */ 
</span>            <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN261"><span class='Ref_to_Member'>expandable</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN261"><span class='Ref_to_Member'>expandable</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN262"><span class='Ref_to_Member'>containsNonWord</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN792"><span class='Ref_To_Local'>charsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Extract all the chars in this color */ 
</span>        <a href="trgm_regexp.c.html#LN793"><span class='Ref_To_Local'>chars</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN792"><span class='Ref_To_Local'>charsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/regex/regexport.h.html#LN53"><span class='Ref_to_Proto'>pg_reg_getcharacters</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN777"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN780"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN793"><span class='Ref_To_Local'>chars</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN792"><span class='Ref_To_Local'>charsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Convert characters back to multibyte form, and save only those that 
         * are word characters.  Set "containsNonWord" if any non-word 
         * character.  (Note: it'd probably be nicer to keep the chars in 
         * pg_wchar format for now, but ISWORDCHR wants to see multibyte.) 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN794"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN794"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN792"><span class='Ref_To_Local'>charsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN794"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN821"></a>            <a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN484"><span class='Ref_to_Proto'>convertPgWchar</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN793"><span class='Ref_To_Local'>chars</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN794"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN821"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* ok to ignore it altogether */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm.h.html#LN50"><span class='Ref_to_Macro'>ISWORDCHR</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN821"><span class='Ref_To_Local'>c</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Parentheses'>))</span> 
                <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN821"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="trgm_regexp.c.html#LN791"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN262"><span class='Ref_to_Member'>containsNonWord</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN793"><span class='Ref_To_Local'>chars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;colorsCount;i++ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end getColorInfo &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Convert pg_wchar to multibyte format. 
 * Returns false if the character should be ignored completely. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN840"></a><span class='Declare_Function'>convertPgWchar</span><span class='Parentheses'>(</span><a href="../../src/include/mb/pg_wchar.h.html#LN24"><span class='Ref_to_Typedef'>pg_wchar</span></a> <span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* "s" has enough space for a multibyte character and a trailing NUL */ 
</span><a name="LN843"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>s</span><span class='Delimiter'>[</span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can ignore the NUL character, since it can never appear in a PG text 
     * string.  This avoids the need for various special cases when 
     * reconstructing trigrams. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN840"><span class='Ref_to_Parameter'>c</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do the conversion, making sure the result is NUL-terminated */ 
</span>    memset<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN843"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN843"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/mb/pg_wchar.h.html#LN514"><span class='Ref_to_Proto'>pg_wchar2mb_with_len</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN840"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN843"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In IGNORECASE mode, we can ignore uppercase characters.  We assume that 
     * the regex engine generated both uppercase and lowercase equivalents 
     * within each color, since we used the REG_ICASE option; so there's no 
     * need to process the uppercase version. 
     * 
     * XXX this code is dependent on the assumption that lowerstr() works the 
     * same as the regex engine's internal case folding machinery.  Might be 
     * wiser to expose pg_wc_tolower and test whether c == pg_wc_tolower(c). 
     * On the other hand, the trigrams in the index were created using 
     * lowerstr(), so we're probably screwed if there's any incompatibility 
     * anyway. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="trgm.h.html#LN24"><span class='Ref_to_Const'>IGNORECASE</span></a> 
    <span class='Delimiter'>{ 
</span><a name="LN872"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>lowerCased</span> <span class='Operator'>= </span><a href="../../src/include/tsearch/ts_locale.h.html#LN65"><span class='Ref_to_Proto'>lowerstr</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN843"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN872"><span class='Ref_To_Local'>lowerCased</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN843"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN872"><span class='Ref_To_Local'>lowerCased</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN872"><span class='Ref_To_Local'>lowerCased</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Fill result with exactly MAX_MULTIBYTE_CHAR_LEN bytes */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN840"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN843"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end convertPgWchar &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*--------------------- 
 * Subroutines for expanding original NFA graph into a trigram graph (stage 2). 
 *--------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Transform the graph, given a regex and extracted color information. 
 * 
 * We create and process a queue of expanded-graph states until all the states 
 * are processed. 
 * 
 * This algorithm may be stopped due to resource limitation. In this case we 
 * force every unprocessed branch to immediately finish with matching (this 
 * can give us false positives but no false negatives) by marking all 
 * unprocessed states as final. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN906"></a><span class='Declare_Function'>transformGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN908"></a>    <a href="../../src/include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hashCtl</span><span class='Delimiter'>; 
</span><a name="LN909"></a>    <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Declare_Local'>initkey</span><span class='Delimiter'>; 
</span><a name="LN910"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>initstate</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize this stage's workspace in trgmNFA struct */ 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN415"><span class='Ref_to_Member'>arcsCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN416"><span class='Ref_to_Member'>overflowed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create hashtable for states */ 
</span>    <a href="trgm_regexp.c.html#LN908"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN908"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN908"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Trigram NFA"</span><span class='Delimiter'>, 
</span>                                  <span class='Number'>1024</span><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="trgm_regexp.c.html#LN908"><span class='Ref_To_Local'>hashCtl</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../src/include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../src/include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../src/include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN410"><span class='Ref_to_Member'>nstates</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create initial state: ambiguous prefix, NFA's initial state */ 
</span>    <a href="../../src/include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN909"><span class='Ref_To_Local'>initkey</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN909"><span class='Ref_To_Local'>initkey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN909"><span class='Ref_To_Local'>initkey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN909"><span class='Ref_To_Local'>initkey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN909"><span class='Ref_To_Local'>initkey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="../../src/include/regex/regexport.h.html#LN42"><span class='Ref_to_Proto'>pg_reg_getinitialstate</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN910"><span class='Ref_To_Local'>initstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN493"><span class='Ref_to_Proto'>getState</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN909"><span class='Ref_To_Local'>initkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN910"><span class='Ref_To_Local'>initstate</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN409"><span class='Ref_to_Member'>initState</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN910"><span class='Ref_To_Local'>initstate</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recursively build the expanded graph by processing queue of states 
     * (breadth-first search).  getState already put initstate in the queue. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a> <span class='Operator'>!= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN944"></a>        <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we overflowed then just mark state as final.  Otherwise do 
         * actual processing. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN416"><span class='Ref_to_Member'>overflowed</span></a><span class='Parentheses'>) 
</span>            <a href="trgm_regexp.c.html#LN944"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="trgm_regexp.c.html#LN486"><span class='Ref_to_Proto'>processState</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN944"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Did we overflow? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN415"><span class='Ref_to_Member'>arcsCount</span></a> <span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN220"><span class='Ref_to_Const'>MAX_EXPANDED_ARCS</span></a> <span class='Operator'>|| 
</span>            <a href="../../src/include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN219"><span class='Ref_to_Const'>MAX_EXPANDED_STATES</span></a><span class='Parentheses'>)</span> 
            <a href="trgm_regexp.c.html#LN906"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN416"><span class='Ref_to_Member'>overflowed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while trgmNFA-&GT;queue!=NIL &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end transformGraph &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process one state: add enter keys and then add outgoing arcs. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN968"></a><span class='Declare_Function'>processState</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* keysQueue should be NIL already, but make sure */ 
</span>    <a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add state's own key, and then process all keys added to keysQueue until 
     * queue is empty.  But we can quit if the state gets marked final. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN487"><span class='Ref_to_Proto'>addKey</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN334"><span class='Ref_to_Member'>stateKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a> <span class='Operator'>!= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>&& !</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN980"></a>        <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>key</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN487"><span class='Ref_to_Proto'>addKey</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN980"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add outgoing arcs only if state isn't final (we have no interest in 
     * outgoing arcs if we already match) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>))</span> 
        <a href="trgm_regexp.c.html#LN489"><span class='Ref_to_Proto'>addArcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN968"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end processState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add the given enter key into the state's enterKeys list, and determine 
 * whether this should result in any further enter keys being added. 
 * If so, add those keys to keysQueue so that processState will handle them. 
 * 
 * If the enter key is for the NFA's final state, mark state as TSTATE_FIN. 
 * This situation means that we can reach the final state from this expanded 
 * state without reading any predictable trigram, so we must consider this 
 * state as an accepting one. 
 * 
 * The given key could be a duplicate of one already in enterKeys, or be 
 * redundant with some enterKeys.  So we check that before doing anything. 
 * 
 * Note that we don't generate any actual arcs here.  addArcs will do that 
 * later, after we have identified all the enter keys for this state. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1011"></a><span class='Declare_Function'>addKey</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1013"></a>    <a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcs</span><span class='Delimiter'>; 
</span><a name="LN1014"></a>    <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Declare_Local'>destKey</span><span class='Delimiter'>; 
</span><a name="LN1015"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>, 
</span><a name="LN1016"></a>               <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>, 
</span><a name="LN1017"></a>               <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span><a name="LN1018"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1019"></a>                <span class='Declare_Local'>arcsCount</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure any pad bytes in destKey are zero, since it may get used as a 
     * hashtable key by getState. 
     */ 
</span>    <a href="../../src/include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compare key to each existing enter key of the state to check for 
     * redundancy.  We can drop either old key(s) or the new key if we find 
     * redundancy. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN1016"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1036"></a>        <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>existingKey</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN1017"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1036"><span class='Ref_To_Local'>existingKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN494"><span class='Ref_to_Proto'>prefixContains</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1036"><span class='Ref_To_Local'>existingKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* This old key already covers the new key. Nothing to do */ 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN494"><span class='Ref_to_Proto'>prefixContains</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1036"><span class='Ref_To_Local'>existingKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The new key covers this old key. Remove the old key, it's 
                 * no longer needed once we add this key to the list. 
                 */ 
</span>                <a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN238"><span class='Ref_to_Proto'>list_delete_cell</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a><span class='Delimiter'>, 
</span>                                                    <a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1016"><span class='Ref_To_Local'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="trgm_regexp.c.html#LN1016"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="trgm_regexp.c.html#LN1016"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1015"><span class='Ref_To_Local'>cell</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1017"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while cell &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* No redundancy, so add this key to the state's list */ 
</span>    <a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a> <span class='Operator'>= </span><a href="../../src/backend/nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If state is now known final, mark it and we're done */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>== </span><a href="../../src/include/regex/regexport.h.html#LN43"><span class='Ref_to_Proto'>pg_reg_getfinalstate</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop through all outgoing arcs of the corresponding state in the 
     * original NFA. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN1019"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>= </span><a href="../../src/include/regex/regexport.h.html#LN44"><span class='Ref_to_Proto'>pg_reg_getnumoutarcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1013"><span class='Ref_To_Local'>arcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1019"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/regex/regexport.h.html#LN45"><span class='Ref_to_Proto'>pg_reg_getoutarcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1013"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1019"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1018"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1018"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1019"><span class='Ref_To_Local'>arcsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1018"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1083"></a>        <a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1013"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1018"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN50"><span class='Ref_to_Proto'>pg_reg_colorisbegin</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Start of line/string (^).  Trigram extraction treats start of 
             * line same as start of word: double space prefix is added. 
             * Hence, make an enter key showing we can reach the arc 
             * destination with all-blank prefix. 
             */ 
</span>            <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add enter key to this state */ 
</span>            <a href="trgm_regexp.c.html#LN488"><span class='Ref_to_Proto'>addKeyToQueue</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN51"><span class='Ref_to_Proto'>pg_reg_colorisend</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * End of line/string ($).  We must consider this arc as a 
             * transition that doesn't read anything.  The reason for adding 
             * this enter key to the state is that if the arc leads to the 
             * NFA's final state, we must mark this expanded state as final. 
             */ 
</span>            <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add enter key to this state */ 
</span>            <a href="trgm_regexp.c.html#LN488"><span class='Ref_to_Proto'>addKeyToQueue</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Regular color */ 
</span><a name="LN1118"></a>            <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>colorInfo</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1118"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN261"><span class='Ref_to_Member'>expandable</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1118"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN262"><span class='Ref_to_Member'>containsNonWord</span></a> <span class='Operator'>&& 
</span>                    <span class='Operator'>!</span><a href="trgm_regexp.c.html#LN492"><span class='Ref_to_Proto'>validArcLabel</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We can reach the arc destination after reading a 
                     * non-word character, but the prefix is not something 
                     * that addArc will accept with COLOR_BLANK, so no trigram 
                     * arc can get made for this transition.  We must make an 
                     * enter key to show that the arc destination is 
                     * reachable.  Set it up with an all-blank prefix, since 
                     * that corresponds to what the trigram extraction code 
                     * will do at a word starting boundary. 
                     */ 
</span>                    <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN488"><span class='Ref_to_Proto'>addKeyToQueue</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1118"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                    <span class='Operator'>!</span><a href="trgm_regexp.c.html#LN492"><span class='Ref_to_Proto'>validArcLabel</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We can reach the arc destination after reading a word 
                     * character, but the prefix is not something that addArc 
                     * will accept, so no trigram arc can get made for this 
                     * transition.  We must make an enter key to show that the 
                     * arc destination is reachable.  The prefix for the enter 
                     * key should reflect the info we have for this arc. 
                     */ 
</span>                    <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>                    <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN488"><span class='Ref_to_Proto'>addKeyToQueue</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if colorInfo-&GT;expandable &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Unexpandable color.  Add enter key with ambiguous prefix, 
                 * showing we can reach the destination from this state, but 
                 * the preceding colors will be uncertain.  (We do not set the 
                 * first prefix color to key-&GT;prefix.colors[1], because a 
                 * prefix of known followed by unknown is invalid.) 
                 */ 
</span>                <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1083"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN488"><span class='Ref_to_Proto'>addKeyToQueue</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1011"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1014"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;arcsCount;i++ &raquo; </span> 
 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1013"><span class='Ref_To_Local'>arcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end addKey &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add copy of given key to keysQueue for later processing. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1182"></a><span class='Declare_Function'>addKeyToQueue</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1184"></a>    <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>keyCopy</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1184"><span class='Ref_To_Local'>keyCopy</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1182"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1182"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a> <span class='Operator'>= </span><a href="../../src/backend/nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1182"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN414"><span class='Ref_to_Member'>keysQueue</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1184"><span class='Ref_To_Local'>keyCopy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add outgoing arcs from given state, whose enter keys are all now known. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1194"></a><span class='Declare_Function'>addArcs</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1196"></a>    <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Declare_Local'>destKey</span><span class='Delimiter'>; 
</span><a name="LN1197"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN1198"></a>    <a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcs</span><span class='Delimiter'>; 
</span><a name="LN1199"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>arcsCount</span><span class='Delimiter'>, 
</span><a name="LN1200"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure any pad bytes in destKey are zero, since it may get used as a 
     * hashtable key by getState. 
     */ 
</span>    <a href="../../src/include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Iterate over enter keys associated with this expanded-graph state. This 
     * includes both the state's own stateKey, and any enter keys we added to 
     * it during addKey (which represent expanded-graph states that are not 
     * distinguishable from this one by means of trigrams).  For each such 
     * enter key, examine all the out-arcs of the key's underlying NFA state, 
     * and try to make a trigram arc leading to where the out-arc leads. 
     * (addArc will deal with whether the arc is valid or not.) 
     */ 
</span>    <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1197"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1219"></a>        <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>key</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1197"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN1199"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>= </span><a href="../../src/include/regex/regexport.h.html#LN44"><span class='Ref_to_Proto'>pg_reg_getnumoutarcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1219"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1198"><span class='Ref_To_Local'>arcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1199"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/regex/regexport.h.html#LN45"><span class='Ref_to_Proto'>pg_reg_getoutarcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN403"><span class='Ref_to_Member'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1219"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1198"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1199"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1200"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1200"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1199"><span class='Ref_To_Local'>arcsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1200"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1227"></a>            <a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1198"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1200"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1228"></a>            <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>colorInfo</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1227"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Ignore non-expandable colors; addKey already handled the case. 
             * 
             * We need no special check for begin/end pseudocolors here.  We 
             * don't need to do any processing for them, and they will be 
             * marked non-expandable since the regex engine will have reported 
             * them that way. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN1228"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN261"><span class='Ref_to_Member'>expandable</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1228"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN262"><span class='Ref_to_Member'>containsNonWord</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Color includes non-word character(s). 
                 * 
                 * Generate an arc, treating this transition as occurring on 
                 * BLANK.  This allows word-ending trigrams to be manufactured 
                 * if possible. 
                 */ 
</span>                <a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1219"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>                <a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1227"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span> 
                <a href="trgm_regexp.c.html#LN490"><span class='Ref_to_Proto'>addArc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1219"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1228"><span class='Ref_To_Local'>colorInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Color includes word character(s). 
                 * 
                 * Generate an arc.  Color is pushed into prefix of target 
                 * state. 
                 */ 
</span>                <a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1219"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>                <a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1227"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1227"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span> 
                <a href="trgm_regexp.c.html#LN490"><span class='Ref_to_Proto'>addArc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1194"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1219"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1227"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1196"><span class='Ref_To_Local'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;arcsCount;i++ &raquo; </span> 
 
        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1198"><span class='Ref_To_Local'>arcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end addArcs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Generate an out-arc of the expanded graph, if it's valid and not redundant. 
 * 
 * state: expanded-graph state we want to add an out-arc to 
 * key: provides prefix colors (key-&GT;nstate is not used) 
 * co: transition color 
 * destKey: identifier for destination state of expanded graph 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1286"></a><span class='Declare_Function'>addArc</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN1287"></a>       <a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a> <span class='Declare_Parameter'>co</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>destKey</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1289"></a>    <a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>arc</span><span class='Delimiter'>; 
</span><a name="LN1290"></a>    <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do nothing if this wouldn't be a valid arc label trigram */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN492"><span class='Ref_to_Proto'>validArcLabel</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1287"><span class='Ref_to_Parameter'>co</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if we are going to reach key which is covered by a key which is 
     * already listed in this state.  If so arc is useless: the NFA can bypass 
     * it through a path that doesn't require any predictable trigram, so 
     * whether the arc's trigram is present or not doesn't really matter. 
     */ 
</span>    <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1290"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1304"></a>        <a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>existingKey</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1290"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1304"><span class='Ref_To_Local'>existingKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1287"><span class='Ref_to_Parameter'>destKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a> <span class='Operator'>&& 
</span>            <a href="trgm_regexp.c.html#LN494"><span class='Ref_to_Proto'>prefixContains</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1304"><span class='Ref_To_Local'>existingKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1287"><span class='Ref_to_Parameter'>destKey</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Checks were successful, add new arc */ 
</span>    <a href="trgm_regexp.c.html#LN1289"><span class='Ref_To_Local'>arc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1289"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN350"><span class='Ref_to_Member'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN493"><span class='Ref_to_Proto'>getState</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1287"><span class='Ref_to_Parameter'>destKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1289"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="trgm_regexp.c.html#LN1289"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <a href="trgm_regexp.c.html#LN1289"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1287"><span class='Ref_to_Parameter'>co</span></a><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN335"><span class='Ref_to_Member'>arcs</span></a> <span class='Operator'>= </span><a href="../../src/backend/nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN335"><span class='Ref_to_Member'>arcs</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1289"><span class='Ref_To_Local'>arc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1286"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN415"><span class='Ref_to_Member'>arcsCount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end addArc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Can we make a valid trigram arc label from the given prefix and arc color? 
 * 
 * This is split out so that tests in addKey and addArc will stay in sync. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1328"></a><span class='Declare_Function'>validArcLabel</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a> <span class='Declare_Parameter'>co</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We have to know full trigram in order to add outgoing arc.  So we can't 
     * do it if prefix is ambiguous. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If key-&GT;prefix.colors[0] isn't unknown, its second color isn't either */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* And we should not be called with an unknown arc color anytime */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>co</span></a> <span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't bother with making arcs representing three non-word 
     * characters, since that's useless for trigram extraction. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a> <span class='Operator'>&& 
</span>        <a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a> <span class='Operator'>&& 
</span>        <a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>co</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We also reject nonblank-blank-anything.  The nonblank-blank-nonblank 
     * case doesn't correspond to any trigram the trigram extraction code 
     * would make.  The nonblank-blank-blank case is also not possible with 
     * RPADDING = 1.  (Note that in many cases we'd fail to generate such a 
     * trigram even if it were valid, for example processing "foo bar" will 
     * not result in considering the trigram "o  ".  So if you want to support 
     * RPADDING = 2, there's more to do than just twiddle this test.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a> <span class='Operator'>&& 
</span>        <a href="trgm_regexp.c.html#LN1328"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN310"><span class='Ref_to_Member'>prefix</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Other combinations involving blank are valid, in particular we assume 
     * blank-blank-nonblank is valid, which presumes that LPADDING is 2. 
     * 
     * Note: Using again the example "foo bar", we will not consider the 
     * trigram "  b", though this trigram would be found by the trigram 
     * extraction code.  Since we will find " ba", it doesn't seem worth 
     * trying to hack the algorithm to generate the additional trigram. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* arc label is valid */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end validArcLabel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get state of expanded graph for given state key, 
 * and queue the state for processing if it didn't already exist. 
 */ 
</span><span class='Keyword'>static </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>* 
</span><a name="LN1383"></a><span class='Declare_Function'>getState</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN308"><span class='Ref_to_Typedef'>TrgmStateKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1385"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN1386"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1383"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1383"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="../../src/include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1386"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN1386"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* New state: initialize and queue it */ 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN335"><span class='Ref_to_Member'>arcs</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN336"><span class='Ref_to_Member'>enterKeys</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* states are initially given negative numbers */ 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a> <span class='Operator'>= -</span><span class='Parentheses'>(</span><span class='Operator'>++</span><a href="trgm_regexp.c.html#LN1383"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN410"><span class='Ref_to_Member'>nstates</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN340"><span class='Ref_to_Member'>tentFlags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN341"><span class='Ref_to_Member'>tentParent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN1383"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a> <span class='Operator'>= </span><a href="../../src/backend/nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1383"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN413"><span class='Ref_to_Member'>queue</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="trgm_regexp.c.html#LN1385"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end getState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if prefix1 "contains" prefix2. 
 * 
 * "contains" means that any exact prefix (with no ambiguity) that satisfies 
 * prefix2 also satisfies prefix1. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1414"></a><span class='Declare_Function'>prefixContains</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN289"><span class='Ref_to_Typedef'>TrgmPrefix</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prefix1</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN289"><span class='Ref_to_Typedef'>TrgmPrefix</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prefix2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Fully ambiguous prefix contains everything */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Prefix with only first unknown color contains every prefix with 
         * same second color. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Exact prefix contains only the exact same prefix */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>&& 
</span>            <a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1414"><span class='Ref_to_Parameter'>prefix2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN291"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end prefixContains &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*--------------------- 
 * Subroutines for expanding color trigrams into regular trigrams (stage 3). 
 *--------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get vector of all color trigrams in graph and select which of them 
 * to expand into simple trigrams. 
 * 
 * Returns TRUE if OK, FALSE if exhausted resource limits. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1456"></a><span class='Declare_Function'>selectColorTrigrams</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1458"></a>    <a href="../../src/include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>scan_status</span><span class='Delimiter'>; 
</span><a name="LN1459"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>arcsCount</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN415"><span class='Ref_to_Member'>arcsCount</span></a><span class='Delimiter'>, 
</span><a name="LN1460"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1461"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN1462"></a>    <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>colorTrgms</span><span class='Delimiter'>; 
</span><a name="LN1463"></a>    <a href="../../src/include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>totalTrgmCount</span><span class='Delimiter'>; 
</span><a name="LN1464"></a>    <a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>totalTrgmPenalty</span><span class='Delimiter'>; 
</span><a name="LN1465"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>cnumber</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Collect color trigrams from all arcs */ 
</span>    <a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1459"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN419"><span class='Ref_to_Member'>colorTrgms</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1458"><span class='Ref_To_Local'>scan_status</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN1461"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1458"><span class='Ref_To_Local'>scan_status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1475"></a>        <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1475"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1461"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN335"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1479"></a>            <a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1475"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1480"></a>            <a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcInfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1481"></a>            <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trgmInfo</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <a href="trgm_regexp.c.html#LN1480"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN360"><span class='Ref_to_Member'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1461"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1480"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN361"><span class='Ref_to_Member'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1479"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN350"><span class='Ref_to_Member'>target</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1481"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1479"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1481"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN376"><span class='Ref_to_Member'>cnumber</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* count and penalty will be set below */ 
</span>            <a href="trgm_regexp.c.html#LN1481"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1481"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN138"><span class='Ref_to_Macro'>list_make1</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1480"><span class='Ref_To_Local'>arcInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (state=(TrgmState*)ha... &raquo; </span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1459"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove duplicates, merging their arcs lists */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1459"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>&GT;= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1498"></a>        <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p1</span><span class='Delimiter'>, 
</span><a name="LN1499"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>p2</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Sort trigrams to ease duplicate detection */ 
</span>        <a href="../../src/include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1459"><span class='Ref_To_Local'>arcsCount</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN499"><span class='Ref_to_Proto'>colorTrgmInfoCmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* p1 is probe point, p2 is last known non-duplicate. */ 
</span>        <a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1498"><span class='Ref_To_Local'>p1</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1498"><span class='Ref_To_Local'>p1</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a> <span class='Operator'>+ </span><a href="trgm_regexp.c.html#LN1459"><span class='Ref_To_Local'>arcsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1498"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN499"><span class='Ref_to_Proto'>colorTrgmInfoCmp</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1498"><span class='Ref_To_Local'>p1</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a> <span class='Operator'>= *</span><a href="trgm_regexp.c.html#LN1498"><span class='Ref_To_Local'>p1</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1498"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1499"><span class='Ref_To_Local'>p2</span></a> <span class='Operator'>- </span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if arcsCount&GT;=2 &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1459"><span class='Ref_To_Local'>arcsCount</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Count number of simple trigrams generated by each color trigram, and 
     * also compute a penalty value, which is the number of simple trigrams 
     * times a multiplier that depends on its whitespace content. 
     * 
     * Note: per-color-trigram counts cannot overflow an int so long as 
     * COLOR_COUNT_LIMIT is not more than the cube root of INT_MAX, ie about 
     * 1290.  However, the grand total totalTrgmCount might conceivably 
     * overflow an int, so we use int64 for that within this routine.  Also, 
     * penalties are calculated in float4 arithmetic to avoid any overflow 
     * worries. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN1463"><span class='Ref_To_Local'>totalTrgmCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1464"><span class='Ref_To_Local'>totalTrgmPenalty</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1541"></a>        <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trgmInfo</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1542"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>, 
</span><a name="LN1543"></a>                    <span class='Declare_Local'>count</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>, 
</span><a name="LN1544"></a>                    <span class='Declare_Local'>typeIndex</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1542"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1542"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1542"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1548"></a>            <a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a>   <span class='Declare_Local'>c</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1541"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1542"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span> 
            <a href="trgm_regexp.c.html#LN1544"><span class='Ref_To_Local'>typeIndex</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1548"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1544"><span class='Ref_To_Local'>typeIndex</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="trgm_regexp.c.html#LN1543"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>*= </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1548"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="trgm_regexp.c.html#LN1541"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN377"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1543"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1463"><span class='Ref_To_Local'>totalTrgmCount</span></a> <span class='Operator'>+= </span><a href="trgm_regexp.c.html#LN1543"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1541"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN378"><span class='Ref_to_Member'>penalty</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN229"><span class='Ref_to_Global_Var'>penalties</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1544"><span class='Ref_To_Local'>typeIndex</span></a><span class='Delimiter'>] </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN1543"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1464"><span class='Ref_To_Local'>totalTrgmPenalty</span></a> <span class='Operator'>+= </span><a href="trgm_regexp.c.html#LN1541"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN378"><span class='Ref_to_Member'>penalty</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;trgmNFA-&GT;colorT... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Sort color trigrams in descending order of their penalties */ 
</span>    <a href="../../src/include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="trgm_regexp.c.html#LN500"><span class='Ref_to_Proto'>colorTrgmInfoPenaltyCmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove color trigrams from the graph so long as total penalty of color 
     * trigrams exceeds WISH_TRGM_PENALTY.  (If we fail to get down to 
     * WISH_TRGM_PENALTY, it's OK so long as total count is no more than 
     * MAX_TRGM_COUNT.)  We prefer to remove color trigrams with higher 
     * penalty, since those are the most promising for reducing the total 
     * penalty.  When removing a color trigram we have to merge states 
     * connected by arcs labeled with that trigram.  It's necessary to not 
     * merge initial and final states, because our graph becomes useless if 
     * that happens; so we cannot always remove the trigram we'd prefer to. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1579"></a>        <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trgmInfo</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1580"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>canRemove</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN1581"></a>        <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done if we've reached the target */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1464"><span class='Ref_To_Local'>totalTrgmPenalty</span></a> <span class='Operator'>&LT;= </span><a href="trgm_regexp.c.html#LN222"><span class='Ref_to_Const'>WISH_TRGM_PENALTY</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"considering ctrgm %d %d %d, penalty %f, %d arcs\n"</span><span class='Delimiter'>, 
</span>                <a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], 
</span>                <a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN378"><span class='Ref_to_Member'>penalty</span></a><span class='Delimiter'>, 
</span>                <a href="../../src/include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Does any arc of this color trigram connect initial and final 
         * states?  If so we can't remove it. 
         */ 
</span>        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1581"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1602"></a>            <a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcInfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1581"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1603"></a>            <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>source</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1602"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN360"><span class='Ref_to_Member'>source</span></a><span class='Delimiter'>, 
</span><a name="LN1604"></a>                       <span class='Operator'>*</span><span class='Declare_Local'>target</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1602"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN361"><span class='Ref_to_Member'>target</span></a><span class='Delimiter'>; 
</span><a name="LN1605"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>source_flags</span><span class='Delimiter'>, 
</span><a name="LN1606"></a>                        <span class='Declare_Local'>target_flags</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"examining arc to s%d (%x) from s%d (%x)\n"</span><span class='Delimiter'>, 
</span>                    <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>snumber<span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>flags<span class='Delimiter'>, 
</span>                    <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Comment_Multi_Line'>/* examine parent states, if any merging has already happened */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>parent<span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>parent<span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>" ... after completed merges: to s%d (%x) from s%d (%x)\n"</span><span class='Delimiter'>, 
</span>                    <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>snumber<span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>flags<span class='Delimiter'>, 
</span>                    <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Comment_Multi_Line'>/* we must also consider merges we are planning right now */ 
</span>            <a href="trgm_regexp.c.html#LN1605"><span class='Ref_To_Local'>source_flags</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN340"><span class='Ref_to_Member'>tentFlags</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN341"><span class='Ref_to_Member'>tentParent</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN341"><span class='Ref_to_Member'>tentParent</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1605"><span class='Ref_To_Local'>source_flags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN340"><span class='Ref_to_Member'>tentFlags</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="trgm_regexp.c.html#LN1606"><span class='Ref_To_Local'>target_flags</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>flags <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentFlags<span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentParent<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentParent<span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1606"><span class='Ref_To_Local'>target_flags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>flags <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentFlags<span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>" ... after tentative merges: to s%d (%x) from s%d (%x)\n"</span><span class='Delimiter'>, 
</span>                    <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>snumber<span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1606"><span class='Ref_To_Local'>target_flags</span></a><span class='Delimiter'>, 
</span>                    <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1605"><span class='Ref_To_Local'>source_flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Comment_Multi_Line'>/* would fully-merged state have both INIT and FIN set? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="trgm_regexp.c.html#LN1605"><span class='Ref_To_Local'>source_flags</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN1606"><span class='Ref_To_Local'>target_flags</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>))</span> <span class='Operator'>== 
</span>                <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1580"><span class='Ref_To_Local'>canRemove</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* ok so far, so remember planned merge */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>" ... tentatively merging s%d into s%d\n"</span><span class='Delimiter'>, 
</span>                        <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>snumber<span class='Delimiter'>, </span><span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <a href="trgm_regexp.c.html#LN1604"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentParent <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1603"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN340"><span class='Ref_to_Member'>tentFlags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN1606"><span class='Ref_To_Local'>target_flags</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We must reset all the tentFlags/tentParent fields before 
         * continuing.  tentFlags could only have become set in states that 
         * are the source or parent or tentative parent of one of the current 
         * arcs; likewise tentParent could only have become set in states that 
         * are the target or parent or tentative parent of one of the current 
         * arcs.  There might be some overlap between those sets, but if we 
         * clear tentFlags in target states as well as source states, we 
         * should be okay even if we visit a state as target before visiting 
         * it as a source. 
         */ 
</span>        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1581"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1679"></a>            <a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcInfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1581"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1680"></a>            <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>source</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1679"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN360"><span class='Ref_to_Member'>source</span></a><span class='Delimiter'>, 
</span><a name="LN1681"></a>                       <span class='Operator'>*</span><span class='Declare_Local'>target</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1679"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN361"><span class='Ref_to_Member'>target</span></a><span class='Delimiter'>; 
</span><a name="LN1682"></a>            <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>ttarget</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* no need to touch previously-merged states */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>parent<span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>parent<span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN340"><span class='Ref_to_Member'>tentFlags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1680"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN341"><span class='Ref_to_Member'>tentParent</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN1682"><span class='Ref_To_Local'>ttarget</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentParent<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentParent <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>tentFlags <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* in case it was also a source */ 
</span>                <a href="trgm_regexp.c.html#LN1681"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1682"><span class='Ref_To_Local'>ttarget</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Now, move on if we can't drop this trigram */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN1580"><span class='Ref_To_Local'>canRemove</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
            <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>" ... not ok to merge\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* OK, merge states linked by each arc labeled by the trigram */ 
</span>        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1581"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN380"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1716"></a>            <a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcInfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN358"><span class='Ref_to_Typedef'>TrgmArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1581"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1717"></a>            <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>source</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1716"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN360"><span class='Ref_to_Member'>source</span></a><span class='Delimiter'>, 
</span><a name="LN1718"></a>                       <span class='Operator'>*</span><span class='Declare_Local'>target</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1716"><span class='Ref_To_Local'>arcInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN361"><span class='Ref_to_Member'>target</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1718"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>parent<span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1718"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1718"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>parent<span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN1718"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
                <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"merging s%d into s%d\n"</span><span class='Delimiter'>, 
</span>                        <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1718"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span>snumber<span class='Delimiter'>, </span><span class='Operator'>-</span><a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <a href="trgm_regexp.c.html#LN498"><span class='Ref_to_Proto'>mergeStates</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1718"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Assert we didn't merge initial and final states */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN1717"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= 
</span>                       <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a> <span class='Operator'>| </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Mark trigram unexpanded, and update totals */ 
</span>        <a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1463"><span class='Ref_To_Local'>totalTrgmCount</span></a> <span class='Operator'>-= </span><a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN377"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN1464"><span class='Ref_To_Local'>totalTrgmPenalty</span></a> <span class='Operator'>-= </span><a href="trgm_regexp.c.html#LN1579"><span class='Ref_To_Local'>trgmInfo</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN378"><span class='Ref_to_Member'>penalty</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;trgmNFA-&GT;colorT... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Did we succeed in fitting into MAX_TRGM_COUNT? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1463"><span class='Ref_To_Local'>totalTrgmCount</span></a> <span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN221"><span class='Ref_to_Const'>MAX_TRGM_COUNT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN421"><span class='Ref_to_Member'>totalTrgmCount</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN1463"><span class='Ref_To_Local'>totalTrgmCount</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Sort color trigrams by colors (will be useful for bsearch in packGraph) 
     * and enumerate the color trigrams that are expanded. 
     */ 
</span>    <a href="trgm_regexp.c.html#LN1465"><span class='Ref_To_Local'>cnumber</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="trgm_regexp.c.html#LN499"><span class='Ref_to_Proto'>colorTrgmInfoCmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1456"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="trgm_regexp.c.html#LN1462"><span class='Ref_To_Local'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1460"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN376"><span class='Ref_to_Member'>cnumber</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1465"><span class='Ref_To_Local'>cnumber</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1465"><span class='Ref_To_Local'>cnumber</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end selectColorTrigrams &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Expand selected color trigrams into regular trigrams. 
 * 
 * Returns the TRGM array to be passed to the index machinery. 
 * The array must be allocated in rcontext. 
 */ 
</span><span class='Keyword'>static </span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>* 
</span><a name="LN1775"></a><span class='Declare_Function'>expandColorTrigrams</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1777"></a>    <a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>trg</span><span class='Delimiter'>; 
</span><a name="LN1778"></a>    <a href="trgm.h.html#LN37"><span class='Ref_to_Typedef'>trgm</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN1779"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1780"></a>    <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Declare_Local'>blankColor</span><span class='Delimiter'>; 
</span><a name="LN1781"></a>    <a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Declare_Local'>blankChar</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up "blank" color structure containing a single zero character */ 
</span>    memset<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1781"><span class='Ref_To_Local'>blankChar</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1781"><span class='Ref_To_Local'>blankChar</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1780"><span class='Ref_To_Local'>blankColor</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1780"><span class='Ref_To_Local'>blankColor</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1781"><span class='Ref_To_Local'>blankChar</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Construct the trgm array */ 
</span>    <a href="trgm_regexp.c.html#LN1777"><span class='Ref_To_Local'>trg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1775"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, 
</span>                               <a href="trgm.h.html#LN69"><span class='Ref_to_Const'>TRGMHDRSIZE</span></a> <span class='Operator'>+ 
</span>                               <a href="trgm_regexp.c.html#LN1775"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN421"><span class='Ref_to_Member'>totalTrgmCount</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm.h.html#LN37"><span class='Ref_to_Typedef'>trgm</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1777"><span class='Ref_To_Local'>trg</span></a><span class='Operator'>-&GT;</span><a href="trgm.h.html#LN65"><span class='Ref_to_Member'>flag</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/adt/tsgistidx.c.html#LN57"><span class='Ref_to_Const'>ARRKEY</span></a><span class='Delimiter'>; 
</span>    <a href="../../src/include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1777"><span class='Ref_To_Local'>trg</span></a><span class='Delimiter'>, </span><a href="../hstore/hstore_gist.c.html#LN51"><span class='Ref_to_Macro'>CALCGTSIZE</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/adt/tsgistidx.c.html#LN57"><span class='Ref_to_Const'>ARRKEY</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1775"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN421"><span class='Ref_to_Member'>totalTrgmCount</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1778"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/adt/tsgistidx.c.html#LN69"><span class='Ref_to_Macro'>GETARR</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1777"><span class='Ref_To_Local'>trg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1779"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1779"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1775"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1779"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1798"></a>        <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>colorTrgm</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1775"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN419"><span class='Ref_to_Member'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1779"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1799"></a>        <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>c</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN1800"></a>        <a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN1801"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>, 
</span><a name="LN1802"></a>                    <span class='Declare_Local'>i1</span><span class='Delimiter'>, 
</span><a name="LN1803"></a>                    <span class='Declare_Local'>i2</span><span class='Delimiter'>, 
</span><a name="LN1804"></a>                    <span class='Declare_Local'>i3</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore any unexpanded trigrams ... */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN1798"><span class='Ref_To_Local'>colorTrgm</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get colors, substituting the dummy struct for COLOR_BLANK */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1798"><span class='Ref_To_Local'>colorTrgm</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1775"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN404"><span class='Ref_to_Member'>colorInfo</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1798"><span class='Ref_To_Local'>colorTrgm</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]]; 
</span>            <span class='Control'>else</span> 
                <a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1801"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1780"><span class='Ref_To_Local'>blankColor</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Iterate over all possible combinations of colors' characters */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1802"><span class='Ref_To_Local'>i1</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1802"><span class='Ref_To_Local'>i1</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1802"><span class='Ref_To_Local'>i1</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="trgm_regexp.c.html#LN1800"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1802"><span class='Ref_To_Local'>i1</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1803"><span class='Ref_To_Local'>i2</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1803"><span class='Ref_To_Local'>i2</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1803"><span class='Ref_To_Local'>i2</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1800"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1803"><span class='Ref_To_Local'>i2</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1804"><span class='Ref_To_Local'>i3</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1804"><span class='Ref_To_Local'>i3</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1804"><span class='Ref_To_Local'>i3</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="trgm_regexp.c.html#LN1800"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1799"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1804"><span class='Ref_To_Local'>i3</span></a><span class='Delimiter'>]; 
</span>                    <a href="trgm_regexp.c.html#LN497"><span class='Ref_to_Proto'>fillTrgm</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1778"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1800"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="trgm_regexp.c.html#LN1778"><span class='Ref_To_Local'>p</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;trgmNFA-&GT;colorT... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="trgm_regexp.c.html#LN1777"><span class='Ref_To_Local'>trg</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end expandColorTrigrams &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Convert trigram into trgm datatype. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1843"></a><span class='Declare_Function'>fillTrgm</span><span class='Parentheses'>(</span><a href="trgm.h.html#LN37"><span class='Ref_to_Typedef'>trgm</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ptrgm</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN241"><span class='Ref_to_Typedef'>trgm_mb_char</span></a> <span class='Declare_Parameter'>s</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1845"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>str</span><span class='Delimiter'>[</span><span class='Number'>3</span> <span class='Operator'>* </span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a><span class='Delimiter'>], 
</span><a name="LN1846"></a>               <span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN1847"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1848"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Write multibyte string into "str" (we don't need null termination) */ 
</span>    <a href="trgm_regexp.c.html#LN1846"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1845"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1847"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1847"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1847"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1843"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1847"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1848"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1848"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a> <span class='Operator'>&& </span><a href="trgm_regexp.c.html#LN1843"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1847"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1848"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; </span><a href="trgm_regexp.c.html#LN1848"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="trgm_regexp.c.html#LN1846"><span class='Ref_To_Local'>p</span></a><span class='Operator'>++ = </span><a href="trgm_regexp.c.html#LN1843"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1847"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1848"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Emit a space in place of COLOR_BLANK */ 
</span>            <span class='Operator'>*</span><a href="trgm_regexp.c.html#LN1846"><span class='Ref_To_Local'>p</span></a><span class='Operator'>++ = </span><span class='String'>' '</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Convert "str" to a standard trigram (possibly hashing it) */ 
</span>    <a href="trgm.h.html#LN124"><span class='Ref_to_Proto'>compact_trigram</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1843"><span class='Ref_to_Parameter'>ptrgm</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1845"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1846"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>- </span><a href="trgm_regexp.c.html#LN1845"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fillTrgm &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Merge two states of graph. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1875"></a><span class='Declare_Function'>mergeStates</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state1</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state1</span></a> <span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* state1 absorbs state2's flags */ 
</span>    <a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* state2, and indirectly all its children, become children of state1 */ 
</span>    <a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1875"><span class='Ref_to_Parameter'>state1</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Compare function for sorting of color trigrams by their colors. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1892"></a><span class='Declare_Function'>colorTrgmInfoCmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1894"></a>    <span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>c1</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN1892"><span class='Ref_to_Parameter'>p1</span></a><span class='Delimiter'>; 
</span><a name="LN1895"></a>    <span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>c2</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN1892"><span class='Ref_to_Parameter'>p2</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> memcmp<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1894"><span class='Ref_To_Local'>c1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1895"><span class='Ref_To_Local'>c2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN375"><span class='Ref_to_Member'>ctrgm</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN298"><span class='Ref_to_Typedef'>ColorTrgm</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Compare function for sorting color trigrams in descending order of 
 * their penalty fields. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1905"></a><span class='Declare_Function'>colorTrgmInfoPenaltyCmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>p2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1907"></a>    <a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>penalty1</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN1905"><span class='Ref_to_Parameter'>p1</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>penalty<span class='Delimiter'>; 
</span><a name="LN1908"></a>    <a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>penalty2</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN1905"><span class='Ref_to_Parameter'>p2</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>penalty<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1907"><span class='Ref_To_Local'>penalty1</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1908"><span class='Ref_To_Local'>penalty2</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1907"><span class='Ref_To_Local'>penalty1</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1908"><span class='Ref_To_Local'>penalty2</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/*--------------------- 
 * Subroutines for packing the graph into final representation (stage 4). 
 *--------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Pack expanded graph into final representation. 
 * 
 * The result data must be allocated in rcontext. 
 */ 
</span><span class='Keyword'>static </span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>* 
</span><a name="LN1930"></a><span class='Declare_Function'>packGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>rcontext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1932"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>snumber</span> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>, 
</span><a name="LN1933"></a>                <span class='Declare_Local'>arcIndex</span><span class='Delimiter'>, 
</span><a name="LN1934"></a>                <span class='Declare_Local'>arcsCount</span><span class='Delimiter'>; 
</span><a name="LN1935"></a>    <a href="../../src/include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>scan_status</span><span class='Delimiter'>; 
</span><a name="LN1936"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN1937"></a>    <a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcs</span><span class='Delimiter'>, 
</span><a name="LN1938"></a>               <span class='Operator'>*</span><span class='Declare_Local'>p1</span><span class='Delimiter'>, 
</span><a name="LN1939"></a>               <span class='Operator'>*</span><span class='Declare_Local'>p2</span><span class='Delimiter'>; 
</span><a name="LN1940"></a>    <a href="trgm_regexp.c.html#LN427"><span class='Ref_to_Typedef'>TrgmPackedArc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>packedArcs</span><span class='Delimiter'>; 
</span><a name="LN1941"></a>    <a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1942"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1943"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Enumerate surviving states, giving init and fin reserved numbers */ 
</span>    <a href="../../src/include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1935"><span class='Ref_To_Local'>scan_status</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1935"><span class='Ref_To_Local'>scan_status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>            <a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1932"><span class='Ref_To_Local'>snumber</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1932"><span class='Ref_To_Local'>snumber</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Collect array of all arcs */ 
</span>    <a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN415"><span class='Ref_to_Member'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1935"><span class='Ref_To_Local'>scan_status</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1935"><span class='Ref_To_Local'>scan_status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1973"></a>        <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>source</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
</span><a name="LN1974"></a>        <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1973"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>            <a href="trgm_regexp.c.html#LN1973"><span class='Ref_To_Local'>source</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1973"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1974"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1936"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN335"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1981"></a>            <a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1974"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1982"></a>            <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>target</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1981"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN350"><span class='Ref_to_Member'>target</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1982"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>                <a href="trgm_regexp.c.html#LN1982"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1982"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN339"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1973"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a> <span class='Operator'>!= </span><a href="trgm_regexp.c.html#LN1982"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1989"></a>                <a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ctrgm</span><span class='Delimiter'>; 
</span> 
                <a href="trgm_regexp.c.html#LN1989"><span class='Ref_To_Local'>ctrgm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>bsearch<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN1981"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Delimiter'>, 
</span>                                                  <a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN419"><span class='Ref_to_Member'>colorTrgms</span></a><span class='Delimiter'>, 
</span>                                                  <a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>, 
</span>                                                  <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN373"><span class='Ref_to_Typedef'>ColorTrgmInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                  <a href="trgm_regexp.c.html#LN499"><span class='Ref_to_Proto'>colorTrgmInfoCmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1989"><span class='Ref_To_Local'>ctrgm</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1989"><span class='Ref_To_Local'>ctrgm</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN472"><span class='Ref_to_Member'>sourceState</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1973"><span class='Ref_To_Local'>source</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN473"><span class='Ref_to_Member'>targetState</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1982"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN474"><span class='Ref_to_Member'>colorTrgm</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1989"><span class='Ref_To_Local'>ctrgm</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN376"><span class='Ref_to_Member'>cnumber</span></a><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (state=(TrgmState*)ha... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Sort arcs to ease duplicate detection */ 
</span>    <a href="../../src/include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN502"><span class='Ref_to_Proto'>packArcInfoCmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We could have duplicates because states were merged. Remove them. */ 
</span>    <span class='Comment_Multi_Line'>/* p1 is probe point, p2 is last known non-duplicate. */ 
</span>    <a href="trgm_regexp.c.html#LN1939"><span class='Ref_To_Local'>p2</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1938"><span class='Ref_To_Local'>p1</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1938"><span class='Ref_To_Local'>p1</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a> <span class='Operator'>+ </span><a href="trgm_regexp.c.html#LN1933"><span class='Ref_To_Local'>arcIndex</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1938"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN502"><span class='Ref_to_Proto'>packArcInfoCmp</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1938"><span class='Ref_To_Local'>p1</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1939"><span class='Ref_To_Local'>p2</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="trgm_regexp.c.html#LN1939"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="trgm_regexp.c.html#LN1939"><span class='Ref_To_Local'>p2</span></a> <span class='Operator'>= *</span><a href="trgm_regexp.c.html#LN1938"><span class='Ref_To_Local'>p1</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="trgm_regexp.c.html#LN1934"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1939"><span class='Ref_To_Local'>p2</span></a> <span class='Operator'>- </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create packed representation */ 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pack color trigrams information */ 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN419"><span class='Ref_to_Member'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a><span class='Parentheses'>) 
</span>            <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN452"><span class='Ref_to_Member'>colorTrigramGroups</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN420"><span class='Ref_to_Member'>colorTrgmsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN419"><span class='Ref_to_Member'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN379"><span class='Ref_to_Member'>expanded</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN452"><span class='Ref_to_Member'>colorTrigramGroups</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN419"><span class='Ref_to_Member'>colorTrgms</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN377"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Pack states and arcs information */ 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN458"><span class='Ref_to_Member'>statesCount</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1932"><span class='Ref_To_Local'>snumber</span></a><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN459"><span class='Ref_to_Member'>states</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN433"><span class='Ref_to_Typedef'>TrgmPackedState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1932"><span class='Ref_To_Local'>snumber</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN433"><span class='Ref_to_Typedef'>TrgmPackedState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1940"><span class='Ref_To_Local'>packedArcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN427"><span class='Ref_to_Typedef'>TrgmPackedArc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN1934"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN427"><span class='Ref_to_Typedef'>TrgmPackedArc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1932"><span class='Ref_To_Local'>snumber</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2055"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>cnt</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN459"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN436"><span class='Ref_to_Member'>arcs</span></a> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN1940"><span class='Ref_To_Local'>packedArcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN1934"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>&& </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN472"><span class='Ref_to_Member'>sourceState</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="trgm_regexp.c.html#LN1940"><span class='Ref_To_Local'>packedArcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN429"><span class='Ref_to_Member'>targetState</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN473"><span class='Ref_to_Member'>targetState</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1940"><span class='Ref_To_Local'>packedArcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN430"><span class='Ref_to_Member'>colorTrgm</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN1937"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN474"><span class='Ref_to_Member'>colorTrgm</span></a><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN2055"><span class='Ref_To_Local'>cnt</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN1943"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN459"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN1942"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN435"><span class='Ref_to_Member'>arcsCount</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN2055"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate working memory for trigramsMatchGraph() */ 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN462"><span class='Ref_to_Member'>colorTrigramsActive</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN463"><span class='Ref_to_Member'>statesActive</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN458"><span class='Ref_to_Member'>statesCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN464"><span class='Ref_to_Member'>statesQueue</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN1930"><span class='Ref_to_Parameter'>rcontext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN458"><span class='Ref_to_Member'>statesCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="trgm_regexp.c.html#LN1941"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end packGraph &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Comparison function for sorting TrgmPackArcInfos. 
 * 
 * Compares arcs in following order: sourceState, colorTrgm, targetState. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2085"></a><span class='Declare_Function'>packArcInfoCmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2087"></a>    <span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p1</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN2085"><span class='Ref_to_Parameter'>a1</span></a><span class='Delimiter'>; 
</span><a name="LN2088"></a>    <span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p2</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="trgm_regexp.c.html#LN470"><span class='Ref_to_Typedef'>TrgmPackArcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN2085"><span class='Ref_to_Parameter'>a2</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2087"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN472"><span class='Ref_to_Member'>sourceState</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2088"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN472"><span class='Ref_to_Member'>sourceState</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2087"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN472"><span class='Ref_to_Member'>sourceState</span></a> <span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN2088"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN472"><span class='Ref_to_Member'>sourceState</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2087"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN474"><span class='Ref_to_Member'>colorTrgm</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2088"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN474"><span class='Ref_to_Member'>colorTrgm</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2087"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN474"><span class='Ref_to_Member'>colorTrgm</span></a> <span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN2088"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN474"><span class='Ref_to_Member'>colorTrgm</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2087"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN473"><span class='Ref_to_Member'>targetState</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2088"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN473"><span class='Ref_to_Member'>targetState</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2087"><span class='Ref_To_Local'>p1</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN473"><span class='Ref_to_Member'>targetState</span></a> <span class='Operator'>&GT; </span><a href="trgm_regexp.c.html#LN2088"><span class='Ref_To_Local'>p2</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN473"><span class='Ref_to_Member'>targetState</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end packArcInfoCmp &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*--------------------- 
 * Debugging functions 
 * 
 * These are designed to emit GraphViz files. 
 *--------------------- 
 */ 
</span> 
<span class='Directive'>#ifdef</span> TRGM_REGEXP_DEBUG 
 
<span class='Comment_Multi_Line'>/* 
 * Print initial NFA, in regexp library's representation 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2119"></a><span class='Declare_Function'>printSourceNFA</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>regex</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colors</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ncolors</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2121"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2122"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nstates</span> <span class='Operator'>= </span><a href="../../src/backend/regex/regexport.c.html#LN34"><span class='Ref_to_Func'>pg_reg_getnumstates</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>regex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2123"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN2124"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\ndigraph sourceNFA {\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2122"><span class='Ref_To_Local'>nstates</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2132"></a>        <a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arcs</span><span class='Delimiter'>; 
</span><a name="LN2133"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN2134"></a>                    <span class='Declare_Local'>arcsCount</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"s%d"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN43"><span class='Ref_to_Proto'>pg_reg_getfinalstate</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>regex</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" [shape = doublecircle]"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>";\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="trgm_regexp.c.html#LN2134"><span class='Ref_To_Local'>arcsCount</span></a> <span class='Operator'>= </span><a href="../../src/include/regex/regexport.h.html#LN44"><span class='Ref_to_Proto'>pg_reg_getnumoutarcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="trgm_regexp.c.html#LN2132"><span class='Ref_To_Local'>arcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../src/include/regex/regexport.h.html#LN33"><span class='Ref_to_Typedef'>regex_arc_t</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="trgm_regexp.c.html#LN2134"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/regex/regexport.h.html#LN45"><span class='Ref_to_Proto'>pg_reg_getoutarcs</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>regex</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2132"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2134"><span class='Ref_To_Local'>arcsCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2133"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2133"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2134"><span class='Ref_To_Local'>arcsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2133"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  s%d -&GT; s%d [label = \"%d\"];\n"</span><span class='Delimiter'>, 
</span>                             <a href="trgm_regexp.c.html#LN2123"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2132"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2133"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/regex/regexport.h.html#LN36"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2132"><span class='Ref_To_Local'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2133"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../src/include/regex/regexport.h.html#LN35"><span class='Ref_to_Member'>co</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2132"><span class='Ref_To_Local'>arcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for state=0;state&LT;nstates... &raquo; </span> 
 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" node [shape = point ]; initial;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" initial -&GT; s%d;\n"</span><span class='Delimiter'>, 
</span>                     <a href="../../src/include/regex/regexport.h.html#LN42"><span class='Ref_to_Proto'>pg_reg_getinitialstate</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>regex</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Print colors */ 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" { rank = sink;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  Colors [shape = none, margin=0, label=&LT;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2124"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2124"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>ncolors</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2124"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2164"></a>        <a href="trgm_regexp.c.html#LN259"><span class='Ref_to_Typedef'>TrgmColorInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>color</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN2119"><span class='Ref_to_Parameter'>colors</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2124"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2165"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;br/&GT;Color %d: "</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2124"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2164"><span class='Ref_To_Local'>color</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN261"><span class='Ref_to_Member'>expandable</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2165"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2165"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2164"><span class='Ref_To_Local'>color</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN263"><span class='Ref_to_Member'>wordCharsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2165"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2172"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>s</span><span class='Delimiter'>[</span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2172"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2164"><span class='Ref_To_Local'>color</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN264"><span class='Ref_to_Member'>wordChars</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2165"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN243"><span class='Ref_to_Member'>bytes</span></a><span class='Delimiter'>, </span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="trgm_regexp.c.html#LN2172"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>[</span><a href="../../src/include/mb/pg_wchar.h.html#LN29"><span class='Ref_to_Const'>MAX_MULTIBYTE_CHAR_LEN</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>                <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2172"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"not expandable"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ncolors;i++ &raquo; </span> 
 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  &GT;];\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" }\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"}\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* dot -Tpng -o /tmp/source.png &LT; /tmp/source.dot */ 
</span><a name="LN2190"></a>        FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span> <span class='Operator'>= </span><a href="../../src/include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><span class='String'>"/tmp/source.dot"</span><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2190"><span class='Ref_To_Local'>fp</span></a><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fclose<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2190"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2121"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end printSourceNFA &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Print expanded graph. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2203"></a><span class='Declare_Function'>printTrgmNFA</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN400"><span class='Ref_to_Typedef'>TrgmNFA</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trgmNFA</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2205"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2206"></a>    <a href="../../src/include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>scan_status</span><span class='Delimiter'>; 
</span><a name="LN2207"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN2208"></a>    <a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>initstate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\ndigraph transformedNFA {\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2206"><span class='Ref_To_Local'>scan_status</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2203"><span class='Ref_to_Parameter'>trgmNFA</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN408"><span class='Ref_to_Member'>states</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN332"><span class='Ref_to_Struct'>TrgmState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2206"><span class='Ref_To_Local'>scan_status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2217"></a>        <a href="../../src/include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"s%d"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN330"><span class='Ref_to_Const'>TSTATE_FIN</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" [shape = doublecircle]"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN337"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="trgm_regexp.c.html#LN329"><span class='Ref_to_Const'>TSTATE_INIT</span></a><span class='Parentheses'>) 
</span>            <a href="trgm_regexp.c.html#LN2208"><span class='Ref_To_Local'>initstate</span></a> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" [label = \"%d\"]"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN334"><span class='Ref_to_Member'>stateKey</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN311"><span class='Ref_to_Member'>nstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>";\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2217"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN335"><span class='Ref_to_Member'>arcs</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2229"></a>            <a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN347"><span class='Ref_to_Typedef'>TrgmArc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2217"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  s%d -&GT; s%d [label = \""</span><span class='Delimiter'>, 
</span>                             <span class='Operator'>-</span><a href="trgm_regexp.c.html#LN2207"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><a href="trgm_regexp.c.html#LN2229"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN350"><span class='Ref_to_Member'>target</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN507"><span class='Ref_to_Proto'>printTrgmColor</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2229"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>' '</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN507"><span class='Ref_to_Proto'>printTrgmColor</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2229"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>' '</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN507"><span class='Ref_to_Proto'>printTrgmColor</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2229"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN349"><span class='Ref_to_Member'>ctrgm</span></a><span class='Operator'>.</span><a href="trgm_regexp.c.html#LN300"><span class='Ref_to_Member'>colors</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\"];\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (state=(TrgmState*)ha... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2208"><span class='Ref_To_Local'>initstate</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" node [shape = point ]; initial;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" initial -&GT; s%d;\n"</span><span class='Delimiter'>, </span><span class='Operator'>-</span><a href="trgm_regexp.c.html#LN2208"><span class='Ref_To_Local'>initstate</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN338"><span class='Ref_to_Member'>snumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"}\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* dot -Tpng -o /tmp/transformed.png &LT; /tmp/transformed.dot */ 
</span><a name="LN2252"></a>        FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span> <span class='Operator'>= </span><a href="../../src/include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><span class='String'>"/tmp/transformed.dot"</span><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2252"><span class='Ref_To_Local'>fp</span></a><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fclose<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2252"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2205"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end printTrgmNFA &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Print a TrgmColor readably. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2265"></a><span class='Declare_Function'>printTrgmColor</span><span class='Parentheses'>(</span><a href="../../src/include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN283"><span class='Ref_to_Typedef'>TrgmColor</span></a> <span class='Declare_Parameter'>co</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2265"><span class='Ref_to_Parameter'>co</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN286"><span class='Ref_to_Const'>COLOR_UNKNOWN</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2265"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'u'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2265"><span class='Ref_to_Parameter'>co</span></a> <span class='Operator'>== </span><a href="trgm_regexp.c.html#LN287"><span class='Ref_to_Const'>COLOR_BLANK</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/backend/replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2265"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'b'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2265"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="trgm_regexp.c.html#LN2265"><span class='Ref_to_Parameter'>co</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Print final packed representation of trigram-based expanded graph. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2279"></a><span class='Declare_Function'>printTrgmPackedGraph</span><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN440"><span class='Ref_to_Struct'>TrgmPackedGraph</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>packedGraph</span><span class='Delimiter'>, </span><a href="trgm.h.html#LN62"><span class='Ref_to_Typedef'>TRGM</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigrams</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2281"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2282"></a>    <a href="trgm.h.html#LN37"><span class='Ref_to_Typedef'>trgm</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN2283"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\ndigraph packedGraph {\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2279"><span class='Ref_to_Parameter'>packedGraph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN458"><span class='Ref_to_Member'>statesCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2291"></a>        <a href="trgm_regexp.c.html#LN433"><span class='Ref_to_Typedef'>TrgmPackedState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN2279"><span class='Ref_to_Parameter'>packedGraph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN459"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2292"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" s%d"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" [shape = doublecircle]"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" [label = &LT;s%d&GT;];\n"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2292"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2292"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2291"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN435"><span class='Ref_to_Member'>arcsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2292"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2302"></a>            <a href="trgm_regexp.c.html#LN427"><span class='Ref_to_Typedef'>TrgmPackedArc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arc</span> <span class='Operator'>= &</span><a href="trgm_regexp.c.html#LN2291"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN436"><span class='Ref_to_Member'>arcs</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2292"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span> 
            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  s%d -&GT; s%d [label = \"trigram %d\"];\n"</span><span class='Delimiter'>, 
</span>                             <a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2302"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN429"><span class='Ref_to_Member'>targetState</span></a><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2302"><span class='Ref_To_Local'>arc</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN430"><span class='Ref_to_Member'>colorTrgm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" node [shape = point ]; initial;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" initial -&GT; s%d;\n"</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Print trigrams */ 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" { rank = sink;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  Trigrams [shape = none, margin=0, label=&LT;\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="trgm_regexp.c.html#LN2282"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/adt/tsgistidx.c.html#LN69"><span class='Ref_to_Macro'>GETARR</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2279"><span class='Ref_to_Parameter'>trigrams</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2279"><span class='Ref_to_Parameter'>packedGraph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN451"><span class='Ref_to_Member'>colorTrigramsCount</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2319"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= </span><a href="trgm_regexp.c.html#LN2279"><span class='Ref_to_Parameter'>packedGraph</span></a><span class='Operator'>-&GT;</span><a href="trgm_regexp.c.html#LN452"><span class='Ref_to_Member'>colorTrigramGroups</span></a><span class='Delimiter'>[</span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2320"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;br/&GT;Trigram %d: "</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2283"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2320"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2320"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="trgm_regexp.c.html#LN2319"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; </span><a href="trgm_regexp.c.html#LN2320"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2320"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * XXX This representation is nice only for all-ASCII trigrams. 
             */ 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\"%c%c%c\""</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="trgm_regexp.c.html#LN2282"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="trgm_regexp.c.html#LN2282"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="trgm_regexp.c.html#LN2282"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="trgm_regexp.c.html#LN2282"><span class='Ref_To_Local'>p</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  &GT;];\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" }\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"}\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* dot -Tpng -o /tmp/packed.png &LT; /tmp/packed.dot */ 
</span><a name="LN2343"></a>        FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span> <span class='Operator'>= </span><a href="../../src/include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><span class='String'>"/tmp/packed.dot"</span><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2343"><span class='Ref_To_Local'>fp</span></a><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        fclose<span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2343"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="trgm_regexp.c.html#LN2281"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end printTrgmPackedGraph &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* TRGM_REGEXP_DEBUG */ 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>