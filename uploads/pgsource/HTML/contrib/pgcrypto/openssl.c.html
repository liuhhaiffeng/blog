<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\pgcrypto\openssl.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\pgcrypto\openssl.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:26 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/* 
 * openssl.c 
 *      Wrapper for OpenSSL library. 
 * 
 * Copyright (c) 2001 Marko Kreen 
 * All rights reserved. 
 * 
 * Redistribution and use in source and binary forms, with or without 
 * modification, are permitted provided that the following conditions 
 * are met: 
 * 1. Redistributions of source code must retain the above copyright 
 *    notice, this list of conditions and the following disclaimer. 
 * 2. Redistributions in binary form must reproduce the above copyright 
 *    notice, this list of conditions and the following disclaimer in the 
 *    documentation and/or other materials provided with the distribution. 
 * 
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND 
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
 * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE 
 * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
 * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS 
 * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) 
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT 
 * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY 
 * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF 
 * SUCH DAMAGE. 
 * 
 * contrib/pgcrypto/openssl.c 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"px.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/evp.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/err.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/rand.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Max lengths we might want to handle. 
 */ 
</span><a name="LN45"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_KEY</span>     <span class='Parentheses'>(</span><span class='Number'>512</span><span class='Operator'>/</span><span class='Number'>8</span><span class='Parentheses'>) 
</span><a name="LN46"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_IV</span>      <span class='Parentheses'>(</span><span class='Number'>128</span><span class='Operator'>/</span><span class='Number'>8</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Hashes 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * To make sure we don't leak OpenSSL handles on abort, we keep OSSLDigest 
 * objects in a linked list, allocated in TopMemoryContext. We use the 
 * ResourceOwner mechanism to free them on abort. 
 */ 
</span><a name="LN57"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>OSSLDigest</span> 
<span class='Delimiter'>{ 
</span><a name="LN59"></a>    <span class='Keyword'>const </span>EVP_MD <span class='Operator'>*</span><span class='Declare_Member'>algo</span><span class='Delimiter'>; 
</span><a name="LN60"></a>    EVP_MD_CTX <span class='Operator'>*</span><span class='Declare_Member'>ctx</span><span class='Delimiter'>; 
</span> 
<a name="LN62"></a>    <a href="../../src/include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Member'>owner</span><span class='Delimiter'>; 
</span><a name="LN63"></a>    <span class='Control'>struct</span> <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span><a name="LN64"></a>    <span class='Control'>struct</span> <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Member'>prev</span><span class='Delimiter'>; 
</span><a name="LN65"></a>} <span class='Declare_Typedef'>OSSLDigest</span><span class='Delimiter'>; 
</span> 
<a name="LN67"></a><span class='Keyword'>static </span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Var'>open_digests</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>digest_resowner_callback_registered</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN71"></a><span class='Declare_Function'>free_openssl_digest</span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>digest</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    EVP_MD_CTX_destroy<span class='Parentheses'>(</span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN64"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN64"><span class='Ref_to_Member'>prev</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="openssl.c.html#LN67"><span class='Ref_to_Global_Var'>open_digests</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN64"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN64"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>; 
</span>    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN71"><span class='Ref_to_Parameter'>digest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Close any open OpenSSL handles on abort. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN87"></a><span class='Declare_Function'>digest_free_callback</span><span class='Parentheses'>(</span><a href="../../src/include/utils/resowner.h.html#LN44"><span class='Ref_to_Typedef'>ResourceReleasePhase</span></a> <span class='Declare_Parameter'>phase</span><span class='Delimiter'>, 
</span><a name="LN88"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, 
</span><a name="LN89"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, 
</span><a name="LN90"></a>                     <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN92"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>curr</span><span class='Delimiter'>; 
</span><a name="LN93"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN87"><span class='Ref_to_Parameter'>phase</span></a> <span class='Operator'>!= </span><a href="../../src/include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN93"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN67"><span class='Ref_to_Global_Var'>open_digests</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN93"><span class='Ref_To_Local'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="openssl.c.html#LN92"><span class='Ref_To_Local'>curr</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN93"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>        <a href="openssl.c.html#LN93"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN92"><span class='Ref_To_Local'>curr</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN92"><span class='Ref_To_Local'>curr</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN62"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="../../src/backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN88"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>                <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"pgcrypto digest reference leak: digest %p still referenced"</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN92"><span class='Ref_To_Local'>curr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="openssl.c.html#LN70"><span class='Ref_to_Func'>free_openssl_digest</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN92"><span class='Ref_To_Local'>curr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end digest_free_callback &raquo; </span> 
 
<span class='Keyword'>static unsigned 
</span><a name="LN114"></a><span class='Declare_Function'>digest_result_size</span><span class='Parentheses'>(</span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN116"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN114"><span class='Ref_to_Parameter'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> EVP_MD_CTX_size<span class='Parentheses'>(</span><a href="openssl.c.html#LN116"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static unsigned 
</span><a name="LN122"></a><span class='Declare_Function'>digest_block_size</span><span class='Parentheses'>(</span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN124"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN122"><span class='Ref_to_Parameter'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> EVP_MD_CTX_block_size<span class='Parentheses'>(</span><a href="openssl.c.html#LN124"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN130"></a><span class='Declare_Function'>digest_reset</span><span class='Parentheses'>(</span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN132"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN130"><span class='Ref_to_Parameter'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    EVP_DigestInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN132"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN132"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN59"><span class='Ref_to_Member'>algo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN138"></a><span class='Declare_Function'>digest_update</span><span class='Parentheses'>(</span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>dlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN140"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN138"><span class='Ref_to_Parameter'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    EVP_DigestUpdate<span class='Parentheses'>(</span><a href="openssl.c.html#LN140"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN138"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN138"><span class='Ref_to_Parameter'>dlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN146"></a><span class='Declare_Function'>digest_finish</span><span class='Parentheses'>(</span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dst</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN148"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN146"><span class='Ref_to_Parameter'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    EVP_DigestFinal_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN148"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN146"><span class='Ref_to_Parameter'>dst</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN154"></a><span class='Declare_Function'>digest_free</span><span class='Parentheses'>(</span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN156"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN154"><span class='Ref_to_Parameter'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN70"><span class='Ref_to_Func'>free_openssl_digest</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN156"><span class='Ref_To_Local'>digest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="px.h.html#LN45"><span class='Ref_to_Macro'>px_free</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN154"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN162"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>px_openssl_initialized</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* PUBLIC functions */ 
</span> 
<span class='Keyword'>int 
</span><a name="LN167"></a><span class='Declare_Function'>px_find_digest</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN169"></a>    <span class='Keyword'>const </span>EVP_MD <span class='Operator'>*</span><span class='Declare_Local'>md</span><span class='Delimiter'>; 
</span><a name="LN170"></a>    EVP_MD_CTX <span class='Operator'>*</span><span class='Declare_Local'>ctx</span><span class='Delimiter'>; 
</span><a name="LN171"></a>    <a href="px.h.html#LN106"><span class='Ref_to_Typedef'>PX_MD</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>h</span><span class='Delimiter'>; 
</span><a name="LN172"></a>    <a href="openssl.c.html#LN57"><span class='Ref_to_Struct'>OSSLDigest</span></a> <span class='Operator'>*</span><span class='Declare_Local'>digest</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN162"><span class='Ref_to_Global_Var'>px_openssl_initialized</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="openssl.c.html#LN162"><span class='Ref_to_Global_Var'>px_openssl_initialized</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        OpenSSL_add_all_algorithms<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN68"><span class='Ref_to_Global_Var'>digest_resowner_callback_registered</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/utils/resowner.h.html#LN76"><span class='Ref_to_Proto'>RegisterResourceReleaseCallback</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN86"><span class='Ref_to_Func'>digest_free_callback</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="openssl.c.html#LN68"><span class='Ref_to_Global_Var'>digest_resowner_callback_registered</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="openssl.c.html#LN169"><span class='Ref_To_Local'>md</span></a> <span class='Operator'>= </span>EVP_get_digestbyname<span class='Parentheses'>(</span><a href="openssl.c.html#LN167"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN169"><span class='Ref_To_Local'>md</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="px.h.html#LN63"><span class='Ref_to_Const'>PXE_NO_HASH</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create an OSSLDigest object, an OpenSSL MD object, and a PX_MD object. 
     * The order is crucial, to make sure we don't leak anything on 
     * out-of-memory or other error. 
     */ 
</span>    <a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN170"><span class='Ref_To_Local'>ctx</span></a> <span class='Operator'>= </span>EVP_MD_CTX_create<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN170"><span class='Ref_To_Local'>ctx</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>EVP_DigestInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN170"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN169"><span class='Ref_To_Local'>md</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN59"><span class='Ref_to_Member'>algo</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN169"><span class='Ref_To_Local'>md</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN60"><span class='Ref_to_Member'>ctx</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN170"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN62"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN63"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN67"><span class='Ref_to_Global_Var'>open_digests</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN64"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN67"><span class='Ref_to_Global_Var'>open_digests</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The PX_MD object is allocated in the current memory context. */ 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>= </span><a href="px.h.html#LN43"><span class='Ref_to_Macro'>px_alloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN114"><span class='Ref_to_Member'>result_size</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN113"><span class='Ref_to_Func'>digest_result_size</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN115"><span class='Ref_to_Member'>block_size</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN121"><span class='Ref_to_Func'>digest_block_size</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN116"><span class='Ref_to_Member'>reset</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN129"><span class='Ref_to_Func'>digest_reset</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN117"><span class='Ref_to_Member'>update</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN137"><span class='Ref_to_Func'>digest_update</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN118"><span class='Ref_to_Member'>finish</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN145"><span class='Ref_to_Func'>digest_finish</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN119"><span class='Ref_to_Member'>free</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN153"><span class='Ref_to_Func'>digest_free</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN125"><span class='Ref_to_Member'>p</span></a><span class='Operator'>.</span><a href="px.h.html#LN124"><span class='Ref_to_Member'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN172"><span class='Ref_To_Local'>digest</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="openssl.c.html#LN167"><span class='Ref_to_Parameter'>res</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN171"><span class='Ref_To_Local'>h</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end px_find_digest &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Ciphers 
 * 
 * We use OpenSSL's EVP* family of functions for these. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * prototype for the EVP functions that return an algorithm, e.g. 
 * EVP_aes_128_cbc(). 
 */ 
</span><a name="LN240"></a><span class='Control'>typedef</span> <span class='Keyword'>const </span>EVP_CIPHER <span class='Operator'>*</span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Typedef'>ossl_EVP_cipher_func</span><span class='Parentheses'>) (</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ossl_cipher contains the static information about each cipher. 
 */ 
</span><a name="LN245"></a><span class='Control'>struct</span> <span class='Declare_Struct'>ossl_cipher</span> 
<span class='Delimiter'>{ 
</span><a name="LN247"></a>    <span class='Keyword'>int</span>         <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Member'>init</span><span class='Parentheses'>) (</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><a href="../../src/interfaces/ecpg/test/expected/preproc-cursor.c.html#LN30"><span class='Ref_to_Typedef'>c</span></a><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span>key<span class='Delimiter'>, </span><span class='Keyword'>unsigned </span>klen<span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span>iv<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN248"></a>    <a href="openssl.c.html#LN240"><span class='Ref_to_Typedef'>ossl_EVP_cipher_func</span></a> <span class='Declare_Member'>cipher_func</span><span class='Delimiter'>; 
</span><a name="LN249"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>block_size</span><span class='Delimiter'>; 
</span><a name="LN250"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>max_key_size</span><span class='Delimiter'>; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * OSSLCipher contains the state for using a cipher. A separate OSSLCipher 
 * object is allocated in each px_find_cipher() call. 
 * 
 * To make sure we don't leak OpenSSL handles on abort, we keep OSSLCipher 
 * objects in a linked list, allocated in TopMemoryContext. We use the 
 * ResourceOwner mechanism to free them on abort. 
 */ 
</span><a name="LN261"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>OSSLCipher</span> 
<span class='Delimiter'>{ 
</span><a name="LN263"></a>    EVP_CIPHER_CTX <span class='Operator'>*</span><span class='Declare_Member'>evp_ctx</span><span class='Delimiter'>; 
</span><a name="LN264"></a>    <span class='Keyword'>const </span>EVP_CIPHER <span class='Operator'>*</span><span class='Declare_Member'>evp_ciph</span><span class='Delimiter'>; 
</span><a name="LN265"></a>    <a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>key</span><span class='Delimiter'>[</span><a href="openssl.c.html#LN45"><span class='Ref_to_Const'>MAX_KEY</span></a><span class='Delimiter'>]; 
</span><a name="LN266"></a>    <a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>iv</span><span class='Delimiter'>[</span><a href="openssl.c.html#LN46"><span class='Ref_to_Const'>MAX_IV</span></a><span class='Delimiter'>]; 
</span><a name="LN267"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Member'>klen</span><span class='Delimiter'>; 
</span><a name="LN268"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Member'>init</span><span class='Delimiter'>; 
</span><a name="LN269"></a>    <span class='Keyword'>const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Operator'>*</span><span class='Declare_Member'>ciph</span><span class='Delimiter'>; 
</span> 
<a name="LN271"></a>    <a href="../../src/include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Member'>owner</span><span class='Delimiter'>; 
</span><a name="LN272"></a>    <span class='Control'>struct</span> <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span><a name="LN273"></a>    <span class='Control'>struct</span> <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Member'>prev</span><span class='Delimiter'>; 
</span><a name="LN274"></a>} <span class='Declare_Typedef'>OSSLCipher</span><span class='Delimiter'>; 
</span> 
<a name="LN276"></a><span class='Keyword'>static </span><a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Var'>open_ciphers</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN277"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>cipher_resowner_callback_registered</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN280"></a><span class='Declare_Function'>free_openssl_cipher</span><span class='Parentheses'>(</span><a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>od</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    EVP_CIPHER_CTX_free<span class='Parentheses'>(</span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN273"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN273"><span class='Ref_to_Member'>prev</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="openssl.c.html#LN276"><span class='Ref_to_Global_Var'>open_ciphers</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN273"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN273"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>; 
</span>    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN280"><span class='Ref_to_Parameter'>od</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Close any open OpenSSL cipher handles on abort. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN296"></a><span class='Declare_Function'>cipher_free_callback</span><span class='Parentheses'>(</span><a href="../../src/include/utils/resowner.h.html#LN44"><span class='Ref_to_Typedef'>ResourceReleasePhase</span></a> <span class='Declare_Parameter'>phase</span><span class='Delimiter'>, 
</span><a name="LN297"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, 
</span><a name="LN298"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, 
</span><a name="LN299"></a>                     <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN301"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>curr</span><span class='Delimiter'>; 
</span><a name="LN302"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN296"><span class='Ref_to_Parameter'>phase</span></a> <span class='Operator'>!= </span><a href="../../src/include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN302"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN276"><span class='Ref_to_Global_Var'>open_ciphers</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN302"><span class='Ref_To_Local'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="openssl.c.html#LN301"><span class='Ref_To_Local'>curr</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN302"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>        <a href="openssl.c.html#LN302"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN301"><span class='Ref_To_Local'>curr</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN301"><span class='Ref_To_Local'>curr</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN271"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="../../src/backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN297"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>                <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"pgcrypto cipher reference leak: cipher %p still referenced"</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN301"><span class='Ref_To_Local'>curr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="openssl.c.html#LN279"><span class='Ref_to_Func'>free_openssl_cipher</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN301"><span class='Ref_To_Local'>curr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end cipher_free_callback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Common routines for all algorithms */ 
</span> 
<span class='Keyword'>static unsigned 
</span><a name="LN325"></a><span class='Declare_Function'>gen_ossl_block_size</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN327"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN325"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="openssl.c.html#LN327"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN269"><span class='Ref_to_Member'>ciph</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN249"><span class='Ref_to_Member'>block_size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static unsigned 
</span><a name="LN333"></a><span class='Declare_Function'>gen_ossl_key_size</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN335"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN333"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="openssl.c.html#LN335"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN269"><span class='Ref_to_Member'>ciph</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN250"><span class='Ref_to_Member'>max_key_size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static unsigned 
</span><a name="LN341"></a><span class='Declare_Function'>gen_ossl_iv_size</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN343"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>ivlen</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN341"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN343"><span class='Ref_To_Local'>ivlen</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN344"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN269"><span class='Ref_to_Member'>ciph</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN249"><span class='Ref_to_Member'>block_size</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="openssl.c.html#LN343"><span class='Ref_To_Local'>ivlen</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN351"></a><span class='Declare_Function'>gen_ossl_free</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN353"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="openssl.c.html#LN351"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN279"><span class='Ref_to_Func'>free_openssl_cipher</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN353"><span class='Ref_To_Local'>od</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="px.h.html#LN45"><span class='Ref_to_Macro'>px_free</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN351"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN360"></a><span class='Declare_Function'>gen_ossl_decrypt</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>dlen</span><span class='Delimiter'>, 
</span><a name="LN361"></a>                 <a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN363"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN360"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN364"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>outlen</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN268"><span class='Ref_to_Member'>init</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_DecryptInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_CIPHER_CTX_set_key_length<span class='Parentheses'>(</span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_DecryptInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>        <a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN268"><span class='Ref_to_Member'>init</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_DecryptUpdate<span class='Parentheses'>(</span><a href="openssl.c.html#LN363"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN361"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN364"><span class='Ref_To_Local'>outlen</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN360"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN360"><span class='Ref_to_Parameter'>dlen</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="px.h.html#LN78"><span class='Ref_to_Const'>PXE_DECRYPT_FAILED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gen_ossl_decrypt &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN384"></a><span class='Declare_Function'>gen_ossl_encrypt</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>dlen</span><span class='Delimiter'>, 
</span><a name="LN385"></a>                 <a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN387"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN384"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN388"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>outlen</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN268"><span class='Ref_to_Member'>init</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_EncryptInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_CIPHER_CTX_set_key_length<span class='Parentheses'>(</span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_EncryptInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>        <a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN268"><span class='Ref_to_Member'>init</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_EncryptUpdate<span class='Parentheses'>(</span><a href="openssl.c.html#LN387"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN385"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN388"><span class='Ref_To_Local'>outlen</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN384"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN384"><span class='Ref_to_Parameter'>dlen</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="px.h.html#LN62"><span class='Ref_to_Const'>PXE_ERR_GENERIC</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gen_ossl_encrypt &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Blowfish */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Check if strong crypto is supported. Some openssl installations 
 * support only short keys and unfortunately BF_set_key does not return any 
 * error value. This function tests if is possible to use strong key. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN415"></a><span class='Declare_Function'>bf_check_supported_key_len</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN417"></a>    <span class='Keyword'>static const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>56</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Number'>0xf0</span><span class='Delimiter'>, </span><span class='Number'>0xe1</span><span class='Delimiter'>, </span><span class='Number'>0xd2</span><span class='Delimiter'>, </span><span class='Number'>0xc3</span><span class='Delimiter'>, </span><span class='Number'>0xb4</span><span class='Delimiter'>, </span><span class='Number'>0xa5</span><span class='Delimiter'>, </span><span class='Number'>0x96</span><span class='Delimiter'>, </span><span class='Number'>0x87</span><span class='Delimiter'>, </span><span class='Number'>0x78</span><span class='Delimiter'>, </span><span class='Number'>0x69</span><span class='Delimiter'>, 
</span>        <span class='Number'>0x5a</span><span class='Delimiter'>, </span><span class='Number'>0x4b</span><span class='Delimiter'>, </span><span class='Number'>0x3c</span><span class='Delimiter'>, </span><span class='Number'>0x2d</span><span class='Delimiter'>, </span><span class='Number'>0x1e</span><span class='Delimiter'>, </span><span class='Number'>0x0f</span><span class='Delimiter'>, </span><span class='Number'>0x00</span><span class='Delimiter'>, </span><span class='Number'>0x11</span><span class='Delimiter'>, </span><span class='Number'>0x22</span><span class='Delimiter'>, </span><span class='Number'>0x33</span><span class='Delimiter'>, 
</span>        <span class='Number'>0x44</span><span class='Delimiter'>, </span><span class='Number'>0x55</span><span class='Delimiter'>, </span><span class='Number'>0x66</span><span class='Delimiter'>, </span><span class='Number'>0x77</span><span class='Delimiter'>, </span><span class='Number'>0x04</span><span class='Delimiter'>, </span><span class='Number'>0x68</span><span class='Delimiter'>, </span><span class='Number'>0x91</span><span class='Delimiter'>, </span><span class='Number'>0x04</span><span class='Delimiter'>, </span><span class='Number'>0xc2</span><span class='Delimiter'>, </span><span class='Number'>0xfd</span><span class='Delimiter'>, 
</span>        <span class='Number'>0x3b</span><span class='Delimiter'>, </span><span class='Number'>0x2f</span><span class='Delimiter'>, </span><span class='Number'>0x58</span><span class='Delimiter'>, </span><span class='Number'>0x40</span><span class='Delimiter'>, </span><span class='Number'>0x23</span><span class='Delimiter'>, </span><span class='Number'>0x64</span><span class='Delimiter'>, </span><span class='Number'>0x1a</span><span class='Delimiter'>, </span><span class='Number'>0xba</span><span class='Delimiter'>, </span><span class='Number'>0x61</span><span class='Delimiter'>, </span><span class='Number'>0x76</span><span class='Delimiter'>, 
</span>        <span class='Number'>0x1f</span><span class='Delimiter'>, </span><span class='Number'>0x1f</span><span class='Delimiter'>, </span><span class='Number'>0x1f</span><span class='Delimiter'>, </span><span class='Number'>0x1f</span><span class='Delimiter'>, </span><span class='Number'>0x0e</span><span class='Delimiter'>, </span><span class='Number'>0x0e</span><span class='Delimiter'>, </span><span class='Number'>0x0e</span><span class='Delimiter'>, </span><span class='Number'>0x0e</span><span class='Delimiter'>, </span><span class='Number'>0xff</span><span class='Delimiter'>, </span><span class='Number'>0xff</span><span class='Delimiter'>, 
</span>        <span class='Number'>0xff</span><span class='Delimiter'>, </span><span class='Number'>0xff</span><span class='Delimiter'>, </span><span class='Number'>0xff</span><span class='Delimiter'>, </span><span class='Number'>0xff</span><span class='Delimiter'>, </span><span class='Number'>0xff</span><span class='Delimiter'>, </span><span class='Number'>0xff</span> 
    <span class='Delimiter'>}; 
</span> 
<a name="LN426"></a>    <span class='Keyword'>static const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>[</span><span class='Number'>8</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Number'>0xfe</span><span class='Delimiter'>, </span><span class='Number'>0xdc</span><span class='Delimiter'>, </span><span class='Number'>0xba</span><span class='Delimiter'>, </span><span class='Number'>0x98</span><span class='Delimiter'>, </span><span class='Number'>0x76</span><span class='Delimiter'>, </span><span class='Number'>0x54</span><span class='Delimiter'>, </span><span class='Number'>0x32</span><span class='Delimiter'>, </span><span class='Number'>0x10</span><span class='Delimiter'>}; 
</span><a name="LN427"></a>    <span class='Keyword'>static const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>[</span><span class='Number'>8</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Number'>0xc0</span><span class='Delimiter'>, </span><span class='Number'>0x45</span><span class='Delimiter'>, </span><span class='Number'>0x04</span><span class='Delimiter'>, </span><span class='Number'>0x01</span><span class='Delimiter'>, </span><span class='Number'>0x2e</span><span class='Delimiter'>, </span><span class='Number'>0x4e</span><span class='Delimiter'>, </span><span class='Number'>0x1f</span><span class='Delimiter'>, </span><span class='Number'>0x53</span><span class='Delimiter'>}; 
</span><a name="LN428"></a>    <a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>out</span><span class='Delimiter'>[</span><span class='Number'>8</span><span class='Delimiter'>]; 
</span><a name="LN429"></a>    EVP_CIPHER_CTX <span class='Operator'>*</span><span class='Declare_Local'>evp_ctx</span><span class='Delimiter'>; 
</span><a name="LN430"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>outlen</span><span class='Delimiter'>; 
</span><a name="LN431"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* encrypt with 448bits key and verify output */ 
</span>    <a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a> <span class='Operator'>= </span>EVP_CIPHER_CTX_new<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_EncryptInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a><span class='Delimiter'>, </span>EVP_bf_ecb<span class='Parentheses'>()</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="openssl.c.html#LN452"><span class='Ref_to_Label'>leave</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_CIPHER_CTX_set_key_length<span class='Parentheses'>(</span><a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a><span class='Delimiter'>, </span><span class='Number'>56</span><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="openssl.c.html#LN452"><span class='Ref_to_Label'>leave</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_EncryptInit_ex<span class='Parentheses'>(</span><a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN417"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="openssl.c.html#LN452"><span class='Ref_to_Label'>leave</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>EVP_EncryptUpdate<span class='Parentheses'>(</span><a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN428"><span class='Ref_To_Local'>out</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN430"><span class='Ref_To_Local'>outlen</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN426"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="openssl.c.html#LN452"><span class='Ref_to_Label'>leave</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><a href="openssl.c.html#LN428"><span class='Ref_To_Local'>out</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN427"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="openssl.c.html#LN452"><span class='Ref_to_Label'>leave</span></a><span class='Delimiter'>;</span>             <span class='Comment_Multi_Line'>/* Output does not match -&GT; strong cipher is 
                                 * not supported */ 
</span>    <a href="openssl.c.html#LN431"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<a name="LN452"></a><span class='Label'>leave</span><span class='Operator'>: 
</span>    EVP_CIPHER_CTX_free<span class='Parentheses'>(</span><a href="openssl.c.html#LN429"><span class='Ref_To_Local'>evp_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="openssl.c.html#LN431"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end bf_check_supported_key_len &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN458"></a><span class='Declare_Function'>bf_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN460"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN461"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>bs</span> <span class='Operator'>= </span><a href="openssl.c.html#LN324"><span class='Ref_to_Func'>gen_ossl_block_size</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN462"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>bf_is_strong</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Test if key len is supported. BF_set_key silently cut large keys and it 
     * could be a problem when user transfer crypted data from one server to 
     * another. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN462"><span class='Ref_To_Local'>bf_is_strong</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN462"><span class='Ref_To_Local'>bf_is_strong</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN414"><span class='Ref_to_Func'>bf_check_supported_key_len</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN462"><span class='Ref_To_Local'>bf_is_strong</span></a> <span class='Operator'>&& </span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>klen</span></a> <span class='Operator'>&GT; </span><span class='Number'>16</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="px.h.html#LN68"><span class='Ref_to_Const'>PXE_KEY_TOO_BIG</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Key len is supported. We can use it. */ 
</span>    <a href="openssl.c.html#LN460"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>klen</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN460"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>klen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN460"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN458"><span class='Ref_to_Parameter'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN461"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN460"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN461"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end bf_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* DES */ 
</span> 
<span class='Keyword'>static int 
</span><a name="LN490"></a><span class='Declare_Function'>ossl_des_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN492"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN493"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>bs</span> <span class='Operator'>= </span><a href="openssl.c.html#LN324"><span class='Ref_to_Func'>gen_ossl_block_size</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN492"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN492"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN492"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>klen</span></a> <span class='Operator'>&GT; </span><span class='Number'>8</span> <span class='Operator'>? </span><span class='Number'>8</span> <span class='Operator'>: </span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>klen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN492"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN490"><span class='Ref_to_Parameter'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN493"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN492"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN493"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* DES3 */ 
</span> 
<span class='Keyword'>static int 
</span><a name="LN509"></a><span class='Declare_Function'>ossl_des3_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN511"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN512"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>bs</span> <span class='Operator'>= </span><a href="openssl.c.html#LN324"><span class='Ref_to_Func'>gen_ossl_block_size</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN511"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><span class='Number'>24</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN511"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN511"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>klen</span></a> <span class='Operator'>&GT; </span><span class='Number'>24</span> <span class='Operator'>? </span><span class='Number'>24</span> <span class='Operator'>: </span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>klen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN511"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN509"><span class='Ref_to_Parameter'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN512"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN511"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN512"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* CAST5 */ 
</span> 
<span class='Keyword'>static int 
</span><a name="LN528"></a><span class='Declare_Function'>ossl_cast_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN530"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN531"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>bs</span> <span class='Operator'>= </span><a href="openssl.c.html#LN324"><span class='Ref_to_Func'>gen_ossl_block_size</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN530"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>klen</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN530"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>klen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN530"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN528"><span class='Ref_to_Parameter'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN531"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN530"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN531"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* AES */ 
</span> 
<span class='Keyword'>static int 
</span><a name="LN546"></a><span class='Declare_Function'>ossl_aes_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN548"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN549"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>bs</span> <span class='Operator'>= </span><a href="openssl.c.html#LN324"><span class='Ref_to_Func'>gen_ossl_block_size</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>klen</span></a> <span class='Operator'>&LT;= </span><span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN548"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>klen</span></a> <span class='Operator'>&LT;= </span><span class='Number'>192</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN548"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><span class='Number'>192</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>klen</span></a> <span class='Operator'>&LT;= </span><span class='Number'>256</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN548"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a> <span class='Operator'>= </span><span class='Number'>256</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="px.h.html#LN68"><span class='Ref_to_Const'>PXE_KEY_TOO_BIG</span></a><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN548"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN265"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>klen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="openssl.c.html#LN548"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN546"><span class='Ref_to_Parameter'>iv</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN549"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        memset<span class='Parentheses'>(</span><a href="openssl.c.html#LN548"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN266"><span class='Ref_to_Member'>iv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="openssl.c.html#LN549"><span class='Ref_To_Local'>bs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ossl_aes_init &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN571"></a><span class='Declare_Function'>ossl_aes_ecb_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN573"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN571"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN574"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN574"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN545"><span class='Ref_to_Func'>ossl_aes_init</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN571"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN571"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN571"><span class='Ref_to_Parameter'>klen</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN571"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN574"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="openssl.c.html#LN574"><span class='Ref_To_Local'>err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN573"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Operator'>: 
</span>            <a href="openssl.c.html#LN573"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span>EVP_aes_128_ecb<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Number'>192</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Operator'>: 
</span>            <a href="openssl.c.html#LN573"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span>EVP_aes_192_ecb<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Number'>256</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Operator'>: 
</span>            <a href="openssl.c.html#LN573"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span>EVP_aes_256_ecb<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>            <a href="openssl.c.html#LN574"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="openssl.c.html#LN574"><span class='Ref_To_Local'>err</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ossl_aes_ecb_init &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN601"></a><span class='Declare_Function'>ossl_aes_cbc_init</span><span class='Parentheses'>(</span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned </span><span class='Declare_Parameter'>klen</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../src/include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN603"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span> <span class='Operator'>= </span><a href="openssl.c.html#LN601"><span class='Ref_to_Parameter'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a><span class='Delimiter'>; 
</span><a name="LN604"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN604"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN545"><span class='Ref_to_Func'>ossl_aes_init</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN601"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN601"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN601"><span class='Ref_to_Parameter'>klen</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN601"><span class='Ref_to_Parameter'>iv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN604"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="openssl.c.html#LN604"><span class='Ref_To_Local'>err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN603"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN267"><span class='Ref_to_Member'>klen</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Operator'>: 
</span>            <a href="openssl.c.html#LN603"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span>EVP_aes_128_cbc<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Number'>192</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Operator'>: 
</span>            <a href="openssl.c.html#LN603"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span>EVP_aes_192_cbc<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Number'>256</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Operator'>: 
</span>            <a href="openssl.c.html#LN603"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span>EVP_aes_256_cbc<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>            <a href="openssl.c.html#LN604"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="openssl.c.html#LN604"><span class='Ref_To_Local'>err</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ossl_aes_cbc_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * aliases 
 */ 
</span> 
<a name="LN634"></a><span class='Keyword'>static </span><a href="px.h.html#LN107"><span class='Ref_to_Typedef'>PX_Alias</span></a> <span class='Declare_Var'>ossl_aliases</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Delimiter'>{</span><span class='String'>"bf"</span><span class='Delimiter'>, </span><span class='String'>"bf-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"blowfish"</span><span class='Delimiter'>, </span><span class='String'>"bf-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"blowfish-cbc"</span><span class='Delimiter'>, </span><span class='String'>"bf-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"blowfish-ecb"</span><span class='Delimiter'>, </span><span class='String'>"bf-ecb"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"blowfish-cfb"</span><span class='Delimiter'>, </span><span class='String'>"bf-cfb"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"des"</span><span class='Delimiter'>, </span><span class='String'>"des-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"3des"</span><span class='Delimiter'>, </span><span class='String'>"des3-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"3des-ecb"</span><span class='Delimiter'>, </span><span class='String'>"des3-ecb"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"3des-cbc"</span><span class='Delimiter'>, </span><span class='String'>"des3-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"cast5"</span><span class='Delimiter'>, </span><span class='String'>"cast5-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"aes"</span><span class='Delimiter'>, </span><span class='String'>"aes-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"rijndael"</span><span class='Delimiter'>, </span><span class='String'>"aes-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"rijndael-cbc"</span><span class='Delimiter'>, </span><span class='String'>"aes-cbc"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"rijndael-ecb"</span><span class='Delimiter'>, </span><span class='String'>"aes-ecb"</span><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>} 
}; 
</span> 
<a name="LN652"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_bf_cbc</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="internal.c.html#LN435"><span class='Ref_to_Func'>bf_init</span></a><span class='Delimiter'>, 
</span>    EVP_bf_cbc<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>448</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN658"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_bf_ecb</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="internal.c.html#LN435"><span class='Ref_to_Func'>bf_init</span></a><span class='Delimiter'>, 
</span>    EVP_bf_ecb<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>448</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN664"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_bf_cfb</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="internal.c.html#LN435"><span class='Ref_to_Func'>bf_init</span></a><span class='Delimiter'>, 
</span>    EVP_bf_cfb<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>448</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN670"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_des_ecb</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN489"><span class='Ref_to_Func'>ossl_des_init</span></a><span class='Delimiter'>, 
</span>    EVP_des_ecb<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN676"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_des_cbc</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN489"><span class='Ref_to_Func'>ossl_des_init</span></a><span class='Delimiter'>, 
</span>    EVP_des_cbc<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN682"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_des3_ecb</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN508"><span class='Ref_to_Func'>ossl_des3_init</span></a><span class='Delimiter'>, 
</span>    EVP_des_ede3_ecb<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>192</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN688"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_des3_cbc</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN508"><span class='Ref_to_Func'>ossl_des3_init</span></a><span class='Delimiter'>, 
</span>    EVP_des_ede3_cbc<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>192</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN694"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_cast_ecb</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN527"><span class='Ref_to_Func'>ossl_cast_init</span></a><span class='Delimiter'>, 
</span>    EVP_cast5_ecb<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN700"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_cast_cbc</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN527"><span class='Ref_to_Func'>ossl_cast_init</span></a><span class='Delimiter'>, 
</span>    EVP_cast5_cbc<span class='Delimiter'>, 
</span>    <span class='Number'>64</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN706"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_aes_ecb</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN570"><span class='Ref_to_Func'>ossl_aes_ecb_init</span></a><span class='Delimiter'>, 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>                       <span class='Comment_Multi_Line'>/* EVP_aes_XXX_ecb(), determined in init 
                                 * function */ 
</span>    <span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>256</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN713"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Declare_Var'>ossl_aes_cbc</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="openssl.c.html#LN600"><span class='Ref_to_Func'>ossl_aes_cbc_init</span></a><span class='Delimiter'>, 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>                       <span class='Comment_Multi_Line'>/* EVP_aes_XXX_cbc(), determined in init 
                                 * function */ 
</span>    <span class='Number'>128</span> <span class='Operator'>/ </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>256</span> <span class='Operator'>/ </span><span class='Number'>8</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Special handlers 
 */ 
</span><a name="LN723"></a><span class='Control'>struct</span> <span class='Declare_Struct'>ossl_cipher_lookup</span> 
<span class='Delimiter'>{ 
</span><a name="LN725"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Member'>name</span><span class='Delimiter'>; 
</span><a name="LN726"></a>    <span class='Keyword'>const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN245"><span class='Ref_to_Struct'>ossl_cipher</span></a> <span class='Operator'>*</span><span class='Declare_Member'>ciph</span><span class='Delimiter'>; 
}; 
</span> 
<a name="LN729"></a><span class='Keyword'>static const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN723"><span class='Ref_to_Struct'>ossl_cipher_lookup</span></a> <span class='Declare_Var'>ossl_cipher_types</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Delimiter'>{</span><span class='String'>"bf-cbc"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN652"><span class='Ref_to_Global_Var'>ossl_bf_cbc</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"bf-ecb"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN658"><span class='Ref_to_Global_Var'>ossl_bf_ecb</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"bf-cfb"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN664"><span class='Ref_to_Global_Var'>ossl_bf_cfb</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"des-ecb"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN670"><span class='Ref_to_Global_Var'>ossl_des_ecb</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"des-cbc"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN676"><span class='Ref_to_Global_Var'>ossl_des_cbc</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"des3-ecb"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN682"><span class='Ref_to_Global_Var'>ossl_des3_ecb</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"des3-cbc"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN688"><span class='Ref_to_Global_Var'>ossl_des3_cbc</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"cast5-ecb"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN694"><span class='Ref_to_Global_Var'>ossl_cast_ecb</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"cast5-cbc"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN700"><span class='Ref_to_Global_Var'>ossl_cast_cbc</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"aes-ecb"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN706"><span class='Ref_to_Global_Var'>ossl_aes_ecb</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='String'>"aes-cbc"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="openssl.c.html#LN713"><span class='Ref_to_Global_Var'>ossl_aes_cbc</span></a><span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>} 
}; 
</span> 
<span class='Comment_Multi_Line'>/* PUBLIC functions */ 
</span> 
<span class='Keyword'>int 
</span><a name="LN747"></a><span class='Declare_Function'>px_find_cipher</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN749"></a>    <span class='Keyword'>const </span><span class='Control'>struct</span> <a href="openssl.c.html#LN723"><span class='Ref_to_Struct'>ossl_cipher_lookup</span></a> <span class='Operator'>*</span><span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN750"></a>    <a href="px.h.html#LN109"><span class='Ref_to_Typedef'>PX_Cipher</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>c</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN751"></a>    EVP_CIPHER_CTX <span class='Operator'>*</span><span class='Declare_Local'>ctx</span><span class='Delimiter'>; 
</span><a name="LN752"></a>    <a href="openssl.c.html#LN261"><span class='Ref_to_Struct'>OSSLCipher</span></a> <span class='Operator'>*</span><span class='Declare_Local'>od</span><span class='Delimiter'>; 
</span> 
    <a href="openssl.c.html#LN747"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>= </span><a href="px.c.html#LN138"><span class='Ref_to_Func'>px_resolve_alias</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN634"><span class='Ref_to_Global_Var'>ossl_aliases</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN747"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN729"><span class='Ref_to_Global_Var'>ossl_cipher_types</span></a><span class='Delimiter'>; </span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN725"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>; </span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN725"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="openssl.c.html#LN747"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN725"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="px.h.html#LN64"><span class='Ref_to_Const'>PXE_NO_CIPHER</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN277"><span class='Ref_to_Global_Var'>cipher_resowner_callback_registered</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/utils/resowner.h.html#LN76"><span class='Ref_to_Proto'>RegisterResourceReleaseCallback</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN295"><span class='Ref_to_Func'>cipher_free_callback</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="openssl.c.html#LN277"><span class='Ref_to_Global_Var'>cipher_resowner_callback_registered</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create an OSSLCipher object, an EVP_CIPHER_CTX object and a PX_Cipher. 
     * The order is crucial, to make sure we don't leak anything on 
     * out-of-memory or other error. 
     */ 
</span>    <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN269"><span class='Ref_to_Member'>ciph</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN726"><span class='Ref_to_Member'>ciph</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate an EVP_CIPHER_CTX object. */ 
</span>    <a href="openssl.c.html#LN751"><span class='Ref_To_Local'>ctx</span></a> <span class='Operator'>= </span>EVP_CIPHER_CTX_new<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="openssl.c.html#LN751"><span class='Ref_To_Local'>ctx</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="px.h.html#LN69"><span class='Ref_to_Const'>PXE_CIPHER_INIT</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN263"><span class='Ref_to_Member'>evp_ctx</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN751"><span class='Ref_To_Local'>ctx</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN271"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="../../src/backend/utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN272"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN276"><span class='Ref_to_Global_Var'>open_ciphers</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN273"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN276"><span class='Ref_to_Global_Var'>open_ciphers</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN726"><span class='Ref_to_Member'>ciph</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN248"><span class='Ref_to_Member'>cipher_func</span></a><span class='Parentheses'>) 
</span>        <a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN264"><span class='Ref_to_Member'>evp_ciph</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN726"><span class='Ref_to_Member'>ciph</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN248"><span class='Ref_to_Member'>cipher_func</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The PX_Cipher is allocated in current memory context */ 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="px.h.html#LN43"><span class='Ref_to_Macro'>px_alloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN155"><span class='Ref_to_Member'>block_size</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN324"><span class='Ref_to_Func'>gen_ossl_block_size</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN156"><span class='Ref_to_Member'>key_size</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN332"><span class='Ref_to_Func'>gen_ossl_key_size</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN157"><span class='Ref_to_Member'>iv_size</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN340"><span class='Ref_to_Func'>gen_ossl_iv_size</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN162"><span class='Ref_to_Member'>free</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN350"><span class='Ref_to_Func'>gen_ossl_free</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN159"><span class='Ref_to_Member'>init</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN269"><span class='Ref_to_Member'>ciph</span></a><span class='Operator'>-&GT;</span><a href="openssl.c.html#LN247"><span class='Ref_to_Member'>init</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN160"><span class='Ref_to_Member'>encrypt</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN383"><span class='Ref_to_Func'>gen_ossl_encrypt</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN161"><span class='Ref_to_Member'>decrypt</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN359"><span class='Ref_to_Func'>gen_ossl_decrypt</span></a><span class='Delimiter'>; 
</span>    <a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Operator'>-&GT;</span><a href="px.h.html#LN164"><span class='Ref_to_Member'>ptr</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN752"><span class='Ref_To_Local'>od</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="openssl.c.html#LN747"><span class='Ref_to_Parameter'>res</span></a> <span class='Operator'>= </span><a href="openssl.c.html#LN750"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end px_find_cipher &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>