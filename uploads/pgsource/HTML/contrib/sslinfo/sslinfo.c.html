<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\sslinfo\sslinfo.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\sslinfo\sslinfo.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * module for PostgreSQL to access client SSL certificate information 
 * 
 * Written by Victor B. Wagner &LT;vitus@cryptocom.ru&GT;, Cryptocom LTD 
 * This file is distributed under BSD-style license. 
 * 
 * contrib/sslinfo/sslinfo.c 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/x509.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/x509v3.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/asn1.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq-be.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
 
<a href="../../src/include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<a name="LN23"></a><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>X509_NAME_field_to_text</span><span class='Parentheses'>(</span>X509_NAME <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fieldName</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN24"></a><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>X509_NAME_to_text</span><span class='Parentheses'>(</span>X509_NAME <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN25"></a><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>ASN1_STRING_to_text</span><span class='Parentheses'>(</span>ASN1_STRING <span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Function context for data persisting over repeated calls. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN32"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Member'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN33"></a>} <span class='Declare_Typedef'>SSLExtensionInfoContext</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Indicates whether current session uses SSL 
 * 
 * Function has no arguments.  Returns bool.  True if current session 
 * is SSL session and false if it is local or non-ssl session. 
 */ 
</span><a name="LN41"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN42"><span class='Ref_to_Func'>ssl_is_used</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN43"></a><span class='Declare_Function'>ssl_is_used</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../src/include/fmgr.h.html#LN318"><span class='Ref_to_Macro'>PG_RETURN_BOOL</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns SSL version currently in use. 
 */ 
</span><a name="LN52"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN53"><span class='Ref_to_Func'>ssl_version</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN54"></a><span class='Declare_Function'>ssl_version</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span>SSL_get_version<span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns SSL cipher currently in use. 
 */ 
</span><a name="LN65"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN66"><span class='Ref_to_Func'>ssl_cipher</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN67"></a><span class='Declare_Function'>ssl_cipher</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span>SSL_get_cipher<span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Indicates whether current client provided a certificate 
 * 
 * Function has no arguments.  Returns bool.  True if current session 
 * is SSL session and client certificate is verified, otherwise false. 
 */ 
</span><a name="LN81"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN82"><span class='Ref_to_Func'>ssl_client_cert_present</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN83"></a><span class='Declare_Function'>ssl_client_cert_present</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../src/include/fmgr.h.html#LN318"><span class='Ref_to_Macro'>PG_RETURN_BOOL</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns serial number of certificate used to establish current 
 * session 
 * 
 * Function has no arguments.  It returns the certificate serial 
 * number as numeric or null if current session doesn't use SSL or if 
 * SSL connection is established without sending client certificate. 
 */ 
</span><a name="LN97"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN98"><span class='Ref_to_Func'>ssl_client_serial</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN99"></a><span class='Declare_Function'>ssl_client_serial</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN101"></a>    <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN102"></a>    <a href="../../src/include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>port</span> <span class='Operator'>= </span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>; 
</span><a name="LN103"></a>    X509       <span class='Operator'>*</span><span class='Declare_Local'>peer</span> <span class='Operator'>= </span><a href="sslinfo.c.html#LN102"><span class='Ref_To_Local'>port</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Delimiter'>; 
</span><a name="LN104"></a>    ASN1_INTEGER <span class='Operator'>*</span><span class='Declare_Local'>serial</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN105"></a>    BIGNUM     <span class='Operator'>*</span><span class='Declare_Local'>b</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>decimal</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="sslinfo.c.html#LN103"><span class='Ref_To_Local'>peer</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN104"><span class='Ref_To_Local'>serial</span></a> <span class='Operator'>= </span>X509_get_serialNumber<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN103"><span class='Ref_To_Local'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN105"><span class='Ref_To_Local'>b</span></a> <span class='Operator'>= </span>ASN1_INTEGER_to_BN<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN104"><span class='Ref_To_Local'>serial</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN106"><span class='Ref_To_Local'>decimal</span></a> <span class='Operator'>= </span>BN_bn2dec<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN105"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    BN_free<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN105"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN101"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN587"><span class='Ref_to_Macro'>DirectFunctionCall3</span></a><span class='Parentheses'>(</span><a href="../../src/backend/utils/adt/numeric.c.html#LN557"><span class='Ref_to_Func'>numeric_in</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../src/include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN106"><span class='Ref_To_Local'>decimal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../src/include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../src/include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    OPENSSL_free<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN106"><span class='Ref_To_Local'>decimal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sslinfo.c.html#LN101"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ssl_client_serial &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Converts OpenSSL ASN1_STRING structure into text 
 * 
 * Converts ASN1_STRING into text, converting all the characters into 
 * current database encoding if possible.  Any invalid characters are 
 * replaced by question marks. 
 * 
 * Parameter: str - OpenSSL ASN1_STRING structure.  Memory management 
 * of this structure is responsibility of caller. 
 * 
 * Returns Datum, which can be directly returned from a C language SQL 
 * function. 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN138"></a><span class='Declare_Function'>ASN1_STRING_to_text</span><span class='Parentheses'>(</span>ASN1_STRING <span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN140"></a>    BIO        <span class='Operator'>*</span><span class='Declare_Local'>membuf</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    size_t      <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN142"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>nullterm</span><span class='Delimiter'>; 
</span><a name="LN143"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sp</span><span class='Delimiter'>; 
</span><a name="LN144"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN145"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a> <span class='Operator'>= </span>BIO_new<span class='Parentheses'>(</span>BIO_s_mem<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create OpenSSL BIO structure"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>BIO_set_close<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span>BIO_CLOSE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    ASN1_STRING_print_ex<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN138"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, 
</span>                         <span class='Parentheses'>((</span>ASN1_STRFLGS_RFC2253 <span class='Operator'>& ~</span>ASN1_STRFLGS_ESC_MSB<span class='Parentheses'>) 
</span>                          <span class='Operator'>| </span>ASN1_STRFLGS_UTF8_CONVERT<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ensure null termination of the BIO's content */ 
</span>    <a href="sslinfo.c.html#LN142"><span class='Ref_To_Local'>nullterm</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    BIO_write<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="sslinfo.c.html#LN142"><span class='Ref_To_Local'>nullterm</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN141"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span>BIO_get_mem_data<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="sslinfo.c.html#LN143"><span class='Ref_To_Local'>sp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN144"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../src/include/mb/pg_wchar.h.html#LN566"><span class='Ref_to_Proto'>pg_any_to_server</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN143"><span class='Ref_To_Local'>sp</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN141"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../src/fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN145"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN144"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN144"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>!= </span><a href="sslinfo.c.html#LN143"><span class='Ref_To_Local'>sp</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN144"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>BIO_free<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN140"><span class='Ref_To_Local'>membuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not free OpenSSL BIO structure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN145"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ASN1_STRING_to_text &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Returns specified field of specified X509_NAME structure 
 * 
 * Common part of ssl_client_dn and ssl_issuer_dn functions. 
 * 
 * Parameter: X509_NAME *name - either subject or issuer of certificate 
 * Parameter: text fieldName  - field name string like 'CN' or commonName 
 *            to be looked up in the OpenSSL ASN1 OID database 
 * 
 * Returns result of ASN1_STRING_to_text applied to appropriate 
 * part of name 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN184"></a><span class='Declare_Function'>X509_NAME_field_to_text</span><span class='Parentheses'>(</span>X509_NAME <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fieldName</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN186"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>string_fieldname</span><span class='Delimiter'>; 
</span><a name="LN187"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nid</span><span class='Delimiter'>, 
</span><a name="LN188"></a>                <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN189"></a>    ASN1_STRING <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span> 
    <a href="sslinfo.c.html#LN186"><span class='Ref_To_Local'>string_fieldname</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN184"><span class='Ref_to_Parameter'>fieldName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN187"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>= </span>OBJ_txt2nid<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN186"><span class='Ref_To_Local'>string_fieldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN187"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>== </span>NID_undef<span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid X.509 field name: \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="sslinfo.c.html#LN186"><span class='Ref_To_Local'>string_fieldname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN186"><span class='Ref_To_Local'>string_fieldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN188"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span>X509_NAME_get_index_by_NID<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN184"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN187"><span class='Ref_To_Local'>nid</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN188"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN189"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span>X509_NAME_ENTRY_get_data<span class='Parentheses'>(</span>X509_NAME_get_entry<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN184"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN188"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sslinfo.c.html#LN25"><span class='Ref_to_Proto'>ASN1_STRING_to_text</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN189"><span class='Ref_To_Local'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end X509_NAME_field_to_text &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Returns specified field of client certificate distinguished name 
 * 
 * Receives field name (like 'commonName' and 'emailAddress') and 
 * returns appropriate part of certificate subject converted into 
 * database encoding. 
 * 
 * Parameter: fieldname text - will be looked up in OpenSSL object 
 * identifier database 
 * 
 * Returns text string with appropriate value. 
 * 
 * Throws an error if argument cannot be converted into ASN1 OID by 
 * OpenSSL.  Returns null if no client certificate is present, or if 
 * there is no field with such name in the certificate. 
 */ 
</span><a name="LN223"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN224"><span class='Ref_to_Func'>ssl_client_dn_field</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN225"></a><span class='Declare_Function'>ssl_client_dn_field</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN227"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>fieldname</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="sslinfo.c.html#LN228"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN23"><span class='Ref_to_Proto'>X509_NAME_field_to_text</span></a><span class='Parentheses'>(</span>X509_get_subject_name<span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN227"><span class='Ref_To_Local'>fieldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="sslinfo.c.html#LN228"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="sslinfo.c.html#LN228"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns specified field of client certificate issuer name 
 * 
 * Receives field name (like 'commonName' and 'emailAddress') and 
 * returns appropriate part of certificate subject converted into 
 * database encoding. 
 * 
 * Parameter: fieldname text - would be looked up in OpenSSL object 
 * identifier database 
 * 
 * Returns text string with appropriate value. 
 * 
 * Throws an error if argument cannot be converted into ASN1 OID by 
 * OpenSSL.  Returns null if no client certificate is present, or if 
 * there is no field with such name in the certificate. 
 */ 
</span><a name="LN258"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN259"><span class='Ref_to_Func'>ssl_issuer_field</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN260"></a><span class='Declare_Function'>ssl_issuer_field</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN262"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>fieldname</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN263"></a>    <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="sslinfo.c.html#LN263"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN23"><span class='Ref_to_Proto'>X509_NAME_field_to_text</span></a><span class='Parentheses'>(</span>X509_get_issuer_name<span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN262"><span class='Ref_To_Local'>fieldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="sslinfo.c.html#LN263"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="sslinfo.c.html#LN263"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Equivalent of X509_NAME_oneline that respects encoding 
 * 
 * This function converts X509_NAME structure to the text variable 
 * converting all textual data into current database encoding. 
 * 
 * Parameter: X509_NAME *name X509_NAME structure to be converted 
 * 
 * Returns: text datum which contains string representation of 
 * X509_NAME 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN289"></a><span class='Declare_Function'>X509_NAME_to_text</span><span class='Parentheses'>(</span>X509_NAME <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN291"></a>    BIO        <span class='Operator'>*</span><span class='Declare_Local'>membuf</span> <span class='Operator'>= </span>BIO_new<span class='Parentheses'>(</span>BIO_s_mem<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><a name="LN292"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN293"></a>                <span class='Declare_Local'>nid</span><span class='Delimiter'>, 
</span><a name="LN294"></a>                <span class='Declare_Local'>count</span> <span class='Operator'>= </span>X509_NAME_entry_count<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN289"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN295"></a>    X509_NAME_ENTRY <span class='Operator'>*</span><span class='Declare_Local'>e</span><span class='Delimiter'>; 
</span><a name="LN296"></a>    ASN1_STRING <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN297"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>field_name</span><span class='Delimiter'>; 
</span><a name="LN298"></a>    size_t      <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN299"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>nullterm</span><span class='Delimiter'>; 
</span><a name="LN300"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sp</span><span class='Delimiter'>; 
</span><a name="LN301"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN302"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create OpenSSL BIO structure"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>BIO_set_close<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span>BIO_CLOSE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN292"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="sslinfo.c.html#LN292"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="sslinfo.c.html#LN294"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; </span><a href="sslinfo.c.html#LN292"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="sslinfo.c.html#LN295"><span class='Ref_To_Local'>e</span></a> <span class='Operator'>= </span>X509_NAME_get_entry<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN289"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN292"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN293"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>= </span>OBJ_obj2nid<span class='Parentheses'>(</span>X509_NAME_ENTRY_get_object<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN295"><span class='Ref_To_Local'>e</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN293"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>== </span>NID_undef<span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not get NID for ASN1_OBJECT object"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN296"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span>X509_NAME_ENTRY_get_data<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN295"><span class='Ref_To_Local'>e</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN297"><span class='Ref_To_Local'>field_name</span></a> <span class='Operator'>= </span>OBJ_nid2sn<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN293"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN297"><span class='Ref_To_Local'>field_name</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="sslinfo.c.html#LN297"><span class='Ref_To_Local'>field_name</span></a> <span class='Operator'>= </span>OBJ_nid2ln<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN293"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN297"><span class='Ref_To_Local'>field_name</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert NID %d to an ASN1_OBJECT structure"</span><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN293"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        BIO_printf<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='String'>"/%s="</span><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN297"><span class='Ref_To_Local'>field_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        ASN1_STRING_print_ex<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN296"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>((</span>ASN1_STRFLGS_RFC2253 <span class='Operator'>& ~</span>ASN1_STRFLGS_ESC_MSB<span class='Parentheses'>) 
</span>                              <span class='Operator'>| </span>ASN1_STRFLGS_UTF8_CONVERT<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;count;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ensure null termination of the BIO's content */ 
</span>    <a href="sslinfo.c.html#LN299"><span class='Ref_To_Local'>nullterm</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    BIO_write<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="sslinfo.c.html#LN299"><span class='Ref_To_Local'>nullterm</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN298"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span>BIO_get_mem_data<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="sslinfo.c.html#LN300"><span class='Ref_To_Local'>sp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN301"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../src/include/mb/pg_wchar.h.html#LN566"><span class='Ref_to_Proto'>pg_any_to_server</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN300"><span class='Ref_To_Local'>sp</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN298"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../src/fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN302"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN301"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN301"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>!= </span><a href="sslinfo.c.html#LN300"><span class='Ref_To_Local'>sp</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN301"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>BIO_free<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN291"><span class='Ref_To_Local'>membuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not free OpenSSL BIO structure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN302"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end X509_NAME_to_text &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Returns current client certificate subject as one string 
 * 
 * This function returns distinguished name (subject) of the client 
 * certificate used in the current SSL connection, converting it into 
 * the current database encoding. 
 * 
 * Returns text datum. 
 */ 
</span><a name="LN356"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN357"><span class='Ref_to_Func'>ssl_client_dn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN358"></a><span class='Declare_Function'>ssl_client_dn</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sslinfo.c.html#LN24"><span class='Ref_to_Proto'>X509_NAME_to_text</span></a><span class='Parentheses'>(</span>X509_get_subject_name<span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns current client certificate issuer as one string 
 * 
 * This function returns issuer's distinguished name of the client 
 * certificate used in the current SSL connection, converting it into 
 * the current database encoding. 
 * 
 * Returns text datum. 
 */ 
</span><a name="LN375"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN376"><span class='Ref_to_Func'>ssl_issuer_dn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN377"></a><span class='Declare_Function'>ssl_issuer_dn</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sslinfo.c.html#LN24"><span class='Ref_to_Proto'>X509_NAME_to_text</span></a><span class='Parentheses'>(</span>X509_get_issuer_name<span class='Parentheses'>(</span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns information about available SSL extensions. 
 * 
 * Returns setof record made of the following values: 
 * - name of the extension. 
 * - value of the extension. 
 * - critical status of the extension. 
 */ 
</span><a name="LN393"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN394"><span class='Ref_to_Func'>ssl_extension_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN395"></a><span class='Declare_Function'>ssl_extension_info</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN397"></a>    X509       <span class='Operator'>*</span><span class='Declare_Local'>cert</span> <span class='Operator'>= </span><a href="../../src/backend/utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Delimiter'>; 
</span><a name="LN398"></a>    <a href="../../src/include/funcapi.h.html#LN56"><span class='Ref_to_Struct'>FuncCallContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcctx</span><span class='Delimiter'>; 
</span><a name="LN399"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>call_cntr</span><span class='Delimiter'>; 
</span><a name="LN400"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>max_calls</span><span class='Delimiter'>; 
</span><a name="LN401"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN402"></a>    <a href="sslinfo.c.html#LN30"><span class='Ref_to_Typedef'>SSLExtensionInfoContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fctx</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN284"><span class='Ref_to_Macro'>SRF_IS_FIRSTCALL</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span> 
<a name="LN407"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* create a function context for cross-call persistence */ 
</span>        <a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN286"><span class='Ref_to_Macro'>SRF_FIRSTCALL_INIT</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Switch to memory context appropriate for multiple function calls 
         */ 
</span>        <a href="sslinfo.c.html#LN401"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create a user function context for cross-call persistence */ 
</span>        <a href="sslinfo.c.html#LN402"><span class='Ref_To_Local'>fctx</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN30"><span class='Ref_to_Typedef'>SSLExtensionInfoContext</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN30"><span class='Ref_to_Typedef'>SSLExtensionInfoContext</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Construct tuple descriptor */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="sslinfo.c.html#LN407"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../src/include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Parentheses'>)</span> 
            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN402"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="sslinfo.c.html#LN32"><span class='Ref_to_Member'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN229"><span class='Ref_to_Proto'>BlessTupleDesc</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN407"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Set max_calls as a count of extensions in certificate */ 
</span>        <a href="sslinfo.c.html#LN400"><span class='Ref_To_Local'>max_calls</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN397"><span class='Ref_To_Local'>cert</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>? </span>X509_get_ext_count<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN397"><span class='Ref_To_Local'>cert</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN400"><span class='Ref_To_Local'>max_calls</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* got results, keep track of them */ 
</span>            <a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN73"><span class='Ref_to_Member'>max_calls</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN400"><span class='Ref_To_Local'>max_calls</span></a><span class='Delimiter'>; 
</span>            <a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN402"><span class='Ref_To_Local'>fctx</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* fast track when no results */ 
</span>            <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN401"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN401"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SRF_IS_FIRSTCALL() &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* stuff done on every call of the function */ 
</span>    <a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN288"><span class='Ref_to_Macro'>SRF_PERCALL_SETUP</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize per-call variables. 
     */ 
</span>    <a href="sslinfo.c.html#LN399"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN64"><span class='Ref_to_Member'>call_cntr</span></a><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN400"><span class='Ref_To_Local'>max_calls</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN73"><span class='Ref_to_Member'>max_calls</span></a><span class='Delimiter'>; 
</span>    <a href="sslinfo.c.html#LN402"><span class='Ref_To_Local'>fctx</span></a> <span class='Operator'>= </span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* do while there are more left to send */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN399"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>&LT; </span><a href="sslinfo.c.html#LN400"><span class='Ref_To_Local'>max_calls</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN459"></a>        <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN460"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN461"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN462"></a>        <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN463"></a>        <a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN464"></a>        BIO        <span class='Operator'>*</span><span class='Declare_Local'>membuf</span><span class='Delimiter'>; 
</span><a name="LN465"></a>        X509_EXTENSION <span class='Operator'>*</span><span class='Declare_Local'>ext</span><span class='Delimiter'>; 
</span><a name="LN466"></a>        ASN1_OBJECT <span class='Operator'>*</span><span class='Declare_Local'>obj</span><span class='Delimiter'>; 
</span><a name="LN467"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nid</span><span class='Delimiter'>; 
</span><a name="LN468"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* need a BIO for this */ 
</span>        <a href="sslinfo.c.html#LN464"><span class='Ref_To_Local'>membuf</span></a> <span class='Operator'>= </span>BIO_new<span class='Parentheses'>(</span>BIO_s_mem<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN464"><span class='Ref_To_Local'>membuf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create OpenSSL BIO structure"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the extension from the certificate */ 
</span>        <a href="sslinfo.c.html#LN465"><span class='Ref_To_Local'>ext</span></a> <span class='Operator'>= </span>X509_get_ext<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN397"><span class='Ref_To_Local'>cert</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN399"><span class='Ref_To_Local'>call_cntr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN466"><span class='Ref_To_Local'>obj</span></a> <span class='Operator'>= </span>X509_EXTENSION_get_object<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN465"><span class='Ref_To_Local'>ext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the extension name */ 
</span>        <a href="sslinfo.c.html#LN467"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>= </span>OBJ_obj2nid<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN466"><span class='Ref_To_Local'>obj</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sslinfo.c.html#LN467"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>== </span>NID_undef<span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unknown OpenSSL extension in certificate at position %d"</span><span class='Delimiter'>, 
</span>                   <a href="sslinfo.c.html#LN399"><span class='Ref_To_Local'>call_cntr</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN459"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span>OBJ_nid2sn<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN467"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN460"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the extension value */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>X509V3_EXT_print<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN464"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN465"><span class='Ref_To_Local'>ext</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not print extension value in certificate at position %d"</span><span class='Delimiter'>, 
</span>                            <a href="sslinfo.c.html#LN399"><span class='Ref_To_Local'>call_cntr</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN468"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>BIO_get_mem_data<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN464"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="sslinfo.c.html#LN461"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN459"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/builtins.h.html#LN86"><span class='Ref_to_Proto'>cstring_to_text_with_len</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN461"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN468"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN460"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get critical status */ 
</span>        <a href="sslinfo.c.html#LN459"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span>X509_EXTENSION_get_critical<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN465"><span class='Ref_To_Local'>ext</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN460"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Build tuple */ 
</span>        <a href="sslinfo.c.html#LN462"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/backend/access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN402"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="sslinfo.c.html#LN32"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN459"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN460"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="sslinfo.c.html#LN463"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN221"><span class='Ref_to_Macro'>HeapTupleGetDatum</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN462"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>BIO_free<span class='Parentheses'>(</span><a href="sslinfo.c.html#LN464"><span class='Ref_To_Local'>membuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not free OpenSSL BIO structure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/funcapi.h.html#LN290"><span class='Ref_to_Macro'>SRF_RETURN_NEXT</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Delimiter'>, </span><a href="sslinfo.c.html#LN463"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if call_cntr&LT;max_calls &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* All done */ 
</span>    <a href="../../src/include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="sslinfo.c.html#LN398"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ssl_extension_info &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>