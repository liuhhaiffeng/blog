<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\tablefunc\tablefunc.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\tablefunc\tablefunc.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * contrib/tablefunc/tablefunc.c 
 * 
 * 
 * tablefunc 
 * 
 * Sample to demonstrate C functions which return setof scalar 
 * and setof composite. 
 * Joe Conway &LT;mail@joeconway.com&GT; 
 * And contributors: 
 * Nabil Sayegh &LT;postgresql@e-trolley.de&GT; 
 * 
 * Copyright (c) 2002-2017, PostgreSQL Global Development Group 
 * 
 * Permission to use, copy, modify, and distribute this software and its 
 * documentation for any purpose, without fee, and without a written agreement 
 * is hereby granted, provided that the above copyright notice and this 
 * paragraph and the following two paragraphs appear in all copies. 
 * 
 * IN NO EVENT SHALL THE AUTHORS OR DISTRIBUTORS BE LIABLE TO ANY PARTY FOR 
 * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, INCLUDING 
 * LOST PROFITS, ARISING OUT OF THE USE OF THIS SOFTWARE AND ITS 
 * DOCUMENTATION, EVEN IF THE AUTHOR OR DISTRIBUTORS HAVE BEEN ADVISED OF THE 
 * POSSIBILITY OF SUCH DAMAGE. 
 * 
 * THE AUTHORS AND DISTRIBUTORS SPECIFICALLY DISCLAIM ANY WARRANTIES, 
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY 
 * AND FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS 
 * ON AN "AS IS" BASIS, AND THE AUTHOR AND DISTRIBUTORS HAS NO OBLIGATIONS TO 
 * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS. 
 * 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"tablefunc.h"</span> 
 
<a href="../../src/include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<a name="LN48"></a><span class='Keyword'>static </span><a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>load_categories_hash</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cats_sql</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN49"></a><span class='Keyword'>static </span><a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_crosstab_tuplestore</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sql</span><span class='Delimiter'>, 
</span><a name="LN50"></a>                        <a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>crosstab_hash</span><span class='Delimiter'>, 
</span><a name="LN51"></a>                        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, 
</span><a name="LN52"></a>                        <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Delimiter'>, 
</span><a name="LN53"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>randomAccess</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN54"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>validateConnectbyTupleDesc</span><span class='Parentheses'>(</span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>show_branch</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>show_serial</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN55"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>compatCrosstabTupleDescs</span><span class='Parentheses'>(</span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc1</span><span class='Delimiter'>, </span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN56"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>compatConnectbyTupleDescs</span><span class='Parentheses'>(</span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc1</span><span class='Delimiter'>, </span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN57"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>get_normal_pair</span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>x1</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>x2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN58"></a><span class='Keyword'>static </span><a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>connectby</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Delimiter'>, 
</span><a name="LN59"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key_fld</span><span class='Delimiter'>, 
</span><a name="LN60"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>parent_key_fld</span><span class='Delimiter'>, 
</span><a name="LN61"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>orderby_fld</span><span class='Delimiter'>, 
</span><a name="LN62"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>branch_delim</span><span class='Delimiter'>, 
</span><a name="LN63"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_with</span><span class='Delimiter'>, 
</span><a name="LN64"></a>          <span class='Keyword'>int </span><span class='Declare_Parameter'>max_depth</span><span class='Delimiter'>, 
</span><a name="LN65"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_branch</span><span class='Delimiter'>, 
</span><a name="LN66"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_serial</span><span class='Delimiter'>, 
</span><a name="LN67"></a>          <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Delimiter'>, 
</span><a name="LN68"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>randomAccess</span><span class='Delimiter'>, 
</span><a name="LN69"></a>          <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attinmeta</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>build_tuplestore_recursively</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key_fld</span><span class='Delimiter'>, 
</span><a name="LN71"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>parent_key_fld</span><span class='Delimiter'>, 
</span><a name="LN72"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Delimiter'>, 
</span><a name="LN73"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>orderby_fld</span><span class='Delimiter'>, 
</span><a name="LN74"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>branch_delim</span><span class='Delimiter'>, 
</span><a name="LN75"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_with</span><span class='Delimiter'>, 
</span><a name="LN76"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>branch</span><span class='Delimiter'>, 
</span><a name="LN77"></a>                             <span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN78"></a>                             <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>serial</span><span class='Delimiter'>, 
</span><a name="LN79"></a>                             <span class='Keyword'>int </span><span class='Declare_Parameter'>max_depth</span><span class='Delimiter'>, 
</span><a name="LN80"></a>                             <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_branch</span><span class='Delimiter'>, 
</span><a name="LN81"></a>                             <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_serial</span><span class='Delimiter'>, 
</span><a name="LN82"></a>                             <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Delimiter'>, 
</span><a name="LN83"></a>                             <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attinmeta</span><span class='Delimiter'>, 
</span><a name="LN84"></a>                             <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tupstore</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN88"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Member'>mean</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* mean of the distribution */ 
</span><a name="LN89"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Member'>stddev</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* stddev of the distribution */ 
</span><a name="LN90"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Member'>carry_val</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* hold second generated value */ 
</span><a name="LN91"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>use_carry</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* use second generated value */ 
</span><a name="LN92"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>normal_rand_fctx</span><span class='Delimiter'>; 
</span> 
<a name="LN94"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>xpfree</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>var_</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN94"><span class='Ref_to_Parameter'>var_</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>        <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>            <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN94"><span class='Ref_to_Parameter'>var_</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>            <a href="tablefunc.c.html#LN94"><span class='Ref_to_Parameter'>var_</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Delimiter'>} </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN103"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>xpstrdup</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>tgtvar_</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>srcvar_</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN103"><span class='Ref_to_Parameter'>srcvar_</span></a><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <a href="tablefunc.c.html#LN103"><span class='Ref_to_Parameter'>tgtvar_</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN103"><span class='Ref_to_Parameter'>srcvar_</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Control'>else</span> <span class='Operator'>\ 
</span>            <a href="tablefunc.c.html#LN103"><span class='Ref_to_Parameter'>tgtvar_</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN111"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>xstreq</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>tgtvar_</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>srcvar_</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(((</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Parameter'>tgtvar_</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Parameter'>srcvar_</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> <span class='Operator'>|| \ 
</span>     <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Parameter'>tgtvar_</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Parameter'>srcvar_</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Parameter'>tgtvar_</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Parameter'>srcvar_</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)))</span> 
 
<span class='Comment_Multi_Line'>/* sign, 10 digits, '\0' */ 
</span><a name="LN116"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>INT32_STRLEN</span>    <span class='Number'>12</span> 
 
<span class='Comment_Multi_Line'>/* stored info for a crosstab category */ 
</span><a name="LN119"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>crosstab_cat_desc</span> 
<span class='Delimiter'>{ 
</span><a name="LN121"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>catname</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* full category name */ 
</span><a name="LN122"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Member'>attidx</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* zero based */ 
</span><a name="LN123"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>crosstab_cat_desc</span><span class='Delimiter'>; 
</span> 
<a name="LN125"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_CATNAME_LEN</span>         <a href="../../src/interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> 
<a name="LN126"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>INIT_CATS</span>               <span class='Number'>64</span> 
 
<a name="LN128"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>crosstab_HashTableLookup</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>HASHTAB</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>CATNAME</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>CATDESC</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="tablefunc.c.html#LN158"><span class='Ref_to_Typedef'>crosstab_HashEnt</span></a> <span class='Operator'>*</span>hentry<span class='Delimiter'>; </span><span class='Keyword'>char </span>key<span class='Delimiter'>[</span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a><span class='Delimiter'>]; </span><span class='Operator'>\ 
</span>    <span class='Operator'>\ 
</span>    <a href="../../src/include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span>key<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span>key<span class='Delimiter'>, </span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN128"><span class='Ref_to_Parameter'>CATNAME</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    hentry <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN158"><span class='Ref_to_Typedef'>crosstab_HashEnt</span></a><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN128"><span class='Ref_to_Parameter'>HASHTAB</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                         key<span class='Delimiter'>, </span><a href="../../src/include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>hentry<span class='Parentheses'>) </span><span class='Operator'>\ 
</span>        <a href="tablefunc.c.html#LN128"><span class='Ref_to_Parameter'>CATDESC</span></a> <span class='Operator'>= </span>hentry<span class='Operator'>-&GT;</span>catdesc<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>else</span> <span class='Operator'>\ 
</span>        <a href="tablefunc.c.html#LN128"><span class='Ref_to_Parameter'>CATDESC</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN142"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>crosstab_HashTableInsert</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>HASHTAB</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>CATDESC</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="tablefunc.c.html#LN158"><span class='Ref_to_Typedef'>crosstab_HashEnt</span></a> <span class='Operator'>*</span>hentry<span class='Delimiter'>; </span><span class='Keyword'>bool </span>found<span class='Delimiter'>; </span><span class='Keyword'>char </span>key<span class='Delimiter'>[</span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a><span class='Delimiter'>]; </span><span class='Operator'>\ 
</span>    <span class='Operator'>\ 
</span>    <a href="../../src/include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span>key<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <a href="../../src/pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span>key<span class='Delimiter'>, </span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN142"><span class='Ref_to_Parameter'>CATDESC</span></a><span class='Operator'>-&GT;</span>catname<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    hentry <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN158"><span class='Ref_to_Typedef'>crosstab_HashEnt</span></a><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN142"><span class='Ref_to_Parameter'>HASHTAB</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                         key<span class='Delimiter'>, </span><a href="../../src/include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span>found<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>found<span class='Parentheses'>) </span><span class='Operator'>\ 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../src/bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate category name"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    hentry<span class='Operator'>-&GT;</span>catdesc <span class='Operator'>= </span><a href="tablefunc.c.html#LN142"><span class='Ref_to_Parameter'>CATDESC</span></a><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* hash table */ 
</span><a name="LN158"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>crosstab_hashent</span> 
<span class='Delimiter'>{ 
</span><a name="LN160"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>internal_catname</span><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN161"></a>    <a href="tablefunc.c.html#LN119"><span class='Ref_to_Struct'>crosstab_cat_desc</span></a> <span class='Operator'>*</span><span class='Declare_Member'>catdesc</span><span class='Delimiter'>; 
</span><a name="LN162"></a>} <span class='Declare_Typedef'>crosstab_HashEnt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * normal_rand - return requested number of random values 
 * with a Gaussian (Normal) distribution. 
 * 
 * inputs are int numvals, float8 mean, and float8 stddev 
 * returns setof float8 
 */ 
</span><a name="LN171"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN172"><span class='Ref_to_Func'>normal_rand</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN173"></a><span class='Declare_Function'>normal_rand</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN175"></a>    <a href="../../src/include/funcapi.h.html#LN56"><span class='Ref_to_Struct'>FuncCallContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcctx</span><span class='Delimiter'>; 
</span><a name="LN176"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>call_cntr</span><span class='Delimiter'>; 
</span><a name="LN177"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>max_calls</span><span class='Delimiter'>; 
</span><a name="LN178"></a>    <a href="tablefunc.c.html#LN86"><span class='Ref_to_Typedef'>normal_rand_fctx</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fctx</span><span class='Delimiter'>; 
</span><a name="LN179"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>mean</span><span class='Delimiter'>; 
</span><a name="LN180"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>stddev</span><span class='Delimiter'>; 
</span><a name="LN181"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>carry_val</span><span class='Delimiter'>; 
</span><a name="LN182"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>use_carry</span><span class='Delimiter'>; 
</span><a name="LN183"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* stuff done only on the first call of the function */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN284"><span class='Ref_to_Macro'>SRF_IS_FIRSTCALL</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* create a function context for cross-call persistence */ 
</span>        <a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN286"><span class='Ref_to_Macro'>SRF_FIRSTCALL_INIT</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * switch to memory context appropriate for multiple function calls 
         */ 
</span>        <a href="tablefunc.c.html#LN183"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* total number of tuples to be returned */ 
</span>        <a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN73"><span class='Ref_to_Member'>max_calls</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN234"><span class='Ref_to_Macro'>PG_GETARG_UINT32</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* allocate memory for user context */ 
</span>        <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN86"><span class='Ref_to_Typedef'>normal_rand_fctx</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN86"><span class='Ref_to_Typedef'>normal_rand_fctx</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Use fctx to keep track of upper and lower bounds from call to call. 
         * It will also be used to carry over the spare value we get from the 
         * Box-Muller algorithm so that we only actually calculate a new value 
         * every other call. 
         */ 
</span>        <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN88"><span class='Ref_to_Member'>mean</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN245"><span class='Ref_to_Macro'>PG_GETARG_FLOAT8</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN89"><span class='Ref_to_Member'>stddev</span></a> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN245"><span class='Ref_to_Macro'>PG_GETARG_FLOAT8</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN90"><span class='Ref_to_Member'>carry_val</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN91"><span class='Ref_to_Member'>use_carry</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN183"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SRF_IS_FIRSTCALL() &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* stuff done on every call of the function */ 
</span>    <a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN288"><span class='Ref_to_Macro'>SRF_PERCALL_SETUP</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN176"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN64"><span class='Ref_to_Member'>call_cntr</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN177"><span class='Ref_To_Local'>max_calls</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN73"><span class='Ref_to_Member'>max_calls</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN179"><span class='Ref_To_Local'>mean</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN88"><span class='Ref_to_Member'>mean</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN180"><span class='Ref_To_Local'>stddev</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN89"><span class='Ref_to_Member'>stddev</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN181"><span class='Ref_To_Local'>carry_val</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN90"><span class='Ref_to_Member'>carry_val</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN182"><span class='Ref_To_Local'>use_carry</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN91"><span class='Ref_to_Member'>use_carry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN176"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN177"><span class='Ref_To_Local'>max_calls</span></a><span class='Parentheses'>)</span>  <span class='Comment_Single_Line'>/* do when there is more left to send */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN231"></a>        <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN182"><span class='Ref_To_Local'>use_carry</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * reset use_carry and use second value obtained on last pass 
             */ 
</span>            <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN91"><span class='Ref_to_Member'>use_carry</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN231"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN181"><span class='Ref_To_Local'>carry_val</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN243"></a>            <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>normval_1</span><span class='Delimiter'>; 
</span><a name="LN244"></a>            <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>normval_2</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get the next two normal values */ 
</span>            <a href="tablefunc.c.html#LN57"><span class='Ref_to_Proto'>get_normal_pair</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN243"><span class='Ref_To_Local'>normval_1</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablefunc.c.html#LN244"><span class='Ref_To_Local'>normval_2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* use the first */ 
</span>            <a href="tablefunc.c.html#LN231"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN179"><span class='Ref_To_Local'>mean</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN180"><span class='Ref_To_Local'>stddev</span></a> <span class='Operator'>* </span><a href="tablefunc.c.html#LN243"><span class='Ref_To_Local'>normval_1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* and save the second */ 
</span>            <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN90"><span class='Ref_to_Member'>carry_val</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN179"><span class='Ref_To_Local'>mean</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN180"><span class='Ref_To_Local'>stddev</span></a> <span class='Operator'>* </span><a href="tablefunc.c.html#LN244"><span class='Ref_To_Local'>normval_2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN178"><span class='Ref_To_Local'>fctx</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN91"><span class='Ref_to_Member'>use_carry</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* send the result */ 
</span>        <a href="../../src/include/funcapi.h.html#LN290"><span class='Ref_to_Macro'>SRF_RETURN_NEXT</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Delimiter'>, </span><a href="../../src/include/postgres.h.html#LN745"><span class='Ref_to_Func'>Float8GetDatum</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN231"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if call_cntr&LT;max_calls &raquo; </span> 
    <span class='Control'>else</span> 
        <span class='Comment_Multi_Line'>/* do when there is no more left */ 
</span>        <a href="../../src/include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN175"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end normal_rand &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_normal_pair() 
 * Assigns normally distributed (Gaussian) values to a pair of provided 
 * parameters, with mean 0, standard deviation 1. 
 * 
 * This routine implements Algorithm P (Polar method for normal deviates) 
 * from Knuth's _The_Art_of_Computer_Programming_, Volume 2, 3rd ed., pages 
 * 122-126. Knuth cites his source as "The polar method", G. E. P. Box, M. E. 
 * Muller, and G. Marsaglia, _Annals_Math,_Stat._ 29 (1958), 610-611. 
 * 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN277"></a><span class='Declare_Function'>get_normal_pair</span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>x1</span><span class='Delimiter'>, </span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>x2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN279"></a>    <a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a>      <span class='Declare_Local'>u1</span><span class='Delimiter'>, 
</span><a name="LN280"></a>                <span class='Declare_Local'>u2</span><span class='Delimiter'>, 
</span><a name="LN281"></a>                <span class='Declare_Local'>v1</span><span class='Delimiter'>, 
</span><a name="LN282"></a>                <span class='Declare_Local'>v2</span><span class='Delimiter'>, 
</span><a name="LN283"></a>                <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tablefunc.c.html#LN279"><span class='Ref_To_Local'>u1</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a><span class='Parentheses'>) </span><a href="../../src/port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a><span class='Parentheses'>) </span><a href="../../src/include/pg_config_manual.h.html#LN199"><span class='Ref_to_Const'>MAX_RANDOM_VALUE</span></a><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN280"><span class='Ref_To_Local'>u2</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a><span class='Parentheses'>) </span><a href="../../src/port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="../../src/include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a><span class='Parentheses'>) </span><a href="../../src/include/pg_config_manual.h.html#LN199"><span class='Ref_to_Const'>MAX_RANDOM_VALUE</span></a><span class='Delimiter'>; 
</span> 
        <a href="tablefunc.c.html#LN281"><span class='Ref_To_Local'>v1</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>* </span><a href="tablefunc.c.html#LN279"><span class='Ref_To_Local'>u1</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN282"><span class='Ref_To_Local'>v2</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>* </span><a href="tablefunc.c.html#LN280"><span class='Ref_To_Local'>u2</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN281"><span class='Ref_To_Local'>v1</span></a> <span class='Operator'>* </span><a href="tablefunc.c.html#LN281"><span class='Ref_To_Local'>v1</span></a> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN282"><span class='Ref_To_Local'>v2</span></a> <span class='Operator'>* </span><a href="tablefunc.c.html#LN282"><span class='Ref_To_Local'>v2</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="tablefunc.c.html#LN277"><span class='Ref_to_Parameter'>x1</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="tablefunc.c.html#LN277"><span class='Ref_to_Parameter'>x2</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span>sqrt<span class='Parentheses'>((</span><span class='Operator'>-</span><span class='Number'>2</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>* </span>log<span class='Parentheses'>(</span><a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="tablefunc.c.html#LN277"><span class='Ref_to_Parameter'>x1</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN281"><span class='Ref_To_Local'>v1</span></a> <span class='Operator'>* </span><a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="tablefunc.c.html#LN277"><span class='Ref_to_Parameter'>x2</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN282"><span class='Ref_To_Local'>v2</span></a> <span class='Operator'>* </span><a href="tablefunc.c.html#LN283"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end get_normal_pair &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * crosstab - create a crosstab of rowids and values columns from a 
 * SQL statement returning one rowid column, one category column, 
 * and one value column. 
 * 
 * e.g. given sql which produces: 
 * 
 *          rowid   cat     value 
 *          ------+-------+------- 
 *          row1    cat1    val1 
 *          row1    cat2    val2 
 *          row1    cat3    val3 
 *          row1    cat4    val4 
 *          row2    cat1    val5 
 *          row2    cat2    val6 
 *          row2    cat3    val7 
 *          row2    cat4    val8 
 * 
 * crosstab returns: 
 *                  &LT;===== values columns =====&GT; 
 *          rowid   cat1    cat2    cat3    cat4 
 *          ------+-------+-------+-------+------- 
 *          row1    val1    val2    val3    val4 
 *          row2    val5    val6    val7    val8 
 * 
 * NOTES: 
 * 1. SQL result must be ordered by 1,2. 
 * 2. The number of values columns depends on the tuple description 
 *    of the function's declared return type.  The return type's columns 
 *    must match the datatypes of the SQL query's result.  The datatype 
 *    of the category column can be anything, however. 
 * 3. Missing values (i.e. not enough adjacent rows of same rowid to 
 *    fill the number of result values columns) are filled in with nulls. 
 * 4. Extra values (i.e. too many adjacent rows of same rowid to fill 
 *    the number of result values columns) are skipped. 
 * 5. Rows with all nulls in the values columns are skipped. 
 */ 
</span><a name="LN346"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN347"><span class='Ref_to_Func'>crosstab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN348"></a><span class='Declare_Function'>crosstab</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN350"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN351"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN352"></a>    <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span><span class='Delimiter'>; 
</span><a name="LN353"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN354"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>call_cntr</span><span class='Delimiter'>; 
</span><a name="LN355"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>max_calls</span><span class='Delimiter'>; 
</span><a name="LN356"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN357"></a>    <a href="../../src/include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Local'>spi_tuptable</span><span class='Delimiter'>; 
</span><a name="LN358"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>spi_tupdesc</span><span class='Delimiter'>; 
</span><a name="LN359"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>firstpass</span><span class='Delimiter'>; 
</span><a name="LN360"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>lastrowid</span><span class='Delimiter'>; 
</span><a name="LN361"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN362"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_categories</span><span class='Delimiter'>; 
</span><a name="LN363"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN364"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN365"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN366"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see if caller supports us returning a tuplestore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../src/include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"materialize mode required, but it is not "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN363"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN365"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>())</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"crosstab: SPI_connect returned %d"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN365"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Retrieve the desired rows */ 
</span>    <a href="tablefunc.c.html#LN365"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN350"><span class='Ref_To_Local'>sql</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN366"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If no qualifying tuples, fall out early */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN365"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>!= </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a> <span class='Operator'>|| </span><a href="tablefunc.c.html#LN366"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN270"><span class='Ref_to_Member'>isDone</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN238"><span class='Ref_to_EnumConst'>ExprEndResult</span></a><span class='Delimiter'>; 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="tablefunc.c.html#LN357"><span class='Ref_To_Local'>spi_tuptable</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN358"><span class='Ref_To_Local'>spi_tupdesc</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN357"><span class='Ref_To_Local'>spi_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * The provided SQL query must always return three columns. 
     * 
     * 1. rowname 
     *  the label or identifier for each row in the final result 
     * 2. category 
     *  the label or identifier for each column in the final result 
     * 3. values 
     *  the value for each column in the final result 
     *---------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN358"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid source data SQL statement"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The provided SQL must return 3 "</span> 
                           <span class='String'>"columns: rowid, category, and values."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get a tuple descriptor for our result type */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../src/include/funcapi.h.html#LN157"><span class='Ref_to_Proto'>get_call_result_type</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../src/include/funcapi.h.html#LN152"><span class='Ref_to_EnumConst'>TYPEFUNC_COMPOSITE</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* success */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../src/include/funcapi.h.html#LN153"><span class='Ref_to_EnumConst'>TYPEFUNC_RECORD</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* failed to determine actual type of RECORD */ 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function returning record called in context "</span> 
                            <span class='String'>"that cannot accept type record"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* result type isn't composite */ 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"return type must be a row type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that return tupdesc is compatible with the data we got from SPI, 
     * at least based on number and type of attributes 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablefunc.c.html#LN55"><span class='Ref_to_Proto'>compatCrosstabTupleDescs</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN358"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"return and sql tuple descriptions are "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"incompatible"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * switch to long-lived memory context 
     */ 
</span>    <a href="tablefunc.c.html#LN364"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN363"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* make sure we have a persistent copy of the result tupdesc */ 
</span>    <a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize our tuplestore in long-lived context */ 
</span>    <a href="tablefunc.c.html#LN352"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= 
</span>        <a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN364"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate attribute metadata needed later to produce tuples from raw C 
     * strings 
     */ 
</span>    <a href="tablefunc.c.html#LN356"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* total number of tuples to be examined */ 
</span>    <a href="tablefunc.c.html#LN355"><span class='Ref_To_Local'>max_calls</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN366"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* the return tuple always must have 1 rowid + num_categories columns */ 
</span>    <a href="tablefunc.c.html#LN362"><span class='Ref_To_Local'>num_categories</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN359"><span class='Ref_To_Local'>firstpass</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN360"><span class='Ref_To_Local'>lastrowid</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN355"><span class='Ref_To_Local'>max_calls</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN482"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>skip_tuple</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN483"></a>        <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* allocate and zero space */ 
</span>        <a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN362"><span class='Ref_To_Local'>num_categories</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * now loop through the sql results and assign each value in sequence 
         * to the next category 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN362"><span class='Ref_To_Local'>num_categories</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN494"></a>            <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>spi_tuple</span><span class='Delimiter'>; 
</span><a name="LN495"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rowid</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* see if we've gone too far already */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a> <span class='Operator'>&GT;= </span><a href="tablefunc.c.html#LN355"><span class='Ref_To_Local'>max_calls</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get the next sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN494"><span class='Ref_To_Local'>spi_tuple</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN357"><span class='Ref_To_Local'>spi_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* get the rowid from the current sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN494"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN358"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If this is the first pass through the values for this rowid, 
             * set the first column to rowid 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Check to see if the rowid is the same as that of the last 
                 * tuple sent -- if so, skip this tuple entirely 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablefunc.c.html#LN359"><span class='Ref_To_Local'>firstpass</span></a> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Macro'>xstreq</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN360"><span class='Ref_To_Local'>lastrowid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="tablefunc.c.html#LN482"><span class='Ref_To_Local'>skip_tuple</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If rowid hasn't changed on us, continue building the output 
             * tuple. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Macro'>xstreq</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Get the next category item value, which is always attribute 
                 * number three. 
                 * 
                 * Be careful to assign the value to the array index based on 
                 * which category we are presently processing. 
                 */ 
</span>                <a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN494"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN358"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * increment the counter since we consume a row for each 
                 * category, but not for last pass because the outer loop will 
                 * do that for us 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN362"><span class='Ref_To_Local'>num_categories</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
                    <a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if xstreq(rowid,values[0... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * We'll fill in NULLs for the missing values, but we need to 
                 * decrement the counter since this sql result row doesn't 
                 * belong to the current output tuple. 
                 */ 
</span>                <a href="tablefunc.c.html#LN354"><span class='Ref_To_Local'>call_cntr</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN495"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;num_categories;... &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablefunc.c.html#LN482"><span class='Ref_To_Local'>skip_tuple</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN566"></a>            <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* build the tuple and store it */ 
</span>            <a href="tablefunc.c.html#LN566"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN356"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN352"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN566"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN566"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Remember current rowid */ 
</span>        <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN360"><span class='Ref_To_Local'>lastrowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN360"><span class='Ref_To_Local'>lastrowid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN359"><span class='Ref_To_Local'>firstpass</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Clean up */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN362"><span class='Ref_To_Local'>num_categories</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN361"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN483"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for call_cntr=0;call_cntr... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* let the caller know we're sending back a tuplestore */ 
</span>    <a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN352"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN351"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN353"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release SPI related resources (and return to caller's context) */ 
</span>    <a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end crosstab &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * crosstab_hash - reimplement crosstab as materialized function and 
 * properly deal with missing values (i.e. don't pack remaining 
 * values to the left) 
 * 
 * crosstab - create a crosstab of rowids and values columns from a 
 * SQL statement returning one rowid column, one category column, 
 * and one value column. 
 * 
 * e.g. given sql which produces: 
 * 
 *          rowid   cat     value 
 *          ------+-------+------- 
 *          row1    cat1    val1 
 *          row1    cat2    val2 
 *          row1    cat4    val4 
 *          row2    cat1    val5 
 *          row2    cat2    val6 
 *          row2    cat3    val7 
 *          row2    cat4    val8 
 * 
 * crosstab returns: 
 *                  &LT;===== values columns =====&GT; 
 *          rowid   cat1    cat2    cat3    cat4 
 *          ------+-------+-------+-------+------- 
 *          row1    val1    val2    null    val4 
 *          row2    val5    val6    val7    val8 
 * 
 * NOTES: 
 * 1. SQL result must be ordered by 1. 
 * 2. The number of values columns depends on the tuple description 
 *    of the function's declared return type. 
 * 3. Missing values (i.e. missing category) are filled in with nulls. 
 * 4. Extra values (i.e. not in category results) are skipped. 
 */ 
</span><a name="LN632"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN633"><span class='Ref_to_Func'>crosstab_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN634"></a><span class='Declare_Function'>crosstab_hash</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN636"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sql</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN637"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cats_sql</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN638"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN639"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN640"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN641"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN642"></a>    <a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>crosstab_hash</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see if caller supports us returning a tuplestore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../src/include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"materialize mode required, but it is not "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN640"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN641"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN640"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get the requested return tuple description */ 
</span>    <a href="tablefunc.c.html#LN639"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to make sure we have a reasonable tuple descriptor 
     * 
     * Note we will attempt to coerce the values into whatever the return 
     * attribute type is and depend on the "in" function to complain if 
     * needed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN639"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&LT; </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"query-specified return tuple and "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"crosstab function are not compatible"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* load up the categories hash table */ 
</span>    <a href="tablefunc.c.html#LN642"><span class='Ref_To_Local'>crosstab_hash</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN48"><span class='Ref_to_Proto'>load_categories_hash</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN637"><span class='Ref_To_Local'>cats_sql</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN640"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* let the caller know we're sending back a tuplestore */ 
</span>    <a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now go build it */ 
</span>    <a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN49"><span class='Ref_to_Proto'>get_crosstab_tuplestore</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN636"><span class='Ref_To_Local'>sql</span></a><span class='Delimiter'>, 
</span>                                                <a href="tablefunc.c.html#LN642"><span class='Ref_To_Local'>crosstab_hash</span></a><span class='Delimiter'>, 
</span>                                                <a href="tablefunc.c.html#LN639"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, 
</span>                                                <a href="tablefunc.c.html#LN640"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Delimiter'>, 
</span>                             <a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SFRM_Materialize mode expects us to return a NULL Datum. The actual 
     * tuples are in our tuplestore and passed back through rsinfo-&GT;setResult. 
     * rsinfo-&GT;setDesc is set to the tuple description that we actually used 
     * to build our tuples with, so the caller can verify we did what it was 
     * expecting. 
     */ 
</span>    <a href="tablefunc.c.html#LN638"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN639"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span>    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN641"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end crosstab_hash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * load up the categories hash table 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>* 
</span><a name="LN705"></a><span class='Declare_Function'>load_categories_hash</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cats_sql</span><span class='Delimiter'>, </span><a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN707"></a>    <a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>crosstab_hash</span><span class='Delimiter'>; 
</span><a name="LN708"></a>    <a href="../../src/include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span><a name="LN709"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN710"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN711"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>SPIcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the category hash table */ 
</span>    <a href="../../src/include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN708"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN708"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN708"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN125"><span class='Ref_to_Const'>MAX_CATNAME_LEN</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN708"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN158"><span class='Ref_to_Typedef'>crosstab_HashEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN708"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../src/include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN705"><span class='Ref_to_Parameter'>per_query_ctx</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * use INIT_CATS, defined above as a guess of how many hash table entries 
     * to create, initially 
     */ 
</span>    <a href="tablefunc.c.html#LN707"><span class='Ref_To_Local'>crosstab_hash</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"crosstab hash"</span><span class='Delimiter'>, 
</span>                                <a href="tablefunc.c.html#LN126"><span class='Ref_to_Const'>INIT_CATS</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="tablefunc.c.html#LN708"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, 
</span>                                <a href="../../src/include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../src/include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN709"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>())</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"load_categories_hash: SPI_connect returned %d"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN709"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Retrieve the category name rows */ 
</span>    <a href="tablefunc.c.html#LN709"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN705"><span class='Ref_to_Parameter'>cats_sql</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN710"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for qualifying tuples */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN709"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN710"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN740"></a>        <a href="../../src/include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Local'>spi_tuptable</span> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>; 
</span><a name="LN741"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>spi_tupdesc</span> <span class='Operator'>= </span><a href="tablefunc.c.html#LN740"><span class='Ref_To_Local'>spi_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span><a name="LN742"></a>        <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The provided categories SQL query must always return one column: 
         * category - the label or identifier for each column 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN741"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"provided \"categories\" SQL must "</span> <span class='Operator'>\ 
</span>                            <span class='String'>"return 1 column of at least one row"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN742"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN742"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN710"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN742"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN756"></a>            <a href="tablefunc.c.html#LN119"><span class='Ref_to_Struct'>crosstab_cat_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>catdesc</span><span class='Delimiter'>; 
</span><a name="LN757"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>catname</span><span class='Delimiter'>; 
</span><a name="LN758"></a>            <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>spi_tuple</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get the next sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN758"><span class='Ref_To_Local'>spi_tuple</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN740"><span class='Ref_To_Local'>spi_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN742"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* get the category from the current sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN757"><span class='Ref_To_Local'>catname</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN758"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN741"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="tablefunc.c.html#LN711"><span class='Ref_To_Local'>SPIcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN705"><span class='Ref_to_Parameter'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="tablefunc.c.html#LN756"><span class='Ref_To_Local'>catdesc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN119"><span class='Ref_to_Struct'>crosstab_cat_desc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN119"><span class='Ref_to_Struct'>crosstab_cat_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN756"><span class='Ref_To_Local'>catdesc</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN121"><span class='Ref_to_Member'>catname</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN757"><span class='Ref_To_Local'>catname</span></a><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN756"><span class='Ref_To_Local'>catdesc</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN122"><span class='Ref_to_Member'>attidx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN742"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add the proc description block to the hashtable */ 
</span>            <a href="tablefunc.c.html#LN142"><span class='Ref_to_Macro'>crosstab_HashTableInsert</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN707"><span class='Ref_To_Local'>crosstab_hash</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN756"><span class='Ref_To_Local'>catdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN711"><span class='Ref_To_Local'>SPIcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;proc;i++ &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (ret==SPI_OK_SELECT)&... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../src/include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"load_categories_hash: SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablefunc.c.html#LN707"><span class='Ref_To_Local'>crosstab_hash</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end load_categories_hash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * create and populate the crosstab tuplestore using the provided source query 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>* 
</span><a name="LN790"></a><span class='Declare_Function'>get_crosstab_tuplestore</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sql</span><span class='Delimiter'>, 
</span><a name="LN791"></a>                        <a href="../../src/backend/utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>crosstab_hash</span><span class='Delimiter'>, 
</span><a name="LN792"></a>                        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, 
</span><a name="LN793"></a>                        <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Delimiter'>, 
</span><a name="LN794"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>randomAccess</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN796"></a>    <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span><span class='Delimiter'>; 
</span><a name="LN797"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_categories</span> <span class='Operator'>= </span><a href="../../src/include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN791"><span class='Ref_to_Parameter'>crosstab_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN798"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN792"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN799"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN800"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN801"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN802"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize our tuplestore (while still in query context!) */ 
</span>    <a href="tablefunc.c.html#LN796"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN794"><span class='Ref_to_Parameter'>randomAccess</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN801"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>())</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"get_crosstab_tuplestore: SPI_connect returned %d"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN801"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now retrieve the crosstab source rows */ 
</span>    <a href="tablefunc.c.html#LN801"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN790"><span class='Ref_to_Parameter'>sql</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN802"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for qualifying tuples */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN801"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN802"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN819"></a>        <a href="../../src/include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Local'>spi_tuptable</span> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>; 
</span><a name="LN820"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>spi_tupdesc</span> <span class='Operator'>= </span><a href="tablefunc.c.html#LN819"><span class='Ref_To_Local'>spi_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span><a name="LN821"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ncols</span> <span class='Operator'>= </span><a href="tablefunc.c.html#LN820"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN822"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rowid</span><span class='Delimiter'>; 
</span><a name="LN823"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>lastrowid</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN824"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>firstpass</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN825"></a>        <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN826"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN827"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>result_ncols</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN797"><span class='Ref_To_Local'>num_categories</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* no qualifying category tuples */ 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"provided \"categories\" SQL must "</span> <span class='Operator'>\ 
</span>                            <span class='String'>"return 1 column of at least one row"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The provided SQL query must always return at least three columns: 
         * 
         * 1. rowname   the label for each row - column 1 in the final result 
         * 2. category  the label for each value-column in the final result 3. 
         * value     the values used to populate the value-columns 
         * 
         * If there are more than three columns, the last two are taken as 
         * "category" and "values". The first column is taken as "rowname". 
         * Additional columns (2 thru N-2) are assumed the same for the same 
         * "rowname", and are copied into the result tuple from the first time 
         * we encounter a particular rowname. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN821"><span class='Ref_To_Local'>ncols</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid source data SQL statement"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The provided SQL must return 3 "</span> <span class='Operator'>\ 
</span>                               <span class='String'>" columns; rowid, category, and values."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="tablefunc.c.html#LN827"><span class='Ref_To_Local'>result_ncols</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN821"><span class='Ref_To_Local'>ncols</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="tablefunc.c.html#LN797"><span class='Ref_To_Local'>num_categories</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Recheck to make sure we tuple descriptor still looks reasonable */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN792"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN827"><span class='Ref_To_Local'>result_ncols</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Query-specified return "</span> <span class='Operator'>\ 
</span>                               <span class='String'>"tuple has %d columns but crosstab "</span> <span class='Operator'>\ 
</span>                               <span class='String'>"returns %d."</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN792"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN827"><span class='Ref_To_Local'>result_ncols</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* allocate space */ 
</span>        <a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN827"><span class='Ref_To_Local'>result_ncols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* and make sure it's clear */ 
</span>        memset<span class='Parentheses'>(</span><a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN827"><span class='Ref_To_Local'>result_ncols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN825"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN825"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN802"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN825"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN877"></a>            <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>spi_tuple</span><span class='Delimiter'>; 
</span><a name="LN878"></a>            <a href="tablefunc.c.html#LN119"><span class='Ref_to_Struct'>crosstab_cat_desc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>catdesc</span><span class='Delimiter'>; 
</span><a name="LN879"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>catname</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get the next sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN877"><span class='Ref_To_Local'>spi_tuple</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN819"><span class='Ref_To_Local'>spi_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN825"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* get the rowid from the current sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN822"><span class='Ref_To_Local'>rowid</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN877"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN820"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * if we're on a new output row, grab the column values up to 
             * column N-2 now 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN824"><span class='Ref_To_Local'>firstpass</span></a> <span class='Operator'>|| !</span><a href="tablefunc.c.html#LN111"><span class='Ref_to_Macro'>xstreq</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN823"><span class='Ref_To_Local'>lastrowid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN822"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * a new row means we need to flush the old one first, unless 
                 * we're on the very first row 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablefunc.c.html#LN824"><span class='Ref_To_Local'>firstpass</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* rowid changed, flush the previous output row */ 
</span>                    <a href="tablefunc.c.html#LN800"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN798"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN796"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN800"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN827"><span class='Ref_To_Local'>result_ncols</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                        <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN822"><span class='Ref_To_Local'>rowid</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN821"><span class='Ref_To_Local'>ncols</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                    <a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN877"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN820"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN826"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* we're no longer on the first pass */ 
</span>                <a href="tablefunc.c.html#LN824"><span class='Ref_To_Local'>firstpass</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if firstpass||!xstreq(la... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* look up the category and fill in the appropriate column */ 
</span>            <a href="tablefunc.c.html#LN879"><span class='Ref_To_Local'>catname</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN877"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN820"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN821"><span class='Ref_To_Local'>ncols</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN879"><span class='Ref_To_Local'>catname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tablefunc.c.html#LN128"><span class='Ref_to_Macro'>crosstab_HashTableLookup</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN791"><span class='Ref_to_Parameter'>crosstab_hash</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN879"><span class='Ref_To_Local'>catname</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN878"><span class='Ref_To_Local'>catdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN878"><span class='Ref_To_Local'>catdesc</span></a><span class='Parentheses'>) 
</span>                    <a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN878"><span class='Ref_To_Local'>catdesc</span></a><span class='Operator'>-&GT;</span><a href="tablefunc.c.html#LN122"><span class='Ref_to_Member'>attidx</span></a> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN821"><span class='Ref_To_Local'>ncols</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>                        <a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN877"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN820"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN821"><span class='Ref_To_Local'>ncols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN823"><span class='Ref_To_Local'>lastrowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN103"><span class='Ref_to_Macro'>xpstrdup</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN823"><span class='Ref_To_Local'>lastrowid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN822"><span class='Ref_To_Local'>rowid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;proc;i++ &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* flush the last output row */ 
</span>        <a href="tablefunc.c.html#LN800"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN798"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN799"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN796"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN800"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (ret==SPI_OK_SELECT)&... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../src/include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"get_crosstab_tuplestore: SPI_finish() failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/tuplestore.h.html#LN59"><span class='Ref_to_Macro'>tuplestore_donestoring</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN796"><span class='Ref_To_Local'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablefunc.c.html#LN796"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_crosstab_tuplestore &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * connectby_text - produce a result set from a hierarchical (parent/child) 
 * table. 
 * 
 * e.g. given table foo: 
 * 
 *          keyid   parent_keyid pos 
 *          ------+------------+-- 
 *          row1    NULL         0 
 *          row2    row1         0 
 *          row3    row1         0 
 *          row4    row2         1 
 *          row5    row2         0 
 *          row6    row4         0 
 *          row7    row3         0 
 *          row8    row6         0 
 *          row9    row5         0 
 * 
 * 
 * connectby(text relname, text keyid_fld, text parent_keyid_fld 
 *            [, text orderby_fld], text start_with, int max_depth 
 *            [, text branch_delim]) 
 * connectby('foo', 'keyid', 'parent_keyid', 'pos', 'row2', 0, '~') returns: 
 * 
 *      keyid   parent_id   level    branch             serial 
 *      ------+-----------+--------+----------------------- 
 *      row2    NULL          0       row2                1 
 *      row5    row2          1       row2~row5           2 
 *      row9    row5          2       row2~row5~row9      3 
 *      row4    row2          1       row2~row4           4 
 *      row6    row4          2       row2~row4~row6      5 
 *      row8    row6          3       row2~row4~row6~row8 6 
 * 
 */ 
</span><a name="LN981"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN986"><span class='Ref_to_Func'>connectby_text</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN983"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>CONNECTBY_NCOLS</span>                 <span class='Number'>4</span> 
<a name="LN984"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>CONNECTBY_NCOLS_NOBRANCH</span>        <span class='Number'>3</span> 
 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN987"></a><span class='Declare_Function'>connectby_text</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN989"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN990"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key_fld</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN991"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>parent_key_fld</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN992"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>start_with</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN993"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>max_depth</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN994"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>branch_delim</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN995"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>show_branch</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN996"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>show_serial</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN997"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN998"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN999"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN1000"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN1001"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see if caller supports us returning a tuplestore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../src/include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"materialize mode required, but it is not "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>nargs <span class='Operator'>== </span><span class='Number'>6</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tablefunc.c.html#LN994"><span class='Ref_To_Local'>branch_delim</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>5</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN995"><span class='Ref_To_Local'>show_branch</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Comment_Multi_Line'>/* default is no show, tilde for the delimiter */ 
</span>        <a href="tablefunc.c.html#LN994"><span class='Ref_To_Local'>branch_delim</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><span class='String'>"~"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN1000"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1001"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1000"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get the requested return tuple description */ 
</span>    <a href="tablefunc.c.html#LN998"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* does it meet our needs */ 
</span>    <a href="tablefunc.c.html#LN54"><span class='Ref_to_Proto'>validateConnectbyTupleDesc</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN998"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN995"><span class='Ref_To_Local'>show_branch</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN996"><span class='Ref_To_Local'>show_serial</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, use it then */ 
</span>    <a href="tablefunc.c.html#LN999"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN998"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, go to work */ 
</span>    <a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN58"><span class='Ref_to_Proto'>connectby</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN989"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN990"><span class='Ref_To_Local'>key_fld</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN991"><span class='Ref_To_Local'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN994"><span class='Ref_To_Local'>branch_delim</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN992"><span class='Ref_To_Local'>start_with</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN993"><span class='Ref_To_Local'>max_depth</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN995"><span class='Ref_To_Local'>show_branch</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN996"><span class='Ref_To_Local'>show_serial</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1000"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Delimiter'>, 
</span>                              <a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN999"><span class='Ref_To_Local'>attinmeta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN997"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN998"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1001"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SFRM_Materialize mode expects us to return a NULL Datum. The actual 
     * tuples are in our tuplestore and passed back through rsinfo-&GT;setResult. 
     * rsinfo-&GT;setDesc is set to the tuple description that we actually used 
     * to build our tuples with, so the caller can verify we did what it was 
     * expecting. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end connectby_text &raquo; </span> 
 
<a name="LN1064"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1065"><span class='Ref_to_Func'>connectby_text_serial</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1066"></a><span class='Declare_Function'>connectby_text_serial</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1068"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1069"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key_fld</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1070"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>parent_key_fld</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1071"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>orderby_fld</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1072"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>start_with</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1073"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>max_depth</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>5</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1074"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>branch_delim</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1075"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>show_branch</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1076"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>show_serial</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN1077"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN1078"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1079"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN1080"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN1081"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see if caller supports us returning a tuplestore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../src/include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"materialize mode required, but it is not "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>nargs <span class='Operator'>== </span><span class='Number'>7</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tablefunc.c.html#LN1074"><span class='Ref_To_Local'>branch_delim</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>6</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN1075"><span class='Ref_To_Local'>show_branch</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Comment_Multi_Line'>/* default is no show, tilde for the delimiter */ 
</span>        <a href="tablefunc.c.html#LN1074"><span class='Ref_To_Local'>branch_delim</span></a> <span class='Operator'>= </span><a href="../../src/include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><span class='String'>"~"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN1080"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1081"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1080"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get the requested return tuple description */ 
</span>    <a href="tablefunc.c.html#LN1078"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* does it meet our needs */ 
</span>    <a href="tablefunc.c.html#LN54"><span class='Ref_to_Proto'>validateConnectbyTupleDesc</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1078"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1075"><span class='Ref_To_Local'>show_branch</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1076"><span class='Ref_To_Local'>show_serial</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, use it then */ 
</span>    <a href="tablefunc.c.html#LN1079"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1078"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, go to work */ 
</span>    <a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN58"><span class='Ref_to_Proto'>connectby</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1068"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1069"><span class='Ref_To_Local'>key_fld</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1070"><span class='Ref_To_Local'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1071"><span class='Ref_To_Local'>orderby_fld</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1074"><span class='Ref_To_Local'>branch_delim</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1072"><span class='Ref_To_Local'>start_with</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1073"><span class='Ref_To_Local'>max_depth</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1075"><span class='Ref_To_Local'>show_branch</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1076"><span class='Ref_To_Local'>show_serial</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1080"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Delimiter'>, 
</span>                              <a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                                  <a href="tablefunc.c.html#LN1079"><span class='Ref_To_Local'>attinmeta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1077"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1078"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1081"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SFRM_Materialize mode expects us to return a NULL Datum. The actual 
     * tuples are in our tuplestore and passed back through rsinfo-&GT;setResult. 
     * rsinfo-&GT;setDesc is set to the tuple description that we actually used 
     * to build our tuples with, so the caller can verify we did what it was 
     * expecting. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end connectby_text_serial &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * connectby - does the real work for connectby_text() 
 */ 
</span><span class='Keyword'>static </span><a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>* 
</span><a name="LN1149"></a><span class='Declare_Function'>connectby</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Delimiter'>, 
</span><a name="LN1150"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key_fld</span><span class='Delimiter'>, 
</span><a name="LN1151"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>parent_key_fld</span><span class='Delimiter'>, 
</span><a name="LN1152"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>orderby_fld</span><span class='Delimiter'>, 
</span><a name="LN1153"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>branch_delim</span><span class='Delimiter'>, 
</span><a name="LN1154"></a>          <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_with</span><span class='Delimiter'>, 
</span><a name="LN1155"></a>          <span class='Keyword'>int </span><span class='Declare_Parameter'>max_depth</span><span class='Delimiter'>, 
</span><a name="LN1156"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_branch</span><span class='Delimiter'>, 
</span><a name="LN1157"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_serial</span><span class='Delimiter'>, 
</span><a name="LN1158"></a>          <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Delimiter'>, 
</span><a name="LN1159"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>randomAccess</span><span class='Delimiter'>, 
</span><a name="LN1160"></a>          <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attinmeta</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1162"></a>    <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1163"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1164"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
<a name="LN1166"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>serial</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to SPI manager */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN1163"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>())</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* internal error */ 
</span>        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"connectby: SPI_connect returned %d"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1163"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* switch to longer term context to create the tuple store */ 
</span>    <a href="tablefunc.c.html#LN1164"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1158"><span class='Ref_to_Parameter'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize our tuplestore */ 
</span>    <a href="tablefunc.c.html#LN1162"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1159"><span class='Ref_to_Parameter'>randomAccess</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1164"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now go get the whole tree */ 
</span>    <a href="tablefunc.c.html#LN70"><span class='Ref_to_Proto'>build_tuplestore_recursively</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1150"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1151"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1149"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1152"><span class='Ref_to_Parameter'>orderby_fld</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1153"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1154"><span class='Ref_to_Parameter'>start_with</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1154"><span class='Ref_to_Parameter'>start_with</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* current_branch */ 
</span>                                 <span class='Number'>0</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* initial level is 0 */ 
</span>                                 <span class='Operator'>&</span><a href="tablefunc.c.html#LN1166"><span class='Ref_To_Local'>serial</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* initial serial is 1 */ 
</span>                                 <a href="tablefunc.c.html#LN1155"><span class='Ref_to_Parameter'>max_depth</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1156"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1157"><span class='Ref_to_Parameter'>show_serial</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1158"><span class='Ref_to_Parameter'>per_query_ctx</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1160"><span class='Ref_to_Parameter'>attinmeta</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1162"><span class='Ref_To_Local'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablefunc.c.html#LN1162"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end connectby &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1204"></a><span class='Declare_Function'>build_tuplestore_recursively</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key_fld</span><span class='Delimiter'>, 
</span><a name="LN1205"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>parent_key_fld</span><span class='Delimiter'>, 
</span><a name="LN1206"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Delimiter'>, 
</span><a name="LN1207"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>orderby_fld</span><span class='Delimiter'>, 
</span><a name="LN1208"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>branch_delim</span><span class='Delimiter'>, 
</span><a name="LN1209"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_with</span><span class='Delimiter'>, 
</span><a name="LN1210"></a>                             <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>branch</span><span class='Delimiter'>, 
</span><a name="LN1211"></a>                             <span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN1212"></a>                             <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>serial</span><span class='Delimiter'>, 
</span><a name="LN1213"></a>                             <span class='Keyword'>int </span><span class='Declare_Parameter'>max_depth</span><span class='Delimiter'>, 
</span><a name="LN1214"></a>                             <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_branch</span><span class='Delimiter'>, 
</span><a name="LN1215"></a>                             <span class='Keyword'>bool </span><span class='Declare_Parameter'>show_serial</span><span class='Delimiter'>, 
</span><a name="LN1216"></a>                             <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>per_query_ctx</span><span class='Delimiter'>, 
</span><a name="LN1217"></a>                             <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attinmeta</span><span class='Delimiter'>, 
</span><a name="LN1218"></a>                             <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tupstore</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1220"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1217"><span class='Ref_to_Parameter'>attinmeta</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/funcapi.h.html#LN37"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span><a name="LN1221"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1222"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN1223"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>serial_column</span><span class='Delimiter'>; 
</span><a name="LN1224"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>sql</span><span class='Delimiter'>; 
</span><a name="LN1225"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN1226"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>current_key</span><span class='Delimiter'>; 
</span><a name="LN1227"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>current_key_parent</span><span class='Delimiter'>; 
</span><a name="LN1228"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>current_level</span><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN116"><span class='Ref_to_Const'>INT32_STRLEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1229"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>serial_str</span><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN116"><span class='Ref_to_Const'>INT32_STRLEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1230"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>current_branch</span><span class='Delimiter'>; 
</span><a name="LN1231"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1213"><span class='Ref_to_Parameter'>max_depth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1211"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT; </span><a href="tablefunc.c.html#LN1213"><span class='Ref_to_Parameter'>max_depth</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1224"><span class='Ref_To_Local'>sql</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build initial sql statement */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablefunc.c.html#LN1215"><span class='Ref_to_Parameter'>show_serial</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1224"><span class='Ref_To_Local'>sql</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT %s, %s FROM %s WHERE %s = %s AND %s IS NOT NULL AND %s &LT;&GT; %s"</span><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1206"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1209"><span class='Ref_to_Parameter'>start_with</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN1223"><span class='Ref_To_Local'>serial_column</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1224"><span class='Ref_To_Local'>sql</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT %s, %s FROM %s WHERE %s = %s AND %s IS NOT NULL AND %s &LT;&GT; %s ORDER BY %s"</span><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1206"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="../../src/backend/utils/adt/quote.c.html#LN100"><span class='Ref_to_Func'>quote_literal_cstr</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1209"><span class='Ref_to_Parameter'>start_with</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                         <a href="tablefunc.c.html#LN1207"><span class='Ref_to_Parameter'>orderby_fld</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN1223"><span class='Ref_To_Local'>serial_column</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1214"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Parentheses'>) 
</span>        <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="tablefunc.c.html#LN983"><span class='Ref_to_Const'>CONNECTBY_NCOLS</span></a> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN1223"><span class='Ref_To_Local'>serial_column</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="tablefunc.c.html#LN984"><span class='Ref_to_Const'>CONNECTBY_NCOLS_NOBRANCH</span></a> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN1223"><span class='Ref_To_Local'>serial_column</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First time through, do a little setup */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1211"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* root value is the one we initially start with */ 
</span>        <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1209"><span class='Ref_to_Parameter'>start_with</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* root value has no parent */ 
</span>        <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* root level is 0 */ 
</span>        <a href="../../src/include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1228"><span class='Ref_To_Local'>current_level</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1211"><span class='Ref_to_Parameter'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1228"><span class='Ref_To_Local'>current_level</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* root branch is just starting root value */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1214"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Parentheses'>) 
</span>            <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1209"><span class='Ref_to_Parameter'>start_with</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* root starts the serial with 1 */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1215"><span class='Ref_to_Parameter'>show_serial</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../src/include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1229"><span class='Ref_To_Local'>serial_str</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tablefunc.c.html#LN1212"><span class='Ref_to_Parameter'>serial</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1214"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Parentheses'>) 
</span>                <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1229"><span class='Ref_To_Local'>serial_str</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1229"><span class='Ref_To_Local'>serial_str</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* construct the tuple */ 
</span>        <a href="tablefunc.c.html#LN1231"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1217"><span class='Ref_to_Parameter'>attinmeta</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* now store it */ 
</span>        <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1218"><span class='Ref_to_Parameter'>tupstore</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1231"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* increment level */ 
</span>        <a href="tablefunc.c.html#LN1211"><span class='Ref_to_Parameter'>level</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if level==0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Retrieve the desired rows */ 
</span>    <a href="tablefunc.c.html#LN1221"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1224"><span class='Ref_To_Local'>sql</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1222"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for qualifying tuples */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tablefunc.c.html#LN1221"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1222"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1312"></a>        <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>spi_tuple</span><span class='Delimiter'>; 
</span><a name="LN1313"></a>        <a href="../../src/include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tuptable</span> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>; 
</span><a name="LN1314"></a>        <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>spi_tupdesc</span> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1313"><span class='Ref_To_Local'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span><a name="LN1315"></a>        <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1316"></a>        <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>branchstr</span><span class='Delimiter'>; 
</span><a name="LN1317"></a>        <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>chk_branchstr</span><span class='Delimiter'>; 
</span><a name="LN1318"></a>        <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>chk_current_key</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check that return tupdesc is compatible with the one we got from 
         * the query. 
         */ 
</span>        <a href="tablefunc.c.html#LN56"><span class='Ref_to_Proto'>compatConnectbyTupleDescs</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1220"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1314"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1316"><span class='Ref_To_Local'>branchstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1317"><span class='Ref_To_Local'>chk_branchstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1318"><span class='Ref_To_Local'>chk_current_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1315"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN1315"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN1222"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN1315"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* initialize branch for this pass */ 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1316"><span class='Ref_To_Local'>branchstr</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1210"><span class='Ref_to_Parameter'>branch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1317"><span class='Ref_To_Local'>chk_branchstr</span></a><span class='Delimiter'>, </span><span class='String'>"%s%s%s"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1208"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1210"><span class='Ref_to_Parameter'>branch</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1208"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get the next sql result tuple */ 
</span>            <a href="tablefunc.c.html#LN1312"><span class='Ref_To_Local'>spi_tuple</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1313"><span class='Ref_To_Local'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN1315"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* get the current key (might be NULL) */ 
</span>            <a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1312"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1314"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get the parent key (might be NULL) */ 
</span>            <a href="tablefunc.c.html#LN1227"><span class='Ref_To_Local'>current_key_parent</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1312"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1314"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* get the current level */ 
</span>            <a href="../../src/include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1228"><span class='Ref_To_Local'>current_level</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1211"><span class='Ref_to_Parameter'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* check to see if this key is also an ancestor */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1318"><span class='Ref_To_Local'>chk_current_key</span></a><span class='Delimiter'>, </span><span class='String'>"%s%s%s"</span><span class='Delimiter'>, 
</span>                                 <a href="tablefunc.c.html#LN1208"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1208"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strstr<span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1317"><span class='Ref_To_Local'>chk_branchstr</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1318"><span class='Ref_To_Local'>chk_current_key</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>))</span> 
                    <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_RECURSION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"infinite recursion detected"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* OK, extend the branch */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Parentheses'>) 
</span>                <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1316"><span class='Ref_To_Local'>branchstr</span></a><span class='Delimiter'>, </span><span class='String'>"%s%s"</span><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1208"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN1230"><span class='Ref_To_Local'>current_branch</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1316"><span class='Ref_To_Local'>branchstr</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* build a tuple */ 
</span>            <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1227"><span class='Ref_To_Local'>current_key_parent</span></a><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1228"><span class='Ref_To_Local'>current_level</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1214"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Parentheses'>) 
</span>                <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1230"><span class='Ref_To_Local'>current_branch</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1215"><span class='Ref_to_Parameter'>show_serial</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../src/include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1229"><span class='Ref_To_Local'>serial_str</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tablefunc.c.html#LN1212"><span class='Ref_to_Parameter'>serial</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1214"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Parentheses'>) 
</span>                    <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1229"><span class='Ref_To_Local'>serial_str</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablefunc.c.html#LN1229"><span class='Ref_To_Local'>serial_str</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="tablefunc.c.html#LN1231"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1217"><span class='Ref_to_Parameter'>attinmeta</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1225"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* store the tuple for later use */ 
</span>            <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1218"><span class='Ref_to_Parameter'>tupstore</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1231"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../src/include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1231"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* recurse using current_key as the new start_with */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Parentheses'>) 
</span>                <a href="tablefunc.c.html#LN70"><span class='Ref_to_Proto'>build_tuplestore_recursively</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1204"><span class='Ref_to_Parameter'>key_fld</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1205"><span class='Ref_to_Parameter'>parent_key_fld</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1206"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1207"><span class='Ref_to_Parameter'>orderby_fld</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1208"><span class='Ref_to_Parameter'>branch_delim</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1230"><span class='Ref_To_Local'>current_branch</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1211"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1212"><span class='Ref_to_Parameter'>serial</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1213"><span class='Ref_to_Parameter'>max_depth</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1214"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1215"><span class='Ref_to_Parameter'>show_serial</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1216"><span class='Ref_to_Parameter'>per_query_ctx</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1217"><span class='Ref_to_Parameter'>attinmeta</span></a><span class='Delimiter'>, 
</span>                                             <a href="tablefunc.c.html#LN1218"><span class='Ref_to_Parameter'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1226"><span class='Ref_To_Local'>current_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1227"><span class='Ref_To_Local'>current_key_parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* reset branch for next pass */ 
</span>            <a href="../../src/backend/lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1316"><span class='Ref_To_Local'>branchstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/backend/lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1317"><span class='Ref_To_Local'>chk_branchstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../src/backend/lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablefunc.c.html#LN1318"><span class='Ref_To_Local'>chk_current_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;proc;i++ &raquo; </span> 
 
        <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1316"><span class='Ref_To_Local'>branchstr</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1317"><span class='Ref_To_Local'>chk_branchstr</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tablefunc.c.html#LN94"><span class='Ref_to_Macro'>xpfree</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1318"><span class='Ref_To_Local'>chk_current_key</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (ret==SPI_OK_SELECT)&... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end build_tuplestore_recursively &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check expected (query runtime) tupdesc suitable for Connectby 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1423"></a><span class='Declare_Function'>validateConnectbyTupleDesc</span><span class='Parentheses'>(</span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>show_branch</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>show_serial</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1425"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>serial_column</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_serial</span></a><span class='Parentheses'>) 
</span>        <a href="tablefunc.c.html#LN1425"><span class='Ref_To_Local'>serial_column</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* are there the correct number of columns */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_branch</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN983"><span class='Ref_to_Const'>CONNECTBY_NCOLS</span></a> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN1425"><span class='Ref_To_Local'>serial_column</span></a><span class='Parentheses'>))</span> 
            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Query-specified return tuple has "</span> <span class='Operator'>\ 
</span>                               <span class='String'>"wrong number of columns."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN984"><span class='Ref_to_Const'>CONNECTBY_NCOLS_NOBRANCH</span></a> <span class='Operator'>+ </span><a href="tablefunc.c.html#LN1425"><span class='Ref_To_Local'>serial_column</span></a><span class='Parentheses'>) 
</span>            <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Query-specified return tuple has "</span> <span class='Operator'>\ 
</span>                               <span class='String'>"wrong number of columns."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* check that the types of the first two columns match */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"First two columns must be the same type."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check that the type of the third column is INT4 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Third column must be type %s."</span><span class='Delimiter'>, 
</span>                           <a href="../../src/backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check that the type of the fourth column is TEXT if applicable */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_branch</span></a> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Fourth column must be type %s."</span><span class='Delimiter'>, 
</span>                           <a href="../../src/backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check that the type of the fifth column is INT4 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_branch</span></a> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_serial</span></a> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"query-specified return tuple not valid for Connectby: "</span> 
                     <span class='String'>"fifth column must be type %s"</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check that the type of the fifth column is INT4 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_branch</span></a> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>show_serial</span></a> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1423"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"query-specified return tuple not valid for Connectby: "</span> 
                     <span class='String'>"fourth column must be type %s"</span><span class='Delimiter'>, 
</span>                     <a href="../../src/backend/utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="../../src/interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, the tupdesc is valid for our purposes */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end validateConnectbyTupleDesc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if spi sql tupdesc and return tupdesc are compatible 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1496"></a><span class='Declare_Function'>compatConnectbyTupleDescs</span><span class='Parentheses'>(</span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>ret_tupdesc</span><span class='Delimiter'>, </span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>sql_tupdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1498"></a>    <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>ret_atttypid</span><span class='Delimiter'>; 
</span><a name="LN1499"></a>    <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>sql_atttypid</span><span class='Delimiter'>; 
</span><a name="LN1500"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>ret_atttypmod</span><span class='Delimiter'>; 
</span><a name="LN1501"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>sql_atttypmod</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Result must have at least 2 columns. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&LT; </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Query must return at least two columns."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * These columns must match the result type indicated by the calling 
     * query. 
     */ 
</span>    <a href="tablefunc.c.html#LN1498"><span class='Ref_To_Local'>ret_atttypid</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1499"><span class='Ref_To_Local'>sql_atttypid</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1501"><span class='Ref_To_Local'>sql_atttypmod</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1498"><span class='Ref_To_Local'>ret_atttypid</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1499"><span class='Ref_To_Local'>sql_atttypid</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1501"><span class='Ref_To_Local'>sql_atttypmod</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SQL key field type %s does "</span> <span class='Operator'>\ 
</span>                           <span class='String'>"not match return key field type %s."</span><span class='Delimiter'>, 
</span>                       <a href="../../src/backend/utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1498"><span class='Ref_To_Local'>ret_atttypid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../src/backend/utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1499"><span class='Ref_To_Local'>sql_atttypid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1501"><span class='Ref_To_Local'>sql_atttypmod</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="tablefunc.c.html#LN1498"><span class='Ref_To_Local'>ret_atttypid</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1499"><span class='Ref_To_Local'>sql_atttypid</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1501"><span class='Ref_To_Local'>sql_atttypmod</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1496"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1498"><span class='Ref_To_Local'>ret_atttypid</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1499"><span class='Ref_To_Local'>sql_atttypid</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1501"><span class='Ref_To_Local'>sql_atttypmod</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SQL parent key field type %s does "</span> <span class='Operator'>\ 
</span>                           <span class='String'>"not match return parent key field type %s."</span><span class='Delimiter'>, 
</span>                       <a href="../../src/backend/utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1498"><span class='Ref_To_Local'>ret_atttypid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1500"><span class='Ref_To_Local'>ret_atttypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../src/backend/utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1499"><span class='Ref_To_Local'>sql_atttypid</span></a><span class='Delimiter'>, </span><a href="tablefunc.c.html#LN1501"><span class='Ref_To_Local'>sql_atttypmod</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, the two tupdescs are compatible for our purposes */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end compatConnectbyTupleDescs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if two tupdescs match in type of attributes 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1551"></a><span class='Declare_Function'>compatCrosstabTupleDescs</span><span class='Parentheses'>(</span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>ret_tupdesc</span><span class='Delimiter'>, </span><a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>sql_tupdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1553"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1554"></a>    <a href="../../src/include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>ret_attr</span><span class='Delimiter'>; 
</span><a name="LN1555"></a>    <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>ret_atttypid</span><span class='Delimiter'>; 
</span><a name="LN1556"></a>    <a href="../../src/include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>sql_attr</span><span class='Delimiter'>; 
</span><a name="LN1557"></a>    <a href="../../src/include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>sql_atttypid</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&LT; </span><span class='Number'>2</span> <span class='Operator'>|| 
</span>        <a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check the rowid types match */ 
</span>    <a href="tablefunc.c.html#LN1555"><span class='Ref_To_Local'>ret_atttypid</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>    <a href="tablefunc.c.html#LN1557"><span class='Ref_To_Local'>sql_atttypid</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1555"><span class='Ref_To_Local'>ret_atttypid</span></a> <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1557"><span class='Ref_To_Local'>sql_atttypid</span></a><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid return type"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SQL rowid datatype does not match "</span> <span class='Operator'>\ 
</span>                           <span class='String'>"return rowid datatype."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * - attribute [1] of the sql tuple is the category; no need to check it - 
     * attribute [2] of the sql tuple should match attributes [1] to [natts] 
     * of the return tuple 
     */ 
</span>    <a href="tablefunc.c.html#LN1556"><span class='Ref_To_Local'>sql_attr</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>sql_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN1553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="tablefunc.c.html#LN1553"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tablefunc.c.html#LN1554"><span class='Ref_To_Local'>ret_attr</span></a> <span class='Operator'>= </span><a href="tablefunc.c.html#LN1551"><span class='Ref_to_Parameter'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="tablefunc.c.html#LN1553"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablefunc.c.html#LN1554"><span class='Ref_To_Local'>ret_attr</span></a><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="tablefunc.c.html#LN1556"><span class='Ref_To_Local'>sql_attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* OK, the two tupdescs are compatible for our purposes */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end compatCrosstabTupleDescs &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>