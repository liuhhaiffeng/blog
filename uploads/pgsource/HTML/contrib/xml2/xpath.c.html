<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>contrib\xml2\xpath.c</title>
<LINK REL=StyleSheet HREF="../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>contrib\xml2\xpath.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * contrib/xml2/xpath.c 
 * 
 * Parser interface for DOM-based parser (libxml) rather than 
 * stream-based SAX-type parser 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/xml.h"</span> 
 
<span class='Comment_Multi_Line'>/* libxml includes */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;libxml/xpath.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;libxml/tree.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;libxml/xmlmemory.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;libxml/xmlerror.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;libxml/parserInternals.h&GT;</span> 
 
<a href="../../src/include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* exported for use by xslt_proc.c */ 
</span> 
<a name="LN29"></a><a href="../../src/backend/utils/adt/xml.c.html#LN103"><span class='Ref_to_Struct'>PgXmlErrorContext</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pgxml_parser_init</span><span class='Parentheses'>(</span><a href="../../src/include/utils/xml.h.html#LN38"><span class='Ref_to_Typedef'>PgXmlStrictness</span></a> <span class='Declare_Parameter'>strictness</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* workspace for pgxml_xpath() */ 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN35"></a>    xmlDocPtr   <span class='Declare_Member'>doctree</span><span class='Delimiter'>; 
</span><a name="LN36"></a>    xmlXPathContextPtr <span class='Declare_Member'>ctxt</span><span class='Delimiter'>; 
</span><a name="LN37"></a>    xmlXPathObjectPtr <span class='Declare_Member'>res</span><span class='Delimiter'>; 
</span><a name="LN38"></a>} <span class='Declare_Typedef'>xpath_workspace</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* local declarations */ 
</span> 
<a name="LN42"></a><span class='Keyword'>static </span>xmlChar <span class='Operator'>*</span><span class='Declare_Prototype'>pgxmlNodeSetToText</span><span class='Parentheses'>(</span>xmlNodeSetPtr <span class='Declare_Parameter'>nodeset</span><span class='Delimiter'>, 
</span><a name="LN43"></a>                   xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>toptagname</span><span class='Delimiter'>, </span>xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>septagname</span><span class='Delimiter'>, 
</span><a name="LN44"></a>                   xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>plainsep</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN46"></a><span class='Keyword'>static </span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pgxml_result_to_text</span><span class='Parentheses'>(</span>xmlXPathObjectPtr <span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span>xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>toptag</span><span class='Delimiter'>, 
</span><a name="LN47"></a>                     xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>septag</span><span class='Delimiter'>, </span>xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>plainsep</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN49"></a><span class='Keyword'>static </span>xmlChar <span class='Operator'>*</span><span class='Declare_Prototype'>pgxml_texttoxmlchar</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>textstring</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN51"></a><span class='Keyword'>static </span>xmlXPathObjectPtr <span class='Declare_Prototype'>pgxml_xpath</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>document</span><span class='Delimiter'>, </span>xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>xpath</span><span class='Delimiter'>, 
</span><a name="LN52"></a>            <a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workspace</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN54"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>cleanup_workspace</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workspace</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize for xml parsing. 
 * 
 * As with the underlying pg_xml_init function, calls to this MUST be followed 
 * by a PG_TRY block that guarantees that pg_xml_done is called. 
 */ 
</span><a href="../../src/backend/utils/adt/xml.c.html#LN103"><span class='Ref_to_Struct'>PgXmlErrorContext</span></a> <span class='Operator'>* 
</span><a name="LN64"></a><span class='Declare_Function'>pgxml_parser_init</span><span class='Parentheses'>(</span><a href="../../src/include/utils/xml.h.html#LN38"><span class='Ref_to_Typedef'>PgXmlStrictness</span></a> <span class='Declare_Parameter'>strictness</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN66"></a>    <a href="../../src/backend/utils/adt/xml.c.html#LN103"><span class='Ref_to_Struct'>PgXmlErrorContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xmlerrcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up error handling (we share the core's error handler) */ 
</span>    <a href="xpath.c.html#LN66"><span class='Ref_To_Local'>xmlerrcxt</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/xml.h.html#LN56"><span class='Ref_to_Proto'>pg_xml_init</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN64"><span class='Ref_to_Parameter'>strictness</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Note: we're assuming an elog cannot be thrown by the following calls */ 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize libxml */ 
</span>    xmlInitParser<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    xmlSubstituteEntitiesDefault<span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    xmlLoadExtDtdDefaultValue <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xpath.c.html#LN66"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns true if document is well-formed 
 * 
 * Note: this has been superseded by a core function.  We still have to 
 * have it in the contrib module so that existing SQL-level references 
 * to the function won't fail; but in normal usage with up-to-date SQL 
 * definitions for the contrib module, this won't be called. 
 */ 
</span> 
<a name="LN92"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN94"><span class='Ref_to_Func'>xml_is_well_formed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN95"></a><span class='Declare_Function'>xml_is_well_formed</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN97"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>t</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* document buffer */ 
</span><a name="LN98"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN99"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>docsize</span> <span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN339"><span class='Ref_to_Macro'>VARSIZE_ANY_EXHDR</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN97"><span class='Ref_To_Local'>t</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN100"></a>    xmlDocPtr   <span class='Declare_Local'>doctree</span><span class='Delimiter'>; 
</span><a name="LN101"></a>    <a href="../../src/backend/utils/adt/xml.c.html#LN103"><span class='Ref_to_Struct'>PgXmlErrorContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xmlerrcxt</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN101"><span class='Ref_To_Local'>xmlerrcxt</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN29"><span class='Ref_to_Proto'>pgxml_parser_init</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/xml.h.html#LN40"><span class='Ref_to_EnumConst'>PG_XML_STRICTNESS_LEGACY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xpath.c.html#LN100"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>= </span>xmlParseMemory<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/postgres.h.html#LN346"><span class='Ref_to_Macro'>VARDATA_ANY</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN97"><span class='Ref_To_Local'>t</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN99"><span class='Ref_To_Local'>docsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xpath.c.html#LN98"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xpath.c.html#LN100"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN100"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            xmlFreeDoc<span class='Parentheses'>(</span><a href="xpath.c.html#LN100"><span class='Ref_To_Local'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/utils/xml.h.html#LN57"><span class='Ref_to_Proto'>pg_xml_done</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN101"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/xml.h.html#LN57"><span class='Ref_to_Proto'>pg_xml_done</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN101"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN318"><span class='Ref_to_Macro'>PG_RETURN_BOOL</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN98"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xml_is_well_formed &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* Encodes special characters (&LT;, &GT;, &, " and \r) as XML entities */ 
</span> 
<a name="LN130"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN132"><span class='Ref_to_Func'>xml_encode_special_chars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN133"></a><span class='Declare_Function'>xml_encode_special_chars</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN135"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>tin</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN136"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>tout</span><span class='Delimiter'>; 
</span><a name="LN137"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>ts</span><span class='Delimiter'>, 
</span><a name="LN138"></a>               <span class='Operator'>*</span><span class='Declare_Local'>tt</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN137"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN135"><span class='Ref_To_Local'>tin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN138"><span class='Ref_To_Local'>tt</span></a> <span class='Operator'>= </span>xmlEncodeSpecialChars<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN137"><span class='Ref_To_Local'>ts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN137"><span class='Ref_To_Local'>ts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN136"><span class='Ref_To_Local'>tout</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xpath.c.html#LN138"><span class='Ref_To_Local'>tt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    xmlFree<span class='Parentheses'>(</span><a href="xpath.c.html#LN138"><span class='Ref_To_Local'>tt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN136"><span class='Ref_To_Local'>tout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xml_encode_special_chars &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Function translates a nodeset into a text representation 
 * 
 * iterates over each node in the set and calls xmlNodeDump to write it to 
 * an xmlBuffer -from which an xmlChar * string is returned. 
 * 
 * each representation is surrounded by &LT;tagname&GT; ... &LT;/tagname&GT; 
 * 
 * plainsep is an ordinary (not tag) separator - if used, then nodes are 
 * cast to string as output method 
 */ 
</span><span class='Keyword'>static </span>xmlChar <span class='Operator'>* 
</span><a name="LN165"></a><span class='Declare_Function'>pgxmlNodeSetToText</span><span class='Parentheses'>(</span>xmlNodeSetPtr <span class='Declare_Parameter'>nodeset</span><span class='Delimiter'>, 
</span><a name="LN166"></a>                   xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>toptagname</span><span class='Delimiter'>, 
</span><a name="LN167"></a>                   xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>septagname</span><span class='Delimiter'>, 
</span><a name="LN168"></a>                   xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>plainsep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN170"></a>    xmlBufferPtr <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN171"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN172"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span>xmlBufferCreate<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xpath.c.html#LN166"><span class='Ref_to_Parameter'>toptagname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span>xmlStrlen<span class='Parentheses'>(</span><a href="xpath.c.html#LN166"><span class='Ref_to_Parameter'>toptagname</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        xmlBufferWriteCHAR<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN166"><span class='Ref_to_Parameter'>toptagname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN165"><span class='Ref_to_Parameter'>nodeset</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="xpath.c.html#LN165"><span class='Ref_to_Parameter'>nodeset</span></a><span class='Operator'>-&GT;</span>nodeNr<span class='Delimiter'>; </span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN168"><span class='Ref_to_Parameter'>plainsep</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                xmlBufferWriteCHAR<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                              xmlXPathCastNodeToString<span class='Parentheses'>(</span><a href="xpath.c.html#LN165"><span class='Ref_to_Parameter'>nodeset</span></a><span class='Operator'>-&GT;</span>nodeTab<span class='Delimiter'>[</span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* If this isn't the last entry, write the plain sep. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="xpath.c.html#LN165"><span class='Ref_to_Parameter'>nodeset</span></a><span class='Operator'>-&GT;</span>nodeNr<span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                    xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xpath.c.html#LN168"><span class='Ref_to_Parameter'>plainsep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xpath.c.html#LN167"><span class='Ref_to_Parameter'>septagname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span>xmlStrlen<span class='Parentheses'>(</span><a href="xpath.c.html#LN167"><span class='Ref_to_Parameter'>septagname</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    xmlBufferWriteCHAR<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN167"><span class='Ref_to_Parameter'>septagname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                xmlNodeDump<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                            <a href="xpath.c.html#LN165"><span class='Ref_to_Parameter'>nodeset</span></a><span class='Operator'>-&GT;</span>nodeTab<span class='Delimiter'>[</span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>doc<span class='Delimiter'>, 
</span>                            <a href="xpath.c.html#LN165"><span class='Ref_to_Parameter'>nodeset</span></a><span class='Operator'>-&GT;</span>nodeTab<span class='Delimiter'>[</span><a href="xpath.c.html#LN172"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                            <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xpath.c.html#LN167"><span class='Ref_to_Parameter'>septagname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span>xmlStrlen<span class='Parentheses'>(</span><a href="xpath.c.html#LN167"><span class='Ref_to_Parameter'>septagname</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;/"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    xmlBufferWriteCHAR<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN167"><span class='Ref_to_Parameter'>septagname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nodeset-&GT;nodeNr... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nodeset!=NULL &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xpath.c.html#LN166"><span class='Ref_to_Parameter'>toptagname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span>xmlStrlen<span class='Parentheses'>(</span><a href="xpath.c.html#LN166"><span class='Ref_to_Parameter'>toptagname</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;/"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        xmlBufferWriteCHAR<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN166"><span class='Ref_to_Parameter'>toptagname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        xmlBufferWriteChar<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="xpath.c.html#LN171"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>xmlStrdup<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span>content<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    xmlBufferFree<span class='Parentheses'>(</span><a href="xpath.c.html#LN170"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="xpath.c.html#LN171"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgxmlNodeSetToText &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* Translate a PostgreSQL "varlena" -i.e. a variable length parameter 
 * into the libxml2 representation 
 */ 
</span><span class='Keyword'>static </span>xmlChar <span class='Operator'>* 
</span><a name="LN234"></a><span class='Declare_Function'>pgxml_texttoxmlchar</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>textstring</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span>xmlChar <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN234"><span class='Ref_to_Parameter'>textstring</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Publicly visible XPath functions */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This is a "raw" xpath function. Check that it returns child elements 
 * properly 
 */ 
</span><a name="LN245"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN247"><span class='Ref_to_Func'>xpath_nodeset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN248"></a><span class='Declare_Function'>xpath_nodeset</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN250"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>document</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN251"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpathsupp</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* XPath expression */ 
</span><a name="LN252"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>toptag</span> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN253"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>septag</span> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN254"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>xpath</span><span class='Delimiter'>; 
</span><a name="LN255"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpres</span><span class='Delimiter'>; 
</span><a name="LN256"></a>    xmlXPathObjectPtr <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN257"></a>    <a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN254"><span class='Ref_To_Local'>xpath</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN251"><span class='Ref_To_Local'>xpathsupp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN256"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN51"><span class='Ref_to_Proto'>pgxml_xpath</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN250"><span class='Ref_To_Local'>document</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN254"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xpath.c.html#LN257"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN255"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN46"><span class='Ref_to_Proto'>pgxml_result_to_text</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN256"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN252"><span class='Ref_To_Local'>toptag</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN253"><span class='Ref_To_Local'>septag</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN257"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN254"><span class='Ref_To_Local'>xpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN255"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN255"><span class='Ref_To_Local'>xpres</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xpath_nodeset &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * The following function is almost identical, but returns the elements in 
 * a list. 
 */ 
</span><a name="LN278"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN280"><span class='Ref_to_Func'>xpath_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN281"></a><span class='Declare_Function'>xpath_list</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN283"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>document</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN284"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpathsupp</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* XPath expression */ 
</span><a name="LN285"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>plainsep</span> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN286"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>xpath</span><span class='Delimiter'>; 
</span><a name="LN287"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpres</span><span class='Delimiter'>; 
</span><a name="LN288"></a>    xmlXPathObjectPtr <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN289"></a>    <a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN286"><span class='Ref_To_Local'>xpath</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN284"><span class='Ref_To_Local'>xpathsupp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN288"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN51"><span class='Ref_to_Proto'>pgxml_xpath</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN283"><span class='Ref_To_Local'>document</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN286"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xpath.c.html#LN289"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN287"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN46"><span class='Ref_to_Proto'>pgxml_result_to_text</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN288"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN285"><span class='Ref_To_Local'>plainsep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN289"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN286"><span class='Ref_To_Local'>xpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN287"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN287"><span class='Ref_To_Local'>xpres</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xpath_list &raquo; </span> 
 
 
<a name="LN307"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN309"><span class='Ref_to_Func'>xpath_string</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN310"></a><span class='Declare_Function'>xpath_string</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN312"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>document</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN313"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpathsupp</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* XPath expression */ 
</span><a name="LN314"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>xpath</span><span class='Delimiter'>; 
</span><a name="LN315"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pathsize</span><span class='Delimiter'>; 
</span><a name="LN316"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpres</span><span class='Delimiter'>; 
</span><a name="LN317"></a>    xmlXPathObjectPtr <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN318"></a>    <a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN315"><span class='Ref_To_Local'>pathsize</span></a> <span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN339"><span class='Ref_to_Macro'>VARSIZE_ANY_EXHDR</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN313"><span class='Ref_To_Local'>xpathsupp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We encapsulate the supplied path with "string()" = 8 chars + 1 for NUL 
     * at end 
     */ 
</span>    <span class='Comment_Multi_Line'>/* We could try casting to string using the libxml function? */ 
</span> 
    <a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>xmlChar <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN315"><span class='Ref_To_Local'>pathsize</span></a> <span class='Operator'>+ </span><span class='Number'>9</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>, </span><span class='String'>"string("</span><span class='Delimiter'>, </span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a> <span class='Operator'>+ </span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../src/include/postgres.h.html#LN346"><span class='Ref_to_Macro'>VARDATA_ANY</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN313"><span class='Ref_To_Local'>xpathsupp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN315"><span class='Ref_To_Local'>pathsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN315"><span class='Ref_To_Local'>pathsize</span></a> <span class='Operator'>+ </span><span class='Number'>7</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>')'</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN315"><span class='Ref_To_Local'>pathsize</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN317"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN51"><span class='Ref_to_Proto'>pgxml_xpath</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN312"><span class='Ref_To_Local'>document</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xpath.c.html#LN318"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN316"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN46"><span class='Ref_to_Proto'>pgxml_result_to_text</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN317"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN318"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN314"><span class='Ref_To_Local'>xpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN316"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../src/include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN316"><span class='Ref_To_Local'>xpres</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xpath_string &raquo; </span> 
 
 
<a name="LN348"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN350"><span class='Ref_to_Func'>xpath_number</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN351"></a><span class='Declare_Function'>xpath_number</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN353"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>document</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN354"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpathsupp</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* XPath expression */ 
</span><a name="LN355"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>xpath</span><span class='Delimiter'>; 
</span><a name="LN356"></a>    <a href="../../src/include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>fRes</span><span class='Delimiter'>; 
</span><a name="LN357"></a>    xmlXPathObjectPtr <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN358"></a>    <a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN355"><span class='Ref_To_Local'>xpath</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN354"><span class='Ref_To_Local'>xpathsupp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN357"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN51"><span class='Ref_to_Proto'>pgxml_xpath</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN353"><span class='Ref_To_Local'>document</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN355"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xpath.c.html#LN358"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN355"><span class='Ref_To_Local'>xpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN357"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN356"><span class='Ref_To_Local'>fRes</span></a> <span class='Operator'>= </span>xmlXPathCastToNumber<span class='Parentheses'>(</span><a href="xpath.c.html#LN357"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN358"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>xmlXPathIsNaN<span class='Parentheses'>(</span><a href="xpath.c.html#LN356"><span class='Ref_To_Local'>fRes</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN324"><span class='Ref_to_Macro'>PG_RETURN_FLOAT4</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN356"><span class='Ref_To_Local'>fRes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xpath_number &raquo; </span> 
 
 
<a name="LN380"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN382"><span class='Ref_to_Func'>xpath_bool</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN383"></a><span class='Declare_Function'>xpath_bool</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN385"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>document</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN386"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpathsupp</span> <span class='Operator'>= </span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* XPath expression */ 
</span><a name="LN387"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>xpath</span><span class='Delimiter'>; 
</span><a name="LN388"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bRes</span><span class='Delimiter'>; 
</span><a name="LN389"></a>    xmlXPathObjectPtr <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN390"></a>    <a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN387"><span class='Ref_To_Local'>xpath</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN49"><span class='Ref_to_Proto'>pgxml_texttoxmlchar</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN386"><span class='Ref_To_Local'>xpathsupp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN389"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN51"><span class='Ref_to_Proto'>pgxml_xpath</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN385"><span class='Ref_To_Local'>document</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN387"><span class='Ref_To_Local'>xpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xpath.c.html#LN390"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN387"><span class='Ref_To_Local'>xpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN389"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/fmgr.h.html#LN318"><span class='Ref_to_Macro'>PG_RETURN_BOOL</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN388"><span class='Ref_To_Local'>bRes</span></a> <span class='Operator'>= </span>xmlXPathCastToBoolean<span class='Parentheses'>(</span><a href="xpath.c.html#LN389"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN390"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/fmgr.h.html#LN318"><span class='Ref_to_Macro'>PG_RETURN_BOOL</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN388"><span class='Ref_To_Local'>bRes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xpath_bool &raquo; </span> 
 
 
 
<span class='Comment_Multi_Line'>/* Core function to evaluate XPath query */ 
</span> 
<span class='Keyword'>static </span>xmlXPathObjectPtr 
<a name="LN413"></a><span class='Declare_Function'>pgxml_xpath</span><span class='Parentheses'>(</span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>document</span><span class='Delimiter'>, </span>xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>xpath</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workspace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN415"></a>    <a href="../../src/include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>docsize</span> <span class='Operator'>= </span><a href="../../src/include/postgres.h.html#LN339"><span class='Ref_to_Macro'>VARSIZE_ANY_EXHDR</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>document</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN416"></a>    <a href="../../src/backend/utils/adt/xml.c.html#LN103"><span class='Ref_to_Struct'>PgXmlErrorContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xmlerrcxt</span><span class='Delimiter'>; 
</span><a name="LN417"></a>    xmlXPathCompExprPtr <span class='Declare_Local'>comppath</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN416"><span class='Ref_To_Local'>xmlerrcxt</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN29"><span class='Ref_to_Proto'>pgxml_parser_init</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/xml.h.html#LN40"><span class='Ref_to_EnumConst'>PG_XML_STRICTNESS_LEGACY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a> <span class='Operator'>= </span>xmlParseMemory<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../src/include/postgres.h.html#LN346"><span class='Ref_to_Macro'>VARDATA_ANY</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>document</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                            <a href="xpath.c.html#LN415"><span class='Ref_To_Local'>docsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a> <span class='Operator'>= </span>xmlXPathNewContext<span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a><span class='Operator'>-&GT;</span>node <span class='Operator'>= </span>xmlDocGetRootElement<span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* compile the path */ 
</span>            <a href="xpath.c.html#LN417"><span class='Ref_To_Local'>comppath</span></a> <span class='Operator'>= </span>xmlXPathCompile<span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>xpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN417"><span class='Ref_To_Local'>comppath</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../src/include/utils/xml.h.html#LN59"><span class='Ref_to_Proto'>xml_ereport</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN416"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span>ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Delimiter'>, 
</span>                            <span class='String'>"XPath Syntax Error"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Now evaluate the path expression. */ 
</span>            <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span>xmlXPathCompiledEval<span class='Parentheses'>(</span><a href="xpath.c.html#LN417"><span class='Ref_To_Local'>comppath</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            xmlXPathFreeCompExpr<span class='Parentheses'>(</span><a href="xpath.c.html#LN417"><span class='Ref_To_Local'>comppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/xml.h.html#LN57"><span class='Ref_to_Proto'>pg_xml_done</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN416"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="xpath.c.html#LN54"><span class='Ref_to_Proto'>cleanup_workspace</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/xml.h.html#LN57"><span class='Ref_to_Proto'>pg_xml_done</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN416"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xpath.c.html#LN413"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgxml_xpath &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Clean up after processing the result of pgxml_xpath() */ 
</span><span class='Keyword'>static void 
</span><a name="LN466"></a><span class='Declare_Function'>cleanup_workspace</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN33"><span class='Ref_to_Typedef'>xpath_workspace</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workspace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>) 
</span>        xmlXPathFreeObject<span class='Parentheses'>(</span><a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN37"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a><span class='Parentheses'>) 
</span>        xmlXPathFreeContext<span class='Parentheses'>(</span><a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN36"><span class='Ref_to_Member'>ctxt</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a><span class='Parentheses'>) 
</span>        xmlFreeDoc<span class='Parentheses'>(</span><a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN466"><span class='Ref_to_Parameter'>workspace</span></a><span class='Operator'>-&GT;</span><a href="xpath.c.html#LN35"><span class='Ref_to_Member'>doctree</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a> <span class='Operator'>* 
</span><a name="LN480"></a><span class='Declare_Function'>pgxml_result_to_text</span><span class='Parentheses'>(</span>xmlXPathObjectPtr <span class='Declare_Parameter'>res</span><span class='Delimiter'>, 
</span><a name="LN481"></a>                     xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>toptag</span><span class='Delimiter'>, 
</span><a name="LN482"></a>                     xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>septag</span><span class='Delimiter'>, 
</span><a name="LN483"></a>                     xmlChar <span class='Operator'>*</span><span class='Declare_Parameter'>plainsep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN485"></a>    xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>xpresstr</span><span class='Delimiter'>; 
</span><a name="LN486"></a>    <a href="../seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>xpres</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN480"><span class='Ref_to_Parameter'>res</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN480"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span>type<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> XPATH_NODESET<span class='Operator'>: 
</span>            <a href="xpath.c.html#LN485"><span class='Ref_To_Local'>xpresstr</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN42"><span class='Ref_to_Proto'>pgxmlNodeSetToText</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN480"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span>nodesetval<span class='Delimiter'>, 
</span>                                          <a href="xpath.c.html#LN481"><span class='Ref_to_Parameter'>toptag</span></a><span class='Delimiter'>, 
</span>                                          <a href="xpath.c.html#LN482"><span class='Ref_to_Parameter'>septag</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN483"><span class='Ref_to_Parameter'>plainsep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> XPATH_STRING<span class='Operator'>: 
</span>            <a href="xpath.c.html#LN485"><span class='Ref_To_Local'>xpresstr</span></a> <span class='Operator'>= </span>xmlStrdup<span class='Parentheses'>(</span><a href="xpath.c.html#LN480"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span>stringval<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, </span><span class='String'>"unsupported XQuery result: %d"</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN480"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span>type<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xpath.c.html#LN485"><span class='Ref_To_Local'>xpresstr</span></a> <span class='Operator'>= </span>xmlStrdup<span class='Parentheses'>((</span><span class='Keyword'>const </span>xmlChar <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='String'>"&LT;unsupported/&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now convert this result back to text */ 
</span>    <a href="xpath.c.html#LN486"><span class='Ref_To_Local'>xpres</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xpath.c.html#LN485"><span class='Ref_To_Local'>xpresstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Free various storage */ 
</span>    xmlFree<span class='Parentheses'>(</span><a href="xpath.c.html#LN485"><span class='Ref_To_Local'>xpresstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xpath.c.html#LN486"><span class='Ref_To_Local'>xpres</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgxml_result_to_text &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * xpath_table is a table function. It needs some tidying (as do the 
 * other functions here! 
 */ 
</span><a name="LN521"></a><span class='Declare_Prototype'>PG_FUNCTION_INFO_V1</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN523"><span class='Ref_to_Func'>xpath_table</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN524"></a><span class='Declare_Function'>xpath_table</span><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Function parameters */ 
</span><a name="LN527"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pkeyfield</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN528"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>xmlfield</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN529"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN530"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>xpathset</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN531"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>condition</span> <span class='Operator'>= </span><a href="../../src/include/utils/builtins.h.html#LN87"><span class='Ref_to_Proto'>text_to_cstring</span></a><span class='Parentheses'>(</span><a href="../../src/include/fmgr.h.html#LN272"><span class='Ref_to_Macro'>PG_GETARG_TEXT_PP</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* SPI (input tuple) support */ 
</span><a name="LN534"></a>    <a href="../../src/include/executor/spi.h.html#LN21"><span class='Ref_to_Struct'>SPITupleTable</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tuptable</span><span class='Delimiter'>; 
</span><a name="LN535"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>spi_tuple</span><span class='Delimiter'>; 
</span><a name="LN536"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>spi_tupdesc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Output tuple (tuplestore) support */ 
</span><a name="LN539"></a>    <a href="../../src/backend/utils/sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN540"></a>    <a href="../../src/include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>ret_tupdesc</span><span class='Delimiter'>; 
</span><a name="LN541"></a>    <a href="../../src/include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>ret_tuple</span><span class='Delimiter'>; 
</span> 
<a name="LN543"></a>    <a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN544"></a>    <a href="../../src/include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN545"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN546"></a>    <a href="../../src/include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
<a name="LN548"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>values</span><span class='Delimiter'>; 
</span><a name="LN549"></a>    xmlChar   <span class='Operator'>**</span><span class='Declare_Local'>xpaths</span><span class='Delimiter'>; 
</span><a name="LN550"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pos</span><span class='Delimiter'>; 
</span><a name="LN551"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>pathsep</span> <span class='Operator'>= </span><span class='String'>"|"</span><span class='Delimiter'>; 
</span> 
<a name="LN553"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numpaths</span><span class='Delimiter'>; 
</span><a name="LN554"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN555"></a>    <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN556"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN557"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rownr</span><span class='Delimiter'>;</span>          <span class='Comment_Multi_Line'>/* For issuing multiple rows from one original 
                                 * document */ 
</span><a name="LN559"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>had_values</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* To determine end of nodeset results */ 
</span><a name="LN560"></a>    <a href="../../src/include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>query_buf</span><span class='Delimiter'>; 
</span><a name="LN561"></a>    <a href="../../src/backend/utils/adt/xml.c.html#LN103"><span class='Ref_to_Struct'>PgXmlErrorContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xmlerrcxt</span><span class='Delimiter'>; 
</span><a name="LN562"></a>    <span class='Keyword'>volatile </span>xmlDocPtr <span class='Declare_Local'>doctree</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We only have a valid tuple description in table function mode */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../src/include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../src/include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"xpath_table must be called as a table function"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We want to materialise because it means that we don't have to carry 
     * libxml2 parser state between invocations of this function 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>))</span> 
        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"xpath_table requires Materialize mode, but it is not "</span> 
                      <span class='String'>"allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The tuplestore must exist in a higher context than this function call 
     * (per_query_ctx is used) 
     */ 
</span>    <a href="xpath.c.html#LN545"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN546"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN545"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the tuplestore - work_mem is the max in-memory size before a 
     * file is created on disk to hold it. 
     */ 
</span>    <a href="xpath.c.html#LN539"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= 
</span>        <a href="../../src/include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../src/include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../src/backend/utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN546"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get the requested return tuple description */ 
</span>    <a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a> <span class='Operator'>= </span><a href="../../src/include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN266"><span class='Ref_to_Member'>expectedDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* must have at least one output column (for the pkey) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"xpath_table must have at least one output column"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * At the moment we assume that the returned attributes make sense for the 
     * XPath specified (i.e. we trust the caller). It's not fatal if they get 
     * it wrong - the input function for the column type will raise an error 
     * if the path result can't be converted into the correct binary 
     * representation. 
     */ 
</span> 
    <a href="xpath.c.html#LN544"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set return mode and allocate value space. */ 
</span>    <a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../src/include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN548"><span class='Ref_To_Local'>values</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN549"><span class='Ref_To_Local'>xpaths</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>xmlChar <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../src/include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>xmlChar <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Split XPaths. xpathset is a writable CString. 
     * 
     * Note that we stop splitting once we've done all needed for tupdesc 
     */ 
</span>    <a href="xpath.c.html#LN553"><span class='Ref_To_Local'>numpaths</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN530"><span class='Ref_To_Local'>xpathset</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN553"><span class='Ref_To_Local'>numpaths</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xpath.c.html#LN549"><span class='Ref_To_Local'>xpaths</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN553"><span class='Ref_To_Local'>numpaths</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span>xmlChar <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>; 
</span>        <a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span>strstr<span class='Parentheses'>(</span><a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN551"><span class='Ref_To_Local'>pathsep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <a href="xpath.c.html#LN550"><span class='Ref_To_Local'>pos</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now build query */ 
</span>    <a href="../../src/backend/lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN560"><span class='Ref_To_Local'>query_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build initial sql statement */ 
</span>    <a href="../../src/bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xpath.c.html#LN560"><span class='Ref_To_Local'>query_buf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT %s, %s FROM %s WHERE %s"</span><span class='Delimiter'>, 
</span>                     <a href="xpath.c.html#LN527"><span class='Ref_To_Local'>pkeyfield</span></a><span class='Delimiter'>, 
</span>                     <a href="xpath.c.html#LN528"><span class='Ref_To_Local'>xmlfield</span></a><span class='Delimiter'>, 
</span>                     <a href="xpath.c.html#LN529"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, 
</span>                     <a href="xpath.c.html#LN531"><span class='Ref_To_Local'>condition</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xpath.c.html#LN554"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>())</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"xpath_table: SPI_connect returned %d"</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN554"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xpath.c.html#LN554"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN560"><span class='Ref_To_Local'>query_buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../src/include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"xpath_table: SPI execution failed for query %s"</span><span class='Delimiter'>, 
</span>             <a href="xpath.c.html#LN560"><span class='Ref_To_Local'>query_buf</span></a><span class='Operator'>.</span><a href="../../src/include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN555"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN534"><span class='Ref_To_Local'>tuptable</span></a> <span class='Operator'>= </span><a href="../../src/backend/executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Delimiter'>; 
</span>    <a href="xpath.c.html#LN536"><span class='Ref_To_Local'>spi_tupdesc</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN534"><span class='Ref_To_Local'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Switch out of SPI context */ 
</span>    <a href="../../src/include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN546"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that SPI returned correct result. If you put a comma into one of 
     * the function parameters, this will catch it when the SPI query returns 
     * e.g. 3 columns. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN536"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../src/include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../src/backend/utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"expression returning multiple columns is not valid in parameter list"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../src/backend/utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Expected two columns in SPI result, got %d."</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN536"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup the parser.  This should happen after we are done evaluating the 
     * query, in case it calls functions that set up libxml differently. 
     */ 
</span>    <a href="xpath.c.html#LN561"><span class='Ref_To_Local'>xmlerrcxt</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN29"><span class='Ref_to_Proto'>pgxml_parser_init</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/xml.h.html#LN40"><span class='Ref_to_EnumConst'>PG_XML_STRICTNESS_LEGACY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* For each row i.e. document returned from SPI */ 
</span><a name="LN692"></a>        <a href="../../src/include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN692"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xpath.c.html#LN692"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="xpath.c.html#LN555"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; </span><a href="xpath.c.html#LN692"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN696"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pkey</span><span class='Delimiter'>; 
</span><a name="LN697"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>xmldoc</span><span class='Delimiter'>; 
</span><a name="LN698"></a>            xmlXPathContextPtr <span class='Declare_Local'>ctxt</span><span class='Delimiter'>; 
</span><a name="LN699"></a>            xmlXPathObjectPtr <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN700"></a>            xmlChar    <span class='Operator'>*</span><span class='Declare_Local'>resstr</span><span class='Delimiter'>; 
</span><a name="LN701"></a>            xmlXPathCompExprPtr <span class='Declare_Local'>comppath</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Extract the row data as C Strings */ 
</span>            <a href="xpath.c.html#LN535"><span class='Ref_To_Local'>spi_tuple</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN534"><span class='Ref_To_Local'>tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN692"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="xpath.c.html#LN696"><span class='Ref_To_Local'>pkey</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN535"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN536"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xpath.c.html#LN697"><span class='Ref_To_Local'>xmldoc</span></a> <span class='Operator'>= </span><a href="../../src/include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN535"><span class='Ref_To_Local'>spi_tuple</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN536"><span class='Ref_To_Local'>spi_tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Clear the values array, so that not-well-formed documents 
             * return NULL in all columns.  Note that this also means that 
             * spare columns will be NULL. 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="xpath.c.html#LN540"><span class='Ref_To_Local'>ret_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="xpath.c.html#LN548"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Insert primary key */ 
</span>            <a href="xpath.c.html#LN548"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xpath.c.html#LN696"><span class='Ref_To_Local'>pkey</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Parse the document */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN697"><span class='Ref_To_Local'>xmldoc</span></a><span class='Parentheses'>) 
</span>                <a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>= </span>xmlParseMemory<span class='Parentheses'>(</span><a href="xpath.c.html#LN697"><span class='Ref_To_Local'>xmldoc</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="xpath.c.html#LN697"><span class='Ref_To_Local'>xmldoc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span>    <span class='Comment_Single_Line'>/* treat NULL as not well-formed */ 
</span>                <a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* not well-formed, so output all-NULL tuple */ 
</span>                <a href="xpath.c.html#LN541"><span class='Ref_To_Local'>ret_tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN544"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN548"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN539"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN541"><span class='Ref_To_Local'>ret_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../src/include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN541"><span class='Ref_To_Local'>ret_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* New loop here - we have to deal with nodeset results */ 
</span>                <a href="xpath.c.html#LN557"><span class='Ref_To_Local'>rownr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>do</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Now evaluate the set of xpaths. */ 
</span>                    <a href="xpath.c.html#LN559"><span class='Ref_To_Local'>had_values</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="xpath.c.html#LN553"><span class='Ref_To_Local'>numpaths</span></a><span class='Delimiter'>; </span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="xpath.c.html#LN698"><span class='Ref_To_Local'>ctxt</span></a> <span class='Operator'>= </span>xmlXPathNewContext<span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="xpath.c.html#LN698"><span class='Ref_To_Local'>ctxt</span></a><span class='Operator'>-&GT;</span>node <span class='Operator'>= </span>xmlDocGetRootElement<span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* compile the path */ 
</span>                        <a href="xpath.c.html#LN701"><span class='Ref_To_Local'>comppath</span></a> <span class='Operator'>= </span>xmlXPathCompile<span class='Parentheses'>(</span><a href="xpath.c.html#LN549"><span class='Ref_To_Local'>xpaths</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN701"><span class='Ref_To_Local'>comppath</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                            <a href="../../src/include/utils/xml.h.html#LN59"><span class='Ref_to_Proto'>xml_ereport</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN561"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><a href="../../src/include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                        ERRCODE_EXTERNAL_ROUTINE_EXCEPTION<span class='Delimiter'>, 
</span>                                        <span class='String'>"XPath Syntax Error"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* Now evaluate the path expression. */ 
</span>                        <a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span>xmlXPathCompiledEval<span class='Parentheses'>(</span><a href="xpath.c.html#LN701"><span class='Ref_To_Local'>comppath</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN698"><span class='Ref_To_Local'>ctxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        xmlXPathFreeCompExpr<span class='Parentheses'>(</span><a href="xpath.c.html#LN701"><span class='Ref_To_Local'>comppath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                        <span class='Delimiter'>{ 
</span>                            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span>type<span class='Parentheses'>) 
</span>                            <span class='Delimiter'>{ 
</span>                                <span class='Control'>case</span> XPATH_NODESET<span class='Operator'>: 
</span>                                    <span class='Comment_Multi_Line'>/* We see if this nodeset has enough nodes */ 
</span>                                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span>nodesetval <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                                        <a href="xpath.c.html#LN557"><span class='Ref_To_Local'>rownr</span></a> <span class='Operator'>&LT; </span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span>nodesetval<span class='Operator'>-&GT;</span>nodeNr<span class='Parentheses'>) 
</span>                                    <span class='Delimiter'>{ 
</span>                                        <a href="xpath.c.html#LN700"><span class='Ref_To_Local'>resstr</span></a> <span class='Operator'>= </span>xmlXPathCastNodeToString<span class='Parentheses'>(</span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span>nodesetval<span class='Operator'>-&GT;</span>nodeTab<span class='Delimiter'>[</span><a href="xpath.c.html#LN557"><span class='Ref_To_Local'>rownr</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                                        <a href="xpath.c.html#LN559"><span class='Ref_To_Local'>had_values</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                                    <span class='Delimiter'>} 
</span>                                    <span class='Control'>else</span> 
                                        <a href="xpath.c.html#LN700"><span class='Ref_To_Local'>resstr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
                                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                                <span class='Control'>case</span> XPATH_STRING<span class='Operator'>: 
</span>                                    <a href="xpath.c.html#LN700"><span class='Ref_To_Local'>resstr</span></a> <span class='Operator'>= </span>xmlStrdup<span class='Parentheses'>(</span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span>stringval<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                                <span class='Control'>default</span><span class='Operator'>: 
</span>                                    <a href="../../src/backend/bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../src/include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, </span><span class='String'>"unsupported XQuery result: %d"</span><span class='Delimiter'>, </span><a href="xpath.c.html#LN699"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span>type<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                                    <a href="xpath.c.html#LN700"><span class='Ref_To_Local'>resstr</span></a> <span class='Operator'>= </span>xmlStrdup<span class='Parentheses'>((</span><span class='Keyword'>const </span>xmlChar <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='String'>"&LT;unsupported/&GT;"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch res-&GT;type &raquo; </span> 
 
                            <span class='Comment_Multi_Line'>/* 
                             * Insert this into the appropriate column in the 
                             * result tuple. 
                             */ 
</span>                            <a href="xpath.c.html#LN548"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="xpath.c.html#LN556"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xpath.c.html#LN700"><span class='Ref_To_Local'>resstr</span></a><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if res!=NULL &raquo; </span> 
                        xmlXPathFreeContext<span class='Parentheses'>(</span><a href="xpath.c.html#LN698"><span class='Ref_To_Local'>ctxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for j=0;j&LT;numpaths;j++ &raquo; </span> 
 
                    <span class='Comment_Multi_Line'>/* Now add the tuple to the output, if there is one. */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN559"><span class='Ref_To_Local'>had_values</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="xpath.c.html#LN541"><span class='Ref_To_Local'>ret_tuple</span></a> <span class='Operator'>= </span><a href="../../src/include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN544"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN548"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../src/include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN539"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="xpath.c.html#LN541"><span class='Ref_To_Local'>ret_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../src/include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN541"><span class='Ref_To_Local'>ret_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <a href="xpath.c.html#LN557"><span class='Ref_To_Local'>rownr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN559"><span class='Ref_To_Local'>had_values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                xmlFreeDoc<span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN696"><span class='Ref_To_Local'>pkey</span></a><span class='Parentheses'>) 
</span>                <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN696"><span class='Ref_To_Local'>pkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN697"><span class='Ref_To_Local'>xmldoc</span></a><span class='Parentheses'>) 
</span>                <a href="../../src/include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN697"><span class='Ref_To_Local'>xmldoc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;proc;i++ &raquo; </span> 
    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            xmlFreeDoc<span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/xml.h.html#LN57"><span class='Ref_to_Proto'>pg_xml_done</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN561"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../src/include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../src/include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        xmlFreeDoc<span class='Parentheses'>(</span><a href="xpath.c.html#LN562"><span class='Ref_To_Local'>doctree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/xml.h.html#LN57"><span class='Ref_to_Proto'>pg_xml_done</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN561"><span class='Ref_To_Local'>xmlerrcxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/utils/tuplestore.h.html#LN59"><span class='Ref_to_Macro'>tuplestore_donestoring</span></a><span class='Parentheses'>(</span><a href="xpath.c.html#LN539"><span class='Ref_To_Local'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../src/include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xpath.c.html#LN543"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../src/include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="xpath.c.html#LN539"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SFRM_Materialize mode expects us to return a NULL Datum. The actual 
     * tuples are in our tuplestore and passed back through rsinfo-&GT;setResult. 
     * rsinfo-&GT;setDesc is set to the tuple description that we actually used 
     * to build our tuples with, so the caller can verify we did what it was 
     * expecting. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../src/include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xpath_table &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>