<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\brin\brin.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\brin\brin.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * brin.c 
 *      Implementation of BRIN indexes for Postgres 
 * 
 * See src/backend/access/brin/README for details. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/brin/brin.c 
 * 
 * TODO 
 *      * ScalarArrayOpExpr (amsearcharray -&GT; SK_SEARCHARRAY) 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/brin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/brin_page.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/brin_pageops.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/brin_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/relscan.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_am.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/freespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/index_selfuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * We use a BrinBuildState during initial construction of a BRIN index. 
 * The running state is kept in a BrinMemTuple. 
 */ 
</span><a name="LN41"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>BrinBuildState</span> 
<span class='Delimiter'>{ 
</span><a name="LN43"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>bs_irel</span><span class='Delimiter'>; 
</span><a name="LN44"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>bs_numtuples</span><span class='Delimiter'>; 
</span><a name="LN45"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Member'>bs_currentInsertBuf</span><span class='Delimiter'>; 
</span><a name="LN46"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>bs_pagesPerRange</span><span class='Delimiter'>; 
</span><a name="LN47"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>bs_currRangeStart</span><span class='Delimiter'>; 
</span><a name="LN48"></a>    <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Member'>bs_rmAccess</span><span class='Delimiter'>; 
</span><a name="LN49"></a>    <a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>bs_bdesc</span><span class='Delimiter'>; 
</span><a name="LN50"></a>    <a href="../../../include/access/brin_tuple.h.html#LN35"><span class='Ref_to_Struct'>BrinMemTuple</span></a> <span class='Operator'>*</span><span class='Declare_Member'>bs_dtuple</span><span class='Delimiter'>; 
</span><a name="LN51"></a>} <span class='Declare_Typedef'>BrinBuildState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Struct used as "opaque" during index scans 
 */ 
</span><a name="LN56"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>BrinOpaque</span> 
<span class='Delimiter'>{ 
</span><a name="LN58"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>bo_pagesPerRange</span><span class='Delimiter'>; 
</span><a name="LN59"></a>    <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Member'>bo_rmAccess</span><span class='Delimiter'>; 
</span><a name="LN60"></a>    <a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>bo_bdesc</span><span class='Delimiter'>; 
</span><a name="LN61"></a>} <span class='Declare_Typedef'>BrinOpaque</span><span class='Delimiter'>; 
</span> 
<a name="LN63"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BRIN_ALL_BLOCKRANGES</span>    <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> 
 
<a name="LN65"></a><span class='Keyword'>static </span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>initialize_brin_buildstate</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxRel</span><span class='Delimiter'>, 
</span><a name="LN66"></a>                           <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>revmap</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pagesPerRange</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>terminate_brin_buildstate</span><span class='Parentheses'>(</span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>brinsummarize</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageRange</span><span class='Delimiter'>, 
</span><a name="LN69"></a>              <span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>numSummarized</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>numExisting</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>form_and_insert_tuple</span><span class='Parentheses'>(</span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>union_tuples</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bdesc</span><span class='Delimiter'>, </span><a href="../../../include/access/brin_tuple.h.html#LN35"><span class='Ref_to_Struct'>BrinMemTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, 
</span><a name="LN72"></a>             <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN73"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>brin_vacuum_scan</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>strategy</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * BRIN handler function: return IndexAmRoutine with access method parameters 
 * and callbacks. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN81"></a><span class='Declare_Function'>brinhandler</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN83"></a>    <a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amroutine</span> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN166"><span class='Ref_to_Member'>amstrategies</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN168"><span class='Ref_to_Member'>amsupport</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN73"><span class='Ref_to_Const'>BRIN_LAST_OPTIONAL_PROCNUM</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN172"><span class='Ref_to_Member'>amcanorderbyop</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN174"><span class='Ref_to_Member'>amcanbackward</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN176"><span class='Ref_to_Member'>amcanunique</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN178"><span class='Ref_to_Member'>amcanmulticol</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN180"><span class='Ref_to_Member'>amoptionalkey</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN182"><span class='Ref_to_Member'>amsearcharray</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN184"><span class='Ref_to_Member'>amsearchnulls</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN186"><span class='Ref_to_Member'>amstorage</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN188"><span class='Ref_to_Member'>amclusterable</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN190"><span class='Ref_to_Member'>ampredlocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN192"><span class='Ref_to_Member'>amcanparallel</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN194"><span class='Ref_to_Member'>amkeytype</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN197"><span class='Ref_to_Member'>ambuild</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN86"><span class='Ref_to_Proto'>brinbuild</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN198"><span class='Ref_to_Member'>ambuildempty</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN88"><span class='Ref_to_Proto'>brinbuildempty</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN199"><span class='Ref_to_Member'>aminsert</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN89"><span class='Ref_to_Proto'>brininsert</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN200"><span class='Ref_to_Member'>ambulkdelete</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN98"><span class='Ref_to_Proto'>brinbulkdelete</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN201"><span class='Ref_to_Member'>amvacuumcleanup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN102"><span class='Ref_to_Proto'>brinvacuumcleanup</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN202"><span class='Ref_to_Member'>amcanreturn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN203"><span class='Ref_to_Member'>amcostestimate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/index_selfuncs.h.html#LN24"><span class='Ref_to_Proto'>brincostestimate</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN204"><span class='Ref_to_Member'>amoptions</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN104"><span class='Ref_to_Proto'>brinoptions</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN205"><span class='Ref_to_Member'>amproperty</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN206"><span class='Ref_to_Member'>amvalidate</span></a> <span class='Operator'>= </span><a href="brin_validate.c.html#LN36"><span class='Ref_to_Func'>brinvalidate</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN207"><span class='Ref_to_Member'>ambeginscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN93"><span class='Ref_to_Proto'>brinbeginscan</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN208"><span class='Ref_to_Member'>amrescan</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN95"><span class='Ref_to_Proto'>brinrescan</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN209"><span class='Ref_to_Member'>amgettuple</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN210"><span class='Ref_to_Member'>amgetbitmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN94"><span class='Ref_to_Proto'>bringetbitmap</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN211"><span class='Ref_to_Member'>amendscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN97"><span class='Ref_to_Proto'>brinendscan</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN212"><span class='Ref_to_Member'>ammarkpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN213"><span class='Ref_to_Member'>amrestrpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN216"><span class='Ref_to_Member'>amestimateparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN217"><span class='Ref_to_Member'>aminitparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN218"><span class='Ref_to_Member'>amparallelrescan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN83"><span class='Ref_To_Local'>amroutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brinhandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * A tuple in the heap is being inserted.  To keep a brin index up to date, 
 * we need to obtain the relevant index tuple and compare its stored values 
 * with those of the new tuple.  If the tuple values are not consistent with 
 * the summary tuple, we need to update the index tuple. 
 * 
 * If autosummarization is enabled, check if we need to summarize the previous 
 * page range. 
 * 
 * If the range is not currently summarized (i.e. the revmap returns NULL for 
 * it), there's nothing to do for this tuple. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN138"></a><span class='Declare_Function'>brininsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxRel</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>nulls</span><span class='Delimiter'>, 
</span><a name="LN139"></a>           <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>heaptid</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, 
</span><a name="LN140"></a>           <a href="../../../include/access/genam.h.html#LN110"><span class='Ref_to_Enum'>IndexUniqueCheck</span></a> <span class='Declare_Parameter'>checkUnique</span><span class='Delimiter'>, 
</span><a name="LN141"></a>           <a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN143"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pagesPerRange</span><span class='Delimiter'>; 
</span><a name="LN144"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>origHeapBlk</span><span class='Delimiter'>; 
</span><a name="LN145"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>heapBlk</span><span class='Delimiter'>; 
</span><a name="LN146"></a>    <a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>bdesc</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN141"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a><span class='Delimiter'>; 
</span><a name="LN147"></a>    <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Local'>revmap</span><span class='Delimiter'>; 
</span><a name="LN148"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN149"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tupcxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN150"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN151"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>autosummarize</span> <span class='Operator'>= </span><a href="../../../include/access/brin.h.html#LN43"><span class='Ref_to_Macro'>BrinGetAutoSummarize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN147"><span class='Ref_To_Local'>revmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN25"><span class='Ref_to_Proto'>brinRevmapInitialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN143"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * origHeapBlk is the block number where the insertion occurred.  heapBlk 
     * is the first block in the corresponding page range. 
     */ 
</span>    <a href="brin.c.html#LN144"><span class='Ref_To_Local'>origHeapBlk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN139"><span class='Ref_to_Parameter'>heaptid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="brin.c.html#LN144"><span class='Ref_To_Local'>origHeapBlk</span></a> <span class='Operator'>/ </span><a href="brin.c.html#LN143"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="brin.c.html#LN143"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN164"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_insert</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN165"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN166"></a>        <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>brtup</span><span class='Delimiter'>; 
</span><a name="LN167"></a>        <a href="../../../include/access/brin_tuple.h.html#LN35"><span class='Ref_to_Struct'>BrinMemTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dtup</span><span class='Delimiter'>; 
</span><a name="LN168"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>keyno</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If auto-summarization is enabled and we just inserted the first 
         * tuple into the first block of a new non-first page range, request a 
         * summarization run of the previous range. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN151"><span class='Ref_To_Local'>autosummarize</span></a> <span class='Operator'>&& 
</span>            <a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>== </span><a href="brin.c.html#LN144"><span class='Ref_To_Local'>origHeapBlk</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN139"><span class='Ref_to_Parameter'>heaptid</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN182"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>lastPageRange</span> <span class='Operator'>= </span><a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN183"></a>            <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>lastPageTuple</span><span class='Delimiter'>; 
</span> 
            <a href="brin.c.html#LN183"><span class='Ref_To_Local'>lastPageTuple</span></a> <span class='Operator'>= 
</span>                <a href="../../../include/access/brin_revmap.h.html#LN35"><span class='Ref_to_Proto'>brinGetTupleForHeapBlock</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN147"><span class='Ref_To_Local'>revmap</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN182"><span class='Ref_To_Local'>lastPageRange</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN165"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, 
</span>                                         <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN183"><span class='Ref_To_Local'>lastPageTuple</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/postmaster/autovacuum.h.html#LN73"><span class='Ref_to_Proto'>AutoVacuumRequestWork</span></a><span class='Parentheses'>(</span><a href="../../../include/postmaster/autovacuum.h.html#LN24"><span class='Ref_to_EnumConst'>AVW_BRINSummarizeRange</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="brin.c.html#LN182"><span class='Ref_To_Local'>lastPageRange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="brin.c.html#LN166"><span class='Ref_To_Local'>brtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN35"><span class='Ref_to_Proto'>brinGetTupleForHeapBlock</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN147"><span class='Ref_To_Local'>revmap</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN165"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, 
</span>                                         <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if range is unsummarized, there's nothing to do */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN166"><span class='Ref_To_Local'>brtup</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* First time through in this statement? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN141"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN150"><span class='Ref_to_Member'>ii_Context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN84"><span class='Ref_to_Proto'>brin_build_desc</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin.c.html#LN141"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN150"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* First time through in this brininsert call? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN149"><span class='Ref_To_Local'>tupcxt</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="brin.c.html#LN149"><span class='Ref_To_Local'>tupcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                           <span class='String'>"brininsert cxt"</span><span class='Delimiter'>, 
</span>                                           <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN149"><span class='Ref_To_Local'>tupcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="brin.c.html#LN167"><span class='Ref_To_Local'>dtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN98"><span class='Ref_to_Proto'>brin_deform_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN166"><span class='Ref_To_Local'>brtup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Compare the key values of the new tuple to the stored index values; 
         * our deformed tuple will get updated if the new tuple doesn't fit 
         * the original range (note this means we can't break out of the loop 
         * early). Make a note of whether this happens, so that we know to 
         * insert the modified tuple later. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN231"></a>            <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN232"></a>            <a href="../../../include/access/brin_tuple.h.html#LN23"><span class='Ref_to_Struct'>BrinValues</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bval</span><span class='Delimiter'>; 
</span><a name="LN233"></a>            <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>addValue</span><span class='Delimiter'>; 
</span> 
            <a href="brin.c.html#LN232"><span class='Ref_To_Local'>bval</span></a> <span class='Operator'>= &</span><a href="brin.c.html#LN167"><span class='Ref_To_Local'>dtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN45"><span class='Ref_to_Member'>bt_columns</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]; 
</span>            <a href="brin.c.html#LN233"><span class='Ref_To_Local'>addValue</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/access/brin_internal.h.html#LN67"><span class='Ref_to_Const'>BRIN_PROCNUM_ADDVALUE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin.c.html#LN231"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN517"><span class='Ref_to_Proto'>FunctionCall4Coll</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN233"><span class='Ref_To_Local'>addValue</span></a><span class='Delimiter'>, 
</span>                                       <a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>], 
</span>                                       <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN232"><span class='Ref_To_Local'>bval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>], 
</span>                                       <a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>nulls</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN168"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* if that returned true, we need to insert the updated tuple */ 
</span>            <a href="brin.c.html#LN164"><span class='Ref_To_Local'>need_insert</span></a> <span class='Operator'>|= </span><a href="../../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN231"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN164"><span class='Ref_To_Local'>need_insert</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The tuple is consistent with the new values, so there's nothing 
             * to do. 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN258"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN259"></a>            <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN258"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN165"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN260"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>origsz</span><span class='Delimiter'>; 
</span><a name="LN261"></a>            <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>origtup</span><span class='Delimiter'>; 
</span><a name="LN262"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newsz</span><span class='Delimiter'>; 
</span><a name="LN263"></a>            <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN264"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>samepage</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Make a copy of the old tuple, so that we can compare it after 
             * re-acquiring the lock. 
             */ 
</span>            <a href="brin.c.html#LN260"><span class='Ref_To_Local'>origsz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN259"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin.c.html#LN261"><span class='Ref_To_Local'>origtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN90"><span class='Ref_to_Proto'>brin_copy_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN166"><span class='Ref_To_Local'>brtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN260"><span class='Ref_To_Local'>origsz</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Before releasing the lock, check if we can attempt a same-page 
             * update.  Another process could insert a tuple concurrently in 
             * the same page though, so downstream we must be prepared to cope 
             * if this turns out to not be possible after all. 
             */ 
</span>            <a href="brin.c.html#LN263"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN85"><span class='Ref_to_Proto'>brin_form_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN146"><span class='Ref_To_Local'>bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN167"><span class='Ref_To_Local'>dtup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN262"><span class='Ref_To_Local'>newsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin.c.html#LN264"><span class='Ref_To_Local'>samepage</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_pageops.h.html#LN21"><span class='Ref_to_Proto'>brin_can_do_samepage_update</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN260"><span class='Ref_To_Local'>origsz</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN262"><span class='Ref_To_Local'>newsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Try to update the tuple.  If this doesn't work for whatever 
             * reason, we need to restart from the top; the revmap might be 
             * pointing at a different tuple for this block now, so we need to 
             * recompute to ensure both our new heap tuple and the other 
             * inserter's are covered by the combined tuple.  It might be that 
             * we don't need to update at all. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/brin_pageops.h.html#LN15"><span class='Ref_to_Proto'>brin_doupdate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN138"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN143"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN147"><span class='Ref_To_Local'>revmap</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN145"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, 
</span>                               <a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN165"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN261"><span class='Ref_To_Local'>origtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN260"><span class='Ref_To_Local'>origsz</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN263"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN262"><span class='Ref_To_Local'>newsz</span></a><span class='Delimiter'>, 
</span>                               <a href="brin.c.html#LN264"><span class='Ref_To_Local'>samepage</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* no luck; start over */ 
</span>                <a href="../../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN149"><span class='Ref_To_Local'>tupcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* success! */ 
</span>        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <a href="../../../include/access/brin_revmap.h.html#LN27"><span class='Ref_to_Proto'>brinRevmapTerminate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN147"><span class='Ref_To_Local'>revmap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN148"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN150"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN149"><span class='Ref_To_Local'>tupcxt</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN149"><span class='Ref_To_Local'>tupcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brininsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize state for a BRIN index scan. 
 * 
 * We read the metapage here to determine the pages-per-range number that this 
 * index was built with.  Note that since this cannot be changed while we're 
 * holding lock on index, it's not necessary to recompute it during brinrescan. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> 
<a name="LN323"></a><span class='Declare_Function'>brinbeginscan</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>norderbys</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN325"></a>    <a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN326"></a>    <a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN325"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../index/genam.c.html#LN76"><span class='Ref_to_Func'>RelationGetIndexScan</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN323"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN323"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN323"><span class='Ref_to_Parameter'>norderbys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN326"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN326"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN59"><span class='Ref_to_Member'>bo_rmAccess</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN25"><span class='Ref_to_Proto'>brinRevmapInitialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN323"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN326"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN58"><span class='Ref_to_Member'>bo_pagesPerRange</span></a><span class='Delimiter'>, 
</span>                                               <a href="brin.c.html#LN325"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN326"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN60"><span class='Ref_to_Member'>bo_bdesc</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN84"><span class='Ref_to_Proto'>brin_build_desc</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN323"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN325"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN326"><span class='Ref_To_Local'>opaque</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin.c.html#LN325"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Execute the index scan. 
 * 
 * This works by reading index TIDs from the revmap, and obtaining the index 
 * tuples pointed to by them; the summary values in the index tuples are 
 * compared to the scan keys.  We return into the TID bitmap all the pages in 
 * ranges corresponding to index tuples that match the scan keys. 
 * 
 * If a TID from the revmap is read as InvalidTID, we know that range is 
 * unsummarized.  Pages in those ranges need to be returned regardless of scan 
 * keys. 
 */ 
</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN352"></a><span class='Declare_Function'>bringetbitmap</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../nodes/tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN354"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>idxRel</span> <span class='Operator'>= </span><a href="brin.c.html#LN352"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN355"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN356"></a>    <a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>bdesc</span><span class='Delimiter'>; 
</span><a name="LN357"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>heapOid</span><span class='Delimiter'>; 
</span><a name="LN358"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>heapRel</span><span class='Delimiter'>; 
</span><a name="LN359"></a>    <a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN360"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblocks</span><span class='Delimiter'>; 
</span><a name="LN361"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>heapBlk</span><span class='Delimiter'>; 
</span><a name="LN362"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>totalpages</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN363"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>consistentFn</span><span class='Delimiter'>; 
</span><a name="LN364"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN365"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>perRangeCxt</span><span class='Delimiter'>; 
</span><a name="LN366"></a>    <a href="../../../include/access/brin_tuple.h.html#LN35"><span class='Ref_to_Struct'>BrinMemTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dtup</span><span class='Delimiter'>; 
</span><a name="LN367"></a>    <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>btup</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN368"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>btupsz</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN359"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN352"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN356"><span class='Ref_To_Local'>bdesc</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN359"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN60"><span class='Ref_to_Member'>bo_bdesc</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1262"><span class='Ref_to_Macro'>pgstat_count_index_scan</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN354"><span class='Ref_To_Local'>idxRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to know the size of the table so that we know how long to 
     * iterate on the revmap. 
     */ 
</span>    <a href="brin.c.html#LN357"><span class='Ref_To_Local'>heapOid</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN354"><span class='Ref_To_Local'>idxRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN358"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN357"><span class='Ref_To_Local'>heapOid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN360"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN358"><span class='Ref_To_Local'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN358"><span class='Ref_To_Local'>heapRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make room for the consistent support procedures of indexed columns.  We 
     * don't look them up here; we do that lazily the first time we see a scan 
     * key reference each of them.  We rely on zeroing fn_oid to InvalidOid. 
     */ 
</span>    <a href="brin.c.html#LN363"><span class='Ref_To_Local'>consistentFn</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="brin.c.html#LN356"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* allocate an initial in-memory tuple, out of the per-range memcxt */ 
</span>    <a href="brin.c.html#LN366"><span class='Ref_To_Local'>dtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN95"><span class='Ref_to_Proto'>brin_new_memtuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN356"><span class='Ref_To_Local'>bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup and use a per-range memory context, which is reset every time we 
     * loop below.  This avoids having to free the tuples within the loop. 
     */ 
</span>    <a href="brin.c.html#LN365"><span class='Ref_To_Local'>perRangeCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                        <span class='String'>"bringetbitmap cxt"</span><span class='Delimiter'>, 
</span>                                        <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN364"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN365"><span class='Ref_To_Local'>perRangeCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now scan the revmap.  We start by querying for heap page 0, 
     * incrementing by the number of pages per range; this gives us a full 
     * view of the table. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN361"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN361"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN360"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN361"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>+= </span><a href="brin.c.html#LN359"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN58"><span class='Ref_to_Member'>bo_pagesPerRange</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN409"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>addrange</span><span class='Delimiter'>; 
</span><a name="LN410"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>gottuple</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN411"></a>        <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN412"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN413"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN365"><span class='Ref_To_Local'>perRangeCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN411"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN35"><span class='Ref_to_Proto'>brinGetTupleForHeapBlock</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN359"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN59"><span class='Ref_to_Member'>bo_rmAccess</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN361"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN355"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="brin.c.html#LN412"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN413"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Delimiter'>, 
</span>                                       <a href="brin.c.html#LN352"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN411"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="brin.c.html#LN410"><span class='Ref_To_Local'>gottuple</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="brin.c.html#LN367"><span class='Ref_To_Local'>btup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN90"><span class='Ref_to_Proto'>brin_copy_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN411"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN413"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN367"><span class='Ref_To_Local'>btup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN368"><span class='Ref_To_Local'>btupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN355"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * For page ranges with no indexed tuple, we must return the whole 
         * range; otherwise, compare it to the scan keys. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN410"><span class='Ref_To_Local'>gottuple</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="brin.c.html#LN409"><span class='Ref_To_Local'>addrange</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="brin.c.html#LN366"><span class='Ref_To_Local'>dtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN98"><span class='Ref_to_Proto'>brin_deform_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN356"><span class='Ref_To_Local'>bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN367"><span class='Ref_To_Local'>btup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN366"><span class='Ref_To_Local'>dtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN366"><span class='Ref_To_Local'>dtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN37"><span class='Ref_to_Member'>bt_placeholder</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Placeholder tuples are always returned, regardless of the 
                 * values stored in them. 
                 */ 
</span>                <a href="brin.c.html#LN409"><span class='Ref_To_Local'>addrange</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN450"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>keyno</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Compare scan keys with summary values stored for the range. 
                 * If scan keys are matched, the page range must be added to 
                 * the bitmap.  We initially assume the range needs to be 
                 * added; in particular this serves the case where there are 
                 * no keys. 
                 */ 
</span>                <a href="brin.c.html#LN409"><span class='Ref_To_Local'>addrange</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN450"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN450"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN352"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN90"><span class='Ref_to_Member'>numberOfKeys</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN450"><span class='Ref_To_Local'>keyno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN462"></a>                    <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a>     <span class='Declare_Local'>key</span> <span class='Operator'>= &</span><a href="brin.c.html#LN352"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN92"><span class='Ref_to_Member'>keyData</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN450"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]; 
</span><a name="LN463"></a>                    <a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a>  <span class='Declare_Local'>keyattno</span> <span class='Operator'>= </span><a href="brin.c.html#LN462"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN66"><span class='Ref_to_Member'>sk_attno</span></a><span class='Delimiter'>; 
</span><a name="LN464"></a>                    <a href="../../../include/access/brin_tuple.h.html#LN23"><span class='Ref_to_Struct'>BrinValues</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bval</span> <span class='Operator'>= &</span><a href="brin.c.html#LN366"><span class='Ref_To_Local'>dtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN45"><span class='Ref_to_Member'>bt_columns</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN463"><span class='Ref_To_Local'>keyattno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN465"></a>                    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>add</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * The collation of the scan key must match the collation 
                     * used in the index column (but only if the search is not 
                     * IS NULL/ IS NOT NULL).  Otherwise we shouldn't be using 
                     * this index ... 
                     */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="brin.c.html#LN462"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN65"><span class='Ref_to_Member'>sk_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/skey.h.html#LN114"><span class='Ref_to_Const'>SK_ISNULL</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                           <span class='Parentheses'>(</span><a href="brin.c.html#LN462"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN69"><span class='Ref_to_Member'>sk_collation</span></a> <span class='Operator'>== 
</span>                      <a href="brin.c.html#LN356"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN463"><span class='Ref_To_Local'>keyattno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attcollation<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* First time this column? look up consistent function */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN363"><span class='Ref_To_Local'>consistentFn</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN463"><span class='Ref_To_Local'>keyattno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span><a name="LN480"></a>                        <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span> 
                        <a href="brin.c.html#LN480"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN354"><span class='Ref_To_Local'>idxRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN463"><span class='Ref_To_Local'>keyattno</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/access/brin_internal.h.html#LN68"><span class='Ref_to_Const'>BRIN_PROCNUM_CONSISTENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="brin.c.html#LN363"><span class='Ref_To_Local'>consistentFn</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN463"><span class='Ref_To_Local'>keyattno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="brin.c.html#LN480"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Check whether the scan key is consistent with the page 
                     * range values; if so, have the pages in the range added 
                     * to the output bitmap. 
                     * 
                     * When there are multiple scan keys, failure to meet the 
                     * criteria for a single one of them is enough to discard 
                     * the range as a whole, so break out of the loop as soon 
                     * as a false return value is obtained. 
                     */ 
</span>                    <a href="brin.c.html#LN465"><span class='Ref_To_Local'>add</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN514"><span class='Ref_to_Proto'>FunctionCall3Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="brin.c.html#LN363"><span class='Ref_To_Local'>consistentFn</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN463"><span class='Ref_To_Local'>keyattno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                                            <a href="brin.c.html#LN462"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN69"><span class='Ref_to_Member'>sk_collation</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN356"><span class='Ref_To_Local'>bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                            <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN464"><span class='Ref_To_Local'>bval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                            <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN462"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="brin.c.html#LN409"><span class='Ref_To_Local'>addrange</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN465"><span class='Ref_To_Local'>add</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN409"><span class='Ref_To_Local'>addrange</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for keyno=0;keyno&LT;scan-&GT;n... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* add the pages in the range to the output bitmap, if needed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN409"><span class='Ref_To_Local'>addrange</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN513"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN513"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN361"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>; 
</span>                 <a href="brin.c.html#LN513"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>&LT;= </span><a href="brin.c.html#LN361"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>+ </span><a href="brin.c.html#LN359"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN58"><span class='Ref_to_Member'>bo_pagesPerRange</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                 <a href="brin.c.html#LN513"><span class='Ref_To_Local'>pageno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN364"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/nodes/tidbitmap.h.html#LN57"><span class='Ref_to_Proto'>tbm_add_page</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN352"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN513"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="brin.c.html#LN362"><span class='Ref_To_Local'>totalpages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN365"><span class='Ref_To_Local'>perRangeCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for heapBlk=0;heapBlk&LT;nbl... &raquo; </span> 
 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN364"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN365"><span class='Ref_To_Local'>perRangeCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN355"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN355"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX We have an approximation of the number of *pages* that our scan 
     * returns, but we don't have a precise idea of the number of heap tuples 
     * involved. 
     */ 
</span>    <span class='Control'>return</span> <a href="brin.c.html#LN362"><span class='Ref_To_Local'>totalpages</span></a> <span class='Operator'>* </span><span class='Number'>10</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end bringetbitmap &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Re-initialize state for a BRIN index scan 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN545"></a><span class='Declare_Function'>brinrescan</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>scankey</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nscankeys</span><span class='Delimiter'>, 
</span><a name="LN546"></a>           <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>orderbys</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>norderbys</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Other index AMs preprocess the scan keys at this point, or sometime 
     * early during the scan; this lets them optimize by removing redundant 
     * keys, or doing early returns when they are impossible to satisfy; see 
     * _bt_preprocess_keys for an example.  Something like that could be added 
     * here someday, too. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN545"><span class='Ref_to_Parameter'>scankey</span></a> <span class='Operator'>&& </span><a href="brin.c.html#LN545"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN90"><span class='Ref_to_Member'>numberOfKeys</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN545"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN92"><span class='Ref_to_Member'>keyData</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN545"><span class='Ref_to_Parameter'>scankey</span></a><span class='Delimiter'>, 
</span>                <a href="brin.c.html#LN545"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN90"><span class='Ref_to_Member'>numberOfKeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Close down a BRIN index scan 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN565"></a><span class='Declare_Function'>brinendscan</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN567"></a>    <a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="brin.c.html#LN56"><span class='Ref_to_Struct'>BrinOpaque</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN565"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_revmap.h.html#LN27"><span class='Ref_to_Proto'>brinRevmapTerminate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN567"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN59"><span class='Ref_to_Member'>bo_rmAccess</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/brin_internal.h.html#LN85"><span class='Ref_to_Proto'>brin_free_desc</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN567"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN60"><span class='Ref_to_Member'>bo_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN567"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Per-heap-tuple callback for IndexBuildHeapScan. 
 * 
 * Note we don't worry about the page range at the end of the table here; it is 
 * present in the build state struct after we're called the last time, but not 
 * inserted into the index.  Caller must ensure to do so, if appropriate. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN582"></a><span class='Declare_Function'>brinbuildCallback</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN583"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>htup</span><span class='Delimiter'>, 
</span><a name="LN584"></a>                  <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, 
</span><a name="LN585"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN586"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>tupleIsAlive</span><span class='Delimiter'>, 
</span><a name="LN587"></a>                  <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>brstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN589"></a>    <a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN587"><span class='Ref_to_Parameter'>brstate</span></a><span class='Delimiter'>; 
</span><a name="LN590"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>thisblock</span><span class='Delimiter'>; 
</span><a name="LN591"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN590"><span class='Ref_To_Local'>thisblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="brin.c.html#LN583"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're in a block that belongs to a future range, summarize what 
     * we've got and start afresh.  Note the scan might have skipped many 
     * pages, if they were devoid of live tuples; make sure to insert index 
     * tuples for those too. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN590"><span class='Ref_To_Local'>thisblock</span></a> <span class='Operator'>&GT; </span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a> <span class='Operator'>+ </span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <a href="../../../include/access/brin_internal.h.html#LN78"><span class='Ref_to_Macro'>BRIN_elog</span></a><span class='Parentheses'>((</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"brinbuildCallback: completed a range: %u--%u"</span><span class='Delimiter'>, 
</span>                   <a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a><span class='Delimiter'>, 
</span>                   <a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a> <span class='Operator'>+ </span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* create the index tuple and insert it */ 
</span>        <a href="brin.c.html#LN70"><span class='Ref_to_Proto'>form_and_insert_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* set state to correspond to the next range */ 
</span>        <a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a> <span class='Operator'>+= </span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* re-initialize state for it */ 
</span>        <a href="../../../include/access/brin_tuple.h.html#LN96"><span class='Ref_to_Proto'>brin_memtuple_initialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Accumulate the current tuple into the running state */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN622"></a>        <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>addValue</span><span class='Delimiter'>; 
</span><a name="LN623"></a>        <a href="../../../include/access/brin_tuple.h.html#LN23"><span class='Ref_to_Struct'>BrinValues</span></a> <span class='Operator'>*</span><span class='Declare_Local'>col</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN623"><span class='Ref_To_Local'>col</span></a> <span class='Operator'>= &</span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN45"><span class='Ref_to_Member'>bt_columns</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="brin.c.html#LN622"><span class='Ref_To_Local'>addValue</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN582"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                     <a href="../../../include/access/brin_internal.h.html#LN67"><span class='Ref_to_Const'>BRIN_PROCNUM_ADDVALUE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update dtuple state, if and as necessary. 
         */ 
</span>        <a href="../../../include/fmgr.h.html#LN517"><span class='Ref_to_Proto'>FunctionCall4Coll</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN622"><span class='Ref_To_Local'>addValue</span></a><span class='Delimiter'>, 
</span>                          <a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN589"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN623"><span class='Ref_To_Local'>col</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="brin.c.html#LN584"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="brin.c.html#LN585"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN591"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end brinbuildCallback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * brinbuild() -- build a new BRIN index. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>* 
</span><a name="LN644"></a><span class='Declare_Function'>brinbuild</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heap</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN646"></a>    <a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN647"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>reltuples</span><span class='Delimiter'>; 
</span><a name="LN648"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>idxtuples</span><span class='Delimiter'>; 
</span><a name="LN649"></a>    <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Local'>revmap</span><span class='Delimiter'>; 
</span><a name="LN650"></a>    <a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN651"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>meta</span><span class='Delimiter'>; 
</span><a name="LN652"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pagesPerRange</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We expect to be called exactly once for any index relation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"index \"%s\" already contains data"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Critical section not required, because on error the creation of the 
     * whole relation will be rolled back. 
     */ 
</span> 
    <a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/brin_page.h.html#LN74"><span class='Ref_to_Const'>BRIN_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_pageops.h.html#LN28"><span class='Ref_to_Proto'>brin_metapage_init</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/brin.h.html#LN39"><span class='Ref_to_Macro'>BrinGetPagesPerRange</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/brin_page.h.html#LN71"><span class='Ref_to_Const'>BRIN_CURRENT_VERSION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN676"></a>        <a href="../../../include/access/brin_xlog.h.html#LN49"><span class='Ref_to_Struct'>xl_brin_createidx</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN677"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN678"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN676"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN52"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_page.h.html#LN71"><span class='Ref_to_Const'>BRIN_CURRENT_VERSION</span></a><span class='Delimiter'>; 
</span>        <a href="brin.c.html#LN676"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN51"><span class='Ref_to_Member'>pagesPerRange</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin.h.html#LN39"><span class='Ref_to_Macro'>BrinGetPagesPerRange</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="brin.c.html#LN676"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_xlog.h.html#LN54"><span class='Ref_to_Const'>SizeOfBrinCreateIdx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN677"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BRIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/brin_xlog.h.html#LN30"><span class='Ref_to_Const'>XLOG_BRIN_CREATE_INDEX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN678"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN678"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN677"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN651"><span class='Ref_To_Local'>meta</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize our state, including the deformed tuple state. 
     */ 
</span>    <a href="brin.c.html#LN649"><span class='Ref_To_Local'>revmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN25"><span class='Ref_to_Proto'>brinRevmapInitialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN652"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN650"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN65"><span class='Ref_to_Proto'>initialize_brin_buildstate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN649"><span class='Ref_To_Local'>revmap</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN652"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now scan the relation.  No syncscan allowed here because we want the 
     * heap blocks in physical order. 
     */ 
</span>    <a href="brin.c.html#LN647"><span class='Ref_To_Local'>reltuples</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN97"><span class='Ref_to_Proto'>IndexBuildHeapScan</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN644"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                   <a href="brin.c.html#LN581"><span class='Ref_to_Func'>brinbuildCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN650"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* process the final batch */ 
</span>    <a href="brin.c.html#LN70"><span class='Ref_to_Proto'>form_and_insert_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN650"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release resources */ 
</span>    <a href="brin.c.html#LN648"><span class='Ref_To_Local'>idxtuples</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN650"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN44"><span class='Ref_to_Member'>bs_numtuples</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/brin_revmap.h.html#LN27"><span class='Ref_to_Proto'>brinRevmapTerminate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN650"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN48"><span class='Ref_to_Member'>bs_rmAccess</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN67"><span class='Ref_to_Proto'>terminate_brin_buildstate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN650"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return statistics 
     */ 
</span>    <a href="brin.c.html#LN646"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN646"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN31"><span class='Ref_to_Member'>heap_tuples</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN647"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN646"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN32"><span class='Ref_to_Member'>index_tuples</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN648"><span class='Ref_To_Local'>idxtuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin.c.html#LN646"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brinbuild &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN728"></a><span class='Declare_Function'>brinbuildempty</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN730"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* An empty BRIN index has a metapage only. */ 
</span>    <a href="brin.c.html#LN730"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN728"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN730"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize and xlog metabuffer. */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/brin_pageops.h.html#LN28"><span class='Ref_to_Proto'>brin_metapage_init</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN730"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/brin.h.html#LN39"><span class='Ref_to_Macro'>BrinGetPagesPerRange</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN728"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/brin_page.h.html#LN71"><span class='Ref_to_Const'>BRIN_CURRENT_VERSION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN730"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN56"><span class='Ref_to_Proto'>log_newpage_buffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN730"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN730"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brinbuildempty &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * brinbulkdelete 
 *      Since there are no per-heap-tuple index tuples in BRIN indexes, 
 *      there's not a lot we can do here. 
 * 
 * XXX we could mark item tuples as "dirty" (when a minimum or maximum heap 
 * tuple is deleted), meaning the need to re-run summarization on the affected 
 * range.  Would need to add an extra flag in brintuples for that. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>* 
</span><a name="LN758"></a><span class='Declare_Function'>brinbulkdelete</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN43"><span class='Ref_to_Struct'>IndexVacuumInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Delimiter'>, 
</span><a name="LN759"></a>               <a href="../../../include/access/genam.h.html#LN82"><span class='Ref_to_Typedef'>IndexBulkDeleteCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>callback_state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* allocate stats if first time through, else re-use existing struct */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN758"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="brin.c.html#LN758"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin.c.html#LN758"><span class='Ref_to_Parameter'>stats</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This routine is in charge of "vacuuming" a BRIN index: we just summarize 
 * ranges that are currently unsummarized. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>* 
</span><a name="LN773"></a><span class='Declare_Function'>brinvacuumcleanup</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN43"><span class='Ref_to_Struct'>IndexVacuumInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN775"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>heapRel</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No-op in ANALYZE ONLY mode */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN46"><span class='Ref_to_Member'>analyze_only</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a><span class='Parentheses'>) 
</span>        <a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN72"><span class='Ref_to_Member'>num_pages</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* rest of stats is initialized by zeroing */ 
</span> 
    <a href="brin.c.html#LN775"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN73"><span class='Ref_to_Proto'>brin_vacuum_scan</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN50"><span class='Ref_to_Member'>strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN68"><span class='Ref_to_Proto'>brinsummarize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN775"><span class='Ref_To_Local'>heapRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN63"><span class='Ref_to_Const'>BRIN_ALL_BLOCKRANGES</span></a><span class='Delimiter'>, 
</span>                  <span class='Operator'>&</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN75"><span class='Ref_to_Member'>num_index_tuples</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN75"><span class='Ref_to_Member'>num_index_tuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN775"><span class='Ref_To_Local'>heapRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin.c.html#LN773"><span class='Ref_to_Parameter'>stats</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brinvacuumcleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * reloptions processor for BRIN indexes 
 */ 
</span><a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>* 
</span><a name="LN803"></a><span class='Declare_Function'>brinoptions</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>validate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN805"></a>    <a href="../../../include/access/reloptions.h.html#LN73"><span class='Ref_to_Struct'>relopt_value</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span><span class='Delimiter'>; 
</span><a name="LN806"></a>    <a href="../../../include/access/brin.h.html#LN20"><span class='Ref_to_Struct'>BrinOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rdopts</span><span class='Delimiter'>; 
</span><a name="LN807"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numoptions</span><span class='Delimiter'>; 
</span><a name="LN808"></a>    <span class='Keyword'>static const </span><a href="../../../include/access/reloptions.h.html#LN122"><span class='Ref_to_Typedef'>relopt_parse_elt</span></a> <span class='Declare_Local'>tab</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Delimiter'>{</span><span class='String'>"pages_per_range"</span><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN31"><span class='Ref_to_EnumConst'>RELOPT_TYPE_INT</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/brin.h.html#LN20"><span class='Ref_to_Struct'>BrinOptions</span></a><span class='Delimiter'>, </span>pagesPerRange<span class='Parentheses'>)</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"autosummarize"</span><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN30"><span class='Ref_to_EnumConst'>RELOPT_TYPE_BOOL</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/brin.h.html#LN20"><span class='Ref_to_Struct'>BrinOptions</span></a><span class='Delimiter'>, </span>autosummarize<span class='Parentheses'>)</span><span class='Delimiter'>} 
</span>    <span class='Delimiter'>}; 
</span> 
    <a href="brin.c.html#LN805"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>= </span><a href="../../../include/access/reloptions.h.html#LN263"><span class='Ref_to_Proto'>parseRelOptions</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN803"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN803"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN49"><span class='Ref_to_EnumConst'>RELOPT_KIND_BRIN</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="brin.c.html#LN807"><span class='Ref_To_Local'>numoptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if none set, we're done */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN807"><span class='Ref_To_Local'>numoptions</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN806"><span class='Ref_To_Local'>rdopts</span></a> <span class='Operator'>= </span><a href="../../../include/access/reloptions.h.html#LN265"><span class='Ref_to_Proto'>allocateReloptStruct</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/brin.h.html#LN20"><span class='Ref_to_Struct'>BrinOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="brin.c.html#LN805"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN807"><span class='Ref_To_Local'>numoptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/reloptions.h.html#LN267"><span class='Ref_to_Proto'>fillRelOptions</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN806"><span class='Ref_To_Local'>rdopts</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/brin.h.html#LN20"><span class='Ref_to_Struct'>BrinOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="brin.c.html#LN805"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN807"><span class='Ref_To_Local'>numoptions</span></a><span class='Delimiter'>, 
</span>                   <a href="brin.c.html#LN803"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN808"><span class='Ref_To_Local'>tab</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN808"><span class='Ref_To_Local'>tab</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN805"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN806"><span class='Ref_To_Local'>rdopts</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brinoptions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL-callable function to scan through an index and summarize all ranges 
 * that are not currently summarized. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN835"></a><span class='Declare_Function'>brin_summarize_new_values</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN837"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>relation</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/fmgr.h.html#LN585"><span class='Ref_to_Macro'>DirectFunctionCall2</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN849"><span class='Ref_to_Func'>brin_summarize_range</span></a><span class='Delimiter'>, 
</span>                               <a href="brin.c.html#LN837"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/postgres.h.html#LN624"><span class='Ref_to_Macro'>Int64GetDatum</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="brin.c.html#LN63"><span class='Ref_to_Const'>BRIN_ALL_BLOCKRANGES</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SQL-callable function to summarize the indicated page range, if not already 
 * summarized.  If the second argument is BRIN_ALL_BLOCKRANGES, all 
 * unsummarized ranges are summarized. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN850"></a><span class='Declare_Function'>brin_summarize_range</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN852"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indexoid</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN239"><span class='Ref_to_Macro'>PG_GETARG_OID</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN853"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>heapBlk64</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN246"><span class='Ref_to_Macro'>PG_GETARG_INT64</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN854"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>heapBlk</span><span class='Delimiter'>; 
</span><a name="LN855"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>heapoid</span><span class='Delimiter'>; 
</span><a name="LN856"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRel</span><span class='Delimiter'>; 
</span><a name="LN857"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>heapRel</span><span class='Delimiter'>; 
</span><a name="LN858"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>numSummarized</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN853"><span class='Ref_To_Local'>heapBlk64</span></a> <span class='Operator'>&GT; </span><a href="brin.c.html#LN63"><span class='Ref_to_Const'>BRIN_ALL_BLOCKRANGES</span></a> <span class='Operator'>|| </span><a href="brin.c.html#LN853"><span class='Ref_To_Local'>heapBlk64</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN862"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>blk</span> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN853"><span class='Ref_To_Local'>heapBlk64</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"block number out of range: %s"</span><span class='Delimiter'>, </span><a href="brin.c.html#LN862"><span class='Ref_To_Local'>blk</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="brin.c.html#LN854"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><a href="brin.c.html#LN853"><span class='Ref_To_Local'>heapBlk64</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must lock table before index to avoid deadlocks.  However, if the 
     * passed indexoid isn't an index then IndexGetRelation() will fail. 
     * Rather than emitting a not-very-helpful error message, postpone 
     * complaining, expecting that the is-it-an-index test below will fail. 
     */ 
</span>    <a href="brin.c.html#LN855"><span class='Ref_To_Local'>heapoid</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN852"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN855"><span class='Ref_To_Local'>heapoid</span></a><span class='Parentheses'>))</span> 
        <a href="brin.c.html#LN857"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN855"><span class='Ref_To_Local'>heapoid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="brin.c.html#LN857"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN852"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be a BRIN index */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a> <span class='Operator'>|| 
</span>        <a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relam <span class='Operator'>!= </span><a href="../../../include/catalog/pg_am.h.html#LN84"><span class='Ref_to_Const'>BRIN_AM_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a BRIN index"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* User must own the index (comparable to privileges needed for VACUUM) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN852"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we did the IndexGetRelation call above without any lock, it's 
     * barely possible that a race against an index drop/recreation could have 
     * netted us the wrong table.  Recheck. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN857"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="brin.c.html#LN855"><span class='Ref_To_Local'>heapoid</span></a> <span class='Operator'>!= </span><a href="../../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN852"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../../bin/scripts/vacuumdb.c.html#LN25"><span class='Ref_to_Const'>ERRCODE_UNDEFINED_TABLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open parent table of index %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, do it */ 
</span>    <a href="brin.c.html#LN68"><span class='Ref_to_Proto'>brinsummarize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN857"><span class='Ref_To_Local'>heapRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN854"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN858"><span class='Ref_To_Local'>numSummarized</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN856"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN857"><span class='Ref_To_Local'>heapRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN313"><span class='Ref_to_Macro'>PG_RETURN_INT32</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><a href="brin.c.html#LN858"><span class='Ref_To_Local'>numSummarized</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_summarize_range &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL-callable interface to mark a range as no longer summarized 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN921"></a><span class='Declare_Function'>brin_desummarize_range</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN923"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indexoid</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN239"><span class='Ref_to_Macro'>PG_GETARG_OID</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN924"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>heapBlk64</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN246"><span class='Ref_to_Macro'>PG_GETARG_INT64</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN925"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>heapBlk</span><span class='Delimiter'>; 
</span><a name="LN926"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>heapoid</span><span class='Delimiter'>; 
</span><a name="LN927"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>heapRel</span><span class='Delimiter'>; 
</span><a name="LN928"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRel</span><span class='Delimiter'>; 
</span><a name="LN929"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>done</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN924"><span class='Ref_To_Local'>heapBlk64</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/block.h.html#LN34"><span class='Ref_to_Const'>MaxBlockNumber</span></a> <span class='Operator'>|| </span><a href="brin.c.html#LN924"><span class='Ref_To_Local'>heapBlk64</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN933"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>blk</span> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN924"><span class='Ref_To_Local'>heapBlk64</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"block number out of range: %s"</span><span class='Delimiter'>, </span><a href="brin.c.html#LN933"><span class='Ref_To_Local'>blk</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="brin.c.html#LN925"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><a href="brin.c.html#LN924"><span class='Ref_To_Local'>heapBlk64</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must lock table before index to avoid deadlocks.  However, if the 
     * passed indexoid isn't an index then IndexGetRelation() will fail. 
     * Rather than emitting a not-very-helpful error message, postpone 
     * complaining, expecting that the is-it-an-index test below will fail. 
     */ 
</span>    <a href="brin.c.html#LN926"><span class='Ref_To_Local'>heapoid</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN923"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN926"><span class='Ref_To_Local'>heapoid</span></a><span class='Parentheses'>))</span> 
        <a href="brin.c.html#LN927"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN926"><span class='Ref_To_Local'>heapoid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="brin.c.html#LN927"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN923"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be a BRIN index */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a> <span class='Operator'>|| 
</span>        <a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relam <span class='Operator'>!= </span><a href="../../../include/catalog/pg_am.h.html#LN84"><span class='Ref_to_Const'>BRIN_AM_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a BRIN index"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* User must own the index (comparable to privileges needed for VACUUM) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN923"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we did the IndexGetRelation call above without any lock, it's 
     * barely possible that a race against an index drop/recreation could have 
     * netted us the wrong table.  Recheck. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN927"><span class='Ref_To_Local'>heapRel</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="brin.c.html#LN926"><span class='Ref_To_Local'>heapoid</span></a> <span class='Operator'>!= </span><a href="../../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN923"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../../bin/scripts/vacuumdb.c.html#LN25"><span class='Ref_to_Const'>ERRCODE_UNDEFINED_TABLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open parent table of index %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* the revmap does the hard work */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="brin.c.html#LN929"><span class='Ref_To_Local'>done</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN38"><span class='Ref_to_Proto'>brinRevmapDesummarizeRange</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN925"><span class='Ref_To_Local'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN929"><span class='Ref_To_Local'>done</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN928"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN927"><span class='Ref_To_Local'>heapRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN308"><span class='Ref_to_Macro'>PG_RETURN_VOID</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_desummarize_range &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build a BrinDesc used to create or scan a BRIN index 
 */ 
</span><a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a> <span class='Operator'>* 
</span><a name="LN996"></a><span class='Declare_Function'>brin_build_desc</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN998"></a>    <a href="../../../include/access/brin_internal.h.html#LN24"><span class='Ref_to_Struct'>BrinOpcInfo</span></a> <span class='Operator'>**</span><span class='Declare_Local'>opcinfo</span><span class='Delimiter'>; 
</span><a name="LN999"></a>    <a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>bdesc</span><span class='Delimiter'>; 
</span><a name="LN1000"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1001"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>totalstored</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1002"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>keyno</span><span class='Delimiter'>; 
</span><a name="LN1003"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>totalsize</span><span class='Delimiter'>; 
</span><a name="LN1004"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>cxt</span><span class='Delimiter'>; 
</span><a name="LN1005"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1004"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                <span class='String'>"brin desc cxt"</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1005"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1004"><span class='Ref_To_Local'>cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN996"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Obtain BrinOpcInfo for each indexed column.  While at it, accumulate 
     * the number of columns stored, since the number is opclass-defined. 
     */ 
</span>    <a href="brin.c.html#LN998"><span class='Ref_To_Local'>opcinfo</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN24"><span class='Ref_to_Struct'>BrinOpcInfo</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN24"><span class='Ref_to_Struct'>BrinOpcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1020"></a>        <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>opcInfoFn</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN1020"><span class='Ref_To_Local'>opcInfoFn</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN996"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/brin_internal.h.html#LN66"><span class='Ref_to_Const'>BRIN_PROCNUM_OPCINFO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN998"><span class='Ref_To_Local'>opcinfo</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN24"><span class='Ref_to_Struct'>BrinOpcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN601"><span class='Ref_to_Macro'>FunctionCall1</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1020"><span class='Ref_To_Local'>opcInfoFn</span></a><span class='Delimiter'>, 
</span>                                          <a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="brin.c.html#LN1001"><span class='Ref_To_Local'>totalstored</span></a> <span class='Operator'>+= </span><a href="brin.c.html#LN998"><span class='Ref_To_Local'>opcinfo</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN27"><span class='Ref_to_Member'>oi_nstored</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate our result struct and fill it in */ 
</span>    <a href="brin.c.html#LN1003"><span class='Ref_To_Local'>totalsize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a><span class='Delimiter'>, </span>bd_info<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN24"><span class='Ref_to_Struct'>BrinOpcInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1003"><span class='Ref_To_Local'>totalsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN43"><span class='Ref_to_Member'>bd_context</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1004"><span class='Ref_To_Local'>cxt</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN46"><span class='Ref_to_Member'>bd_index</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN996"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN52"><span class='Ref_to_Member'>bd_disktdesc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* generated lazily */ 
</span>    <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN55"><span class='Ref_to_Member'>bd_totalstored</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1001"><span class='Ref_To_Local'>totalstored</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN1000"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN58"><span class='Ref_to_Member'>bd_info</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="brin.c.html#LN998"><span class='Ref_To_Local'>opcinfo</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1002"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN998"><span class='Ref_To_Local'>opcinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1005"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin.c.html#LN999"><span class='Ref_To_Local'>bdesc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_build_desc &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN1051"></a><span class='Declare_Function'>brin_free_desc</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* make sure the tupdesc is still valid */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="brin.c.html#LN1051"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN79"><span class='Ref_to_Member'>tdrefcount</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* no need for retail pfree */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1051"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN43"><span class='Ref_to_Member'>bd_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fetch index's statistical data into *stats 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1063"></a><span class='Declare_Function'>brinGetStats</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/brin.h.html#LN31"><span class='Ref_to_Struct'>BrinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1065"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuffer</span><span class='Delimiter'>; 
</span><a name="LN1066"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapage</span><span class='Delimiter'>; 
</span><a name="LN1067"></a>    <a href="../../../include/access/brin_page.h.html#LN63"><span class='Ref_to_Struct'>BrinMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1065"><span class='Ref_To_Local'>metabuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1063"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_page.h.html#LN74"><span class='Ref_to_Const'>BRIN_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1065"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1066"><span class='Ref_To_Local'>metapage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1065"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1067"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN63"><span class='Ref_to_Struct'>BrinMetaPageData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1066"><span class='Ref_To_Local'>metapage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1063"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin.h.html#LN33"><span class='Ref_to_Member'>pagesPerRange</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1067"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_page.h.html#LN67"><span class='Ref_to_Member'>pagesPerRange</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1063"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin.h.html#LN34"><span class='Ref_to_Member'>revmapNumPages</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1067"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_page.h.html#LN68"><span class='Ref_to_Member'>lastRevmapPage</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1065"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize a BrinBuildState appropriate to create tuples on the given index. 
 */ 
</span><span class='Keyword'>static </span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>* 
</span><a name="LN1084"></a><span class='Declare_Function'>initialize_brin_buildstate</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxRel</span><span class='Delimiter'>, </span><a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>revmap</span><span class='Delimiter'>, 
</span><a name="LN1085"></a>                           <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pagesPerRange</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1087"></a>    <a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN43"><span class='Ref_to_Member'>bs_irel</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1084"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN44"><span class='Ref_to_Member'>bs_numtuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN45"><span class='Ref_to_Member'>bs_currentInsertBuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1085"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN48"><span class='Ref_to_Member'>bs_rmAccess</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1084"><span class='Ref_to_Parameter'>revmap</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_internal.h.html#LN84"><span class='Ref_to_Proto'>brin_build_desc</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1084"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN95"><span class='Ref_to_Proto'>brin_new_memtuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_tuple.h.html#LN96"><span class='Ref_to_Proto'>brin_memtuple_initialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin.c.html#LN1087"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initialize_brin_buildstate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Release resources associated with a BrinBuildState. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1109"></a><span class='Declare_Function'>terminate_brin_buildstate</span><span class='Parentheses'>(</span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* release the last index buffer used */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/buf.h.html#LN30"><span class='Ref_to_Macro'>BufferIsInvalid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN45"><span class='Ref_to_Member'>bs_currentInsertBuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1114"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN1114"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN45"><span class='Ref_to_Member'>bs_currentInsertBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN43"><span class='Ref_to_Member'>bs_irel</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN45"><span class='Ref_to_Member'>bs_currentInsertBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1114"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN45"><span class='Ref_to_Member'>bs_currentInsertBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/access/brin_internal.h.html#LN85"><span class='Ref_to_Proto'>brin_free_desc</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1109"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Summarize the given page range of the given index. 
 * 
 * This routine can run in parallel with insertions into the heap.  To avoid 
 * missing those values from the summary tuple, we first insert a placeholder 
 * index tuple into the index, then execute the heap scan; transactions 
 * concurrent with the scan update the placeholder tuple.  After the scan, we 
 * union the placeholder tuple with the one computed by this routine.  The 
 * update of the index value happens in a loop, so that if somebody updates 
 * the placeholder tuple after we read it, we detect the case and try again. 
 * This ensures that the concurrently inserted tuples are not lost. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1141"></a><span class='Declare_Function'>summarize_range</span><span class='Parentheses'>(</span><a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Delimiter'>, </span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, 
</span><a name="LN1142"></a>                <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapNumBlks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1144"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>phbuf</span><span class='Delimiter'>; 
</span><a name="LN1145"></a>    <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>phtup</span><span class='Delimiter'>; 
</span><a name="LN1146"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>phsz</span><span class='Delimiter'>; 
</span><a name="LN1147"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN1148"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>scanNumBlks</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insert the placeholder tuple 
     */ 
</span>    <a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN87"><span class='Ref_to_Proto'>brin_form_placeholder_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1146"><span class='Ref_To_Local'>phsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1147"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_pageops.h.html#LN23"><span class='Ref_to_Proto'>brin_doinsert</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN43"><span class='Ref_to_Member'>bs_irel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a><span class='Delimiter'>, 
</span>                           <a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN48"><span class='Ref_to_Member'>bs_rmAccess</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a><span class='Delimiter'>, 
</span>                           <a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1146"><span class='Ref_To_Local'>phsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Execute the partial heap scan covering the heap blocks in the specified 
     * page range, summarizing the heap tuples in it.  This scan stops just 
     * short of brinbuildCallback creating the new index entry. 
     * 
     * Note that it is critical we use the "any visible" mode of 
     * IndexBuildHeapRangeScan here: otherwise, we would miss tuples inserted 
     * by transactions that are still in progress, among other corner cases. 
     */ 
</span>    <a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1148"><span class='Ref_To_Local'>scanNumBlks</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a> <span class='Operator'>+ </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a> <span class='Operator'>&LT;= </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapNumBlks</span></a> <span class='Operator'>? 
</span>        <a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a> <span class='Operator'>: </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapNumBlks</span></a> <span class='Operator'>- </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/index.h.html#LN103"><span class='Ref_to_Proto'>IndexBuildHeapRangeScan</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN43"><span class='Ref_to_Member'>bs_irel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                            <a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1148"><span class='Ref_To_Local'>scanNumBlks</span></a><span class='Delimiter'>, 
</span>                            <a href="brin.c.html#LN581"><span class='Ref_to_Func'>brinbuildCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we update the values obtained by the scan with the placeholder 
     * tuple.  We do this in a loop which only terminates if we're able to 
     * update the placeholder tuple successfully; if we are not, this means 
     * somebody else modified the placeholder tuple after we read it. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1183"></a>        <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN1184"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newsize</span><span class='Delimiter'>; 
</span><a name="LN1185"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>didupdate</span><span class='Delimiter'>; 
</span><a name="LN1186"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>samepage</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update the summary tuple and try to update. 
         */ 
</span>        <a href="brin.c.html#LN1183"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN85"><span class='Ref_to_Proto'>brin_form_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Delimiter'>, 
</span>                                 <a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1184"><span class='Ref_To_Local'>newsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="brin.c.html#LN1186"><span class='Ref_To_Local'>samepage</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_pageops.h.html#LN21"><span class='Ref_to_Proto'>brin_can_do_samepage_update</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1146"><span class='Ref_To_Local'>phsz</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1184"><span class='Ref_To_Local'>newsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="brin.c.html#LN1185"><span class='Ref_To_Local'>didupdate</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/access/brin_pageops.h.html#LN15"><span class='Ref_to_Proto'>brin_doupdate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN43"><span class='Ref_to_Member'>bs_irel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a><span class='Delimiter'>, 
</span>                          <a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN48"><span class='Ref_to_Member'>bs_rmAccess</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1147"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, 
</span>                          <a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1146"><span class='Ref_To_Local'>phsz</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1183"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1184"><span class='Ref_To_Local'>newsize</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1186"><span class='Ref_To_Local'>samepage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/brin_tuple.h.html#LN89"><span class='Ref_to_Proto'>brin_free_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/brin_tuple.h.html#LN89"><span class='Ref_to_Proto'>brin_free_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1183"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If the update succeeded, we're done. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1185"><span class='Ref_To_Local'>didupdate</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the update didn't work, it might be because somebody updated the 
         * placeholder tuple concurrently.  Extract the new version, union it 
         * with the values we have from the scan, and start over.  (There are 
         * other reasons for the update to fail, but it's simple to treat them 
         * the same.) 
         */ 
</span>        <a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN35"><span class='Ref_to_Proto'>brinGetTupleForHeapBlock</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN48"><span class='Ref_to_Member'>bs_rmAccess</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1142"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="brin.c.html#LN1147"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1146"><span class='Ref_To_Local'>phsz</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Delimiter'>, 
</span>                                         <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* the placeholder tuple must exist */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing placeholder tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN90"><span class='Ref_to_Proto'>brin_copy_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1146"><span class='Ref_To_Local'>phsz</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* merge it into the tuple from the heap scan */ 
</span>        <a href="brin.c.html#LN71"><span class='Ref_to_Proto'>union_tuples</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1141"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1145"><span class='Ref_To_Local'>phtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1144"><span class='Ref_To_Local'>phbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end summarize_range &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Summarize page ranges that are not already summarized.  If pageRange is 
 * BRIN_ALL_BLOCKRANGES then the whole table is scanned; otherwise, only the 
 * page range containing the given heap page number is scanned. 
 * 
 * For each new index tuple inserted, *numSummarized (if not NULL) is 
 * incremented; for each existing tuple, *numExisting (if not NULL) is 
 * incremented. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1240"></a><span class='Declare_Function'>brinsummarize</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageRange</span><span class='Delimiter'>, 
</span><a name="LN1241"></a>              <span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>numSummarized</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>numExisting</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1243"></a>    <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Local'>revmap</span><span class='Delimiter'>; 
</span><a name="LN1244"></a>    <a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1245"></a>    <a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indexInfo</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1246"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>heapNumBlocks</span><span class='Delimiter'>; 
</span><a name="LN1247"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>heapBlk</span><span class='Delimiter'>; 
</span><a name="LN1248"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pagesPerRange</span><span class='Delimiter'>; 
</span><a name="LN1249"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1250"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>startBlk</span><span class='Delimiter'>; 
</span><a name="LN1251"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>endBlk</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* determine range of pages to process; nothing to do for an empty table */ 
</span>    <a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1243"><span class='Ref_To_Local'>revmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN25"><span class='Ref_to_Proto'>brinRevmapInitialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1248"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>pageRange</span></a> <span class='Operator'>== </span><a href="brin.c.html#LN63"><span class='Ref_to_Const'>BRIN_ALL_BLOCKRANGES</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="brin.c.html#LN1250"><span class='Ref_To_Local'>startBlk</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="brin.c.html#LN1251"><span class='Ref_To_Local'>endBlk</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="brin.c.html#LN1250"><span class='Ref_To_Local'>startBlk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>pageRange</span></a> <span class='Operator'>/ </span><a href="brin.c.html#LN1248"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="brin.c.html#LN1248"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Nothing to do if start point is beyond end of table */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1250"><span class='Ref_To_Local'>startBlk</span></a> <span class='Operator'>&GT; </span><a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/brin_revmap.h.html#LN27"><span class='Ref_to_Proto'>brinRevmapTerminate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1243"><span class='Ref_To_Local'>revmap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="brin.c.html#LN1251"><span class='Ref_To_Local'>endBlk</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1250"><span class='Ref_To_Local'>startBlk</span></a> <span class='Operator'>+ </span><a href="brin.c.html#LN1248"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1251"><span class='Ref_To_Local'>endBlk</span></a> <span class='Operator'>&GT; </span><a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a><span class='Parentheses'>) 
</span>            <a href="brin.c.html#LN1251"><span class='Ref_To_Local'>endBlk</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the revmap to find unsummarized items. 
     */ 
</span>    <a href="brin.c.html#LN1249"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1247"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN1250"><span class='Ref_To_Local'>startBlk</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN1247"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN1251"><span class='Ref_To_Local'>endBlk</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN1247"><span class='Ref_To_Local'>heapBlk</span></a> <span class='Operator'>+= </span><a href="brin.c.html#LN1248"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1285"></a>        <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN1286"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN1285"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN35"><span class='Ref_to_Proto'>brinGetTupleForHeapBlock</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1243"><span class='Ref_To_Local'>revmap</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1247"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1249"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1286"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                       <a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1285"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* no revmap entry for this heap range. Summarize it. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* first time through */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin.c.html#LN1245"><span class='Ref_To_Local'>indexInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="brin.c.html#LN65"><span class='Ref_to_Proto'>initialize_brin_buildstate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1243"><span class='Ref_To_Local'>revmap</span></a><span class='Delimiter'>, 
</span>                                                   <a href="brin.c.html#LN1248"><span class='Ref_To_Local'>pagesPerRange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="brin.c.html#LN1245"><span class='Ref_To_Local'>indexInfo</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN81"><span class='Ref_to_Proto'>BuildIndexInfo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="brin.c.html#LN1140"><span class='Ref_to_Func'>summarize_range</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1245"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1240"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1247"><span class='Ref_To_Local'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1246"><span class='Ref_To_Local'>heapNumBlocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* and re-initialize state for the next range */ 
</span>            <a href="../../../include/access/brin_tuple.h.html#LN96"><span class='Ref_to_Proto'>brin_memtuple_initialize</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1241"><span class='Ref_to_Parameter'>numSummarized</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="brin.c.html#LN1241"><span class='Ref_to_Parameter'>numSummarized</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1241"><span class='Ref_to_Parameter'>numExisting</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="brin.c.html#LN1241"><span class='Ref_to_Parameter'>numExisting</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1249"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for heapBlk=startBlk;heap... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1249"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1249"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* free resources */ 
</span>    <a href="../../../include/access/brin_revmap.h.html#LN27"><span class='Ref_to_Proto'>brinRevmapTerminate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1243"><span class='Ref_To_Local'>revmap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="brin.c.html#LN67"><span class='Ref_to_Proto'>terminate_brin_buildstate</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1244"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1245"><span class='Ref_To_Local'>indexInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end brinsummarize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given a deformed tuple in the build state, convert it into the on-disk 
 * format and insert it into the index, making the revmap point to it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1336"></a><span class='Declare_Function'>form_and_insert_tuple</span><span class='Parentheses'>(</span><a href="brin.c.html#LN41"><span class='Ref_to_Struct'>BrinBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1338"></a>    <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN1339"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <a href="brin.c.html#LN1338"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN85"><span class='Ref_to_Proto'>brin_form_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN49"><span class='Ref_to_Member'>bs_bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a><span class='Delimiter'>, 
</span>                          <a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN50"><span class='Ref_to_Member'>bs_dtuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin.c.html#LN1339"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/brin_pageops.h.html#LN23"><span class='Ref_to_Proto'>brin_doinsert</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN43"><span class='Ref_to_Member'>bs_irel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN46"><span class='Ref_to_Member'>bs_pagesPerRange</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN48"><span class='Ref_to_Member'>bs_rmAccess</span></a><span class='Delimiter'>, 
</span>                  <span class='Operator'>&</span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN45"><span class='Ref_to_Member'>bs_currentInsertBuf</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN47"><span class='Ref_to_Member'>bs_currRangeStart</span></a><span class='Delimiter'>, 
</span>                  <a href="brin.c.html#LN1338"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1339"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1336"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="brin.c.html#LN44"><span class='Ref_to_Member'>bs_numtuples</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1338"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Given two deformed tuples, adjust the first one so that it's consistent 
 * with the summary values in both. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1356"></a><span class='Declare_Function'>union_tuples</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_internal.h.html#LN40"><span class='Ref_to_Struct'>BrinDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bdesc</span><span class='Delimiter'>, </span><a href="../../../include/access/brin_tuple.h.html#LN35"><span class='Ref_to_Struct'>BrinMemTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1358"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>keyno</span><span class='Delimiter'>; 
</span><a name="LN1359"></a>    <a href="../../../include/access/brin_tuple.h.html#LN35"><span class='Ref_to_Struct'>BrinMemTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>db</span><span class='Delimiter'>; 
</span><a name="LN1360"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>cxt</span><span class='Delimiter'>; 
</span><a name="LN1361"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Use our own memory context to avoid retail pfree */ 
</span>    <a href="brin.c.html#LN1360"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                <span class='String'>"brin union"</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1361"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1360"><span class='Ref_To_Local'>cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin.c.html#LN1359"><span class='Ref_To_Local'>db</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN98"><span class='Ref_to_Proto'>brin_deform_tuple</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1361"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>&LT; </span><a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN49"><span class='Ref_to_Member'>bd_tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1373"></a>        <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>unionFn</span><span class='Delimiter'>; 
</span><a name="LN1374"></a>        <a href="../../../include/access/brin_tuple.h.html#LN23"><span class='Ref_to_Struct'>BrinValues</span></a> <span class='Operator'>*</span><span class='Declare_Local'>col_a</span> <span class='Operator'>= &</span><a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN45"><span class='Ref_to_Member'>bt_columns</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]; 
</span><a name="LN1375"></a>        <a href="../../../include/access/brin_tuple.h.html#LN23"><span class='Ref_to_Struct'>BrinValues</span></a> <span class='Operator'>*</span><span class='Declare_Local'>col_b</span> <span class='Operator'>= &</span><a href="brin.c.html#LN1359"><span class='Ref_To_Local'>db</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN45"><span class='Ref_to_Member'>bt_columns</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>]; 
</span> 
        <a href="brin.c.html#LN1373"><span class='Ref_To_Local'>unionFn</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN46"><span class='Ref_to_Member'>bd_index</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/access/brin_internal.h.html#LN69"><span class='Ref_to_Const'>BRIN_PROCNUM_UNION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN514"><span class='Ref_to_Proto'>FunctionCall3Coll</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1373"><span class='Ref_To_Local'>unionFn</span></a><span class='Delimiter'>, 
</span>                          <a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_internal.h.html#LN46"><span class='Ref_to_Member'>bd_index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><a href="brin.c.html#LN1358"><span class='Ref_To_Local'>keyno</span></a><span class='Delimiter'>], 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1356"><span class='Ref_to_Parameter'>bdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1374"><span class='Ref_To_Local'>col_a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1375"><span class='Ref_To_Local'>col_b</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1360"><span class='Ref_To_Local'>cxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end union_tuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * brin_vacuum_scan 
 *      Do a complete scan of the index during VACUUM. 
 * 
 * This routine scans the complete index looking for uncatalogued index pages, 
 * i.e. those that might have been lost due to a crash after index extension 
 * and such. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1398"></a><span class='Declare_Function'>brin_vacuum_scan</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>strategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1400"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>vacuum_fsm</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1401"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the index in physical order, and clean up any possible mess in 
     * each page. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1401"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="brin.c.html#LN1401"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1398"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="brin.c.html#LN1401"><span class='Ref_To_Local'>blkno</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1409"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN1409"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1398"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1401"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1398"><span class='Ref_to_Parameter'>strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin.c.html#LN1400"><span class='Ref_To_Local'>vacuum_fsm</span></a> <span class='Operator'>|= </span><a href="../../../include/access/brin_pageops.h.html#LN35"><span class='Ref_to_Proto'>brin_page_cleanup</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1398"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin.c.html#LN1409"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1409"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we made any change to the FSM, make sure the new info is visible all 
     * the way to the top. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin.c.html#LN1400"><span class='Ref_To_Local'>vacuum_fsm</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="brin.c.html#LN1398"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_vacuum_scan &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>