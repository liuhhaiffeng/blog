<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\brin\brin_pageops.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\brin\brin_pageops.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* 
 * brin_pageops.c 
 *      Page-handling routines for BRIN indexes 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/brin/brin_pageops.c 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/brin_pageops.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/brin_page.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/brin_revmap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/brin_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/freespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Maximum size of an entry in a BRIN_PAGETYPE_REGULAR page.  We can tolerate 
 * a single item per page, unlike other index AMs. 
 */ 
</span><a name="LN29"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BrinMaxItemSize</span> <span class='Operator'>\ 
</span>    <a href="../../../include/c.h.html#LN599"><span class='Ref_to_Macro'>MAXALIGN_DOWN</span></a><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>- \ 
</span>                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>+ \ 
</span>                            <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ \ 
</span>                   <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN28"><span class='Ref_to_Struct'>BrinSpecialSpace</span></a><span class='Parentheses'>))))</span> 
 
<a name="LN35"></a><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Prototype'>brin_getinsertbuffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>irel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>oldbuf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsz</span><span class='Delimiter'>, 
</span><a name="LN36"></a>                     <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>extended</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN37"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>br_page_get_freespace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN38"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>brin_initialize_empty_new_buffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update tuple origtup (size origsz), located in offset oldoff of buffer 
 * oldbuf, to newtup (size newsz) as summary tuple for the page range starting 
 * at heapBlk.  oldbuf must not be locked on entry, and is not locked at exit. 
 * 
 * If samepage is true, attempt to put the new tuple in the same page, but if 
 * there's no room, use some other one. 
 * 
 * If the update is successful, return true; the revmap is updated to point to 
 * the new tuple.  If the update is not done for whatever reason, return false. 
 * Caller may retry the update if this happens. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN54"></a><span class='Declare_Function'>brin_doupdate</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pagesPerRange</span><span class='Delimiter'>, 
</span><a name="LN55"></a>              <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>revmap</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, 
</span><a name="LN56"></a>              <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>oldbuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoff</span><span class='Delimiter'>, 
</span><a name="LN57"></a>              <span class='Keyword'>const </span><a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>origtup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>origsz</span><span class='Delimiter'>, 
</span><a name="LN58"></a>              <span class='Keyword'>const </span><a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newsz</span><span class='Delimiter'>, 
</span><a name="LN59"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>samepage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN61"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>oldpage</span><span class='Delimiter'>; 
</span><a name="LN62"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>oldlp</span><span class='Delimiter'>; 
</span><a name="LN63"></a>    <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>oldtup</span><span class='Delimiter'>; 
</span><a name="LN64"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>oldsz</span><span class='Delimiter'>; 
</span><a name="LN65"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>newbuf</span><span class='Delimiter'>; 
</span><a name="LN66"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>extended</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the item is oversized, don't bother. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a> <span class='Operator'>&GT; </span><a href="brin_pageops.c.html#LN29"><span class='Ref_to_Const'>BrinMaxItemSize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                   <a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN29"><span class='Ref_to_Const'>BrinMaxItemSize</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* make sure the revmap is long enough to contain the entry we need */ 
</span>    <a href="../../../include/access/brin_revmap.h.html#LN29"><span class='Ref_to_Proto'>brinRevmapExtend</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN55"><span class='Ref_to_Parameter'>revmap</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN55"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin_pageops.c.html#LN59"><span class='Ref_to_Parameter'>samepage</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* need a page on which to put the item */ 
</span>        <a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN35"><span class='Ref_to_Proto'>brin_getinsertbuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note: it's possible (though unlikely) that the returned newbuf is 
         * the same as oldbuf, if brin_getinsertbuffer determined that the old 
         * buffer does in fact have enough space. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>== </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !samepage &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN62"><span class='Ref_To_Local'>oldlp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the old tuple wasn't updated concurrently: it might have 
     * moved someplace else entirely ... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN62"><span class='Ref_To_Local'>oldlp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this happens, and the new buffer was obtained by extending the 
         * relation, then we need to ensure we don't leave it uninitialized or 
         * forget about it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>                <a href="brin_pageops.c.html#LN38"><span class='Ref_to_Proto'>brin_initialize_empty_new_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="brin_pageops.c.html#LN64"><span class='Ref_To_Local'>oldsz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN62"><span class='Ref_To_Local'>oldlp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN63"><span class='Ref_To_Local'>oldtup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN62"><span class='Ref_To_Local'>oldlp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ... or it might have been updated in place to different contents. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/brin_tuple.h.html#LN92"><span class='Ref_to_Proto'>brin_tuples_equal</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN63"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN64"><span class='Ref_To_Local'>oldsz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN57"><span class='Ref_to_Parameter'>origtup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN57"><span class='Ref_to_Parameter'>origsz</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>                <a href="brin_pageops.c.html#LN38"><span class='Ref_to_Proto'>brin_initialize_empty_new_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Great, the old tuple is intact.  We can proceed with the update. 
     * 
     * If there's enough room in the old page for the new tuple, replace it. 
     * 
     * Note that there might now be enough space on the page even though the 
     * caller told us there isn't, if a concurrent update moved another tuple 
     * elsewhere or replaced a tuple with a smaller one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="../../../include/access/brin_page.h.html#LN45"><span class='Ref_to_Macro'>BrinPageFlags</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/brin_page.h.html#LN59"><span class='Ref_to_Const'>BRIN_EVACUATE_PAGE</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>        <a href="../../../include/access/brin_pageops.h.html#LN21"><span class='Ref_to_Proto'>brin_can_do_samepage_update</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN57"><span class='Ref_to_Parameter'>origsz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* as above */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>                <a href="brin_pageops.c.html#LN38"><span class='Ref_to_Proto'>brin_initialize_empty_new_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN433"><span class='Ref_to_Proto'>PageIndexTupleOverwrite</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldoff</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to replace BRIN tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN185"></a>            <a href="../../../include/access/brin_xlog.h.html#LN101"><span class='Ref_to_Struct'>xl_brin_samepage_update</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN186"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN187"></a>            <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/brin_xlog.h.html#LN33"><span class='Ref_to_Const'>XLOG_BRIN_SAMEPAGE_UPDATE</span></a><span class='Delimiter'>; 
</span> 
            <a href="brin_pageops.c.html#LN185"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN103"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldoff</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN185"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_xlog.h.html#LN106"><span class='Ref_to_Const'>SizeOfBrinSamepageUpdate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="brin_pageops.c.html#LN186"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BRIN_ID<span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN187"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN186"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ((BrinPageFlags(oldpa... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Not enough space, but caller said that there was. Tell them to 
         * start over. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Not enough free space on the oldpage. Put the new tuple on the new 
         * page, and update the revmap. 
         */ 
</span><a name="LN226"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>newpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN227"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>revmapbuf</span><span class='Delimiter'>; 
</span><a name="LN228"></a>        <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>newtid</span><span class='Delimiter'>; 
</span><a name="LN229"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>newoff</span><span class='Delimiter'>; 
</span><a name="LN230"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>newblk</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span><a name="LN231"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN227"><span class='Ref_To_Local'>revmapbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN31"><span class='Ref_to_Proto'>brinLockRevmapPageForUpdate</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN55"><span class='Ref_to_Parameter'>revmap</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN55"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We need to initialize the page if it's newly obtained.  Note we 
         * will WAL-log the initialization as part of the update, so we don't 
         * need to do that here. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/brin_pageops.h.html#LN27"><span class='Ref_to_Proto'>brin_page_init</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/brin_page.h.html#LN52"><span class='Ref_to_Const'>BRIN_PAGETYPE_REGULAR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN432"><span class='Ref_to_Proto'>PageIndexTupleDeleteNoCompact</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="brin_pageops.c.html#LN229"><span class='Ref_To_Local'>newoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN226"><span class='Ref_To_Local'>newpage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN229"><span class='Ref_To_Local'>newoff</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add BRIN tuple to new page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* needed to update FSM below */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="brin_pageops.c.html#LN230"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN231"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN37"><span class='Ref_to_Proto'>br_page_get_freespace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN226"><span class='Ref_To_Local'>newpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN228"><span class='Ref_To_Local'>newtid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN229"><span class='Ref_To_Local'>newoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/brin_revmap.h.html#LN33"><span class='Ref_to_Proto'>brinSetHeapBlockItemptr</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN227"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN55"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN228"><span class='Ref_To_Local'>newtid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN227"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN267"></a>            <a href="../../../include/access/brin_xlog.h.html#LN86"><span class='Ref_to_Struct'>xl_brin_update</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN268"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN269"></a>            <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span> 
            <a href="brin_pageops.c.html#LN269"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_xlog.h.html#LN32"><span class='Ref_to_Const'>XLOG_BRIN_UPDATE</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a> <span class='Operator'>? </span><a href="../../../include/access/brin_xlog.h.html#LN42"><span class='Ref_to_Const'>XLOG_BRIN_INIT_PAGE</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="brin_pageops.c.html#LN267"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN91"><span class='Ref_to_Member'>insert</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN70"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN229"><span class='Ref_To_Local'>newoff</span></a><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN267"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN91"><span class='Ref_to_Member'>insert</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN64"><span class='Ref_to_Member'>heapBlk</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN55"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN267"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN91"><span class='Ref_to_Member'>insert</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN67"><span class='Ref_to_Member'>pagesPerRange</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN267"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN89"><span class='Ref_to_Member'>oldOffnum</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldoff</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* new page */ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN267"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_xlog.h.html#LN94"><span class='Ref_to_Const'>SizeOfBrinUpdate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a> <span class='Operator'>? </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN58"><span class='Ref_to_Parameter'>newsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* revmap page */ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN227"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* old page */ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="brin_pageops.c.html#LN268"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BRIN_ID<span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN269"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN61"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN268"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN226"><span class='Ref_To_Local'>newpage</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN268"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN227"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN268"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(idxr... &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN227"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN56"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN65"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN66"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN230"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN230"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN231"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN54"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end brin_doupdate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return whether brin_doupdate can do a samepage update. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN320"></a><span class='Declare_Function'>brin_can_do_samepage_update</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>origsz</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newsz</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> 
        <span class='Parentheses'>((</span><a href="brin_pageops.c.html#LN320"><span class='Ref_to_Parameter'>newsz</span></a> <span class='Operator'>&LT;= </span><a href="brin_pageops.c.html#LN320"><span class='Ref_to_Parameter'>origsz</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>         <a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN320"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN320"><span class='Ref_to_Parameter'>newsz</span></a> <span class='Operator'>- </span><a href="brin_pageops.c.html#LN320"><span class='Ref_to_Parameter'>origsz</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Insert an index tuple into the index relation.  The revmap is updated to 
 * mark the range containing the given page as pointing to the inserted entry. 
 * A WAL record is written. 
 * 
 * The buffer, if valid, is first checked for free space to insert the new 
 * entry; if there isn't enough, a new buffer is obtained and pinned.  No 
 * buffer lock must be held on entry, no buffer lock is held on exit. 
 * 
 * Return value is the offset number where the tuple was inserted. 
 */ 
</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> 
<a name="LN339"></a><span class='Declare_Function'>brin_doinsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pagesPerRange</span><span class='Delimiter'>, 
</span><a name="LN340"></a>              <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>revmap</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, 
</span><a name="LN341"></a>              <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsz</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN343"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blk</span><span class='Delimiter'>; 
</span><a name="LN345"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN346"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>revmapbuf</span><span class='Delimiter'>; 
</span><a name="LN347"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>tid</span><span class='Delimiter'>; 
</span><a name="LN348"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>extended</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the item is oversized, don't even bother. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a> <span class='Operator'>&GT; </span><a href="brin_pageops.c.html#LN29"><span class='Ref_to_Const'>BrinMaxItemSize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN29"><span class='Ref_to_Const'>BrinMaxItemSize</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN339"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure the revmap is long enough to contain the entry we need */ 
</span>    <a href="../../../include/access/brin_revmap.h.html#LN29"><span class='Ref_to_Proto'>brinRevmapExtend</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>revmap</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Acquire lock on buffer supplied by caller, if any.  If it doesn't have 
     * enough space, unpin it to obtain a new one below. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * It's possible that another backend (or ourselves!) extended the 
         * revmap over the page we held a pin on, so we cannot assume that 
         * it's still a regular page. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN37"><span class='Ref_to_Proto'>br_page_get_freespace</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we still don't have a usable buffer, have brin_getinsertbuffer 
     * obtain one for us. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>do</span> 
            <span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN35"><span class='Ref_to_Proto'>brin_getinsertbuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN339"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN348"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="brin_pageops.c.html#LN348"><span class='Ref_To_Local'>extended</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now obtain lock on revmap buffer */ 
</span>    <a href="brin_pageops.c.html#LN346"><span class='Ref_To_Local'>revmapbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_revmap.h.html#LN31"><span class='Ref_to_Proto'>brinLockRevmapPageForUpdate</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>revmap</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN343"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN344"><span class='Ref_To_Local'>blk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Execute the actual insertion */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN348"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/brin_pageops.h.html#LN27"><span class='Ref_to_Proto'>brin_page_init</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/brin_page.h.html#LN52"><span class='Ref_to_Const'>BRIN_PAGETYPE_REGULAR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN345"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN343"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, 
</span>                      <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN345"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not insert new index tuple to page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_internal.h.html#LN78"><span class='Ref_to_Macro'>BRIN_elog</span></a><span class='Parentheses'>((</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"inserted tuple (%u,%u) for range starting at %u"</span><span class='Delimiter'>, 
</span>               <a href="brin_pageops.c.html#LN344"><span class='Ref_To_Local'>blk</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN345"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN347"><span class='Ref_To_Local'>tid</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN344"><span class='Ref_To_Local'>blk</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN345"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/brin_revmap.h.html#LN33"><span class='Ref_to_Proto'>brinSetHeapBlockItemptr</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN346"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN339"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN347"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN346"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN339"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN423"></a>        <a href="../../../include/access/brin_xlog.h.html#LN62"><span class='Ref_to_Struct'>xl_brin_insert</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN424"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN425"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN425"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_xlog.h.html#LN31"><span class='Ref_to_Const'>XLOG_BRIN_INSERT</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN348"><span class='Ref_To_Local'>extended</span></a> <span class='Operator'>? </span><a href="../../../include/access/brin_xlog.h.html#LN42"><span class='Ref_to_Const'>XLOG_BRIN_INIT_PAGE</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="brin_pageops.c.html#LN423"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN64"><span class='Ref_to_Member'>heapBlk</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Delimiter'>; 
</span>        <a href="brin_pageops.c.html#LN423"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN67"><span class='Ref_to_Member'>pagesPerRange</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN339"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>; 
</span>        <a href="brin_pageops.c.html#LN423"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/brin_xlog.h.html#LN70"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN345"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN423"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_xlog.h.html#LN73"><span class='Ref_to_Const'>SizeOfBrinInsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN348"><span class='Ref_To_Local'>extended</span></a> <span class='Operator'>? </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN341"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN346"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN424"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BRIN_ID<span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN425"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN343"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN424"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN346"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN424"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(idxr... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Tuple is firmly on buffer; we can release our locks */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN340"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN346"><span class='Ref_To_Local'>revmapbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN348"><span class='Ref_To_Local'>extended</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN339"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="brin_pageops.c.html#LN345"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_doinsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a page with the given type. 
 * 
 * Caller is responsible for marking it dirty, as appropriate. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN464"></a><span class='Declare_Function'>brin_page_init</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN464"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN28"><span class='Ref_to_Struct'>BrinSpecialSpace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_page.h.html#LN41"><span class='Ref_to_Macro'>BrinPageType</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN464"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="brin_pageops.c.html#LN464"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize a new BRIN index' metapage. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN475"></a><span class='Declare_Function'>brin_metapage_init</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pagesPerRange</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>version</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN477"></a>    <a href="../../../include/access/brin_page.h.html#LN63"><span class='Ref_to_Struct'>BrinMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_pageops.h.html#LN27"><span class='Ref_to_Proto'>brin_page_init</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN475"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_page.h.html#LN50"><span class='Ref_to_Const'>BRIN_PAGETYPE_META</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN477"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN63"><span class='Ref_to_Struct'>BrinMetaPageData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN475"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN477"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_page.h.html#LN65"><span class='Ref_to_Member'>brinMagic</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_page.h.html#LN72"><span class='Ref_to_Const'>BRIN_META_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN477"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_page.h.html#LN66"><span class='Ref_to_Member'>brinVersion</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN475"><span class='Ref_to_Parameter'>version</span></a><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN477"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_page.h.html#LN67"><span class='Ref_to_Member'>pagesPerRange</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN475"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note we cheat here a little.  0 is not a valid revmap block number 
     * (because it's the metapage buffer), but doing this enables the first 
     * revmap page to be created when the index is. 
     */ 
</span>    <a href="brin_pageops.c.html#LN477"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_page.h.html#LN68"><span class='Ref_to_Member'>lastRevmapPage</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_metapage_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initiate page evacuation protocol. 
 * 
 * The page must be locked in exclusive mode by the caller. 
 * 
 * If the page is not yet initialized or empty, return false without doing 
 * anything; it can be used for revmap without any further changes.  If it 
 * contains tuples, mark it for evacuation and return true. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN505"></a><span class='Declare_Function'>brin_start_evacuating_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxRel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN507"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN508"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN509"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN509"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN505"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN509"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN508"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN509"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN507"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="brin_pageops.c.html#LN507"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="brin_pageops.c.html#LN508"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="brin_pageops.c.html#LN507"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN519"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN519"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN509"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN507"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN519"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* prevent other backends from adding more stuff to this page */ 
</span>            <a href="../../../include/access/brin_page.h.html#LN45"><span class='Ref_to_Macro'>BrinPageFlags</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN509"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|= </span><a href="../../../include/access/brin_page.h.html#LN59"><span class='Ref_to_Const'>BRIN_EVACUATE_PAGE</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN211"><span class='Ref_to_Proto'>MarkBufferDirtyHint</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN505"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_start_evacuating_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Move all tuples out of a page. 
 * 
 * The caller must hold lock on the page. The lock and pin are released. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN540"></a><span class='Declare_Function'>brin_evacuate_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxRel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pagesPerRange</span><span class='Delimiter'>, 
</span><a name="LN541"></a>                   <a href="brin_revmap.c.html#LN46"><span class='Ref_to_Struct'>BrinRevmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>revmap</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN543"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN544"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN545"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN546"></a>    <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>btup</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN547"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>btupsz</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN545"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN541"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN45"><span class='Ref_to_Macro'>BrinPageFlags</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN545"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/brin_page.h.html#LN59"><span class='Ref_to_Const'>BRIN_EVACUATE_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="brin_pageops.c.html#LN544"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN545"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN543"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="brin_pageops.c.html#LN543"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="brin_pageops.c.html#LN544"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="brin_pageops.c.html#LN543"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN556"></a>        <a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN557"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sz</span><span class='Delimiter'>; 
</span><a name="LN558"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN558"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN545"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN543"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN558"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="brin_pageops.c.html#LN557"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN558"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN556"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/brin_tuple.h.html#LN53"><span class='Ref_to_Struct'>BrinTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN545"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN558"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN556"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/access/brin_tuple.h.html#LN90"><span class='Ref_to_Proto'>brin_copy_tuple</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN556"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN557"><span class='Ref_To_Local'>sz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN546"><span class='Ref_To_Local'>btup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="brin_pageops.c.html#LN547"><span class='Ref_To_Local'>btupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN541"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/brin_pageops.h.html#LN15"><span class='Ref_to_Proto'>brin_doupdate</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN540"><span class='Ref_to_Parameter'>idxRel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN540"><span class='Ref_to_Parameter'>pagesPerRange</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN541"><span class='Ref_to_Parameter'>revmap</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN556"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/brin_tuple.h.html#LN56"><span class='Ref_to_Member'>bt_blkno</span></a><span class='Delimiter'>, 
</span>                               <a href="brin_pageops.c.html#LN541"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN543"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN556"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN557"><span class='Ref_To_Local'>sz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN556"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN557"><span class='Ref_To_Local'>sz</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <a href="brin_pageops.c.html#LN543"><span class='Ref_To_Local'>off</span></a><span class='Operator'>--</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* retry */ 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN541"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* It's possible that someone extended the revmap over this page */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/brin_page.h.html#LN56"><span class='Ref_to_Macro'>BRIN_IS_REGULAR_PAGE</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN545"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for off=FirstOffsetNumber... &raquo; </span> 
 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN541"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_evacuate_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given a BRIN index page, initialize it if necessary, and record it into the 
 * FSM if necessary.  Return value is true if the FSM itself needs "vacuuming". 
 * The main use for this is when, during vacuuming, an uninitialized page is 
 * found, which could be the result of relation extension followed by a crash 
 * before the page can be used. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN594"></a><span class='Declare_Function'>brin_page_cleanup</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN596"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN597"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a page was left uninitialized, initialize it now; also record it in 
     * FSM. 
     * 
     * Somebody else might be extending the relation concurrently.  To avoid 
     * re-initializing the page before they can grab the buffer lock, we 
     * acquire the extension lock momentarily.  Since they hold the extension 
     * lock from before getting the page and after its been initialized, we're 
     * sure to see their initialization. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN596"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN596"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="brin_pageops.c.html#LN38"><span class='Ref_to_Proto'>brin_initialize_empty_new_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing to be done for non-regular index pages */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN54"><span class='Ref_to_Macro'>BRIN_IS_META_PAGE</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>        <a href="../../../include/access/brin_page.h.html#LN55"><span class='Ref_to_Macro'>BRIN_IS_REVMAP_PAGE</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Measure free space and record it */ 
</span>    <a href="brin_pageops.c.html#LN597"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN37"><span class='Ref_to_Proto'>br_page_get_freespace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN596"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN597"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/freespace.h.html#LN21"><span class='Ref_to_Proto'>GetRecordedFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN594"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN597"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_page_cleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return a pinned and exclusively locked buffer which can be used to insert an 
 * index item of size itemsz (caller must ensure not to request sizes 
 * impossible to fulfill).  If oldbuf is a valid buffer, it is also locked (in 
 * an order determined to avoid deadlocks.) 
 * 
 * If we find that the old page is no longer a regular index page (because 
 * of a revmap extension), the old buffer is unlocked and we return 
 * InvalidBuffer. 
 * 
 * If there's no existing page with enough free space to accommodate the new 
 * item, the relation is extended.  If this happens, *extended is set to true, 
 * and it is the caller's responsibility to initialize the page (and WAL-log 
 * that fact) prior to use. 
 * 
 * Note that in some corner cases it is possible for this routine to extend the 
 * relation and then not return the buffer.  It is this routine's 
 * responsibility to WAL-log the page initialization and to record the page in 
 * FSM if that happens.  Such a buffer may later be reused by this routine. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN661"></a><span class='Declare_Function'>brin_getinsertbuffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>irel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>oldbuf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsz</span><span class='Delimiter'>, 
</span><a name="LN662"></a>                     <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>extended</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN664"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>oldblk</span><span class='Delimiter'>; 
</span><a name="LN665"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>newblk</span><span class='Delimiter'>; 
</span><a name="LN666"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN667"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* callers must have checked */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>itemsz</span></a> <span class='Operator'>&LT;= </span><a href="brin_pageops.c.html#LN29"><span class='Ref_to_Const'>BrinMaxItemSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>))</span> 
        <a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop until we find a page with sufficient free space.  By the time we 
     * return to caller out of this loop, both buffers are valid and locked; 
     * if we have to restart here, neither buffer is locked and buf is not a 
     * pinned buffer. 
     */ 
</span>    <a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN488"><span class='Ref_to_Macro'>RelationGetTargetBlock</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/freespace.h.html#LN22"><span class='Ref_to_Proto'>GetPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN690"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN691"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>extensionLockHeld</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * There's not enough free space in any existing index page, 
             * according to the FSM: extend the relation to obtain a shiny new 
             * page. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN523"><span class='Ref_to_Macro'>RELATION_IS_LOCAL</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="brin_pageops.c.html#LN691"><span class='Ref_To_Local'>extensionLockHeld</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/brin_internal.h.html#LN78"><span class='Ref_to_Macro'>BRIN_elog</span></a><span class='Parentheses'>((</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"brin_getinsertbuffer: extending to page %u"</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>== </span><a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * There's an odd corner-case here where the FSM is out-of-date, 
             * and gave us the old page. 
             */ 
</span>            <a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We lock the old buffer first, if it's earlier than the new one; but 
         * before we do, we need to check that it hasn't been turned into a 
         * revmap page concurrently; if we detect that it happened, give up 
         * and tell caller to start over. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>&LT; </span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/brin_page.h.html#LN56"><span class='Ref_to_Macro'>BRIN_IS_REGULAR_PAGE</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * It is possible that the new page was obtained from 
                 * extending the relation.  In that case, we must be sure to 
                 * record it in the FSM before leaving, because otherwise the 
                 * space would be lost forever.  However, we cannot let an 
                 * uninitialized page get in the FSM, so we need to initialize 
                 * it first. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="brin_pageops.c.html#LN38"><span class='Ref_to_Proto'>brin_initialize_empty_new_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* shouldn't matter, but don't confuse caller */ 
</span>                    <span class='Operator'>*</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN691"><span class='Ref_To_Local'>extensionLockHeld</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !BRIN_IS_REGULAR_PAGE... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if BufferIsValid(oldbuf)... &raquo; </span> 
 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN691"><span class='Ref_To_Local'>extensionLockHeld</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN666"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have a new buffer to insert into.  Check that the new page has 
         * enough free space, and return it if it does; otherwise start over. 
         * Note that we allow for the FSM to be out of date here, and in that 
         * case we update it and move on. 
         * 
         * (br_page_get_freespace also checks that the FSM didn't hand us a 
         * page that has since been repurposed for the revmap.) 
         */ 
</span>        <a href="brin_pageops.c.html#LN667"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= *</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a> <span class='Operator'>? 
</span>            <a href="brin_pageops.c.html#LN29"><span class='Ref_to_Const'>BrinMaxItemSize</span></a> <span class='Operator'>: </span><a href="brin_pageops.c.html#LN37"><span class='Ref_to_Proto'>br_page_get_freespace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN666"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN667"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>&GT;= </span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/rel.h.html#LN495"><span class='Ref_to_Macro'>RelationSetTargetBlock</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Since the target block specification can get lost on cache 
             * invalidations, make sure we update the more permanent FSM with 
             * data about it before going away. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        <a href="brin_pageops.c.html#LN667"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Lock the old buffer if not locked already.  Note that in this 
             * case we know for sure it's a regular page: it's later than the 
             * new page we just got, which is not a revmap page, and revmap 
             * pages are always consecutive. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>&GT; </span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN56"><span class='Ref_to_Macro'>BRIN_IS_REGULAR_PAGE</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>return</span> <a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if freespace&GT;=itemsz &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* This page is no good. */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If an entirely new page does not contain enough free space for the 
         * new item, then surely that item is oversized.  Complain loudly; but 
         * first make sure we initialize the page and record it as free, for 
         * next time. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="brin_pageops.c.html#LN662"><span class='Ref_to_Parameter'>extended</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="brin_pageops.c.html#LN38"><span class='Ref_to_Proto'>brin_initialize_empty_new_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                   <a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN667"><span class='Ref_To_Local'>freespace</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>!= </span><a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN690"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="brin_pageops.c.html#LN664"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>&LT;= </span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>)</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/freespace.h.html#LN23"><span class='Ref_to_Proto'>RecordAndGetPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>irel</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN665"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN667"><span class='Ref_To_Local'>freespace</span></a><span class='Delimiter'>, </span><a href="brin_pageops.c.html#LN661"><span class='Ref_to_Parameter'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end brin_getinsertbuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a page as an empty regular BRIN page, WAL-log this, and record 
 * the page in FSM. 
 * 
 * There are several corner situations in which we extend the relation to 
 * obtain a new page and later find that we cannot use it immediately.  When 
 * that happens, we don't want to leave the page go unrecorded in FSM, because 
 * there is no mechanism to get the space back and the index would bloat. 
 * Also, because we would not WAL-log the action that would initialize the 
 * page, the page would go uninitialized in a standby (or after recovery). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN849"></a><span class='Declare_Function'>brin_initialize_empty_new_buffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>idxrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN851"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/brin_internal.h.html#LN78"><span class='Ref_to_Macro'>BRIN_elog</span></a><span class='Parentheses'>((</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>               <span class='String'>"brin_initialize_empty_new_buffer: initializing blank page %u"</span><span class='Delimiter'>, 
</span>               <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN849"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="brin_pageops.c.html#LN851"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN849"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/brin_pageops.h.html#LN27"><span class='Ref_to_Proto'>brin_page_init</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/brin_page.h.html#LN52"><span class='Ref_to_Const'>BRIN_PAGETYPE_REGULAR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN849"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN56"><span class='Ref_to_Proto'>log_newpage_buffer</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN849"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We update the FSM for this page, but this is not WAL-logged.  This is 
     * acceptable because VACUUM will scan the index and update the FSM with 
     * pages whose FSM records were forgotten in a crash. 
     */ 
</span>    <a href="../../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN849"><span class='Ref_to_Parameter'>idxrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN849"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="brin_pageops.c.html#LN37"><span class='Ref_to_Proto'>br_page_get_freespace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end brin_initialize_empty_new_buffer &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Return the amount of free space on a regular BRIN index page. 
 * 
 * If the page is not a regular page, or has been marked with the 
 * BRIN_EVACUATE_PAGE flag, returns 0. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN881"></a><span class='Declare_Function'>br_page_get_freespace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/brin_page.h.html#LN56"><span class='Ref_to_Macro'>BRIN_IS_REGULAR_PAGE</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN881"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="../../../include/access/brin_page.h.html#LN45"><span class='Ref_to_Macro'>BrinPageFlags</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN881"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/brin_page.h.html#LN59"><span class='Ref_to_Const'>BRIN_EVACUATE_PAGE</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="brin_pageops.c.html#LN881"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>