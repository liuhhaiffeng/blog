<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gin\ginbtree.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gin\ginbtree.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * ginbtree.c 
 *    page utilities routines for the postgres inverted index access method. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/gin/ginbtree.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/gin_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/ginxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
<a name="LN23"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ginFindParents</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN24"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ginPlaceToPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN25"></a>               <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN26"></a>               <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>childbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN27"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ginFinishSplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN28"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>freestack</span><span class='Delimiter'>, </span><a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Lock buffer by needed method for search. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN34"></a><span class='Declare_Function'>ginTraverseLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>searchMode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN36"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN37"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>access</span> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN36"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN36"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>searchMode</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we should relock our page */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* But root can become non-leaf during relock */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN36"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* restore old lock type (very rare) */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN34"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="ginbtree.c.html#LN37"><span class='Ref_To_Local'>access</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="ginbtree.c.html#LN37"><span class='Ref_To_Local'>access</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginTraverseLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Descend the tree to the leaf page that contains or would contain the key 
 * we're searching for. The key should already be filled in 'btree', in 
 * tree-type specific manner. If btree-&GT;fullScan is true, descends to the 
 * leftmost leaf page. 
 * 
 * If 'searchmode' is false, on return stack-&GT;buffer is exclusively locked, 
 * and the stack represents the full path to the root. Otherwise stack-&GT;buffer 
 * is share-locked, and stack-&GT;parent is NULL. 
 */ 
</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>* 
</span><a name="LN75"></a><span class='Declare_Function'>ginFindLeafPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>searchMode</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN77"></a>    <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>stack</span><span class='Delimiter'>; 
</span> 
    <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN128"><span class='Ref_to_Member'>predictNumber</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN87"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN88"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>child</span><span class='Delimiter'>; 
</span><a name="LN89"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>access</span><span class='Delimiter'>; 
</span> 
        <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
        <a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ginbtree.c.html#LN89"><span class='Ref_To_Local'>access</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN33"><span class='Ref_to_Func'>ginTraverseLock</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>searchMode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we're going to modify the tree, finish any incomplete splits we 
         * encounter on the way. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>searchMode</span></a> <span class='Operator'>&& </span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ok, page is correctly locked, we should check to move right .., 
         * root never has a right link, so small optimization 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN162"><span class='Ref_to_Member'>fullScan</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE </span><span class='Operator'>&& </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>!= </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a> <span class='Operator'>&& 
</span>               <a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN147"><span class='Ref_to_Member'>isMoveRight</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN112"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rightlink</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN112"><span class='Ref_To_Local'>rightlink</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Comment_Multi_Line'>/* rightmost page */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN163"><span class='Ref_to_Func'>ginStepRight</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN89"><span class='Ref_To_Local'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN112"><span class='Ref_To_Local'>rightlink</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>searchMode</span></a> <span class='Operator'>&& </span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN87"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span>    <span class='Comment_Single_Line'>/* we found, return locked page */ 
</span>            <span class='Control'>return</span> <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* now we have correct buffer, try to find child */ 
</span>        <a href="ginbtree.c.html#LN88"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN145"><span class='Ref_to_Member'>findChildPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN88"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>!= </span><a href="ginbtree.c.html#LN88"><span class='Ref_To_Local'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>searchMode</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* in search mode we may forget path to leaf */ 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN88"><span class='Ref_To_Local'>child</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN178"><span class='Ref_to_Proto'>ReleaseAndReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN145"></a>            <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="ginbtree.c.html#LN145"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN145"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN88"><span class='Ref_To_Local'>child</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN75"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN77"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN128"><span class='Ref_to_Member'>predictNumber</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ginFindLeafPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Step right from current page. 
 * 
 * The next page is locked first, before releasing the current page. This is 
 * crucial to protect from concurrent page deletion (see comment in 
 * ginDeletePage). 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN164"></a><span class='Declare_Function'>ginStepRight</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN166"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>nextbuffer</span><span class='Delimiter'>; 
</span><a name="LN167"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN164"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN168"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isLeaf</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN169"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isData</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN170"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span> 
    <a href="ginbtree.c.html#LN166"><span class='Ref_To_Local'>nextbuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN164"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN170"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN166"><span class='Ref_To_Local'>nextbuffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN164"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN164"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sanity check that the page we stepped to is of similar kind. */ 
</span>    <a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN166"><span class='Ref_To_Local'>nextbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN168"><span class='Ref_To_Local'>isLeaf</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="ginbtree.c.html#LN169"><span class='Ref_To_Local'>isData</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"right sibling of GIN page is of different type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Given the proper lock sequence above, we should never land on a deleted 
     * page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN122"><span class='Ref_to_Macro'>GinPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN167"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"right sibling of GIN page was deleted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ginbtree.c.html#LN166"><span class='Ref_To_Local'>nextbuffer</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginStepRight &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN192"></a><span class='Declare_Function'>freeGinBtreeStack</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN192"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN196"></a>        <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><a href="ginbtree.c.html#LN192"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN192"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN192"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN192"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN192"><span class='Ref_to_Parameter'>stack</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN196"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Try to find parent for current stack position. Returns correct parent and 
 * child's offset in stack-&GT;parent. The root page is never released, to 
 * to prevent conflict with vacuum process. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN212"></a><span class='Declare_Function'>ginFindParents</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN214"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN215"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN216"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>, 
</span><a name="LN217"></a>                <span class='Declare_Local'>leftmostBlkno</span><span class='Delimiter'>; 
</span><a name="LN218"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN219"></a>    <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>root</span><span class='Delimiter'>; 
</span><a name="LN220"></a>    <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unwind the stack all the way up to the root, leaving only the root 
     * item. 
     * 
     * Be careful not to release the pin on the root page! The pin on root 
     * page is required to lock out concurrent vacuums on the tree. 
     */ 
</span>    <a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN218"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"Lost path"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>!= </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * parent may be wrong, but if so, the ginFinishSplit call will 
             * recurse to call ginFindParents again to fix it. 
             */ 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
            <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="ginbtree.c.html#LN217"><span class='Ref_To_Local'>leftmostBlkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN146"><span class='Ref_to_Member'>getLeftMostChild</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="ginbtree.c.html#LN218"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN151"><span class='Ref_to_Member'>findChildPtr</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN163"><span class='Ref_to_Func'>ginStepRight</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* finish any incomplete splits, as above */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>!= </span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>                <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>                <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Delimiter'>; 
</span>                <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
                <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (offset=btree-&GT;findCh... &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN219"><span class='Ref_To_Local'>root</span></a><span class='Delimiter'>; </span><span class='Comment_Multi_Line'>/* it may be wrong, but in next call we will 
                                 * correct */ 
</span>            <a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN218"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN220"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Descend down to next level */ 
</span>        <a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN217"><span class='Ref_To_Local'>leftmostBlkno</span></a><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN215"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN212"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN216"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ginFindParents &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert a new item to a page. 
 * 
 * Returns true if the insertion was finished. On false, the page was split and 
 * the parent needs to be updated. (A root split returns true as it doesn't 
 * need any further action by the caller to complete.) 
 * 
 * When inserting a downlink to an internal page, 'childbuf' contains the 
 * child page that was split. Its GIN_INCOMPLETE_SPLIT flag will be cleared 
 * atomically with the insert. Also, the existing item at offset stack-&GT;off 
 * in the target page is updated to point to updateblkno. 
 * 
 * stack-&GT;buffer is locked on entry, and is kept locked. 
 * Likewise for childbuf, if given. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN328"></a><span class='Declare_Function'>ginPlaceToPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN329"></a>               <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN330"></a>               <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>childbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN332"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN333"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN334"></a>    <a href="../../../include/access/gin_private.h.html#LN135"><span class='Ref_to_Typedef'>GinPlaceToPageRC</span></a> <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN335"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>xlflags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN336"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>childpage</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN337"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>newlpage</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN338"></a>                <span class='Declare_Local'>newrpage</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN339"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptp_workspace</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN340"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tmpCxt</span><span class='Delimiter'>; 
</span><a name="LN341"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldCxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do all the work of this function and its subfunctions in a temporary 
     * memory context.  This avoids leakages and simplifies APIs, since some 
     * subfunctions allocate storage that has to survive until we've finished 
     * the WAL insertion. 
     */ 
</span>    <a href="ginbtree.c.html#LN340"><span class='Ref_To_Local'>tmpCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                   <span class='String'>"ginPlaceToPage temporary context"</span><span class='Delimiter'>, 
</span>                                   <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbtree.c.html#LN341"><span class='Ref_To_Local'>oldCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN340"><span class='Ref_To_Local'>tmpCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="ginbtree.c.html#LN335"><span class='Ref_To_Local'>xlflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/ginxlog.h.html#LN125"><span class='Ref_to_Const'>GIN_INSERT_ISDATA</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ginbtree.c.html#LN335"><span class='Ref_To_Local'>xlflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/ginxlog.h.html#LN126"><span class='Ref_to_Const'>GIN_INSERT_ISLEAF</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN329"><span class='Ref_to_Parameter'>updateblkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN329"><span class='Ref_to_Parameter'>updateblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * See if the incoming tuple will fit on the page.  beginPlaceToPage will 
     * decide if the page needs to be split, and will compute the split 
     * contents if so.  See comments for beginPlaceToPage and execPlaceToPage 
     * functions for more details of the API here. 
     */ 
</span>    <a href="ginbtree.c.html#LN334"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN152"><span class='Ref_to_Member'>beginPlaceToPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, 
</span>                                 <a href="ginbtree.c.html#LN329"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN329"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="ginbtree.c.html#LN339"><span class='Ref_To_Local'>ptp_workspace</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN334"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><a href="../../../include/access/gin_private.h.html#LN137"><span class='Ref_to_EnumConst'>GPTP_NO_WORK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Nothing to do */ 
</span>        <a href="ginbtree.c.html#LN333"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN334"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><a href="../../../include/access/gin_private.h.html#LN138"><span class='Ref_to_EnumConst'>GPTP_INSERT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* It will fit, perform the insertion */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Perform the page update, and register any extra WAL data */ 
</span>        <a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN153"><span class='Ref_to_Member'>execPlaceToPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, 
</span>                               <a href="ginbtree.c.html#LN329"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN329"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN339"><span class='Ref_To_Local'>ptp_workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* An insert to an internal page finishes the split of the child. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>&= ~</span><a href="../../../include/access/ginblock.h.html#LN44"><span class='Ref_to_Const'>GIN_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN413"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN414"></a>            <a href="../../../include/access/ginxlog.h.html#LN38"><span class='Ref_to_Typedef'>ginxlogInsert</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN415"></a>            <a href="../../../include/storage/block.h.html#LN52"><span class='Ref_to_Struct'>BlockIdData</span></a> <span class='Declare_Local'>childblknos</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
            <a href="ginbtree.c.html#LN414"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN40"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN335"><span class='Ref_To_Local'>xlflags</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ginbtree.c.html#LN414"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN38"><span class='Ref_to_Typedef'>ginxlogInsert</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Log information about child if this was an insertion of a 
             * downlink. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/block.h.html#LN83"><span class='Ref_to_Macro'>BlockIdSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginbtree.c.html#LN415"><span class='Ref_To_Local'>childblknos</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/block.h.html#LN83"><span class='Ref_to_Macro'>BlockIdSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginbtree.c.html#LN415"><span class='Ref_To_Local'>childblknos</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbtree.c.html#LN415"><span class='Ref_To_Local'>childblknos</span></a><span class='Delimiter'>, 
</span>                                 <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN52"><span class='Ref_to_Struct'>BlockIdData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="ginbtree.c.html#LN413"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN36"><span class='Ref_to_Const'>XLOG_GIN_INSERT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN413"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN413"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(btre... &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Insertion is complete. */ 
</span>        <a href="ginbtree.c.html#LN333"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rc==GPTP_INSERT &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN334"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><a href="../../../include/access/gin_private.h.html#LN139"><span class='Ref_to_EnumConst'>GPTP_SPLIT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Didn't fit, need to split.  The split has been computed in newlpage 
         * and newrpage, which are pointers to palloc'd pages, not associated 
         * with buffers.  stack-&GT;buffer is not touched yet. 
         */ 
</span><a name="LN451"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuffer</span><span class='Delimiter'>; 
</span><a name="LN452"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>savedRightLink</span><span class='Delimiter'>; 
</span><a name="LN453"></a>        <a href="../../../include/access/ginxlog.h.html#LN112"><span class='Ref_to_Struct'>ginxlogSplit</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN454"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>lbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN455"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>newrootpg</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get a new index page to become the right page */ 
</span>        <a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN88"><span class='Ref_to_Proto'>GinNewBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* During index build, count the new page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN157"><span class='Ref_to_Member'>isData</span></a><span class='Parentheses'>) 
</span>                <a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin.h.html#LN45"><span class='Ref_to_Member'>nDataPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin.h.html#LN44"><span class='Ref_to_Member'>nEntryPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="ginbtree.c.html#LN452"><span class='Ref_To_Local'>savedRightLink</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Begin setting up WAL record */ 
</span>        <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN114"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN119"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN335"><span class='Ref_To_Local'>xlflags</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN117"><span class='Ref_to_Member'>leftChildBlkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN118"><span class='Ref_to_Member'>rightChildBlkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN117"><span class='Ref_to_Member'>leftChildBlkno</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN118"><span class='Ref_to_Member'>rightChildBlkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * splitting the root, so we need to allocate new left page and 
             * place pointers to left and right page on root page. 
             */ 
</span>            <a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN88"><span class='Ref_to_Proto'>GinNewBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* During index build, count the new left page */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN157"><span class='Ref_to_Member'>isData</span></a><span class='Parentheses'>) 
</span>                    <a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin.h.html#LN45"><span class='Ref_to_Member'>nDataPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin.h.html#LN44"><span class='Ref_to_Member'>nEntryPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN115"><span class='Ref_to_Member'>rrlink</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN119"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/ginxlog.h.html#LN127"><span class='Ref_to_Const'>GIN_SPLIT_ROOT</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Construct a new root page containing downlinks to the new left 
             * and right pages.  (Do this in a temporary copy rather than 
             * overwriting the original page directly, since we're not in the 
             * critical section yet.) 
             */ 
</span>            <a href="ginbtree.c.html#LN455"><span class='Ref_To_Local'>newrootpg</span></a> <span class='Operator'>= </span><a href="../../storage/page/bufpage.c.html#LN346"><span class='Ref_to_Func'>PageGetTempPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gin_private.h.html#LN90"><span class='Ref_to_Proto'>GinInitPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN455"><span class='Ref_To_Local'>newrootpg</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>& ~</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN39"><span class='Ref_to_Const'>GIN_LEAF</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN46"><span class='Ref_to_Const'>GIN_COMPRESSED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN155"><span class='Ref_to_Member'>fillRoot</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN455"><span class='Ref_To_Local'>newrootpg</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stack-&GT;parent==NULL &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* splitting a non-root page */ 
</span>            <a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN115"><span class='Ref_to_Member'>rrlink</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN452"><span class='Ref_To_Local'>savedRightLink</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="ginbtree.c.html#LN452"><span class='Ref_To_Local'>savedRightLink</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>|= </span><a href="../../../include/access/ginblock.h.html#LN44"><span class='Ref_to_Const'>GIN_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * OK, we have the new contents of the left page in a temporary copy 
         * now (newlpage), and likewise for the new contents of the 
         * newly-allocated right block. The original page is still unchanged. 
         * 
         * If this is a root split, we also have a temporary page containing 
         * the new contents of the root. 
         */ 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Restore the temporary copies over the real buffers. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Splitting the root, three pages to update */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN455"><span class='Ref_To_Local'>newrootpg</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Normal split, only two pages to update */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN337"><span class='Ref_To_Local'>newlpage</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN338"><span class='Ref_To_Local'>newrpage</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* We also clear childbuf's INCOMPLETE_SPLIT flag, if passed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>&= ~</span><a href="../../../include/access/ginblock.h.html#LN44"><span class='Ref_to_Const'>GIN_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* write WAL record */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN570"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We just take full page images of all the split pages. Splits 
             * are uncommon enough that it's not worth complicating the code 
             * to be more efficient. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN29"><span class='Ref_to_Const'>REGBUF_FORCE_IMAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN29"><span class='Ref_to_Const'>REGBUF_FORCE_IMAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN29"><span class='Ref_to_Const'>REGBUF_FORCE_IMAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN29"><span class='Ref_to_Const'>REGBUF_FORCE_IMAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN29"><span class='Ref_to_Const'>REGBUF_FORCE_IMAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ginbtree.c.html#LN453"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN112"><span class='Ref_to_Struct'>ginxlogSplit</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="ginbtree.c.html#LN570"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN110"><span class='Ref_to_Const'>XLOG_GIN_SPLIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN332"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN570"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN570"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN570"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN330"><span class='Ref_to_Parameter'>childbuf</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN336"><span class='Ref_To_Local'>childpage</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN570"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(btre... &raquo; </span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can release the locks/pins on the new pages now, but keep 
         * stack-&GT;buffer locked.  childbuf doesn't get unlocked either. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN451"><span class='Ref_To_Local'>rbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN454"><span class='Ref_To_Local'>lbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we split the root, we're done. Otherwise the split is not 
         * complete until the downlink for the new page has been inserted to 
         * the parent. 
         */ 
</span>        <a href="ginbtree.c.html#LN333"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN328"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rc==GPTP_SPLIT &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid return code from GIN placeToPage method: %d"</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN334"><span class='Ref_To_Local'>rc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN333"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up temp context */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN341"><span class='Ref_To_Local'>oldCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN340"><span class='Ref_To_Local'>tmpCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ginbtree.c.html#LN333"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginPlaceToPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Finish a split by inserting the downlink for the new page to parent. 
 * 
 * On entry, stack-&GT;buffer is exclusively locked. 
 * 
 * If freestack is true, all the buffers are released and unlocked as we 
 * crawl up the tree, and 'stack' is freed. Otherwise stack-&GT;buffer is kept 
 * locked, and stack is unmodified, except for possibly moving right to find 
 * the correct parent of page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN645"></a><span class='Declare_Function'>ginFinishSplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>freestack</span><span class='Delimiter'>, 
</span><a name="LN646"></a>               <a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN648"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN649"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>done</span><span class='Delimiter'>; 
</span><a name="LN650"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>first</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * freestack == false when we encounter an incompletely split page during 
     * a scan, while freestack == true is used in the normal scenario that a 
     * split is finished right after the initial insert. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>freestack</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"finishing incomplete split of block %u in gin index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* this loop crawls up the stack until the insertion is complete */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN664"></a>        <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parent</span> <span class='Operator'>= </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span><a name="LN665"></a>        <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>insertdata</span><span class='Delimiter'>; 
</span><a name="LN666"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>updateblkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* search parent to lock */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the parent page was incompletely split, finish that split first, 
         * then continue with the current one. 
         * 
         * Note: we have to finish *all* incomplete splits we encounter, even 
         * if we have to move right. Otherwise we might choose as the target a 
         * page that has no downlink in the parent, and splitting it further 
         * would fail. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)))</span> 
            <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN646"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* move right if it's needed */ 
</span>        <a href="ginbtree.c.html#LN648"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN151"><span class='Ref_to_Member'>findChildPtr</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN648"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN127"><span class='Ref_to_Macro'>GinPageRightMost</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN648"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * rightmost page, but we don't find parent, we should use 
                 * plain search... 
                 */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ginbtree.c.html#LN23"><span class='Ref_to_Proto'>ginFindParents</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN129"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN163"><span class='Ref_to_Func'>ginStepRight</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN123"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbtree.c.html#LN648"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)))</span> 
                <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN646"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (parent-&GT;off=btree-&GT;f... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* insert the downlink */ 
</span>        <a href="ginbtree.c.html#LN665"><span class='Ref_To_Local'>insertdata</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span>prepareDownlink<span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN666"><span class='Ref_To_Local'>updateblkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN649"><span class='Ref_To_Local'>done</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN24"><span class='Ref_to_Proto'>ginPlaceToPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, 
</span>                              <a href="ginbtree.c.html#LN665"><span class='Ref_To_Local'>insertdata</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN666"><span class='Ref_To_Local'>updateblkno</span></a><span class='Delimiter'>, 
</span>                              <a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN646"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN665"><span class='Ref_To_Local'>insertdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the caller requested to free the stack, unlock and release the 
         * child buffer now. Otherwise keep it pinned and locked, but if we 
         * have to recurse up the tree, we can unlock the upper pages, only 
         * keeping the page at the bottom of the stack locked. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ginbtree.c.html#LN650"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>|| </span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>freestack</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>freestack</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN664"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>; 
</span> 
        <a href="ginbtree.c.html#LN650"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ginbtree.c.html#LN649"><span class='Ref_To_Local'>done</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* unlock the parent */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>freestack</span></a><span class='Parentheses'>) 
</span>        <a href="ginbtree.c.html#LN191"><span class='Ref_to_Func'>freeGinBtreeStack</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN645"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginFinishSplit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert a value to tree described by stack. 
 * 
 * The value to be inserted is given in 'insertdata'. Its format depends 
 * on whether this is an entry or data tree, ginInsertValue just passes it 
 * through to the tree-specific callback function. 
 * 
 * During an index build, buildStats is non-null and the counters it contains 
 * are incremented as needed. 
 * 
 * NB: the passed-in stack is freed, as though by freeGinBtreeStack. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN754"></a><span class='Declare_Function'>ginInsertValue</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, 
</span><a name="LN755"></a>               <a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN757"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>done</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the leaf page was incompletely split, finish the split first */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN125"><span class='Ref_to_Macro'>GinPageIsIncompleteSplit</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)))</span> 
        <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN755"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ginbtree.c.html#LN757"><span class='Ref_To_Local'>done</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN24"><span class='Ref_to_Proto'>ginPlaceToPage</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, 
</span>                          <a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>, 
</span>                          <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN755"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbtree.c.html#LN757"><span class='Ref_To_Local'>done</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbtree.c.html#LN191"><span class='Ref_to_Func'>freeGinBtreeStack</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="ginbtree.c.html#LN27"><span class='Ref_to_Proto'>ginFinishSplit</span></a><span class='Parentheses'>(</span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN754"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="ginbtree.c.html#LN755"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginInsertValue &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>