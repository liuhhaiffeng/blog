<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gin\ginbulk.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gin\ginbulk.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * ginbulk.c 
 *    routines for fast build of inverted index 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/gin/ginbulk.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/gin_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/datum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
 
<a name="LN23"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEF_NENTRY</span>  <span class='Number'>2048</span>        <span class='Comment_Single_Line'>/* GinEntryAccumulator allocation quantum */ 
</span><a name="LN24"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEF_NPTR</span>    <span class='Number'>5</span>           <span class='Comment_Single_Line'>/* ItemPointer initial allocation quantum */ 
</span> 
 
<span class='Comment_Multi_Line'>/* Combiner function for rbtree.c */ 
</span><span class='Keyword'>static void 
</span><a name="LN29"></a><span class='Declare_Function'>ginCombineData</span><span class='Parentheses'>(</span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>existing</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newdata</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN31"></a>    <a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>eo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN29"><span class='Ref_to_Parameter'>existing</span></a><span class='Delimiter'>; 
</span><a name="LN32"></a>    <span class='Keyword'>const </span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>en</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN29"><span class='Ref_to_Parameter'>newdata</span></a><span class='Delimiter'>; 
</span><a name="LN33"></a>    <a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>accum</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN29"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note this code assumes that newdata contains only one itempointer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>&GT;= </span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN400"><span class='Ref_to_Member'>maxcount</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN400"><span class='Ref_to_Member'>maxcount</span></a> <span class='Operator'>&GT; </span>INT_MAX<span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"posting list is too long"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Reduce maintenance_work_mem."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="ginbulk.c.html#LN33"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>-= </span><a href="../../../include/utils/memutils.h.html#LN80"><span class='Ref_to_Proto'>GetMemoryChunkSpace</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN400"><span class='Ref_to_Member'>maxcount</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN97"><span class='Ref_to_Proto'>repalloc_huge</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN400"><span class='Ref_to_Member'>maxcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN33"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/memutils.h.html#LN80"><span class='Ref_to_Proto'>GetMemoryChunkSpace</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If item pointers are not ordered, they will need to be sorted later */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN398"><span class='Ref_to_Member'>shouldSort</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN56"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
        <a href="ginbulk.c.html#LN56"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>+ </span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN32"><span class='Ref_To_Local'>en</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN56"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN56"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN398"><span class='Ref_to_Member'>shouldSort</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Delimiter'>[</span><a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ginbulk.c.html#LN32"><span class='Ref_To_Local'>en</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="ginbulk.c.html#LN31"><span class='Ref_To_Local'>eo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginCombineData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Comparator function for rbtree.c */ 
</span><span class='Keyword'>static int 
</span><a name="LN71"></a><span class='Declare_Function'>cmpEntryAccumulator</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN73"></a>    <span class='Keyword'>const </span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ea</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN71"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>; 
</span><a name="LN74"></a>    <span class='Keyword'>const </span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>eb</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN71"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>; 
</span><a name="LN75"></a>    <a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>accum</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN71"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/gin_private.h.html#LN95"><span class='Ref_to_Proto'>ginCompareAttEntries</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN75"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN406"><span class='Ref_to_Member'>ginstate</span></a><span class='Delimiter'>, 
</span>                                <a href="ginbulk.c.html#LN73"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN397"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN73"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN395"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN73"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN396"><span class='Ref_to_Member'>category</span></a><span class='Delimiter'>, 
</span>                                <a href="ginbulk.c.html#LN74"><span class='Ref_To_Local'>eb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN397"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN74"><span class='Ref_To_Local'>eb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN395"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN74"><span class='Ref_To_Local'>eb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN396"><span class='Ref_to_Member'>category</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Allocator function for rbtree.c */ 
</span><span class='Keyword'>static </span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>* 
</span><a name="LN84"></a><span class='Declare_Function'>ginAllocEntryAccumulator</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN86"></a>    <a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>accum</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN84"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span><a name="LN87"></a>    <a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ea</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate memory by rather big chunks to decrease overhead.  We have no 
     * need to reclaim RBNodes individually, so this costs nothing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN408"><span class='Ref_to_Member'>entryallocator</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN409"><span class='Ref_to_Member'>eas_used</span></a> <span class='Operator'>&GT;= </span><a href="ginbulk.c.html#LN23"><span class='Ref_to_Const'>DEF_NENTRY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN408"><span class='Ref_to_Member'>entryallocator</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginbulk.c.html#LN23"><span class='Ref_to_Const'>DEF_NENTRY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/memutils.h.html#LN80"><span class='Ref_to_Proto'>GetMemoryChunkSpace</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN408"><span class='Ref_to_Member'>entryallocator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN409"><span class='Ref_to_Member'>eas_used</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate new RBNode from current chunk */ 
</span>    <a href="ginbulk.c.html#LN87"><span class='Ref_To_Local'>ea</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN408"><span class='Ref_to_Member'>entryallocator</span></a> <span class='Operator'>+ </span><a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN409"><span class='Ref_to_Member'>eas_used</span></a><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN86"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN409"><span class='Ref_to_Member'>eas_used</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN87"><span class='Ref_To_Local'>ea</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginAllocEntryAccumulator &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN108"></a><span class='Declare_Function'>ginInitBA</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* accum-&GT;ginstate is intentionally not set here */ 
</span>    <a href="ginbulk.c.html#LN108"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN108"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN408"><span class='Ref_to_Member'>entryallocator</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN108"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN409"><span class='Ref_to_Member'>eas_used</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN108"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN410"><span class='Ref_to_Member'>tree</span></a> <span class='Operator'>= </span><a href="../../../include/lib/rbtree.h.html#LN64"><span class='Ref_to_Proto'>rb_create</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="ginbulk.c.html#LN70"><span class='Ref_to_Func'>cmpEntryAccumulator</span></a><span class='Delimiter'>, 
</span>                            <a href="ginbulk.c.html#LN28"><span class='Ref_to_Func'>ginCombineData</span></a><span class='Delimiter'>, 
</span>                            <a href="ginbulk.c.html#LN83"><span class='Ref_to_Func'>ginAllocEntryAccumulator</span></a><span class='Delimiter'>, 
</span>                            <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* no freefunc needed */ 
</span>                            <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN108"><span class='Ref_to_Parameter'>accum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This is basically the same as datumCopy(), but extended to count 
 * palloc'd space in accum-&GT;allocatedMemory. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN127"></a><span class='Declare_Function'>getDatumCopy</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN129"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="ginbulk.c.html#LN127"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN406"><span class='Ref_to_Member'>ginstate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN66"><span class='Ref_to_Member'>origTupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="ginbulk.c.html#LN127"><span class='Ref_to_Parameter'>attnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN130"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN129"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attbyval<span class='Parentheses'>) 
</span>        <a href="ginbulk.c.html#LN130"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><span class='Keyword'>value</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ginbulk.c.html#LN130"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/datum.h.html#LN30"><span class='Ref_to_Proto'>datumCopy</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN129"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attlen<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN127"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/memutils.h.html#LN80"><span class='Ref_to_Proto'>GetMemoryChunkSpace</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN130"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="ginbulk.c.html#LN130"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Find/store one entry from indexed value. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN146"></a><span class='Declare_Function'>ginInsertBAEntry</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Delimiter'>, 
</span><a name="LN147"></a>                 <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>heapptr</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, 
</span><a name="LN148"></a>                 <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Declare_Parameter'>category</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN150"></a>    <a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Declare_Local'>eatmp</span><span class='Delimiter'>; 
</span><a name="LN151"></a>    <a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ea</span><span class='Delimiter'>; 
</span><a name="LN152"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNew</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For the moment, fill only the fields of eatmp that will be looked at by 
     * cmpEntryAccumulator or ginCombineData. 
     */ 
</span>    <a href="ginbulk.c.html#LN150"><span class='Ref_To_Local'>eatmp</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN397"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN147"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN150"><span class='Ref_To_Local'>eatmp</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN395"><span class='Ref_to_Member'>key</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN148"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN150"><span class='Ref_To_Local'>eatmp</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN396"><span class='Ref_to_Member'>category</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN148"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* temporarily set up single-entry itempointer list */ 
</span>    <a href="ginbulk.c.html#LN150"><span class='Ref_To_Local'>eatmp</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN147"><span class='Ref_to_Parameter'>heapptr</span></a><span class='Delimiter'>; 
</span> 
    <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/lib/rbtree.h.html#LN74"><span class='Ref_to_Proto'>rb_insert</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN146"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN410"><span class='Ref_to_Member'>tree</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/lib/rbtree.h.html#LN22"><span class='Ref_to_Struct'>RBNode</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ginbulk.c.html#LN150"><span class='Ref_To_Local'>eatmp</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="ginbulk.c.html#LN152"><span class='Ref_To_Local'>isNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN152"><span class='Ref_To_Local'>isNew</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Finish initializing new tree entry, including making permanent 
         * copies of the datum (if it's not null) and itempointer. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN148"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginblock.h.html#LN198"><span class='Ref_to_Const'>GIN_CAT_NORM_KEY</span></a><span class='Parentheses'>) 
</span>            <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN395"><span class='Ref_to_Member'>key</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN126"><span class='Ref_to_Func'>getDatumCopy</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN146"><span class='Ref_to_Parameter'>accum</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN147"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN148"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN400"><span class='Ref_to_Member'>maxcount</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN24"><span class='Ref_to_Const'>DEF_NPTR</span></a><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN398"><span class='Ref_to_Member'>shouldSort</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginbulk.c.html#LN24"><span class='Ref_to_Const'>DEF_NPTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="ginbulk.c.html#LN147"><span class='Ref_to_Parameter'>heapptr</span></a><span class='Delimiter'>; 
</span>        <a href="ginbulk.c.html#LN146"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/memutils.h.html#LN80"><span class='Ref_to_Proto'>GetMemoryChunkSpace</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN151"><span class='Ref_To_Local'>ea</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * ginCombineData did everything needed. 
         */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ginInsertBAEntry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert the entries for one heap pointer. 
 * 
 * Since the entries are being inserted into a balanced binary tree, you 
 * might think that the order of insertion wouldn't be critical, but it turns 
 * out that inserting the entries in sorted order results in a lot of 
 * rebalancing operations and is slow.  To prevent this, we attempt to insert 
 * the nodes in an order that will produce a nearly-balanced tree if the input 
 * is in fact sorted. 
 * 
 * We do this as follows.  First, we imagine that we have an array whose size 
 * is the smallest power of two greater than or equal to the actual array 
 * size.  Second, we insert the middle entry of our virtual array into the 
 * tree; then, we insert the middles of each half of our virtual array, then 
 * middles of quarters, etc. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN208"></a><span class='Declare_Function'>ginInsertBAEntries</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Delimiter'>, 
</span><a name="LN209"></a>                   <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>heapptr</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, 
</span><a name="LN210"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>entries</span><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>categories</span><span class='Delimiter'>, 
</span><a name="LN211"></a>                   <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>nentries</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN213"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>step</span> <span class='Operator'>= </span><a href="ginbulk.c.html#LN211"><span class='Ref_to_Parameter'>nentries</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN211"><span class='Ref_to_Parameter'>nentries</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN209"><span class='Ref_to_Parameter'>heapptr</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="ginbulk.c.html#LN209"><span class='Ref_to_Parameter'>attnum</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * step will contain largest power of 2 and &LT;= nentries 
     */ 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN233"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="ginbulk.c.html#LN233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginbulk.c.html#LN211"><span class='Ref_to_Parameter'>nentries</span></a> <span class='Operator'>&& </span><a href="ginbulk.c.html#LN233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginbulk.c.html#LN233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+= </span><a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span> <span class='Comment_Multi_Line'>/* *2 */ </span><span class='Parentheses'>) 
</span>            <a href="ginbulk.c.html#LN145"><span class='Ref_to_Func'>ginInsertBAEntry</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN208"><span class='Ref_to_Parameter'>accum</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN209"><span class='Ref_to_Parameter'>heapptr</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN209"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, 
</span>                             <a href="ginbulk.c.html#LN210"><span class='Ref_to_Parameter'>entries</span></a><span class='Delimiter'>[</span><a href="ginbulk.c.html#LN233"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ginbulk.c.html#LN210"><span class='Ref_to_Parameter'>categories</span></a><span class='Delimiter'>[</span><a href="ginbulk.c.html#LN233"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ginbulk.c.html#LN213"><span class='Ref_To_Local'>step</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* /2 */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ginInsertBAEntries &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN244"></a><span class='Declare_Function'>qsortCompareItemPointers</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN246"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN244"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="ginbulk.c.html#LN244"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert that there are no equal item pointers being sorted */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN246"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="ginbulk.c.html#LN246"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Prepare to read out the rbtree contents using ginGetBAEntry */ 
</span><span class='Keyword'>void 
</span><a name="LN255"></a><span class='Declare_Function'>ginBeginBAScan</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/lib/rbtree.h.html#LN77"><span class='Ref_to_Proto'>rb_begin_iterate</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN255"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN410"><span class='Ref_to_Member'>tree</span></a><span class='Delimiter'>, </span><a href="../../../include/lib/rbtree.h.html#LN36"><span class='Ref_to_EnumConst'>LeftRightWalk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginbulk.c.html#LN255"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN411"><span class='Ref_to_Member'>tree_walk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get the next entry in sequence from the BuildAccumulator's rbtree. 
 * This consists of a single key datum and a list (array) of one or more 
 * heap TIDs in which that key is found.  The list is guaranteed sorted. 
 */ 
</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>* 
</span><a name="LN266"></a><span class='Declare_Function'>ginGetBAEntry</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Delimiter'>, 
</span><a name="LN267"></a>              <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>category</span><span class='Delimiter'>, 
</span><a name="LN268"></a>              <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN270"></a>    <a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN271"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>list</span><span class='Delimiter'>; 
</span> 
    <a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN392"><span class='Ref_to_Struct'>GinEntryAccumulator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/lib/rbtree.h.html#LN79"><span class='Ref_to_Proto'>rb_iterate</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginbulk.c.html#LN266"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN411"><span class='Ref_to_Member'>tree_walk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* no more entries */ 
</span> 
    <span class='Operator'>*</span><a href="ginbulk.c.html#LN267"><span class='Ref_to_Parameter'>attnum</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN397"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="ginbulk.c.html#LN267"><span class='Ref_to_Parameter'>key</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN395"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="ginbulk.c.html#LN267"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN396"><span class='Ref_to_Member'>category</span></a><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN271"><span class='Ref_To_Local'>list</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN399"><span class='Ref_to_Member'>list</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="ginbulk.c.html#LN268"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN271"><span class='Ref_To_Local'>list</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN398"><span class='Ref_to_Member'>shouldSort</span></a> <span class='Operator'>&& </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="ginbulk.c.html#LN271"><span class='Ref_To_Local'>list</span></a><span class='Delimiter'>, </span><a href="ginbulk.c.html#LN270"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN401"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="ginbulk.c.html#LN243"><span class='Ref_to_Func'>qsortCompareItemPointers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ginbulk.c.html#LN271"><span class='Ref_To_Local'>list</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginGetBAEntry &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>