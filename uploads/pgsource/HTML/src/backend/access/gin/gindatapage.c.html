<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gin\gindatapage.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gin\gindatapage.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:27 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * gindatapage.c 
 *    routines for handling GIN posting tree pages. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/gin/gindatapage.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/gin_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/ginxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/ilist.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Min, Max and Target size of posting lists stored on leaf pages, in bytes. 
 * 
 * The code can deal with any size, but random access is more efficient when 
 * a number of smaller lists are stored, rather than one big list. If a 
 * posting list would become larger than Max size as a result of insertions, 
 * it is split into two. If a posting list would be smaller than minimum 
 * size, it is merged with the next posting list. 
 */ 
</span><a name="LN32"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>GinPostingListSegmentMaxSize</span> <span class='Number'>384</span> 
<a name="LN33"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>GinPostingListSegmentTargetSize</span> <span class='Number'>256</span> 
<a name="LN34"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>GinPostingListSegmentMinSize</span> <span class='Number'>128</span> 
 
<span class='Comment_Multi_Line'>/* 
 * At least this many items fit in a GinPostingListSegmentMaxSize-bytes 
 * long segment. This is used when estimating how much space is required 
 * for N items, at minimum. 
 */ 
</span><a name="LN41"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MinTuplesPerSegment</span> <span class='Parentheses'>((</span><a href="gindatapage.c.html#LN32"><span class='Ref_to_Const'>GinPostingListSegmentMaxSize</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>6</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * A working struct for manipulating a posting tree leaf page. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN48"></a>    <a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a>  <span class='Declare_Member'>segments</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* a list of leafSegmentInfos */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The following fields represent how the segments are split across pages, 
     * if a page split is required. Filled in by leafRepackItems. 
     */ 
</span><a name="LN54"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Member'>lastleft</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* last segment on left page */ 
</span><a name="LN55"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>lsize</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* total size on left page */ 
</span><a name="LN56"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>rsize</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* total size on right page */ 
</span> 
<a name="LN58"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>oldformat</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* page is in pre-9.4 format on disk */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we need WAL data representing the reconstructed leaf page, it's 
     * stored here by computeLeafRecompressWALData. 
     */ 
</span><a name="LN64"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>walinfo</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* buffer start */ 
</span><a name="LN65"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>walinfolen</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* and length */ 
</span><a name="LN66"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end {anondisassembledLeaf} &raquo; </span> <span class='Declare_Typedef'>disassembledLeaf</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN70"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>node</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* linked list pointers */ 
</span> 
    <span class='Comment_Multi_Line'>/*------------- 
     * 'action' indicates the status of this in-memory segment, compared to 
     * what's on disk. It is one of the GIN_SEGMENT_* action codes: 
     * 
     * UNMODIFIED   no changes 
     * DELETE       the segment is to be removed. 'seg' and 'items' are 
     *              ignored 
     * INSERT       this is a completely new segment 
     * REPLACE      this replaces an existing segment with new content 
     * ADDITEMS     like REPLACE, but no items have been removed, and we track 
     *              in detail what items have been added to this segment, in 
     *              'modifieditems' 
     *------------- 
     */ 
</span><a name="LN86"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>action</span><span class='Delimiter'>; 
</span> 
<a name="LN88"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Declare_Member'>modifieditems</span><span class='Delimiter'>; 
</span><a name="LN89"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>nmodifieditems</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The following fields represent the items in this segment. If 'items' is 
     * not NULL, it contains a palloc'd array of the itemsin this segment. If 
     * 'seg' is not NULL, it contains the items in an already-compressed 
     * format. It can point to an on-disk page (!modified), or a palloc'd 
     * segment in memory. If both are set, they must represent the same items. 
     */ 
</span><a name="LN98"></a>    <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Member'>seg</span><span class='Delimiter'>; 
</span><a name="LN99"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Member'>items</span><span class='Delimiter'>; 
</span><a name="LN100"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nitems</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* # of items in 'items', if items != NULL */ 
</span><a name="LN101"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end {anonleafSegmentInfo} &raquo; </span> <span class='Declare_Typedef'>leafSegmentInfo</span><span class='Delimiter'>; 
</span> 
<a name="LN103"></a><span class='Keyword'>static </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Prototype'>dataLeafPageGetUncompressed</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nitems</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN104"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dataSplitPageInternal</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>origbuf</span><span class='Delimiter'>, 
</span><a name="LN105"></a>                      <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN106"></a>                      <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN107"></a>                      <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newlpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newrpage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN109"></a><span class='Keyword'>static </span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>disassembleLeaf</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN110"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>leafRepackItems</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>remaining</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN111"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>addItemsToLeaf</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>newItems</span><span class='Delimiter'>, 
</span><a name="LN112"></a>               <span class='Keyword'>int </span><span class='Declare_Parameter'>nNewItems</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN114"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>computeLeafRecompressWALData</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN115"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dataPlaceToPageLeafRecompress</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN116"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dataPlaceToPageLeafSplit</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Delimiter'>, 
</span><a name="LN117"></a>                         <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Parameter'>lbound</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Parameter'>rbound</span><span class='Delimiter'>, 
</span><a name="LN118"></a>                         <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>lpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>rpage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Read TIDs from leaf data page to single uncompressed array. The TIDs are 
 * returned in ascending order. 
 * 
 * advancePast is a hint, indicating that the caller is only interested in 
 * TIDs &GT; advancePast. To return all items, use ItemPointerSetMin. 
 * 
 * Note: This function can still return items smaller than advancePast that 
 * are in the same posting list as the items of interest, so the caller must 
 * still check all the returned items. But passing it allows this function to 
 * skip whole posting lists. 
 */ 
</span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> 
<a name="LN133"></a><span class='Declare_Function'>GinDataLeafPageGetItems</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Parameter'>advancePast</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN135"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN119"><span class='Ref_to_Macro'>GinPageIsCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN139"></a>        <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seg</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN140"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>len</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN270"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingListSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN141"></a>        <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>endptr</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN139"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN140"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span><a name="LN142"></a>        <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip to the segment containing advancePast+1 */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>advancePast</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN142"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN333"><span class='Ref_to_Macro'>GinNextPostingListSegment</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN139"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN142"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN141"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>&& 
</span>                   <a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN142"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN327"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>advancePast</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="gindatapage.c.html#LN139"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN142"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN142"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN333"><span class='Ref_to_Macro'>GinNextPostingListSegment</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN139"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="gindatapage.c.html#LN140"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN141"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN139"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN140"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN135"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN280"><span class='Ref_to_Func'>ginPostingListDecodeAllSegments</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN139"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN140"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN135"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if GinPageIsCompressed(p... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN167"></a>        <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN103"><span class='Ref_to_Proto'>dataLeafPageGetUncompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN135"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><span class='Operator'>*</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN135"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN167"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gindatapage.c.html#LN133"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN135"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GinDataLeafPageGetItems &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Places all TIDs from leaf data page to bitmap. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN180"></a><span class='Declare_Function'>GinDataLeafPageGetItemsToTbm</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../nodes/tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN182"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>uncompressed</span><span class='Delimiter'>; 
</span><a name="LN183"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nitems</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN119"><span class='Ref_to_Macro'>GinPageIsCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN180"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN187"></a>        <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN180"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN188"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>len</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN270"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingListSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN180"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN183"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN341"><span class='Ref_to_Func'>ginPostingListDecodeAllSegmentsToTbm</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN187"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN188"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN180"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN182"><span class='Ref_To_Local'>uncompressed</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN103"><span class='Ref_to_Proto'>dataLeafPageGetUncompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN180"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN183"><span class='Ref_To_Local'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN183"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/nodes/tidbitmap.h.html#LN54"><span class='Ref_to_Proto'>tbm_add_tuples</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN180"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN182"><span class='Ref_To_Local'>uncompressed</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN183"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN183"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GinDataLeafPageGetItemsToTbm &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get pointer to the uncompressed array of items on a pre-9.4 format 
 * uncompressed leaf page. The number of items in the array is returned in 
 * *nitems. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> 
<a name="LN209"></a><span class='Declare_Function'>dataLeafPageGetUncompressed</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nitems</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN211"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>items</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN119"><span class='Ref_to_Macro'>GinPageIsCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN209"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In the old pre-9.4 page format, the whole page content is used for 
     * uncompressed items, and the number of items is stored in 'maxoff' 
     */ 
</span>    <a href="gindatapage.c.html#LN211"><span class='Ref_To_Local'>items</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN285"><span class='Ref_to_Macro'>GinDataPageGetData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN209"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="gindatapage.c.html#LN209"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN209"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN211"><span class='Ref_To_Local'>items</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Check if we should follow the right link to find the item we're searching 
 * for. 
 * 
 * Compares inserting item pointer with the right bound of the current page. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN232"></a><span class='Declare_Function'>dataIsMoveRight</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN234"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>iptr</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN232"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN127"><span class='Ref_to_Macro'>GinPageRightMost</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN232"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN232"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN171"><span class='Ref_to_Member'>itemptr</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN234"><span class='Ref_To_Local'>iptr</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>? </span><span class='Boolean'>TRUE </span><span class='Operator'>: </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Find correct PostingItem in non-leaf page. It is assumed that this is 
 * the correct page, and the searched value SHOULD be on the page. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN247"></a><span class='Declare_Function'>dataLocateItem</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN249"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>low</span><span class='Delimiter'>, 
</span><a name="LN250"></a>                <span class='Declare_Local'>high</span><span class='Delimiter'>, 
</span><a name="LN251"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN252"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pitem</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN253"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN254"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN124"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN162"><span class='Ref_to_Member'>fullScan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN128"><span class='Ref_to_Member'>predictNumber</span></a> <span class='Operator'>*= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN146"><span class='Ref_to_Member'>getLeftMostChild</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gindatapage.c.html#LN249"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN251"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&GT;= </span><a href="gindatapage.c.html#LN249"><span class='Ref_To_Local'>low</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&GT; </span><a href="gindatapage.c.html#LN249"><span class='Ref_To_Local'>low</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN274"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>mid</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN249"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>+ </span><span class='Parentheses'>((</span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN249"><span class='Ref_To_Local'>low</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN252"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN274"><span class='Ref_To_Local'>mid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN274"><span class='Ref_To_Local'>mid</span></a> <span class='Operator'>== </span><a href="gindatapage.c.html#LN251"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Right infinity, page already correctly chosen with a help of 
             * dataIsMoveRight 
             */ 
</span>            <a href="gindatapage.c.html#LN253"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN252"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN274"><span class='Ref_To_Local'>mid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN253"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN171"><span class='Ref_to_Member'>itemptr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN252"><span class='Ref_To_Local'>pitem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN179"><span class='Ref_to_Member'>key</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN253"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN274"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN252"><span class='Ref_To_Local'>pitem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN253"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN249"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN274"><span class='Ref_To_Local'>mid</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN274"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while high&GT;low &raquo; </span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&LT;= </span><a href="gindatapage.c.html#LN251"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN247"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN252"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN254"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN250"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN252"><span class='Ref_To_Local'>pitem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataLocateItem &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find link to blkno on non-leaf page, returns offset of PostingItem 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> 
<a name="LN314"></a><span class='Declare_Function'>dataFindChildPtr</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>storedOff</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN316"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN317"></a>                <span class='Declare_Local'>maxoff</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span><a name="LN318"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pitem</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if page isn't changed, we return storedOff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>storedOff</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>storedOff</span></a> <span class='Operator'>&LT;= </span><a href="gindatapage.c.html#LN317"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN318"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>storedOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN318"><span class='Ref_To_Local'>pitem</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>storedOff</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * we hope, that needed pointer goes to right. It's true if there 
         * wasn't a deletion 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>storedOff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gindatapage.c.html#LN317"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN318"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN318"><span class='Ref_To_Local'>pitem</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="gindatapage.c.html#LN317"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>storedOff</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* last chance */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gindatapage.c.html#LN317"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN318"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN318"><span class='Ref_To_Local'>pitem</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="gindatapage.c.html#LN314"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="gindatapage.c.html#LN316"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataFindChildPtr &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return blkno of leftmost child 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN359"></a><span class='Declare_Function'>dataGetLeftMostPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN361"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pitem</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN359"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN359"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN359"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN361"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN359"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN361"><span class='Ref_To_Local'>pitem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add PostingItem to a non-leaf page. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN375"></a><span class='Declare_Function'>GinDataPageAddPostingItem</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN377"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span><a name="LN378"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN182"><span class='Ref_to_Macro'>PostingItemGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>data</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN378"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN377"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN378"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>!= </span><a href="gindatapage.c.html#LN377"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN378"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="gindatapage.c.html#LN378"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN377"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>*</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN378"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN377"><span class='Ref_To_Local'>maxoff</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><a href="gindatapage.c.html#LN377"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also set pd_lower to the end of the posting items, to follow the 
     * "standard" page layout, so that we can squeeze out the unused space 
     * from full-page images. 
     */ 
</span>    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN375"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN377"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GinDataPageAddPostingItem &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete posting item from non-leaf page 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN412"></a><span class='Declare_Function'>GinPageDeletePostingItem</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN414"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT;= </span><a href="gindatapage.c.html#LN414"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>!= </span><a href="gindatapage.c.html#LN414"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN414"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN414"><span class='Ref_To_Local'>maxoff</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><a href="gindatapage.c.html#LN414"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN412"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN414"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Prepare to insert data on a leaf data page. 
 * 
 * If it will fit, return GPTP_INSERT after doing whatever setup is needed 
 * before we enter the insertion critical section.  *ptp_workspace can be 
 * set to pass information along to the execPlaceToPage function. 
 * 
 * If it won't fit, perform a page split and return two temporary page 
 * images into *newlpage and *newrpage, with result GPTP_SPLIT. 
 * 
 * In neither case should the given page buffer be modified here. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/gin_private.h.html#LN135"><span class='Ref_to_Typedef'>GinPlaceToPageRC</span></a> 
<a name="LN443"></a><span class='Declare_Function'>dataBeginPlaceToPageLeaf</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN444"></a>                         <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, 
</span><a name="LN445"></a>                         <span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>ptp_workspace</span><span class='Delimiter'>, 
</span><a name="LN446"></a>                         <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newlpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newrpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN448"></a>    <a href="../../../include/access/gin_private.h.html#LN185"><span class='Ref_to_Typedef'>GinBtreeDataLeafInsertData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>items</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN444"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>; 
</span><a name="LN449"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>newItems</span> <span class='Operator'>= &</span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN187"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a><span class='Delimiter'>]; 
</span><a name="LN450"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxitems</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a><span class='Delimiter'>; 
</span><a name="LN451"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN452"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN453"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>rbound</span><span class='Delimiter'>; 
</span><a name="LN454"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>lbound</span><span class='Delimiter'>; 
</span><a name="LN455"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needsplit</span><span class='Delimiter'>; 
</span><a name="LN456"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>append</span><span class='Delimiter'>; 
</span><a name="LN457"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span><span class='Delimiter'>; 
</span><a name="LN458"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span><span class='Delimiter'>; 
</span><a name="LN459"></a>    <a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>leaf</span><span class='Delimiter'>; 
</span><a name="LN460"></a>    <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lastleftinfo</span><span class='Delimiter'>; 
</span><a name="LN461"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>maxOldItem</span><span class='Delimiter'>; 
</span><a name="LN462"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>remaining</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN453"><span class='Ref_To_Local'>rbound</span></a> <span class='Operator'>= *</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN451"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Count how many of the new items belong to this page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN127"><span class='Ref_to_Macro'>GinPageRightMost</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN451"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN449"><span class='Ref_To_Local'>newItems</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN453"><span class='Ref_To_Local'>rbound</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * This needs to go to some other location in the tree. (The 
                 * caller should've chosen the insert location so that at 
                 * least the first item goes here.) 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Disassemble the data on the page */ 
</span>    <a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN109"><span class='Ref_to_Proto'>disassembleLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN451"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Are we appending to the end of the page? IOW, are all the new items 
     * larger than any of the existing items. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../../include/lib/ilist.h.html#LN464"><span class='Ref_to_Func'>dlist_tail_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN267"><span class='Ref_to_Func'>ginPostingListDecode</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Operator'>&</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN461"><span class='Ref_To_Local'>maxOldItem</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN449"><span class='Ref_To_Local'>newItems</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN461"><span class='Ref_To_Local'>maxOldItem</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/ginblock.h.html#LN156"><span class='Ref_to_Macro'>ItemPointerSetMin</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN461"><span class='Ref_To_Local'>maxOldItem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're appending to the end of the page, we will append as many items 
     * as we can fit (after splitting), and stop when the pages becomes full. 
     * Otherwise we have to limit the number of new items to insert, because 
     * once we start packing we can't just stop when we run out of space, 
     * because we must make sure that all the old items still fit. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN119"><span class='Ref_to_Macro'>GinPageIsCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN451"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="gindatapage.c.html#LN458"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN276"><span class='Ref_to_Macro'>GinDataLeafPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN451"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="gindatapage.c.html#LN458"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Even when appending, trying to append more items than will fit is 
         * not completely free, because we will merge the new items and old 
         * items into an array below. In the best case, every new item fits in 
         * a single byte, and we can use all the free space on the old page as 
         * well as the new page. For simplicity, ignore segment overhead etc. 
         */ 
</span>        <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN458"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>+ </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Calculate a conservative estimate of how many new items we can fit 
         * on the two pages after splitting. 
         * 
         * We can use any remaining free space on the old page to store full 
         * segments, as well as the new page. Each full-sized segment can hold 
         * at least MinTuplesPerSegment items 
         */ 
</span><a name="LN545"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nnewsegments</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN545"><span class='Ref_To_Local'>nnewsegments</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN458"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>/ </span><a href="gindatapage.c.html#LN32"><span class='Ref_to_Const'>GinPostingListSegmentMaxSize</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN545"><span class='Ref_To_Local'>nnewsegments</span></a> <span class='Operator'>+= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a> <span class='Operator'>/ </span><a href="gindatapage.c.html#LN32"><span class='Ref_to_Const'>GinPostingListSegmentMaxSize</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN545"><span class='Ref_To_Local'>nnewsegments</span></a> <span class='Operator'>* </span><a href="gindatapage.c.html#LN41"><span class='Ref_to_Const'>MinTuplesPerSegment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Add the new items to the segment list */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN111"><span class='Ref_to_Proto'>addItemsToLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN449"><span class='Ref_To_Local'>newItems</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* all items were duplicates, we have nothing to do */ 
</span>        <a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../../include/access/gin_private.h.html#LN137"><span class='Ref_to_EnumConst'>GPTP_NO_WORK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Pack the items back to compressed segments, ready for writing to disk. 
     */ 
</span>    <a href="gindatapage.c.html#LN455"><span class='Ref_To_Local'>needsplit</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN110"><span class='Ref_to_Proto'>leafRepackItems</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN462"><span class='Ref_To_Local'>remaining</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Did all the new items fit? 
     * 
     * If we're appending, it's OK if they didn't. But as a sanity check, 
     * verify that all the old items fit. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN462"><span class='Ref_To_Local'>remaining</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a> <span class='Operator'>|| </span><a href="../../storage/page/itemptr.c.html#LN50"><span class='Ref_to_Func'>ItemPointerCompare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN461"><span class='Ref_To_Local'>maxOldItem</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN462"><span class='Ref_To_Local'>remaining</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not split GIN page; all old items didn't fit"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Count how many of the new items did fit. */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>; </span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN449"><span class='Ref_To_Local'>newItems</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN462"><span class='Ref_To_Local'>remaining</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not split GIN page; no new items fit"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN452"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN455"><span class='Ref_To_Local'>needsplit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Great, all the items fit on a single page.  If needed, prepare data 
         * for a WAL record describing the changes we'll make. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
            <a href="gindatapage.c.html#LN114"><span class='Ref_to_Proto'>computeLeafRecompressWALData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We're ready to enter the critical section, but 
         * dataExecPlaceToPageLeaf will need access to the "leaf" data. 
         */ 
</span>        <span class='Operator'>*</span><a href="gindatapage.c.html#LN445"><span class='Ref_to_Parameter'>ptp_workspace</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"appended %d new items to block %u; %d bytes (%d to go)"</span><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"inserted %d new items to block %u; %d bytes (%d to go)"</span><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !needsplit &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Have to split. 
         * 
         * leafRepackItems already divided the segments between the left and 
         * the right page. It filled the left page as full as possible, and 
         * put the rest to the right page. When building a new index, that's 
         * good, because the table is scanned from beginning to end and there 
         * won't be any more insertions to the left page during the build. 
         * This packs the index as tight as possible. But otherwise, split 
         * 50/50, by moving segments from the left page to the right page 
         * until they're balanced. 
         * 
         * As a further heuristic, when appending items to the end of the 
         * page, try to make the left page 75% full, on the assumption that 
         * subsequent insertions will probably also go to the end. This packs 
         * the index somewhat tighter when appending to a table, which is very 
         * common. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN163"><span class='Ref_to_Member'>isBuild</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN410"><span class='Ref_to_Func'>dlist_has_prev</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* ignore deleted segments */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="gindatapage.c.html#LN457"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Note that we check that the right page doesn't become 
                     * more full than the left page even when appending. It's 
                     * possible that we added enough items to make both pages 
                     * more than 75% full. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN457"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN457"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN457"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>* </span><span class='Number'>3</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>4</span><span class='Parentheses'>)</span> 
                            <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>-= </span><a href="gindatapage.c.html#LN457"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN457"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if lastleftinfo-&GT;action!... &raquo; </span> 
                <a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN429"><span class='Ref_to_Func'>dlist_prev_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while dlist_has_prev(&leaf-... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !btree-&GT;isBuild &raquo; </span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fetch the max item in the left page's last segment; it becomes the 
         * right bound of the page. 
         */ 
</span>        <a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN267"><span class='Ref_to_Func'>ginPostingListDecode</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Operator'>&</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN454"><span class='Ref_To_Local'>lbound</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN460"><span class='Ref_To_Local'>lastleftinfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now allocate a couple of temporary page images, and fill them. 
         */ 
</span>        <span class='Operator'>*</span><a href="gindatapage.c.html#LN446"><span class='Ref_to_Parameter'>newlpage</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="gindatapage.c.html#LN446"><span class='Ref_to_Parameter'>newrpage</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN116"><span class='Ref_to_Proto'>dataPlaceToPageLeafSplit</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN454"><span class='Ref_To_Local'>lbound</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN453"><span class='Ref_To_Local'>rbound</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>*</span><a href="gindatapage.c.html#LN446"><span class='Ref_to_Parameter'>newlpage</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="gindatapage.c.html#LN446"><span class='Ref_to_Parameter'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN127"><span class='Ref_to_Macro'>GinPageRightMost</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN451"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>               <a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gindatapage.c.html#LN446"><span class='Ref_to_Parameter'>newlpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gindatapage.c.html#LN446"><span class='Ref_to_Parameter'>newrpage</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN456"><span class='Ref_To_Local'>append</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"appended %d items to block %u; split %d/%d (%d to go)"</span><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"inserted %d items to block %u; split %d/%d (%d to go)"</span><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN443"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN459"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a><span class='Delimiter'>, 
</span>                 <a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="gindatapage.c.html#LN448"><span class='Ref_To_Local'>items</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN450"><span class='Ref_To_Local'>maxitems</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN455"><span class='Ref_To_Local'>needsplit</span></a> <span class='Operator'>? </span><a href="../../../include/access/gin_private.h.html#LN139"><span class='Ref_to_EnumConst'>GPTP_SPLIT</span></a> <span class='Operator'>: </span><a href="../../../include/access/gin_private.h.html#LN138"><span class='Ref_to_EnumConst'>GPTP_INSERT</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataBeginPlaceToPageLeaf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform data insertion after beginPlaceToPage has decided it will fit. 
 * 
 * This is invoked within a critical section, and XLOG record creation (if 
 * needed) is already started.  The target buffer is registered in slot 0. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN711"></a><span class='Declare_Function'>dataExecPlaceToPageLeaf</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN712"></a>                        <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptp_workspace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN714"></a>    <a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>leaf</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN712"><span class='Ref_to_Parameter'>ptp_workspace</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Apply changes to page */ 
</span>    <a href="gindatapage.c.html#LN115"><span class='Ref_to_Proto'>dataPlaceToPageLeafRecompress</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN711"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN714"><span class='Ref_To_Local'>leaf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If needed, register WAL data built by computeLeafRecompressWALData */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN711"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN714"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN64"><span class='Ref_to_Member'>walinfo</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN714"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN65"><span class='Ref_to_Member'>walinfolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Vacuum a posting tree leaf page. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN730"></a><span class='Declare_Function'>ginVacuumPostingTreeLeaf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>indexrel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="ginvacuum.c.html#LN26"><span class='Ref_to_Struct'>GinVacuumState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gvs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN732"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN733"></a>    <a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>leaf</span><span class='Delimiter'>; 
</span><a name="LN734"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>removedsomething</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN735"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN109"><span class='Ref_to_Proto'>disassembleLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN732"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Vacuum each segment. */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN735"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN742"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN735"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN743"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>oldsegsize</span><span class='Delimiter'>; 
</span><a name="LN744"></a>        <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>cleaned</span><span class='Delimiter'>; 
</span><a name="LN745"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ncleaned</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN267"><span class='Ref_to_Func'>ginPostingListDecode</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, 
</span>                                                  <span class='Operator'>&</span><a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN743"><span class='Ref_To_Local'>oldsegsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gindatapage.c.html#LN743"><span class='Ref_To_Local'>oldsegsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN744"><span class='Ref_To_Local'>cleaned</span></a> <span class='Operator'>= </span><a href="ginvacuum.c.html#LN45"><span class='Ref_to_Func'>ginVacuumItemPointers</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>gvs</span></a><span class='Delimiter'>, 
</span>                                        <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, 
</span>                                        <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="gindatapage.c.html#LN745"><span class='Ref_To_Local'>ncleaned</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN744"><span class='Ref_To_Local'>cleaned</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN745"><span class='Ref_To_Local'>ncleaned</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN766"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>npacked</span><span class='Delimiter'>; 
</span> 
                <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN178"><span class='Ref_to_Func'>ginCompressPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN744"><span class='Ref_To_Local'>cleaned</span></a><span class='Delimiter'>, 
</span>                                                      <a href="gindatapage.c.html#LN745"><span class='Ref_To_Local'>ncleaned</span></a><span class='Delimiter'>, 
</span>                                                      <a href="gindatapage.c.html#LN743"><span class='Ref_To_Local'>oldsegsize</span></a><span class='Delimiter'>, 
</span>                                                      <span class='Operator'>&</span><a href="gindatapage.c.html#LN766"><span class='Ref_To_Local'>npacked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Removing an item never increases the size of the segment */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN766"><span class='Ref_To_Local'>npacked</span></a> <span class='Operator'>!= </span><a href="gindatapage.c.html#LN745"><span class='Ref_To_Local'>ncleaned</span></a><span class='Parentheses'>) 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not fit vacuumed posting list"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="gindatapage.c.html#LN742"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN745"><span class='Ref_To_Local'>ncleaned</span></a><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN734"><span class='Ref_To_Local'>removedsomething</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cleaned &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we removed any items, reconstruct the page from the pieces. 
     * 
     * We don't try to re-encode the segments here, even though some of them 
     * might be really small now that we've removed some items from them. It 
     * seems like a waste of effort, as there isn't really any benefit from 
     * larger segments per se; larger segments only help to pack more items in 
     * the same space. We might as well delay doing that until the next 
     * insertion, which will need to re-encode at least part of the page 
     * anyway. 
     * 
     * Also note if the page was in uncompressed, pre-9.4 format before, it is 
     * now represented as one huge segment that contains all the items. It 
     * might make sense to split that, to speed up random access, but we don't 
     * bother. You'll have to REINDEX anyway if you want the full gain of the 
     * new tighter index format. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN734"><span class='Ref_To_Local'>removedsomething</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN808"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>modified</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make sure we have a palloc'd copy of all segments, after the first 
         * segment that is modified. (dataPlaceToPageLeafRecompress requires 
         * this). 
         */ 
</span>        <a href="gindatapage.c.html#LN808"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN735"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN818"></a>            <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                                       <a href="gindatapage.c.html#LN735"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN818"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>                <a href="gindatapage.c.html#LN808"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN808"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN818"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN825"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN818"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN826"></a>                <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN825"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN826"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN818"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN825"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN818"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN826"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>indexrel</span></a><span class='Parentheses'>))</span> 
            <a href="gindatapage.c.html#LN114"><span class='Ref_to_Proto'>computeLeafRecompressWALData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Apply changes to page */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN115"><span class='Ref_to_Proto'>dataPlaceToPageLeafRecompress</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>indexrel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN845"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN730"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN64"><span class='Ref_to_Member'>walinfo</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN733"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN65"><span class='Ref_to_Member'>walinfolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN845"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN142"><span class='Ref_to_Const'>XLOG_GIN_VACUUM_DATA_LEAF_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN732"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN845"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if removedsomething &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ginVacuumPostingTreeLeaf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct a ginxlogRecompressDataLeaf record representing the changes 
 * in *leaf.  (Because this requires a palloc, we have to do it before 
 * we enter the critical section that actually updates the page.) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN864"></a><span class='Declare_Function'>computeLeafRecompressWALData</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN866"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmodified</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN867"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>walbufbegin</span><span class='Delimiter'>; 
</span><a name="LN868"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>walbufend</span><span class='Delimiter'>; 
</span><a name="LN869"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN870"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span><a name="LN871"></a>    <a href="../../../include/access/ginxlog.h.html#LN66"><span class='Ref_to_Typedef'>ginxlogRecompressDataLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>recompress_xlog</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Count the modified segments */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN869"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN864"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN876"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                                   <a href="gindatapage.c.html#LN869"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN876"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN866"><span class='Ref_To_Local'>nmodified</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gindatapage.c.html#LN867"><span class='Ref_To_Local'>walbufbegin</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN66"><span class='Ref_to_Typedef'>ginxlogRecompressDataLeaf</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>               BLCKSZ <span class='Operator'>+</span>         <span class='Comment_Single_Line'>/* max size needed to hold the segment data */ 
</span>               <a href="gindatapage.c.html#LN866"><span class='Ref_To_Local'>nmodified</span></a> <span class='Operator'>* </span><span class='Number'>2</span>    <span class='Comment_Single_Line'>/* (segno + action) per action */ 
</span>        <span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN867"><span class='Ref_To_Local'>walbufbegin</span></a><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN871"><span class='Ref_To_Local'>recompress_xlog</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN66"><span class='Ref_to_Typedef'>ginxlogRecompressDataLeaf</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN66"><span class='Ref_to_Typedef'>ginxlogRecompressDataLeaf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN871"><span class='Ref_To_Local'>recompress_xlog</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginxlog.h.html#LN68"><span class='Ref_to_Member'>nactions</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN866"><span class='Ref_To_Local'>nmodified</span></a><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN870"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN869"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN864"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN898"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                                   <a href="gindatapage.c.html#LN869"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN900"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN901"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>datalen</span><span class='Delimiter'>; 
</span><a name="LN902"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>action</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN870"><span class='Ref_To_Local'>segno</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN900"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If storing the uncompressed list of added item pointers would take 
         * more space than storing the compressed segment as is, do that 
         * instead. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginxlog.h.html#LN96"><span class='Ref_to_Const'>GIN_SEGMENT_ADDITEMS</span></a> <span class='Operator'>&& 
</span>            <a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN89"><span class='Ref_to_Member'>nmodifieditems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="gindatapage.c.html#LN900"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Operator'>*</span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a><span class='Operator'>++</span><span class='Parentheses'>))</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN870"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a><span class='Operator'>++</span><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Operator'>: 
</span>                <a href="gindatapage.c.html#LN901"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/access/ginxlog.h.html#LN96"><span class='Ref_to_Const'>GIN_SEGMENT_ADDITEMS</span></a><span class='Operator'>: 
</span>                <a href="gindatapage.c.html#LN901"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN89"><span class='Ref_to_Member'>nmodifieditems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN89"><span class='Ref_to_Member'>nmodifieditems</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN88"><span class='Ref_to_Member'>modifieditems</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN901"><span class='Ref_To_Local'>datalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN901"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Operator'>: 
</span>                <a href="gindatapage.c.html#LN901"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN583"><span class='Ref_to_Macro'>SHORTALIGN</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN900"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN898"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN900"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected GIN leaf action %d"</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch action &raquo; </span> 
        <a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN901"><span class='Ref_To_Local'>datalen</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN902"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN870"><span class='Ref_To_Local'>segno</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Pass back the constructed info via *leaf */ 
</span>    <a href="gindatapage.c.html#LN864"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN64"><span class='Ref_to_Member'>walinfo</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN867"><span class='Ref_To_Local'>walbufbegin</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN864"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN65"><span class='Ref_to_Member'>walinfolen</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN868"><span class='Ref_To_Local'>walbufend</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN867"><span class='Ref_To_Local'>walbufbegin</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end computeLeafRecompressWALData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Assemble a disassembled posting tree leaf page back to a buffer. 
 * 
 * This just updates the target buffer; WAL stuff is caller's responsibility. 
 * 
 * NOTE: The segment pointers must not point directly to the same buffer, 
 * except for segments that have not been modified and whose preceding 
 * segments have not been modified either. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN970"></a><span class='Declare_Function'>dataPlaceToPageLeafRecompress</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN972"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN970"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN973"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN974"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>newsize</span><span class='Delimiter'>; 
</span><a name="LN975"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>modified</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN976"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN977"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page was in pre-9.4 format before, convert the header, and force 
     * all segments to be copied to the page whether they were modified or 
     * not. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN119"><span class='Ref_to_Macro'>GinPageIsCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN972"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN970"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN58"><span class='Ref_to_Member'>oldformat</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/ginblock.h.html#LN120"><span class='Ref_to_Macro'>GinPageSetCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN972"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN972"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN975"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gindatapage.c.html#LN973"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN972"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN974"><span class='Ref_To_Local'>newsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN976"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN970"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN996"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN976"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN996"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN975"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN996"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN977"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN996"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN975"><span class='Ref_To_Local'>modified</span></a><span class='Parentheses'>) 
</span>                memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN973"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN996"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN977"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN973"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN977"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN974"><span class='Ref_To_Local'>newsize</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN977"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN974"><span class='Ref_To_Local'>newsize</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN972"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN974"><span class='Ref_To_Local'>newsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataPlaceToPageLeafRecompress &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Like dataPlaceToPageLeafRecompress, but writes the disassembled leaf 
 * segments to two pages instead of one. 
 * 
 * This is different from the non-split cases in that this does not modify 
 * the original page directly, but writes to temporary in-memory copies of 
 * the new left and right pages. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1026"></a><span class='Declare_Function'>dataPlaceToPageLeafSplit</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Delimiter'>, 
</span><a name="LN1027"></a>                         <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Parameter'>lbound</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Parameter'>rbound</span><span class='Delimiter'>, 
</span><a name="LN1028"></a>                         <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>lpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>rpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1030"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN1031"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span><span class='Delimiter'>; 
</span><a name="LN1032"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lsize</span><span class='Delimiter'>; 
</span><a name="LN1033"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rsize</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>node</span><span class='Delimiter'>; 
</span><a name="LN1035"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>firstright</span><span class='Delimiter'>; 
</span><a name="LN1036"></a>    <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize temporary pages to hold the new left and right pages */ 
</span>    <a href="../../../include/access/gin_private.h.html#LN90"><span class='Ref_to_Proto'>GinInitPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>lpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN38"><span class='Ref_to_Const'>GIN_DATA</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN39"><span class='Ref_to_Const'>GIN_LEAF</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN46"><span class='Ref_to_Const'>GIN_COMPRESSED</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN90"><span class='Ref_to_Proto'>GinInitPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>rpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN38"><span class='Ref_to_Const'>GIN_DATA</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN39"><span class='Ref_to_Const'>GIN_LEAF</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN46"><span class='Ref_to_Const'>GIN_COMPRESSED</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy the segments that go to the left page. 
     * 
     * XXX: We should skip copying the unmodified part of the left page, like 
     * we do when recompressing. 
     */ 
</span>    <a href="gindatapage.c.html#LN1032"><span class='Ref_To_Local'>lsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1030"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1035"><span class='Ref_To_Local'>firstright</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN447"><span class='Ref_to_Func'>dlist_head_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>!= </span><a href="gindatapage.c.html#LN1035"><span class='Ref_To_Local'>firstright</span></a><span class='Delimiter'>; 
</span>         <a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1030"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1030"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1032"><span class='Ref_To_Local'>lsize</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1032"><span class='Ref_To_Local'>lsize</span></a> <span class='Operator'>== </span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>lpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1032"><span class='Ref_To_Local'>lsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>lpage</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="gindatapage.c.html#LN1027"><span class='Ref_to_Parameter'>lbound</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy the segments that go to the right page */ 
</span>    <a href="gindatapage.c.html#LN1030"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>rpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1033"><span class='Ref_To_Local'>rsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1035"><span class='Ref_To_Local'>firstright</span></a><span class='Delimiter'>; 
</span>         <span class='Delimiter'>; 
</span>         <a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1030"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1036"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1030"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1033"><span class='Ref_To_Local'>rsize</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1031"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN400"><span class='Ref_to_Func'>dlist_has_next</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1034"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1033"><span class='Ref_To_Local'>rsize</span></a> <span class='Operator'>== </span><a href="gindatapage.c.html#LN1026"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>rpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1033"><span class='Ref_To_Local'>rsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1028"><span class='Ref_to_Parameter'>rpage</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="gindatapage.c.html#LN1027"><span class='Ref_to_Parameter'>rbound</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataPlaceToPageLeafSplit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Prepare to insert data on an internal data page. 
 * 
 * If it will fit, return GPTP_INSERT after doing whatever setup is needed 
 * before we enter the insertion critical section.  *ptp_workspace can be 
 * set to pass information along to the execPlaceToPage function. 
 * 
 * If it won't fit, perform a page split and return two temporary page 
 * images into *newlpage and *newrpage, with result GPTP_SPLIT. 
 * 
 * In neither case should the given page buffer be modified here. 
 * 
 * Note: on insertion to an internal node, in addition to inserting the given 
 * item, the downlink of the existing item at stack-&GT;off will be updated to 
 * point to updateblkno. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/gin_private.h.html#LN135"><span class='Ref_to_Typedef'>GinPlaceToPageRC</span></a> 
<a name="LN1111"></a><span class='Declare_Function'>dataBeginPlaceToPageInternal</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1112"></a>                             <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN1113"></a>                             <span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>ptp_workspace</span><span class='Delimiter'>, 
</span><a name="LN1114"></a>                             <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newlpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newrpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1116"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1111"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If it doesn't fit, deal with split case */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN305"><span class='Ref_to_Macro'>GinNonLeafDataPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1116"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN104"><span class='Ref_to_Proto'>dataSplitPageInternal</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1111"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1111"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1111"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1112"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1112"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Delimiter'>, 
</span>                              <a href="gindatapage.c.html#LN1114"><span class='Ref_to_Parameter'>newlpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1114"><span class='Ref_to_Parameter'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/access/gin_private.h.html#LN139"><span class='Ref_to_EnumConst'>GPTP_SPLIT</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Else, we're ready to proceed with insertion */ 
</span>    <span class='Control'>return</span> <a href="../../../include/access/gin_private.h.html#LN138"><span class='Ref_to_EnumConst'>GPTP_INSERT</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Perform data insertion after beginPlaceToPage has decided it will fit. 
 * 
 * This is invoked within a critical section, and XLOG record creation (if 
 * needed) is already started.  The target buffer is registered in slot 0. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1137"></a><span class='Declare_Function'>dataExecPlaceToPageInternal</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1138"></a>                            <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN1139"></a>                            <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptp_workspace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1141"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1137"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1142"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1137"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a><span class='Delimiter'>; 
</span><a name="LN1143"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pitem</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update existing downlink to point to next page (on internal page) */ 
</span>    <a href="gindatapage.c.html#LN1143"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1141"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1142"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN185"><span class='Ref_to_Macro'>PostingItemSetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1143"><span class='Ref_To_Local'>pitem</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1138"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add new item */ 
</span>    <a href="gindatapage.c.html#LN1143"><span class='Ref_To_Local'>pitem</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN1138"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN220"><span class='Ref_to_Proto'>GinDataPageAddPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1141"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1143"><span class='Ref_To_Local'>pitem</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1142"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1137"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This must be static, because it has to survive until XLogInsert, 
         * and we can't palloc here.  Ugly, but the XLogInsert infrastructure 
         * isn't reentrant anyway. 
         */ 
</span><a name="LN1160"></a>        <span class='Keyword'>static </span><a href="../../../include/access/ginxlog.h.html#LN98"><span class='Ref_to_Typedef'>ginxlogInsertDataInternal</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1160"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN100"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1142"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1160"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN101"><span class='Ref_to_Member'>newitem</span></a> <span class='Operator'>= *</span><a href="gindatapage.c.html#LN1143"><span class='Ref_To_Local'>pitem</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1160"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, 
</span>                            <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN98"><span class='Ref_to_Typedef'>ginxlogInsertDataInternal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end dataExecPlaceToPageInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Prepare to insert data on a posting-tree data page. 
 * 
 * If it will fit, return GPTP_INSERT after doing whatever setup is needed 
 * before we enter the insertion critical section.  *ptp_workspace can be 
 * set to pass information along to the execPlaceToPage function. 
 * 
 * If it won't fit, perform a page split and return two temporary page 
 * images into *newlpage and *newrpage, with result GPTP_SPLIT. 
 * 
 * In neither case should the given page buffer be modified here. 
 * 
 * Note: on insertion to an internal node, in addition to inserting the given 
 * item, the downlink of the existing item at stack-&GT;off will be updated to 
 * point to updateblkno. 
 * 
 * Calls relevant function for internal or leaf page because they are handled 
 * very differently. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/gin_private.h.html#LN135"><span class='Ref_to_Typedef'>GinPlaceToPageRC</span></a> 
<a name="LN1190"></a><span class='Declare_Function'>dataBeginPlaceToPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1191"></a>                     <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN1192"></a>                     <span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>ptp_workspace</span><span class='Delimiter'>, 
</span><a name="LN1193"></a>                     <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newlpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newrpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1195"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN113"><span class='Ref_to_Macro'>GinPageIsData</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1195"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1195"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="gindatapage.c.html#LN442"><span class='Ref_to_Func'>dataBeginPlaceToPageLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1191"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, 
</span>                                        <a href="gindatapage.c.html#LN1192"><span class='Ref_to_Parameter'>ptp_workspace</span></a><span class='Delimiter'>, 
</span>                                        <a href="gindatapage.c.html#LN1193"><span class='Ref_to_Parameter'>newlpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1193"><span class='Ref_to_Parameter'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="gindatapage.c.html#LN1110"><span class='Ref_to_Func'>dataBeginPlaceToPageInternal</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1190"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, 
</span>                                            <a href="gindatapage.c.html#LN1191"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1191"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Delimiter'>, 
</span>                                            <a href="gindatapage.c.html#LN1192"><span class='Ref_to_Parameter'>ptp_workspace</span></a><span class='Delimiter'>, 
</span>                                            <a href="gindatapage.c.html#LN1193"><span class='Ref_to_Parameter'>newlpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1193"><span class='Ref_to_Parameter'>newrpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataBeginPlaceToPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform data insertion after beginPlaceToPage has decided it will fit. 
 * 
 * This is invoked within a critical section, and XLOG record creation (if 
 * needed) is already started.  The target buffer is registered in slot 0. 
 * 
 * Calls relevant function for internal or leaf page because they are handled 
 * very differently. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1220"></a><span class='Declare_Function'>dataExecPlaceToPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1221"></a>                    <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN1222"></a>                    <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptp_workspace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1224"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN110"><span class='Ref_to_Macro'>GinPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1224"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="gindatapage.c.html#LN710"><span class='Ref_to_Func'>dataExecPlaceToPageLeaf</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1221"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, 
</span>                                <a href="gindatapage.c.html#LN1222"><span class='Ref_to_Parameter'>ptp_workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="gindatapage.c.html#LN1136"><span class='Ref_to_Func'>dataExecPlaceToPageInternal</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1220"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1221"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Delimiter'>, 
</span>                                    <a href="gindatapage.c.html#LN1221"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1222"><span class='Ref_to_Parameter'>ptp_workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Split internal page and insert new data. 
 * 
 * Returns new temp pages to *newlpage and *newrpage. 
 * The original buffer is left untouched. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1241"></a><span class='Declare_Function'>dataSplitPageInternal</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>origbuf</span><span class='Delimiter'>, 
</span><a name="LN1242"></a>                      <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1243"></a>                      <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>insertdata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>updateblkno</span><span class='Delimiter'>, 
</span><a name="LN1244"></a>                      <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newlpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newrpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1246"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>oldpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1241"><span class='Ref_to_Parameter'>origbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1247"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1242"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN125"><span class='Ref_to_Member'>off</span></a><span class='Delimiter'>; 
</span><a name="LN1248"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nitems</span> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span><a name="LN1249"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nleftitems</span><span class='Delimiter'>; 
</span><a name="LN1250"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nrightitems</span><span class='Delimiter'>; 
</span><a name="LN1251"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageSize</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN264"><span class='Ref_to_Macro'>PageGetPageSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1252"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>oldbound</span> <span class='Operator'>= *</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1253"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>bound</span><span class='Delimiter'>; 
</span><a name="LN1254"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>lpage</span><span class='Delimiter'>; 
</span><a name="LN1255"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>rpage</span><span class='Delimiter'>; 
</span><a name="LN1256"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>separator</span><span class='Delimiter'>; 
</span><a name="LN1257"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Declare_Local'>allitems</span><span class='Delimiter'>[</span><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a> <span class='Operator'>= </span><a href="../../storage/page/bufpage.c.html#LN346"><span class='Ref_to_Func'>PageGetTempPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a> <span class='Operator'>= </span><a href="../../storage/page/bufpage.c.html#LN346"><span class='Ref_to_Func'>PageGetTempPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN90"><span class='Ref_to_Proto'>GinInitPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags<span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1251"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN90"><span class='Ref_to_Proto'>GinInitPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags<span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1251"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First construct a new list of PostingItems, which includes all the old 
     * items, and the new item. 
     */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1257"><span class='Ref_To_Local'>allitems</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1247"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1257"><span class='Ref_To_Local'>allitems</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1247"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><span class='Parentheses'>((</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN1243"><span class='Ref_to_Parameter'>insertdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1257"><span class='Ref_To_Local'>allitems</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1247"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>], </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1247"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1248"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1247"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1248"><span class='Ref_To_Local'>nitems</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update existing downlink to point to next page */ 
</span>    <a href="../../../include/access/ginblock.h.html#LN185"><span class='Ref_to_Macro'>PostingItemSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1257"><span class='Ref_To_Local'>allitems</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1247"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>], </span><a href="gindatapage.c.html#LN1243"><span class='Ref_to_Parameter'>updateblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When creating a new index, fit as many tuples as possible on the left 
     * page, on the assumption that the table is scanned from beginning to 
     * end. This packs the index as tight as possible. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1241"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN163"><span class='Ref_to_Member'>isBuild</span></a> <span class='Operator'>&& </span><a href="../../../include/access/ginblock.h.html#LN127"><span class='Ref_to_Macro'>GinPageRightMost</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1246"><span class='Ref_To_Local'>oldpage</span></a><span class='Parentheses'>))</span> 
        <a href="gindatapage.c.html#LN1256"><span class='Ref_To_Local'>separator</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN305"><span class='Ref_to_Macro'>GinNonLeafDataPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="gindatapage.c.html#LN1256"><span class='Ref_To_Local'>separator</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1248"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1249"><span class='Ref_To_Local'>nleftitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1256"><span class='Ref_To_Local'>separator</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1250"><span class='Ref_To_Local'>nrightitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1248"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN1256"><span class='Ref_To_Local'>separator</span></a><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="gindatapage.c.html#LN1257"><span class='Ref_To_Local'>allitems</span></a><span class='Delimiter'>, 
</span>           <a href="gindatapage.c.html#LN1249"><span class='Ref_To_Local'>nleftitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><a href="gindatapage.c.html#LN1249"><span class='Ref_To_Local'>nleftitems</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <span class='Operator'>&</span><a href="gindatapage.c.html#LN1257"><span class='Ref_To_Local'>allitems</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1256"><span class='Ref_To_Local'>separator</span></a><span class='Delimiter'>], 
</span>           <a href="gindatapage.c.html#LN1250"><span class='Ref_To_Local'>nrightitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><a href="gindatapage.c.html#LN1250"><span class='Ref_To_Local'>nrightitems</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also set pd_lower for both pages, like GinDataPageAddPostingItem does. 
     */ 
</span>    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1249"><span class='Ref_To_Local'>nleftitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1250"><span class='Ref_To_Local'>nrightitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set up right bound for left page */ 
</span>    <a href="gindatapage.c.html#LN1253"><span class='Ref_To_Local'>bound</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="gindatapage.c.html#LN1253"><span class='Ref_To_Local'>bound</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN288"><span class='Ref_to_Macro'>GinDataPageGetPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1249"><span class='Ref_To_Local'>nleftitems</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>key<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set up right bound for right page */ 
</span>    <span class='Operator'>*</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="gindatapage.c.html#LN1252"><span class='Ref_To_Local'>oldbound</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* return temp pages to caller */ 
</span>    <span class='Operator'>*</span><a href="gindatapage.c.html#LN1244"><span class='Ref_to_Parameter'>newlpage</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1254"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="gindatapage.c.html#LN1244"><span class='Ref_to_Parameter'>newrpage</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1255"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dataSplitPageInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct insertion payload for inserting the downlink for given buffer. 
 */ 
</span><span class='Keyword'>static void </span><span class='Operator'>* 
</span><a name="LN1322"></a><span class='Declare_Function'>dataPrepareDownlink</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>lbuf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1324"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pitem</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1325"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>lpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1322"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/ginblock.h.html#LN185"><span class='Ref_to_Macro'>PostingItemSetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1324"><span class='Ref_To_Local'>pitem</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1322"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1324"><span class='Ref_To_Local'>pitem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN179"><span class='Ref_to_Member'>key</span></a> <span class='Operator'>= *</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1325"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN1324"><span class='Ref_To_Local'>pitem</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fills new root by right bound values from child. 
 * Also called from ginxlog, should not use btree 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1338"></a><span class='Declare_Function'>ginDataFillRoot</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>root</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>lblkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>lpage</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>rblkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>rpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1340"></a>    <a href="../../../include/access/ginblock.h.html#LN175"><span class='Ref_to_Typedef'>PostingItem</span></a> <span class='Declare_Local'>li</span><span class='Delimiter'>, 
</span><a name="LN1341"></a>                <span class='Declare_Local'>ri</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1340"><span class='Ref_To_Local'>li</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN179"><span class='Ref_to_Member'>key</span></a> <span class='Operator'>= *</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1338"><span class='Ref_to_Parameter'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN185"><span class='Ref_to_Macro'>PostingItemSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1340"><span class='Ref_To_Local'>li</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1338"><span class='Ref_to_Parameter'>lblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN220"><span class='Ref_to_Proto'>GinDataPageAddPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1338"><span class='Ref_to_Parameter'>root</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1340"><span class='Ref_To_Local'>li</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1341"><span class='Ref_To_Local'>ri</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN179"><span class='Ref_to_Member'>key</span></a> <span class='Operator'>= *</span><a href="../../../include/access/ginblock.h.html#LN278"><span class='Ref_to_Macro'>GinDataPageGetRightBound</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1338"><span class='Ref_to_Parameter'>rpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN185"><span class='Ref_to_Macro'>PostingItemSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1341"><span class='Ref_To_Local'>ri</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1338"><span class='Ref_to_Parameter'>rblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN220"><span class='Ref_to_Proto'>GinDataPageAddPostingItem</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1338"><span class='Ref_to_Parameter'>root</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1341"><span class='Ref_To_Local'>ri</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/*** Functions to work with disassembled leaf pages ***/ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Disassemble page into a disassembledLeaf struct. 
 */ 
</span><span class='Keyword'>static </span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>* 
</span><a name="LN1359"></a><span class='Declare_Function'>disassembleLeaf</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1361"></a>    <a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>leaf</span><span class='Delimiter'>; 
</span><a name="LN1362"></a>    <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seg</span><span class='Delimiter'>; 
</span><a name="LN1363"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>segbegin</span><span class='Delimiter'>; 
</span><a name="LN1364"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>segend</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN119"><span class='Ref_to_Macro'>GinPageIsCompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Create a leafSegment entry for each segment. 
         */ 
</span>        <a href="gindatapage.c.html#LN1362"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1363"><span class='Ref_To_Local'>segbegin</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN1362"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1364"><span class='Ref_To_Local'>segend</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1363"><span class='Ref_To_Local'>segbegin</span></a> <span class='Operator'>+ </span><a href="../../../include/access/ginblock.h.html#LN270"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingListSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="gindatapage.c.html#LN1362"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN1364"><span class='Ref_To_Local'>segend</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1379"></a>            <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN1379"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1379"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1362"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1379"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1379"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1379"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN70"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN1362"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN333"><span class='Ref_to_Macro'>GinNextPostingListSegment</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1362"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN58"><span class='Ref_to_Member'>oldformat</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if GinPageIsCompressed(p... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * A pre-9.4 format uncompressed page is represented by a single 
         * segment, with an array of items. 
         */ 
</span><a name="LN1397"></a>        <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>uncompressed</span><span class='Delimiter'>; 
</span><a name="LN1398"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nuncompressed</span><span class='Delimiter'>; 
</span><a name="LN1399"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1397"><span class='Ref_To_Local'>uncompressed</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN103"><span class='Ref_to_Proto'>dataLeafPageGetUncompressed</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1398"><span class='Ref_To_Local'>nuncompressed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1398"><span class='Ref_To_Local'>nuncompressed</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1397"><span class='Ref_To_Local'>uncompressed</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1398"><span class='Ref_To_Local'>nuncompressed</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1398"><span class='Ref_To_Local'>nuncompressed</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1399"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN70"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN58"><span class='Ref_to_Member'>oldformat</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN1361"><span class='Ref_To_Local'>leaf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end disassembleLeaf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Distribute newItems to the segments. 
 * 
 * Any segments that acquire new items are decoded, and the new items are 
 * merged with the old items. 
 * 
 * Returns true if any new items were added. False means they were all 
 * duplicates of existing items on the page. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1429"></a><span class='Declare_Function'>addItemsToLeaf</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>newItems</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nNewItems</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1431"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN1432"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>nextnew</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>newItems</span></a><span class='Delimiter'>; 
</span><a name="LN1433"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>newleft</span> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>nNewItems</span></a><span class='Delimiter'>; 
</span><a name="LN1434"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>modified</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1435"></a>    <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newseg</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page is completely empty, just construct one new segment to hold 
     * all the new items. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>newItems</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>nNewItems</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN70"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1431"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1454"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1431"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1455"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nthis</span><span class='Delimiter'>; 
</span><a name="LN1456"></a>        <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>tmpitems</span><span class='Delimiter'>; 
</span><a name="LN1457"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ntmpitems</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * How many of the new items fall into this segment? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN400"><span class='Ref_to_Func'>dlist_has_next</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1431"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>))</span> 
            <a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1433"><span class='Ref_To_Local'>newleft</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1466"></a>            <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span><a name="LN1467"></a>            <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>next_first</span><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN1466"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1431"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1466"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Parentheses'>) 
</span>                <a href="gindatapage.c.html#LN1467"><span class='Ref_To_Local'>next_first</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1466"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1466"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1467"><span class='Ref_To_Local'>next_first</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1466"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN327"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN1433"><span class='Ref_To_Local'>newleft</span></a> <span class='Operator'>&& </span><a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1432"><span class='Ref_To_Local'>nextnew</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1467"><span class='Ref_To_Local'>next_first</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Merge the new items with the existing items. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Parentheses'>) 
</span>            <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN267"><span class='Ref_to_Func'>ginPostingListDecode</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fast path for the important special case that we're appending to 
         * the end of the page: don't let the last segment on the page grow 
         * larger than the target, create a new segment before that happens. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN400"><span class='Ref_to_Func'>dlist_has_next</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1431"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/gin_private.h.html#LN459"><span class='Ref_to_Func'>ginCompareItemPointers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1432"><span class='Ref_To_Local'>nextnew</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="gindatapage.c.html#LN33"><span class='Ref_to_Const'>GinPostingListSegmentTargetSize</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1432"><span class='Ref_To_Local'>nextnew</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1429"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1435"><span class='Ref_To_Local'>newseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN70"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1434"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="gindatapage.c.html#LN1456"><span class='Ref_To_Local'>tmpitems</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN361"><span class='Ref_to_Func'>ginMergeItemPointers</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>, 
</span>                                        <a href="gindatapage.c.html#LN1432"><span class='Ref_To_Local'>nextnew</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="gindatapage.c.html#LN1457"><span class='Ref_To_Local'>ntmpitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1457"><span class='Ref_To_Local'>ntmpitems</span></a> <span class='Operator'>!= </span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If there are no duplicates, track the added items so that we 
             * can emit a compact ADDITEMS WAL record later on. (it doesn't 
             * seem worth re-checking which items were duplicates, if there 
             * were any) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1457"><span class='Ref_To_Local'>ntmpitems</span></a> <span class='Operator'>== </span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>&& 
</span>                <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN96"><span class='Ref_to_Const'>GIN_SEGMENT_ADDITEMS</span></a><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN88"><span class='Ref_to_Member'>modifieditems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1432"><span class='Ref_To_Local'>nextnew</span></a><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN89"><span class='Ref_to_Member'>nmodifieditems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1456"><span class='Ref_To_Local'>tmpitems</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1457"><span class='Ref_To_Local'>ntmpitems</span></a><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1454"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1434"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ntmpitems!=cur-&GT;nitem... &raquo; </span> 
 
        <a href="gindatapage.c.html#LN1432"><span class='Ref_To_Local'>nextnew</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1433"><span class='Ref_To_Local'>newleft</span></a> <span class='Operator'>-= </span><a href="gindatapage.c.html#LN1455"><span class='Ref_To_Local'>nthis</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1433"><span class='Ref_To_Local'>newleft</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN1434"><span class='Ref_To_Local'>modified</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end addItemsToLeaf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Recompresses all segments that have been modified. 
 * 
 * If not all the items fit on two pages (ie. after split), we store as 
 * many items as fit, and set *remaining to the first item that didn't fit. 
 * If all items fit, *remaining is set to invalid. 
 * 
 * Returns true if the page has to be split. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1556"></a><span class='Declare_Function'>leafRepackItems</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN46"><span class='Ref_to_Typedef'>disassembledLeaf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leaf</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>remaining</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1558"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pgused</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1559"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needsplit</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1560"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN1561"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span><span class='Delimiter'>; 
</span><a name="LN1562"></a>    <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nextseg</span><span class='Delimiter'>; 
</span><a name="LN1563"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>npacked</span><span class='Delimiter'>; 
</span><a name="LN1564"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>modified</span><span class='Delimiter'>; 
</span><a name="LN1565"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur_node</span><span class='Delimiter'>; 
</span><a name="LN1566"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next_node</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>remaining</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * cannot use dlist_foreach_modify here because we insert adjacent items 
     * while iterating. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN447"><span class='Ref_to_Func'>dlist_head_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>         <a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1578"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                                   <a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN400"><span class='Ref_to_Func'>dlist_has_next</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>))</span> 
            <a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Compress the posting list, if necessary */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>&GT; </span><a href="gindatapage.c.html#LN32"><span class='Ref_to_Const'>GinPostingListSegmentMaxSize</span></a><span class='Parentheses'>) 
</span>                    <a href="gindatapage.c.html#LN1563"><span class='Ref_To_Local'>npacked</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* no chance that it would fit. */ 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN178"><span class='Ref_to_Func'>ginCompressPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, 
</span>                                                          <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>, 
</span>                                                <a href="gindatapage.c.html#LN32"><span class='Ref_to_Const'>GinPostingListSegmentMaxSize</span></a><span class='Delimiter'>, 
</span>                                                          <span class='Operator'>&</span><a href="gindatapage.c.html#LN1563"><span class='Ref_To_Local'>npacked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1563"><span class='Ref_To_Local'>npacked</span></a> <span class='Operator'>!= </span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Too large. Compress again to the target size, and 
                     * create a new segment to represent the remaining items. 
                     * The new segment is inserted after this one, so it will 
                     * be processed in the next iteration of this loop. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>) 
</span>                        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN178"><span class='Ref_to_Func'>ginCompressPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, 
</span>                                                          <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>, 
</span>                                             <a href="gindatapage.c.html#LN33"><span class='Ref_to_Const'>GinPostingListSegmentTargetSize</span></a><span class='Delimiter'>, 
</span>                                                          <span class='Operator'>&</span><a href="gindatapage.c.html#LN1563"><span class='Ref_To_Local'>npacked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Parentheses'>) 
</span>                        <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Delimiter'>; 
</span> 
                    <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= &</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1563"><span class='Ref_To_Local'>npacked</span></a><span class='Delimiter'>]; 
</span>                    <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN1563"><span class='Ref_To_Local'>npacked</span></a><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a> <span class='Operator'>= &</span><a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN70"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span>                    <a href="../../../include/lib/ilist.h.html#LN332"><span class='Ref_to_Func'>dlist_insert_after</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if npacked!=seginfo-&GT;nit... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if seginfo-&GT;seg==NULL &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * If the segment is very small, merge it with the next segment. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN34"><span class='Ref_to_Const'>GinPostingListSegmentMinSize</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1632"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>nmerged</span><span class='Delimiter'>; 
</span> 
                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1566"><span class='Ref_To_Local'>next_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN267"><span class='Ref_to_Func'>ginPostingListDecode</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, 
</span>                                                          <span class='Operator'>&</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN267"><span class='Ref_to_Func'>ginPostingListDecode</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, 
</span>                                                          <span class='Operator'>&</span><a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= 
</span>                    <a href="ginpostinglist.c.html#LN361"><span class='Ref_to_Func'>ginMergeItemPointers</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>, 
</span>                                         <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="gindatapage.c.html#LN1632"><span class='Ref_To_Local'>nmerged</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1632"><span class='Ref_To_Local'>nmerged</span></a> <span class='Operator'>== </span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1632"><span class='Ref_To_Local'>nmerged</span></a><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN95"><span class='Ref_to_Const'>GIN_SEGMENT_REPLACE</span></a><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN88"><span class='Ref_to_Member'>modifieditems</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1562"><span class='Ref_To_Local'>nextseg</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN89"><span class='Ref_to_Member'>nmodifieditems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginxlog.h.html#LN94"><span class='Ref_to_Const'>GIN_SEGMENT_INSERT</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Delimiter'>; 
</span>                    <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SizeOfGinPostingList(... &raquo; </span> 
 
            <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN99"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN100"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if seginfo-&GT;action!=GIN_... &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginxlog.h.html#LN93"><span class='Ref_to_Const'>GIN_SEGMENT_DELETE</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * OK, we now have a compressed version of this segment ready for 
         * copying to the page. Did we exceed the size that fits on one page? 
         */ 
</span>        <a href="gindatapage.c.html#LN1561"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN1561"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN1559"><span class='Ref_To_Local'>needsplit</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* switch to right page */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN54"><span class='Ref_to_Member'>lastleft</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN429"><span class='Ref_to_Func'>dlist_prev_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1559"><span class='Ref_To_Local'>needsplit</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a><span class='Delimiter'>; 
</span>                <a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Filled both pages. The last segment we constructed did not 
                 * fit. 
                 */ 
</span>                <span class='Operator'>*</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>remaining</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1578"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN327"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * remove all segments that did not fit from the list. 
                 */ 
</span>                <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN400"><span class='Ref_to_Func'>dlist_has_next</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>))</span> 
                    <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1565"><span class='Ref_To_Local'>cur_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pgused+segsize&GT;GinDat... &raquo; </span> 
 
        <a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1561"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for cur_node=dlist_head_n... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN1559"><span class='Ref_To_Local'>needsplit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1558"><span class='Ref_To_Local'>pgused</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN55"><span class='Ref_to_Member'>lsize</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN56"><span class='Ref_to_Member'>rsize</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a palloc'd copy of every segment after the first modified one, 
     * because as we start copying items to the original page, we might 
     * overwrite an existing segment. 
     */ 
</span>    <a href="gindatapage.c.html#LN1564"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1560"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1556"><span class='Ref_to_Parameter'>leaf</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN48"><span class='Ref_to_Member'>segments</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1729"></a>        <a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seginfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN68"><span class='Ref_to_Typedef'>leafSegmentInfo</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                                   <a href="gindatapage.c.html#LN1560"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gindatapage.c.html#LN1564"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN1729"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>!= </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gindatapage.c.html#LN1564"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1564"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>&& </span><a href="gindatapage.c.html#LN1729"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN86"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/ginxlog.h.html#LN92"><span class='Ref_to_Const'>GIN_SEGMENT_UNMODIFIED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1738"></a>            <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span> 
            <a href="gindatapage.c.html#LN1561"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1729"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1738"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1561"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1738"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1729"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1561"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gindatapage.c.html#LN1729"><span class='Ref_To_Local'>seginfo</span></a><span class='Operator'>-&GT;</span><a href="gindatapage.c.html#LN98"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1738"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN1559"><span class='Ref_To_Local'>needsplit</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end leafRepackItems &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*** Functions that are exported to the rest of the GIN code ***/ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Creates new posting tree containing the given TIDs. Returns the page 
 * number of the root of the new posting tree. 
 * 
 * items[] must be in sorted order with no duplicates. 
 */ 
</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN1760"></a><span class='Declare_Function'>createPostingTree</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>items</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN1761"></a>                  <a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1763"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN1764"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN1765"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>tmppage</span><span class='Delimiter'>; 
</span><a name="LN1766"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1767"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN1768"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nrootitems</span><span class='Delimiter'>; 
</span><a name="LN1769"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rootsize</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Construct the new root page in memory first. */ 
</span>    <a href="gindatapage.c.html#LN1765"><span class='Ref_To_Local'>tmppage</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN90"><span class='Ref_to_Proto'>GinInitPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1765"><span class='Ref_To_Local'>tmppage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN38"><span class='Ref_to_Const'>GIN_DATA</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN39"><span class='Ref_to_Const'>GIN_LEAF</span></a> <span class='Operator'>| </span><a href="../../../include/access/ginblock.h.html#LN46"><span class='Ref_to_Const'>GIN_COMPRESSED</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1765"><span class='Ref_To_Local'>tmppage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write as many of the items to the root page as fit. In segments of max 
     * GinPostingListSegmentMaxSize bytes each. 
     */ 
</span>    <a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1769"><span class='Ref_To_Local'>rootsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1767"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1765"><span class='Ref_To_Local'>tmppage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1785"></a>        <a href="../../../include/access/ginblock.h.html#LN325"><span class='Ref_to_Typedef'>GinPostingList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment</span><span class='Delimiter'>; 
</span><a name="LN1786"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>npacked</span><span class='Delimiter'>; 
</span><a name="LN1787"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>segsize</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1785"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>= </span><a href="ginpostinglist.c.html#LN178"><span class='Ref_to_Func'>ginCompressPostingList</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a><span class='Delimiter'>], 
</span>                                         <a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a><span class='Delimiter'>, 
</span>                                         <a href="gindatapage.c.html#LN32"><span class='Ref_to_Const'>GinPostingListSegmentMaxSize</span></a><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="gindatapage.c.html#LN1786"><span class='Ref_To_Local'>npacked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1787"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN332"><span class='Ref_to_Macro'>SizeOfGinPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1785"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1769"><span class='Ref_To_Local'>rootsize</span></a> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN1787"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/ginblock.h.html#LN309"><span class='Ref_to_Const'>GinDataPageMaxDataSize</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1767"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1785"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1787"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1767"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1787"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1769"><span class='Ref_To_Local'>rootsize</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1787"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>; 
</span>        <a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a> <span class='Operator'>+= </span><a href="gindatapage.c.html#LN1786"><span class='Ref_To_Local'>npacked</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1785"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while nrootitems&LT;nitems &raquo; </span> 
    <a href="../../../include/access/ginblock.h.html#LN299"><span class='Ref_to_Macro'>GinDataPageSetDataSize</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1765"><span class='Ref_To_Local'>tmppage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1769"><span class='Ref_To_Local'>rootsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * All set. Get a new physical page, and copy the in-memory page to it. 
     */ 
</span>    <a href="gindatapage.c.html#LN1764"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN88"><span class='Ref_to_Proto'>GinNewBuffer</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1766"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1764"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1763"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1764"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/page/bufpage.c.html#LN405"><span class='Ref_to_Func'>PageRestoreTempPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1765"><span class='Ref_To_Local'>tmppage</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1766"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1764"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1819"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN1820"></a>        <a href="../../../include/access/ginxlog.h.html#LN22"><span class='Ref_to_Struct'>ginxlogCreatePostingTree</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1820"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN24"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1769"><span class='Ref_To_Local'>rootsize</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1820"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN22"><span class='Ref_to_Struct'>ginxlogCreatePostingTree</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/ginblock.h.html#LN268"><span class='Ref_to_Macro'>GinDataLeafPageGetPostingList</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1766"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="gindatapage.c.html#LN1769"><span class='Ref_To_Local'>rootsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1764"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gindatapage.c.html#LN1819"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN20"><span class='Ref_to_Const'>XLOG_GIN_CREATE_PTREE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1766"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1819"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1764"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* During index build, count the newly-added data page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1761"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>) 
</span>        <a href="gindatapage.c.html#LN1761"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin.h.html#LN45"><span class='Ref_to_Member'>nDataPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"created GIN posting tree with %d items"</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add any remaining TIDs to the newly-created posting tree. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&GT; </span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/gin_private.h.html#LN222"><span class='Ref_to_Proto'>ginInsertItemPointers</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1763"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, 
</span>                              <a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>items</span></a> <span class='Operator'>+ </span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a><span class='Delimiter'>, 
</span>                              <a href="gindatapage.c.html#LN1760"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>- </span><a href="gindatapage.c.html#LN1768"><span class='Ref_To_Local'>nrootitems</span></a><span class='Delimiter'>, 
</span>                              <a href="gindatapage.c.html#LN1761"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN1763"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end createPostingTree &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN1860"></a><span class='Declare_Function'>ginPrepareDataScan</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>rootBlkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    memset<span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN142"><span class='Ref_to_Struct'>GinBtreeData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN159"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN160"><span class='Ref_to_Member'>rootBlkno</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>rootBlkno</span></a><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN145"><span class='Ref_to_Member'>findChildPage</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN246"><span class='Ref_to_Func'>dataLocateItem</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN146"><span class='Ref_to_Member'>getLeftMostChild</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN358"><span class='Ref_to_Func'>dataGetLeftMostPage</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN147"><span class='Ref_to_Member'>isMoveRight</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN231"><span class='Ref_to_Func'>dataIsMoveRight</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN148"><span class='Ref_to_Member'>findItem</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN151"><span class='Ref_to_Member'>findChildPtr</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN313"><span class='Ref_to_Func'>dataFindChildPtr</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN152"><span class='Ref_to_Member'>beginPlaceToPage</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1189"><span class='Ref_to_Func'>dataBeginPlaceToPage</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN153"><span class='Ref_to_Member'>execPlaceToPage</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1219"><span class='Ref_to_Func'>dataExecPlaceToPage</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN155"><span class='Ref_to_Member'>fillRoot</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN226"><span class='Ref_to_Proto'>ginDataFillRoot</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span>prepareDownlink <span class='Operator'>= </span><a href="gindatapage.c.html#LN1321"><span class='Ref_to_Func'>dataPrepareDownlink</span></a><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN157"><span class='Ref_to_Member'>isData</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN162"><span class='Ref_to_Member'>fullScan</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1860"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN163"><span class='Ref_to_Member'>isBuild</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginPrepareDataScan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Inserts array of item pointers, may execute several tree scan (very rare) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1886"></a><span class='Declare_Function'>ginInsertItemPointers</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>rootBlkno</span><span class='Delimiter'>, 
</span><a name="LN1887"></a>                      <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>items</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>nitem</span><span class='Delimiter'>, 
</span><a name="LN1888"></a>                      <a href="../../../include/access/gin.h.html#LN40"><span class='Ref_to_Struct'>GinStatsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildStats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1890"></a>    <a href="../../../include/access/gin_private.h.html#LN142"><span class='Ref_to_Struct'>GinBtreeData</span></a> <span class='Declare_Local'>btree</span><span class='Delimiter'>; 
</span><a name="LN1891"></a>    <a href="../../../include/access/gin_private.h.html#LN185"><span class='Ref_to_Typedef'>GinBtreeDataLeafInsertData</span></a> <span class='Declare_Local'>insertdata</span><span class='Delimiter'>; 
</span><a name="LN1892"></a>    <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>stack</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gin_private.h.html#LN227"><span class='Ref_to_Proto'>ginPrepareDataScan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1890"><span class='Ref_To_Local'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1886"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1886"><span class='Ref_to_Parameter'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1890"><span class='Ref_To_Local'>btree</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN163"><span class='Ref_to_Member'>isBuild</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1888"><span class='Ref_to_Parameter'>buildStats</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN187"><span class='Ref_to_Member'>items</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1887"><span class='Ref_to_Parameter'>items</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1887"><span class='Ref_to_Parameter'>nitem</span></a><span class='Delimiter'>; 
</span>    <a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a> <span class='Operator'>&LT; </span><a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN188"><span class='Ref_to_Member'>nitem</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* search for the leaf page where the first item should go to */ 
</span>        <a href="gindatapage.c.html#LN1890"><span class='Ref_To_Local'>btree</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN171"><span class='Ref_to_Member'>itemptr</span></a> <span class='Operator'>= </span><a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN187"><span class='Ref_to_Member'>items</span></a><span class='Delimiter'>[</span><a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN189"><span class='Ref_to_Member'>curitem</span></a><span class='Delimiter'>]; 
</span>        <a href="gindatapage.c.html#LN1892"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN74"><span class='Ref_to_Func'>ginFindLeafPage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1890"><span class='Ref_To_Local'>btree</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/gin_private.h.html#LN200"><span class='Ref_to_Proto'>ginInsertValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1890"><span class='Ref_To_Local'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1892"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gindatapage.c.html#LN1891"><span class='Ref_To_Local'>insertdata</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1888"><span class='Ref_to_Parameter'>buildStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ginInsertItemPointers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Starts a new scan on a posting tree. 
 */ 
</span><a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>* 
</span><a name="LN1914"></a><span class='Declare_Function'>ginScanBeginPostingTree</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN132"><span class='Ref_to_Typedef'>GinBtree</span></a> <span class='Declare_Parameter'>btree</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>rootBlkno</span><span class='Delimiter'>, 
</span><a name="LN1915"></a>                        <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1917"></a>    <a href="../../../include/access/gin_private.h.html#LN121"><span class='Ref_to_Struct'>GinBtreeStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>stack</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gin_private.h.html#LN227"><span class='Ref_to_Proto'>ginPrepareDataScan</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1914"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1914"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1914"><span class='Ref_to_Parameter'>rootBlkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1914"><span class='Ref_to_Parameter'>btree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN162"><span class='Ref_to_Member'>fullScan</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span> 
    <a href="gindatapage.c.html#LN1917"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="ginbtree.c.html#LN74"><span class='Ref_to_Func'>ginFindLeafPage</span></a><span class='Parentheses'>(</span><a href="gindatapage.c.html#LN1914"><span class='Ref_to_Parameter'>btree</span></a><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span><a href="gindatapage.c.html#LN1915"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gindatapage.c.html#LN1917"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>