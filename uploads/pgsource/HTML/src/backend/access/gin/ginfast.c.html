<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gin\ginfast.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gin\ginfast.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * ginfast.c 
 *    Fast insert routines for the Postgres inverted index access method. 
 *    Pending entries are stored in linear list of pages.  Later on 
 *    (typically during VACUUM), ginInsertCleanup() will be invoked to 
 *    transfer pending entries into the regular index structure.  This 
 *    wins because bulk insertion is much more efficient than retail. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/gin/ginfast.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/gin_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/ginxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/vacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_am.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/indexfsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
 
<span class='Comment_Multi_Line'>/* GUC parameter */ 
</span><a name="LN36"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>gin_pending_list_limit</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN38"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>GIN_PAGE_FREESIZE</span> <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span> BLCKSZ <span class='Operator'>- </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN27"><span class='Ref_to_Struct'>GinPageOpaqueData</span></a><span class='Parentheses'>))</span> <span class='Parentheses'>)</span> 
 
<a name="LN41"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>KeyArray</span> 
<span class='Delimiter'>{ 
</span><a name="LN43"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Member'>keys</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* expansible array */ 
</span><a name="LN44"></a>    <a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Operator'>*</span><span class='Declare_Member'>categories</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* another expansible array */ 
</span><a name="LN45"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>nvalues</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* current number of valid entries */ 
</span><a name="LN46"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>maxvalues</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* allocated size of arrays */ 
</span><a name="LN47"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>KeyArray</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build a pending-list page from the given array of tuples, and write it out. 
 * 
 * Returns amount of free space left on the page. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> 
<a name="LN56"></a><span class='Declare_Function'>writeListPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN57"></a>              <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuples</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>ntuples</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>rightlink</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN59"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN60"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN61"></a>                <span class='Declare_Local'>freesize</span><span class='Delimiter'>, 
</span><a name="LN62"></a>                <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN63"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>l</span><span class='Delimiter'>, 
</span><a name="LN64"></a>                <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN65"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span><a name="LN66"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* workspace could be a local array; we use palloc for alignment */ 
</span>    <a href="ginfast.c.html#LN65"><span class='Ref_To_Local'>workspace</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gin_private.h.html#LN89"><span class='Ref_to_Proto'>GinInitBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN42"><span class='Ref_to_Const'>GIN_LIST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN64"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN66"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN65"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN60"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN60"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN60"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN80"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>this_size</span> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN60"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="ginfast.c.html#LN66"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN60"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ginfast.c.html#LN80"><span class='Ref_To_Local'>this_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN66"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN80"><span class='Ref_To_Local'>this_size</span></a><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN62"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN80"><span class='Ref_To_Local'>this_size</span></a><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN63"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN60"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ginfast.c.html#LN80"><span class='Ref_To_Local'>this_size</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN64"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN63"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item to index page in \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN64"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN62"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&LT;= </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* else we overran workspace */ 
</span> 
    <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>rightlink</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * tail page may contain only whole row(s) or final part of row placed on 
     * previous pages (a "row" here meaning all the index tuples generated for 
     * one heap tuple) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>rightlink</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/ginblock.h.html#LN118"><span class='Ref_to_Macro'>GinPageSetFullRow</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN118"></a>        <a href="../../../include/access/ginxlog.h.html#LN182"><span class='Ref_to_Struct'>ginxlogInsertListPage</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN119"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN118"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN184"><span class='Ref_to_Member'>rightlink</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>rightlink</span></a><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN118"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN185"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN57"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ginfast.c.html#LN118"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN182"><span class='Ref_to_Struct'>ginxlogInsertListPage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN65"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN62"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN119"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN180"><span class='Ref_to_Const'>XLOG_GIN_INSERT_LISTPAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN119"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* get free space before releasing buffer */ 
</span>    <a href="ginfast.c.html#LN61"><span class='Ref_To_Local'>freesize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN59"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN56"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN65"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ginfast.c.html#LN61"><span class='Ref_To_Local'>freesize</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end writeListPage &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN147"></a><span class='Declare_Function'>makeSublist</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuples</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>ntuples</span><span class='Delimiter'>, 
</span><a name="LN148"></a>            <a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN150"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>curBuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN151"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>prevBuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN152"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN153"></a>                <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN154"></a>                <span class='Declare_Local'>tupsize</span><span class='Delimiter'>; 
</span><a name="LN155"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>startTuple</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Split tuples into pages 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN88"><span class='Ref_to_Proto'>GinNewBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN151"><span class='Ref_To_Local'>prevBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="ginfast.c.html#LN148"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="ginfast.c.html#LN55"><span class='Ref_to_Func'>writeListPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN151"><span class='Ref_To_Local'>prevBuffer</span></a><span class='Delimiter'>, 
</span>                              <a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>tuples</span></a> <span class='Operator'>+ </span><a href="ginfast.c.html#LN155"><span class='Ref_To_Local'>startTuple</span></a><span class='Delimiter'>, 
</span>                              <a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><a href="ginfast.c.html#LN155"><span class='Ref_To_Local'>startTuple</span></a><span class='Delimiter'>, 
</span>                              <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="ginfast.c.html#LN148"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="ginfast.c.html#LN151"><span class='Ref_To_Local'>prevBuffer</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN155"><span class='Ref_To_Local'>startTuple</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN153"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if curBuffer==InvalidBuf... &raquo; </span> 
 
        <a href="ginfast.c.html#LN154"><span class='Ref_To_Local'>tupsize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN153"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+ </span><a href="ginfast.c.html#LN154"><span class='Ref_To_Local'>tupsize</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/ginblock.h.html#LN317"><span class='Ref_to_Const'>GinListPageSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* won't fit, force a new page and reprocess */ 
</span>            <a href="ginfast.c.html#LN152"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN153"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN154"><span class='Ref_To_Local'>tupsize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ntuples;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Write last page 
     */ 
</span>    <a href="ginfast.c.html#LN148"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN148"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN55"><span class='Ref_to_Func'>writeListPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN150"><span class='Ref_To_Local'>curBuffer</span></a><span class='Delimiter'>, 
</span>                                      <a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>tuples</span></a> <span class='Operator'>+ </span><a href="ginfast.c.html#LN155"><span class='Ref_To_Local'>startTuple</span></a><span class='Delimiter'>, 
</span>                                      <a href="ginfast.c.html#LN147"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>- </span><a href="ginfast.c.html#LN155"><span class='Ref_To_Local'>startTuple</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN148"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* that was only one heap tuple */ 
</span>    <a href="ginfast.c.html#LN148"><span class='Ref_to_Parameter'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end makeSublist &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write the index tuples contained in *collector into the index's 
 * pending list. 
 * 
 * Function guarantees that all these tuples will be inserted consecutively, 
 * preserving order 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN221"></a><span class='Declare_Function'>ginHeapTupleFastInsert</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN50"><span class='Ref_to_Struct'>GinState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ginstate</span><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN426"><span class='Ref_to_Struct'>GinTupleCollector</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>collector</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN223"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>index</span> <span class='Operator'>= </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN52"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span><a name="LN224"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuffer</span><span class='Delimiter'>; 
</span><a name="LN225"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapage</span><span class='Delimiter'>; 
</span><a name="LN226"></a>    <a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN227"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN228"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN229"></a>    <a href="../../../include/access/ginxlog.h.html#LN168"><span class='Ref_to_Struct'>ginxlogUpdateMeta</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN230"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>separateList</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN231"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needCleanup</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN232"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>cleanupSize</span><span class='Delimiter'>; 
</span><a name="LN233"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needWal</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN233"><span class='Ref_To_Local'>needWal</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN170"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN174"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN173"><span class='Ref_to_Member'>newRightlink</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN172"><span class='Ref_to_Member'>prevTail</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN49"><span class='Ref_to_Const'>GIN_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN225"><span class='Ref_To_Local'>metapage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN431"><span class='Ref_to_Member'>sumsize</span></a> <span class='Operator'>+ </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../../../include/access/ginblock.h.html#LN317"><span class='Ref_to_Const'>GinListPageSize</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Total size is greater than one page =&GT; make sublist 
         */ 
</span>        <a href="ginfast.c.html#LN230"><span class='Ref_To_Local'>separateList</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN102"><span class='Ref_to_Macro'>GinPageGetMeta</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN225"><span class='Ref_To_Local'>metapage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>|| 
</span>            <a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN431"><span class='Ref_to_Member'>sumsize</span></a> <span class='Operator'>+ </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Pending list is empty or total size is greater than freespace 
             * on tail page =&GT; make sublist 
             * 
             * We unlock metabuffer to keep high concurrency 
             */ 
</span>            <a href="ginfast.c.html#LN230"><span class='Ref_To_Local'>separateList</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN230"><span class='Ref_To_Local'>separateList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We should make sublist separately and append it to the tail 
         */ 
</span><a name="LN278"></a>        <a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a> <span class='Declare_Local'>sublist</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN146"><span class='Ref_to_Func'>makeSublist</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN233"><span class='Ref_To_Local'>needWal</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * metapage was unlocked, see above 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN102"><span class='Ref_to_Macro'>GinPageGetMeta</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN225"><span class='Ref_To_Local'>metapage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Main list is empty, so just insert sublist as main list 
             */ 
</span>            <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Merge lists 
             */ 
</span>            <a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN172"><span class='Ref_to_Member'>prevTail</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN173"><span class='Ref_to_Member'>newRightlink</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN278"><span class='Ref_To_Local'>sublist</span></a><span class='Operator'>.</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN233"><span class='Ref_To_Local'>needWal</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if separateList &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Insert into tail page.  Metapage is already locked 
         */ 
</span><a name="LN341"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>l</span><span class='Delimiter'>, 
</span><a name="LN342"></a>                    <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN343"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN344"></a>                    <span class='Declare_Local'>tupsize</span><span class='Delimiter'>; 
</span><a name="LN345"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN346"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>collectordata</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN342"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>: 
</span>            <a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN346"><span class='Ref_To_Local'>collectordata</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN345"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN431"><span class='Ref_to_Member'>sumsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN174"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN233"><span class='Ref_To_Local'>needWal</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Increase counter of heap tuples 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff <span class='Operator'>&LT;= </span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN343"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN343"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN343"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN344"><span class='Ref_To_Local'>tupsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN343"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN341"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN343"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ginfast.c.html#LN344"><span class='Ref_To_Local'>tupsize</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN342"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN341"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item to index page in \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><a href="ginfast.c.html#LN345"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN343"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ginfast.c.html#LN344"><span class='Ref_To_Local'>tupsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN345"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN344"><span class='Ref_To_Local'>tupsize</span></a><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN342"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="ginfast.c.html#LN345"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>- </span><a href="ginfast.c.html#LN346"><span class='Ref_To_Local'>collectordata</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN431"><span class='Ref_to_Member'>sumsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN233"><span class='Ref_To_Local'>needWal</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN346"><span class='Ref_To_Local'>collectordata</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN431"><span class='Ref_to_Member'>sumsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Write metabuffer, make xlog entry 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN233"><span class='Ref_To_Local'>needWal</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN405"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN171"><span class='Ref_to_Member'>metadata</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ginfast.c.html#LN229"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN168"><span class='Ref_to_Struct'>ginxlogUpdateMeta</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN405"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN162"><span class='Ref_to_Const'>XLOG_GIN_UPDATE_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN225"><span class='Ref_To_Local'>metapage</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN405"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN228"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN405"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN227"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force pending list cleanup when it becomes too long. And, 
     * ginInsertCleanup could take significant amount of time, so we prefer to 
     * call it when it can do all the work in a single collection cycle. In 
     * non-vacuum mode, it shouldn't require maintenance_work_mem, so fire it 
     * while pending list is still small enough to fit into 
     * gin_pending_list_limit. 
     * 
     * ginInsertCleanup() should not be called inside our CRIT_SECTION. 
     */ 
</span>    <a href="ginfast.c.html#LN232"><span class='Ref_To_Local'>cleanupSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN34"><span class='Ref_to_Macro'>GinGetPendingListCleanupSize</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN223"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN226"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a> <span class='Operator'>* </span><a href="ginfast.c.html#LN38"><span class='Ref_to_Const'>GIN_PAGE_FREESIZE</span></a> <span class='Operator'>&GT; </span><a href="ginfast.c.html#LN232"><span class='Ref_To_Local'>cleanupSize</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>) 
</span>        <a href="ginfast.c.html#LN231"><span class='Ref_To_Local'>needCleanup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN224"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN231"><span class='Ref_To_Local'>needCleanup</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/gin_private.h.html#LN440"><span class='Ref_to_Proto'>ginInsertCleanup</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN221"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginHeapTupleFastInsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create temporary index tuples for a single indexable item (one index column 
 * for the heap tuple specified by ht_ctid), and append them to the array 
 * in *collector.  They will subsequently be written out using 
 * ginHeapTupleFastInsert.  Note that to guarantee consistent state, all 
 * temp tuples for a given heap tuple must be written in one call to 
 * ginHeapTupleFastInsert. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN455"></a><span class='Declare_Function'>ginHeapTupleFastCollect</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN50"><span class='Ref_to_Struct'>GinState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ginstate</span><span class='Delimiter'>, 
</span><a name="LN456"></a>                        <a href="../../../include/access/gin_private.h.html#LN426"><span class='Ref_to_Struct'>GinTupleCollector</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>collector</span><span class='Delimiter'>, 
</span><a name="LN457"></a>                        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNull</span><span class='Delimiter'>, 
</span><a name="LN458"></a>                        <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ht_ctid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN460"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>entries</span><span class='Delimiter'>; 
</span><a name="LN461"></a>    <a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Operator'>*</span><span class='Declare_Local'>categories</span><span class='Delimiter'>; 
</span><a name="LN462"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN463"></a>                <span class='Declare_Local'>nentries</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Extract the key values that need to be inserted in the index 
     */ 
</span>    <a href="ginfast.c.html#LN460"><span class='Ref_To_Local'>entries</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN98"><span class='Ref_to_Proto'>ginExtractEntries</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN455"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN457"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, </span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN457"><span class='Ref_to_Parameter'>isNull</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="ginfast.c.html#LN463"><span class='Ref_To_Local'>nentries</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN461"><span class='Ref_To_Local'>categories</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate/reallocate memory for storing collected tuples 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN430"><span class='Ref_to_Member'>lentuples</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN463"><span class='Ref_To_Local'>nentries</span></a> <span class='Operator'>* </span><a href="ginfast.c.html#LN455"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN66"><span class='Ref_to_Member'>origTupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN430"><span class='Ref_to_Member'>lentuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>+ </span><a href="ginfast.c.html#LN463"><span class='Ref_To_Local'>nentries</span></a> <span class='Operator'>&GT; </span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN430"><span class='Ref_to_Member'>lentuples</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN430"><span class='Ref_to_Member'>lentuples</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>, 
</span>                                  <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN430"><span class='Ref_to_Member'>lentuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build an index tuple for each key value, and add to array.  In pending 
     * tuples we just stick the heap TID into t_tid. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN462"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN462"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN463"><span class='Ref_To_Local'>nentries</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN462"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN493"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN493"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="ginentrypage.c.html#LN43"><span class='Ref_to_Func'>GinFormTuple</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN455"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN457"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN460"><span class='Ref_To_Local'>entries</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN462"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ginfast.c.html#LN461"><span class='Ref_To_Local'>categories</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN462"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                            <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN493"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a> <span class='Operator'>= *</span><a href="ginfast.c.html#LN458"><span class='Ref_to_Parameter'>ht_ctid</span></a><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN428"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN429"><span class='Ref_to_Member'>ntuples</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ginfast.c.html#LN493"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN456"><span class='Ref_to_Parameter'>collector</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN431"><span class='Ref_to_Member'>sumsize</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN493"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ginHeapTupleFastCollect &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Deletes pending list pages up to (not including) newHead page. 
 * If newHead == InvalidBlockNumber then function drops the whole list. 
 * 
 * metapage is pinned and exclusive-locked throughout this function. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN510"></a><span class='Declare_Function'>shiftList</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>metabuffer</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>newHead</span><span class='Delimiter'>, 
</span><a name="LN511"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>fill_fsm</span><span class='Delimiter'>, </span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN513"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapage</span><span class='Delimiter'>; 
</span><a name="LN514"></a>    <a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span><a name="LN515"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blknoToDelete</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN513"><span class='Ref_To_Local'>metapage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN102"><span class='Ref_to_Macro'>GinPageGetMeta</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN513"><span class='Ref_To_Local'>metapage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN523"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN524"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN525"></a>        <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>nDeletedHeapTuples</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN526"></a>        <a href="../../../include/access/ginxlog.h.html#LN203"><span class='Ref_to_Struct'>ginxlogDeleteListPages</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN527"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffers</span><span class='Delimiter'>[</span><a href="../../../include/access/ginxlog.h.html#LN202"><span class='Ref_to_Const'>GIN_NDELETE_AT_ONCE</span></a><span class='Delimiter'>]; 
</span><a name="LN528"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>freespace</span><span class='Delimiter'>[</span><a href="../../../include/access/ginxlog.h.html#LN202"><span class='Ref_to_Const'>GIN_NDELETE_AT_ONCE</span></a><span class='Delimiter'>]; 
</span> 
        <a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/ginxlog.h.html#LN202"><span class='Ref_to_Const'>GIN_NDELETE_AT_ONCE</span></a> <span class='Operator'>&& </span><a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a> <span class='Operator'>!= </span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>newHead</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN528"><span class='Ref_To_Local'>freespace</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>], </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN122"><span class='Ref_to_Macro'>GinPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN525"><span class='Ref_To_Local'>nDeletedHeapTuples</span></a> <span class='Operator'>+= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>maxoff<span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN511"><span class='Ref_to_Parameter'>stats</span></a><span class='Parentheses'>) 
</span>            <a href="ginfast.c.html#LN511"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN77"><span class='Ref_to_Member'>pages_deleted</span></a> <span class='Operator'>+= </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This operation touches an unusually large number of pages, so 
         * prepare the XLogInsert machinery for that before entering the 
         * critical section. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN44"><span class='Ref_to_Proto'>XLogEnsureRecordSpace</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a> <span class='Operator'>&GT;= </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a> <span class='Operator'>-= </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a> <span class='Operator'>&GT;= </span><a href="ginfast.c.html#LN525"><span class='Ref_To_Local'>nDeletedHeapTuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a> <span class='Operator'>-= </span><a href="ginfast.c.html#LN525"><span class='Ref_To_Local'>nDeletedHeapTuples</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN65"><span class='Ref_to_Member'>tailFreeSize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN71"><span class='Ref_to_Member'>nPendingPages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN72"><span class='Ref_to_Member'>nPendingHeapTuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN40"><span class='Ref_to_Const'>GIN_DELETED</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN585"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN205"><span class='Ref_to_Member'>metadata</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN514"><span class='Ref_To_Local'>metadata</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, 
</span>                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginxlog.h.html#LN203"><span class='Ref_to_Struct'>ginxlogDeleteListPages</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="ginfast.c.html#LN585"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIN_ID<span class='Delimiter'>, </span><a href="../../../include/access/ginxlog.h.html#LN194"><span class='Ref_to_Const'>XLOG_GIN_DELETE_LISTPAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN513"><span class='Ref_To_Local'>metapage</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN585"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN523"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN585"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(inde... &raquo; </span> 
 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN527"><span class='Ref_To_Local'>buffers</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ginfast.c.html#LN511"><span class='Ref_to_Parameter'>fill_fsm</span></a> <span class='Operator'>&& </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ginfast.c.html#LN526"><span class='Ref_To_Local'>data</span></a><span class='Operator'>.</span><a href="../../../include/access/ginxlog.h.html#LN206"><span class='Ref_to_Member'>ndeleted</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/indexfsm.h.html#LN20"><span class='Ref_to_Proto'>RecordFreeIndexPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN528"><span class='Ref_To_Local'>freespace</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN524"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN515"><span class='Ref_To_Local'>blknoToDelete</span></a> <span class='Operator'>!= </span><a href="ginfast.c.html#LN510"><span class='Ref_to_Parameter'>newHead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shiftList &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Initialize empty KeyArray */ 
</span><span class='Keyword'>static void 
</span><a name="LN620"></a><span class='Declare_Function'>initKeyArray</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN41"><span class='Ref_to_Struct'>KeyArray</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>keys</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>maxvalues</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN43"><span class='Ref_to_Member'>keys</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>maxvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN44"><span class='Ref_to_Member'>categories</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>maxvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN46"><span class='Ref_to_Member'>maxvalues</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN620"><span class='Ref_to_Parameter'>maxvalues</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Add datum to KeyArray, resizing if needed */ 
</span><span class='Keyword'>static void 
</span><a name="LN631"></a><span class='Declare_Function'>addDatum</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN41"><span class='Ref_to_Struct'>KeyArray</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>keys</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>datum</span><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Declare_Parameter'>category</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a> <span class='Operator'>&GT;= </span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN46"><span class='Ref_to_Member'>maxvalues</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN46"><span class='Ref_to_Member'>maxvalues</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN43"><span class='Ref_to_Member'>keys</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN43"><span class='Ref_to_Member'>keys</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN46"><span class='Ref_to_Member'>maxvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN44"><span class='Ref_to_Member'>categories</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN44"><span class='Ref_to_Member'>categories</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN46"><span class='Ref_to_Member'>maxvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN43"><span class='Ref_to_Member'>keys</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>datum</span></a><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN44"><span class='Ref_to_Member'>categories</span></a><span class='Delimiter'>[</span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN631"><span class='Ref_to_Parameter'>keys</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Collect data from a pending-list page in preparation for insertion into 
 * the main index. 
 * 
 * Go through all tuples &GT;= startoff on page and collect values in accum 
 * 
 * Note that ka is just workspace --- it does not carry any state across 
 * calls. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN657"></a><span class='Declare_Function'>processPendingPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>accum</span><span class='Delimiter'>, </span><a href="ginfast.c.html#LN41"><span class='Ref_to_Struct'>KeyArray</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ka</span><span class='Delimiter'>, 
</span><a name="LN658"></a>                   <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>startoff</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN660"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>heapptr</span><span class='Delimiter'>; 
</span><a name="LN661"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN662"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN663"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>attrnum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* reset *ka to empty */ 
</span>    <a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN662"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN658"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN662"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN663"><span class='Ref_To_Local'>attrnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN661"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN658"><span class='Ref_to_Parameter'>startoff</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN661"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="ginfast.c.html#LN662"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="ginfast.c.html#LN661"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN661"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN675"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN658"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN658"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN661"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN676"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>curattnum</span><span class='Delimiter'>; 
</span><a name="LN677"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>curkey</span><span class='Delimiter'>; 
</span><a name="LN678"></a>        <a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Declare_Local'>curcategory</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check for change of heap TID or attnum */ 
</span>        <a href="ginfast.c.html#LN676"><span class='Ref_To_Local'>curattnum</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN102"><span class='Ref_to_Proto'>gintuple_get_attrnum</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN406"><span class='Ref_to_Member'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN675"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN675"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN663"><span class='Ref_To_Local'>attrnum</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN676"><span class='Ref_To_Local'>curattnum</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../../storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN675"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                   <a href="ginfast.c.html#LN676"><span class='Ref_To_Local'>curattnum</span></a> <span class='Operator'>== </span><a href="ginfast.c.html#LN663"><span class='Ref_To_Local'>attrnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * ginInsertBAEntries can insert several datums per call, but only 
             * for one heap tuple and one column.  So call it at a boundary, 
             * and reset ka. 
             */ 
</span>            <a href="ginbulk.c.html#LN207"><span class='Ref_to_Func'>ginInsertBAEntries</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>accum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN663"><span class='Ref_To_Local'>attrnum</span></a><span class='Delimiter'>, 
</span>                               <a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN43"><span class='Ref_to_Member'>keys</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN44"><span class='Ref_to_Member'>categories</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN675"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN663"><span class='Ref_To_Local'>attrnum</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN676"><span class='Ref_To_Local'>curattnum</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Add key to KeyArray */ 
</span>        <a href="ginfast.c.html#LN677"><span class='Ref_To_Local'>curkey</span></a> <span class='Operator'>= </span><a href="../../../include/access/gin_private.h.html#LN103"><span class='Ref_to_Proto'>gintuple_get_key</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>accum</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN406"><span class='Ref_to_Member'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN675"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN678"><span class='Ref_To_Local'>curcategory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN630"><span class='Ref_to_Func'>addDatum</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN677"><span class='Ref_To_Local'>curkey</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN678"><span class='Ref_To_Local'>curcategory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=startoff;i&LT;=maxoff;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Dump out all remaining keys */ 
</span>    <a href="ginbulk.c.html#LN207"><span class='Ref_to_Func'>ginInsertBAEntries</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>accum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN660"><span class='Ref_To_Local'>heapptr</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN663"><span class='Ref_To_Local'>attrnum</span></a><span class='Delimiter'>, 
</span>                       <a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN43"><span class='Ref_to_Member'>keys</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN44"><span class='Ref_to_Member'>categories</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN657"><span class='Ref_to_Parameter'>ka</span></a><span class='Operator'>-&GT;</span><a href="ginfast.c.html#LN45"><span class='Ref_to_Member'>nvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end processPendingPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Move tuples from pending pages into regular GIN structure. 
 * 
 * On first glance it looks completely not crash-safe. But if we crash 
 * after posting entries to the main index and before removing them from the 
 * pending list, it's okay because when we redo the posting later on, nothing 
 * bad will happen. 
 * 
 * fill_fsm indicates that ginInsertCleanup should add deleted pages 
 * to FSM otherwise caller is responsible to put deleted pages into 
 * FSM. 
 * 
 * If stats isn't null, we count deleted pending pages into the counts. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN728"></a><span class='Declare_Function'>ginInsertCleanup</span><span class='Parentheses'>(</span><a href="../../../include/access/gin_private.h.html#LN50"><span class='Ref_to_Struct'>GinState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ginstate</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>full_clean</span><span class='Delimiter'>, 
</span><a name="LN729"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>fill_fsm</span><span class='Delimiter'>, </span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN731"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>index</span> <span class='Operator'>= </span><a href="ginfast.c.html#LN728"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gin_private.h.html#LN52"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span><a name="LN732"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuffer</span><span class='Delimiter'>, 
</span><a name="LN733"></a>                <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN734"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapage</span><span class='Delimiter'>, 
</span><a name="LN735"></a>                <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN736"></a>    <a href="../../../include/access/ginblock.h.html#LN52"><span class='Ref_to_Struct'>GinMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span><a name="LN737"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>opCtx</span><span class='Delimiter'>, 
</span><a name="LN738"></a>                <span class='Declare_Local'>oldCtx</span><span class='Delimiter'>; 
</span><a name="LN739"></a>    <a href="../../../include/access/gin_private.h.html#LN404"><span class='Ref_to_Typedef'>BuildAccumulator</span></a> <span class='Declare_Local'>accum</span><span class='Delimiter'>; 
</span><a name="LN740"></a>    <a href="ginfast.c.html#LN41"><span class='Ref_to_Struct'>KeyArray</span></a>    <span class='Declare_Local'>datums</span><span class='Delimiter'>; 
</span><a name="LN741"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>, 
</span><a name="LN742"></a>                <span class='Declare_Local'>blknoFinish</span><span class='Delimiter'>; 
</span><a name="LN743"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>cleanupFinish</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN744"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>fsm_vac</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN745"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>workMemory</span><span class='Delimiter'>; 
</span><a name="LN746"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>inVacuum</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN729"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We would like to prevent concurrent cleanup process. For that we will 
     * lock metapage in exclusive mode using LockPage() call. Nobody other 
     * will use that lock for metapage, so we keep possibility of concurrent 
     * insertion into pending list 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN746"><span class='Ref_To_Local'>inVacuum</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We are called from [auto]vacuum/analyze or gin_clean_pending_list() 
         * and we would like to wait concurrent cleanup to finish. 
         */ 
</span>        <a href="../../../include/storage/lmgr.h.html#LN60"><span class='Ref_to_Proto'>LockPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN49"><span class='Ref_to_Const'>GIN_METAPAGE_BLKNO</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN745"><span class='Ref_To_Local'>workMemory</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><a href="../../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="../../postmaster/autovacuum.c.html#LN113"><span class='Ref_to_Global_Var'>autovacuum_work_mem</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>? 
</span>            <a href="../../postmaster/autovacuum.c.html#LN113"><span class='Ref_to_Global_Var'>autovacuum_work_mem</span></a> <span class='Operator'>: </span><a href="../../utils/init/globals.c.html#LN113"><span class='Ref_to_Global_Var'>maintenance_work_mem</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We are called from regular insert and if we see concurrent cleanup 
         * just exit in hope that concurrent process will clean up pending 
         * list. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lmgr.h.html#LN61"><span class='Ref_to_Proto'>ConditionalLockPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN49"><span class='Ref_to_Const'>GIN_METAPAGE_BLKNO</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN745"><span class='Ref_To_Local'>workMemory</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN49"><span class='Ref_to_Const'>GIN_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN734"><span class='Ref_To_Local'>metapage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN736"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN102"><span class='Ref_to_Macro'>GinPageGetMeta</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN734"><span class='Ref_To_Local'>metapage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN736"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Nothing to do */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lmgr.h.html#LN62"><span class='Ref_to_Proto'>UnlockPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN49"><span class='Ref_to_Const'>GIN_METAPAGE_BLKNO</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remember a tail page to prevent infinite cleanup if other backends add 
     * new tuples faster than we can cleanup. 
     */ 
</span>    <a href="ginfast.c.html#LN742"><span class='Ref_To_Local'>blknoFinish</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN736"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN60"><span class='Ref_to_Member'>tail</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read and lock head of pending list 
     */ 
</span>    <a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN736"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize.  All temporary space will be in opCtx 
     */ 
</span>    <a href="ginfast.c.html#LN737"><span class='Ref_To_Local'>opCtx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"GIN insert cleanup temporary context"</span><span class='Delimiter'>, 
</span>                                  <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN738"><span class='Ref_To_Local'>oldCtx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN737"><span class='Ref_To_Local'>opCtx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ginfast.c.html#LN619"><span class='Ref_to_Func'>initKeyArray</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN740"><span class='Ref_To_Local'>datums</span></a><span class='Delimiter'>, </span><span class='Number'>128</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginbulk.c.html#LN107"><span class='Ref_to_Func'>ginInitBA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN406"><span class='Ref_to_Member'>ginstate</span></a> <span class='Operator'>= </span><a href="ginfast.c.html#LN728"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * At the top of this loop, we have pin and lock on the current page of 
     * the pending list.  However, we'll release that before exiting the loop. 
     * Note we also have pin but not lock on the metapage. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN122"><span class='Ref_to_Macro'>GinPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Are we walk through the page which as we remember was a tail when 
         * we start our cleanup?  But if caller asks us to clean up whole 
         * pending list then ignore old tail, we will work until list becomes 
         * empty. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="ginfast.c.html#LN742"><span class='Ref_To_Local'>blknoFinish</span></a> <span class='Operator'>&& </span><a href="ginfast.c.html#LN728"><span class='Ref_to_Parameter'>full_clean</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Parentheses'>) 
</span>            <a href="ginfast.c.html#LN743"><span class='Ref_To_Local'>cleanupFinish</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * read page's datums into accum 
         */ 
</span>        <a href="ginfast.c.html#LN656"><span class='Ref_to_Func'>processPendingPage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN740"><span class='Ref_To_Local'>datums</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Is it time to flush memory to disk?  Flush if we are at the end of 
         * the pending list, or if we have a full row and memory is getting 
         * full. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="../../../include/access/ginblock.h.html#LN117"><span class='Ref_to_Macro'>GinPageHasFullRow</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>             <span class='Parentheses'>(</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Operator'>.</span><a href="../../../include/access/gin_private.h.html#LN407"><span class='Ref_to_Member'>allocatedMemory</span></a> <span class='Operator'>&GT;= </span><a href="ginfast.c.html#LN745"><span class='Ref_To_Local'>workMemory</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN854"></a>            <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>list</span><span class='Delimiter'>; 
</span><a name="LN855"></a>            <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>nlist</span><span class='Delimiter'>; 
</span><a name="LN856"></a>            <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN857"></a>            <a href="../../../include/access/ginblock.h.html#LN196"><span class='Ref_to_Typedef'>GinNullCategory</span></a> <span class='Declare_Local'>category</span><span class='Delimiter'>; 
</span><a name="LN858"></a>            <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>, 
</span><a name="LN859"></a>                        <span class='Declare_Local'>attnum</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Unlock current page to increase performance. Changes of page 
             * will be checked later by comparing maxoff after completion of 
             * memory flush. 
             */ 
</span>            <a href="ginfast.c.html#LN858"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Moving collected data into regular structure can take 
             * significant amount of time - so, run it without locking pending 
             * list. 
             */ 
</span>            <a href="ginbulk.c.html#LN254"><span class='Ref_to_Func'>ginBeginBAScan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="ginfast.c.html#LN854"><span class='Ref_To_Local'>list</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN265"><span class='Ref_to_Func'>ginGetBAEntry</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="ginfast.c.html#LN859"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN856"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN857"><span class='Ref_To_Local'>category</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN855"><span class='Ref_To_Local'>nlist</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/gin_private.h.html#LN114"><span class='Ref_to_Proto'>ginEntryInsert</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN728"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN859"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN856"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN857"><span class='Ref_To_Local'>category</span></a><span class='Delimiter'>, 
</span>                               <a href="ginfast.c.html#LN854"><span class='Ref_To_Local'>list</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN855"><span class='Ref_To_Local'>nlist</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Lock the whole list to remove pages 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN44"><span class='Ref_to_Const'>GIN_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/ginblock.h.html#LN122"><span class='Ref_to_Macro'>GinPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * While we left the page unlocked, more stuff might have gotten 
             * added to it.  If so, process those entries immediately.  There 
             * shouldn't be very many, so we don't worry about the fact that 
             * we're doing this with exclusive lock. Insertion algorithm 
             * guarantees that inserted row(s) will not continue on next page. 
             * NOTE: intentionally no vacuum_delay_point in this loop. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="ginfast.c.html#LN858"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="ginbulk.c.html#LN107"><span class='Ref_to_Func'>ginInitBA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ginfast.c.html#LN656"><span class='Ref_to_Func'>processPendingPage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN740"><span class='Ref_To_Local'>datums</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN858"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="ginbulk.c.html#LN254"><span class='Ref_to_Func'>ginBeginBAScan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="ginfast.c.html#LN854"><span class='Ref_To_Local'>list</span></a> <span class='Operator'>= </span><a href="ginbulk.c.html#LN265"><span class='Ref_to_Func'>ginGetBAEntry</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="ginfast.c.html#LN859"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN856"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN857"><span class='Ref_To_Local'>category</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN855"><span class='Ref_To_Local'>nlist</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                    <a href="../../../include/access/gin_private.h.html#LN114"><span class='Ref_to_Proto'>ginEntryInsert</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN728"><span class='Ref_to_Parameter'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN859"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN856"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN857"><span class='Ref_To_Local'>category</span></a><span class='Delimiter'>, 
</span>                                   <a href="ginfast.c.html#LN854"><span class='Ref_To_Local'>list</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN855"><span class='Ref_To_Local'>nlist</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Remember next page - it will become the new list head 
             */ 
</span>            <a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Multi_Line'>/* shiftList will do exclusive 
                                                 * locking */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * remove read pages from pending list, at this point all content 
             * of read pages is in regular structure 
             */ 
</span>            <a href="ginfast.c.html#LN509"><span class='Ref_to_Func'>shiftList</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN729"><span class='Ref_to_Parameter'>fill_fsm</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN729"><span class='Ref_to_Parameter'>stats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* At this point, some pending pages have been freed up */ 
</span>            <a href="ginfast.c.html#LN744"><span class='Ref_To_Local'>fsm_vac</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="ginfast.c.html#LN736"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/ginblock.h.html#LN59"><span class='Ref_to_Member'>head</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN42"><span class='Ref_to_Const'>GIN_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * if we removed the whole pending list or we cleanup tail (which 
             * we remembered on start our cleanup process) then just exit 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>|| </span><a href="ginfast.c.html#LN743"><span class='Ref_To_Local'>cleanupFinish</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * release memory used so far and reinit state 
             */ 
</span>            <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN737"><span class='Ref_To_Local'>opCtx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginfast.c.html#LN619"><span class='Ref_to_Func'>initKeyArray</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN740"><span class='Ref_To_Local'>datums</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN740"><span class='Ref_To_Local'>datums</span></a><span class='Operator'>.</span><a href="ginfast.c.html#LN46"><span class='Ref_to_Member'>maxvalues</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ginbulk.c.html#LN107"><span class='Ref_to_Func'>ginInitBA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN739"><span class='Ref_To_Local'>accum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if GinPageGetOpaque(page... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/ginblock.h.html#LN108"><span class='Ref_to_Macro'>GinPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Read next page in pending list 
         */ 
</span>        <a href="../../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN741"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gin_private.h.html#LN43"><span class='Ref_to_Const'>GIN_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ginfast.c.html#LN735"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN733"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <a href="../../../include/storage/lmgr.h.html#LN62"><span class='Ref_to_Proto'>UnlockPage</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/ginblock.h.html#LN49"><span class='Ref_to_Const'>GIN_METAPAGE_BLKNO</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN732"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * As pending list pages can have a high churn rate, it is desirable to 
     * recycle them immediately to the FreeSpace Map when ordinary backends 
     * clean the list. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN744"><span class='Ref_To_Local'>fsm_vac</span></a> <span class='Operator'>&& </span><a href="ginfast.c.html#LN729"><span class='Ref_to_Parameter'>fill_fsm</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/indexfsm.h.html#LN23"><span class='Ref_to_Proto'>IndexFreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN731"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* Clean up temporary space */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN738"><span class='Ref_To_Local'>oldCtx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN737"><span class='Ref_To_Local'>opCtx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ginInsertCleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL-callable function to clean the insert pending list 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN980"></a><span class='Declare_Function'>gin_clean_pending_list</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN982"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indexoid</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN239"><span class='Ref_to_Macro'>PG_GETARG_OID</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN983"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRel</span> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN982"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN984"></a>    <a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Declare_Local'>stats</span><span class='Delimiter'>; 
</span><a name="LN985"></a>    <a href="../../../include/access/gin_private.h.html#LN50"><span class='Ref_to_Struct'>GinState</span></a>    <span class='Declare_Local'>ginstate</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"recovery is in progress"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"GIN pending list cannot be cleaned up during recovery."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be a GIN index */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a> <span class='Operator'>|| 
</span>        <a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relam <span class='Operator'>!= </span><a href="../../../include/catalog/pg_am.h.html#LN78"><span class='Ref_to_Const'>GIN_AM_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a GIN index"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reject attempts to read non-local temporary relations; we would be 
     * likely to get wrong data since we have no visibility into the owning 
     * session's local buffers. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN533"><span class='Ref_to_Macro'>RELATION_IS_OTHER_TEMP</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot access temporary indexes of other sessions"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* User must own the index (comparable to privileges needed for VACUUM) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN982"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN984"><span class='Ref_To_Local'>stats</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ginfast.c.html#LN984"><span class='Ref_To_Local'>stats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="ginutil.c.html#LN84"><span class='Ref_to_Func'>initGinState</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN985"><span class='Ref_To_Local'>ginstate</span></a><span class='Delimiter'>, </span><a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gin_private.h.html#LN440"><span class='Ref_to_Proto'>ginInsertCleanup</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ginfast.c.html#LN985"><span class='Ref_To_Local'>ginstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ginfast.c.html#LN984"><span class='Ref_To_Local'>stats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="ginfast.c.html#LN983"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN326"><span class='Ref_to_Macro'>PG_RETURN_INT64</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="ginfast.c.html#LN984"><span class='Ref_To_Local'>stats</span></a><span class='Operator'>.</span><a href="../../../include/access/genam.h.html#LN77"><span class='Ref_to_Member'>pages_deleted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gin_clean_pending_list &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>