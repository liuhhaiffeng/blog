<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gist\gist.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gist\gist.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * gist.c 
 *    interface routines for the postgres GiST index access method. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/gist/gist.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/gist_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/gistscan.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_collation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/execnodes.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/index_selfuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* non-export function prototypes */ 
</span><a name="LN28"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistfixsplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN29"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>gistinserttuple</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN30"></a>             <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN31"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>gistinserttuples</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN32"></a>                 <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, 
</span><a name="LN33"></a>                 <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuples</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntup</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Delimiter'>, 
</span><a name="LN34"></a>                 <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>leftchild</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>rightchild</span><span class='Delimiter'>, 
</span><a name="LN35"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>unlockbuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>unlockleftchild</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN36"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistfinishsplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN37"></a>                <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>splitinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>releasebuf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN38"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistvacuumpage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<a name="LN41"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ROTATEDIST</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>d</span><span class='Parentheses'>) </span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a> <span class='Operator'>*</span>tmp<span class='Operator'>=</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a><span class='Operator'>*</span><span class='Parentheses'>)</span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    memset<span class='Parentheses'>(</span>tmp<span class='Delimiter'>,</span><span class='Number'>0</span><span class='Delimiter'>,</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    tmp<span class='Operator'>-&GT;</span>block<span class='Operator'>.</span>blkno <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>;</span>  <span class='Operator'>\ 
</span>    tmp<span class='Operator'>-&GT;</span>buffer <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>;</span>    <span class='Operator'>\ 
</span>    tmp<span class='Operator'>-&GT;</span>next <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gist.c.html#LN41"><span class='Ref_to_Parameter'>d</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="gist.c.html#LN41"><span class='Ref_to_Parameter'>d</span></a><span class='Parentheses'>)</span><span class='Operator'>=</span>tmp<span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * GiST handler function: return IndexAmRoutine with access method parameters 
 * and callbacks. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN56"></a><span class='Declare_Function'>gisthandler</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN58"></a>    <a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amroutine</span> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN166"><span class='Ref_to_Member'>amstrategies</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN168"><span class='Ref_to_Member'>amsupport</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN36"><span class='Ref_to_Const'>GISTNProcs</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN172"><span class='Ref_to_Member'>amcanorderbyop</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN174"><span class='Ref_to_Member'>amcanbackward</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN176"><span class='Ref_to_Member'>amcanunique</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN178"><span class='Ref_to_Member'>amcanmulticol</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN180"><span class='Ref_to_Member'>amoptionalkey</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN182"><span class='Ref_to_Member'>amsearcharray</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN184"><span class='Ref_to_Member'>amsearchnulls</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN186"><span class='Ref_to_Member'>amstorage</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN188"><span class='Ref_to_Member'>amclusterable</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN190"><span class='Ref_to_Member'>ampredlocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN192"><span class='Ref_to_Member'>amcanparallel</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN194"><span class='Ref_to_Member'>amkeytype</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN197"><span class='Ref_to_Member'>ambuild</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN112"><span class='Ref_to_Func'>gistbuild</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN198"><span class='Ref_to_Member'>ambuildempty</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN119"><span class='Ref_to_Func'>gistbuildempty</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN199"><span class='Ref_to_Member'>aminsert</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN145"><span class='Ref_to_Func'>gistinsert</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN200"><span class='Ref_to_Member'>ambulkdelete</span></a> <span class='Operator'>= </span><a href="gistvacuum.c.html#LN137"><span class='Ref_to_Func'>gistbulkdelete</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN201"><span class='Ref_to_Member'>amvacuumcleanup</span></a> <span class='Operator'>= </span><a href="gistvacuum.c.html#LN27"><span class='Ref_to_Func'>gistvacuumcleanup</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN202"><span class='Ref_to_Member'>amcanreturn</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN424"><span class='Ref_to_Proto'>gistcanreturn</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN203"><span class='Ref_to_Member'>amcostestimate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/index_selfuncs.h.html#LN48"><span class='Ref_to_Proto'>gistcostestimate</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN204"><span class='Ref_to_Member'>amoptions</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN437"><span class='Ref_to_Proto'>gistoptions</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN205"><span class='Ref_to_Member'>amproperty</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN438"><span class='Ref_to_Proto'>gistproperty</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN206"><span class='Ref_to_Member'>amvalidate</span></a> <span class='Operator'>= </span><a href="gistvalidate.c.html#LN32"><span class='Ref_to_Func'>gistvalidate</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN207"><span class='Ref_to_Member'>ambeginscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/gistscan.h.html#LN18"><span class='Ref_to_Proto'>gistbeginscan</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN208"><span class='Ref_to_Member'>amrescan</span></a> <span class='Operator'>= </span><a href="../../../include/access/gistscan.h.html#LN19"><span class='Ref_to_Proto'>gistrescan</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN209"><span class='Ref_to_Member'>amgettuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN422"><span class='Ref_to_Proto'>gistgettuple</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN210"><span class='Ref_to_Member'>amgetbitmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN423"><span class='Ref_to_Proto'>gistgetbitmap</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN211"><span class='Ref_to_Member'>amendscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/gistscan.h.html#LN21"><span class='Ref_to_Proto'>gistendscan</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN212"><span class='Ref_to_Member'>ammarkpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN213"><span class='Ref_to_Member'>amrestrpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN216"><span class='Ref_to_Member'>amestimateparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN217"><span class='Ref_to_Member'>aminitparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN218"><span class='Ref_to_Member'>amparallelrescan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN58"><span class='Ref_To_Local'>amroutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gisthandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create and return a temporary memory context for use by GiST. We 
 * _always_ invoke user-provided methods in a temporary memory 
 * context, so that memory leaks in those functions cannot cause 
 * problems. Also, we use some additional temporary contexts in the 
 * GiST code itself, to avoid the need to do some awkward manual 
 * memory management. 
 */ 
</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> 
<a name="LN109"></a><span class='Declare_Function'>createTempGistContext</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                 <span class='String'>"GiST temporary context"</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  gistbuildempty() -- build an empty gist index in the initialization fork 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN120"></a><span class='Declare_Function'>gistbuildempty</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN122"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the root page */ 
</span>    <a href="gist.c.html#LN122"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN120"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN122"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize and xlog buffer */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gist_private.h.html#LN466"><span class='Ref_to_Proto'>GISTInitBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN122"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN41"><span class='Ref_to_Const'>F_LEAF</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN122"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN56"><span class='Ref_to_Proto'>log_newpage_buffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN122"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Unlock and release the buffer */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN122"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  gistinsert -- wrapper for GiST tuple insertion. 
 * 
 *    This is the public interface routine for tuple insertion in GiSTs. 
 *    It doesn't do any work; just locks the relation and passes the buck. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN146"></a><span class='Declare_Function'>gistinsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN147"></a>           <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ht_ctid</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, 
</span><a name="LN148"></a>           <a href="../../../include/access/genam.h.html#LN110"><span class='Ref_to_Enum'>IndexUniqueCheck</span></a> <span class='Declare_Parameter'>checkUnique</span><span class='Delimiter'>, 
</span><a name="LN149"></a>           <a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN151"></a>    <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>giststate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gist.c.html#LN149"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a><span class='Delimiter'>; 
</span><a name="LN152"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN153"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldCxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize GISTSTATE cache if first call in this statement */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN153"><span class='Ref_To_Local'>oldCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN149"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN150"><span class='Ref_to_Member'>ii_Context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN386"><span class='Ref_to_Proto'>initGISTstate</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN146"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN108"><span class='Ref_to_Func'>createTempGistContext</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN149"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN153"><span class='Ref_To_Local'>oldCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gist.c.html#LN153"><span class='Ref_To_Local'>oldCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN152"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN459"><span class='Ref_to_Proto'>gistFormTuple</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN146"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, 
</span>                         <a href="gist.c.html#LN146"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN146"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>true </span><span class='Comment_Multi_Line'>/* size is currently bogus */ </span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN152"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a> <span class='Operator'>= *</span><a href="gist.c.html#LN147"><span class='Ref_to_Parameter'>ht_ctid</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gist_private.h.html#LN388"><span class='Ref_to_Proto'>gistdoinsert</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN146"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN152"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* cleanup */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN153"><span class='Ref_To_Local'>oldCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN151"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistinsert &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Place tuples from 'itup' to 'buffer'. If 'oldoffnum' is valid, the tuple 
 * at that offset is atomically removed along with inserting the new tuples. 
 * This is used to replace a tuple with a new one. 
 * 
 * If 'leftchildbuf' is valid, we're inserting the downlink for the page 
 * to the right of 'leftchildbuf', or updating the downlink for 'leftchildbuf'. 
 * F_FOLLOW_RIGHT flag on 'leftchildbuf' is cleared and NSN is set. 
 * 
 * If 'markfollowright' is true and the page is split, the left child is 
 * marked with F_FOLLOW_RIGHT flag. That is the normal case. During buffered 
 * index build, however, there is no concurrent access and the page splitting 
 * is done in a slightly simpler fashion, and false is passed. 
 * 
 * If there is not enough room on the page, it is split. All the split 
 * pages are kept pinned and locked and returned in *splitinfo, the caller 
 * is responsible for inserting the downlinks for them. However, if 
 * 'buffer' is the root page and it needs to be split, gistplacetopage() 
 * performs the split as one atomic operation, and *splitinfo is set to NIL. 
 * In that case, we continue to hold the root page locked, and the child 
 * pages are released; note that new tuple(s) are *not* on the root page 
 * but in one of the new child pages. 
 * 
 * If 'newblkno' is not NULL, returns the block number of page the first 
 * new/updated tuple was inserted to. Usually it's the given page, but could 
 * be its right sibling if the page was split. 
 * 
 * Returns 'true' if the page was split, 'false' otherwise. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN211"></a><span class='Declare_Function'>gistplacetopage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>freespace</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, 
</span><a name="LN212"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN213"></a>                <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntup</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Delimiter'>, 
</span><a name="LN214"></a>                <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newblkno</span><span class='Delimiter'>, 
</span><a name="LN215"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>leftchildbuf</span><span class='Delimiter'>, 
</span><a name="LN216"></a>                <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>splitinfo</span><span class='Delimiter'>, 
</span><a name="LN217"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>markfollowright</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN219"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN220"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN221"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_leaf</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><span class='Boolean'>true </span><span class='Operator'>: </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN222"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN223"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN224"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_split</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Refuse to modify a page that's incompletely split. This should not 
     * happen because we finish any incomplete splits while we walk down the 
     * tree. However, it's remotely possible that another concurrent inserter 
     * splits a parent page, and errors out before completing the split. We 
     * will just throw an error in that case, and leave any split we had in 
     * progress unfinished too. The next insert that comes along will clean up 
     * the mess. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"concurrent GiST page split was incomplete"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="gist.c.html#LN216"><span class='Ref_to_Parameter'>splitinfo</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * if isupdate, remove old key: This node's key has been modified, either 
     * because a child split occurred or because we needed to adjust our key 
     * for an insert in a child node. Therefore, remove the old version of 
     * this node's key. 
     * 
     * for WAL replay, in the non-split case we handle this by setting up a 
     * one-element todelete array; in the split case, it's handled implicitly 
     * because the tuple vector passed to gistSplit won't include this tuple. 
     */ 
</span>    <a href="gist.c.html#LN224"><span class='Ref_To_Local'>is_split</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN56"><span class='Ref_to_Func'>gistnospace</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If leaf page is full, try at first to delete dead tuples. And then 
     * check again. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN224"><span class='Ref_To_Local'>is_split</span></a> <span class='Operator'>&& </span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/gist.h.html#LN142"><span class='Ref_to_Macro'>GistPageHasGarbage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN38"><span class='Ref_to_Proto'>gistvacuumpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN224"><span class='Ref_To_Local'>is_split</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN56"><span class='Ref_to_Func'>gistnospace</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN224"><span class='Ref_To_Local'>is_split</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* no space for insertion */ 
</span><a name="LN265"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>itvec</span><span class='Delimiter'>; 
</span><a name="LN266"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>tlen</span><span class='Delimiter'>; 
</span><a name="LN267"></a>        <a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dist</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN268"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN269"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>oldrlink</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span><a name="LN270"></a>        <a href="../../../include/access/gist.h.html#LN49"><span class='Ref_to_Typedef'>GistNSN</span></a>     <span class='Declare_Local'>oldnsn</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN271"></a>        <a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a> <span class='Declare_Local'>rootpg</span><span class='Delimiter'>; 
</span><a name="LN272"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_rootsplit</span><span class='Delimiter'>; 
</span><a name="LN273"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>npage</span><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN272"><span class='Ref_To_Local'>is_rootsplit</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gist.c.html#LN219"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form index tuples vector to split. If we're replacing an old tuple, 
         * remove the old version from the vector. 
         */ 
</span>        <a href="gist.c.html#LN265"><span class='Ref_To_Local'>itvec</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN92"><span class='Ref_to_Func'>gistextractpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gist.c.html#LN266"><span class='Ref_To_Local'>tlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN39"><span class='Ref_to_Macro'>OffsetNumberIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* on inner page we should remove old tuple */ 
</span><a name="LN285"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>pos</span> <span class='Operator'>= </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a> <span class='Operator'>- </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN266"><span class='Ref_To_Local'>tlen</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN285"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>!= </span><a href="gist.c.html#LN266"><span class='Ref_To_Local'>tlen</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN265"><span class='Ref_To_Local'>itvec</span></a> <span class='Operator'>+ </span><a href="gist.c.html#LN285"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN265"><span class='Ref_To_Local'>itvec</span></a> <span class='Operator'>+ </span><a href="gist.c.html#LN285"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="gist.c.html#LN266"><span class='Ref_To_Local'>tlen</span></a> <span class='Operator'>- </span><a href="gist.c.html#LN285"><span class='Ref_To_Local'>pos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="gist.c.html#LN265"><span class='Ref_To_Local'>itvec</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN111"><span class='Ref_to_Func'>gistjoinvector</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN265"><span class='Ref_To_Local'>itvec</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gist.c.html#LN266"><span class='Ref_To_Local'>tlen</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN408"><span class='Ref_to_Proto'>gistSplit</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN265"><span class='Ref_To_Local'>itvec</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN266"><span class='Ref_To_Local'>tlen</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check that split didn't produce too many pages. 
         */ 
</span>        <a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* in a root split, we'll add one more page to the list below */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN272"><span class='Ref_To_Local'>is_rootsplit</span></a><span class='Parentheses'>) 
</span>            <a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/gist_private.h.html#LN39"><span class='Ref_to_Const'>GIST_MAX_SPLIT_PAGES</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"GiST page split into too many halves (%d, maximum %d)"</span><span class='Delimiter'>, 
</span>                 <a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN39"><span class='Ref_to_Const'>GIST_MAX_SPLIT_PAGES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Set up pages to work with. Allocate new buffers for all but the 
         * leftmost page. The original page becomes the new leftmost page, and 
         * is just replaced with the new contents. 
         * 
         * For a root-split, allocate new buffers for all child pages, the 
         * original page is overwritten with new root page containing 
         * downlinks to the new child pages. 
         */ 
</span>        <a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gist.c.html#LN272"><span class='Ref_To_Local'>is_rootsplit</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* save old rightlink and NSN */ 
</span>            <a href="gist.c.html#LN269"><span class='Ref_To_Local'>oldrlink</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN270"><span class='Ref_To_Local'>oldnsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN150"><span class='Ref_to_Macro'>GistPageGetNSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../storage/page/bufpage.c.html#LN383"><span class='Ref_to_Func'>PageGetTempPageCopySpecial</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* clean all flags except F_LEAF */ 
</span>            <a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gist.c.html#LN221"><span class='Ref_To_Local'>is_leaf</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../../include/access/gist.h.html#LN41"><span class='Ref_to_Const'>F_LEAF</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Allocate new page */ 
</span>            <a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN444"><span class='Ref_to_Proto'>gistNewBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gist_private.h.html#LN466"><span class='Ref_to_Proto'>GISTInitBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="gist.c.html#LN221"><span class='Ref_To_Local'>is_leaf</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../../include/access/gist.h.html#LN41"><span class='Ref_to_Const'>F_LEAF</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now that we know which blocks the new pages go to, set up downlink 
         * tuples to point to them. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/itemptr.h.html#LN114"><span class='Ref_to_Macro'>ItemPointerSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gist_private.h.html#LN275"><span class='Ref_to_Macro'>GistTupleSetValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is a root split, we construct the new root page with the 
         * downlinks here directly, instead of requiring the caller to insert 
         * them. Add the new root page to the list along with the child pages. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN272"><span class='Ref_To_Local'>is_rootsplit</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN358"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>downlinks</span><span class='Delimiter'>; 
</span><a name="LN359"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>ndownlinks</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN360"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../storage/page/bufpage.c.html#LN383"><span class='Ref_to_Func'>PageGetTempPageCopySpecial</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>flags <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Prepare a vector of all the downlinks */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>                <a href="gist.c.html#LN359"><span class='Ref_To_Local'>ndownlinks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN358"><span class='Ref_To_Local'>downlinks</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="gist.c.html#LN359"><span class='Ref_To_Local'>ndownlinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN360"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>                <a href="gist.c.html#LN358"><span class='Ref_To_Local'>downlinks</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN360"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN182"><span class='Ref_to_Member'>num</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN359"><span class='Ref_To_Local'>ndownlinks</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN189"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN124"><span class='Ref_to_Func'>gistfillitupvec</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN358"><span class='Ref_To_Local'>downlinks</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN359"><span class='Ref_To_Local'>ndownlinks</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN190"><span class='Ref_to_Member'>lenlist</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a> <span class='Operator'>= &</span><a href="gist.c.html#LN271"><span class='Ref_To_Local'>rootpg</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if is_rootsplit &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Prepare split-info to be returned to caller */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN387"></a>                <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>si</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="gist.c.html#LN387"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN387"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="gist.c.html#LN216"><span class='Ref_to_Parameter'>splitinfo</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gist.c.html#LN216"><span class='Ref_to_Parameter'>splitinfo</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN387"><span class='Ref_To_Local'>si</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fill all pages. All the pages are new, ie. freshly allocated empty 
         * pages, or a temporary copy of the old page. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN401"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN189"><span class='Ref_to_Member'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN223"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gist.c.html#LN223"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN182"><span class='Ref_to_Member'>num</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN223"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN405"></a>                <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>thistup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="gist.c.html#LN401"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="gist.c.html#LN401"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN405"><span class='Ref_To_Local'>thistup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gist.c.html#LN223"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item to index page in \"%s\""</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If this is the first inserted/updated tuple, let the caller 
                 * know which page it landed on. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN214"><span class='Ref_to_Parameter'>newblkno</span></a> <span class='Operator'>&& </span><a href="../../storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gist.c.html#LN405"><span class='Ref_To_Local'>thistup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>t_tid<span class='Parentheses'>))</span> 
                    <span class='Operator'>*</span><a href="gist.c.html#LN214"><span class='Ref_to_Parameter'>newblkno</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span> 
                <a href="gist.c.html#LN401"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN405"><span class='Ref_To_Local'>thistup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Set up rightlinks */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>&& </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>!= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= 
</span>                    <a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN181"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>= </span><a href="gist.c.html#LN269"><span class='Ref_To_Local'>oldrlink</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Mark the all but the right-most page with the follow-right 
             * flag. It will be cleared as soon as the downlink is inserted 
             * into the parent, but this ensures that if we error out before 
             * that, the index is still consistent. (in buffering build mode, 
             * any error will abort the index build anyway, so this is not 
             * needed.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>&& !</span><a href="gist.c.html#LN272"><span class='Ref_To_Local'>is_rootsplit</span></a> <span class='Operator'>&& </span><a href="gist.c.html#LN217"><span class='Ref_to_Parameter'>markfollowright</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/access/gist.h.html#LN147"><span class='Ref_to_Macro'>GistMarkFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/access/gist.h.html#LN148"><span class='Ref_to_Macro'>GistClearFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Copy the NSN of the original page to all pages. The 
             * F_FOLLOW_RIGHT flags ensure that scans will follow the 
             * rightlinks until the downlinks are inserted. 
             */ 
</span>            <a href="../../../include/access/gist.h.html#LN151"><span class='Ref_to_Macro'>GistPageSetNSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN270"><span class='Ref_To_Local'>oldnsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ptr=dist;ptr;ptr=ptr-... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * gistXLogSplit() needs to WAL log a lot of pages, prepare WAL 
         * insertion for that. NB: The number of pages and data segments 
         * specified here must match the calculations in gistXLogSplit()! 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN44"><span class='Ref_to_Proto'>XLogEnsureRecordSpace</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="gist.c.html#LN273"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Must mark buffers dirty before XLogInsert, even though we'll still 
         * be changing their opaque fields below. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The first page in the chain was a temporary working copy meant to 
         * replace the old page. Copy it over the old page. 
         */ 
</span>        <a href="../../storage/page/bufpage.c.html#LN405"><span class='Ref_to_Func'>PageRestoreTempPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Write the WAL record */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
            <a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="gistxlog.c.html#LN391"><span class='Ref_to_Func'>gistXLogSplit</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN221"><span class='Ref_To_Local'>is_leaf</span></a><span class='Delimiter'>, 
</span>                                   <a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN269"><span class='Ref_To_Local'>oldrlink</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN270"><span class='Ref_To_Local'>oldnsn</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Delimiter'>, 
</span>                                   <a href="gist.c.html#LN217"><span class='Ref_to_Parameter'>markfollowright</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN486"><span class='Ref_to_Proto'>gistGetFakeLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN192"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Return the new child buffers to the caller. 
         * 
         * If this was a root split, we've already inserted the downlink 
         * pointers, in the form of a new root page. Therefore we can release 
         * all the new buffers, and keep just the root page locked. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN272"><span class='Ref_To_Local'>is_rootsplit</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN267"><span class='Ref_To_Local'>dist</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN268"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN193"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if is_split &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Enough space.  We always get here if ntup==0. 
         */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Delete old tuple if any, then insert new tuple(s) if any.  If 
         * possible, use the fast path of PageIndexTupleOverwrite. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN39"><span class='Ref_to_Macro'>OffsetNumberIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* One-for-one replacement, so use PageIndexTupleOverwrite */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN433"><span class='Ref_to_Proto'>PageIndexTupleOverwrite</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><span class='Operator'>*</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item to index page in \"%s\""</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Delete old, then append new tuple(s) to page */ 
</span>                <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gistutil.c.html#LN31"><span class='Ref_to_Func'>gistfillbuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Just append new tuples at the end of the page */ 
</span>            <a href="gistutil.c.html#LN31"><span class='Ref_to_Func'>gistfillbuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN541"></a>            <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>ndeloffs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN542"></a>                        <span class='Declare_Local'>deloffs</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN39"><span class='Ref_to_Macro'>OffsetNumberIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="gist.c.html#LN542"><span class='Ref_To_Local'>deloffs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN541"><span class='Ref_To_Local'>ndeloffs</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN411"><span class='Ref_to_Proto'>gistXLogUpdate</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN212"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, 
</span>                                    <a href="gist.c.html#LN542"><span class='Ref_To_Local'>deloffs</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN541"><span class='Ref_To_Local'>ndeloffs</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN213"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, 
</span>                                    <a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN486"><span class='Ref_to_Proto'>gistGetFakeLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN211"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN220"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN214"><span class='Ref_to_Parameter'>newblkno</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="gist.c.html#LN214"><span class='Ref_to_Parameter'>newblkno</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN219"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we inserted the downlink for a child page, set NSN and clear 
     * F_FOLLOW_RIGHT flag on the left child, so that concurrent scans know to 
     * follow the rightlink if and only if they looked at the parent page 
     * before we inserted the downlink. 
     * 
     * Note that we do this *after* writing the WAL record. That means that 
     * the possible full page image in the WAL record does not include these 
     * changes, and they must be replayed even if the page is restored from 
     * the full page image. There's a chicken-and-egg problem: if we updated 
     * the child pages first, we wouldn't know the recptr of the WAL record 
     * we're about to write. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN581"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>leftpg</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN215"><span class='Ref_to_Parameter'>leftchildbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/gist.h.html#LN151"><span class='Ref_to_Macro'>GistPageSetNSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN581"><span class='Ref_To_Local'>leftpg</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/gist.h.html#LN148"><span class='Ref_to_Macro'>GistClearFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN581"><span class='Ref_To_Local'>leftpg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN581"><span class='Ref_To_Local'>leftpg</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN222"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gist.c.html#LN224"><span class='Ref_To_Local'>is_split</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistplacetopage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Workhouse routine for doing insertion into a GiST index. Note that 
 * this routine assumes it is invoked in a short-lived memory context, 
 * so it does not bother releasing palloc'd allocations. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN600"></a><span class='Declare_Function'>gistdoinsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>freespace</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN602"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span><span class='Delimiter'>; 
</span><a name="LN603"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span><span class='Delimiter'>; 
</span><a name="LN604"></a>    <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Declare_Local'>firststack</span><span class='Delimiter'>; 
</span><a name="LN605"></a>    <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>stack</span><span class='Delimiter'>; 
</span><a name="LN606"></a>    <a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN607"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>xlocked</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN242"><span class='Ref_to_Member'>freespace</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>freespace</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Start from the root */ 
</span>    <a href="gist.c.html#LN604"><span class='Ref_To_Local'>firststack</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN604"><span class='Ref_To_Local'>firststack</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN604"><span class='Ref_To_Local'>firststack</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN604"><span class='Ref_To_Local'>firststack</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= &</span><a href="gist.c.html#LN604"><span class='Ref_To_Local'>firststack</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Walk down along the path of smallest penalty, updating the parent 
     * pointers with the key we're inserting as we go. If we crash in the 
     * middle, the tree is consistent, although the possible parent updates 
     * were a waste. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a><span class='Parentheses'>))</span> 
            <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Be optimistic and grab shared lock first. Swap it for an exclusive 
         * lock later if we need to update the page. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN42"><span class='Ref_to_Const'>GIST_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gist_private.h.html#LN443"><span class='Ref_to_Proto'>gistcheckpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Parentheses'>) </span><span class='Operator'>|| !</span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this page was split but the downlink was never inserted to the 
         * parent because the inserting backend crashed before doing that, fix 
         * that now. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* someone might've completed the split when we unlocked */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="gist.c.html#LN28"><span class='Ref_to_Proto'>gistfixsplit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>!= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a> <span class='Operator'>&& 
</span>            <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/gist.h.html#LN150"><span class='Ref_to_Macro'>GistPageGetNSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Concurrent split detected. There's no guarantee that the 
             * downlink for this page is consistent with the tuple we're 
             * inserting anymore, so go back to parent and rechoose the best 
             * child. 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This is an internal page so continue to walk down the tree. 
             * Find the child node that has the minimum insertion penalty. 
             */ 
</span><a name="LN690"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>childblkno</span><span class='Delimiter'>; 
</span><a name="LN691"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN692"></a>            <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span><a name="LN693"></a>            <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>downlinkoffnum</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN693"><span class='Ref_To_Local'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN370"><span class='Ref_to_Func'>gistchoose</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN602"><span class='Ref_To_Local'>iid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN693"><span class='Ref_To_Local'>downlinkoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN603"><span class='Ref_To_Local'>idxtuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN602"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN690"><span class='Ref_To_Local'>childblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN603"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check that it's not a leftover invalid tuple from pre-9.1 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN274"><span class='Ref_to_Macro'>GistTupleIsInvalid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN603"><span class='Ref_To_Local'>idxtuple</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" contains an inner tuple marked as invalid"</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"This is caused by an incomplete page split at crash recovery before upgrading to PostgreSQL 9.1."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Please REINDEX it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check that the key representing the target child node is 
             * consistent with the key we're inserting. Update it if it's not. 
             */ 
</span>            <a href="gist.c.html#LN691"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN312"><span class='Ref_to_Func'>gistgetadjusted</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN603"><span class='Ref_To_Local'>idxtuple</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN691"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Swap shared lock for an exclusive one. Beware, the page may 
                 * change while we unlock/lock the page... 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* the page was changed while we unlocked it, retry */ 
</span>                        <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Update the tuple. 
                 * 
                 * We still hold the lock after gistinserttuple(), but it 
                 * might have to split the page to make the updated tuple fit. 
                 * In that case the updated tuple might migrate to the other 
                 * half of the split, so we have to go back to the parent and 
                 * descend back to the half that's a better fit for the new 
                 * tuple. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN29"><span class='Ref_to_Proto'>gistinserttuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN691"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, 
</span>                                    <a href="gist.c.html#LN693"><span class='Ref_To_Local'>downlinkoffnum</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * If this was a root split, the root page continues to be 
                     * the parent and the updated tuple went to one of the 
                     * child pages, so we just need to retry from the root 
                     * page. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>!= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if newtup &raquo; </span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* descend to the chosen child */ 
</span>            <a href="gist.c.html#LN692"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN692"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN690"><span class='Ref_To_Local'>childblkno</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN692"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN692"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN693"><span class='Ref_To_Local'>downlinkoffnum</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN692"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !GistPageIsLeaf(stack... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Leaf page. Insert the new key. We've already updated all the 
             * parents on the way down, but we might have to split the page if 
             * it doesn't fit. gistinserthere() will take care of that. 
             */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Swap shared lock for an exclusive one. Be careful, the page may 
             * change while we unlock/lock the page... 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * the only page that can become inner instead of leaf is 
                     * the root page, so for root we should recheck it 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * very rare situation: during unlock/lock index with 
                         * number of pages = 1 was increased 
                         */ 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * we don't need to check root split, because checking 
                     * leaf/inner is enough to recognize split for root 
                     */ 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stack-&GT;blkno==GIST_RO... &raquo; </span> 
                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                         <a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/gist.h.html#LN150"><span class='Ref_to_Macro'>GistPageGetNSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * The page was split while we momentarily unlocked the 
                     * page. Go back to parent. 
                     */ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="gist.c.html#LN607"><span class='Ref_To_Local'>xlocked</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !xlocked &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* now state.stack-&GT;(page, buffer and blkno) points to leaf page */ 
</span> 
            <a href="gist.c.html#LN29"><span class='Ref_to_Proto'>gistinserttuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gist.c.html#LN606"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN600"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Release any pins we might still hold before exiting */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN605"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistdoinsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Traverse the tree to find path from root page to specified "child" block. 
 * 
 * returns a new insertion stack, starting from the parent of "child", up 
 * to the root. *downlinkoffnum is set to the offset of the downlink in the 
 * direct parent of child. 
 * 
 * To prevent deadlocks, this should lock only one page at a time. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>* 
</span><a name="LN853"></a><span class='Declare_Function'>gistFindPath</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>downlinkoffnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN855"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN856"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN857"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN858"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN859"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span><span class='Delimiter'>; 
</span><a name="LN860"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span><span class='Delimiter'>; 
</span><a name="LN861"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>fifo</span><span class='Delimiter'>; 
</span><a name="LN862"></a>    <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>top</span><span class='Delimiter'>, 
</span><a name="LN863"></a>               <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN864"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN138"><span class='Ref_to_Macro'>list_make1</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Get next page to visit */ 
</span>        <a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN853"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN42"><span class='Ref_to_Const'>GIST_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/gist_private.h.html#LN443"><span class='Ref_to_Proto'>gistcheckpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN853"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Because we scan the index top-down, all the rest of the pages 
             * in the queue must be leaf pages as well. 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If F_FOLLOW_RIGHT is set, the page to the right doesn't have a 
         * downlink. This should not normally happen.. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"concurrent GiST page split was incomplete"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>&& </span><a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/gist.h.html#LN150"><span class='Ref_to_Macro'>GistPageGetNSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Comment_Multi_Line'>/* sanity check */ </span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Page was split while we looked elsewhere. We didn't see the 
             * downlink to the right page when we scanned the parent, so add 
             * it to the queue now. 
             * 
             * Put the right page ahead of the queue, so that we visit it 
             * next. That's important, because if this is the lowest internal 
             * level, just above leaves, we might already have queued up some 
             * leaf pages, and we assume that there can't be any non-leaf 
             * pages behind leaf pages. 
             */ 
</span>            <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if top-&GT;parent&&top-&GT;par... &raquo; </span> 
 
        <a href="gist.c.html#LN858"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gist.c.html#LN858"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gist.c.html#LN859"><span class='Ref_To_Local'>iid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN860"><span class='Ref_To_Local'>idxtuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN855"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN859"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN864"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN860"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN864"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="gist.c.html#LN853"><span class='Ref_to_Parameter'>child</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Found it! */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="gist.c.html#LN853"><span class='Ref_to_Parameter'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Append this child to the list of pages to visit later */ 
</span>                <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN864"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN857"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN862"><span class='Ref_To_Local'>top</span></a><span class='Delimiter'>; 
</span> 
                <a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN861"><span class='Ref_To_Local'>fifo</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN863"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=FirstOffsetNumber;i... &raquo; </span> 
 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN856"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while fifo!=NIL &raquo; </span> 
 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find parent of a page in index \"%s\", block %u"</span><span class='Delimiter'>, 
</span>         <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN853"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gist.c.html#LN853"><span class='Ref_to_Parameter'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistFindPath &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Updates the stack so that child-&GT;parent is the correct parent of the 
 * child. child-&GT;parent must be exclusively locked on entry, and will 
 * remain so at exit, but it might not be the same page anymore. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN963"></a><span class='Declare_Function'>gistFindCorrectParent</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>child</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN965"></a>    <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parent</span> <span class='Operator'>= </span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gist_private.h.html#LN443"><span class='Ref_to_Proto'>gistcheckpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* here we don't need to distinguish between split and page update */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a> <span class='Operator'>|| 
</span>        <a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN213"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* parent is changed, look child in right links until found */ 
</span><a name="LN975"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN976"></a>                    <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN977"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span><span class='Delimiter'>; 
</span><a name="LN978"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span><span class='Delimiter'>; 
</span><a name="LN979"></a>        <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gist.c.html#LN976"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN975"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN975"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gist.c.html#LN976"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN975"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN975"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="gist.c.html#LN977"><span class='Ref_To_Local'>iid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN975"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gist.c.html#LN978"><span class='Ref_To_Local'>idxtuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN977"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN978"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* yes!!, found */ 
</span>                    <a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN975"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * End of chain and still didn't find parent. It's a very-very 
                 * rare situation when root splited. 
                 */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gist_private.h.html#LN443"><span class='Ref_to_Proto'>gistcheckpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * awful!!, we need search tree to find parent ... , but before we 
         * should release all old parent 
         */ 
</span> 
        <a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>;</span>    <span class='Comment_Multi_Line'>/* child-&GT;parent already released 
                                         * above */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* ok, find new path */ 
</span>        <a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN852"><span class='Ref_to_Func'>gistFindPath</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* read all buffers as expected by caller */ 
</span>        <span class='Comment_Multi_Line'>/* note we don't lock them or gistcheckpage them here! */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN979"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* install new chain of parents to stack */ 
</span>        <a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN965"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* make recursive call to normal processing */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN962"><span class='Ref_to_Func'>gistFindCorrectParent</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN963"><span class='Ref_to_Parameter'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if child-&GT;downlinkoffnum... &raquo; </span> 
 
    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistFindCorrectParent &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Form a downlink pointer for the page in 'buf'. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> 
<a name="LN1052"></a><span class='Declare_Function'>gistformdownlink</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, 
</span><a name="LN1053"></a>                 <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1055"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1052"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1056"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN1057"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN1058"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>downlink</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN1056"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1055"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1057"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN1057"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT;= </span><a href="gist.c.html#LN1056"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN1057"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1057"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1063"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>ituple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1055"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1055"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1057"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1063"><span class='Ref_To_Local'>ituple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1070"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>newdownlink</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN1070"><span class='Ref_To_Local'>newdownlink</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN312"><span class='Ref_to_Func'>gistgetadjusted</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1052"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1063"><span class='Ref_To_Local'>ituple</span></a><span class='Delimiter'>, 
</span>                                          <a href="gist.c.html#LN1052"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1070"><span class='Ref_To_Local'>newdownlink</span></a><span class='Parentheses'>) 
</span>                <a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1070"><span class='Ref_To_Local'>newdownlink</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page is completely empty, we can't form a meaningful downlink 
     * for it. But we have to insert a downlink for the page. Any key will do, 
     * as long as its consistent with the downlink of parent page, so that we 
     * can legally insert it to the parent. A minimal one that matches as few 
     * scans as possible would be best, to keep scans from doing useless work, 
     * but we don't know how to construct that. So we just use the downlink of 
     * the original page that was split - that's as far from optimal as it can 
     * get but will do.. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1091"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1053"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN962"><span class='Ref_to_Func'>gistFindCorrectParent</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1052"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1053"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1091"><span class='Ref_To_Local'>iid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1053"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1053"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1053"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1091"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1053"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/itemptr.h.html#LN114"><span class='Ref_to_Macro'>ItemPointerSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1052"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gist_private.h.html#LN275"><span class='Ref_to_Macro'>GistTupleSetValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gist.c.html#LN1058"><span class='Ref_To_Local'>downlink</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistformdownlink &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Complete the incomplete split of state-&GT;stack-&GT;page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1112"></a><span class='Declare_Function'>gistfixsplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1114"></a>    <a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Local'>stack</span> <span class='Operator'>= </span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN244"><span class='Ref_to_Member'>stack</span></a><span class='Delimiter'>; 
</span><a name="LN1115"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1116"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1117"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>splitinfo</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"fixing incomplete split in index \"%s\", block %u"</span><span class='Delimiter'>, 
</span>         <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gist.c.html#LN1114"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN205"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1114"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN207"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN39"><span class='Ref_to_Macro'>OffsetNumberIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1114"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN1115"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1114"><span class='Ref_To_Local'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the chain of split pages, following the rightlinks. Construct a 
     * downlink tuple for each page. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1133"></a>        <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>si</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1134"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>downlink</span><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN1116"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1115"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Form the new downlink tuples to insert to parent */ 
</span>        <a href="gist.c.html#LN1134"><span class='Ref_To_Local'>downlink</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1051"><span class='Ref_to_Func'>gistformdownlink</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1115"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1114"><span class='Ref_To_Local'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN1133"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1115"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1133"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1134"><span class='Ref_To_Local'>downlink</span></a><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN1117"><span class='Ref_To_Local'>splitinfo</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1117"><span class='Ref_To_Local'>splitinfo</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1133"><span class='Ref_To_Local'>si</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN146"><span class='Ref_to_Macro'>GistFollowRight</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1116"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* lock next page */ 
</span>            <a href="gist.c.html#LN1115"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1116"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rightlink<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1115"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Insert the downlinks */ 
</span>    <a href="gist.c.html#LN36"><span class='Ref_to_Proto'>gistfinishsplit</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1114"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1112"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1117"><span class='Ref_To_Local'>splitinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistfixsplit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert or replace a tuple in stack-&GT;buffer. If 'oldoffnum' is valid, the 
 * tuple at 'oldoffnum' is replaced, otherwise the tuple is inserted as new. 
 * 'stack' represents the path from the root to the page being updated. 
 * 
 * The caller must hold an exclusive lock on stack-&GT;buffer.  The lock is still 
 * held on return, but the page might not contain the inserted tuple if the 
 * page was split. The function returns true if the page was split, false 
 * otherwise. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1171"></a><span class='Declare_Function'>gistinserttuple</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1172"></a>              <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="gist.c.html#LN31"><span class='Ref_to_Proto'>gistinserttuples</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1171"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1171"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1172"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gist.c.html#LN1172"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="gist.c.html#LN1172"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 * An extended workhorse version of gistinserttuple(). This version allows 
 * inserting multiple tuples, or replacing a single tuple with multiple tuples. 
 * This is used to recursively update the downlinks in the parent when a page 
 * is split. 
 * 
 * If leftchild and rightchild are valid, we're inserting/replacing the 
 * downlink for rightchild, and leftchild is its left sibling. We clear the 
 * F_FOLLOW_RIGHT flag and update NSN on leftchild, atomically with the 
 * insertion of the downlink. 
 * 
 * To avoid holding locks for longer than necessary, when recursing up the 
 * tree to update the parents, the locking is a bit peculiar here. On entry, 
 * the caller must hold an exclusive lock on stack-&GT;buffer, as well as 
 * leftchild and rightchild if given. On return: 
 * 
 *  - Lock on stack-&GT;buffer is released, if 'unlockbuf' is true. The page is 
 *    always kept pinned, however. 
 *  - Lock on 'leftchild' is released, if 'unlockleftchild' is true. The page 
 *    is kept pinned. 
 *  - Lock and pin on 'rightchild' are always released. 
 * 
 * Returns 'true' if the page had to be split. Note that if the page was 
 * split, the inserted/updated tuples might've been inserted to a right 
 * sibling of stack-&GT;buffer instead of stack-&GT;buffer itself. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1205"></a><span class='Declare_Function'>gistinserttuples</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1206"></a>                 <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, 
</span><a name="LN1207"></a>                 <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuples</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntup</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Delimiter'>, 
</span><a name="LN1208"></a>                 <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>leftchild</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>rightchild</span><span class='Delimiter'>, 
</span><a name="LN1209"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>unlockbuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>unlockleftchild</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1211"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>splitinfo</span><span class='Delimiter'>; 
</span><a name="LN1212"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_split</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Insert the tuple(s) to the page, splitting the page if necessary */ 
</span>    <a href="gist.c.html#LN1212"><span class='Ref_To_Local'>is_split</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN210"><span class='Ref_to_Func'>gistplacetopage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1205"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1205"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN242"><span class='Ref_to_Member'>freespace</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1206"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, 
</span>                               <a href="gist.c.html#LN1205"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, 
</span>                               <a href="gist.c.html#LN1207"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1207"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, 
</span>                               <a href="gist.c.html#LN1207"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                               <a href="gist.c.html#LN1208"><span class='Ref_to_Parameter'>leftchild</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="gist.c.html#LN1211"><span class='Ref_To_Local'>splitinfo</span></a><span class='Delimiter'>, 
</span>                               <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before recursing up in case the page was split, release locks on the 
     * child pages. We don't need to keep them locked when updating the 
     * parent. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1208"><span class='Ref_to_Parameter'>rightchild</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1208"><span class='Ref_to_Parameter'>rightchild</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1208"><span class='Ref_to_Parameter'>leftchild</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="gist.c.html#LN1209"><span class='Ref_to_Parameter'>unlockleftchild</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1208"><span class='Ref_to_Parameter'>leftchild</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we had to split, insert/update the downlinks in the parent. If the 
     * caller requested us to release the lock on stack-&GT;buffer, tell 
     * gistfinishsplit() to do that as soon as it's safe to do so. If we 
     * didn't have to split, release it ourselves. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1211"><span class='Ref_To_Local'>splitinfo</span></a><span class='Parentheses'>) 
</span>        <a href="gist.c.html#LN36"><span class='Ref_to_Proto'>gistfinishsplit</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1205"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1205"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1206"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1211"><span class='Ref_To_Local'>splitinfo</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1209"><span class='Ref_to_Parameter'>unlockbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1209"><span class='Ref_to_Parameter'>unlockbuf</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1205"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gist.c.html#LN1212"><span class='Ref_To_Local'>is_split</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistinserttuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Finish an incomplete split by inserting/updating the downlinks in parent 
 * page. 'splitinfo' contains all the child pages involved in the split, 
 * from left-to-right. 
 * 
 * On entry, the caller must hold a lock on stack-&GT;buffer and all the child 
 * pages in 'splitinfo'. If 'unlockbuf' is true, the lock on stack-&GT;buffer is 
 * released on return. The child pages are always unlocked and unpinned. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1257"></a><span class='Declare_Function'>gistfinishsplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN239"><span class='Ref_to_Typedef'>GISTInsertState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN202"><span class='Ref_to_Struct'>GISTInsertStack</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1258"></a>                <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>splitinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>unlockbuf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1260"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN1261"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>reversed</span><span class='Delimiter'>; 
</span><a name="LN1262"></a>    <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>right</span><span class='Delimiter'>; 
</span><a name="LN1263"></a>    <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>left</span><span class='Delimiter'>; 
</span><a name="LN1264"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>tuples</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* A split always contains at least two halves */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1258"><span class='Ref_to_Parameter'>splitinfo</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to insert downlinks for each new page, and update the downlink 
     * for the original (leftmost) page in the split. Begin at the rightmost 
     * page, inserting one downlink at a time until there's only two pages 
     * left. Finally insert the downlink for the last new page and update the 
     * downlink for the original page as one operation. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* for convenience, create a copy of the list in reverse order */ 
</span>    <a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1260"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1258"><span class='Ref_to_Parameter'>splitinfo</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1260"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN962"><span class='Ref_to_Func'>gistFindCorrectParent</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * insert downlinks for the siblings from right to left, until there are 
     * only two siblings left. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN1262"><span class='Ref_To_Local'>right</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1263"><span class='Ref_To_Local'>left</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN115"><span class='Ref_to_Macro'>lsecond</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN31"><span class='Ref_to_Proto'>gistinserttuples</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1258"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="gist.c.html#LN1262"><span class='Ref_To_Local'>right</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                             <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, 
</span>                             <a href="gist.c.html#LN1263"><span class='Ref_To_Local'>left</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1262"><span class='Ref_To_Local'>right</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If the parent page was split, need to relocate the original 
             * parent pointer. 
             */ 
</span>            <a href="gist.c.html#LN962"><span class='Ref_to_Func'>gistFindCorrectParent</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN241"><span class='Ref_to_Member'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* gistinserttuples() released the lock on right-&GT;buf. */ 
</span>        <a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gist.c.html#LN1262"><span class='Ref_To_Local'>right</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN1263"><span class='Ref_To_Local'>left</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN115"><span class='Ref_to_Macro'>lsecond</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1261"><span class='Ref_To_Local'>reversed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Finally insert downlink for the remaining right page and update the 
     * downlink for the original page to not contain the tuples that were 
     * moved to the new pages. 
     */ 
</span>    <a href="gist.c.html#LN1264"><span class='Ref_To_Local'>tuples</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN1263"><span class='Ref_To_Local'>left</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN1264"><span class='Ref_To_Local'>tuples</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN1262"><span class='Ref_To_Local'>right</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN31"><span class='Ref_to_Proto'>gistinserttuples</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN219"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1258"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, 
</span>                     <a href="gist.c.html#LN1264"><span class='Ref_To_Local'>tuples</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                     <a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN216"><span class='Ref_to_Member'>downlinkoffnum</span></a><span class='Delimiter'>, 
</span>                     <a href="gist.c.html#LN1263"><span class='Ref_To_Local'>left</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1262"><span class='Ref_To_Local'>right</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Delimiter'>, 
</span>                     <span class='Boolean'>true</span><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* Unlock parent */ 
</span>                     <a href="gist.c.html#LN1258"><span class='Ref_to_Parameter'>unlockbuf</span></a>  <span class='Comment_Single_Line'>/* Unlock stack-&GT;buffer if caller wants that */ 
</span>        <span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1263"><span class='Ref_To_Local'>left</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a> <span class='Operator'>== </span><a href="gist.c.html#LN1257"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN206"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistfinishsplit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * gistSplit -- split a page in the tree and fill struct 
 * used for XLOG and real writes buffers. Function is recursive, ie 
 * it will split page until keys will fit in every page. 
 */ 
</span><a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a> <span class='Operator'>* 
</span><a name="LN1337"></a><span class='Declare_Function'>gistSplit</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, 
</span><a name="LN1338"></a>          <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN1339"></a>          <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* contains compressed entry */ 
</span><a name="LN1340"></a>          <span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, 
</span><a name="LN1341"></a>          <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1343"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lvectup</span><span class='Delimiter'>, 
</span><a name="LN1344"></a>               <span class='Operator'>*</span><span class='Declare_Local'>rvectup</span><span class='Delimiter'>; 
</span><a name="LN1345"></a>    <a href="../../../include/access/gist_private.h.html#LN223"><span class='Ref_to_Struct'>GistSplitVector</span></a> <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1346"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1347"></a>    <a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a> <span class='Operator'>*</span><span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* this should never recurse very deeply, but better safe than sorry */ 
</span>    <a href="../../../include/miscadmin.h.html#LN275"><span class='Ref_to_Proto'>check_stack_depth</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* there's no point in splitting an empty page */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1340"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a single tuple doesn't fit on a page, no amount of splitting will 
     * help. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1340"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1339"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN431"><span class='Ref_to_Const'>GiSTPageSize</span></a><span class='Delimiter'>, 
</span>                   <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1337"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN229"><span class='Ref_to_Member'>spl_lisnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN233"><span class='Ref_to_Member'>spl_risnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gist_private.h.html#LN497"><span class='Ref_to_Proto'>gistSplitByKey</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1337"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1338"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1339"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1340"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* form left and right vector */ 
</span>    <a href="gist.c.html#LN1343"><span class='Ref_To_Local'>lvectup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="gist.c.html#LN1340"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN1344"><span class='Ref_To_Local'>rvectup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="gist.c.html#LN1340"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN105"><span class='Ref_to_Member'>spl_nleft</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="gist.c.html#LN1343"><span class='Ref_To_Local'>lvectup</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN1339"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN104"><span class='Ref_to_Member'>spl_left</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN110"><span class='Ref_to_Member'>spl_nright</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="gist.c.html#LN1344"><span class='Ref_To_Local'>rvectup</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN1339"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN109"><span class='Ref_to_Member'>spl_right</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* finalize splitting (may need another split) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistutil.c.html#LN76"><span class='Ref_to_Func'>gistfitpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1344"><span class='Ref_To_Local'>rvectup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN110"><span class='Ref_to_Member'>spl_nright</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN408"><span class='Ref_to_Proto'>gistSplit</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1337"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1338"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1344"><span class='Ref_To_Local'>rvectup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN110"><span class='Ref_to_Member'>spl_nright</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN41"><span class='Ref_to_Macro'>ROTATEDIST</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN182"><span class='Ref_to_Member'>num</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN110"><span class='Ref_to_Member'>spl_nright</span></a><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN189"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN124"><span class='Ref_to_Func'>gistfillitupvec</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1344"><span class='Ref_To_Local'>rvectup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN110"><span class='Ref_to_Member'>spl_nright</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN190"><span class='Ref_to_Member'>lenlist</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN459"><span class='Ref_to_Proto'>gistFormTuple</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1337"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN231"><span class='Ref_to_Member'>spl_rattr</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN233"><span class='Ref_to_Member'>spl_risnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistutil.c.html#LN76"><span class='Ref_to_Func'>gistfitpage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1343"><span class='Ref_To_Local'>lvectup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN105"><span class='Ref_to_Member'>spl_nleft</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1395"></a>        <a href="../../../include/access/gist_private.h.html#LN186"><span class='Ref_to_Struct'>SplitedPageLayout</span></a> <span class='Operator'>*</span><span class='Declare_Local'>resptr</span><span class='Delimiter'>, 
</span><a name="LN1396"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>subres</span><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN1395"><span class='Ref_To_Local'>resptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1396"><span class='Ref_To_Local'>subres</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN408"><span class='Ref_to_Proto'>gistSplit</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1337"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1338"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1343"><span class='Ref_To_Local'>lvectup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN105"><span class='Ref_to_Member'>spl_nleft</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* install on list's tail */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1395"><span class='Ref_To_Local'>resptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="gist.c.html#LN1395"><span class='Ref_To_Local'>resptr</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1395"><span class='Ref_To_Local'>resptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
        <a href="gist.c.html#LN1395"><span class='Ref_To_Local'>resptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN195"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1396"><span class='Ref_To_Local'>subres</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gist.c.html#LN41"><span class='Ref_to_Macro'>ROTATEDIST</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN188"><span class='Ref_to_Member'>block</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN182"><span class='Ref_to_Member'>num</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN105"><span class='Ref_to_Member'>spl_nleft</span></a><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN189"><span class='Ref_to_Member'>list</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN124"><span class='Ref_to_Func'>gistfillitupvec</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1343"><span class='Ref_To_Local'>lvectup</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN225"><span class='Ref_to_Member'>splitVector</span></a><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN105"><span class='Ref_to_Member'>spl_nleft</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN190"><span class='Ref_to_Member'>lenlist</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN191"><span class='Ref_to_Member'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN459"><span class='Ref_to_Proto'>gistFormTuple</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1341"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1337"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN227"><span class='Ref_to_Member'>spl_lattr</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1345"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN229"><span class='Ref_to_Member'>spl_lisnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gist.c.html#LN1347"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistSplit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a GISTSTATE and fill it with information about the index 
 */ 
</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>* 
</span><a name="LN1422"></a><span class='Declare_Function'>initGISTstate</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1424"></a>    <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>giststate</span><span class='Delimiter'>; 
</span><a name="LN1425"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>scanCxt</span><span class='Delimiter'>; 
</span><a name="LN1426"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldCxt</span><span class='Delimiter'>; 
</span><a name="LN1427"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* safety check to protect fixed-size arrays in GISTSTATE */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&GT; </span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"numberOfAttributes %d &GT; %d"</span><span class='Delimiter'>, 
</span>             <a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>, </span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create the memory context that will hold the GISTSTATE */ 
</span>    <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                    <span class='String'>"GiST scan context"</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN1426"><span class='Ref_To_Local'>oldCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create and fill in the GISTSTATE */ 
</span>    <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN77"><span class='Ref_to_Member'>scanCxt</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Delimiter'>; 
</span>    <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* caller must change this if needed */ 
</span>    <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN84"><span class='Ref_to_Member'>consistentFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN27"><span class='Ref_to_Const'>GIST_CONSISTENT_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN85"><span class='Ref_to_Member'>unionFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN28"><span class='Ref_to_Const'>GIST_UNION_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN86"><span class='Ref_to_Member'>compressFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN29"><span class='Ref_to_Const'>GIST_COMPRESS_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN87"><span class='Ref_to_Member'>decompressFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN30"><span class='Ref_to_Const'>GIST_DECOMPRESS_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN88"><span class='Ref_to_Member'>penaltyFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN31"><span class='Ref_to_Const'>GIST_PENALTY_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN89"><span class='Ref_to_Member'>picksplitFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN32"><span class='Ref_to_Const'>GIST_PICKSPLIT_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN90"><span class='Ref_to_Member'>equalFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN33"><span class='Ref_to_Const'>GIST_EQUAL_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* opclasses are not required to provide a Distance method */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN172"><span class='Ref_to_Proto'>index_getprocid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN34"><span class='Ref_to_Const'>GIST_DISTANCE_PROC</span></a><span class='Parentheses'>)))</span> 
            <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN91"><span class='Ref_to_Member'>distanceFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN34"><span class='Ref_to_Const'>GIST_DISTANCE_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN91"><span class='Ref_to_Member'>distanceFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* opclasses are not required to provide a Fetch method */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN172"><span class='Ref_to_Proto'>index_getprocid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN35"><span class='Ref_to_Const'>GIST_FETCH_PROC</span></a><span class='Parentheses'>)))</span> 
            <a href="../../../include/fmgr.h.html#LN109"><span class='Ref_to_Proto'>fmgr_info_copy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN92"><span class='Ref_to_Member'>fetchFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN35"><span class='Ref_to_Const'>GIST_FETCH_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="gist.c.html#LN1425"><span class='Ref_To_Local'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN92"><span class='Ref_to_Member'>fetchFn</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the index column has a specified collation, we should honor that 
         * while doing comparisons.  However, we may have a collatable storage 
         * type for a noncollatable indexed data type.  If there's no index 
         * collation then specify default collation in case the support 
         * functions need collation.  This is harmless if the support 
         * functions don't care about collation, so we just do it 
         * unconditionally.  (We could alternatively call get_typcollation, 
         * but that seems like expensive overkill --- there aren't going to be 
         * any cases where a GiST storage type has a nondefault collation.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN1422"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>else</span> 
            <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1427"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;index-&GT;rd_att-&GT;... &raquo; </span> 
 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1426"><span class='Ref_To_Local'>oldCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gist.c.html#LN1424"><span class='Ref_To_Local'>giststate</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initGISTstate &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN1509"></a><span class='Declare_Function'>freeGISTstate</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* It's sufficient to delete the scanCxt */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1509"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN77"><span class='Ref_to_Member'>scanCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * gistvacuumpage() -- try to remove LP_DEAD items from the given page. 
 * Function assumes that buffer is exclusively locked. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1520"></a><span class='Declare_Function'>gistvacuumpage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1522"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>deletable</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN1523"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndeletable</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1524"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN1525"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan over all items to see which ones need to be deleted according to 
     * LP_DEAD flags. 
     */ 
</span>    <a href="gist.c.html#LN1525"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1524"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>         <a href="gist.c.html#LN1524"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="gist.c.html#LN1525"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>         <a href="gist.c.html#LN1524"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1524"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1538"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemId</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1524"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1538"><span class='Ref_To_Local'>itemId</span></a><span class='Parentheses'>))</span> 
            <a href="gist.c.html#LN1522"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>[</span><a href="gist.c.html#LN1523"><span class='Ref_To_Local'>ndeletable</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gist.c.html#LN1524"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gist.c.html#LN1523"><span class='Ref_To_Local'>ndeletable</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN431"><span class='Ref_to_Proto'>PageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1522"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1523"><span class='Ref_To_Local'>ndeletable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Mark the page as not containing any LP_DEAD items.  This is not 
         * certainly true (there might be some that have recently been marked, 
         * but weren't included in our target-item list), but it will almost 
         * always be true and it doesn't seem worth an additional page scan to 
         * check it. Remember that F_HAS_GARBAGE is only a hint anyway. 
         */ 
</span>        <a href="../../../include/access/gist.h.html#LN144"><span class='Ref_to_Macro'>GistClearPageHasGarbage</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1564"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="gist.c.html#LN1564"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN411"><span class='Ref_to_Proto'>gistXLogUpdate</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, 
</span>                                    <a href="gist.c.html#LN1522"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1523"><span class='Ref_To_Local'>ndeletable</span></a><span class='Delimiter'>, 
</span>                                    <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gist.c.html#LN1564"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN486"><span class='Ref_to_Proto'>gistGetFakeLSN</span></a><span class='Parentheses'>(</span><a href="gist.c.html#LN1520"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ndeletable&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Note: if we didn't find any LP_DEAD items, then the page's 
     * F_HAS_GARBAGE hint bit is falsely set.  We do not bother expending a 
     * separate write to clear it, however.  We will clear it when we split 
     * the page. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistvacuumpage &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>