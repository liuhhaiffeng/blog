<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gist\gistbuild.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gist\gistbuild.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * gistbuild.c 
 *    build algorithm for GiST indexes implementation. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/gist/gistbuild.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/gist_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/gistxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/cost.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
<span class='Comment_Multi_Line'>/* Step of index tuples for check whether to switch to buffering build mode */ 
</span><a name="LN31"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BUFFERING_MODE_SWITCH_CHECK_STEP</span> <span class='Number'>256</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Number of tuples to process in the slow way before switching to buffering 
 * mode, when buffering is explicitly turned on. Also, the number of tuples 
 * to process between readjusting the buffer size parameter, while in 
 * buffering mode. 
 */ 
</span><a name="LN39"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BUFFERING_MODE_TUPLE_SIZE_STATS_TARGET</span> <span class='Number'>4096</span> 
 
<span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN43"></a>    <span class='Declare_Enum_Const'>GIST_BUFFERING_DISABLED</span><span class='Delimiter'>,</span>    <span class='Comment_Multi_Line'>/* in regular build mode and aren't going to 
                                 * switch */ 
</span><a name="LN45"></a>    <span class='Declare_Enum_Const'>GIST_BUFFERING_AUTO</span><span class='Delimiter'>,</span>        <span class='Comment_Multi_Line'>/* in regular build mode, but will switch to 
                                 * buffering build mode if the index grows too 
                                 * big */ 
</span><a name="LN48"></a>    <span class='Declare_Enum_Const'>GIST_BUFFERING_STATS</span><span class='Delimiter'>,</span>       <span class='Comment_Multi_Line'>/* gathering statistics of index tuple size 
                                 * before switching to the buffering build 
                                 * mode */ 
</span><a name="LN51"></a>    <span class='Declare_Enum_Const'>GIST_BUFFERING_ACTIVE</span>       <span class='Comment_Single_Line'>/* in buffering build mode */ 
</span><a name="LN52"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>GistBufferingMode</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Working state for gistbuild and its callback */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN57"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>indexrel</span><span class='Delimiter'>; 
</span><a name="LN58"></a>    <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>giststate</span><span class='Delimiter'>; 
</span> 
<a name="LN60"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Member'>indtuples</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* number of tuples indexed */ 
</span><a name="LN61"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Member'>indtuplesSize</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* total size of all indexed tuples */ 
</span> 
<a name="LN63"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>freespace</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* amount of free space to leave on pages */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Extra data structures used during a buffering build. 'gfbb' contains 
     * information related to managing the build buffers. 'parentMap' is a 
     * lookup table of the parent of each internal page. 
     */ 
</span><a name="LN70"></a>    <a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Member'>gfbb</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    <a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>parentMap</span><span class='Delimiter'>; 
</span> 
<a name="LN73"></a>    <a href="gistbuild.c.html#LN41"><span class='Ref_to_Typedef'>GistBufferingMode</span></a> <span class='Declare_Member'>bufferingMode</span><span class='Delimiter'>; 
</span><a name="LN74"></a>}<span class='Auto_Annotations'> &laquo; end {anonGISTBuildState} &raquo; </span> <span class='Declare_Typedef'>GISTBuildState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* prototypes for private functions */ 
</span><a name="LN77"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistInitBuffering</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>calculatePagesPerBuffer</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>levelStep</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistBuildCallback</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN80"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>htup</span><span class='Delimiter'>, 
</span><a name="LN81"></a>                  <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, 
</span><a name="LN82"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN83"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>tupleIsAlive</span><span class='Delimiter'>, 
</span><a name="LN84"></a>                  <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN85"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistBufferingBuildInsert</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, 
</span><a name="LN86"></a>                         <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>gistProcessItup</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN88"></a>                <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>startblkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>startlevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN89"></a><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Prototype'>gistbufferinginserttuples</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, 
</span><a name="LN90"></a>                          <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN91"></a>                          <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntup</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Delimiter'>, 
</span><a name="LN92"></a>                          <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>parentblk</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>downlinkoffnum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN93"></a><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Prototype'>gistBufferingFindCorrectParent</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, 
</span><a name="LN94"></a>                               <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>childblkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN95"></a>                               <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parentblk</span><span class='Delimiter'>, 
</span><a name="LN96"></a>                               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>downlinkoffnum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistProcessEmptyingQueue</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN98"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistEmptyAllBuffers</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN99"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>gistGetMaxLevel</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN101"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistInitParentMap</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN102"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistMemorizeParent</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Delimiter'>, 
</span><a name="LN103"></a>                   <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>parent</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN104"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistMemorizeAllDownlinks</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>parent</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN105"></a><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Prototype'>gistGetParent</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Main entry point to GiST index build. Initially calls insert over and over, 
 * but switches to more efficient buffering build algorithm after a certain 
 * number of tuples (unless buffering mode is disabled). 
 */ 
</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>* 
</span><a name="LN113"></a><span class='Declare_Function'>gistbuild</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heap</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN115"></a>    <a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN116"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>reltuples</span><span class='Delimiter'>; 
</span><a name="LN117"></a>    <a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Declare_Local'>buildstate</span><span class='Delimiter'>; 
</span><a name="LN118"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN119"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN120"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN121"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fillfactor</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN155"><span class='Ref_to_Member'>rd_options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Get buffering mode from the options string */ 
</span><a name="LN127"></a>        <a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN155"><span class='Ref_to_Member'>rd_options</span></a><span class='Delimiter'>; 
</span><a name="LN128"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bufferingMode</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN127"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>+ </span><a href="gistbuild.c.html#LN127"><span class='Ref_To_Local'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN376"><span class='Ref_to_Member'>bufferingModeOffset</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="gistbuild.c.html#LN128"><span class='Ref_To_Local'>bufferingMode</span></a><span class='Delimiter'>, </span><span class='String'>"on"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN48"><span class='Ref_to_EnumConst'>GIST_BUFFERING_STATS</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="gistbuild.c.html#LN128"><span class='Ref_To_Local'>bufferingMode</span></a><span class='Delimiter'>, </span><span class='String'>"off"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN43"><span class='Ref_to_EnumConst'>GIST_BUFFERING_DISABLED</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN45"><span class='Ref_to_EnumConst'>GIST_BUFFERING_AUTO</span></a><span class='Delimiter'>; 
</span> 
        <a href="gistbuild.c.html#LN121"><span class='Ref_To_Local'>fillfactor</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN127"><span class='Ref_To_Local'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN375"><span class='Ref_to_Member'>fillfactor</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * By default, switch to buffering mode when the index grows too large 
         * to fit in cache. 
         */ 
</span>        <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN45"><span class='Ref_to_EnumConst'>GIST_BUFFERING_AUTO</span></a><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN121"><span class='Ref_To_Local'>fillfactor</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN435"><span class='Ref_to_Const'>GIST_DEFAULT_FILLFACTOR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* Calculate target amount of free space to leave on pages */ 
</span>    <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN63"><span class='Ref_to_Member'>freespace</span></a> <span class='Operator'>= </span>BLCKSZ <span class='Operator'>* </span><span class='Parentheses'>(</span><span class='Number'>100</span> <span class='Operator'>- </span><a href="gistbuild.c.html#LN121"><span class='Ref_To_Local'>fillfactor</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We expect to be called exactly once for any index relation. If that's 
     * not the case, big trouble's what we have. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"index \"%s\" already contains data"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* no locking is needed */ 
</span>    <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN386"><span class='Ref_to_Proto'>initGISTstate</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a temporary memory context that is reset once for each tuple 
     * processed.  (Note: we don't bother to make this a child of the 
     * giststate's scanCxt, so we have to delete it separately at the end.) 
     */ 
</span>    <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN108"><span class='Ref_to_Func'>createTempGistContext</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the root page */ 
</span>    <a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN444"><span class='Ref_to_Proto'>gistNewBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN119"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gist_private.h.html#LN466"><span class='Ref_to_Proto'>GISTInitBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN41"><span class='Ref_to_Const'>F_LEAF</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN182"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gistbuild.c.html#LN182"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_GIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/gistxlog.h.html#LN23"><span class='Ref_to_Const'>XLOG_GIST_CREATE_INDEX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN119"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN182"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN119"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN486"><span class='Ref_to_Proto'>gistGetFakeLSN</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>heap</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN118"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* build the index */ 
</span>    <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN61"><span class='Ref_to_Member'>indtuplesSize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the heap scan. 
     */ 
</span>    <a href="gistbuild.c.html#LN116"><span class='Ref_To_Local'>reltuples</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN97"><span class='Ref_to_Proto'>IndexBuildHeapScan</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN113"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                   <a href="gistbuild.c.html#LN79"><span class='Ref_to_Proto'>gistBuildCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If buffering was used, flush out all the tuples that are still in the 
     * buffers. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>== </span><a href="gistbuild.c.html#LN51"><span class='Ref_to_EnumConst'>GIST_BUFFERING_ACTIVE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"all tuples processed, emptying buffers"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN98"><span class='Ref_to_Proto'>gistEmptyAllBuffers</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN509"><span class='Ref_to_Func'>gistFreeBuildBuffers</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* okay, all heap tuples are indexed */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN120"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gist_private.h.html#LN387"><span class='Ref_to_Proto'>freeGISTstate</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return statistics 
     */ 
</span>    <a href="gistbuild.c.html#LN115"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN115"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN31"><span class='Ref_to_Member'>heap_tuples</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN116"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN115"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN32"><span class='Ref_to_Member'>index_tuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN117"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gistbuild.c.html#LN115"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistbuild &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Validator for "buffering" reloption on GiST indexes. Allows "on", "off" 
 * and "auto" values. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN240"></a><span class='Declare_Function'>gistValidateBufferingOption</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>value</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>value </span><span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='String'>"on"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>         strcmp<span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='String'>"off"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>         strcmp<span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='String'>"auto"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid value for \"buffering\" option"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Valid values are \"on\", \"off\", and \"auto\"."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Attempt to switch to buffering mode. 
 * 
 * If there is not enough memory for buffering build, sets bufferingMode 
 * to GIST_BUFFERING_DISABLED, so that we don't bother to try the switch 
 * anymore. Otherwise initializes the build buffers, and sets bufferingMode to 
 * GIST_BUFFERING_ACTIVE. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN263"></a><span class='Declare_Function'>gistInitBuffering</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN265"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>index</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>; 
</span><a name="LN266"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pagesPerBuffer</span><span class='Delimiter'>; 
</span><a name="LN267"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageFreeSpace</span><span class='Delimiter'>; 
</span><a name="LN268"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itupAvgSize</span><span class='Delimiter'>, 
</span><a name="LN269"></a>                <span class='Declare_Local'>itupMinSize</span><span class='Delimiter'>; 
</span><a name="LN270"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>avgIndexTuplesPerPage</span><span class='Delimiter'>, 
</span><a name="LN271"></a>                <span class='Declare_Local'>maxIndexTuplesPerPage</span><span class='Delimiter'>; 
</span><a name="LN272"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN273"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>levelStep</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Calc space of index page which is available for index tuples */ 
</span>    <a href="gistbuild.c.html#LN267"><span class='Ref_To_Local'>pageFreeSpace</span></a> <span class='Operator'>= </span>BLCKSZ <span class='Operator'>- </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN57"><span class='Ref_to_Struct'>GISTPageOpaqueData</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>- </span><a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN63"><span class='Ref_to_Member'>freespace</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate average size of already inserted index tuples using gathered 
     * statistics. 
     */ 
</span>    <a href="gistbuild.c.html#LN268"><span class='Ref_To_Local'>itupAvgSize</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN61"><span class='Ref_to_Member'>indtuplesSize</span></a> <span class='Operator'>/ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate minimal possible size of index tuple by index metadata. 
     * Minimal possible size of varlena is VARHDRSZ. 
     * 
     * XXX: that's not actually true, as a short varlen can be just 2 bytes. 
     * And we should take padding into account here. 
     */ 
</span>    <a href="gistbuild.c.html#LN269"><span class='Ref_To_Local'>itupMinSize</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN272"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN272"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistbuild.c.html#LN265"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN272"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN265"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN272"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="gistbuild.c.html#LN269"><span class='Ref_To_Local'>itupMinSize</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="gistbuild.c.html#LN269"><span class='Ref_To_Local'>itupMinSize</span></a> <span class='Operator'>+= </span><a href="gistbuild.c.html#LN265"><span class='Ref_To_Local'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN272"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Calculate average and maximal number of index tuples which fit to page */ 
</span>    <a href="gistbuild.c.html#LN270"><span class='Ref_To_Local'>avgIndexTuplesPerPage</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN267"><span class='Ref_To_Local'>pageFreeSpace</span></a> <span class='Operator'>/ </span><a href="gistbuild.c.html#LN268"><span class='Ref_To_Local'>itupAvgSize</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN271"><span class='Ref_To_Local'>maxIndexTuplesPerPage</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN267"><span class='Ref_To_Local'>pageFreeSpace</span></a> <span class='Operator'>/ </span><a href="gistbuild.c.html#LN269"><span class='Ref_To_Local'>itupMinSize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to calculate two parameters for the buffering algorithm: 
     * levelStep and pagesPerBuffer. 
     * 
     * levelStep determines the size of subtree that we operate on, while 
     * emptying a buffer. A higher value is better, as you need fewer buffer 
     * emptying steps to build the index. However, if you set it too high, the 
     * subtree doesn't fit in cache anymore, and you quickly lose the benefit 
     * of the buffers. 
     * 
     * In Arge et al's paper, levelStep is chosen as logB(M/4B), where B is 
     * the number of tuples on page (ie. fanout), and M is the amount of 
     * internal memory available. Curiously, they doesn't explain *why* that 
     * setting is optimal. We calculate it by taking the highest levelStep so 
     * that a subtree still fits in cache. For a small B, our way of 
     * calculating levelStep is very close to Arge et al's formula. For a 
     * large B, our formula gives a value that is 2x higher. 
     * 
     * The average size (in pages) of a subtree of depth n can be calculated 
     * as a geometric series: 
     * 
     * B^0 + B^1 + B^2 + ... + B^n = (1 - B^(n + 1)) / (1 - B) 
     * 
     * where B is the average number of index tuples on page. The subtree is 
     * cached in the shared buffer cache and the OS cache, so we choose 
     * levelStep so that the subtree size is comfortably smaller than 
     * effective_cache_size, with a safety factor of 4. 
     * 
     * The estimate on the average number of index tuples on page is based on 
     * average tuple sizes observed before switching to buffered build, so the 
     * real subtree size can be somewhat larger. Also, it would selfish to 
     * gobble the whole cache for our index build. The safety factor of 4 
     * should account for those effects. 
     * 
     * The other limiting factor for setting levelStep is that while 
     * processing a subtree, we need to hold one page for each buffer at the 
     * next lower buffered level. The max. number of buffers needed for that 
     * is maxIndexTuplesPerPage^levelStep. This is very conservative, but 
     * hopefully maintenance_work_mem is set high enough that you're 
     * constrained by effective_cache_size rather than maintenance_work_mem. 
     * 
     * XXX: the buffer hash table consumes a fair amount of memory too per 
     * buffer, but that is not currently taken into account. That scales on 
     * the total number of buffers used, ie. the index size and on levelStep. 
     * Note that a higher levelStep *reduces* the amount of memory needed for 
     * the hash table. 
     */ 
</span>    <a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN357"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>subtreesize</span><span class='Delimiter'>; 
</span><a name="LN358"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>maxlowestlevelpages</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* size of an average subtree at this levelStep (in pages). */ 
</span>        <a href="gistbuild.c.html#LN357"><span class='Ref_To_Local'>subtreesize</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>- </span>pow<span class='Parentheses'>(</span><a href="gistbuild.c.html#LN270"><span class='Ref_To_Local'>avgIndexTuplesPerPage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) (</span><a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)))</span> <span class='Operator'>/ 
</span>            <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>- </span><a href="gistbuild.c.html#LN270"><span class='Ref_To_Local'>avgIndexTuplesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* max number of pages at the lowest level of a subtree */ 
</span>        <a href="gistbuild.c.html#LN358"><span class='Ref_To_Local'>maxlowestlevelpages</span></a> <span class='Operator'>= </span>pow<span class='Parentheses'>(</span><a href="gistbuild.c.html#LN271"><span class='Ref_To_Local'>maxIndexTuplesPerPage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* subtree must fit in cache (with safety factor of 4) */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN357"><span class='Ref_To_Local'>subtreesize</span></a> <span class='Operator'>&GT; </span><a href="../../optimizer/path/costsize.c.html#LN111"><span class='Ref_to_Global_Var'>effective_cache_size</span></a> <span class='Operator'>/ </span><span class='Number'>4</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* each node in the lowest level of a subtree has one page in memory */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN358"><span class='Ref_To_Local'>maxlowestlevelpages</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>((</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="../../utils/init/globals.c.html#LN113"><span class='Ref_to_Global_Var'>maintenance_work_mem</span></a> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>)</span> <span class='Operator'>/ </span>BLCKSZ<span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Good, we can handle this levelStep. See if we can go one higher. */ 
</span>        <a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We just reached an unacceptable value of levelStep in previous loop. 
     * So, decrease levelStep to get last acceptable value. 
     */ 
</span>    <a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's not enough cache or maintenance_work_mem, fall back to plain 
     * inserts. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"failed to switch to buffered GiST build"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN43"><span class='Ref_to_EnumConst'>GIST_BUFFERING_DISABLED</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The second parameter to set is pagesPerBuffer, which determines the 
     * size of each buffer. We adjust pagesPerBuffer also during the build, 
     * which is why this calculation is in a separate function. 
     */ 
</span>    <a href="gistbuild.c.html#LN266"><span class='Ref_To_Local'>pagesPerBuffer</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN78"><span class='Ref_to_Proto'>calculatePagesPerBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize GISTBuildBuffers with these parameters */ 
</span>    <a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN46"><span class='Ref_to_Func'>gistInitBuildBuffers</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN266"><span class='Ref_To_Local'>pagesPerBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a><span class='Delimiter'>, 
</span>                                            <a href="gistbuild.c.html#LN99"><span class='Ref_to_Proto'>gistGetMaxLevel</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN265"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN101"><span class='Ref_to_Proto'>gistInitParentMap</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN263"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN51"><span class='Ref_to_EnumConst'>GIST_BUFFERING_ACTIVE</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"switched to buffered GiST build; level step = %d, pagesPerBuffer = %d"</span><span class='Delimiter'>, 
</span>         <a href="gistbuild.c.html#LN273"><span class='Ref_To_Local'>levelStep</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN266"><span class='Ref_To_Local'>pagesPerBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistInitBuffering &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Calculate pagesPerBuffer parameter for the buffering algorithm. 
 * 
 * Buffer size is chosen so that assuming that tuples are distributed 
 * randomly, emptying half a buffer fills on average one page in every buffer 
 * at the next lower level. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN424"></a><span class='Declare_Function'>calculatePagesPerBuffer</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>levelStep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN426"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>pagesPerBuffer</span><span class='Delimiter'>; 
</span><a name="LN427"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>avgIndexTuplesPerPage</span><span class='Delimiter'>; 
</span><a name="LN428"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>itupAvgSize</span><span class='Delimiter'>; 
</span><a name="LN429"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageFreeSpace</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Calc space of index page which is available for index tuples */ 
</span>    <a href="gistbuild.c.html#LN429"><span class='Ref_To_Local'>pageFreeSpace</span></a> <span class='Operator'>= </span>BLCKSZ <span class='Operator'>- </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN57"><span class='Ref_to_Struct'>GISTPageOpaqueData</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>- </span><a href="gistbuild.c.html#LN424"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN63"><span class='Ref_to_Member'>freespace</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate average size of already inserted index tuples using gathered 
     * statistics. 
     */ 
</span>    <a href="gistbuild.c.html#LN428"><span class='Ref_To_Local'>itupAvgSize</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN424"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN61"><span class='Ref_to_Member'>indtuplesSize</span></a> <span class='Operator'>/ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN424"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN427"><span class='Ref_To_Local'>avgIndexTuplesPerPage</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN429"><span class='Ref_To_Local'>pageFreeSpace</span></a> <span class='Operator'>/ </span><a href="gistbuild.c.html#LN428"><span class='Ref_To_Local'>itupAvgSize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recalculate required size of buffers. 
     */ 
</span>    <a href="gistbuild.c.html#LN426"><span class='Ref_To_Local'>pagesPerBuffer</span></a> <span class='Operator'>= </span><span class='Number'>2</span> <span class='Operator'>* </span>pow<span class='Parentheses'>(</span><a href="gistbuild.c.html#LN427"><span class='Ref_To_Local'>avgIndexTuplesPerPage</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN424"><span class='Ref_to_Parameter'>levelStep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../../port/rint.c.html#LN20"><span class='Ref_to_Func'>rint</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN426"><span class='Ref_To_Local'>pagesPerBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end calculatePagesPerBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Per-tuple callback from IndexBuildHeapScan. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN457"></a><span class='Declare_Function'>gistBuildCallback</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN458"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>htup</span><span class='Delimiter'>, 
</span><a name="LN459"></a>                  <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, 
</span><a name="LN460"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN461"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>tupleIsAlive</span><span class='Delimiter'>, 
</span><a name="LN462"></a>                  <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN464"></a>    <a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>buildstate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistbuild.c.html#LN462"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; 
</span><a name="LN465"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN466"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldCtx</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN466"><span class='Ref_To_Local'>oldCtx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* form an index tuple and point it at the heap tuple */ 
</span>    <a href="gistbuild.c.html#LN465"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN459"><span class='Ref_to_Proto'>gistFormTuple</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN457"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN459"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN460"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN465"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN458"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>== </span><a href="gistbuild.c.html#LN51"><span class='Ref_to_EnumConst'>GIST_BUFFERING_ACTIVE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We have buffers, so use them. */ 
</span>        <a href="gistbuild.c.html#LN85"><span class='Ref_to_Proto'>gistBufferingBuildInsert</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN465"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * There's no buffers (yet). Since we already have the index relation 
         * locked, we call gistdoinsert directly. 
         */ 
</span>        <a href="../../../include/access/gist_private.h.html#LN388"><span class='Ref_to_Proto'>gistdoinsert</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN457"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN465"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN63"><span class='Ref_to_Member'>freespace</span></a><span class='Delimiter'>, 
</span>                     <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Update tuple count and total size. */ 
</span>    <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN61"><span class='Ref_to_Member'>indtuplesSize</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN465"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN466"><span class='Ref_To_Local'>oldCtx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>== </span><a href="gistbuild.c.html#LN51"><span class='Ref_to_EnumConst'>GIST_BUFFERING_ACTIVE</span></a> <span class='Operator'>&& 
</span>        <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>% </span><a href="gistbuild.c.html#LN39"><span class='Ref_to_Const'>BUFFERING_MODE_TUPLE_SIZE_STATS_TARGET</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Adjust the target buffer size now */ 
</span>        <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN351"><span class='Ref_to_Member'>pagesPerBuffer</span></a> <span class='Operator'>= 
</span>            <a href="gistbuild.c.html#LN78"><span class='Ref_to_Proto'>calculatePagesPerBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN350"><span class='Ref_to_Member'>levelStep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In 'auto' mode, check if the index has grown too large to fit in cache, 
     * and switch to buffering mode if it has. 
     * 
     * To avoid excessive calls to smgrnblocks(), only check this every 
     * BUFFERING_MODE_SWITCH_CHECK_STEP index tuples 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>== </span><a href="gistbuild.c.html#LN45"><span class='Ref_to_EnumConst'>GIST_BUFFERING_AUTO</span></a> <span class='Operator'>&& 
</span>         <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>% </span><a href="gistbuild.c.html#LN31"><span class='Ref_to_Const'>BUFFERING_MODE_SWITCH_CHECK_STEP</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>         <a href="../../optimizer/path/costsize.c.html#LN111"><span class='Ref_to_Global_Var'>effective_cache_size</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/smgr.h.html#LN104"><span class='Ref_to_Proto'>smgrnblocks</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN457"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN73"><span class='Ref_to_Member'>bufferingMode</span></a> <span class='Operator'>== </span><a href="gistbuild.c.html#LN48"><span class='Ref_to_EnumConst'>GIST_BUFFERING_STATS</span></a> <span class='Operator'>&& 
</span>         <a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN60"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>&GT;= </span><a href="gistbuild.c.html#LN39"><span class='Ref_to_Const'>BUFFERING_MODE_TUPLE_SIZE_STATS_TARGET</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Index doesn't fit in effective cache anymore. Try to switch to 
         * buffering build mode. 
         */ 
</span>        <a href="gistbuild.c.html#LN77"><span class='Ref_to_Proto'>gistInitBuffering</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN464"><span class='Ref_To_Local'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end gistBuildCallback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert function for buffering index build. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN529"></a><span class='Declare_Function'>gistBufferingBuildInsert</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Insert the tuple to buffers. */ 
</span>    <a href="gistbuild.c.html#LN87"><span class='Ref_to_Proto'>gistProcessItup</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN529"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN529"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN529"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN366"><span class='Ref_to_Member'>rootlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we filled up (half of a) buffer, process buffer emptying. */ 
</span>    <a href="gistbuild.c.html#LN97"><span class='Ref_to_Proto'>gistProcessEmptyingQueue</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN529"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Process an index tuple. Runs the tuple down the tree until we reach a leaf 
 * page or node buffer, and inserts the tuple there. Returns true if we have 
 * to stop buffer emptying process (because one of child buffers can't take 
 * index tuples anymore). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN545"></a><span class='Declare_Function'>gistProcessItup</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN546"></a>                <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>startblkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>startlevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN548"></a>    <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>giststate</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Delimiter'>; 
</span><a name="LN549"></a>    <a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Local'>gfbb</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Delimiter'>; 
</span><a name="LN550"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexrel</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>; 
</span><a name="LN551"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>childblkno</span><span class='Delimiter'>; 
</span><a name="LN552"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN554"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN555"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>level</span><span class='Delimiter'>; 
</span><a name="LN556"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>downlinkoffnum</span> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span><a name="LN557"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>parentblkno</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop until we reach a leaf page (level == 0) or a level with buffers 
     * (not including the level we start at, because we would otherwise make 
     * no progress). 
     */ 
</span>    <a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN546"><span class='Ref_to_Parameter'>startblkno</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN546"><span class='Ref_to_Parameter'>startlevel</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN570"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span><span class='Delimiter'>; 
</span><a name="LN571"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span><span class='Delimiter'>, 
</span><a name="LN572"></a>                    <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN573"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN574"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>childoffnum</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Have we reached a level with buffers? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN305"><span class='Ref_to_Macro'>LEVEL_HAS_BUFFERS</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN549"><span class='Ref_To_Local'>gfbb</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>!= </span><a href="gistbuild.c.html#LN546"><span class='Ref_to_Parameter'>startlevel</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Have we reached a leaf page? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Nope. Descend down to the next level then. Choose a child to 
         * descend down to. 
         */ 
</span> 
        <a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN550"><span class='Ref_To_Local'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gistbuild.c.html#LN573"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN574"><span class='Ref_To_Local'>childoffnum</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN370"><span class='Ref_to_Func'>gistchoose</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN550"><span class='Ref_To_Local'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN573"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN548"><span class='Ref_To_Local'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN570"><span class='Ref_To_Local'>iid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN573"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN574"><span class='Ref_To_Local'>childoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN571"><span class='Ref_To_Local'>idxtuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN573"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN570"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN551"><span class='Ref_To_Local'>childblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN571"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="gistbuild.c.html#LN102"><span class='Ref_to_Proto'>gistMemorizeParent</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN551"><span class='Ref_To_Local'>childblkno</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check that the key representing the target child node is consistent 
         * with the key we're inserting. Update it if it's not. 
         */ 
</span>        <a href="gistbuild.c.html#LN572"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN312"><span class='Ref_to_Func'>gistgetadjusted</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN550"><span class='Ref_To_Local'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN571"><span class='Ref_To_Local'>idxtuple</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN548"><span class='Ref_To_Local'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN572"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN89"><span class='Ref_to_Proto'>gistbufferinginserttuples</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, 
</span>                                              <a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, 
</span>                                              <a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="gistbuild.c.html#LN572"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, 
</span>                                              <span class='Number'>1</span><span class='Delimiter'>, 
</span>                                              <a href="gistbuild.c.html#LN574"><span class='Ref_To_Local'>childoffnum</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* gistbufferinginserttuples() released the buffer */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Descend to the child */ 
</span>        <a href="gistbuild.c.html#LN557"><span class='Ref_To_Local'>parentblkno</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN551"><span class='Ref_To_Local'>childblkno</span></a><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN556"><span class='Ref_To_Local'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN574"><span class='Ref_To_Local'>childoffnum</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN305"><span class='Ref_to_Macro'>LEVEL_HAS_BUFFERS</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN549"><span class='Ref_To_Local'>gfbb</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We've reached level with buffers. Place the index tuple to the 
         * buffer, and add the buffer to the emptying queue if it overflows. 
         */ 
</span><a name="LN635"></a>        <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>childNodeBuffer</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find the buffer or create a new one */ 
</span>        <a href="gistbuild.c.html#LN635"><span class='Ref_To_Local'>childNodeBuffer</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN116"><span class='Ref_to_Func'>gistGetNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN549"><span class='Ref_To_Local'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN548"><span class='Ref_To_Local'>giststate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Add index tuple to it */ 
</span>        <a href="gistbuildbuffers.c.html#LN338"><span class='Ref_to_Func'>gistPushItupToNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN549"><span class='Ref_To_Local'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN635"><span class='Ref_To_Local'>childNodeBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN318"><span class='Ref_to_Macro'>BUFFER_OVERFLOWED</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN635"><span class='Ref_To_Local'>childNodeBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN549"><span class='Ref_To_Local'>gfbb</span></a><span class='Parentheses'>))</span> 
            <a href="gistbuild.c.html#LN553"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We've reached a leaf page. Place the tuple here. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN550"><span class='Ref_To_Local'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN554"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN89"><span class='Ref_to_Proto'>gistbufferinginserttuples</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN552"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN555"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="gistbuild.c.html#LN545"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, 
</span>                                  <a href="gistbuild.c.html#LN557"><span class='Ref_To_Local'>parentblkno</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN556"><span class='Ref_To_Local'>downlinkoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* gistbufferinginserttuples() released the buffer */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gistbuild.c.html#LN553"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistProcessItup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert tuples to a given page. 
 * 
 * This is analogous with gistinserttuples() in the regular insertion code. 
 * 
 * Returns the block number of the page where the (first) new or updated tuple 
 * was inserted. Usually that's the original page, but might be a sibling page 
 * if the original page was split. 
 * 
 * Caller should hold a lock on 'buffer' on entry. This function will unlock 
 * and unpin it. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN676"></a><span class='Declare_Function'>gistbufferinginserttuples</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN677"></a>                          <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntup</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>oldoffnum</span><span class='Delimiter'>, 
</span><a name="LN678"></a>                          <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>parentblk</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>downlinkoffnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN680"></a>    <a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Local'>gfbb</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Delimiter'>; 
</span><a name="LN681"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>splitinfo</span><span class='Delimiter'>; 
</span><a name="LN682"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_split</span><span class='Delimiter'>; 
</span><a name="LN683"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>placed_to_blk</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN682"><span class='Ref_To_Local'>is_split</span></a> <span class='Operator'>= </span><a href="gist.c.html#LN210"><span class='Ref_to_Func'>gistplacetopage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>, 
</span>                               <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN63"><span class='Ref_to_Member'>freespace</span></a><span class='Delimiter'>, 
</span>                               <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Delimiter'>, 
</span>                               <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, 
</span>                               <a href="gistbuild.c.html#LN677"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN677"><span class='Ref_to_Parameter'>ntup</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN677"><span class='Ref_to_Parameter'>oldoffnum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistbuild.c.html#LN683"><span class='Ref_To_Local'>placed_to_blk</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="gistbuild.c.html#LN681"><span class='Ref_To_Local'>splitinfo</span></a><span class='Delimiter'>, 
</span>                               <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is a root split, update the root path item kept in memory. This 
     * ensures that all path stacks are always complete, including all parent 
     * nodes up to the root. That simplifies the algorithm to re-find correct 
     * parent. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN682"><span class='Ref_To_Local'>is_split</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN702"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN703"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN704"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>== </span><a href="gistbuild.c.html#LN680"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN366"><span class='Ref_to_Member'>rootlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN680"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN366"><span class='Ref_to_Member'>rootlevel</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"splitting GiST root page, now %d levels deep"</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN680"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN366"><span class='Ref_to_Member'>rootlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * All the downlinks on the old root page are now on one of the child 
         * pages. Visit all the new child pages to memorize the parents of the 
         * grandchildren. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN680"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN366"><span class='Ref_to_Member'>rootlevel</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gistbuild.c.html#LN704"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN702"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN703"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN703"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="gistbuild.c.html#LN704"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN703"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN721"></a>                <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN702"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN703"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN722"></a>                <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN702"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN721"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN723"></a>                <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>childblkno</span> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN722"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN724"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>childbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN723"><span class='Ref_To_Local'>childblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN724"><span class='Ref_To_Local'>childbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN42"><span class='Ref_to_Const'>GIST_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="gistbuild.c.html#LN104"><span class='Ref_to_Proto'>gistMemorizeAllDownlinks</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN724"><span class='Ref_To_Local'>childbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN724"><span class='Ref_To_Local'>childbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Also remember that the parent of the new child page is the 
                 * root block. 
                 */ 
</span>                <a href="gistbuild.c.html#LN102"><span class='Ref_to_Proto'>gistMemorizeParent</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN723"><span class='Ref_To_Local'>childblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if gfbb-&GT;rootlevel&GT;1 &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if is_split&&BufferGetBl... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN681"><span class='Ref_To_Local'>splitinfo</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Insert the downlinks to the parent. This is analogous with 
         * gistfinishsplit() in the regular insertion code, but the locking is 
         * simpler, and we have to maintain the buffers on internal nodes and 
         * the parent map. 
         */ 
</span><a name="LN747"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>downlinks</span><span class='Delimiter'>; 
</span><a name="LN748"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ndownlinks</span><span class='Delimiter'>, 
</span><a name="LN749"></a>                    <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN750"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>parentBuffer</span><span class='Delimiter'>; 
</span><a name="LN751"></a>        <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Parent may have changed since we memorized this path. */ 
</span>        <a href="gistbuild.c.html#LN750"><span class='Ref_To_Local'>parentBuffer</span></a> <span class='Operator'>= 
</span>            <a href="gistbuild.c.html#LN93"><span class='Ref_to_Proto'>gistBufferingFindCorrectParent</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                           <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="gistbuild.c.html#LN678"><span class='Ref_to_Parameter'>parentblk</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="gistbuild.c.html#LN678"><span class='Ref_to_Parameter'>downlinkoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If there's a buffer associated with this page, that needs to be 
         * split too. gistRelocateBuildBuffersOnSplit() will also adjust the 
         * downlinks in 'splitinfo', to make sure they're consistent not only 
         * with the tuples already on the pages, but also the tuples in the 
         * buffers that will eventually be inserted to them. 
         */ 
</span>        <a href="../../../include/access/gist_private.h.html#LN518"><span class='Ref_to_Proto'>gistRelocateBuildBuffersOnSplit</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN680"><span class='Ref_To_Local'>gfbb</span></a><span class='Delimiter'>, 
</span>                                        <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Delimiter'>, 
</span>                                        <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>, 
</span>                                        <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>, 
</span>                                        <a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN681"><span class='Ref_To_Local'>splitinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create an array of all the downlink tuples */ 
</span>        <a href="gistbuild.c.html#LN748"><span class='Ref_To_Local'>ndownlinks</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN681"><span class='Ref_To_Local'>splitinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN747"><span class='Ref_To_Local'>downlinks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="gistbuild.c.html#LN748"><span class='Ref_To_Local'>ndownlinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN749"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN751"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN681"><span class='Ref_To_Local'>splitinfo</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN780"></a>            <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>splitinfo</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN751"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Remember the parent of each new child page in our parent map. 
             * This assumes that the downlinks fit on the parent page. If the 
             * parent page is split, too, when we recurse up to insert the 
             * downlinks, the recursive gistbufferinginserttuples() call will 
             * update the map again. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="gistbuild.c.html#LN102"><span class='Ref_to_Proto'>gistMemorizeParent</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN780"><span class='Ref_To_Local'>splitinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN750"><span class='Ref_To_Local'>parentBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Also update the parent map for all the downlinks that got moved 
             * to a different page. (actually this also loops through the 
             * downlinks that stayed on the original page, but it does no 
             * harm). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="gistbuild.c.html#LN104"><span class='Ref_to_Proto'>gistMemorizeAllDownlinks</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN780"><span class='Ref_To_Local'>splitinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Since there's no concurrent access, we can release the lower 
             * level buffers immediately. This includes the original page. 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN780"><span class='Ref_To_Local'>splitinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gistbuild.c.html#LN747"><span class='Ref_To_Local'>downlinks</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN749"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistbuild.c.html#LN780"><span class='Ref_To_Local'>splitinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Insert them into parent. */ 
</span>        <a href="gistbuild.c.html#LN89"><span class='Ref_to_Proto'>gistbufferinginserttuples</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN750"><span class='Ref_To_Local'>parentBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                  <a href="gistbuild.c.html#LN747"><span class='Ref_To_Local'>downlinks</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN748"><span class='Ref_To_Local'>ndownlinks</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN678"><span class='Ref_to_Parameter'>downlinkoffnum</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/nodes/pg_list.h.html#LN266"><span class='Ref_to_Proto'>list_free_deep</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN681"><span class='Ref_To_Local'>splitinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* we don't need this anymore */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if splitinfo &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN676"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gistbuild.c.html#LN683"><span class='Ref_To_Local'>placed_to_blk</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistbufferinginserttuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find the downlink pointing to a child page. 
 * 
 * 'childblkno' indicates the child page to find the parent for. 'level' is 
 * the level of the child. On entry, *parentblkno and *downlinkoffnum can 
 * point to a location where the downlink used to be - we will check that 
 * location first, and save some cycles if it hasn't moved. The function 
 * returns a buffer containing the downlink, exclusively-locked, and 
 * *parentblkno and *downlinkoffnum are set to the real location of the 
 * downlink. 
 * 
 * If the child page is a leaf (level == 0), the caller must supply a correct 
 * parentblkno. Otherwise we use the parent map hash table to find the parent 
 * block. 
 * 
 * This function serves the same purpose as gistFindCorrectParent() during 
 * normal index inserts, but this is simpler because we don't need to deal 
 * with concurrent inserts. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN844"></a><span class='Declare_Function'>gistBufferingFindCorrectParent</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, 
</span><a name="LN845"></a>                               <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>childblkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN846"></a>                               <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parentblkno</span><span class='Delimiter'>, 
</span><a name="LN847"></a>                               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>downlinkoffnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN849"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>parent</span><span class='Delimiter'>; 
</span><a name="LN850"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN851"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN852"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN853"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN845"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="gistbuild.c.html#LN849"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN105"><span class='Ref_to_Proto'>gistGetParent</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN844"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN845"><span class='Ref_to_Parameter'>childblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * For a leaf page, the caller must supply a correct parent block 
         * number. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gistbuild.c.html#LN846"><span class='Ref_to_Parameter'>parentblkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no parent buffer provided of child %d"</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN845"><span class='Ref_to_Parameter'>childblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN849"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= *</span><a href="gistbuild.c.html#LN846"><span class='Ref_to_Parameter'>parentblkno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gistbuild.c.html#LN850"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN844"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN849"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN851"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN850"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN850"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/gist_private.h.html#LN443"><span class='Ref_to_Proto'>gistcheckpage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN844"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN57"><span class='Ref_to_Member'>indexrel</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN850"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN852"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check if it was not moved */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN849"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>== *</span><a href="gistbuild.c.html#LN846"><span class='Ref_to_Parameter'>parentblkno</span></a> <span class='Operator'>&& *</span><a href="gistbuild.c.html#LN846"><span class='Ref_to_Parameter'>parentblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>*</span><a href="gistbuild.c.html#LN847"><span class='Ref_to_Parameter'>downlinkoffnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a> <span class='Operator'>&& *</span><a href="gistbuild.c.html#LN847"><span class='Ref_to_Parameter'>downlinkoffnum</span></a> <span class='Operator'>&LT;= </span><a href="gistbuild.c.html#LN852"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN878"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="gistbuild.c.html#LN847"><span class='Ref_to_Parameter'>downlinkoffnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN879"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN878"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN879"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="gistbuild.c.html#LN845"><span class='Ref_to_Parameter'>childblkno</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Still there */ 
</span>            <span class='Control'>return</span> <a href="gistbuild.c.html#LN850"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Downlink was not at the offset where it used to be. Scan the page to 
     * find it. During normal gist insertions, it might've moved to another 
     * page, to the right, but during a buffering build, we keep track of the 
     * parent of each page in the lookup table so we should always know what 
     * page it's on. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN853"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN853"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="gistbuild.c.html#LN852"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN853"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN853"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN897"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN853"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN898"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN851"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN897"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN898"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="gistbuild.c.html#LN845"><span class='Ref_to_Parameter'>childblkno</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* yes!!, found it */ 
</span>            <span class='Operator'>*</span><a href="gistbuild.c.html#LN847"><span class='Ref_to_Parameter'>downlinkoffnum</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN853"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="gistbuild.c.html#LN850"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find parent for block %u"</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN845"><span class='Ref_to_Parameter'>childblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistBufferingFindCorrectParent &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process buffers emptying stack. Emptying of one buffer can cause emptying 
 * of other buffers. This function iterates until this cascading emptying 
 * process finished, e.g. until buffers emptying stack is empty. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN918"></a><span class='Declare_Function'>gistProcessEmptyingQueue</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN920"></a>    <a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Local'>gfbb</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN918"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Iterate while we have elements in buffers emptying stack. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN920"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN925"></a>        <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>emptyingNodeBuffer</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get node buffer from emptying stack. */ 
</span>        <a href="gistbuild.c.html#LN925"><span class='Ref_To_Local'>emptyingNodeBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN920"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN920"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN920"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN925"><span class='Ref_To_Local'>emptyingNodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN293"><span class='Ref_to_Member'>queuedForEmptying</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We are going to load last pages of buffers where emptying will be 
         * to. So let's unload any previously loaded buffers. 
         */ 
</span>        <a href="gistbuildbuffers.c.html#LN274"><span class='Ref_to_Func'>gistUnloadNodeBuffers</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN920"><span class='Ref_To_Local'>gfbb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Pop tuples from the buffer and run them down to the buffers at 
         * lower level, or leaf pages. We continue until one of the lower 
         * level buffers fills up, or this buffer runs empty. 
         * 
         * In Arge et al's paper, the buffer emptying is stopped after 
         * processing 1/2 node buffer worth of tuples, to avoid overfilling 
         * any of the lower level buffers. However, it's more efficient to 
         * keep going until one of the lower level buffers actually fills up, 
         * so that's what we do. This doesn't need to be exact, if a buffer 
         * overfills by a few tuples, there's no harm done. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN952"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get next index tuple from the buffer */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuildbuffers.c.html#LN408"><span class='Ref_to_Func'>gistPopItupFromNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN920"><span class='Ref_To_Local'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN925"><span class='Ref_To_Local'>emptyingNodeBuffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistbuild.c.html#LN952"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Run it down to the underlying node buffer or leaf page. 
             * 
             * Note: it's possible that the buffer we're emptying splits as a 
             * result of this call. If that happens, our emptyingNodeBuffer 
             * points to the left half of the split. After split, it's very 
             * likely that the new left buffer is no longer over the half-full 
             * threshold, but we might as well keep flushing tuples from it 
             * until we fill a lower-level buffer. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN87"><span class='Ref_to_Proto'>gistProcessItup</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN918"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN952"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN925"><span class='Ref_To_Local'>emptyingNodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN286"><span class='Ref_to_Member'>nodeBlocknum</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN925"><span class='Ref_To_Local'>emptyingNodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN298"><span class='Ref_to_Member'>level</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * A lower level buffer filled up. Stop emptying this buffer, 
                 * to avoid overflowing the lower level buffer. 
                 */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Free all the memory allocated during index tuple processing */ 
</span>            <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN918"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while gfbb-&GT;bufferEmptyingQ... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistProcessEmptyingQueue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Empty all node buffers, from top to bottom. This is done at the end of 
 * index build to flush all remaining tuples to the index. 
 * 
 * Note: This destroys the buffersOnLevels lists, so the buffers should not 
 * be inserted to after this call. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN991"></a><span class='Declare_Function'>gistEmptyAllBuffers</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN993"></a>    <a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Local'>gfbb</span> <span class='Operator'>= </span><a href="gistbuild.c.html#LN991"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN70"><span class='Ref_to_Member'>gfbb</span></a><span class='Delimiter'>; 
</span><a name="LN994"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldCtx</span><span class='Delimiter'>; 
</span><a name="LN995"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN994"><span class='Ref_To_Local'>oldCtx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN991"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Iterate through the levels from top to bottom. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN355"><span class='Ref_to_Member'>buffersOnLevelsLen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Empty all buffers on this level. Note that new buffers can pop up 
         * in the list during the processing, as a result of page splits, so a 
         * simple walk through the list won't work. We remove buffers from the 
         * list when we see them empty; a buffer can't become non-empty once 
         * it's been fully emptied. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1013"></a>            <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nodeBuffer</span><span class='Delimiter'>; 
</span> 
            <a href="gistbuild.c.html#LN1013"><span class='Ref_To_Local'>nodeBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1013"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Add this buffer to the emptying queue, and proceed to empty 
                 * the queue. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuild.c.html#LN1013"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN293"><span class='Ref_to_Member'>queuedForEmptying</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN327"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="gistbuild.c.html#LN1013"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN293"><span class='Ref_to_Member'>queuedForEmptying</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a> <span class='Operator'>= 
</span>                        <a href="../../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1013"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN991"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN58"><span class='Ref_to_Member'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="gistbuild.c.html#LN97"><span class='Ref_to_Proto'>gistProcessEmptyingQueue</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN991"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= 
</span>                    <a href="../../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN993"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while gfbb-&GT;buffersOnLevels... &raquo; </span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"emptied all buffers at level %d"</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=gfbb-&GT;buffersOnLeve... &raquo; </span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN994"><span class='Ref_To_Local'>oldCtx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistEmptyAllBuffers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get the depth of the GiST index. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1046"></a><span class='Declare_Function'>gistGetMaxLevel</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1048"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxLevel</span><span class='Delimiter'>; 
</span><a name="LN1049"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Traverse down the tree, starting from the root, until we hit the leaf 
     * level. 
     */ 
</span>    <a href="gistbuild.c.html#LN1048"><span class='Ref_To_Local'>maxLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN1049"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1059"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN1060"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1061"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
        <a href="gistbuild.c.html#LN1059"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1046"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN1049"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * There's no concurrent access during index build, so locking is just 
         * pro forma. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1059"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN42"><span class='Ref_to_Const'>GIST_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN1060"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1059"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1060"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We hit the bottom, so we're done. */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1059"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Pick the first downlink on the page, and follow it. It doesn't 
         * matter which downlink we choose, the tree has the same depth 
         * everywhere, so we just pick the first one. 
         */ 
</span>        <a href="gistbuild.c.html#LN1061"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1060"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1060"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gistbuild.c.html#LN1049"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1061"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1059"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We're going down on the tree. It means that there is yet one more 
         * level in the tree. 
         */ 
</span>        <a href="gistbuild.c.html#LN1048"><span class='Ref_To_Local'>maxLevel</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
    <span class='Control'>return</span> <a href="gistbuild.c.html#LN1048"><span class='Ref_To_Local'>maxLevel</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistGetMaxLevel &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Routines for managing the parent map. 
 * 
 * Whenever a page is split, we need to insert the downlinks into the parent. 
 * We need to somehow find the parent page to do that. In normal insertions, 
 * we keep a stack of nodes visited when we descend the tree. However, in 
 * buffering build, we can start descending the tree from any internal node, 
 * when we empty a buffer by cascading tuples to its children. So we don't 
 * have a full stack up to the root available at that time. 
 * 
 * So instead, we maintain a hash table to track the parent of every internal 
 * page. We don't need to track the parents of leaf nodes, however. Whenever 
 * we insert to a leaf, we've just descended down from its parent, so we know 
 * its immediate parent already. This helps a lot to limit the memory used 
 * by this hash table. 
 * 
 * Whenever an internal node is split, the parent map needs to be updated. 
 * the parent of the new child page needs to be recorded, and also the 
 * entries for all page whose downlinks are moved to a new page at the split 
 * needs to be updated. 
 * 
 * We also update the parent map whenever we descend the tree. That might seem 
 * unnecessary, because we maintain the map whenever a downlink is moved or 
 * created, but it is needed because we switch to buffering mode after 
 * creating a tree with regular index inserts. Any pages created before 
 * switching to buffering mode will not be present in the parent map initially, 
 * but will be added there the first time we visit them. 
 */ 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN1130"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>childblkno</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* hash key */ 
</span><a name="LN1131"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>parentblkno</span><span class='Delimiter'>; 
</span><a name="LN1132"></a>} <span class='Declare_Typedef'>ParentMapEntry</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN1135"></a><span class='Declare_Function'>gistInitParentMap</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1137"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hashCtl</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN1137"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN1137"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1128"><span class='Ref_to_Typedef'>ParentMapEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN1137"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN1135"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN71"><span class='Ref_to_Member'>parentMap</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"gistbuild parent map"</span><span class='Delimiter'>, 
</span>                                        <span class='Number'>1024</span><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="gistbuild.c.html#LN1137"><span class='Ref_To_Local'>hashCtl</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN1149"></a><span class='Declare_Function'>gistMemorizeParent</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>parent</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1151"></a>    <a href="gistbuild.c.html#LN1128"><span class='Ref_to_Typedef'>ParentMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN1152"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN1151"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1128"><span class='Ref_to_Typedef'>ParentMapEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1149"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN71"><span class='Ref_to_Member'>parentMap</span></a><span class='Delimiter'>, 
</span>                                           <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="gistbuild.c.html#LN1149"><span class='Ref_to_Parameter'>child</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="gistbuild.c.html#LN1152"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuild.c.html#LN1151"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN1131"><span class='Ref_to_Member'>parentblkno</span></a> <span class='Operator'>= </span><a href="gistbuild.c.html#LN1149"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Scan all downlinks on a page, and memorize their parent. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1165"></a><span class='Declare_Function'>gistMemorizeAllDownlinks</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>parentbuf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1167"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN1168"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN1169"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>parentblkno</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1165"><span class='Ref_to_Parameter'>parentbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1170"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1165"><span class='Ref_to_Parameter'>parentbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1170"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuild.c.html#LN1167"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1170"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1168"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN1168"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="gistbuild.c.html#LN1167"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gistbuild.c.html#LN1168"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1177"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1170"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN1168"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1178"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>idxtuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1170"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN1177"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1179"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>childblkno</span> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1178"><span class='Ref_To_Local'>idxtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="gistbuild.c.html#LN102"><span class='Ref_to_Proto'>gistMemorizeParent</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1165"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN1179"><span class='Ref_To_Local'>childblkno</span></a><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN1169"><span class='Ref_To_Local'>parentblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end gistMemorizeAllDownlinks &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN1186"></a><span class='Declare_Function'>gistGetParent</span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN55"><span class='Ref_to_Typedef'>GISTBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buildstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1188"></a>    <a href="gistbuild.c.html#LN1128"><span class='Ref_to_Typedef'>ParentMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN1189"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find node buffer in hash table */ 
</span>    <a href="gistbuild.c.html#LN1188"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1128"><span class='Ref_to_Typedef'>ParentMapEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="gistbuild.c.html#LN1186"><span class='Ref_to_Parameter'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN71"><span class='Ref_to_Member'>parentMap</span></a><span class='Delimiter'>, 
</span>                                           <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="gistbuild.c.html#LN1186"><span class='Ref_to_Parameter'>child</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="gistbuild.c.html#LN1189"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuild.c.html#LN1189"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find parent of block %d in lookup table"</span><span class='Delimiter'>, </span><a href="gistbuild.c.html#LN1186"><span class='Ref_to_Parameter'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gistbuild.c.html#LN1188"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="gistbuild.c.html#LN1131"><span class='Ref_to_Member'>parentblkno</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>