<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gist\gistbuildbuffers.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gist\gistbuildbuffers.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * gistbuildbuffers.c 
 *    node buffer management functions for GiST buffering build algorithm. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/gist/gistbuildbuffers.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/gist_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/buffile.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
<a name="LN25"></a><span class='Keyword'>static </span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>gistAllocateNewPageBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN26"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistAddLoadedBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, 
</span><a name="LN27"></a>                    <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN28"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistLoadNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, 
</span><a name="LN29"></a>                   <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN30"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistUnloadNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, 
</span><a name="LN31"></a>                     <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN32"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistPlaceItupToPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pageBuffer</span><span class='Delimiter'>, 
</span><a name="LN33"></a>                    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>item</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN34"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistGetItupFromPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pageBuffer</span><span class='Delimiter'>, 
</span><a name="LN35"></a>                    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>item</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN36"></a><span class='Keyword'>static long </span><span class='Declare_Prototype'>gistBuffersGetFreeBlock</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN37"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>gistBuffersReleaseBlock</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN39"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReadTempFileBlock</span><span class='Parentheses'>(</span><a href="../../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN40"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WriteTempFileBlock</span><span class='Parentheses'>(</span><a href="../../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize GiST build buffers. 
 */ 
</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>* 
</span><a name="LN47"></a><span class='Declare_Function'>gistInitBuildBuffers</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pagesPerBuffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>levelStep</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxLevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN49"></a>    <a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Local'>gfbb</span><span class='Delimiter'>; 
</span><a name="LN50"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hashCtl</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN351"><span class='Ref_to_Member'>pagesPerBuffer</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN47"><span class='Ref_to_Parameter'>pagesPerBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN350"><span class='Ref_to_Member'>levelStep</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN47"><span class='Ref_to_Parameter'>levelStep</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a temporary file to hold buffer pages that are swapped out of 
     * memory. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN329"><span class='Ref_to_Member'>pfile</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buffile.h.html#LN36"><span class='Ref_to_Proto'>BufFileCreateTemp</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN330"><span class='Ref_to_Member'>nFileBlocks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize free page management. */ 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN336"><span class='Ref_to_Member'>nFreeBlocks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN337"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>= </span><span class='Number'>32</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN335"><span class='Ref_to_Member'>freeBlocks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN337"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Current memory context will be used for all in-memory data structures 
     * of buffers which are persistent during buffering build. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN327"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * nodeBuffersTab hash is association between index blocks and it's 
     * buffers. 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN50"><span class='Ref_To_Local'>hashCtl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN50"><span class='Ref_To_Local'>hashCtl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN50"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN50"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN50"><span class='Ref_To_Local'>hashCtl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN340"><span class='Ref_to_Member'>nodeBuffersTab</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"gistbuildbuffers"</span><span class='Delimiter'>, 
</span>                                       <span class='Number'>1024</span><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN50"><span class='Ref_To_Local'>hashCtl</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Per-level node buffers lists for final buffers emptying process. Node 
     * buffers are inserted here when they are created. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN355"><span class='Ref_to_Member'>buffersOnLevelsLen</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* 
</span>                                             <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN355"><span class='Ref_to_Member'>buffersOnLevelsLen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Block numbers of node buffers which last pages are currently loaded 
     * into main memory. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN363"><span class='Ref_to_Member'>loadedBuffersLen</span></a> <span class='Operator'>= </span><span class='Number'>32</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN361"><span class='Ref_to_Member'>loadedBuffers</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN363"><span class='Ref_to_Member'>loadedBuffersLen</span></a> <span class='Operator'>* 
</span>                                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN362"><span class='Ref_to_Member'>loadedBuffersCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN366"><span class='Ref_to_Member'>rootlevel</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN47"><span class='Ref_to_Parameter'>maxLevel</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gistbuildbuffers.c.html#LN49"><span class='Ref_To_Local'>gfbb</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistInitBuildBuffers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns a node buffer for given block. The buffer is created if it 
 * doesn't exist yet. 
 */ 
</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>* 
</span><a name="LN117"></a><span class='Declare_Function'>gistGetNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, 
</span><a name="LN118"></a>                  <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>nodeBlocknum</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN120"></a>    <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nodeBuffer</span><span class='Delimiter'>; 
</span><a name="LN121"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find node buffer in hash table */ 
</span>    <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN340"><span class='Ref_to_Member'>nodeBuffersTab</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>nodeBlocknum</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN121"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuildbuffers.c.html#LN121"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Node buffer wasn't found. Initialize the new buffer as empty. 
         */ 
</span><a name="LN133"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN327"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* nodeBuffer-&GT;nodeBlocknum is the hash key and was filled in already */ 
</span>        <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN289"><span class='Ref_to_Member'>pageBlocknum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN293"><span class='Ref_to_Member'>queuedForEmptying</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN298"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Add this buffer to the list of buffers on this level. Enlarge 
         * buffersOnLevels array if needed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT;= </span><a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN355"><span class='Ref_to_Member'>buffersOnLevelsLen</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN148"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a> <span class='Operator'>= 
</span>                <span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>, 
</span>                                   <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* initialize the enlarged portion */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN148"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN355"><span class='Ref_to_Member'>buffersOnLevelsLen</span></a><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN148"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN148"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN148"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>            <a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN355"><span class='Ref_to_Member'>buffersOnLevelsLen</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Prepend the new buffer to the list of buffers on this level. It's 
         * not arbitrary that the new buffer is put to the beginning of the 
         * list: in the final emptying phase we loop through all buffers at 
         * each level, and flush them. If a page is split during the emptying, 
         * it's more efficient to flush the new splitted pages first, before 
         * moving on to pre-existing pages on the level. The buffers just 
         * created during the page split are likely still in cache, so 
         * flushing them immediately is more efficient than putting them to 
         * the end of the queue. 
         */ 
</span>        <a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Delimiter'>, 
</span>                                             <a href="gistbuildbuffers.c.html#LN117"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN354"><span class='Ref_to_Member'>buffersOnLevels</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN118"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN133"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !found &raquo; </span> 
 
    <span class='Control'>return</span> <a href="gistbuildbuffers.c.html#LN120"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistGetNodeBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate memory for a buffer page. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>* 
</span><a name="LN184"></a><span class='Declare_Function'>gistAllocateNewPageBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN186"></a>    <a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pageBuffer</span><span class='Delimiter'>; 
</span> 
    <a href="gistbuildbuffers.c.html#LN186"><span class='Ref_To_Local'>pageBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN184"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN327"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                                                           BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN186"><span class='Ref_To_Local'>pageBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN48"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set page free space */ 
</span>    <a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN186"><span class='Ref_To_Local'>pageBuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span>BLCKSZ <span class='Operator'>- </span><a href="../../../include/access/gist_private.h.html#LN53"><span class='Ref_to_Const'>BUFFER_PAGE_DATA_OFFSET</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="gistbuildbuffers.c.html#LN186"><span class='Ref_To_Local'>pageBuffer</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add specified buffer into loadedBuffers array. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN201"></a><span class='Declare_Function'>gistAddLoadedBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Never add a temporary buffer to the array */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN296"><span class='Ref_to_Member'>isTemp</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Enlarge the array if needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN362"><span class='Ref_to_Member'>loadedBuffersCount</span></a> <span class='Operator'>&GT;= </span><a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN363"><span class='Ref_to_Member'>loadedBuffersLen</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN363"><span class='Ref_to_Member'>loadedBuffersLen</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN361"><span class='Ref_to_Member'>loadedBuffers</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN361"><span class='Ref_to_Member'>loadedBuffers</span></a><span class='Delimiter'>, 
</span>                     <a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN363"><span class='Ref_to_Member'>loadedBuffersLen</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN361"><span class='Ref_to_Member'>loadedBuffers</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN362"><span class='Ref_to_Member'>loadedBuffersCount</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN201"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN362"><span class='Ref_to_Member'>loadedBuffersCount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Load last page of node buffer into main memory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN224"></a><span class='Declare_Function'>gistLoadNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Check if we really should load something */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>&& </span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Allocate memory for page */ 
</span>        <a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN25"><span class='Ref_to_Proto'>gistAllocateNewPageBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Read block from temporary file */ 
</span>        <a href="gistbuildbuffers.c.html#LN39"><span class='Ref_to_Proto'>ReadTempFileBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN329"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN289"><span class='Ref_to_Member'>pageBlocknum</span></a><span class='Delimiter'>, 
</span>                          <a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark file block as free */ 
</span>        <a href="gistbuildbuffers.c.html#LN37"><span class='Ref_to_Proto'>gistBuffersReleaseBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN289"><span class='Ref_to_Member'>pageBlocknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark node buffer as loaded */ 
</span>        <a href="gistbuildbuffers.c.html#LN26"><span class='Ref_to_Proto'>gistAddLoadedBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN224"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN289"><span class='Ref_to_Member'>pageBlocknum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end gistLoadNodeBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write last page of node buffer to the disk. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN249"></a><span class='Declare_Function'>gistUnloadNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Check if we have something to write */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN254"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get free file block */ 
</span>        <a href="gistbuildbuffers.c.html#LN254"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN36"><span class='Ref_to_Proto'>gistBuffersGetFreeBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Write block to the temporary file */ 
</span>        <a href="gistbuildbuffers.c.html#LN40"><span class='Ref_to_Proto'>WriteTempFileBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN329"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN254"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Free memory of that page */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save block number */ 
</span>        <a href="gistbuildbuffers.c.html#LN249"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN289"><span class='Ref_to_Member'>pageBlocknum</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN254"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end gistUnloadNodeBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write last pages of all node buffers to the disk. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN275"></a><span class='Declare_Function'>gistUnloadNodeBuffers</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN277"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Unload all the buffers that have a page loaded in memory. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN277"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN277"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistbuildbuffers.c.html#LN275"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN362"><span class='Ref_to_Member'>loadedBuffersCount</span></a><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN277"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="gistbuildbuffers.c.html#LN30"><span class='Ref_to_Proto'>gistUnloadNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN275"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN275"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN361"><span class='Ref_to_Member'>loadedBuffers</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN277"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now there are no node buffers with loaded last page */ 
</span>    <a href="gistbuildbuffers.c.html#LN275"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN362"><span class='Ref_to_Member'>loadedBuffersCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add index tuple to buffer page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN291"></a><span class='Declare_Function'>gistPlaceItupToPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pageBuffer</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN293"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itupsz</span> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN291"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN294"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* There should be enough of space. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN291"><span class='Ref_to_Parameter'>pageBuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN293"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reduce free space value of page to reserve a spot for the tuple. */ 
</span>    <a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN291"><span class='Ref_to_Parameter'>pageBuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>-= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN293"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get pointer to the spot we reserved (ie. end of free space). */ 
</span>    <a href="gistbuildbuffers.c.html#LN294"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistbuildbuffers.c.html#LN291"><span class='Ref_to_Parameter'>pageBuffer</span></a> <span class='Operator'>+ </span><a href="../../../include/access/gist_private.h.html#LN53"><span class='Ref_to_Const'>BUFFER_PAGE_DATA_OFFSET</span></a> 
        <span class='Operator'>+ </span><a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN291"><span class='Ref_to_Parameter'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy the index tuple there. */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN294"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN291"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN293"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get last item from buffer page and remove it from page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN314"></a><span class='Declare_Function'>gistGetItupFromPage</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pageBuffer</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN316"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN317"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itupsz</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist_private.h.html#LN57"><span class='Ref_to_Macro'>PAGE_IS_EMPTY</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN314"><span class='Ref_to_Parameter'>pageBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* Page shouldn't be empty */ 
</span> 
    <span class='Comment_Multi_Line'>/* Get pointer to last index tuple */ 
</span>    <a href="gistbuildbuffers.c.html#LN316"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistbuildbuffers.c.html#LN314"><span class='Ref_to_Parameter'>pageBuffer</span></a> 
                        <span class='Operator'>+ </span><a href="../../../include/access/gist_private.h.html#LN53"><span class='Ref_to_Const'>BUFFER_PAGE_DATA_OFFSET</span></a> 
                        <span class='Operator'>+ </span><a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN314"><span class='Ref_to_Parameter'>pageBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN317"><span class='Ref_To_Local'>itupsz</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN316"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make a copy of the tuple */ 
</span>    <span class='Operator'>*</span><a href="gistbuildbuffers.c.html#LN314"><span class='Ref_to_Parameter'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN317"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gistbuildbuffers.c.html#LN314"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN316"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN317"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mark the space used by the tuple as free */ 
</span>    <a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN314"><span class='Ref_to_Parameter'>pageBuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN317"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistGetItupFromPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Push an index tuple to node buffer. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN339"></a><span class='Declare_Function'>gistPushItupToNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Delimiter'>, 
</span><a name="LN340"></a>                         <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Most part of memory operations will be in buffering build persistent 
     * context. So, let's switch to it. 
     */ 
</span><a name="LN346"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN327"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the buffer is currently empty, create the first page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN25"><span class='Ref_to_Proto'>gistAllocateNewPageBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN26"><span class='Ref_to_Proto'>gistAddLoadedBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Load last page of node buffer if it wasn't in memory already */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="gistbuildbuffers.c.html#LN28"><span class='Ref_to_Proto'>gistLoadNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if there is enough space on the last page for the tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN59"><span class='Ref_to_Macro'>PAGE_NO_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN340"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Nope. Swap previous block to disk and allocate a new one. 
         */ 
</span><a name="LN370"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Write filled page to the disk */ 
</span>        <a href="gistbuildbuffers.c.html#LN370"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN36"><span class='Ref_to_Proto'>gistBuffersGetFreeBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN40"><span class='Ref_to_Proto'>WriteTempFileBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN329"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN370"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Reset the in-memory page as empty, and link the previous block to 
         * the new page by storing its block number in the prev-link. 
         */ 
</span>        <a href="../../../include/access/gist_private.h.html#LN55"><span class='Ref_to_Macro'>PAGE_FREE_SPACE</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>= 
</span>            BLCKSZ <span class='Operator'>- </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN46"><span class='Ref_to_Typedef'>GISTNodeBufferPage</span></a><span class='Delimiter'>, </span>tupledata<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN48"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN370"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We've just added one more page */ 
</span>        <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PAGE_NO_SPACE(nodeBuf... &raquo; </span> 
 
    <a href="gistbuildbuffers.c.html#LN32"><span class='Ref_to_Proto'>gistPlaceItupToPage</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN340"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the buffer just overflowed, add it to the emptying queue. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN310"><span class='Ref_to_Macro'>BUFFER_HALF_FILLED</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN293"><span class='Ref_to_Member'>queuedForEmptying</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Delimiter'>, 
</span>                                          <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN343"><span class='Ref_to_Member'>bufferEmptyingQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN339"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN293"><span class='Ref_to_Member'>queuedForEmptying</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Restore memory context */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN346"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistPushItupToNodeBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Removes one index tuple from node buffer. Returns true if success and false 
 * if node buffer is empty. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN409"></a><span class='Declare_Function'>gistPopItupFromNodeBuffer</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodeBuffer</span><span class='Delimiter'>, 
</span><a name="LN410"></a>                          <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If node buffer is empty then return false. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load last page of node buffer if needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="gistbuildbuffers.c.html#LN28"><span class='Ref_to_Proto'>gistLoadNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get index tuple from last non-empty page. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN34"><span class='Ref_to_Proto'>gistGetItupFromPage</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN410"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we just removed the last tuple from the page, fetch previous page on 
     * this node buffer (if any). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN57"><span class='Ref_to_Macro'>PAGE_IS_EMPTY</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN433"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>prevblkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * blocksCount includes the page in pageBuffer, so decrease it now. 
         */ 
</span>        <a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If there's more pages, fetch previous one. 
         */ 
</span>        <a href="gistbuildbuffers.c.html#LN433"><span class='Ref_To_Local'>prevblkno</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN48"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN433"><span class='Ref_To_Local'>prevblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* There is a previous page. Fetch it. */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gistbuildbuffers.c.html#LN39"><span class='Ref_to_Proto'>ReadTempFileBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN329"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN433"><span class='Ref_To_Local'>prevblkno</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Now that we've read the block in memory, we can release its 
             * on-disk block for reuse. 
             */ 
</span>            <a href="gistbuildbuffers.c.html#LN37"><span class='Ref_to_Proto'>gistBuffersReleaseBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN433"><span class='Ref_To_Local'>prevblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* No more pages. Free memory. */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gistbuildbuffers.c.html#LN409"><span class='Ref_to_Parameter'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PAGE_IS_EMPTY(nodeBuf... &raquo; </span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistPopItupFromNodeBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Select a currently unused block for writing to. 
 */ 
</span><span class='Keyword'>static long 
</span><a name="LN471"></a><span class='Declare_Function'>gistBuffersGetFreeBlock</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If there are multiple free blocks, we select the one appearing last in 
     * freeBlocks[].  If there are none, assign the next block at the end of 
     * the file (causing the file to be extended). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN471"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN336"><span class='Ref_to_Member'>nFreeBlocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="gistbuildbuffers.c.html#LN471"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN335"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>[</span><span class='Operator'>--</span><a href="gistbuildbuffers.c.html#LN471"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN336"><span class='Ref_to_Member'>nFreeBlocks</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="gistbuildbuffers.c.html#LN471"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN330"><span class='Ref_to_Member'>nFileBlocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return a block# to the freelist. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN488"></a><span class='Declare_Function'>gistBuffersReleaseBlock</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN490"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndx</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Enlarge freeBlocks array if full. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN336"><span class='Ref_to_Member'>nFreeBlocks</span></a> <span class='Operator'>&GT;= </span><a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN337"><span class='Ref_to_Member'>freeBlocksLen</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN337"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN335"><span class='Ref_to_Member'>freeBlocks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN335"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>, 
</span>                                             <a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN337"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>* 
</span>                                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Add blocknum to array */ 
</span>    <a href="gistbuildbuffers.c.html#LN490"><span class='Ref_To_Local'>ndx</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN336"><span class='Ref_to_Member'>nFreeBlocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN335"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN490"><span class='Ref_To_Local'>ndx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN488"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Free buffering build data structure. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN510"></a><span class='Declare_Function'>gistFreeBuildBuffers</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Close buffers file. */ 
</span>    <a href="../../../include/storage/buffile.h.html#LN37"><span class='Ref_to_Proto'>BufFileClose</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN510"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN329"><span class='Ref_to_Member'>pfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* All other things will be freed on memory context release */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Data structure representing information about node buffer for index tuples 
 * relocation from splitted node buffer. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN524"></a>    <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>   <span class='Declare_Member'>entry</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN525"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN526"></a>    <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Member'>splitinfo</span><span class='Delimiter'>; 
</span><a name="LN527"></a>    <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Member'>nodeBuffer</span><span class='Delimiter'>; 
</span><a name="LN528"></a>} <span class='Declare_Typedef'>RelocationBufferInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * At page split, distribute tuples from the buffer of the split page to 
 * new buffers for the created page halves. This also adjusts the downlinks 
 * in 'splitinfo' to include the tuples in the buffers. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN536"></a><span class='Declare_Function'>gistRelocateBuildBuffersOnSplit</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN324"><span class='Ref_to_Struct'>GISTBuildBuffers</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gfbb</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, 
</span><a name="LN537"></a>                                <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, 
</span><a name="LN538"></a>                                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>splitinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN540"></a>    <a href="gistbuildbuffers.c.html#LN522"><span class='Ref_to_Typedef'>RelocationBufferInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>relocationBuffersInfos</span><span class='Delimiter'>; 
</span><a name="LN541"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN542"></a>    <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nodeBuffer</span><span class='Delimiter'>; 
</span><a name="LN543"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blocknum</span><span class='Delimiter'>; 
</span><a name="LN544"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN545"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>splitPagesCount</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN546"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN547"></a>    <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>   <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN548"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN549"></a>    <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Declare_Local'>oldBuf</span><span class='Delimiter'>; 
</span><a name="LN550"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the splitted page doesn't have buffers, we have nothing to do. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist_private.h.html#LN305"><span class='Ref_to_Macro'>LEVEL_HAS_BUFFERS</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the node buffer of the splitted page. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN543"><span class='Ref_To_Local'>blocknum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN538"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN542"><span class='Ref_To_Local'>nodeBuffer</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN340"><span class='Ref_to_Member'>nodeBuffersTab</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN543"><span class='Ref_To_Local'>blocknum</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN541"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistbuildbuffers.c.html#LN541"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The page has no buffer, so we have nothing to do. */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a copy of the old buffer, as we're going reuse it as the buffer 
     * for the new left page, which is on the same block as the old page. 
     * That's not true for the root page, but that's fine because we never 
     * have a buffer on the root page anyway. The original algorithm as 
     * described by Arge et al did, but it's of no use, as you might as well 
     * read the tuples straight from the heap instead of the root buffer. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN543"><span class='Ref_To_Local'>blocknum</span></a> <span class='Operator'>!= </span><a href="../../../include/access/gist_private.h.html#LN248"><span class='Ref_to_Const'>GIST_ROOT_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN549"><span class='Ref_To_Local'>oldBuf</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN542"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN549"><span class='Ref_To_Local'>oldBuf</span></a><span class='Operator'>.</span><a href="../../../include/access/gist_private.h.html#LN296"><span class='Ref_to_Member'>isTemp</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset the old buffer, used for the new left page from now on */ 
</span>    <a href="gistbuildbuffers.c.html#LN542"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN287"><span class='Ref_to_Member'>blocksCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN542"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN290"><span class='Ref_to_Member'>pageBuffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN542"><span class='Ref_To_Local'>nodeBuffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN289"><span class='Ref_to_Member'>pageBlocknum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate memory for information about relocation buffers. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN545"><span class='Ref_To_Local'>splitPagesCount</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN538"><span class='Ref_to_Parameter'>splitinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN522"><span class='Ref_to_Typedef'>RelocationBufferInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN522"><span class='Ref_to_Typedef'>RelocationBufferInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>* 
</span>                                        <a href="gistbuildbuffers.c.html#LN545"><span class='Ref_To_Local'>splitPagesCount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fill relocation buffers information for node buffers of pages produced 
     * by split. 
     */ 
</span>    <a href="gistbuildbuffers.c.html#LN546"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN550"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN538"><span class='Ref_to_Parameter'>splitinfo</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN600"></a>        <a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>si</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN394"><span class='Ref_to_Typedef'>GISTPageSplitInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN550"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN601"></a>        <a href="../../../include/access/gist_private.h.html#LN284"><span class='Ref_to_Typedef'>GISTNodeBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newNodeBuffer</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Decompress parent index tuple of node buffer page. */ 
</span>        <a href="gistutil.c.html#LN292"><span class='Ref_to_Func'>gistDeCompressAtt</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, 
</span>                          <a href="gistbuildbuffers.c.html#LN600"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                          <a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN546"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="gistbuildbuffers.c.html#LN524"><span class='Ref_to_Member'>entry</span></a><span class='Delimiter'>, 
</span>                          <a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN546"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="gistbuildbuffers.c.html#LN525"><span class='Ref_to_Member'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create a node buffer for the page. The leftmost half is on the same 
         * block as the old page before split, so for the leftmost half this 
         * will return the original buffer. The tuples on the original buffer 
         * were relinked to the temporary buffer, so the original one is now 
         * empty. 
         */ 
</span>        <a href="gistbuildbuffers.c.html#LN601"><span class='Ref_To_Local'>newNodeBuffer</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN116"><span class='Ref_to_Func'>gistGetNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN600"><span class='Ref_To_Local'>si</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN396"><span class='Ref_to_Member'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN546"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="gistbuildbuffers.c.html#LN527"><span class='Ref_to_Member'>nodeBuffer</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN601"><span class='Ref_To_Local'>newNodeBuffer</span></a><span class='Delimiter'>; 
</span>        <a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN546"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="gistbuildbuffers.c.html#LN526"><span class='Ref_to_Member'>splitinfo</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN600"><span class='Ref_To_Local'>si</span></a><span class='Delimiter'>; 
</span> 
        <a href="gistbuildbuffers.c.html#LN546"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop through all index tuples in the buffer of the page being split, 
     * moving them to buffers for the new pages.  We try to move each tuple to 
     * the page that will result in the lowest penalty for the leading column 
     * or, in the case of a tie, the lowest penalty for the earliest column 
     * that is not tied. 
     * 
     * The page searching logic is very similar to gistchoose(). 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN408"><span class='Ref_to_Func'>gistPopItupFromNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN549"><span class='Ref_To_Local'>oldBuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN544"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN635"></a>        <span class='Keyword'>float</span>       <span class='Declare_Local'>best_penalty</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN636"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN637"></a>                    <span class='Declare_Local'>which</span><span class='Delimiter'>; 
</span><a name="LN638"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN639"></a>        <a href="gistbuildbuffers.c.html#LN522"><span class='Ref_to_Typedef'>RelocationBufferInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>targetBufferInfo</span><span class='Delimiter'>; 
</span> 
        <a href="gistutil.c.html#LN292"><span class='Ref_to_Func'>gistDeCompressAtt</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, 
</span>                          <a href="gistbuildbuffers.c.html#LN544"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN547"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN548"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* default to using first page (shouldn't matter) */ 
</span>        <a href="gistbuildbuffers.c.html#LN637"><span class='Ref_To_Local'>which</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * best_penalty[j] is the best penalty we have seen so far for column 
         * j, or -1 when we haven't yet examined column j.  Array entries to 
         * the right of the first -1 are undefined. 
         */ 
</span>        <a href="gistbuildbuffers.c.html#LN635"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Loop over possible target pages, looking for one to move this tuple 
         * to. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN636"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN636"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistbuildbuffers.c.html#LN545"><span class='Ref_To_Local'>splitPagesCount</span></a><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN636"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN660"></a>            <a href="gistbuildbuffers.c.html#LN522"><span class='Ref_to_Typedef'>RelocationBufferInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>splitPageInfo</span> <span class='Operator'>= &</span><a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN636"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN661"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>zero_penalty</span><span class='Delimiter'>; 
</span><a name="LN662"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
            <a href="gistbuildbuffers.c.html#LN661"><span class='Ref_To_Local'>zero_penalty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Loop over index attributes. */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN669"></a>                <span class='Keyword'>float</span>       <span class='Declare_Local'>usize</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Compute penalty for this column. */ 
</span>                <a href="gistbuildbuffers.c.html#LN669"><span class='Ref_To_Local'>usize</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN471"><span class='Ref_to_Proto'>gistpenalty</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN660"><span class='Ref_To_Local'>splitPageInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN524"><span class='Ref_to_Member'>entry</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                    <a href="gistbuildbuffers.c.html#LN660"><span class='Ref_To_Local'>splitPageInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN525"><span class='Ref_to_Member'>isnull</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                    <span class='Operator'>&</span><a href="gistbuildbuffers.c.html#LN547"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], </span><a href="gistbuildbuffers.c.html#LN548"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN669"><span class='Ref_To_Local'>usize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="gistbuildbuffers.c.html#LN661"><span class='Ref_To_Local'>zero_penalty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN635"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="gistbuildbuffers.c.html#LN669"><span class='Ref_To_Local'>usize</span></a> <span class='Operator'>&LT; </span><a href="gistbuildbuffers.c.html#LN635"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * New best penalty for column.  Tentatively select this 
                     * page as the target, and record the best penalty.  Then 
                     * reset the next column's penalty to "unknown" (and 
                     * indirectly, the same for all the ones to its right). 
                     * This will force us to adopt this page's penalty values 
                     * as the best for all the remaining columns during 
                     * subsequent loop iterations. 
                     */ 
</span>                    <a href="gistbuildbuffers.c.html#LN637"><span class='Ref_To_Local'>which</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN636"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                    <a href="gistbuildbuffers.c.html#LN635"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN669"><span class='Ref_To_Local'>usize</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                        <a href="gistbuildbuffers.c.html#LN635"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN635"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN662"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="gistbuildbuffers.c.html#LN669"><span class='Ref_To_Local'>usize</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * The current page is exactly as good for this column as 
                     * the best page seen so far.  The next iteration of this 
                     * loop will compare the next column. 
                     */ 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * The current page is worse for this column than the best 
                     * page seen so far.  Skip the remaining columns and move 
                     * on to the next page, if any. 
                     */ 
</span>                    <a href="gistbuildbuffers.c.html#LN661"><span class='Ref_To_Local'>zero_penalty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* so outer loop won't exit */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for j=0;j&LT;r-&GT;rd_att-&GT;natt... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * If we find a page with zero penalty for all columns, there's no 
             * need to examine remaining pages; just break out of the loop and 
             * return it. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN661"><span class='Ref_To_Local'>zero_penalty</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;splitPagesCount... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* OK, "which" is the page index to push the tuple to */ 
</span>        <a href="gistbuildbuffers.c.html#LN639"><span class='Ref_To_Local'>targetBufferInfo</span></a> <span class='Operator'>= &</span><a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Delimiter'>[</span><a href="gistbuildbuffers.c.html#LN637"><span class='Ref_To_Local'>which</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Push item to selected node buffer */ 
</span>        <a href="gistbuildbuffers.c.html#LN338"><span class='Ref_to_Func'>gistPushItupToNodeBuffer</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>gfbb</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN639"><span class='Ref_To_Local'>targetBufferInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN527"><span class='Ref_to_Member'>nodeBuffer</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN544"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Adjust the downlink for this page, if needed. */ 
</span>        <a href="gistbuildbuffers.c.html#LN638"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN312"><span class='Ref_to_Func'>gistgetadjusted</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN639"><span class='Ref_To_Local'>targetBufferInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN526"><span class='Ref_to_Member'>splitinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a><span class='Delimiter'>, 
</span>                                 <a href="gistbuildbuffers.c.html#LN544"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>giststate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN638"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gistutil.c.html#LN292"><span class='Ref_to_Func'>gistDeCompressAtt</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN536"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN537"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, 
</span>                              <a href="gistbuildbuffers.c.html#LN638"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                              <a href="gistbuildbuffers.c.html#LN639"><span class='Ref_To_Local'>targetBufferInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN524"><span class='Ref_to_Member'>entry</span></a><span class='Delimiter'>, 
</span>                              <a href="gistbuildbuffers.c.html#LN639"><span class='Ref_To_Local'>targetBufferInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN525"><span class='Ref_to_Member'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="gistbuildbuffers.c.html#LN639"><span class='Ref_To_Local'>targetBufferInfo</span></a><span class='Operator'>-&GT;</span><a href="gistbuildbuffers.c.html#LN526"><span class='Ref_to_Member'>splitinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN397"><span class='Ref_to_Member'>downlink</span></a> <span class='Operator'>= </span><a href="gistbuildbuffers.c.html#LN638"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while gistPopItupFromNodeBu... &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN540"><span class='Ref_To_Local'>relocationBuffersInfos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistRelocateBuildBuffersOnSplit &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Wrappers around BufFile operations. The main difference is that these 
 * wrappers report errors with ereport(), so that the callers don't need 
 * to check the return code. 
 */ 
</span> 
<span class='Keyword'>static void 
</span><a name="LN756"></a><span class='Declare_Function'>ReadTempFileBlock</span><span class='Parentheses'>(</span><a href="../../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buffile.h.html#LN42"><span class='Ref_to_Proto'>BufFileSeekBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN756"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN756"><span class='Ref_to_Parameter'>blknum</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not seek temporary file: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buffile.h.html#LN38"><span class='Ref_to_Proto'>BufFileRead</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN756"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN756"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not read temporary file: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN765"></a><span class='Declare_Function'>WriteTempFileBlock</span><span class='Parentheses'>(</span><a href="../../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buffile.h.html#LN42"><span class='Ref_to_Proto'>BufFileSeekBlock</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN765"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN765"><span class='Ref_to_Parameter'>blknum</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not seek temporary file: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buffile.h.html#LN39"><span class='Ref_to_Proto'>BufFileWrite</span></a><span class='Parentheses'>(</span><a href="gistbuildbuffers.c.html#LN765"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="gistbuildbuffers.c.html#LN765"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * the other errors in Read/WriteTempFileBlock shouldn't happen, but 
         * an error at write can easily happen if you run out of disk space. 
         */ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write block %ld of temporary file: %m"</span><span class='Delimiter'>, 
</span>                        <a href="gistbuildbuffers.c.html#LN765"><span class='Ref_to_Parameter'>blknum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>