<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\gist\gistutil.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\gist\gistutil.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * gistutil.c 
 *    utilities routines for the postgres GiST index access method. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/gist/gistutil.c 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;float.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/gist_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opclass.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/indexfsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Write itup vector to page, has no control of free space. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN32"></a><span class='Declare_Function'>gistfillbuffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>off</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN34"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>l</span> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span><a name="LN35"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>off</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>        <a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>off</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>: 
</span>            <a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN35"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN35"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN35"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN43"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sz</span> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN35"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="gistutil.c.html#LN34"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN35"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="gistutil.c.html#LN43"><span class='Ref_To_Local'>sz</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>off</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN34"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item to GiST index page, item %d out of %d, size %d bytes"</span><span class='Delimiter'>, 
</span>                 <a href="gistutil.c.html#LN35"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="gistutil.c.html#LN43"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistutil.c.html#LN32"><span class='Ref_to_Parameter'>off</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end gistfillbuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check space for itup vector on page 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN57"></a><span class='Declare_Function'>gistnospace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itvec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>todelete</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>freespace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN59"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>size</span> <span class='Operator'>= </span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>freespace</span></a><span class='Delimiter'>, 
</span><a name="LN60"></a>                <span class='Declare_Local'>deleted</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN61"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN61"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN61"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN61"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="gistutil.c.html#LN59"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN61"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>todelete</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN68"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>todelete</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="gistutil.c.html#LN60"><span class='Ref_To_Local'>deleted</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN68"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN57"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="gistutil.c.html#LN60"><span class='Ref_To_Local'>deleted</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN59"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN77"></a><span class='Declare_Function'>gistfitpage</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itvec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN79"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN80"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN79"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN79"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN77"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN79"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="gistutil.c.html#LN80"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN77"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN79"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* TODO: Consider fillfactor */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN80"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/gist_private.h.html#LN431"><span class='Ref_to_Const'>GiSTPageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Read buffer into itup vector 
 */ 
</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>* 
</span><a name="LN93"></a><span class='Declare_Function'>gistextractpage</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>len</span> <span class='Comment_Multi_Line'>/* out */ </span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN95"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN96"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN97"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>itvec</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN96"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN93"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="gistutil.c.html#LN93"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN96"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>    <a href="gistutil.c.html#LN97"><span class='Ref_To_Local'>itvec</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="gistutil.c.html#LN96"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN95"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN95"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gistutil.c.html#LN96"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN95"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN95"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
        <a href="gistutil.c.html#LN97"><span class='Ref_To_Local'>itvec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN95"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN93"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN93"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN95"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gistutil.c.html#LN97"><span class='Ref_To_Local'>itvec</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * join two vectors into one 
 */ 
</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>* 
</span><a name="LN112"></a><span class='Declare_Function'>gistjoinvector</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itvec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>additvec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>addlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>itvec</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><span class='Parentheses'>((</span><span class='Operator'>*</span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>addlen</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>], </span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>additvec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>addlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>+= </span><a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>addlen</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="gistutil.c.html#LN112"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * make plain IndexTupleVector 
 */ 
</span> 
<a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a> <span class='Operator'>* 
</span><a name="LN125"></a><span class='Declare_Function'>gistfillitupvec</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>veclen</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>memlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN127"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>, 
</span><a name="LN128"></a>               <span class='Operator'>*</span><span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN129"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>memlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>veclen</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>memlen</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>vec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN127"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN128"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>memlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>veclen</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="gistutil.c.html#LN127"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>vec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>vec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="gistutil.c.html#LN127"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN125"><span class='Ref_to_Parameter'>vec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN129"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistutil.c.html#LN128"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistfillitupvec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Make unions of keys in IndexTuple vector (one union datum per index column). 
 * Union Datums are returned into the attr/isnull arrays. 
 * Resulting Datums aren't compressed. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN153"></a><span class='Declare_Function'>gistMakeUnionItVec</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itvec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, 
</span><a name="LN154"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attr</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN156"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN157"></a>    <a href="../../../include/access/gist.h.html#LN157"><span class='Ref_to_Typedef'>GistEntryVector</span></a> <span class='Operator'>*</span><span class='Declare_Local'>evec</span><span class='Delimiter'>; 
</span><a name="LN158"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>attrsize</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN157"><span class='Ref_to_Typedef'>GistEntryVector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/access/gist.h.html#LN163"><span class='Ref_to_Const'>GEVHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN164"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Collect non-null datums for this column */ 
</span>        <a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN164"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN164"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN164"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN170"></a>            <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span><a name="LN171"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>IsNull</span><span class='Delimiter'>; 
</span> 
            <a href="gistutil.c.html#LN170"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN164"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], </span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN171"><span class='Ref_To_Local'>IsNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN171"><span class='Ref_To_Local'>IsNull</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/gist_private.h.html#LN467"><span class='Ref_to_Proto'>gistdentryinit</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                           <a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a> <span class='Operator'>+ </span><a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a><span class='Delimiter'>, 
</span>                           <a href="gistutil.c.html#LN170"><span class='Ref_To_Local'>datum</span></a><span class='Delimiter'>, 
</span>                           <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                           <span class='Boolean'>FALSE</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN171"><span class='Ref_To_Local'>IsNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If this column was all NULLs, the union is NULL */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gistutil.c.html#LN154"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN154"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* unionFn may expect at least two inputs */ 
</span>                <a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>                <a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Make union and store in attr array */ 
</span>            <a href="gistutil.c.html#LN154"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN85"><span class='Ref_to_Member'>unionFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                        <a href="gistutil.c.html#LN153"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                        <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN157"><span class='Ref_To_Local'>evec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN158"><span class='Ref_To_Local'>attrsize</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="gistutil.c.html#LN154"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;giststate-&GT;tupd... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistMakeUnionItVec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return an IndexTuple containing the result of applying the "union" 
 * method to the specified IndexTuple vector. 
 */ 
</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> 
<a name="LN216"></a><span class='Declare_Function'>gistunion</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itvec</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN218"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>attr</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN219"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span> 
    <a href="gistutil.c.html#LN152"><span class='Ref_to_Func'>gistMakeUnionItVec</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN216"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN216"><span class='Ref_to_Parameter'>itvec</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN216"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN218"><span class='Ref_To_Local'>attr</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN219"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/gist_private.h.html#LN459"><span class='Ref_to_Proto'>gistFormTuple</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN216"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN216"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN218"><span class='Ref_To_Local'>attr</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN219"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * makes union of two key 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN230"></a><span class='Declare_Function'>gistMakeUnionKey</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attno</span><span class='Delimiter'>, 
</span><a name="LN231"></a>                 <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>entry1</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull1</span><span class='Delimiter'>, 
</span><a name="LN232"></a>                 <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>entry2</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull2</span><span class='Delimiter'>, 
</span><a name="LN233"></a>                 <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dst</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dstisnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* we need a GistEntryVector with room for exactly 2 elements */ 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN238"></a>        <a href="../../../include/access/gist.h.html#LN157"><span class='Ref_to_Typedef'>GistEntryVector</span></a> <span class='Declare_Member'>gev</span><span class='Delimiter'>; 
</span><a name="LN239"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>padding</span><span class='Delimiter'>[</span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/access/gist.h.html#LN163"><span class='Ref_to_Const'>GEVHDRSZ</span></a><span class='Delimiter'>]; 
</span><a name="LN240"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>storage</span><span class='Delimiter'>; 
</span><a name="LN241"></a>    <a href="../../../include/access/gist.h.html#LN157"><span class='Ref_to_Typedef'>GistEntryVector</span></a> <span class='Operator'>*</span><span class='Declare_Local'>evec</span> <span class='Operator'>= &</span><a href="gistutil.c.html#LN240"><span class='Ref_To_Local'>storage</span></a><span class='Operator'>.</span><a href="gistutil.c.html#LN238"><span class='Ref_to_Member'>gev</span></a><span class='Delimiter'>; 
</span><a name="LN242"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>dstsize</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN159"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN231"><span class='Ref_to_Parameter'>isnull1</span></a> <span class='Operator'>&& </span><a href="gistutil.c.html#LN232"><span class='Ref_to_Parameter'>isnull2</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="gistutil.c.html#LN233"><span class='Ref_to_Parameter'>dstisnull</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="gistutil.c.html#LN233"><span class='Ref_to_Parameter'>dst</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN231"><span class='Ref_to_Parameter'>isnull1</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE </span><span class='Operator'>&& </span><a href="gistutil.c.html#LN232"><span class='Ref_to_Parameter'>isnull2</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="gistutil.c.html#LN231"><span class='Ref_to_Parameter'>entry1</span></a><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="gistutil.c.html#LN232"><span class='Ref_to_Parameter'>entry2</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN231"><span class='Ref_to_Parameter'>isnull1</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="gistutil.c.html#LN231"><span class='Ref_to_Parameter'>entry1</span></a><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="gistutil.c.html#LN231"><span class='Ref_to_Parameter'>entry1</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="gistutil.c.html#LN232"><span class='Ref_to_Parameter'>entry2</span></a><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN160"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="gistutil.c.html#LN232"><span class='Ref_to_Parameter'>entry2</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Operator'>*</span><a href="gistutil.c.html#LN233"><span class='Ref_to_Parameter'>dstisnull</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="gistutil.c.html#LN233"><span class='Ref_to_Parameter'>dst</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN230"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN85"><span class='Ref_to_Member'>unionFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN230"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], 
</span>                                 <a href="gistutil.c.html#LN230"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN230"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], 
</span>                                 <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN241"><span class='Ref_To_Local'>evec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN242"><span class='Ref_To_Local'>dstsize</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end gistMakeUnionKey &raquo; </span> 
 
<span class='Keyword'>bool 
</span><a name="LN278"></a><span class='Declare_Function'>gistKeyIsEQ</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attno</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN280"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN514"><span class='Ref_to_Proto'>FunctionCall3Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN278"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN90"><span class='Ref_to_Member'>equalFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN278"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], 
</span>                      <a href="gistutil.c.html#LN278"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN278"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], 
</span>                      <a href="gistutil.c.html#LN278"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN278"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN280"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="gistutil.c.html#LN280"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Decompress all keys in tuple 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN293"></a><span class='Declare_Function'>gistDeCompressAtt</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>p</span><span class='Delimiter'>, 
</span><a name="LN294"></a>                  <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>o</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attdata</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN296"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN293"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN300"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span> 
        <a href="gistutil.c.html#LN300"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN293"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN293"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN294"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/gist_private.h.html#LN467"><span class='Ref_to_Proto'>gistdentryinit</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN293"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN294"><span class='Ref_to_Parameter'>attdata</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                       <a href="gistutil.c.html#LN300"><span class='Ref_To_Local'>datum</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN293"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN293"><span class='Ref_to_Parameter'>p</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN294"><span class='Ref_to_Parameter'>o</span></a><span class='Delimiter'>, 
</span>                       <span class='Boolean'>FALSE</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN294"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN296"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Forms union of oldtup and addtup, if union == oldtup then return NULL 
 */ 
</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> 
<a name="LN313"></a><span class='Declare_Function'>gistgetadjusted</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>addtup</span><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN315"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>neednew</span> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span><a name="LN316"></a>    <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>   <span class='Declare_Local'>oldentries</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>], 
</span><a name="LN317"></a>                <span class='Declare_Local'>addentries</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN318"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>oldisnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>], 
</span><a name="LN319"></a>                <span class='Declare_Local'>addisnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN320"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>attr</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN321"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN322"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>newtup</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN323"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN292"><span class='Ref_to_Func'>gistDeCompressAtt</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN316"><span class='Ref_To_Local'>oldentries</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN318"><span class='Ref_To_Local'>oldisnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN292"><span class='Ref_to_Func'>gistDeCompressAtt</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>addtup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN317"><span class='Ref_To_Local'>addentries</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN319"><span class='Ref_To_Local'>addisnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="gistutil.c.html#LN229"><span class='Ref_to_Func'>gistMakeUnionKey</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                         <a href="gistutil.c.html#LN316"><span class='Ref_To_Local'>oldentries</span></a> <span class='Operator'>+ </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN318"><span class='Ref_To_Local'>oldisnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                         <a href="gistutil.c.html#LN317"><span class='Ref_To_Local'>addentries</span></a> <span class='Operator'>+ </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN319"><span class='Ref_To_Local'>addisnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                         <a href="gistutil.c.html#LN320"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>+ </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN321"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>+ </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN315"><span class='Ref_To_Local'>neednew</span></a><span class='Parentheses'>) 
</span>            <span class='Comment_Multi_Line'>/* we already need new key, so we can skip check */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN321"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Comment_Multi_Line'>/* union of key may be NULL if and only if both keys are NULL */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistutil.c.html#LN319"><span class='Ref_To_Local'>addisnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN318"><span class='Ref_To_Local'>oldisnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="gistutil.c.html#LN277"><span class='Ref_to_Func'>gistKeyIsEQ</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN316"><span class='Ref_To_Local'>oldentries</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/gist.h.html#LN122"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN320"><span class='Ref_To_Local'>attr</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN323"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
                <a href="gistutil.c.html#LN315"><span class='Ref_To_Local'>neednew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;r-&GT;rd_att-&GT;natt... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN315"><span class='Ref_To_Local'>neednew</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* need to update key */ 
</span>        <a href="gistutil.c.html#LN322"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN459"><span class='Ref_to_Proto'>gistFormTuple</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN320"><span class='Ref_To_Local'>attr</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN321"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistutil.c.html#LN322"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN313"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gistutil.c.html#LN322"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistgetadjusted &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Search an upper index page for the entry with lowest penalty for insertion 
 * of the new index key contained in "it". 
 * 
 * Returns the index of the page entry to insert into. 
 */ 
</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> 
<a name="LN371"></a><span class='Declare_Function'>gistchoose</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>p</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>it</span><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* it has compressed entry */ 
</span><a name="LN372"></a>           <a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN374"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN375"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN376"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN377"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>best_penalty</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN378"></a>    <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>   <span class='Declare_Local'>entry</span><span class='Delimiter'>, 
</span><a name="LN379"></a>                <span class='Declare_Local'>identry</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN380"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN381"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>keep_current_best</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/gist.h.html#LN131"><span class='Ref_to_Macro'>GistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>p</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN292"><span class='Ref_to_Func'>gistDeCompressAtt</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN372"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, 
</span>                      <a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>it</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                      <a href="gistutil.c.html#LN379"><span class='Ref_To_Local'>identry</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN380"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we'll return FirstOffsetNumber if page is empty (shouldn't happen) */ 
</span>    <a href="gistutil.c.html#LN374"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The index may have multiple columns, and there's a penalty value for 
     * each column.  The penalty associated with a column that appears earlier 
     * in the index definition is strictly more important than the penalty of 
     * a column that appears later in the index definition. 
     * 
     * best_penalty[j] is the best penalty we have seen so far for column j, 
     * or -1 when we haven't yet examined column j.  Array entries to the 
     * right of the first -1 are undefined. 
     */ 
</span>    <a href="gistutil.c.html#LN377"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we find a tuple that's exactly as good as the currently best one, we 
     * could use either one.  When inserting a lot of tuples with the same or 
     * similar keys, it's preferable to descend down the same path when 
     * possible, as that's more cache-friendly.  On the other hand, if all 
     * inserts land on the same leaf page after a split, we're never going to 
     * insert anything to the other half of the split, and will end up using 
     * only 50% of the available space.  Distributing the inserts evenly would 
     * lead to better space usage, but that hurts cache-locality during 
     * insertion.  To get the best of both worlds, when we find a tuple that's 
     * exactly as good as the previous best, choose randomly whether to stick 
     * to the old best, or use the new one.  Once we decide to stick to the 
     * old best, we keep sticking to it for any subsequent equally good tuples 
     * we might find.  This favors tuples with low offsets, but still allows 
     * some inserts to go to other equally-good subtrees. 
     * 
     * keep_current_best is -1 if we haven't yet had to make a random choice 
     * whether to keep the current best tuple.  If we have done so, and 
     * decided to keep it, keep_current_best is 1; if we've decided to 
     * replace, keep_current_best is 0.  (This state will be reset to -1 as 
     * soon as we've made the replacement, but sometimes we make the choice in 
     * advance of actually finding a replacement best tuple.) 
     */ 
</span>    <a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop over tuples on page. 
     */ 
</span>    <a href="gistutil.c.html#LN375"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistutil.c.html#LN375"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="gistutil.c.html#LN375"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN437"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>p</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>p</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN438"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>zero_penalty</span><span class='Delimiter'>; 
</span><a name="LN439"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
        <a href="gistutil.c.html#LN438"><span class='Ref_To_Local'>zero_penalty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Loop over index attributes. */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN446"></a>            <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span><a name="LN447"></a>            <span class='Keyword'>float</span>       <span class='Declare_Local'>usize</span><span class='Delimiter'>; 
</span><a name="LN448"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>IsNull</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Compute penalty for this column. */ 
</span>            <a href="gistutil.c.html#LN446"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN437"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN372"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN448"><span class='Ref_To_Local'>IsNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/gist_private.h.html#LN467"><span class='Ref_to_Proto'>gistdentryinit</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN372"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN378"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN446"><span class='Ref_To_Local'>datum</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>p</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                           <span class='Boolean'>FALSE</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN448"><span class='Ref_To_Local'>IsNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN447"><span class='Ref_To_Local'>usize</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist_private.h.html#LN471"><span class='Ref_to_Proto'>gistpenalty</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN372"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN378"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN448"><span class='Ref_To_Local'>IsNull</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="gistutil.c.html#LN379"><span class='Ref_To_Local'>identry</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], </span><a href="gistutil.c.html#LN380"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN447"><span class='Ref_To_Local'>usize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="gistutil.c.html#LN438"><span class='Ref_To_Local'>zero_penalty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN377"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="gistutil.c.html#LN447"><span class='Ref_To_Local'>usize</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN377"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * New best penalty for column.  Tentatively select this tuple 
                 * as the target, and record the best penalty.  Then reset the 
                 * next column's penalty to "unknown" (and indirectly, the 
                 * same for all the ones to its right).  This will force us to 
                 * adopt this tuple's penalty values as the best for all the 
                 * remaining columns during subsequent loop iterations. 
                 */ 
</span>                <a href="gistutil.c.html#LN374"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="gistutil.c.html#LN377"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistutil.c.html#LN447"><span class='Ref_To_Local'>usize</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="gistutil.c.html#LN377"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* we have new best, so reset keep-it decision */ 
</span>                <a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN377"><span class='Ref_To_Local'>best_penalty</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="gistutil.c.html#LN447"><span class='Ref_To_Local'>usize</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The current tuple is exactly as good for this column as the 
                 * best tuple seen so far.  The next iteration of this loop 
                 * will compare the next column. 
                 */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The current tuple is worse for this column than the best 
                 * tuple seen so far.  Skip the remaining columns and move on 
                 * to the next tuple, if any. 
                 */ 
</span>                <a href="gistutil.c.html#LN438"><span class='Ref_To_Local'>zero_penalty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* so outer loop won't exit */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for j=0;j&LT;r-&GT;rd_att-&GT;natt... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If we looped past the last column, and did not update "result", 
         * then this tuple is exactly as good as the prior best tuple. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN439"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>== </span><a href="gistutil.c.html#LN371"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>&& </span><a href="gistutil.c.html#LN374"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* we didn't make the random choice yet for this old best */ 
</span>                <a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN199"><span class='Ref_to_Const'>MAX_RANDOM_VALUE</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>))</span> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* we choose to use the new tuple */ 
</span>                <a href="gistutil.c.html#LN374"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN376"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* choose again if there are even more exactly-as-good ones */ 
</span>                <a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we find a tuple with zero penalty for all columns, and we've 
         * decided we don't want to search for another tuple with equal 
         * penalty, there's no need to examine remaining tuples; just break 
         * out of the loop and return it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN438"><span class='Ref_To_Local'>zero_penalty</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* we didn't make the random choice yet for this old best */ 
</span>                <a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN199"><span class='Ref_to_Const'>MAX_RANDOM_VALUE</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>))</span> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN381"><span class='Ref_To_Local'>keep_current_best</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=FirstOffsetNumber;i... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="gistutil.c.html#LN374"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistchoose &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * initialize a GiST entry with a decompressed version of key 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN543"></a><span class='Declare_Function'>gistdentryinit</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nkey</span><span class='Delimiter'>, </span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>e</span><span class='Delimiter'>, 
</span><a name="LN544"></a>               <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>k</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>pg</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>o</span><span class='Delimiter'>, 
</span><a name="LN545"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>l</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistutil.c.html#LN545"><span class='Ref_to_Parameter'>isNull</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN549"></a>        <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>dep</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/gist.h.html#LN168"><span class='Ref_to_Macro'>gistentryinit</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>e</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>k</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>pg</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>o</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN545"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN510"><span class='Ref_to_Proto'>FunctionCall1Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN87"><span class='Ref_to_Member'>decompressFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>nkey</span></a><span class='Delimiter'>], 
</span>                                           <a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>nkey</span></a><span class='Delimiter'>], 
</span>                                              <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>e</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* decompressFn may just return the given pointer */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a> <span class='Operator'>!= </span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>e</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/gist.h.html#LN168"><span class='Ref_to_Macro'>gistentryinit</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>e</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN122"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN123"><span class='Ref_to_Member'>rel</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN124"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN125"><span class='Ref_to_Member'>offset</span></a><span class='Delimiter'>, 
</span>                          <a href="gistutil.c.html#LN549"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN126"><span class='Ref_to_Member'>leafkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/access/gist.h.html#LN168"><span class='Ref_to_Macro'>gistentryinit</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="gistutil.c.html#LN543"><span class='Ref_to_Parameter'>e</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>pg</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN544"><span class='Ref_to_Parameter'>o</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN545"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistdentryinit &raquo; </span> 
 
<a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> 
<a name="LN566"></a><span class='Declare_Function'>gistFormTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, 
</span><a name="LN567"></a>              <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>attdata</span><span class='Delimiter'>[], </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>[], </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isleaf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN569"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>compatt</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN570"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN571"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Call the compress method on each attribute. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN566"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN567"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="gistutil.c.html#LN569"><span class='Ref_To_Local'>compatt</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN582"></a>            <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>   <span class='Declare_Local'>centry</span><span class='Delimiter'>; 
</span><a name="LN583"></a>            <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>cep</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/gist.h.html#LN168"><span class='Ref_to_Macro'>gistentryinit</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN582"><span class='Ref_To_Local'>centry</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN567"><span class='Ref_to_Parameter'>attdata</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="gistutil.c.html#LN566"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                          <a href="gistutil.c.html#LN567"><span class='Ref_to_Parameter'>isleaf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN583"><span class='Ref_To_Local'>cep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN510"><span class='Ref_to_Proto'>FunctionCall1Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN566"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN86"><span class='Ref_to_Member'>compressFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <a href="gistutil.c.html#LN566"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                                  <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN582"><span class='Ref_To_Local'>centry</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN569"><span class='Ref_To_Local'>compatt</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN570"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistutil.c.html#LN583"><span class='Ref_To_Local'>cep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN122"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="gistutil.c.html#LN571"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../common/indextuple.c.html#LN35"><span class='Ref_to_Func'>index_form_tuple</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN566"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN569"><span class='Ref_To_Local'>compatt</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN567"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The offset number on tuples on internal pages is unused. For historical 
     * reasons, it is set to 0xffff. 
     */ 
</span>    <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="gistutil.c.html#LN571"><span class='Ref_To_Local'>res</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0xffff</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="gistutil.c.html#LN571"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistFormTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * initialize a GiST entry with fetched value in key field 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN609"></a><span class='Declare_Function'>gistFetchAtt</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nkey</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>k</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN611"></a>    <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>   <span class='Declare_Local'>fentry</span><span class='Delimiter'>; 
</span><a name="LN612"></a>    <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>fep</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/gist.h.html#LN168"><span class='Ref_to_Macro'>gistentryinit</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN611"><span class='Ref_To_Local'>fentry</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN609"><span class='Ref_to_Parameter'>k</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN609"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN612"><span class='Ref_To_Local'>fep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN510"><span class='Ref_to_Proto'>FunctionCall1Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN609"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN92"><span class='Ref_to_Member'>fetchFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN609"><span class='Ref_to_Parameter'>nkey</span></a><span class='Delimiter'>], 
</span>                                          <a href="gistutil.c.html#LN609"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN609"><span class='Ref_to_Parameter'>nkey</span></a><span class='Delimiter'>], 
</span>                                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN611"><span class='Ref_To_Local'>fentry</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fetchFn set 'key', return it to the caller */ 
</span>    <span class='Control'>return</span> <a href="gistutil.c.html#LN612"><span class='Ref_To_Local'>fep</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN122"><span class='Ref_to_Member'>key</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fetch all keys in tuple. 
 * Returns a new HeapTuple containing the originally-indexed data. 
 */ 
</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN630"></a><span class='Declare_Function'>gistFetchTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN632"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN78"><span class='Ref_to_Member'>tempCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN633"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>fetchatt</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN634"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN635"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN639"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span> 
        <a href="gistutil.c.html#LN639"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN80"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN634"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN92"><span class='Ref_to_Member'>fetchFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistutil.c.html#LN634"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <a href="gistutil.c.html#LN633"><span class='Ref_To_Local'>fetchatt</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="gistutil.c.html#LN608"><span class='Ref_to_Func'>gistFetchAtt</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>giststate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN639"><span class='Ref_To_Local'>datum</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="gistutil.c.html#LN633"><span class='Ref_To_Local'>fetchatt</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Index-only scans not supported for this column. Since the 
             * planner chose an index-only scan anyway, it is not interested 
             * in this column, and we can replace it with a NULL. 
             */ 
</span>            <a href="gistutil.c.html#LN634"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="gistutil.c.html#LN633"><span class='Ref_To_Local'>fetchatt</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;r-&GT;rd_att-&GT;natt... &raquo; </span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN632"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN630"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN81"><span class='Ref_to_Member'>fetchTupdesc</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN633"><span class='Ref_To_Local'>fetchatt</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN634"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistFetchTuple &raquo; </span> 
 
<span class='Keyword'>float 
</span><a name="LN667"></a><span class='Declare_Function'>gistpenalty</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN75"><span class='Ref_to_Struct'>GISTSTATE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>giststate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attno</span><span class='Delimiter'>, 
</span><a name="LN668"></a>            <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>orig</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNullOrig</span><span class='Delimiter'>, 
</span><a name="LN669"></a>            <a href="../../../include/access/gist.h.html#LN120"><span class='Ref_to_Struct'>GISTENTRY</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>add</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNullAdd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN671"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>penalty</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN667"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN88"><span class='Ref_to_Member'>penaltyFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN667"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN60"><span class='Ref_to_Member'>fn_strict</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE </span><span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="gistutil.c.html#LN668"><span class='Ref_to_Parameter'>isNullOrig</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE </span><span class='Operator'>&& </span><a href="gistutil.c.html#LN669"><span class='Ref_to_Parameter'>isNullAdd</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/fmgr.h.html#LN514"><span class='Ref_to_Proto'>FunctionCall3Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN667"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN88"><span class='Ref_to_Member'>penaltyFn</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN667"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], 
</span>                          <a href="gistutil.c.html#LN667"><span class='Ref_to_Parameter'>giststate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist_private.h.html#LN95"><span class='Ref_to_Member'>supportCollation</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN667"><span class='Ref_to_Parameter'>attno</span></a><span class='Delimiter'>], 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN668"><span class='Ref_to_Parameter'>orig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN669"><span class='Ref_to_Parameter'>add</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* disallow negative or NaN penalty */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/test/expected/pgtypeslib-nan_test.c.html#LN30"><span class='Ref_to_Macro'>isnan</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN668"><span class='Ref_to_Parameter'>isNullOrig</span></a> <span class='Operator'>&& </span><a href="gistutil.c.html#LN669"><span class='Ref_to_Parameter'>isNullAdd</span></a><span class='Parentheses'>) 
</span>        <a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* try to prevent mixing null and non-null values */ 
</span>        <a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN56"><span class='Ref_to_Proto'>get_float4_infinity</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="gistutil.c.html#LN671"><span class='Ref_To_Local'>penalty</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistpenalty &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a new index page 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN700"></a><span class='Declare_Function'>GISTInitBuffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>b</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN702"></a>    <a href="../../../include/access/gist.h.html#LN65"><span class='Ref_to_Typedef'>GISTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN703"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN704"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageSize</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN704"><span class='Ref_To_Local'>pageSize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN700"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="gistutil.c.html#LN703"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN700"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN703"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN704"><span class='Ref_To_Local'>pageSize</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN57"><span class='Ref_to_Struct'>GISTPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN702"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN129"><span class='Ref_to_Macro'>GistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN703"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* page was already zeroed by PageInit, so this is not needed: */ 
</span>    <span class='Comment_Multi_Line'>/* memset(&(opaque-&GT;nsn), 0, sizeof(GistNSN)); */ 
</span>    <a href="gistutil.c.html#LN702"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN60"><span class='Ref_to_Member'>rightlink</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="gistutil.c.html#LN702"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN61"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN700"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>; 
</span>    <a href="gistutil.c.html#LN702"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/gist.h.html#LN62"><span class='Ref_to_Member'>gist_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN73"><span class='Ref_to_Const'>GIST_PAGE_ID</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Verify that a freshly-read page looks sane. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN722"></a><span class='Declare_Function'>gistcheckpage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN724"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN722"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ReadBuffer verifies that every newly-read page passes 
     * PageHeaderIsValid, which means it either contains a reasonably sane 
     * page header or is all-zero.  We have to defend against the all-zero 
     * case, however. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN724"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" contains unexpected zero page at block %u"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN722"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN722"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Please REINDEX it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Additionally check that the special area looks sane. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN296"><span class='Ref_to_Macro'>PageGetSpecialSize</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN724"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN57"><span class='Ref_to_Struct'>GISTPageOpaqueData</span></a><span class='Parentheses'>)))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" contains corrupted page at block %u"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN722"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN722"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Please REINDEX it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistcheckpage &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate a new page (either by recycling, or by extending the index file) 
 * 
 * The returned buffer is already pinned and exclusive-locked 
 * 
 * Caller is responsible for initializing the page by calling GISTInitBuffer 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN761"></a><span class='Declare_Function'>gistNewBuffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>r</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN763"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN764"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needLock</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First, try to get a page from FSM */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN769"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../../include/storage/indexfsm.h.html#LN19"><span class='Ref_to_Proto'>GetFreeIndexPage</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN769"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* nothing left in FSM */ 
</span> 
        <a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN769"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have to guard against the possibility that someone else already 
         * recycled this page; the buffer may be locked if so. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN782"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN782"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OK to use, if never initialized */ 
</span> 
            <a href="../../../include/access/gist_private.h.html#LN443"><span class='Ref_to_Proto'>gistcheckpage</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/gist.h.html#LN134"><span class='Ref_to_Macro'>GistPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN782"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OK to use */ 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN44"><span class='Ref_to_Const'>GIST_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Can't use it, so release buffer and try again */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Must extend the file */ 
</span>    <a href="gistutil.c.html#LN764"><span class='Ref_To_Local'>needLock</span></a> <span class='Operator'>= !</span><a href="../../../include/utils/rel.h.html#LN523"><span class='Ref_to_Macro'>RELATION_IS_LOCAL</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN764"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/gist_private.h.html#LN43"><span class='Ref_to_Const'>GIST_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN764"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN761"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="gistutil.c.html#LN763"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistNewBuffer &raquo; </span> 
 
<a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>* 
</span><a name="LN815"></a><span class='Declare_Function'>gistoptions</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>validate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN817"></a>    <a href="../../../include/access/reloptions.h.html#LN73"><span class='Ref_to_Struct'>relopt_value</span></a> <span class='Operator'>*</span><span class='Declare_Local'>options</span><span class='Delimiter'>; 
</span><a name="LN818"></a>    <a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rdopts</span><span class='Delimiter'>; 
</span><a name="LN819"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numoptions</span><span class='Delimiter'>; 
</span><a name="LN820"></a>    <span class='Keyword'>static const </span><a href="../../../include/access/reloptions.h.html#LN122"><span class='Ref_to_Typedef'>relopt_parse_elt</span></a> <span class='Declare_Local'>tab</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Delimiter'>{</span><span class='String'>"fillfactor"</span><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN31"><span class='Ref_to_EnumConst'>RELOPT_TYPE_INT</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a><span class='Delimiter'>, </span><a href="../../../bin/pgbench/pgbench.c.html#LN111"><span class='Ref_to_Global_Var'>fillfactor</span></a><span class='Parentheses'>)</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"buffering"</span><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN33"><span class='Ref_to_EnumConst'>RELOPT_TYPE_STRING</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a><span class='Delimiter'>, </span>bufferingModeOffset<span class='Parentheses'>)</span><span class='Delimiter'>} 
</span>    <span class='Delimiter'>}; 
</span> 
    <a href="gistutil.c.html#LN817"><span class='Ref_To_Local'>options</span></a> <span class='Operator'>= </span><a href="../../../include/access/reloptions.h.html#LN263"><span class='Ref_to_Proto'>parseRelOptions</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN815"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN815"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN44"><span class='Ref_to_EnumConst'>RELOPT_KIND_GIST</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="gistutil.c.html#LN819"><span class='Ref_To_Local'>numoptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if none set, we're done */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN819"><span class='Ref_To_Local'>numoptions</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN818"><span class='Ref_To_Local'>rdopts</span></a> <span class='Operator'>= </span><a href="../../../include/access/reloptions.h.html#LN265"><span class='Ref_to_Proto'>allocateReloptStruct</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN817"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN819"><span class='Ref_To_Local'>numoptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/reloptions.h.html#LN267"><span class='Ref_to_Proto'>fillRelOptions</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistutil.c.html#LN818"><span class='Ref_To_Local'>rdopts</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/gist_private.h.html#LN372"><span class='Ref_to_Struct'>GiSTOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="gistutil.c.html#LN817"><span class='Ref_To_Local'>options</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN819"><span class='Ref_To_Local'>numoptions</span></a><span class='Delimiter'>, 
</span>                   <a href="gistutil.c.html#LN815"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN820"><span class='Ref_To_Local'>tab</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN820"><span class='Ref_To_Local'>tab</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN817"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="gistutil.c.html#LN818"><span class='Ref_To_Local'>rdopts</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistoptions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  gistproperty() -- Check boolean properties of indexes. 
 * 
 * This is optional for most AMs, but is required for GiST because the core 
 * property code doesn't support AMPROP_DISTANCE_ORDERABLE.  We also handle 
 * AMPROP_RETURNABLE here to save opening the rel to call gistcanreturn. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN850"></a><span class='Declare_Function'>gistproperty</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>index_oid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attno</span><span class='Delimiter'>, 
</span><a name="LN851"></a>             <a href="../../../include/access/amapi.h.html#LN33"><span class='Ref_to_Enum'>IndexAMProperty</span></a> <span class='Declare_Parameter'>prop</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>propname</span><span class='Delimiter'>, 
</span><a name="LN852"></a>             <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN854"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN855"></a>    <a href="../../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a> rd_index <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span><span class='Delimiter'>; 
</span><a name="LN856"></a>    <a href="../../../include/catalog/pg_opclass.h.html#LN67"><span class='Ref_to_Typedef'>Form_pg_opclass</span></a> <span class='Declare_Local'>rd_opclass</span><span class='Delimiter'>; 
</span><a name="LN857"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span><a name="LN858"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>disnull</span><span class='Delimiter'>; 
</span><a name="LN859"></a>    <a href="../../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indclass</span><span class='Delimiter'>; 
</span><a name="LN860"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>opclass</span><span class='Delimiter'>, 
</span><a name="LN861"></a>                <span class='Declare_Local'>opfamily</span><span class='Delimiter'>, 
</span><a name="LN862"></a>                <span class='Declare_Local'>opcintype</span><span class='Delimiter'>; 
</span><a name="LN863"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>procno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Only answer column-level inquiries */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN850"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Currently, GiST distance-ordered scans require that there be a distance 
     * function in the opclass with the default types (i.e. the one loaded 
     * into the relcache entry, see initGISTstate).  So we assume that if such 
     * a function exists, then there's a reason for it (rather than grubbing 
     * through all the opfamily's operators to find an ordered one). 
     * 
     * Essentially the same code can test whether we support returning the 
     * column data, since that's true if the opclass provides a fetch proc. 
     */ 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN851"><span class='Ref_to_Parameter'>prop</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/access/amapi.h.html#LN41"><span class='Ref_to_EnumConst'>AMPROP_DISTANCE_ORDERABLE</span></a><span class='Operator'>: 
</span>            <a href="gistutil.c.html#LN863"><span class='Ref_To_Local'>procno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN34"><span class='Ref_to_Const'>GIST_DISTANCE_PROC</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/amapi.h.html#LN42"><span class='Ref_to_EnumConst'>AMPROP_RETURNABLE</span></a><span class='Operator'>: 
</span>            <a href="gistutil.c.html#LN863"><span class='Ref_To_Local'>procno</span></a> <span class='Operator'>= </span><a href="../../../include/access/gist.h.html#LN35"><span class='Ref_to_Const'>GIST_FETCH_PROC</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* First we need to know the column's opclass. */ 
</span> 
    <a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN65"><span class='Ref_to_EnumConst'>INDEXRELID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN850"><span class='Ref_to_Parameter'>index_oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="gistutil.c.html#LN852"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    rd_index <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* caller is supposed to guarantee this */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistutil.c.html#LN850"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="gistutil.c.html#LN850"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>&LT;= </span>rd_index<span class='Operator'>-&GT;</span>indnatts<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN857"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN65"><span class='Ref_to_EnumConst'>INDEXRELID</span></a><span class='Delimiter'>, </span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/catalog/pg_index.h.html#LN88"><span class='Ref_to_Const'>Anum_pg_index_indclass</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="gistutil.c.html#LN858"><span class='Ref_To_Local'>disnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="gistutil.c.html#LN858"><span class='Ref_To_Local'>disnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN859"><span class='Ref_To_Local'>indclass</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN857"><span class='Ref_To_Local'>datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="gistutil.c.html#LN860"><span class='Ref_To_Local'>opclass</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN859"><span class='Ref_To_Local'>indclass</span></a><span class='Operator'>-&GT;</span><a href="../../../include/c.h.html#LN485"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>[</span><a href="gistutil.c.html#LN850"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now look up the opclass family and input datatype. */ 
</span> 
    <a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN47"><span class='Ref_to_EnumConst'>CLAOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN860"><span class='Ref_To_Local'>opclass</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="gistutil.c.html#LN852"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="gistutil.c.html#LN856"><span class='Ref_To_Local'>rd_opclass</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_opclass.h.html#LN67"><span class='Ref_to_Typedef'>Form_pg_opclass</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="gistutil.c.html#LN861"><span class='Ref_To_Local'>opfamily</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN856"><span class='Ref_To_Local'>rd_opclass</span></a><span class='Operator'>-&GT;</span>opcfamily<span class='Delimiter'>; 
</span>    <a href="gistutil.c.html#LN862"><span class='Ref_To_Local'>opcintype</span></a> <span class='Operator'>= </span><a href="gistutil.c.html#LN856"><span class='Ref_To_Local'>rd_opclass</span></a><span class='Operator'>-&GT;</span>opcintype<span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN854"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And now we can check whether the function is provided. */ 
</span> 
    <span class='Operator'>*</span><a href="gistutil.c.html#LN852"><span class='Ref_to_Parameter'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN179"><span class='Ref_to_Macro'>SearchSysCacheExists4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN38"><span class='Ref_to_EnumConst'>AMPROCNUM</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN861"><span class='Ref_To_Local'>opfamily</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN862"><span class='Ref_To_Local'>opcintype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN862"><span class='Ref_To_Local'>opcintype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="gistutil.c.html#LN863"><span class='Ref_To_Local'>procno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end gistproperty &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Temporary and unlogged GiST indexes are not WAL-logged, but we need LSNs 
 * to detect concurrent page splits anyway. This function provides a fake 
 * sequence of LSNs for that purpose. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN945"></a><span class='Declare_Function'>gistGetFakeLSN</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN947"></a>    <span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Local'>counter</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="gistutil.c.html#LN945"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Temporary relations are only accessible in our session, so a simple 
         * backend-local counter will do. 
         */ 
</span>        <span class='Control'>return</span> <a href="gistutil.c.html#LN947"><span class='Ref_To_Local'>counter</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Unlogged relations are accessible from other backends, and survive 
         * (clean) restarts. GetFakeLSNForUnloggedRel() handles that for us. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="gistutil.c.html#LN945"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN170"><span class='Ref_to_Const'>RELPERSISTENCE_UNLOGGED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/access/xlog.h.html#LN260"><span class='Ref_to_Proto'>GetFakeLSNForUnloggedRel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end gistGetFakeLSN &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>