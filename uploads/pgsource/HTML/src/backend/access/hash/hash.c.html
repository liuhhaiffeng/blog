<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\hash\hash.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\hash\hash.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * hash.c 
 *    Implementation of Margo Seltzer's Hashing package for postgres. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/hash/hash.c 
 * 
 * NOTES 
 *    This file contains only the public interface routines. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/hash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/hash_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/relscan.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/vacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/plancat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/index_selfuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Working state for hashbuild and its callback */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN36"></a>    <a href="hashsort.c.html#LN35"><span class='Ref_to_Struct'>HSpool</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>spool</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* NULL if not using spooling */ 
</span><a name="LN37"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>indtuples</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* # tuples accepted into index */ 
</span><a name="LN38"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>heapRel</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* heap relation descriptor */ 
</span><a name="LN39"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>HashBuildState</span><span class='Delimiter'>; 
</span> 
<a name="LN41"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>hashbuildCallback</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN42"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>htup</span><span class='Delimiter'>, 
</span><a name="LN43"></a>                  <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, 
</span><a name="LN44"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN45"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>tupleIsAlive</span><span class='Delimiter'>, 
</span><a name="LN46"></a>                  <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Hash handler function: return IndexAmRoutine with access method parameters 
 * and callbacks. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN54"></a><span class='Declare_Function'>hashhandler</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN56"></a>    <a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amroutine</span> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN166"><span class='Ref_to_Member'>amstrategies</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN290"><span class='Ref_to_Const'>HTMaxStrategyNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN168"><span class='Ref_to_Member'>amsupport</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN298"><span class='Ref_to_Const'>HASHNProcs</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN172"><span class='Ref_to_Member'>amcanorderbyop</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN174"><span class='Ref_to_Member'>amcanbackward</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN176"><span class='Ref_to_Member'>amcanunique</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN178"><span class='Ref_to_Member'>amcanmulticol</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN180"><span class='Ref_to_Member'>amoptionalkey</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN182"><span class='Ref_to_Member'>amsearcharray</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN184"><span class='Ref_to_Member'>amsearchnulls</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN186"><span class='Ref_to_Member'>amstorage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN188"><span class='Ref_to_Member'>amclusterable</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN190"><span class='Ref_to_Member'>ampredlocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN192"><span class='Ref_to_Member'>amcanparallel</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN194"><span class='Ref_to_Member'>amkeytype</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN197"><span class='Ref_to_Member'>ambuild</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN101"><span class='Ref_to_Func'>hashbuild</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN198"><span class='Ref_to_Member'>ambuildempty</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN184"><span class='Ref_to_Func'>hashbuildempty</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN199"><span class='Ref_to_Member'>aminsert</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN235"><span class='Ref_to_Func'>hashinsert</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN200"><span class='Ref_to_Member'>ambulkdelete</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN316"><span class='Ref_to_Proto'>hashbulkdelete</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN201"><span class='Ref_to_Member'>amvacuumcleanup</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN320"><span class='Ref_to_Proto'>hashvacuumcleanup</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN202"><span class='Ref_to_Member'>amcanreturn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN203"><span class='Ref_to_Member'>amcostestimate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/index_selfuncs.h.html#LN40"><span class='Ref_to_Proto'>hashcostestimate</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN204"><span class='Ref_to_Member'>amoptions</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN288"><span class='Ref_to_Func'>hashoptions</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN205"><span class='Ref_to_Member'>amproperty</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN206"><span class='Ref_to_Member'>amvalidate</span></a> <span class='Operator'>= </span><a href="hashvalidate.c.html#LN42"><span class='Ref_to_Func'>hashvalidate</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN207"><span class='Ref_to_Member'>ambeginscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN312"><span class='Ref_to_Proto'>hashbeginscan</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN208"><span class='Ref_to_Member'>amrescan</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN313"><span class='Ref_to_Proto'>hashrescan</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN209"><span class='Ref_to_Member'>amgettuple</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN266"><span class='Ref_to_Func'>hashgettuple</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN210"><span class='Ref_to_Member'>amgetbitmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN311"><span class='Ref_to_Proto'>hashgetbitmap</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN211"><span class='Ref_to_Member'>amendscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN315"><span class='Ref_to_Proto'>hashendscan</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN212"><span class='Ref_to_Member'>ammarkpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN213"><span class='Ref_to_Member'>amrestrpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN216"><span class='Ref_to_Member'>amestimateparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN217"><span class='Ref_to_Member'>aminitparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN218"><span class='Ref_to_Member'>amparallelrescan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN56"><span class='Ref_To_Local'>amroutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashhandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  hashbuild() -- build a new hash index. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>* 
</span><a name="LN102"></a><span class='Declare_Function'>hashbuild</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heap</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN104"></a>    <a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN105"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>relpages</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>reltuples</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>allvisfrac</span><span class='Delimiter'>; 
</span><a name="LN108"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>num_buckets</span><span class='Delimiter'>; 
</span><a name="LN109"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>sort_threshold</span><span class='Delimiter'>; 
</span><a name="LN110"></a>    <a href="hash.c.html#LN34"><span class='Ref_to_Typedef'>HashBuildState</span></a> <span class='Declare_Local'>buildstate</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We expect to be called exactly once for any index relation. If that's 
     * not the case, big trouble's what we have. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"index \"%s\" already contains data"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Estimate the number of rows currently present in the table */ 
</span>    <a href="../../../include/optimizer/plancat.h.html#LN32"><span class='Ref_to_Proto'>estimate_rel_size</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN105"><span class='Ref_To_Local'>relpages</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN106"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN107"><span class='Ref_To_Local'>allvisfrac</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the hash index metadata page and initial buckets */ 
</span>    <a href="hash.c.html#LN108"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN333"><span class='Ref_to_Func'>_hash_init</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN106"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we just insert the tuples into the index in scan order, then 
     * (assuming their hash codes are pretty random) there will be no locality 
     * of access to the index, and if the index is bigger than available RAM 
     * then we'll thrash horribly.  To prevent that scenario, we can sort the 
     * tuples by (expected) bucket number.  However, such a sort is useless 
     * overhead when the index does fit in RAM.  We choose to sort if the 
     * initial index size exceeds maintenance_work_mem, or the number of 
     * buffers usable for the index, whichever is less.  (Limiting by the 
     * number of buffers should reduce thrashing between PG buffers and kernel 
     * buffers, which seems useful even if no physical I/O results.  Limiting 
     * by maintenance_work_mem is useful to allow easy testing of the sort 
     * code path, and may be useful to DBAs as an additional control knob.) 
     * 
     * NOTE: this test will need adjustment if a bucket is ever different from 
     * one page.  Also, "initial index size" accounting does not include the 
     * metapage, nor the first bitmap page. 
     */ 
</span>    <a href="hash.c.html#LN109"><span class='Ref_To_Local'>sort_threshold</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN113"><span class='Ref_to_Global_Var'>maintenance_work_mem</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>) </span><span class='Operator'>/ </span>BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>) 
</span>        <a href="hash.c.html#LN109"><span class='Ref_To_Local'>sort_threshold</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN109"><span class='Ref_To_Local'>sort_threshold</span></a><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN122"><span class='Ref_to_Global_Var'>NBuffers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hash.c.html#LN109"><span class='Ref_To_Local'>sort_threshold</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN109"><span class='Ref_To_Local'>sort_threshold</span></a><span class='Delimiter'>, </span><a href="../../storage/buffer/localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN108"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="hash.c.html#LN109"><span class='Ref_To_Local'>sort_threshold</span></a><span class='Parentheses'>)</span> 
        <a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a> <span class='Operator'>= </span><a href="hashsort.c.html#LN54"><span class='Ref_to_Func'>_h_spoolinit</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN108"><span class='Ref_To_Local'>num_buckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prepare to build the index */ 
</span>    <a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN37"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN38"><span class='Ref_to_Member'>heapRel</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* do the heap scan */ 
</span>    <a href="hash.c.html#LN106"><span class='Ref_To_Local'>reltuples</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/index.h.html#LN97"><span class='Ref_to_Proto'>IndexBuildHeapScan</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN102"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                   <a href="hash.c.html#LN41"><span class='Ref_to_Proto'>hashbuildCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* sort the tuples and insert them into the index */ 
</span>        <a href="hashsort.c.html#LN113"><span class='Ref_to_Func'>_h_indexbuild</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN38"><span class='Ref_to_Member'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashsort.c.html#LN92"><span class='Ref_to_Func'>_h_spooldestroy</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return statistics 
     */ 
</span>    <a href="hash.c.html#LN104"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN29"><span class='Ref_to_Struct'>IndexBuildResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN104"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN31"><span class='Ref_to_Member'>heap_tuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN106"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN104"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN32"><span class='Ref_to_Member'>index_tuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN110"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>.</span><a href="hash.c.html#LN37"><span class='Ref_to_Member'>indtuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hash.c.html#LN104"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashbuild &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  hashbuildempty() -- build an empty hash index in the initialization fork 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN185"></a><span class='Declare_Function'>hashbuildempty</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="hashpage.c.html#LN333"><span class='Ref_to_Func'>_hash_init</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN185"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Per-tuple callback from IndexBuildHeapScan 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN194"></a><span class='Declare_Function'>hashbuildCallback</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN195"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>htup</span><span class='Delimiter'>, 
</span><a name="LN196"></a>                  <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, 
</span><a name="LN197"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN198"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>tupleIsAlive</span><span class='Delimiter'>, 
</span><a name="LN199"></a>                  <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN201"></a>    <a href="hash.c.html#LN34"><span class='Ref_to_Typedef'>HashBuildState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>buildstate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hash.c.html#LN34"><span class='Ref_to_Typedef'>HashBuildState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hash.c.html#LN199"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; 
</span><a name="LN202"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>index_values</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN203"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>index_isnull</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN204"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* convert data to a hash key; on failure, do not insert anything */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashutil.c.html#LN324"><span class='Ref_to_Func'>_hash_convert_tuple</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN194"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                             <a href="hash.c.html#LN196"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN197"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>, 
</span>                             <a href="hash.c.html#LN202"><span class='Ref_To_Local'>index_values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN203"><span class='Ref_To_Local'>index_isnull</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Either spool the tuple for sorting, or just put it into the index */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN201"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a><span class='Parentheses'>) 
</span>        <a href="hashsort.c.html#LN102"><span class='Ref_to_Func'>_h_spool</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN201"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="hash.c.html#LN36"><span class='Ref_to_Member'>spool</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN195"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, 
</span>                 <a href="hash.c.html#LN202"><span class='Ref_To_Local'>index_values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN203"><span class='Ref_To_Local'>index_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* form an index tuple and point it at the heap tuple */ 
</span>        <a href="hash.c.html#LN204"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../common/indextuple.c.html#LN35"><span class='Ref_to_Func'>index_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN194"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="hash.c.html#LN202"><span class='Ref_To_Local'>index_values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN203"><span class='Ref_To_Local'>index_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN204"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN195"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>        <a href="hashinsert.c.html#LN34"><span class='Ref_to_Func'>_hash_doinsert</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN194"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN204"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN201"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="hash.c.html#LN38"><span class='Ref_to_Member'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN204"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hash.c.html#LN201"><span class='Ref_To_Local'>buildstate</span></a><span class='Operator'>-&GT;</span><a href="hash.c.html#LN37"><span class='Ref_to_Member'>indtuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashbuildCallback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  hashinsert() -- insert an index tuple into a hash table. 
 * 
 *  Hash on the heap tuple's key, form an index tuple with hash code. 
 *  Find the appropriate location for the new tuple, and put it there. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN236"></a><span class='Declare_Function'>hashinsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Delimiter'>, 
</span><a name="LN237"></a>           <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ht_ctid</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, 
</span><a name="LN238"></a>           <a href="../../../include/access/genam.h.html#LN110"><span class='Ref_to_Enum'>IndexUniqueCheck</span></a> <span class='Declare_Parameter'>checkUnique</span><span class='Delimiter'>, 
</span><a name="LN239"></a>           <a href="../../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN241"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>index_values</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN242"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>index_isnull</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN243"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* convert data to a hash key; on failure, do not insert anything */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashutil.c.html#LN324"><span class='Ref_to_Func'>_hash_convert_tuple</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN236"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                             <a href="hash.c.html#LN236"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN236"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>, 
</span>                             <a href="hash.c.html#LN241"><span class='Ref_To_Local'>index_values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN242"><span class='Ref_To_Local'>index_isnull</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* form an index tuple and point it at the heap tuple */ 
</span>    <a href="hash.c.html#LN243"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../common/indextuple.c.html#LN35"><span class='Ref_to_Func'>index_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN236"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hash.c.html#LN241"><span class='Ref_To_Local'>index_values</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN242"><span class='Ref_To_Local'>index_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN243"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a> <span class='Operator'>= *</span><a href="hash.c.html#LN237"><span class='Ref_to_Parameter'>ht_ctid</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashinsert.c.html#LN34"><span class='Ref_to_Func'>_hash_doinsert</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN236"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN243"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN237"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN243"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashinsert &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  hashgettuple() -- Get the next tuple in the scan. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN267"></a><span class='Declare_Function'>hashgettuple</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN269"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN270"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN271"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN272"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN273"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN274"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>current</span><span class='Delimiter'>; 
</span><a name="LN275"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Hash indexes are always lossy since we store only the hash code */ 
</span>    <a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN121"><span class='Ref_to_Member'>xs_recheck</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We hold pin but not lock on current buffer while outside the hash AM. 
     * Reacquire the read lock here. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we've already initialized this scan, we can just advance it in the 
     * appropriate direction.  If we haven't done so yet, we call a routine to 
     * get the first item in the scan. 
     */ 
</span>    <a href="hash.c.html#LN274"><span class='Ref_To_Local'>current</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN274"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * An insertion into the current index page could have happened while 
         * we didn't have read lock on it.  Re-find our position by looking 
         * for the TID we previously returned.  (Because we hold a pin on the 
         * primary bucket page, no deletions or splits could have occurred; 
         * therefore we can expect that the TID still exists in the current 
         * index page, at an offset &GT;= where we were.) 
         */ 
</span><a name="LN303"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoffnum</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN271"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN271"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN272"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN271"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't need test for old snapshot here as the current buffer is 
         * pinned, so vacuum can't clean the page. 
         */ 
</span>        <a href="hash.c.html#LN303"><span class='Ref_To_Local'>maxoffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN272"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN274"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>             <a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="hash.c.html#LN303"><span class='Ref_To_Local'>maxoffnum</span></a><span class='Delimiter'>; 
</span>             <a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN318"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
            <a href="hash.c.html#LN318"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN272"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN272"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN318"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT; </span><a href="hash.c.html#LN303"><span class='Ref_To_Local'>maxoffnum</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find scan position within index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN270"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN274"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check to see if we should kill the previously-fetched tuple. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN98"><span class='Ref_to_Member'>kill_prior_tuple</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Yes, so remember it for later. (We'll deal with all such tuples 
             * at once right after leaving the index page or at end of scan.) 
             * In case if caller reverses the indexscan direction it is quite 
             * possible that the same item might get entered multiple times. 
             * But, we don't detect that; instead, we just forget any excess 
             * entries. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a> <span class='Operator'>* 
</span>                                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN99"><span class='Ref_to_Struct'>HashScanPosItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a><span class='Delimiter'>[</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/hash.h.html#LN101"><span class='Ref_to_Member'>heapTid</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a><span class='Delimiter'>; 
</span>                <a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a><span class='Delimiter'>[</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/hash.h.html#LN102"><span class='Ref_to_Member'>indexOffset</span></a> <span class='Operator'>= 
</span>                    <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if scan-&GT;kill_prior_tupl... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Now continue the scan. 
         */ 
</span>        <a href="hash.c.html#LN275"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN32"><span class='Ref_to_Func'>_hash_next</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ItemPointerIsValid(cu... &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="hash.c.html#LN275"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN220"><span class='Ref_to_Func'>_hash_first</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Skip killed tuples if asked to. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN99"><span class='Ref_to_Member'>ignore_killed_tuples</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN275"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN274"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN272"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN272"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN273"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN275"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN32"><span class='Ref_to_Func'>_hash_next</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Release read lock on current buffer, but keep it pinned */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return current heap TID on success */ 
</span>    <a href="hash.c.html#LN267"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN118"><span class='Ref_to_Member'>xs_ctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN269"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hash.c.html#LN275"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashgettuple &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  hashgetbitmap() -- get all tuples at once 
 */ 
</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN393"></a><span class='Declare_Function'>hashgetbitmap</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../nodes/tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN395"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hash.c.html#LN393"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN396"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>ntids</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN396"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN220"><span class='Ref_to_Func'>_hash_first</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN393"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN396"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN403"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>add_tuple</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Skip killed tuples if asked to. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN393"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN99"><span class='Ref_to_Member'>ignore_killed_tuples</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN410"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN411"></a>            <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span> 
            <a href="hash.c.html#LN411"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN395"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN410"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN395"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN403"><span class='Ref_To_Local'>add_tuple</span></a> <span class='Operator'>= !</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN410"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN411"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="hash.c.html#LN403"><span class='Ref_To_Local'>add_tuple</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save tuple ID, and continue scanning */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN403"><span class='Ref_To_Local'>add_tuple</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Note we mark the tuple ID as requiring recheck */ 
</span>            <a href="../../../include/nodes/tidbitmap.h.html#LN54"><span class='Ref_to_Proto'>tbm_add_tuples</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN393"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN395"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN397"><span class='Ref_To_Local'>ntids</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="hash.c.html#LN396"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN32"><span class='Ref_to_Func'>_hash_next</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN393"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while res &raquo; </span> 
 
    <span class='Control'>return</span> <a href="hash.c.html#LN397"><span class='Ref_To_Local'>ntids</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashgetbitmap &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  hashbeginscan() -- start a scan on a hash index 
 */ 
</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> 
<a name="LN439"></a><span class='Declare_Function'>hashbeginscan</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>norderbys</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN441"></a>    <a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN442"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* no order by operators allowed */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hash.c.html#LN439"><span class='Ref_to_Parameter'>norderbys</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN441"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../index/genam.c.html#LN76"><span class='Ref_to_Func'>RelationGetIndexScan</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN439"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN439"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN439"><span class='Ref_to_Parameter'>norderbys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN109"><span class='Ref_to_Struct'>HashScanOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* set position invalid (this will cause _hash_first call) */ 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN441"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN442"><span class='Ref_To_Local'>so</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hash.c.html#LN441"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashbeginscan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  hashrescan() -- rescan an index relation 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN472"></a><span class='Declare_Function'>hashrescan</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>scankey</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nscankeys</span><span class='Delimiter'>, 
</span><a name="LN473"></a>           <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>orderbys</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>norderbys</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN475"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN476"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before leaving current page, deal with any killed items. Also, ensure 
     * that we acquire lock on current page before calling _hash_kill_items. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/hash.h.html#LN414"><span class='Ref_to_Proto'>_hash_kill_items</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hashpage.c.html#LN295"><span class='Ref_to_Func'>_hash_dropscanbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN476"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set position invalid (this will cause _hash_first call) */ 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update scan key, if a new one is given */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scankey</span></a> <span class='Operator'>&& </span><a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN90"><span class='Ref_to_Member'>numberOfKeys</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN92"><span class='Ref_to_Member'>keyData</span></a><span class='Delimiter'>, 
</span>                <a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scankey</span></a><span class='Delimiter'>, 
</span>                <a href="hash.c.html#LN472"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN90"><span class='Ref_to_Member'>numberOfKeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN475"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashrescan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  hashendscan() -- close down a scan 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN511"></a><span class='Declare_Function'>hashendscan</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN513"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hash.c.html#LN511"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN514"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hash.c.html#LN511"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before leaving current page, deal with any killed items. Also, ensure 
     * that we acquire lock on current page before calling _hash_kill_items. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/hash.h.html#LN414"><span class='Ref_to_Proto'>_hash_kill_items</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN511"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hashpage.c.html#LN295"><span class='Ref_to_Func'>_hash_dropscanbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN514"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN147"><span class='Ref_to_Member'>killedItems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN513"><span class='Ref_To_Local'>so</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN511"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashendscan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Bulk deletion of all index entries pointing to a set of heap tuples. 
 * The set of target tuples is specified via a callback routine that tells 
 * whether any given heap tuple (identified by ItemPointer) is being deleted. 
 * 
 * This function also deletes the tuples that are moved by split to other 
 * bucket. 
 * 
 * Result: a palloc'd struct containing statistical info for VACUUM displays. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>* 
</span><a name="LN546"></a><span class='Declare_Function'>hashbulkdelete</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN43"><span class='Ref_to_Struct'>IndexVacuumInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Delimiter'>, 
</span><a name="LN547"></a>               <a href="../../../include/access/genam.h.html#LN82"><span class='Ref_to_Typedef'>IndexBulkDeleteCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>callback_state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN549"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span><a name="LN550"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>tuples_removed</span><span class='Delimiter'>; 
</span><a name="LN551"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>num_index_tuples</span><span class='Delimiter'>; 
</span><a name="LN552"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>orig_ntuples</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>orig_maxbucket</span><span class='Delimiter'>; 
</span><a name="LN554"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>cur_maxbucket</span><span class='Delimiter'>; 
</span><a name="LN555"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>cur_bucket</span><span class='Delimiter'>; 
</span><a name="LN556"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN557"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN558"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>cachedmetap</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN550"><span class='Ref_To_Local'>tuples_removed</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN551"><span class='Ref_To_Local'>num_index_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need a copy of the metapage so that we can use its hashm_spares[] 
     * values to compute bucket page addresses, but a cached copy should be 
     * good enough.  (If not, we'll detect that further down and refresh the 
     * cache as necessary.) 
     */ 
</span>    <a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN354"><span class='Ref_to_Proto'>_hash_getcachedmetap</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN553"><span class='Ref_To_Local'>orig_maxbucket</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN552"><span class='Ref_To_Local'>orig_ntuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan the buckets that we know exist */ 
</span>    <a href="hash.c.html#LN555"><span class='Ref_To_Local'>cur_bucket</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN554"><span class='Ref_To_Local'>cur_maxbucket</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN553"><span class='Ref_To_Local'>orig_maxbucket</span></a><span class='Delimiter'>; 
</span> 
<a name="LN579"></a><span class='Label'>loop_top</span><span class='Operator'>: 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN555"><span class='Ref_To_Local'>cur_bucket</span></a> <span class='Operator'>&LT;= </span><a href="hash.c.html#LN554"><span class='Ref_To_Local'>cur_maxbucket</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN582"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>bucket_blkno</span><span class='Delimiter'>; 
</span><a name="LN583"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN584"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>bucket_buf</span><span class='Delimiter'>; 
</span><a name="LN585"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN586"></a>        <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>bucket_opaque</span><span class='Delimiter'>; 
</span><a name="LN587"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN588"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>split_cleanup</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get address of bucket's start page */ 
</span>        <a href="hash.c.html#LN582"><span class='Ref_To_Local'>bucket_blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN37"><span class='Ref_to_Macro'>BUCKET_TO_BLKNO</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN555"><span class='Ref_To_Local'>cur_bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN583"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN582"><span class='Ref_To_Local'>bucket_blkno</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We need to acquire a cleanup lock on the primary bucket page to out 
         * wait concurrent scans before deleting the dead tuples. 
         */ 
</span>        <a href="hash.c.html#LN585"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN583"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN50"><span class='Ref_to_Member'>strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN216"><span class='Ref_to_Proto'>LockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN585"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN585"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN587"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN585"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN586"><span class='Ref_To_Local'>bucket_opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN587"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the bucket contains tuples that are moved by split, then we need 
         * to delete such tuples.  We can't delete such tuples if the split 
         * operation on bucket is not finished as those are needed by scans. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/hash.h.html#LN87"><span class='Ref_to_Macro'>H_BUCKET_BEING_SPLIT</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN586"><span class='Ref_To_Local'>bucket_opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/hash.h.html#LN86"><span class='Ref_to_Macro'>H_NEEDS_SPLIT_CLEANUP</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN586"><span class='Ref_To_Local'>bucket_opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="hash.c.html#LN588"><span class='Ref_To_Local'>split_cleanup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * This bucket might have been split since we last held a lock on 
             * the metapage.  If so, hashm_maxbucket, hashm_highmask and 
             * hashm_lowmask might be old enough to cause us to fail to remove 
             * tuples left behind by the most recent split.  To prevent that, 
             * now that the primary page of the target bucket has been locked 
             * (and thus can't be further split), check whether we need to 
             * update our cached metapage data. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hash.c.html#LN586"><span class='Ref_To_Local'>bucket_opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN586"><span class='Ref_To_Local'>bucket_opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>&GT; </span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN354"><span class='Ref_to_Proto'>_hash_getcachedmetap</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !H_BUCKET_BEING_SPLIT... &raquo; </span> 
 
        <a href="hash.c.html#LN584"><span class='Ref_To_Local'>bucket_buf</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN585"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/hash.h.html#LN417"><span class='Ref_to_Proto'>hashbucketcleanup</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN555"><span class='Ref_To_Local'>cur_bucket</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN584"><span class='Ref_To_Local'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN583"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN50"><span class='Ref_to_Member'>strategy</span></a><span class='Delimiter'>, 
</span>                          <a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>, 
</span>                          <a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>, 
</span>                          <a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN550"><span class='Ref_To_Local'>tuples_removed</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="hash.c.html#LN551"><span class='Ref_To_Local'>num_index_tuples</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN588"><span class='Ref_To_Local'>split_cleanup</span></a><span class='Delimiter'>, 
</span>                          <a href="hash.c.html#LN547"><span class='Ref_to_Parameter'>callback</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN547"><span class='Ref_to_Parameter'>callback_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN584"><span class='Ref_To_Local'>bucket_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Advance to next bucket */ 
</span>        <a href="hash.c.html#LN555"><span class='Ref_To_Local'>cur_bucket</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while cur_bucket&LT;=cur_maxbu... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN30"><span class='Ref_to_Macro'>BufferIsInvalid</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
        <a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN158"><span class='Ref_to_Const'>HASH_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN284"><span class='Ref_to_Const'>HASH_NOLOCK</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN55"><span class='Ref_to_Const'>LH_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Write-lock metapage and check for split since we started */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN554"><span class='Ref_To_Local'>cur_maxbucket</span></a> <span class='Operator'>!= </span><a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* There's been a split, so process the additional bucket(s) */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN354"><span class='Ref_to_Proto'>_hash_getcachedmetap</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN554"><span class='Ref_To_Local'>cur_maxbucket</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN558"><span class='Ref_To_Local'>cachedmetap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="hash.c.html#LN579"><span class='Ref_to_Label'>loop_top</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Okay, we're really done.  Update tuple count in metapage. */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN553"><span class='Ref_To_Local'>orig_maxbucket</span></a> <span class='Operator'>== </span><a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>&& 
</span>        <a href="hash.c.html#LN552"><span class='Ref_To_Local'>orig_ntuples</span></a> <span class='Operator'>== </span><a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * No one has split or inserted anything since start of scan, so 
         * believe our count as gospel. 
         */ 
</span>        <a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN551"><span class='Ref_To_Local'>num_index_tuples</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Otherwise, our count is untrustworthy since we may have 
         * double-scanned tuples in split buckets.  Proceed by dead-reckoning. 
         * (Note: we still return estimated_count = false, because using this 
         * count is better than not updating reltuples at all.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a> <span class='Operator'>&GT; </span><a href="hash.c.html#LN550"><span class='Ref_To_Local'>tuples_removed</span></a><span class='Parentheses'>) 
</span>            <a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a> <span class='Operator'>-= </span><a href="hash.c.html#LN550"><span class='Ref_To_Local'>tuples_removed</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN551"><span class='Ref_To_Local'>num_index_tuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN697"></a>        <a href="../../../include/access/hash_xlog.h.html#LN215"><span class='Ref_to_Struct'>xl_hash_update_meta_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN698"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN697"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN217"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN557"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hash.c.html#LN697"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN220"><span class='Ref_to_Const'>SizeOfHashUpdateMetaPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN698"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN43"><span class='Ref_to_Const'>XLOG_HASH_UPDATE_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hash.c.html#LN698"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN549"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN556"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* return statistics */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN74"><span class='Ref_to_Member'>estimated_count</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN75"><span class='Ref_to_Member'>num_index_tuples</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN551"><span class='Ref_To_Local'>num_index_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN76"><span class='Ref_to_Member'>tuples_removed</span></a> <span class='Operator'>+= </span><a href="hash.c.html#LN550"><span class='Ref_To_Local'>tuples_removed</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* hashvacuumcleanup will fill in num_pages */ 
</span> 
    <span class='Control'>return</span> <a href="hash.c.html#LN546"><span class='Ref_to_Parameter'>stats</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashbulkdelete &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Post-VACUUM cleanup. 
 * 
 * Result: a palloc'd struct containing statistical info for VACUUM displays. 
 */ 
</span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>* 
</span><a name="LN732"></a><span class='Declare_Function'>hashvacuumcleanup</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN43"><span class='Ref_to_Struct'>IndexVacuumInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><a href="../../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN734"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hash.c.html#LN732"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span><a name="LN735"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>num_pages</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If hashbulkdelete wasn't called, return NULL signifying no change */ 
</span>    <span class='Comment_Multi_Line'>/* Note: this covers the analyze_only case too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN732"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* update statistics */ 
</span>    <a href="hash.c.html#LN735"><span class='Ref_To_Local'>num_pages</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN734"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN732"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/genam.h.html#LN72"><span class='Ref_to_Member'>num_pages</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN735"><span class='Ref_To_Local'>num_pages</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hash.c.html#LN732"><span class='Ref_to_Parameter'>stats</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Helper function to perform deletion of index entries from a bucket. 
 * 
 * This function expects that the caller has acquired a cleanup lock on the 
 * primary bucket page, and will return with a write lock again held on the 
 * primary bucket page.  The lock won't necessarily be held continuously, 
 * though, because we'll release it when visiting overflow pages. 
 * 
 * It would be very bad if this function cleaned a page while some other 
 * backend was in the midst of scanning it, because hashgettuple assumes 
 * that the next valid TID will be greater than or equal to the current 
 * valid TID.  There can't be any concurrent scans in progress when we first 
 * enter this function because of the cleanup lock we hold on the primary 
 * bucket page, but as soon as we release that lock, there might be.  We 
 * handle that by conspiring to prevent those scans from passing our cleanup 
 * scan.  To do that, we lock the next page in the bucket chain before 
 * releasing the lock on the previous page.  (This type of lock chaining is 
 * not ideal, so we might want to look for a better solution at some point.) 
 * 
 * We need to retain a pin on the primary bucket to ensure that no concurrent 
 * split can start. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN772"></a><span class='Declare_Function'>hashbucketcleanup</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>cur_bucket</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>bucket_buf</span><span class='Delimiter'>, 
</span><a name="LN773"></a>                  <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>bucket_blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Delimiter'>, 
</span><a name="LN774"></a>                  <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>maxbucket</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>highmask</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>lowmask</span><span class='Delimiter'>, 
</span><a name="LN775"></a>                  <span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>tuples_removed</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>num_index_tuples</span><span class='Delimiter'>, 
</span><a name="LN776"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>split_cleanup</span><span class='Delimiter'>, 
</span><a name="LN777"></a>                  <a href="../../../include/access/genam.h.html#LN82"><span class='Ref_to_Typedef'>IndexBulkDeleteCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>callback_state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN779"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN780"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN781"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> new_bucket <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN35"><span class='Ref_to_Const'>InvalidBucket</span></a><span class='Delimiter'>; 
</span><a name="LN782"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>bucket_dirty</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="hash.c.html#LN779"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN773"><span class='Ref_to_Parameter'>bucket_blkno</span></a><span class='Delimiter'>; 
</span>    <a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN776"><span class='Ref_to_Parameter'>split_cleanup</span></a><span class='Parentheses'>) 
</span>        new_bucket <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN412"><span class='Ref_to_Proto'>_hash_get_newbucket_from_oldbucket</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>cur_bucket</span></a><span class='Delimiter'>, 
</span>                                                        <a href="hash.c.html#LN774"><span class='Ref_to_Parameter'>lowmask</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN774"><span class='Ref_to_Parameter'>maxbucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan each page in bucket */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN794"></a>        <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN795"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offno</span><span class='Delimiter'>; 
</span><a name="LN796"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoffno</span><span class='Delimiter'>; 
</span><a name="LN797"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>next_buf</span><span class='Delimiter'>; 
</span><a name="LN798"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN799"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>deletable</span><span class='Delimiter'>[</span><a href="../../../include/storage/off.h.html#LN27"><span class='Ref_to_Const'>MaxOffsetNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN800"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ndeletable</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN801"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>retain_pin</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN802"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>clear_dead_marking</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN798"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN794"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN798"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan each tuple in page */ 
</span>        <a href="hash.c.html#LN796"><span class='Ref_To_Local'>maxoffno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN798"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN795"><span class='Ref_To_Local'>offno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>             <a href="hash.c.html#LN795"><span class='Ref_To_Local'>offno</span></a> <span class='Operator'>&LT;= </span><a href="hash.c.html#LN796"><span class='Ref_To_Local'>maxoffno</span></a><span class='Delimiter'>; 
</span>             <a href="hash.c.html#LN795"><span class='Ref_To_Local'>offno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN795"><span class='Ref_To_Local'>offno</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN815"></a>            <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN816"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN817"></a>            <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN818"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>kill_tuple</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <a href="hash.c.html#LN816"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN798"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN798"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN795"><span class='Ref_To_Local'>offno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN815"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="hash.c.html#LN816"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * To remove the dead tuples, we strictly want to rely on results 
             * of callback function.  refer btvacuumpage for detailed reason. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN777"><span class='Ref_to_Parameter'>callback</span></a> <span class='Operator'>&& </span><a href="hash.c.html#LN777"><span class='Ref_to_Parameter'>callback</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN815"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN777"><span class='Ref_to_Parameter'>callback_state</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="hash.c.html#LN818"><span class='Ref_To_Local'>kill_tuple</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN775"><span class='Ref_to_Parameter'>tuples_removed</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="hash.c.html#LN775"><span class='Ref_to_Parameter'>tuples_removed</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN776"><span class='Ref_to_Parameter'>split_cleanup</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* delete the tuples that are moved by split. */ 
</span>                <a href="hash.c.html#LN817"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN123"><span class='Ref_to_Func'>_hash_hashkey2bucket</span></a><span class='Parentheses'>(</span><a href="hashutil.c.html#LN297"><span class='Ref_to_Func'>_hash_get_indextuple_hashkey</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN816"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                              <a href="hash.c.html#LN774"><span class='Ref_to_Parameter'>maxbucket</span></a><span class='Delimiter'>, 
</span>                                              <a href="hash.c.html#LN774"><span class='Ref_to_Parameter'>highmask</span></a><span class='Delimiter'>, 
</span>                                              <a href="hash.c.html#LN774"><span class='Ref_to_Parameter'>lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* mark the item for deletion */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN817"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>!= </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>cur_bucket</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We expect tuples to either belong to current bucket or 
                     * new_bucket.  This is ensured because we don't allow 
                     * further splits from bucket that contains garbage. See 
                     * comments in _hash_expandtable. 
                     */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hash.c.html#LN817"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>== </span>new_bucket<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="hash.c.html#LN818"><span class='Ref_To_Local'>kill_tuple</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if split_cleanup &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN818"><span class='Ref_To_Local'>kill_tuple</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* mark the item for deletion */ 
</span>                <a href="hash.c.html#LN799"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>[</span><a href="hash.c.html#LN800"><span class='Ref_To_Local'>ndeletable</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="hash.c.html#LN795"><span class='Ref_To_Local'>offno</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* we're keeping it, so count it */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN775"><span class='Ref_to_Parameter'>num_index_tuples</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="hash.c.html#LN775"><span class='Ref_to_Parameter'>num_index_tuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offno=FirstOffsetNumb... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* retain the pin on primary bucket page till end of bucket scan */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN779"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="hash.c.html#LN773"><span class='Ref_to_Parameter'>bucket_blkno</span></a><span class='Parentheses'>) 
</span>            <a href="hash.c.html#LN801"><span class='Ref_To_Local'>retain_pin</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hash.c.html#LN801"><span class='Ref_To_Local'>retain_pin</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN779"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN794"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Apply deletions, advance to next page and write page if needed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN800"><span class='Ref_To_Local'>ndeletable</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* No ereport(ERROR) until changes are logged */ 
</span>            <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN431"><span class='Ref_to_Proto'>PageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN798"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN799"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN800"><span class='Ref_To_Local'>ndeletable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hash.c.html#LN782"><span class='Ref_To_Local'>bucket_dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Let us mark the page as clean if vacuum removes the DEAD tuples 
             * from an index page. We do this by clearing 
             * LH_PAGE_HAS_DEAD_TUPLES flag. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN775"><span class='Ref_to_Parameter'>tuples_removed</span></a> <span class='Operator'>&& *</span><a href="hash.c.html#LN775"><span class='Ref_to_Parameter'>tuples_removed</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                <a href="../../../include/access/hash.h.html#LN89"><span class='Ref_to_Macro'>H_HAS_DEAD_TUPLES</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN794"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="hash.c.html#LN794"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/hash.h.html#LN59"><span class='Ref_to_Const'>LH_PAGE_HAS_DEAD_TUPLES</span></a><span class='Delimiter'>; 
</span>                <a href="hash.c.html#LN802"><span class='Ref_To_Local'>clear_dead_marking</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN904"></a>                <a href="../../../include/access/hash_xlog.h.html#LN198"><span class='Ref_to_Struct'>xl_hash_delete</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN905"></a>                <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
                <a href="hash.c.html#LN904"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN200"><span class='Ref_to_Member'>clear_dead_marking</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN802"><span class='Ref_To_Local'>clear_dead_marking</span></a><span class='Delimiter'>; 
</span>                <a href="hash.c.html#LN904"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN202"><span class='Ref_to_Member'>is_primary_bucket_page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Boolean'>true </span><span class='Operator'>: </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hash.c.html#LN904"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN206"><span class='Ref_to_Const'>SizeOfHashDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * bucket buffer needs to be registered to ensure that we can 
                 * acquire a cleanup lock on it during replay. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hash.c.html#LN904"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN202"><span class='Ref_to_Member'>is_primary_bucket_page</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN30"><span class='Ref_to_Const'>REGBUF_NO_IMAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hash.c.html#LN799"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, 
</span>                                    <a href="hash.c.html#LN800"><span class='Ref_To_Local'>ndeletable</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="hash.c.html#LN905"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN39"><span class='Ref_to_Const'>XLOG_HASH_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hash.c.html#LN905"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
            <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ndeletable&GT;0 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* bail out if there are no more pages to scan. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN779"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN797"><span class='Ref_To_Local'>next_buf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN245"><span class='Ref_to_Func'>_hash_getbuf_with_strategy</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN779"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>, 
</span>                                              <a href="hash.c.html#LN773"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * release the lock on previous page after acquiring the lock on next 
         * page 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN801"><span class='Ref_To_Local'>retain_pin</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="hash.c.html#LN797"><span class='Ref_To_Local'>next_buf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * lock the bucket page to clear the garbage flag and squeeze the bucket. 
     * if the current buffer is same as bucket buffer, then we already have 
     * lock on bucket page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>!= </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN780"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear the garbage flag from bucket after deleting the tuples that are 
     * moved by split.  We purposefully clear the flag before squeeze bucket, 
     * so that after restart, vacuum shouldn't again try to delete the moved 
     * by split tuples. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN776"><span class='Ref_to_Parameter'>split_cleanup</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN970"></a>        <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>bucket_opaque</span><span class='Delimiter'>; 
</span><a name="LN971"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN971"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hash.c.html#LN970"><span class='Ref_To_Local'>bucket_opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN971"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No ereport(ERROR) until changes are logged */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="hash.c.html#LN970"><span class='Ref_To_Local'>bucket_opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/hash.h.html#LN58"><span class='Ref_to_Const'>LH_BUCKET_NEEDS_SPLIT_CLEANUP</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN985"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="hash.c.html#LN985"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN40"><span class='Ref_to_Const'>XLOG_HASH_SPLIT_CLEANUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN971"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN985"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if split_cleanup &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we have deleted anything, try to compact free space.  For squeezing 
     * the bucket, we must have a cleanup lock, else it can impact the 
     * ordering of tuples for a scan that has started before it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hash.c.html#LN782"><span class='Ref_To_Local'>bucket_dirty</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufmgr.h.html#LN218"><span class='Ref_to_Proto'>IsBufferCleanupOK</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/hash.h.html#LN343"><span class='Ref_to_Proto'>_hash_squeezebucket</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>cur_bucket</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN773"><span class='Ref_to_Parameter'>bucket_blkno</span></a><span class='Delimiter'>, </span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, 
</span>                            <a href="hash.c.html#LN773"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hash.c.html#LN772"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hashbucketcleanup &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>