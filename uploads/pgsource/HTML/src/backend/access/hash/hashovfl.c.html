<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\hash\hashovfl.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\hash\hashovfl.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * hashovfl.c 
 *    Overflow page management code for the Postgres hash access method 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/hash/hashovfl.c 
 * 
 * NOTES 
 *    Overflow pages look like ordinary relation pages. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/hash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/hash_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<a name="LN25"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Prototype'>_hash_firstfreebit</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>map</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Convert overflow page bit number (its index in the free-page bitmaps) 
 * to block number within the index. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN33"></a><span class='Declare_Function'>bitno_to_blkno</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Parameter'>metap</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>ovflbitnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN35"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>splitnum</span> <span class='Operator'>= </span><a href="hashovfl.c.html#LN33"><span class='Ref_to_Parameter'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Delimiter'>; 
</span><a name="LN36"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert zero-based bitnumber to 1-based page number */ 
</span>    <a href="hashovfl.c.html#LN33"><span class='Ref_to_Parameter'>ovflbitnum</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Determine the split number for this page (must be &GT;= 1) */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN36"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>         <a href="hashovfl.c.html#LN36"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN35"><span class='Ref_To_Local'>splitnum</span></a> <span class='Operator'>&& </span><a href="hashovfl.c.html#LN33"><span class='Ref_to_Parameter'>ovflbitnum</span></a> <span class='Operator'>&GT; </span><a href="hashovfl.c.html#LN33"><span class='Ref_to_Parameter'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN36"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>         <a href="hashovfl.c.html#LN36"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>         <span class='Comment_Multi_Line'>/* loop */ </span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Convert to absolute page number by adding the number of bucket pages 
     * that exist before this split point. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) (</span><a href="hashutil.c.html#LN187"><span class='Ref_to_Func'>_hash_get_totalbuckets</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN36"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="hashovfl.c.html#LN33"><span class='Ref_to_Parameter'>ovflbitnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end bitno_to_blkno &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * _hash_ovflblkno_to_bitno 
 * 
 * Convert overflow page block number to bit number for free-page bitmap. 
 */ 
</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN60"></a><span class='Declare_Function'>_hash_ovflblkno_to_bitno</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Parameter'>metap</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>ovflblkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN62"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>splitnum</span> <span class='Operator'>= </span><a href="hashovfl.c.html#LN60"><span class='Ref_to_Parameter'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Delimiter'>; 
</span><a name="LN63"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN64"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>bitnum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Determine the split number containing this page */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="hashovfl.c.html#LN62"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN60"><span class='Ref_to_Parameter'>ovflblkno</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><a href="hashutil.c.html#LN187"><span class='Ref_to_Func'>_hash_get_totalbuckets</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* oops */ 
</span>        <a href="hashovfl.c.html#LN64"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN60"><span class='Ref_to_Parameter'>ovflblkno</span></a> <span class='Operator'>- </span><a href="hashutil.c.html#LN187"><span class='Ref_to_Func'>_hash_get_totalbuckets</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * bitnum has to be greater than number of overflow page added in 
         * previous split point. The overflow page at this splitnum (i) if any 
         * should start from (_hash_get_totalbuckets(i) + 
         * metap-&GT;hashm_spares[i - 1] + 1). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN64"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>&GT; </span><a href="hashovfl.c.html#LN60"><span class='Ref_to_Parameter'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>&& 
</span>            <a href="hashovfl.c.html#LN64"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>&LT;= </span><a href="hashovfl.c.html#LN60"><span class='Ref_to_Parameter'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN63"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="hashovfl.c.html#LN64"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* -1 to convert 1-based to 0-based */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid overflow block number %u"</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN60"><span class='Ref_to_Parameter'>ovflblkno</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _hash_ovflblkno_to_bitno &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_addovflpage 
 * 
 *  Add an overflow page to the bucket whose last page is pointed to by 'buf'. 
 * 
 *  On entry, the caller must hold a pin but no lock on 'buf'.  The pin is 
 *  dropped before exiting (we assume the caller is not interested in 'buf' 
 *  anymore) if not asked to retain.  The pin will be retained only for the 
 *  primary bucket.  The returned overflow page will be pinned and 
 *  write-locked; it is guaranteed to be empty. 
 * 
 *  The caller must hold a pin, but no lock, on the metapage buffer. 
 *  That buffer is returned in the same state. 
 * 
 * NB: since this could be executed concurrently by multiple processes, 
 * one should not assume that the returned overflow page will be the 
 * immediate successor of the originally passed 'buf'.  Additional overflow 
 * pages might have been added to the bucket chain in between. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN110"></a><span class='Declare_Function'>_hash_addovflpage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>metabuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>retain_pin</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN112"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>ovflbuf</span><span class='Delimiter'>; 
</span><a name="LN113"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN114"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>ovflpage</span><span class='Delimiter'>; 
</span><a name="LN115"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>pageopaque</span><span class='Delimiter'>; 
</span><a name="LN116"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>ovflopaque</span><span class='Delimiter'>; 
</span><a name="LN117"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN118"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>mapbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN119"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>newmapbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN120"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN121"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>orig_firstfree</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>splitnum</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>freep</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN124"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>max_ovflpg</span><span class='Delimiter'>; 
</span><a name="LN125"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>bit</span><span class='Delimiter'>; 
</span><a name="LN126"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>bitmap_page_bit</span><span class='Delimiter'>; 
</span><a name="LN127"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN128"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>last_bit</span><span class='Delimiter'>; 
</span><a name="LN129"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>last_page</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN131"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN132"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>page_found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write-lock the tail page.  Here, we need to maintain locking order such 
     * that, first acquire the lock on tail page of bucket, then on meta page 
     * to find and lock the bitmap page and if it is found, then lock on meta 
     * page is released, then finally acquire the lock on new overflow buffer. 
     * We need this locking order to avoid deadlock with backends that are 
     * doing inserts. 
     * 
     * Note: We could have avoided locking many buffers here if we made two 
     * WAL records for acquiring an overflow page (one to allocate an overflow 
     * page and another to add it to overflow bucket chain).  However, doing 
     * so can leak an overflow page, if the system crashes after allocation. 
     * Needless to say, it is better to have a single record from a 
     * performance point of view as well. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* probably redundant... */ 
</span>    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* loop to find current tail page, in case someone else inserted too */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN157"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nextblkno</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN113"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN115"><span class='Ref_To_Local'>pageopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN113"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN157"><span class='Ref_To_Local'>nextblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN115"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN157"><span class='Ref_To_Local'>nextblkno</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we assume we do not need to write the unmodified page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>retain_pin</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* pin will be retained only for the primary bucket page */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="hashovfl.c.html#LN115"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>& </span><a href="../../../include/access/hash.h.html#LN61"><span class='Ref_to_Const'>LH_PAGE_TYPE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>retain_pin</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN157"><span class='Ref_To_Local'>nextblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Get exclusive lock on the meta page */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN55"><span class='Ref_to_Const'>LH_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* start search at hashm_firstfree */ 
</span>    <a href="hashovfl.c.html#LN121"><span class='Ref_To_Local'>orig_firstfree</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN127"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN121"><span class='Ref_To_Local'>orig_firstfree</span></a> <span class='Operator'>&GT;&GT; </span><a href="../../../include/access/hash.h.html#LN256"><span class='Ref_to_Macro'>BMPG_SHIFT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN121"><span class='Ref_To_Local'>orig_firstfree</span></a> <span class='Operator'>& </span><a href="../../../include/access/hash.h.html#LN257"><span class='Ref_to_Macro'>BMPG_MASK</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN127"><span class='Ref_To_Local'>first_page</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN131"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>/ </span><a href="../../../include/access/hash.h.html#LN272"><span class='Ref_to_Const'>BITS_PER_MAP</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN272"><span class='Ref_to_Const'>BITS_PER_MAP</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* outer loop iterates once per bitmap page */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN198"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapblkno</span><span class='Delimiter'>; 
</span><a name="LN199"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>mappage</span><span class='Delimiter'>; 
</span><a name="LN200"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>last_inpage</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* want to end search with the last existing overflow page */ 
</span>        <a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN124"><span class='Ref_To_Local'>max_ovflpg</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN129"><span class='Ref_To_Local'>last_page</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN124"><span class='Ref_To_Local'>max_ovflpg</span></a> <span class='Operator'>&GT;&GT; </span><a href="../../../include/access/hash.h.html#LN256"><span class='Ref_to_Macro'>BMPG_SHIFT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN128"><span class='Ref_To_Local'>last_bit</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN124"><span class='Ref_To_Local'>max_ovflpg</span></a> <span class='Operator'>& </span><a href="../../../include/access/hash.h.html#LN257"><span class='Ref_to_Macro'>BMPG_MASK</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><a href="hashovfl.c.html#LN129"><span class='Ref_To_Local'>last_page</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN198"><span class='Ref_To_Local'>mapblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN222"><span class='Ref_to_Member'>hashm_mapp</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN129"><span class='Ref_To_Local'>last_page</span></a><span class='Parentheses'>) 
</span>            <a href="hashovfl.c.html#LN200"><span class='Ref_To_Local'>last_inpage</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN128"><span class='Ref_To_Local'>last_bit</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hashovfl.c.html#LN200"><span class='Ref_To_Local'>last_inpage</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN255"><span class='Ref_to_Macro'>BMPGSZ_BIT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release exclusive lock on metapage while reading bitmap page */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN198"><span class='Ref_To_Local'>mapblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN54"><span class='Ref_to_Const'>LH_BITMAP_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN199"><span class='Ref_To_Local'>mappage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN123"><span class='Ref_To_Local'>freep</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN259"><span class='Ref_to_Macro'>HashPageGetBitmap</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN199"><span class='Ref_To_Local'>mappage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>&LT;= </span><a href="hashovfl.c.html#LN200"><span class='Ref_To_Local'>last_inpage</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN131"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>+= </span><a href="../../../include/access/hash.h.html#LN272"><span class='Ref_to_Const'>BITS_PER_MAP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN123"><span class='Ref_To_Local'>freep</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN131"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../../include/access/hash.h.html#LN245"><span class='Ref_to_Const'>ALL_SET</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="hashovfl.c.html#LN132"><span class='Ref_To_Local'>page_found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Reacquire exclusive lock on the meta page */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* convert bit to bit number within page */ 
</span>                <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>+= </span><a href="hashovfl.c.html#LN25"><span class='Ref_to_Proto'>_hash_firstfreebit</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN123"><span class='Ref_To_Local'>freep</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN131"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN126"><span class='Ref_To_Local'>bitmap_page_bit</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* convert bit to absolute bit number */ 
</span>                <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;&LT; </span><a href="../../../include/access/hash.h.html#LN256"><span class='Ref_to_Macro'>BMPG_SHIFT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Calculate address of the recycled overflow page */ 
</span>                <a href="hashovfl.c.html#LN120"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN32"><span class='Ref_to_Func'>bitno_to_blkno</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Fetch and init the recycled page */ 
</span>                <a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN141"><span class='Ref_to_Func'>_hash_getinitbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN120"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="hashovfl.c.html#LN312"><span class='Ref_to_Label'>found</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if freep[j]!=ALL_SET &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;bit&LT;=last_inpage;j++... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* No free space here, try to advance to next map page */ 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN130"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN131"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* scan from start of next map page */ 
</span>        <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Reacquire exclusive lock on the meta page */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * No free pages --- have to extend the relation to add an overflow page. 
     * First, check to see if we have to add a new bitmap page too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN128"><span class='Ref_To_Local'>last_bit</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN255"><span class='Ref_to_Macro'>BMPGSZ_BIT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We create the new bitmap page with all pages marked "in use". 
         * Actually two pages in the new bitmap's range will exist 
         * immediately: the bitmap page itself, and the following page which 
         * is the one we return to the caller.  Both of these are correctly 
         * marked "in use".  Subsequent pages do not exist yet, but it is 
         * convenient to pre-mark them as "in use" too. 
         */ 
</span>        <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* metapage already has a write lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/hash.h.html#LN188"><span class='Ref_to_Const'>HASH_MAX_BITMAPS</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of overflow pages in hash index \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN204"><span class='Ref_to_Func'>_hash_getnewbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN32"><span class='Ref_to_Func'>bitno_to_blkno</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if last_bit==(uint32)(BM... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Nothing to do here; since the page will be past the last used page, 
         * we know its bitmap bit was preinitialized to "in use". 
         */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Calculate address of the new overflow page */ 
</span>    <a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>? 
</span>        <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>: </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>]; 
</span>    <a href="hashovfl.c.html#LN120"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN32"><span class='Ref_to_Func'>bitno_to_blkno</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch the page with _hash_getnewbuf to ensure smgr's idea of the 
     * relation length stays in sync with ours.  XXX It's annoying to do this 
     * with metapage write lock held; would be better to use a lock that 
     * doesn't block incoming searches. 
     * 
     * It is okay to hold two buffer locks here (one on tail page of bucket 
     * and other on new overflow page) since there cannot be anyone else 
     * contending for access to ovflbuf. 
     */ 
</span>    <a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN204"><span class='Ref_to_Func'>_hash_getnewbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN120"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN312"></a><span class='Label'>found</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the update.  No ereport(ERROR) until changes are logged. We want to 
     * log the changes for bitmap page and overflow page together to avoid 
     * loss of pages in case the new page is added. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN132"><span class='Ref_To_Local'>page_found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* mark page "in use" in the bitmap */ 
</span>        <a href="../../../../contrib/bloom/blutils.c.html#LN32"><span class='Ref_to_Macro'>SETBIT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN123"><span class='Ref_To_Local'>freep</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN126"><span class='Ref_To_Local'>bitmap_page_bit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* update the count to indicate new overflow page is added */ 
</span>        <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/hash.h.html#LN342"><span class='Ref_to_Proto'>_hash_initbitmapbuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN209"><span class='Ref_to_Member'>hashm_bmsize</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* add the new bitmap page to the metapage's list of bitmaps */ 
</span>            <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN222"><span class='Ref_to_Member'>hashm_mapp</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN122"><span class='Ref_To_Local'>splitnum</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * for new overflow page, we don't need to explicitly set the bit in 
         * bitmap page, as by default that will be set to "in use". 
         */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Adjust hashm_firstfree to avoid redundant searches.  But don't risk 
     * changing it if someone moved it while we were searching bitmap pages. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN121"><span class='Ref_To_Local'>orig_firstfree</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN125"><span class='Ref_To_Local'>bit</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* initialize new overflow page */ 
</span>    <a href="hashovfl.c.html#LN114"><span class='Ref_To_Local'>ovflpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN116"><span class='Ref_To_Local'>ovflopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN114"><span class='Ref_To_Local'>ovflpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN116"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN116"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN116"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN115"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN116"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN116"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* logically chain overflow page to previous page */ 
</span>    <a href="hashovfl.c.html#LN115"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN381"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN382"></a>        <a href="../../../include/access/hash_xlog.h.html#LN94"><span class='Ref_to_Struct'>xl_hash_add_ovfl_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN382"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN97"><span class='Ref_to_Member'>bmpage_found</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN132"><span class='Ref_To_Local'>page_found</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN382"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN96"><span class='Ref_to_Member'>bmsize</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN209"><span class='Ref_to_Member'>hashm_bmsize</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN382"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN100"><span class='Ref_to_Const'>SizeOfHashAddOvflPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN115"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN126"><span class='Ref_To_Local'>bitmap_page_bit</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN117"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN381"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN29"><span class='Ref_to_Const'>XLOG_HASH_ADD_OVFL_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN381"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN381"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN381"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN381"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN381"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>retain_pin</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>))</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN118"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>))</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN119"><span class='Ref_To_Local'>newmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashovfl.c.html#LN112"><span class='Ref_To_Local'>ovflbuf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_addovflpage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_firstfreebit() 
 * 
 *  Return the number of the first bit that is not set in the word 'map'. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN445"></a><span class='Declare_Function'>_hash_firstfreebit</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>map</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN447"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN448"></a>                <span class='Declare_Local'>mask</span><span class='Delimiter'>; 
</span> 
    <a href="hashovfl.c.html#LN448"><span class='Ref_To_Local'>mask</span></a> <span class='Operator'>= </span><span class='Number'>0x1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN447"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN447"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/hash.h.html#LN272"><span class='Ref_to_Const'>BITS_PER_MAP</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN447"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN448"><span class='Ref_To_Local'>mask</span></a> <span class='Operator'>& </span><a href="hashovfl.c.html#LN445"><span class='Ref_to_Parameter'>map</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="hashovfl.c.html#LN447"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN448"><span class='Ref_To_Local'>mask</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"firstfreebit found no free bit"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _hash_freeovflpage() - 
 * 
 *  Remove this overflow page from its bucket's chain, and mark the page as 
 *  free.  On entry, ovflbuf is write-locked; it is released before exiting. 
 * 
 *  Add the tuples (itups) to wbuf in this function.  We could do that in the 
 *  caller as well, but the advantage of doing it here is we can easily write 
 *  the WAL for XLOG_HASH_SQUEEZE_PAGE operation.  Addition of tuples and 
 *  removal of overflow page has to done as an atomic operation, otherwise 
 *  during replay on standby users might find duplicate records. 
 * 
 *  Since this function is invoked in VACUUM, we provide an access strategy 
 *  parameter that controls fetches of the bucket pages. 
 * 
 *  Returns the block number of the page that followed the given page 
 *  in the bucket, or InvalidBlockNumber if no following page. 
 * 
 *  NB: caller must not hold lock on metapage, nor on page, that's next to 
 *  ovflbuf in the bucket chain.  We don't acquire the lock on page that's 
 *  prior to ovflbuf in chain if it is same as wbuf because the caller already 
 *  has a lock on same. 
 */ 
</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN487"></a><span class='Declare_Function'>_hash_freeovflpage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>bucketbuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>ovflbuf</span><span class='Delimiter'>, 
</span><a name="LN488"></a>                   <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>wbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itups</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itup_offsets</span><span class='Delimiter'>, 
</span><a name="LN489"></a>                   <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tups_size</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>nitups</span><span class='Delimiter'>, 
</span><a name="LN490"></a>                   <a href="../../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN492"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN493"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN494"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>mapbuf</span><span class='Delimiter'>; 
</span><a name="LN495"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>ovflblkno</span><span class='Delimiter'>; 
</span><a name="LN496"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>prevblkno</span><span class='Delimiter'>; 
</span><a name="LN497"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN498"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nextblkno</span><span class='Delimiter'>; 
</span><a name="LN499"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>writeblkno</span><span class='Delimiter'>; 
</span><a name="LN500"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>ovflopaque</span><span class='Delimiter'>; 
</span><a name="LN501"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>ovflpage</span><span class='Delimiter'>; 
</span><a name="LN502"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>mappage</span><span class='Delimiter'>; 
</span><a name="LN503"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>freep</span><span class='Delimiter'>; 
</span><a name="LN504"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>ovflbitno</span><span class='Delimiter'>; 
</span><a name="LN505"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>bitmappage</span><span class='Delimiter'>, 
</span><a name="LN506"></a>                <span class='Declare_Local'>bitmapbit</span><span class='Delimiter'>; 
</span><a name="LN507"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> bucket <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span><span class='Delimiter'>; 
</span><a name="LN508"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>prevbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN509"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>nextbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN510"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>update_metap</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get information from the doomed page */ 
</span>    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN495"><span class='Ref_To_Local'>ovflblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN501"><span class='Ref_To_Local'>ovflpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN501"><span class='Ref_To_Local'>ovflpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN498"><span class='Ref_To_Local'>nextblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN499"><span class='Ref_To_Local'>writeblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    bucket <span class='Operator'>= </span><a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fix up the bucket chain.  this is a doubly-linked list, so we must fix 
     * up the bucket chain members behind and ahead of the overflow page being 
     * deleted.  Concurrency issues are avoided by using lock chaining as 
     * described atop hashbucketcleanup. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN499"><span class='Ref_To_Local'>writeblkno</span></a><span class='Parentheses'>) 
</span>            <a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN245"><span class='Ref_to_Func'>_hash_getbuf_with_strategy</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                                 <a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>, 
</span>                                                 <a href="hashovfl.c.html#LN490"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN498"><span class='Ref_To_Local'>nextblkno</span></a><span class='Parentheses'>))</span> 
        <a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN245"><span class='Ref_to_Func'>_hash_getbuf_with_strategy</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                             <a href="hashovfl.c.html#LN498"><span class='Ref_To_Local'>nextblkno</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>, 
</span>                                             <a href="hashovfl.c.html#LN490"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Note: bstrategy is intentionally not used for metapage and bitmap */ 
</span> 
    <span class='Comment_Multi_Line'>/* Read the metapage so we can determine which bitmap page to use */ 
</span>    <a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN158"><span class='Ref_to_Const'>HASH_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN55"><span class='Ref_to_Const'>LH_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Identify which bit to set */ 
</span>    <a href="hashovfl.c.html#LN504"><span class='Ref_To_Local'>ovflbitno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN59"><span class='Ref_to_Func'>_hash_ovflblkno_to_bitno</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN495"><span class='Ref_To_Local'>ovflblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashovfl.c.html#LN505"><span class='Ref_To_Local'>bitmappage</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN504"><span class='Ref_To_Local'>ovflbitno</span></a> <span class='Operator'>&GT;&GT; </span><a href="../../../include/access/hash.h.html#LN256"><span class='Ref_to_Macro'>BMPG_SHIFT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN506"><span class='Ref_To_Local'>bitmapbit</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN504"><span class='Ref_To_Local'>ovflbitno</span></a> <span class='Operator'>& </span><a href="../../../include/access/hash.h.html#LN257"><span class='Ref_to_Macro'>BMPG_MASK</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN505"><span class='Ref_To_Local'>bitmappage</span></a> <span class='Operator'>&GT;= </span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid overflow bit number %u"</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN504"><span class='Ref_To_Local'>ovflbitno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN497"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN222"><span class='Ref_to_Member'>hashm_mapp</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN505"><span class='Ref_To_Local'>bitmappage</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Release metapage lock while we access the bitmap page */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* read the bitmap page to clear the bitmap bit */ 
</span>    <a href="hashovfl.c.html#LN494"><span class='Ref_To_Local'>mapbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN497"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN54"><span class='Ref_to_Const'>LH_BITMAP_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN502"><span class='Ref_To_Local'>mappage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN494"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN503"><span class='Ref_To_Local'>freep</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN259"><span class='Ref_to_Macro'>HashPageGetBitmap</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN502"><span class='Ref_To_Local'>mappage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN277"><span class='Ref_to_Macro'>ISSET</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN503"><span class='Ref_To_Local'>freep</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN506"><span class='Ref_To_Local'>bitmapbit</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get write-lock on metapage to update firstfree */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This operation needs to log multiple tuples, prepare WAL for that */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/xloginsert.h.html#LN44"><span class='Ref_to_Proto'>XLogEnsureRecordSpace</span></a><span class='Parentheses'>(</span><a href="../../../include/access/hash_xlog.h.html#LN21"><span class='Ref_to_Const'>HASH_XLOG_FREE_OVFL_BUFS</span></a><span class='Delimiter'>, </span><span class='Number'>4</span> <span class='Operator'>+ </span><a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>nitups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * we have to insert tuples on the "write" page, being careful to preserve 
     * hashkey ordering.  (If we insert many tuples into the same "write" page 
     * it would be worth qsort'ing them). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>nitups</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="hashinsert.c.html#LN295"><span class='Ref_to_Func'>_hash_pgaddmultitup</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>itups</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>itup_offsets</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>nitups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reinitialize the freed overflow page.  Just zeroing the page won't 
     * work, because WAL replay routines expect pages to be initialized. See 
     * explanation of RBM_NORMAL mode atop XLogReadBufferExtended.  We are 
     * careful to make the special space valid here so that tools like 
     * pageinspect won't get confused. 
     */ 
</span>    <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN501"><span class='Ref_To_Local'>ovflpage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN501"><span class='Ref_To_Local'>ovflpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN51"><span class='Ref_to_Const'>LH_UNUSED_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN500"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN612"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>prevpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN613"></a>        <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>prevopaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN612"><span class='Ref_To_Local'>prevpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN613"><span class='Ref_To_Local'>prevopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span>bucket<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN613"><span class='Ref_To_Local'>prevopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN498"><span class='Ref_To_Local'>nextblkno</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN621"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>nextpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN622"></a>        <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>nextopaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN621"><span class='Ref_To_Local'>nextpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN622"><span class='Ref_To_Local'>nextopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span>bucket<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN622"><span class='Ref_To_Local'>nextopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Clear the bitmap bit to indicate that this overflow page is free */ 
</span>    <a href="../../../../contrib/bloom/blutils.c.html#LN31"><span class='Ref_to_Macro'>CLRBIT</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN503"><span class='Ref_To_Local'>freep</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN506"><span class='Ref_To_Local'>bitmapbit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN494"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if this is now the first free page, update hashm_firstfree */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN504"><span class='Ref_To_Local'>ovflbitno</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN504"><span class='Ref_To_Local'>ovflbitno</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN510"><span class='Ref_To_Local'>update_metap</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN644"></a>        <a href="../../../include/access/hash_xlog.h.html#LN173"><span class='Ref_to_Struct'>xl_hash_squeeze_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN645"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN646"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN175"><span class='Ref_to_Member'>prevblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN176"><span class='Ref_to_Member'>nextblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN498"><span class='Ref_To_Local'>nextblkno</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN177"><span class='Ref_to_Member'>ntups</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>nitups</span></a><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN178"><span class='Ref_to_Member'>is_prim_bucket_same_wrt</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>bucketbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN181"><span class='Ref_to_Member'>is_prev_bucket_same_wrt</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN187"><span class='Ref_to_Const'>SizeOfHashSqueezePage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * bucket buffer needs to be registered to ensure that we can acquire 
         * a cleanup lock on it during replay. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN178"><span class='Ref_to_Member'>is_prim_bucket_same_wrt</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>bucketbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN30"><span class='Ref_to_Const'>REGBUF_NO_IMAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN177"><span class='Ref_to_Member'>ntups</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>itup_offsets</span></a><span class='Delimiter'>, 
</span>                                <a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>nitups</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN646"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN646"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>nitups</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN646"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>itups</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN646"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="hashovfl.c.html#LN489"><span class='Ref_to_Parameter'>tups_size</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN646"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If prevpage and the writepage (block in which we are moving tuples 
         * from overflow) are same, then no need to separately register 
         * prevpage.  During replay, we can directly update the nextblock in 
         * writepage. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN181"><span class='Ref_to_Member'>is_prev_bucket_same_wrt</span></a><span class='Parentheses'>)</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>5</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN494"><span class='Ref_To_Local'>mapbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN506"><span class='Ref_To_Local'>bitmapbit</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN510"><span class='Ref_To_Local'>update_metap</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>6</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>6</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN492"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN36"><span class='Ref_to_Const'>XLOG_HASH_SQUEEZE_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN488"><span class='Ref_to_Parameter'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="hashovfl.c.html#LN644"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN181"><span class='Ref_to_Member'>is_prev_bucket_same_wrt</span></a><span class='Parentheses'>)</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN494"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN510"><span class='Ref_To_Local'>update_metap</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN645"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release previous bucket if it is not same as write bucket */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="hashovfl.c.html#LN496"><span class='Ref_To_Local'>prevblkno</span></a> <span class='Operator'>!= </span><a href="hashovfl.c.html#LN499"><span class='Ref_To_Local'>writeblkno</span></a><span class='Parentheses'>)</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN508"><span class='Ref_To_Local'>prevbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>))</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>ovflbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>))</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN509"><span class='Ref_To_Local'>nextbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN494"><span class='Ref_To_Local'>mapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN487"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN493"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashovfl.c.html#LN498"><span class='Ref_To_Local'>nextblkno</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_freeovflpage &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_initbitmapbuffer() 
 * 
 *   Initialize a new bitmap page.  All bits in the new bitmap page are set to 
 *   "1", indicating "in use". 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN738"></a><span class='Declare_Function'>_hash_initbitmapbuffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>bmsize</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>initpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN740"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>pg</span><span class='Delimiter'>; 
</span><a name="LN741"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>op</span><span class='Delimiter'>; 
</span><a name="LN742"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>freep</span><span class='Delimiter'>; 
</span> 
    <a href="hashovfl.c.html#LN740"><span class='Ref_To_Local'>pg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN738"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN738"><span class='Ref_to_Parameter'>initpage</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN740"><span class='Ref_To_Local'>pg</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN738"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the page's special space */ 
</span>    <a href="hashovfl.c.html#LN741"><span class='Ref_To_Local'>op</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN740"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN741"><span class='Ref_To_Local'>op</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN741"><span class='Ref_To_Local'>op</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN741"><span class='Ref_To_Local'>op</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN741"><span class='Ref_To_Local'>op</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN54"><span class='Ref_to_Const'>LH_BITMAP_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN741"><span class='Ref_To_Local'>op</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set all of the bits to 1 */ 
</span>    <a href="hashovfl.c.html#LN742"><span class='Ref_To_Local'>freep</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN259"><span class='Ref_to_Macro'>HashPageGetBitmap</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN740"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN742"><span class='Ref_To_Local'>freep</span></a><span class='Delimiter'>, </span><span class='Number'>0xFF</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN738"><span class='Ref_to_Parameter'>bmsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set pd_lower just past the end of the bitmap page data.  We could even 
     * set pd_lower equal to pd_upper, but this is more precise and makes the 
     * page look compressible to xlog.c. 
     */ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN740"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN742"><span class='Ref_To_Local'>freep</span></a> <span class='Operator'>+ </span><a href="hashovfl.c.html#LN738"><span class='Ref_to_Parameter'>bmsize</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN740"><span class='Ref_To_Local'>pg</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_initbitmapbuffer &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_squeezebucket(rel, bucket) 
 * 
 *  Try to squeeze the tuples onto pages occurring earlier in the 
 *  bucket chain in an attempt to free overflow pages. When we start 
 *  the "squeezing", the page from which we start taking tuples (the 
 *  "read" page) is the last bucket in the bucket chain and the page 
 *  onto which we start squeezing tuples (the "write" page) is the 
 *  first page in the bucket chain.  The read page works backward and 
 *  the write page works forward; the procedure terminates when the 
 *  read page and write page are the same page. 
 * 
 *  At completion of this procedure, it is guaranteed that all pages in 
 *  the bucket are nonempty, unless the bucket is totally empty (in 
 *  which case all overflow pages will be freed).  The original implementation 
 *  required that to be true on entry as well, but it's a lot easier for 
 *  callers to leave empty overflow pages and let this guy clean it up. 
 * 
 *  Caller must acquire cleanup lock on the primary page of the target 
 *  bucket to exclude any scans that are in progress, which could easily 
 *  be confused into returning the same tuple more than once or some tuples 
 *  not at all by the rearrangement we are performing here.  To prevent 
 *  any concurrent scan to cross the squeeze scan we use lock chaining 
 *  similar to hasbucketcleanup.  Refer comments atop hashbucketcleanup. 
 * 
 *  We need to retain a pin on the primary bucket to ensure that no concurrent 
 *  split can start. 
 * 
 *  Since this function is invoked in VACUUM, we provide an access strategy 
 *  parameter that controls fetches of the bucket pages. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN803"></a><span class='Declare_Function'>_hash_squeezebucket</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN804"></a>                    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>bucket</span><span class='Delimiter'>, 
</span><a name="LN805"></a>                    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>bucket_blkno</span><span class='Delimiter'>, 
</span><a name="LN806"></a>                    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>bucket_buf</span><span class='Delimiter'>, 
</span><a name="LN807"></a>                    <a href="../../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN809"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>wblkno</span><span class='Delimiter'>; 
</span><a name="LN810"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rblkno</span><span class='Delimiter'>; 
</span><a name="LN811"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>wbuf</span><span class='Delimiter'>; 
</span><a name="LN812"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuf</span><span class='Delimiter'>; 
</span><a name="LN813"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>wpage</span><span class='Delimiter'>; 
</span><a name="LN814"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>rpage</span><span class='Delimiter'>; 
</span><a name="LN815"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>wopaque</span><span class='Delimiter'>; 
</span><a name="LN816"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>ropaque</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * start squeezing into the primary bucket page. 
     */ 
</span>    <a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN805"><span class='Ref_to_Parameter'>bucket_blkno</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN806"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN813"><span class='Ref_To_Local'>wpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN815"><span class='Ref_To_Local'>wopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN813"><span class='Ref_To_Local'>wpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * if there aren't any overflow pages, there's nothing to squeeze. caller 
     * is responsible for releasing the pin on primary bucket page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN815"><span class='Ref_To_Local'>wopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find the last page in the bucket chain by starting at the base bucket 
     * page and working forward.  Note: we assume that a hash bucket chain is 
     * usually smaller than the buffer ring being used by VACUUM, else using 
     * the access strategy here would be counterproductive. 
     */ 
</span>    <a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN815"><span class='Ref_To_Local'>wopaque</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN245"><span class='Ref_to_Func'>_hash_getbuf_with_strategy</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                          <a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>, 
</span>                                          <a href="hashovfl.c.html#LN807"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN804"><span class='Ref_to_Parameter'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * squeeze the tuples. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN864"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>roffnum</span><span class='Delimiter'>; 
</span><a name="LN865"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxroffnum</span><span class='Delimiter'>; 
</span><a name="LN866"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>deletable</span><span class='Delimiter'>[</span><a href="../../../include/storage/off.h.html#LN27"><span class='Ref_to_Const'>MaxOffsetNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN867"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itups</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN868"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>tups_size</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN869"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>itup_offsets</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN870"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>ndeletable</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN871"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>nitups</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN872"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>all_tups_size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN873"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN874"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>retain_pin</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN876"></a><span class='Label'>readpage</span><span class='Operator'>: 
</span>        <span class='Comment_Multi_Line'>/* Scan each tuple in "read" page */ 
</span>        <a href="hashovfl.c.html#LN865"><span class='Ref_To_Local'>maxroffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>             <a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a> <span class='Operator'>&LT;= </span><a href="hashovfl.c.html#LN865"><span class='Ref_To_Local'>maxroffnum</span></a><span class='Delimiter'>; 
</span>             <a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN883"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN884"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itemsz</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* skip dead tuples */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="hashovfl.c.html#LN883"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="hashovfl.c.html#LN884"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN70"><span class='Ref_to_Macro'>IndexTupleDSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashovfl.c.html#LN883"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hashovfl.c.html#LN884"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN884"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Walk up the bucket chain, looking for a page big enough for 
             * this item and all other accumulated items.  Exit if we reach 
             * the read page. 
             */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN427"><span class='Ref_to_Proto'>PageGetFreeSpaceForMultipleTuples</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN813"><span class='Ref_To_Local'>wpage</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN872"><span class='Ref_To_Local'>all_tups_size</span></a> <span class='Operator'>+ </span><a href="hashovfl.c.html#LN884"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN902"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>next_wbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN903"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>tups_moved</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN813"><span class='Ref_To_Local'>wpage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN805"><span class='Ref_to_Parameter'>bucket_blkno</span></a><span class='Parentheses'>) 
</span>                    <a href="hashovfl.c.html#LN874"><span class='Ref_To_Local'>retain_pin</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN815"><span class='Ref_To_Local'>wopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* don't need to move to next page if we reached the read page */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a> <span class='Operator'>!= </span><a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a><span class='Parentheses'>) 
</span>                    <a href="hashovfl.c.html#LN902"><span class='Ref_To_Local'>next_wbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN245"><span class='Ref_to_Func'>_hash_getbuf_with_strategy</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                                           <a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a><span class='Delimiter'>, 
</span>                                                           <a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, 
</span>                                                           <a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>, 
</span>                                                           <a href="hashovfl.c.html#LN807"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN870"><span class='Ref_To_Local'>ndeletable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * This operation needs to log multiple tuples, prepare 
                     * WAL for that. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
                        <a href="../../../include/access/xloginsert.h.html#LN44"><span class='Ref_to_Proto'>XLogEnsureRecordSpace</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>3</span> <span class='Operator'>+ </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * we have to insert tuples on the "write" page, being 
                     * careful to preserve hashkey ordering.  (If we insert 
                     * many tuples into the same "write" page it would be 
                     * worth qsort'ing them). 
                     */ 
</span>                    <a href="hashinsert.c.html#LN295"><span class='Ref_to_Func'>_hash_pgaddmultitup</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN867"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN869"><span class='Ref_To_Local'>itup_offsets</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Delete tuples we already moved off read page */ 
</span>                    <a href="../../../include/storage/bufpage.h.html#LN431"><span class='Ref_to_Proto'>PageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN866"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN870"><span class='Ref_To_Local'>ndeletable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span><a name="LN950"></a>                        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN951"></a>                        <a href="../../../include/access/hash_xlog.h.html#LN150"><span class='Ref_to_Struct'>xl_hash_move_page_contents</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
                        <a href="hashovfl.c.html#LN951"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN152"><span class='Ref_to_Member'>ntups</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>; 
</span>                        <a href="hashovfl.c.html#LN951"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN153"><span class='Ref_to_Member'>is_prim_bucket_same_wrt</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN806"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Boolean'>true </span><span class='Operator'>: </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashovfl.c.html#LN951"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN158"><span class='Ref_to_Const'>SizeOfHashMovePageContents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * bucket buffer needs to be registered to ensure that 
                         * we can acquire a cleanup lock on it during replay. 
                         */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashovfl.c.html#LN951"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN153"><span class='Ref_to_Member'>is_prim_bucket_same_wrt</span></a><span class='Parentheses'>) 
</span>                            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN806"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN30"><span class='Ref_to_Const'>REGBUF_NO_IMAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN869"><span class='Ref_To_Local'>itup_offsets</span></a><span class='Delimiter'>, 
</span>                                            <a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN867"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="hashovfl.c.html#LN868"><span class='Ref_To_Local'>tups_size</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashovfl.c.html#LN866"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, 
</span>                                          <a href="hashovfl.c.html#LN870"><span class='Ref_To_Local'>ndeletable</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                        <a href="hashovfl.c.html#LN950"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN34"><span class='Ref_to_Const'>XLOG_HASH_MOVE_PAGE_CONTENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN950"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN950"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
                    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                    <a href="hashovfl.c.html#LN903"><span class='Ref_To_Local'>tups_moved</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nitups&GT;0 &raquo; </span> 
 
                <span class='Comment_Multi_Line'>/* 
                 * release the lock on previous page after acquiring the lock 
                 * on next page 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN874"><span class='Ref_To_Local'>retain_pin</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* nothing more to do if we reached the read page */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN902"><span class='Ref_To_Local'>next_wbuf</span></a><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN813"><span class='Ref_To_Local'>wpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN815"><span class='Ref_To_Local'>wopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN813"><span class='Ref_To_Local'>wpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN815"><span class='Ref_To_Local'>wopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN804"><span class='Ref_to_Parameter'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN874"><span class='Ref_To_Local'>retain_pin</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* be tidy */ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN867"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN872"><span class='Ref_To_Local'>all_tups_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="hashovfl.c.html#LN870"><span class='Ref_To_Local'>ndeletable</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * after moving the tuples, rpage would have been compacted, 
                 * so we need to rescan it. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN903"><span class='Ref_To_Local'>tups_moved</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="hashovfl.c.html#LN876"><span class='Ref_to_Label'>readpage</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while PageGetFreeSpaceForMu... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* remember tuple for deletion from "read" page */ 
</span>            <a href="hashovfl.c.html#LN866"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN870"><span class='Ref_To_Local'>ndeletable</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="hashovfl.c.html#LN864"><span class='Ref_To_Local'>roffnum</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * we need a copy of index tuples as they can be freed as part of 
             * overflow page, however we need them to write a WAL record in 
             * _hash_freeovflpage. 
             */ 
</span>            <a href="hashovfl.c.html#LN867"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN883"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hashovfl.c.html#LN868"><span class='Ref_To_Local'>tups_size</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="hashovfl.c.html#LN884"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>; 
</span>            <a href="hashovfl.c.html#LN872"><span class='Ref_To_Local'>all_tups_size</span></a> <span class='Operator'>+= </span><a href="hashovfl.c.html#LN884"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for roffnum=FirstOffsetNu... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If we reach here, there are no live tuples on the "read" page --- 
         * it was empty when we got to it, or we moved them all.  So we can 
         * just free the page without bothering with deleting tuples 
         * individually.  Then advance to the previous "read" page. 
         * 
         * Tricky point here: if our read and write pages are adjacent in the 
         * bucket chain, our write lock on wbuf will conflict with 
         * _hash_freeovflpage's attempt to update the sibling links of the 
         * removed page.  In that case, we don't need to lock it again. 
         */ 
</span>        <a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* free this overflow page (releases rbuf) */ 
</span>        <a href="../../../include/access/hash.h.html#LN339"><span class='Ref_to_Proto'>_hash_freeovflpage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN806"><span class='Ref_to_Parameter'>bucket_buf</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN867"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN869"><span class='Ref_To_Local'>itup_offsets</span></a><span class='Delimiter'>, 
</span>                           <a href="hashovfl.c.html#LN868"><span class='Ref_To_Local'>tups_size</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN807"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* be tidy */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashovfl.c.html#LN871"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>; </span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN867"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashovfl.c.html#LN873"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* are we freeing the page adjacent to wbuf? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* retain the pin on primary bucket page till end of bucket scan */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashovfl.c.html#LN809"><span class='Ref_To_Local'>wblkno</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN805"><span class='Ref_to_Parameter'>bucket_blkno</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashovfl.c.html#LN811"><span class='Ref_To_Local'>wbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN245"><span class='Ref_to_Func'>_hash_getbuf_with_strategy</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                          <a href="hashovfl.c.html#LN810"><span class='Ref_To_Local'>rblkno</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Delimiter'>, 
</span>                                          <a href="hashovfl.c.html#LN807"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN812"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN814"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashovfl.c.html#LN816"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span><a href="hashovfl.c.html#LN804"><span class='Ref_to_Parameter'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* NOTREACHED */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _hash_squeezebucket &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>