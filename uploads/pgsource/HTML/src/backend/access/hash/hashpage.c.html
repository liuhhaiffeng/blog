<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\hash\hashpage.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\hash\hashpage.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * hashpage.c 
 *    Hash table page management code for the Postgres hash access method 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/hash/hashpage.c 
 * 
 * NOTES 
 *    Postgres hash pages look like ordinary relation pages.  The opaque 
 *    data at high addresses includes information about the page including 
 *    whether a page is an overflow page or a true bucket, the bucket 
 *    number, and the block numbers of the preceding and following pages 
 *    in the same bucket. 
 * 
 *    The first page in a hash relation, page zero, is special -- it stores 
 *    information describing the hash table; it is referred to as the 
 *    "meta page." Pages one and higher store the actual data. 
 * 
 *    There are also bitmap pages, which are not manipulated here; 
 *    see hashovfl.c. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/hash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/hash_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
 
 
<a name="LN37"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>_hash_alloc_buckets</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>firstblock</span><span class='Delimiter'>, 
</span><a name="LN38"></a>                    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>nblocks</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN39"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_hash_splitbucket</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>metabuf</span><span class='Delimiter'>, 
</span><a name="LN40"></a>                  <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>obucket</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>nbucket</span><span class='Delimiter'>, 
</span><a name="LN41"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>obuf</span><span class='Delimiter'>, 
</span><a name="LN42"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>nbuf</span><span class='Delimiter'>, 
</span><a name="LN43"></a>                  <a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>htab</span><span class='Delimiter'>, 
</span><a name="LN44"></a>                  <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>maxbucket</span><span class='Delimiter'>, 
</span><a name="LN45"></a>                  <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>highmask</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>lowmask</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN46"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>log_split_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * We use high-concurrency locking on hash indexes (see README for an overview 
 * of the locking rules).  However, we can skip taking lmgr locks when the 
 * index is local to the current backend (ie, either temp or new in the 
 * current transaction).  No one else can see it, so there's no reason to 
 * take locks.  We still take buffer-level locks, but not lmgr locks. 
 */ 
</span><a name="LN56"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>USELOCKING</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Parentheses'>)</span>     <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN523"><span class='Ref_to_Macro'>RELATION_IS_LOCAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN56"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_getbuf() -- Get a buffer by block number for read or write. 
 * 
 *      'access' must be HASH_READ, HASH_WRITE, or HASH_NOLOCK. 
 *      'flags' is a bitwise OR of the allowed page types. 
 * 
 *      This must be used only to fetch pages that are expected to be valid 
 *      already.  _hash_checkpage() is applied using the given flags. 
 * 
 *      When this routine returns, the appropriate lock is set on the 
 *      requested buffer and its reference count has been incremented 
 *      (ie, the buffer is "locked and pinned"). 
 * 
 *      P_NEW is disallowed because this routine can only be used 
 *      to access pages that are known to be before the filesystem EOF. 
 *      Extending the index should be done with _hash_getnewbuf. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN77"></a><span class='Declare_Function'>_hash_getbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN79"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash AM does not use P_NEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN79"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>!= </span><a href="../../../include/access/hash.h.html#LN284"><span class='Ref_to_Const'>HASH_NOLOCK</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN79"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ref count and lock type are correct */ 
</span> 
    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN79"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN77"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN79"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * _hash_getbuf_with_condlock_cleanup() -- Try to get a buffer for cleanup. 
 * 
 *      We read the page and try to acquire a cleanup lock.  If we get it, 
 *      we return the buffer; otherwise, we return InvalidBuffer. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN103"></a><span class='Declare_Function'>_hash_getbuf_with_condlock_cleanup</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN105"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN103"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash AM does not use P_NEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN105"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN103"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN217"><span class='Ref_to_Proto'>ConditionalLockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN105"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN105"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* ref count and lock type are correct */ 
</span> 
    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN105"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN103"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN105"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_getbuf_with_condlock_cleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_getinitbuf() -- Get and initialize a buffer by block number. 
 * 
 *      This must be used only to fetch pages that are known to be before 
 *      the index's filesystem EOF, but are to be filled from scratch. 
 *      _hash_pageinit() is applied automatically.  Otherwise it has 
 *      effects similar to _hash_getbuf() with access = HASH_WRITE. 
 * 
 *      When this routine returns, a write lock is set on the 
 *      requested buffer and its reference count has been incremented 
 *      (ie, the buffer is "locked and pinned"). 
 * 
 *      P_NEW is disallowed because this routine can only be used 
 *      to access pages that are known to be before the filesystem EOF. 
 *      Extending the index should be done with _hash_getnewbuf. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN142"></a><span class='Declare_Function'>_hash_getinitbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN144"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN142"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash AM does not use P_NEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN144"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN142"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN142"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN40"><span class='Ref_to_EnumConst'>RBM_ZERO_AND_LOCK</span></a><span class='Delimiter'>, 
</span>                             <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ref count and lock type are correct */ 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the page */ 
</span>    <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN144"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN144"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN144"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _hash_initbuf() -- Get and initialize a buffer by bucket number. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN164"></a><span class='Declare_Function'>_hash_initbuf</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>max_bucket</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>num_bucket</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>flag</span><span class='Delimiter'>, 
</span><a name="LN165"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>initpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN167"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>pageopaque</span><span class='Delimiter'>; 
</span><a name="LN168"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN168"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN164"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN165"><span class='Ref_to_Parameter'>initpage</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN168"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN164"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN167"><span class='Ref_To_Local'>pageopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN168"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set hasho_prevblkno with current hashm_maxbucket. This value will be 
     * used to validate cached HashMetaPageData. See 
     * _hash_getbucketbuf_from_hashkey(). 
     */ 
</span>    <a href="hashpage.c.html#LN167"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN164"><span class='Ref_to_Parameter'>max_bucket</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN167"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN167"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN164"><span class='Ref_to_Parameter'>num_bucket</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN167"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN164"><span class='Ref_to_Parameter'>flag</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN167"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_initbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_getnewbuf() -- Get a new page at the end of the index. 
 * 
 *      This has the same API as _hash_getinitbuf, except that we are adding 
 *      a page to the index, and hence expect the page to be past the 
 *      logical EOF.  (However, we have to support the case where it isn't, 
 *      since a prior try might have crashed after extending the filesystem 
 *      EOF but before updating the metapage to reflect the added page.) 
 * 
 *      It is caller's responsibility to ensure that only one process can 
 *      extend the index at a time.  In practice, this function is called 
 *      only while holding write lock on the metapage, because adding a page 
 *      is always associated with an update of metapage data. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN205"></a><span class='Declare_Function'>_hash_getnewbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN207"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblocks</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN188"><span class='Ref_to_Proto'>RelationGetNumberOfBlocksInFork</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN208"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash AM does not use P_NEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>&GT; </span><a href="hashpage.c.html#LN207"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"access to noncontiguous page in hash index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* smgr insists we use P_NEW to extend the relation */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN207"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected hash relation size: %u, should be %u"</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN205"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN40"><span class='Ref_to_EnumConst'>RBM_ZERO_AND_LOCK</span></a><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* ref count and lock type are correct */ 
</span> 
    <span class='Comment_Multi_Line'>/* initialize the page */ 
</span>    <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN208"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_getnewbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_getbuf_with_strategy() -- Get a buffer with nondefault strategy. 
 * 
 *      This is identical to _hash_getbuf() but also allows a buffer access 
 *      strategy to be specified.  We use this for VACUUM operations. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN246"></a><span class='Declare_Function'>_hash_getbuf_with_strategy</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, 
</span><a name="LN247"></a>                           <span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Delimiter'>, 
</span><a name="LN248"></a>                           <a href="../../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN250"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN246"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash AM does not use P_NEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN250"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN246"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN246"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN248"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN247"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>!= </span><a href="../../../include/access/hash.h.html#LN284"><span class='Ref_to_Const'>HASH_NOLOCK</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN250"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN247"><span class='Ref_to_Parameter'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ref count and lock type are correct */ 
</span> 
    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN246"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN250"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN247"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN250"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_getbuf_with_strategy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_relbuf() -- release a locked buffer. 
 * 
 * Lock and pin (refcount) are both dropped. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN273"></a><span class='Declare_Function'>_hash_relbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN273"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _hash_dropbuf() -- release an unlocked buffer. 
 * 
 * This is used to unpin a buffer on which we hold no lock. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN284"></a><span class='Declare_Function'>_hash_dropbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN284"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _hash_dropscanbuf() -- release buffers used in scan. 
 * 
 * This routine unpins the buffers used during scan on which we 
 * hold no lock. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN296"></a><span class='Declare_Function'>_hash_dropscanbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Parameter'>so</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* release pin we hold on primary bucket page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>!= </span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>)</span> 
        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release pin we hold on primary bucket page  of bucket being split */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a> <span class='Operator'>!= </span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>)</span> 
        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release any pin we still hold */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>))</span> 
        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* reset split scan */ 
</span>    <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN296"><span class='Ref_to_Parameter'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_dropscanbuf &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_init() -- Initialize the metadata page of a hash index, 
 *              the initial buckets, and the initial bitmap page. 
 * 
 * The initial number of buckets is dependent on num_tuples, an estimate 
 * of the number of tuples to be loaded into the index initially.  The 
 * chosen number of buckets is returned. 
 * 
 * We are fairly cavalier about locking here, since we know that no one else 
 * could be accessing this index.  In particular the rule about not holding 
 * multiple buffer locks is ignored. 
 */ 
</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN334"></a><span class='Declare_Function'>_hash_init</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Declare_Parameter'>num_tuples</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN336"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN337"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN338"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>bitmapbuf</span><span class='Delimiter'>; 
</span><a name="LN339"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>pg</span><span class='Delimiter'>; 
</span><a name="LN340"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN341"></a>    <a href="../../../include/c.h.html#LN394"><span class='Ref_to_Typedef'>RegProcedure</span></a> <span class='Declare_Local'>procid</span><span class='Delimiter'>; 
</span><a name="LN342"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>data_width</span><span class='Delimiter'>; 
</span><a name="LN343"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>item_width</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>ffactor</span><span class='Delimiter'>; 
</span><a name="LN345"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>num_buckets</span><span class='Delimiter'>; 
</span><a name="LN346"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* safety check */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN188"><span class='Ref_to_Proto'>RelationGetNumberOfBlocksInFork</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot initialize non-empty hash index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine the target fill factor (in tuples per bucket) for this index. 
     * The idea is to make the fill factor correspond to pages about as full 
     * as the user-settable fillfactor parameter says.  We can compute it 
     * exactly since the index datatype (i.e. uint32 hash key) is fixed-width. 
     */ 
</span>    <a href="hashpage.c.html#LN342"><span class='Ref_To_Local'>data_width</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN343"><span class='Ref_To_Local'>item_width</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN342"><span class='Ref_To_Local'>data_width</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* include the line pointer */ 
</span>    <a href="hashpage.c.html#LN344"><span class='Ref_To_Local'>ffactor</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN300"><span class='Ref_to_Macro'>RelationGetTargetPageUsage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN239"><span class='Ref_to_Const'>HASH_DEFAULT_FILLFACTOR</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="hashpage.c.html#LN343"><span class='Ref_To_Local'>item_width</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* keep to a sane range */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN344"><span class='Ref_To_Local'>ffactor</span></a> <span class='Operator'>&LT; </span><span class='Number'>10</span><span class='Parentheses'>) 
</span>        <a href="hashpage.c.html#LN344"><span class='Ref_To_Local'>ffactor</span></a> <span class='Operator'>= </span><span class='Number'>10</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN341"><span class='Ref_To_Local'>procid</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN172"><span class='Ref_to_Proto'>index_getprocid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN297"><span class='Ref_to_Const'>HASHPROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We initialize the metapage, the first N bucket pages, and the first 
     * bitmap page in sequence, using _hash_getnewbuf to cause smgrextend() 
     * calls to occur.  This ensures that the smgr level has the right idea of 
     * the physical index length. 
     * 
     * Critical section not required, because on error the creation of the 
     * whole relation will be rolled back. 
     */ 
</span>    <a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN204"><span class='Ref_to_Func'>_hash_getnewbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN158"><span class='Ref_to_Const'>HASH_METAPAGE</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/hash.h.html#LN372"><span class='Ref_to_Proto'>_hash_init_metabuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>num_tuples</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN341"><span class='Ref_To_Local'>procid</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN344"><span class='Ref_To_Local'>ffactor</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN339"><span class='Ref_To_Local'>pg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN339"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN388"></a>        <a href="../../../include/access/hash_xlog.h.html#LN230"><span class='Ref_to_Struct'>xl_hash_init_meta_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN389"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN388"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN232"><span class='Ref_to_Member'>num_tuples</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>num_tuples</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN388"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN233"><span class='Ref_to_Member'>procid</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN219"><span class='Ref_to_Member'>hashm_procid</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN388"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN234"><span class='Ref_to_Member'>ffactor</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN207"><span class='Ref_to_Member'>hashm_ffactor</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN388"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN237"><span class='Ref_to_Const'>SizeOfHashInitMetaPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN389"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN26"><span class='Ref_to_Const'>XLOG_HASH_INIT_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN389"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hashpage.c.html#LN345"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release buffer lock on the metapage while we initialize buckets. 
     * Otherwise, we'll be in interrupt holdoff and the CHECK_FOR_INTERRUPTS 
     * won't accomplish anything.  It's a bad idea to hold buffer locks for 
     * long intervals in any case, since that can block the bgwriter. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize and WAL Log the first N buckets 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashpage.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashpage.c.html#LN345"><span class='Ref_To_Local'>num_buckets</span></a><span class='Delimiter'>; </span><a href="hashpage.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN419"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Allow interrupts, in case N is huge */ 
</span>        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN419"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN37"><span class='Ref_to_Macro'>BUCKET_TO_BLKNO</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN337"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN204"><span class='Ref_to_Func'>_hash_getnewbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN419"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN163"><span class='Ref_to_Func'>_hash_initbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN337"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN337"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN54"><span class='Ref_to_Proto'>log_newpage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>, 
</span>                    <a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, 
</span>                    <a href="hashpage.c.html#LN419"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN337"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN337"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now reacquire buffer lock on metapage */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize bitmap page 
     */ 
</span>    <a href="hashpage.c.html#LN338"><span class='Ref_To_Local'>bitmapbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN204"><span class='Ref_to_Func'>_hash_getnewbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN345"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/hash.h.html#LN342"><span class='Ref_to_Proto'>_hash_initbitmapbuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN338"><span class='Ref_To_Local'>bitmapbuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN209"><span class='Ref_to_Member'>hashm_bmsize</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN338"><span class='Ref_To_Local'>bitmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* add the new bitmap page to the metapage's list of bitmaps */ 
</span>    <span class='Comment_Multi_Line'>/* metapage already has a write lock */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/hash.h.html#LN188"><span class='Ref_to_Const'>HASH_MAX_BITMAPS</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of overflow pages in hash index \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN222"><span class='Ref_to_Member'>hashm_mapp</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="hashpage.c.html#LN345"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN463"></a>        <a href="../../../include/access/hash_xlog.h.html#LN248"><span class='Ref_to_Struct'>xl_hash_init_bitmap_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN464"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN463"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN250"><span class='Ref_to_Member'>bmsize</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN340"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN209"><span class='Ref_to_Member'>hashm_bmsize</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN463"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN253"><span class='Ref_to_Const'>SizeOfHashInitBitmapPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN338"><span class='Ref_To_Local'>bitmapbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This is safe only because nobody else can be modifying the index at 
         * this stage; it's only visible to the transaction that is creating 
         * it. 
         */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN464"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN27"><span class='Ref_to_Const'>XLOG_HASH_INIT_BITMAP_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN338"><span class='Ref_To_Local'>bitmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN464"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN464"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* all done */ 
</span>    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN338"><span class='Ref_To_Local'>bitmapbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN334"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN336"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN345"><span class='Ref_To_Local'>num_buckets</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_init_metabuffer() -- Initialize the metadata page of a hash index. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN496"></a><span class='Declare_Function'>_hash_init_metabuffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Declare_Parameter'>num_tuples</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN394"><span class='Ref_to_Typedef'>RegProcedure</span></a> <span class='Declare_Parameter'>procid</span><span class='Delimiter'>, 
</span><a name="LN497"></a>                      <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>ffactor</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>initpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN499"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN500"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>pageopaque</span><span class='Delimiter'>; 
</span><a name="LN501"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN502"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>dnumbuckets</span><span class='Delimiter'>; 
</span><a name="LN503"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>num_buckets</span><span class='Delimiter'>; 
</span><a name="LN504"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>spare_index</span><span class='Delimiter'>; 
</span><a name="LN505"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Choose the number of initial bucket pages to match the fill factor 
     * given the estimated number of tuples.  We round up the result to the 
     * total number of buckets which has to be allocated before using its 
     * _hashm_spare element. However always force at least 2 bucket pages. The 
     * upper limit is determined by considerations explained in 
     * _hash_expandtable(). 
     */ 
</span>    <a href="hashpage.c.html#LN502"><span class='Ref_To_Local'>dnumbuckets</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN496"><span class='Ref_to_Parameter'>num_tuples</span></a> <span class='Operator'>/ </span><a href="hashpage.c.html#LN497"><span class='Ref_to_Parameter'>ffactor</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN502"><span class='Ref_To_Local'>dnumbuckets</span></a> <span class='Operator'>&LT;= </span><span class='Number'>2</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="hashpage.c.html#LN503"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN502"><span class='Ref_To_Local'>dnumbuckets</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><span class='Number'>0x40000000</span><span class='Parentheses'>)</span> 
        <a href="hashpage.c.html#LN503"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>= </span><span class='Number'>0x40000000</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hashpage.c.html#LN503"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN187"><span class='Ref_to_Func'>_hash_get_totalbuckets</span></a><span class='Parentheses'>(</span><a href="hashutil.c.html#LN155"><span class='Ref_to_Func'>_hash_spareindex</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN502"><span class='Ref_To_Local'>dnumbuckets</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN504"><span class='Ref_To_Local'>spare_index</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN155"><span class='Ref_to_Func'>_hash_spareindex</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN503"><span class='Ref_To_Local'>num_buckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN504"><span class='Ref_To_Local'>spare_index</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/hash.h.html#LN197"><span class='Ref_to_Const'>HASH_MAX_SPLITPOINTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN496"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN497"><span class='Ref_to_Parameter'>initpage</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN496"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN500"><span class='Ref_To_Local'>pageopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN500"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN500"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN500"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN500"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN55"><span class='Ref_to_Const'>LH_META_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN500"><span class='Ref_To_Local'>pageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN204"><span class='Ref_to_Member'>hashm_magic</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN160"><span class='Ref_to_Const'>HASH_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN205"><span class='Ref_to_Member'>hashm_version</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN161"><span class='Ref_to_Const'>HASH_VERSION</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN218"><span class='Ref_to_Member'>hashm_nmaps</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN207"><span class='Ref_to_Member'>hashm_ffactor</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN497"><span class='Ref_to_Parameter'>ffactor</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN208"><span class='Ref_to_Member'>hashm_bsize</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN262"><span class='Ref_to_Macro'>HashGetMaxBitmapSize</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* find largest bitmap array size that will fit in page size */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN139"><span class='Ref_to_Func'>_hash_log2</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN208"><span class='Ref_to_Member'>hashm_bsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN208"><span class='Ref_to_Member'>hashm_bsize</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN209"><span class='Ref_to_Member'>hashm_bmsize</span></a> <span class='Operator'>= </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN211"><span class='Ref_to_Member'>hashm_bmshift</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN505"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><a href="../../../include/access/hash.h.html#LN244"><span class='Ref_to_Const'>BYTE_TO_BIT</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../../include/access/hash.h.html#LN256"><span class='Ref_to_Macro'>BMPG_SHIFT</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN257"><span class='Ref_to_Macro'>BMPG_MASK</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Label the index with its primary hash support function's OID.  This is 
     * pretty useless for normal operation (in fact, hashm_procid is not used 
     * anywhere), but it might be handy for forensic purposes so we keep it. 
     */ 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN219"><span class='Ref_to_Member'>hashm_procid</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN496"><span class='Ref_to_Parameter'>procid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We initialize the index with N buckets, 0 .. N-1, occupying physical 
     * blocks 1 to N.  The first freespace bitmap page is in block N+1. 
     */ 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN503"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set highmask as next immediate ((2 ^ x) - 1), which should be 
     * sufficient to cover num_buckets. 
     */ 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="hashutil.c.html#LN139"><span class='Ref_to_Func'>_hash_log2</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN503"><span class='Ref_To_Local'>num_buckets</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)))</span> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN222"><span class='Ref_to_Member'>hashm_mapp</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN222"><span class='Ref_to_Member'>hashm_mapp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up mapping for one spare page after the initial splitpoints */ 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN504"><span class='Ref_To_Local'>spare_index</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN504"><span class='Ref_To_Local'>spare_index</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN217"><span class='Ref_to_Member'>hashm_firstfree</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set pd_lower just past the end of the metadata.  This is to log full 
     * page image of metapage in xloginsert.c. 
     */ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>= 
</span>        <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashpage.c.html#LN499"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN202"><span class='Ref_to_Struct'>HashMetaPageData</span></a><span class='Parentheses'>))</span> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="hashpage.c.html#LN501"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_init_metabuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_pageinit() -- Initialize a new hash index page. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN596"></a><span class='Declare_Function'>_hash_pageinit</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN596"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN596"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN75"><span class='Ref_to_Struct'>HashPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Attempt to expand the hash table by creating one new bucket. 
 * 
 * This will silently do nothing if we don't get cleanup lock on old or 
 * new bucket. 
 * 
 * Complete the pending splits and remove the tuples from old bucket, 
 * if there are any left over from the previous split. 
 * 
 * The caller must hold a pin, but no lock, on the metapage buffer. 
 * The buffer is returned in the same state. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN614"></a><span class='Declare_Function'>_hash_expandtable</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>metabuf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN616"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN617"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>old_bucket</span><span class='Delimiter'>; 
</span><a name="LN618"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>new_bucket</span><span class='Delimiter'>; 
</span><a name="LN619"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>spare_ndx</span><span class='Delimiter'>; 
</span><a name="LN620"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>start_oblkno</span><span class='Delimiter'>; 
</span><a name="LN621"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>start_nblkno</span><span class='Delimiter'>; 
</span><a name="LN622"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf_nblkno</span><span class='Delimiter'>; 
</span><a name="LN623"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf_oblkno</span><span class='Delimiter'>; 
</span><a name="LN624"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>opage</span><span class='Delimiter'>; 
</span><a name="LN625"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>npage</span><span class='Delimiter'>; 
</span><a name="LN626"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>oopaque</span><span class='Delimiter'>; 
</span><a name="LN627"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>nopaque</span><span class='Delimiter'>; 
</span><a name="LN628"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>maxbucket</span><span class='Delimiter'>; 
</span><a name="LN629"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>highmask</span><span class='Delimiter'>; 
</span><a name="LN630"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lowmask</span><span class='Delimiter'>; 
</span><a name="LN631"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>metap_update_masks</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN632"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>metap_update_splitpoint</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN634"></a><span class='Label'>restart_expand</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write-lock the meta page.  It used to be necessary to acquire a 
     * heavyweight lock to begin a split, but that is no longer required. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN55"><span class='Ref_to_Const'>LH_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to see if split is still needed; someone else might have already 
     * done one while we waited for the lock. 
     * 
     * Make sure this stays in sync with _hash_doinsert() 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN206"><span class='Ref_to_Member'>hashm_ntuples</span></a> <span class='Operator'>&LT;= 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN207"><span class='Ref_to_Member'>hashm_ffactor</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="hashpage.c.html#LN956"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Can't split anymore if maxbucket has reached its maximum possible 
     * value. 
     * 
     * Ideally we'd allow bucket numbers up to UINT_MAX-1 (no higher because 
     * the calculation maxbucket+1 mustn't overflow).  Currently we restrict 
     * to half that because of overflow looping in _hash_log2() and 
     * insufficient space in hashm_spares[].  It's moot anyway because an 
     * index with 2^32 buckets would certainly overflow BlockNumber and hence 
     * _hash_alloc_buckets() would fail, but if we supported buckets smaller 
     * than a disk block then this would be an independent constraint. 
     * 
     * If you change this, see also the maximum initial number of buckets in 
     * _hash_init(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><span class='Number'>0x7FFFFFFE</span><span class='Parentheses'>)</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="hashpage.c.html#LN956"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine which bucket is to be split, and attempt to take cleanup lock 
     * on the old bucket.  If we can't get the lock, give up. 
     * 
     * The cleanup lock protects us not only against other backends, but 
     * against our own backend as well. 
     * 
     * The cleanup lock is mainly to protect the split from concurrent 
     * inserts. See src/backend/access/hash/README, Lock Definitions for 
     * further details.  Due to this locking restriction, if there is any 
     * pending scan, the split will give up which is not good, but harmless. 
     */ 
</span>    <a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN617"><span class='Ref_To_Local'>old_bucket</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>& </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN620"><span class='Ref_To_Local'>start_oblkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN37"><span class='Ref_to_Macro'>BUCKET_TO_BLKNO</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN617"><span class='Ref_To_Local'>old_bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN102"><span class='Ref_to_Func'>_hash_getbuf_with_condlock_cleanup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN620"><span class='Ref_To_Local'>start_oblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="hashpage.c.html#LN956"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN624"><span class='Ref_To_Local'>opage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN624"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We want to finish the split from a bucket as there is no apparent 
     * benefit by not doing so and it will make the code complicated to finish 
     * the split that involves multiple buckets considering the case where new 
     * split also fails.  We don't need to consider the new bucket for 
     * completing the split here as it is not possible that a re-split of new 
     * bucket starts when there is still a pending split from old bucket. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN87"><span class='Ref_to_Macro'>H_BUCKET_BEING_SPLIT</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Copy bucket mapping info now; refer the comment in code below where 
         * we copy this information before calling _hash_splitbucket to see 
         * why this is okay. 
         */ 
</span>        <a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN629"><span class='Ref_To_Local'>highmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN630"><span class='Ref_To_Local'>lowmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Release the lock on metapage and old_bucket, before completing the 
         * split. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/hash.h.html#LN376"><span class='Ref_to_Proto'>_hash_finish_split</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN617"><span class='Ref_To_Local'>old_bucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a><span class='Delimiter'>, 
</span>                           <a href="hashpage.c.html#LN629"><span class='Ref_To_Local'>highmask</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN630"><span class='Ref_To_Local'>lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* release the pin on old buffer and retry for expand. */ 
</span>        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="hashpage.c.html#LN634"><span class='Ref_to_Label'>restart_expand</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if H_BUCKET_BEING_SPLIT(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Clean the tuples remained from the previous split.  This operation 
     * requires cleanup lock and we already have one on the old bucket, so 
     * let's do it. We also don't want to allow further splits from the bucket 
     * till the garbage of previous split is cleaned.  This has two 
     * advantages; first, it helps in avoiding the bloat due to garbage and 
     * second is, during cleanup of bucket, we are always sure that the 
     * garbage tuples belong to most recently split bucket.  On the contrary, 
     * if we allow cleanup of bucket after meta page is updated to indicate 
     * the new split and before the actual split, the cleanup operation won't 
     * be able to decide whether the tuple has been moved to the newly created 
     * bucket and ended up deleting such tuples. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN86"><span class='Ref_to_Macro'>H_NEEDS_SPLIT_CLEANUP</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Copy bucket mapping info now; refer to the comment in code below 
         * where we copy this information before calling _hash_splitbucket to 
         * see why this is okay. 
         */ 
</span>        <a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN629"><span class='Ref_To_Local'>highmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN630"><span class='Ref_To_Local'>lowmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release the metapage lock. */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/hash.h.html#LN417"><span class='Ref_to_Proto'>hashbucketcleanup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN617"><span class='Ref_To_Local'>old_bucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN620"><span class='Ref_To_Local'>start_oblkno</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                          <a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN629"><span class='Ref_To_Local'>highmask</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN630"><span class='Ref_To_Local'>lowmask</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="hashpage.c.html#LN634"><span class='Ref_to_Label'>restart_expand</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if H_NEEDS_SPLIT_CLEANUP... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * There shouldn't be any active scan on new bucket. 
     * 
     * Note: it is safe to compute the new bucket's blkno here, even though we 
     * may still need to update the BUCKET_TO_BLKNO mapping.  This is because 
     * the current value of hashm_spares[hashm_ovflpoint] correctly shows 
     * where we are going to put a new splitpoint's worth of buckets. 
     */ 
</span>    <a href="hashpage.c.html#LN621"><span class='Ref_To_Local'>start_nblkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN37"><span class='Ref_to_Macro'>BUCKET_TO_BLKNO</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the split point is increasing we need to allocate a new batch of 
     * bucket pages. 
     */ 
</span>    <a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN155"><span class='Ref_to_Func'>_hash_spareindex</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a> <span class='Operator'>&GT; </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN786"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>buckets_to_add</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We treat allocation of buckets as a separate WAL-logged action. 
         * Even if we fail after this operation, won't leak bucket pages; 
         * rather, the next split will consume this space. In any case, even 
         * without failure we don't use all the space in one split operation. 
         */ 
</span>        <a href="hashpage.c.html#LN786"><span class='Ref_To_Local'>buckets_to_add</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN187"><span class='Ref_to_Func'>_hash_get_totalbuckets</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashpage.c.html#LN37"><span class='Ref_to_Proto'>_hash_alloc_buckets</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN621"><span class='Ref_To_Local'>start_nblkno</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN786"><span class='Ref_To_Local'>buckets_to_add</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* can't split due to BlockNumber overflow */ 
</span>            <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="hashpage.c.html#LN956"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if spare_ndx&GT;metap-&GT;hash... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Physically allocate the new bucket's primary page.  We want to do this 
     * before changing the metapage's mapping info, in case we can't get the 
     * disk space.  Ideally, we don't need to check for cleanup lock on new 
     * bucket as no other backend could find this bucket unless meta page is 
     * updated.  However, it is good to be consistent with old bucket locking. 
     */ 
</span>    <a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN204"><span class='Ref_to_Func'>_hash_getnewbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN621"><span class='Ref_To_Local'>start_nblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN218"><span class='Ref_to_Proto'>IsBufferCleanupOK</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="hashpage.c.html#LN956"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we are scribbling on the pages in the shared buffers, establish a 
     * critical section.  Any failure in this next code leaves us with a big 
     * problem: the metapage is effectively corrupt but could get written back 
     * to disk. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Okay to proceed with split.  Update the metapage bucket mapping info. 
     */ 
</span>    <a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>&GT; </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Starting a new doubling */ 
</span>        <a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>| </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN631"><span class='Ref_To_Local'>metap_update_masks</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the split point is increasing we need to adjust the hashm_spares[] 
     * array and hashm_ovflpoint so that future overflow pages will be created 
     * beyond this new batch of bucket pages. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a> <span class='Operator'>&GT; </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Delimiter'>]; 
</span>        <a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN619"><span class='Ref_To_Local'>spare_ndx</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN632"><span class='Ref_To_Local'>metap_update_splitpoint</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy bucket mapping info now; this saves re-accessing the meta page 
     * inside _hash_splitbucket's inner loop.  Note that once we drop the 
     * split lock, other splits could begin, so these values might be out of 
     * date before _hash_splitbucket finishes.  That's okay, since all it 
     * needs is to tell which of these two buckets to map hashkeys into. 
     */ 
</span>    <a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN629"><span class='Ref_To_Local'>highmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN630"><span class='Ref_To_Local'>lowmask</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN624"><span class='Ref_To_Local'>opage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN624"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the old bucket to indicate that split is in progress.  (At 
     * operation end, we will clear the split-in-progress flag.)  Also, for a 
     * primary bucket page, hasho_prevblkno stores the number of buckets that 
     * existed as of the last split, so we must update that value here. 
     */ 
</span>    <a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>|= </span><a href="../../../include/access/hash.h.html#LN57"><span class='Ref_to_Const'>LH_BUCKET_BEING_SPLIT</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN625"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize the new bucket's primary page and mark it to indicate that 
     * split is in progress. 
     */ 
</span>    <a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN625"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN56"><span class='Ref_to_Const'>LH_BUCKET_BEING_POPULATED</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN898"></a>        <a href="../../../include/access/hash_xlog.h.html#LN112"><span class='Ref_to_Struct'>xl_hash_split_allocate_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN899"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN114"><span class='Ref_to_Member'>new_bucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN115"><span class='Ref_to_Member'>old_bucket_flag</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN626"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN116"><span class='Ref_to_Member'>new_bucket_flag</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN627"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN117"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN631"><span class='Ref_To_Local'>metap_update_masks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN117"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/hash_xlog.h.html#LN52"><span class='Ref_to_Const'>XLH_SPLIT_META_UPDATE_MASKS</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN632"><span class='Ref_To_Local'>metap_update_splitpoint</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN117"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/hash_xlog.h.html#LN53"><span class='Ref_to_Const'>XLH_SPLIT_META_UPDATE_SPLITPOINT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Delimiter'>, 
</span>                                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN220"><span class='Ref_to_Member'>hashm_spares</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN616"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN215"><span class='Ref_to_Member'>hashm_ovflpoint</span></a><span class='Delimiter'>], 
</span>                                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN898"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN120"><span class='Ref_to_Const'>SizeOfHashSplitAllocPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN899"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN30"><span class='Ref_to_Const'>XLOG_HASH_SPLIT_ALLOCATE_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN899"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN899"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN899"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* drop lock, but keep pin */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Relocate records to the new bucket */ 
</span>    <a href="hashpage.c.html#LN39"><span class='Ref_to_Proto'>_hash_splitbucket</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, 
</span>                      <a href="hashpage.c.html#LN617"><span class='Ref_To_Local'>old_bucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN618"><span class='Ref_To_Local'>new_bucket</span></a><span class='Delimiter'>, 
</span>                      <a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                      <a href="hashpage.c.html#LN628"><span class='Ref_To_Local'>maxbucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN629"><span class='Ref_To_Local'>highmask</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN630"><span class='Ref_To_Local'>lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* all done, now release the locks and pins on primary buckets. */ 
</span>    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN623"><span class='Ref_To_Local'>buf_oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN622"><span class='Ref_To_Local'>buf_nblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Here if decide not to split or fail to acquire old bucket lock */ 
</span><a name="LN956"></a><span class='Label'>fail</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* We didn't write the metapage, so just drop lock */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN614"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_expandtable &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * _hash_alloc_buckets -- allocate a new splitpoint's worth of bucket pages 
 * 
 * This does not need to initialize the new bucket pages; we'll do that as 
 * each one is used by _hash_expandtable().  But we have to extend the logical 
 * EOF to the end of the splitpoint; this keeps smgr's idea of the EOF in 
 * sync with ours, so that we don't get complaints from smgr. 
 * 
 * We do this by writing a page of zeroes at the end of the splitpoint range. 
 * We expect that the filesystem will ensure that the intervening pages read 
 * as zeroes too.  On many filesystems this "hole" will not be allocated 
 * immediately, which means that the index file may end up more fragmented 
 * than if we forced it all to be allocated now; but since we don't scan 
 * hash indexes sequentially anyway, that probably doesn't matter. 
 * 
 * XXX It's annoying that this code is executed with the metapage lock held. 
 * We need to interlock against _hash_addovflpage() adding a new overflow page 
 * concurrently, but it'd likely be better to use LockRelationForExtension 
 * for the purpose.  OTOH, adding a splitpoint is a very infrequent operation, 
 * so it may not be worth worrying about. 
 * 
 * Returns TRUE if successful, or FALSE if allocation failed due to 
 * BlockNumber overflow. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN988"></a><span class='Declare_Function'>_hash_alloc_buckets</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>firstblock</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>nblocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN990"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>lastblock</span><span class='Delimiter'>; 
</span><a name="LN991"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>zerobuf</span><span class='Delimiter'>[</span>BLCKSZ<span class='Delimiter'>]; 
</span><a name="LN992"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN993"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>ovflopaque</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN990"><span class='Ref_To_Local'>lastblock</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>firstblock</span></a> <span class='Operator'>+ </span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for overflow in block number calculation; if so, we cannot extend 
     * the index anymore. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN990"><span class='Ref_To_Local'>lastblock</span></a> <span class='Operator'>&LT; </span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>firstblock</span></a> <span class='Operator'>|| </span><a href="hashpage.c.html#LN990"><span class='Ref_To_Local'>lastblock</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN992"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="hashpage.c.html#LN991"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the page.  Just zeroing the page won't work; see 
     * _hash_freeovflpage for similar usage.  We take care to make the special 
     * space valid for the benefit of tools such as pageinspect. 
     */ 
</span>    <a href="../../../include/access/hash.h.html#LN374"><span class='Ref_to_Proto'>_hash_pageinit</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN992"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN993"><span class='Ref_To_Local'>ovflopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN992"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN993"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN993"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN993"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN993"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN51"><span class='Ref_to_Const'>LH_UNUSED_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN993"><span class='Ref_To_Local'>ovflopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN81"><span class='Ref_to_Member'>hasho_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN97"><span class='Ref_to_Const'>HASHO_PAGE_ID</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/xloginsert.h.html#LN54"><span class='Ref_to_Proto'>log_newpage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, 
</span>                    <a href="hashpage.c.html#LN990"><span class='Ref_To_Local'>lastblock</span></a><span class='Delimiter'>, 
</span>                    <a href="hashpage.c.html#LN991"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/smgr.h.html#LN94"><span class='Ref_to_Proto'>smgrextend</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN988"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN990"><span class='Ref_To_Local'>lastblock</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN991"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_alloc_buckets &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * _hash_splitbucket -- split 'obucket' into 'obucket' and 'nbucket' 
 * 
 * This routine is used to partition the tuples between old and new bucket and 
 * is used to finish the incomplete split operations.  To finish the previously 
 * interrupted split operation, the caller needs to fill htab.  If htab is set, 
 * then we skip the movement of tuples that exists in htab, otherwise NULL 
 * value of htab indicates movement of all the tuples that belong to the new 
 * bucket. 
 * 
 * We are splitting a bucket that consists of a base bucket page and zero 
 * or more overflow (bucket chain) pages.  We must relocate tuples that 
 * belong in the new bucket. 
 * 
 * The caller must hold cleanup locks on both buckets to ensure that 
 * no one else is trying to access them (see README). 
 * 
 * The caller must hold a pin, but no lock, on the metapage buffer. 
 * The buffer is returned in the same state.  (The metapage is only 
 * touched if it becomes necessary to add or remove overflow pages.) 
 * 
 * Split needs to retain pin on primary bucket pages of both old and new 
 * buckets till end of operation.  This is to prevent vacuum from starting 
 * while a split is in progress. 
 * 
 * In addition, the caller must have created the new bucket's base page, 
 * which is passed in buffer nbuf, pinned and write-locked.  That lock and 
 * pin are released here.  (The API is set up this way because we must do 
 * _hash_getnewbuf() before releasing the metapage write lock.  So instead of 
 * passing the new bucket's start block number, we pass an actual buffer.) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1067"></a><span class='Declare_Function'>_hash_splitbucket</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN1068"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>metabuf</span><span class='Delimiter'>, 
</span><a name="LN1069"></a>                  <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>obucket</span><span class='Delimiter'>, 
</span><a name="LN1070"></a>                  <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>nbucket</span><span class='Delimiter'>, 
</span><a name="LN1071"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>obuf</span><span class='Delimiter'>, 
</span><a name="LN1072"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>nbuf</span><span class='Delimiter'>, 
</span><a name="LN1073"></a>                  <a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>htab</span><span class='Delimiter'>, 
</span><a name="LN1074"></a>                  <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>maxbucket</span><span class='Delimiter'>, 
</span><a name="LN1075"></a>                  <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>highmask</span><span class='Delimiter'>, 
</span><a name="LN1076"></a>                  <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>lowmask</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1078"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>bucket_obuf</span><span class='Delimiter'>; 
</span><a name="LN1079"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>bucket_nbuf</span><span class='Delimiter'>; 
</span><a name="LN1080"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>opage</span><span class='Delimiter'>; 
</span><a name="LN1081"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>npage</span><span class='Delimiter'>; 
</span><a name="LN1082"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>oopaque</span><span class='Delimiter'>; 
</span><a name="LN1083"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>nopaque</span><span class='Delimiter'>; 
</span><a name="LN1084"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>itup_offsets</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN1085"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itups</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN1086"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>all_tups_size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1087"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1088"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>nitups</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1083"><span class='Ref_To_Local'>nopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Partition the tuples in the old bucket between the old bucket and the 
     * new bucket, advancing along the old bucket's overflow bucket chain and 
     * adding overflow pages to the new bucket as needed.  Outer loop iterates 
     * once per page in old bucket. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1106"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>oblkno</span><span class='Delimiter'>; 
</span><a name="LN1107"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>ooffnum</span><span class='Delimiter'>; 
</span><a name="LN1108"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>omaxoffnum</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan each tuple in old page */ 
</span>        <a href="hashpage.c.html#LN1108"><span class='Ref_To_Local'>omaxoffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1107"><span class='Ref_To_Local'>ooffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>             <a href="hashpage.c.html#LN1107"><span class='Ref_To_Local'>ooffnum</span></a> <span class='Operator'>&LT;= </span><a href="hashpage.c.html#LN1108"><span class='Ref_To_Local'>omaxoffnum</span></a><span class='Delimiter'>; 
</span>             <a href="hashpage.c.html#LN1107"><span class='Ref_To_Local'>ooffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1107"><span class='Ref_To_Local'>ooffnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1116"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN1117"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itemsz</span><span class='Delimiter'>; 
</span><a name="LN1118"></a>            <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN1119"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* skip dead tuples */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1107"><span class='Ref_To_Local'>ooffnum</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Before inserting a tuple, probe the hash table containing TIDs 
             * of tuples belonging to new bucket, if we find a match, then 
             * skip that tuple, else fetch the item's hash key (conveniently 
             * stored in the item) and determine which bucket it now belongs 
             * in. 
             */ 
</span>            <a href="hashpage.c.html#LN1116"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1107"><span class='Ref_To_Local'>ooffnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1073"><span class='Ref_to_Parameter'>htab</span></a><span class='Parentheses'>) 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1073"><span class='Ref_to_Parameter'>htab</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1116"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1119"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1119"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="hashpage.c.html#LN1118"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN123"><span class='Ref_to_Func'>_hash_hashkey2bucket</span></a><span class='Parentheses'>(</span><a href="hashutil.c.html#LN297"><span class='Ref_to_Func'>_hash_get_indextuple_hashkey</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1116"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                          <a href="hashpage.c.html#LN1074"><span class='Ref_to_Parameter'>maxbucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1075"><span class='Ref_to_Parameter'>highmask</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1076"><span class='Ref_to_Parameter'>lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1118"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1070"><span class='Ref_to_Parameter'>nbucket</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1146"></a>                <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>new_itup</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * make a copy of index tuple as we have to scribble on it. 
                 */ 
</span>                <a href="hashpage.c.html#LN1146"><span class='Ref_To_Local'>new_itup</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1116"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * mark the index tuple as moved by split, such tuples are 
                 * skipped by scan if there is split in progress for a bucket. 
                 */ 
</span>                <a href="hashpage.c.html#LN1146"><span class='Ref_To_Local'>new_itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>|= </span><a href="../../../include/access/hash.h.html#LN236"><span class='Ref_to_Const'>INDEX_MOVED_BY_SPLIT_MASK</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * insert the tuple into the new bucket.  if it doesn't fit on 
                 * the current page in the new bucket, we must allocate a new 
                 * overflow page and place the tuple on that page instead. 
                 */ 
</span>                <a href="hashpage.c.html#LN1117"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN70"><span class='Ref_to_Macro'>IndexTupleDSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashpage.c.html#LN1146"><span class='Ref_To_Local'>new_itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="hashpage.c.html#LN1117"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1117"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN427"><span class='Ref_to_Proto'>PageGetFreeSpaceForMultipleTuples</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1086"><span class='Ref_To_Local'>all_tups_size</span></a> <span class='Operator'>+ </span><a href="hashpage.c.html#LN1117"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Change the shared buffer state in critical section, 
                     * otherwise any error could make it unrecoverable. 
                     */ 
</span>                    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                    <a href="hashinsert.c.html#LN295"><span class='Ref_to_Func'>_hash_pgaddmultitup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1085"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1084"><span class='Ref_To_Local'>itup_offsets</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* log the split operation before releasing the lock */ 
</span>                    <a href="hashpage.c.html#LN46"><span class='Ref_to_Proto'>log_split_page</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* drop lock, but keep pin */ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* be tidy */ 
</span>                    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>; </span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1085"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <a href="hashpage.c.html#LN1086"><span class='Ref_To_Local'>all_tups_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* chain to a new overflow page */ 
</span>                    <a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a> <span class='Operator'>= </span><a href="hashovfl.c.html#LN109"><span class='Ref_to_Func'>_hash_addovflpage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1068"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Boolean'>true </span><span class='Operator'>: </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="hashpage.c.html#LN1083"><span class='Ref_To_Local'>nopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PageGetFreeSpaceForMu... &raquo; </span> 
 
                <a href="hashpage.c.html#LN1085"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="hashpage.c.html#LN1146"><span class='Ref_To_Local'>new_itup</span></a><span class='Delimiter'>; 
</span>                <a href="hashpage.c.html#LN1086"><span class='Ref_To_Local'>all_tups_size</span></a> <span class='Operator'>+= </span><a href="hashpage.c.html#LN1117"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if bucket==nbucket &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * the tuple stays on this page, so nothing to do. 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1118"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1069"><span class='Ref_to_Parameter'>obucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ooffnum=FirstOffsetNu... &raquo; </span> 
 
        <a href="hashpage.c.html#LN1106"><span class='Ref_To_Local'>oblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* retain the pin on the old primary bucket */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Exit loop if no more overflow pages in old bucket */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1106"><span class='Ref_To_Local'>oblkno</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Change the shared buffer state in critical section, otherwise 
             * any error could make it unrecoverable. 
             */ 
</span>            <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="hashinsert.c.html#LN295"><span class='Ref_to_Func'>_hash_pgaddmultitup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1085"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1084"><span class='Ref_To_Local'>itup_offsets</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* log the split operation before releasing the lock */ 
</span>            <a href="hashpage.c.html#LN46"><span class='Ref_to_Proto'>log_split_page</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1072"><span class='Ref_to_Parameter'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* be tidy */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="hashpage.c.html#LN1088"><span class='Ref_To_Local'>nitups</span></a><span class='Delimiter'>; </span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1085"><span class='Ref_To_Local'>itups</span></a><span class='Delimiter'>[</span><a href="hashpage.c.html#LN1087"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !BlockNumberIsValid(o... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Else, advance to next old page */ 
</span>        <a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1106"><span class='Ref_To_Local'>oblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1071"><span class='Ref_to_Parameter'>obuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We're at the end of the old bucket chain, so we're done partitioning 
     * the tuples.  Mark the old and new buckets to indicate split is 
     * finished. 
     * 
     * To avoid deadlocks due to locking order of buckets, first lock the old 
     * bucket and then the new bucket. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1080"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1083"><span class='Ref_To_Local'>nopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1081"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/hash.h.html#LN57"><span class='Ref_to_Const'>LH_BUCKET_BEING_SPLIT</span></a><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1083"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/hash.h.html#LN56"><span class='Ref_to_Const'>LH_BUCKET_BEING_POPULATED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * After the split is finished, mark the old bucket to indicate that it 
     * contains deletable tuples.  Vacuum will clear split-cleanup flag after 
     * deleting such tuples. 
     */ 
</span>    <a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a> <span class='Operator'>|= </span><a href="../../../include/access/hash.h.html#LN58"><span class='Ref_to_Const'>LH_BUCKET_NEEDS_SPLIT_CLEANUP</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * now write the buffers, here we don't release the locks as caller is 
     * responsible to release locks. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1067"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1287"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN1288"></a>        <a href="../../../include/access/hash_xlog.h.html#LN131"><span class='Ref_to_Struct'>xl_hash_split_complete</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN1288"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN133"><span class='Ref_to_Member'>old_bucket_flag</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1082"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1288"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/hash_xlog.h.html#LN134"><span class='Ref_to_Member'>new_bucket_flag</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1083"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN80"><span class='Ref_to_Member'>hasho_flag</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1288"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN137"><span class='Ref_to_Const'>SizeOfHashSplitComplete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN1287"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN32"><span class='Ref_to_Const'>XLOG_HASH_SPLIT_COMPLETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1078"><span class='Ref_To_Local'>bucket_obuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1287"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1079"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1287"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_splitbucket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_finish_split() -- Finish the previously interrupted split operation 
 * 
 * To complete the split operation, we form the hash table of TIDs in new 
 * bucket which is then used by split operation to skip tuples that are 
 * already moved before the split operation was previously interrupted. 
 * 
 * The caller must hold a pin, but no lock, on the metapage and old bucket's 
 * primary page buffer.  The buffers are returned in the same state.  (The 
 * metapage is only touched if it becomes necessary to add or remove overflow 
 * pages.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1322"></a><span class='Declare_Function'>_hash_finish_split</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>metabuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>obuf</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a> <span class='Declare_Parameter'>obucket</span><span class='Delimiter'>, 
</span><a name="LN1323"></a>                   <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>maxbucket</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>highmask</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>lowmask</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1325"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span><a name="LN1326"></a>    <a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>tidhtab</span><span class='Delimiter'>; 
</span><a name="LN1327"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>bucket_nbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN1328"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>nbuf</span><span class='Delimiter'>; 
</span><a name="LN1329"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>npage</span><span class='Delimiter'>; 
</span><a name="LN1330"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblkno</span><span class='Delimiter'>; 
</span><a name="LN1331"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>bucket_nblkno</span><span class='Delimiter'>; 
</span><a name="LN1332"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>npageopaque</span><span class='Delimiter'>; 
</span><a name="LN1333"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>nbucket</span><span class='Delimiter'>; 
</span><a name="LN1334"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize hash tables used to track TIDs */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="hashpage.c.html#LN1325"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1325"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1325"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1325"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1325"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN1326"><span class='Ref_To_Local'>tidhtab</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"bucket ctids"</span><span class='Delimiter'>, 
</span>                    <span class='Number'>256</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* arbitrary initial size */ 
</span>                    <span class='Operator'>&</span><a href="hashpage.c.html#LN1325"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN1331"><span class='Ref_To_Local'>bucket_nblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1330"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN411"><span class='Ref_to_Proto'>_hash_get_newblock_from_oldbucket</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>obucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the new bucket and build hash table of TIDs 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1355"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>noffnum</span><span class='Delimiter'>; 
</span><a name="LN1356"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>nmaxoffnum</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN1328"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1330"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remember the primary bucket buffer to acquire cleanup lock on it. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1330"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1331"><span class='Ref_To_Local'>bucket_nblkno</span></a><span class='Parentheses'>) 
</span>            <a href="hashpage.c.html#LN1327"><span class='Ref_To_Local'>bucket_nbuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1328"><span class='Ref_To_Local'>nbuf</span></a><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1328"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1332"><span class='Ref_To_Local'>npageopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan each tuple in new page */ 
</span>        <a href="hashpage.c.html#LN1356"><span class='Ref_To_Local'>nmaxoffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1355"><span class='Ref_To_Local'>noffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>             <a href="hashpage.c.html#LN1355"><span class='Ref_To_Local'>noffnum</span></a> <span class='Operator'>&LT;= </span><a href="hashpage.c.html#LN1356"><span class='Ref_To_Local'>nmaxoffnum</span></a><span class='Delimiter'>; 
</span>             <a href="hashpage.c.html#LN1355"><span class='Ref_To_Local'>noffnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1355"><span class='Ref_To_Local'>noffnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1374"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Fetch the item's TID and insert it in hash table. */ 
</span>            <a href="hashpage.c.html#LN1374"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1355"><span class='Ref_To_Local'>noffnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1326"><span class='Ref_To_Local'>tidhtab</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1374"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1334"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashpage.c.html#LN1334"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="hashpage.c.html#LN1330"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1332"><span class='Ref_To_Local'>npageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * release our write lock without modifying buffer and ensure to 
         * retain the pin on primary bucket. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1328"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1327"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1328"><span class='Ref_To_Local'>nbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1328"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Exit loop if no more overflow pages in new bucket */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1330"><span class='Ref_To_Local'>nblkno</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Conditionally get the cleanup lock on old and new buckets to perform 
     * the split operation.  If we don't get the cleanup locks, silently give 
     * up and next insertion on old bucket will try again to complete the 
     * split. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN217"><span class='Ref_to_Proto'>ConditionalLockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>obuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1326"><span class='Ref_To_Local'>tidhtab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN217"><span class='Ref_to_Proto'>ConditionalLockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1327"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1326"><span class='Ref_To_Local'>tidhtab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1327"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1332"><span class='Ref_To_Local'>npageopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1329"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashpage.c.html#LN1333"><span class='Ref_To_Local'>nbucket</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1332"><span class='Ref_To_Local'>npageopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN39"><span class='Ref_to_Proto'>_hash_splitbucket</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>obucket</span></a><span class='Delimiter'>, 
</span>                      <a href="hashpage.c.html#LN1333"><span class='Ref_To_Local'>nbucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1327"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1326"><span class='Ref_To_Local'>tidhtab</span></a><span class='Delimiter'>, 
</span>                      <a href="hashpage.c.html#LN1323"><span class='Ref_to_Parameter'>maxbucket</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1323"><span class='Ref_to_Parameter'>highmask</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1323"><span class='Ref_to_Parameter'>lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1327"><span class='Ref_To_Local'>bucket_nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1322"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1326"><span class='Ref_To_Local'>tidhtab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_finish_split &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  log_split_page() -- Log the split operation 
 * 
 *  We log the split operation when the new page in new bucket gets full, 
 *  so we log the entire page. 
 * 
 *  'buf' must be locked by the caller which is also responsible for unlocking 
 *  it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1442"></a><span class='Declare_Function'>log_split_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1442"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1446"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1442"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN29"><span class='Ref_to_Const'>REGBUF_FORCE_IMAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN1446"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HASH_ID<span class='Delimiter'>, </span><a href="../../../include/access/hash_xlog.h.html#LN31"><span class='Ref_to_Const'>XLOG_HASH_SPLIT_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1442"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1446"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _hash_getcachedmetap() -- Returns cached metapage data. 
 * 
 *  If metabuf is not InvalidBuffer, caller must hold a pin, but no lock, on 
 *  the metapage.  If not set, we'll set it before returning if we have to 
 *  refresh the cache, and return with a pin but no lock on it; caller is 
 *  responsible for releasing the pin. 
 * 
 *  We refresh the cache if it's not initialized yet or force_refresh is true. 
 */ 
</span><a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> 
<a name="LN1469"></a><span class='Declare_Function'>_hash_getcachedmetap</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>metabuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>force_refresh</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1471"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>force_refresh</span></a> <span class='Operator'>|| </span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1476"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cache</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * It's important that we don't set rd_amcache to an invalid value. 
         * Either MemoryContextAlloc or _hash_getbuf could fail, so don't 
         * install a pointer to the newly-allocated storage in the actual 
         * relcache entry until both have succeeeded. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="hashpage.c.html#LN1476"><span class='Ref_To_Local'>cache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN178"><span class='Ref_to_Member'>rd_indexcxt</span></a><span class='Delimiter'>, 
</span>                                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN202"><span class='Ref_to_Struct'>HashMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Read the metapage. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Operator'>*</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>metabuf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN158"><span class='Ref_to_Const'>HASH_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/access/hash.h.html#LN55"><span class='Ref_to_Const'>LH_META_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1471"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Populate the cache. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1476"><span class='Ref_To_Local'>cache</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN266"><span class='Ref_to_Macro'>HashPageGetMeta</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1471"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN202"><span class='Ref_to_Struct'>HashMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release metapage lock, but keep the pin. */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if force_refresh||rel-&GT;r... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a><span class='Parentheses'>) </span><a href="hashpage.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_getcachedmetap &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_getbucketbuf_from_hashkey() -- Get the bucket's buffer for the given 
 *                                       hashkey. 
 * 
 *  Bucket pages do not move or get removed once they are allocated. This give 
 *  us an opportunity to use the previously saved metapage contents to reach 
 *  the target bucket buffer, instead of reading from the metapage every time. 
 *  This saves one buffer access every time we want to reach the target bucket 
 *  buffer, which is very helpful savings in bufmgr traffic and contention. 
 * 
 *  The access type parameter (HASH_READ or HASH_WRITE) indicates whether the 
 *  bucket buffer has to be locked for reading or writing. 
 * 
 *  The out parameter cachedmetap is set with metapage contents used for 
 *  hashkey to bucket buffer mapping. Some callers need this info to reach the 
 *  old bucket in case of bucket split, see _hash_doinsert(). 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN1527"></a><span class='Declare_Function'>_hash_getbucketbuf_from_hashkey</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashkey</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Delimiter'>, 
</span><a name="LN1528"></a>                                <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cachedmetap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1530"></a>    <a href="../../../include/access/hash.h.html#LN225"><span class='Ref_to_Typedef'>HashMetaPage</span></a> <span class='Declare_Local'>metap</span><span class='Delimiter'>; 
</span><a name="LN1531"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1532"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN1533"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1534"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN1535"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN1536"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We read from target bucket buffer, hence locking is must. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>== </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a> <span class='Operator'>|| </span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>== </span><a href="../../../include/access/hash.h.html#LN283"><span class='Ref_to_Const'>HASH_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN354"><span class='Ref_to_Proto'>_hash_getcachedmetap</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1532"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop until we get a lock on the correct target bucket. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Compute the target bucket number, and convert to block number. 
         */ 
</span>        <a href="hashpage.c.html#LN1534"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN123"><span class='Ref_to_Func'>_hash_hashkey2bucket</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>hashkey</span></a><span class='Delimiter'>, 
</span>                                      <a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Delimiter'>, 
</span>                                      <a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN213"><span class='Ref_to_Member'>hashm_highmask</span></a><span class='Delimiter'>, 
</span>                                      <a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN214"><span class='Ref_to_Member'>hashm_lowmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashpage.c.html#LN1535"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN37"><span class='Ref_to_Macro'>BUCKET_TO_BLKNO</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1534"><span class='Ref_To_Local'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch the primary bucket page for the bucket */ 
</span>        <a href="hashpage.c.html#LN1531"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1535"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>access</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1533"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1531"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1536"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1533"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1536"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span><a href="hashpage.c.html#LN1534"><span class='Ref_To_Local'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1536"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this bucket hasn't been split, we're done. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1536"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN77"><span class='Ref_to_Member'>hasho_prevblkno</span></a> <span class='Operator'>&LT;= </span><a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN212"><span class='Ref_to_Member'>hashm_maxbucket</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Drop lock on this buffer, update cached metapage, and retry. */ 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1531"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN354"><span class='Ref_to_Proto'>_hash_getcachedmetap</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashpage.c.html#LN1532"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1532"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
        <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashpage.c.html#LN1527"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="hashpage.c.html#LN1532"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashpage.c.html#LN1528"><span class='Ref_to_Parameter'>cachedmetap</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="hashpage.c.html#LN1528"><span class='Ref_to_Parameter'>cachedmetap</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN1530"><span class='Ref_To_Local'>metap</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="hashpage.c.html#LN1531"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_getbucketbuf_from_hashkey &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>