<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\hash\hashsearch.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\hash\hashsearch.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * hashsearch.c 
 *    search code for postgres hash tables 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/hash/hashsearch.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/hash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/relscan.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_next() -- Get the next item in a scan. 
 * 
 *      On entry, we have a valid hashso_curpos in the scan, and a 
 *      pin and read lock on the page that contains that item. 
 *      We find the next item in the scan, if any. 
 *      On success exit, we have the page containing the next item 
 *      pinned and locked. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN33"></a><span class='Declare_Function'>_hash_next</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN35"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hashsearch.c.html#LN33"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN36"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hashsearch.c.html#LN33"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN37"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN38"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN39"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN40"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>current</span><span class='Delimiter'>; 
</span><a name="LN41"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we still have the buffer pinned and read-locked */ 
</span>    <a href="hashsearch.c.html#LN37"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN36"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN37"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * step to next valid tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/hash.h.html#LN383"><span class='Ref_to_Proto'>_hash_step</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN33"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN37"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN33"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if we're here, _hash_step found a valid tuple */ 
</span>    <a href="hashsearch.c.html#LN40"><span class='Ref_To_Local'>current</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN36"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN39"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN40"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN35"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN37"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN38"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN37"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN41"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN38"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN38"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN39"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN36"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN41"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_next &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Advance to next page in a bucket, if any.  If we are scanning the bucket 
 * being populated during split operation then this function advances to the 
 * bucket being split after the last bucket page of bucket being populated. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN70"></a><span class='Declare_Function'>_hash_readnext</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, 
</span><a name="LN71"></a>               <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bufp</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pagep</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opaquep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN73"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN74"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hashsearch.c.html#LN70"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN75"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hashsearch.c.html#LN70"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN76"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>block_found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN73"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>opaquep</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>hasho_nextblkno<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Retain the pin on primary bucket page till the end of scan.  Refer the 
     * comments in _hash_first to know the reason of retaining pin. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN75"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>|| *</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN75"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN74"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check for interrupts while we're not holding any buffer lock */ 
</span>    <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN73"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN74"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN73"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashsearch.c.html#LN76"><span class='Ref_To_Local'>block_found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN75"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>&& !</span><a href="hashsearch.c.html#LN75"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * end of bucket, scan bucket being split if there was a split in 
         * progress at the start of scan. 
         */ 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN75"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * buffer for bucket being split must be valid as we acquire the pin 
         * on it before the start of scan and retain it till end of scan. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * setting hashso_buc_split to true indicates that we are scanning 
         * bucket being split. 
         */ 
</span>        <a href="hashsearch.c.html#LN75"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="hashsearch.c.html#LN76"><span class='Ref_To_Local'>block_found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if so-&GT;hashso_buc_popula... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN76"><span class='Ref_To_Local'>block_found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>pagep</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN70"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN74"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>pagep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>opaquep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN71"><span class='Ref_to_Parameter'>pagep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end _hash_readnext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Advance to previous page in a bucket, if any.  If the current scan has 
 * started during split operation then this function advances to bucket 
 * being populated after the first bucket page of bucket being split. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN136"></a><span class='Declare_Function'>_hash_readprev</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, 
</span><a name="LN137"></a>               <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bufp</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pagep</span><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opaquep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN139"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN140"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hashsearch.c.html#LN136"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN141"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hashsearch.c.html#LN136"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN142"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>haveprevblk</span><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN139"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>opaquep</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>hasho_prevblkno<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Retain the pin on primary bucket page till the end of scan.  Refer the 
     * comments in _hash_first to know the reason of retaining pin. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>|| *</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashsearch.c.html#LN142"><span class='Ref_To_Local'>haveprevblk</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="hashpage.c.html#LN272"><span class='Ref_to_Func'>_hash_relbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN140"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashsearch.c.html#LN142"><span class='Ref_To_Local'>haveprevblk</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check for interrupts while we're not holding any buffer lock */ 
</span>    <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN142"><span class='Ref_To_Local'>haveprevblk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN139"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN140"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN139"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>pagep</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN136"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN140"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>pagep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>opaquep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>pagep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We always maintain the pin on bucket page for whole scan operation, 
         * so releasing the additional pin we have acquired here. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>|| *</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Parentheses'>) 
</span>            <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN140"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>&& </span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * end of bucket, scan bucket being populated if there was a split in 
         * progress at the start of scan. 
         */ 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * buffer for bucket being populated must be valid as we acquire the 
         * pin on it before the start of scan and retain it till end of scan. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>pagep</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>opaquep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>pagep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* move to the end of bucket chain */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>((</span><span class='Operator'>*</span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>opaquep</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>hasho_nextblkno<span class='Parentheses'>))</span> 
            <a href="hashsearch.c.html#LN69"><span class='Ref_to_Func'>_hash_readnext</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN136"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>bufp</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>pagep</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN137"><span class='Ref_to_Parameter'>opaquep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * setting hashso_buc_split to false indicates that we are scanning 
         * bucket being populated. 
         */ 
</span>        <a href="hashsearch.c.html#LN141"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if so-&GT;hashso_buc_popula... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _hash_readprev &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_first() -- Find the first item in a scan. 
 * 
 *      Find the first item in the index that 
 *      satisfies the qualification associated with the scan descriptor. On 
 *      success, the page containing the current index tuple is read locked 
 *      and pinned, and the scan's opaque data entry is updated to 
 *      include the buffer. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN221"></a><span class='Declare_Function'>_hash_first</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN223"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN224"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN225"></a>    <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a>     <span class='Declare_Local'>cur</span><span class='Delimiter'>; 
</span><a name="LN226"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashkey</span><span class='Delimiter'>; 
</span><a name="LN227"></a>    <a href="../../../include/access/hash.h.html#LN33"><span class='Ref_to_Typedef'>Bucket</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN229"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN230"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN231"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN232"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>current</span><span class='Delimiter'>; 
</span><a name="LN233"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1262"><span class='Ref_to_Macro'>pgstat_count_index_scan</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN232"><span class='Ref_To_Local'>current</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN232"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do not support hash scans with no index qualification, because we 
     * would have to read the whole index rather than just one bucket. That 
     * creates a whole raft of problems, since we haven't got a practical way 
     * to lock all the buckets against splits or compactions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN90"><span class='Ref_to_Member'>numberOfKeys</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"hash indexes do not support whole-index scans"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* There may be more than one index qual, but we hash only the first */ 
</span>    <a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a> <span class='Operator'>= &</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN92"><span class='Ref_to_Member'>keyData</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* We support only single-column hash indexes */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN66"><span class='Ref_to_Member'>sk_attno</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* And there's only one operator strategy, too */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN67"><span class='Ref_to_Member'>sk_strategy</span></a> <span class='Operator'>== </span><a href="../../../include/access/hash.h.html#LN289"><span class='Ref_to_Const'>HTEqualStrategyNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the constant in the index qual is NULL, assume it cannot match any 
     * items in the index. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN65"><span class='Ref_to_Member'>sk_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/skey.h.html#LN114"><span class='Ref_to_Const'>SK_ISNULL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Okay to compute the hash key.  We want to do this before acquiring any 
     * locks, in case a user-defined hash function happens to be slow. 
     * 
     * If scankey operator is not a cross-type comparison, we can use the 
     * cached hash function; otherwise gotta look it up in the catalogs. 
     * 
     * We support the convention that sk_subtype == InvalidOid means the 
     * opclass input type; this is a hack to simplify life for ScanKeyInit(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN68"><span class='Ref_to_Member'>sk_subtype</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN182"><span class='Ref_to_Member'>rd_opcintype</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>|| 
</span>        <a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN68"><span class='Ref_to_Member'>sk_subtype</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <a href="hashsearch.c.html#LN226"><span class='Ref_To_Local'>hashkey</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN80"><span class='Ref_to_Func'>_hash_datum2hashkey</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN71"><span class='Ref_to_Member'>sk_argument</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hashsearch.c.html#LN226"><span class='Ref_To_Local'>hashkey</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN100"><span class='Ref_to_Func'>_hash_datum2hashkey_type</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN71"><span class='Ref_to_Member'>sk_argument</span></a><span class='Delimiter'>, 
</span>                                           <a href="hashsearch.c.html#LN225"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN68"><span class='Ref_to_Member'>sk_subtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN226"><span class='Ref_To_Local'>hashkey</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN356"><span class='Ref_to_Proto'>_hash_getbucketbuf_from_hashkey</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN226"><span class='Ref_To_Local'>hashkey</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN227"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN123"><span class='Ref_to_Member'>hashso_bucket_buf</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a bucket split is in progress, then while scanning the bucket being 
     * populated, we need to skip tuples that were copied from bucket being 
     * split.  We also need to maintain a pin on the bucket being split to 
     * ensure that split-cleanup work done by vacuum doesn't remove tuples 
     * from it till this scan is done.  We need to maintain a pin on the 
     * bucket being populated to ensure that vacuum doesn't squeeze that 
     * bucket till this scan is complete; otherwise, the ordering of tuples 
     * can't be maintained during forward and backward scans.  Here, we have 
     * to be cautious about locking order: first, acquire the lock on bucket 
     * being split; then, release the lock on it but not the pin; then, 
     * acquire a lock on bucket being populated and again re-verify whether 
     * the bucket split is still in progress.  Acquiring the lock on bucket 
     * being split first ensures that the vacuum waits for this scan to 
     * finish. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN88"><span class='Ref_to_Macro'>H_BUCKET_BEING_POPULATED</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN311"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>old_blkno</span><span class='Delimiter'>; 
</span><a name="LN312"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>old_buf</span><span class='Delimiter'>; 
</span> 
        <a href="hashsearch.c.html#LN311"><span class='Ref_To_Local'>old_blkno</span></a> <span class='Operator'>= </span><a href="../../../include/access/hash.h.html#LN410"><span class='Ref_to_Proto'>_hash_get_oldblock_from_newbucket</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN227"><span class='Ref_To_Local'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * release the lock on new bucket and re-acquire it after acquiring 
         * the lock on old bucket. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="hashsearch.c.html#LN312"><span class='Ref_To_Local'>old_buf</span></a> <span class='Operator'>= </span><a href="hashpage.c.html#LN76"><span class='Ref_to_Func'>_hash_getbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN311"><span class='Ref_To_Local'>old_blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN282"><span class='Ref_to_Const'>HASH_READ</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN312"><span class='Ref_To_Local'>old_buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * remember the split bucket buffer so as to use it later for 
         * scanning. 
         */ 
</span>        <a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN312"><span class='Ref_To_Local'>old_buf</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN312"><span class='Ref_To_Local'>old_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN79"><span class='Ref_to_Member'>hasho_bucket</span></a> <span class='Operator'>== </span><a href="hashsearch.c.html#LN227"><span class='Ref_To_Local'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN88"><span class='Ref_to_Macro'>H_BUCKET_BEING_POPULATED</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
            <a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="hashpage.c.html#LN283"><span class='Ref_to_Func'>_hash_dropbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN130"><span class='Ref_to_Member'>hashso_split_bucket_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if H_BUCKET_BEING_POPULA... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* If a backwards scan is requested, move to the end of the chain */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/sdir.h.html#LN40"><span class='Ref_to_Macro'>ScanDirectionIsBackward</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Backward scans that start during split needs to start from end of 
         * bucket being split. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN78"><span class='Ref_to_Member'>hasho_nextblkno</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>               <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>&& !</span><a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a><span class='Parentheses'>))</span> 
            <a href="hashsearch.c.html#LN69"><span class='Ref_to_Func'>_hash_readnext</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN230"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now find the first tuple satisfying the qualification */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/hash.h.html#LN383"><span class='Ref_to_Proto'>_hash_step</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN221"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if we're here, _hash_step found a valid tuple */ 
</span>    <a href="hashsearch.c.html#LN233"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN232"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN223"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN228"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN231"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN229"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN233"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN224"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN136"><span class='Ref_to_Member'>hashso_heappos</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN231"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_first &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _hash_step() -- step to the next valid item in a scan in the bucket. 
 * 
 *      If no valid record exists in the requested direction, return 
 *      false.  Else, return true and set the hashso_curpos for the 
 *      scan to the right thing. 
 * 
 *      Here we need to ensure that if the scan has started during split, then 
 *      skip the tuples that are moved by split while scanning bucket being 
 *      populated and then scan the bucket being split to cover all such 
 *      tuples.  This is done to ensure that we don't miss tuples in the scans 
 *      that are started during split. 
 * 
 *      'bufP' points to the current buffer, which is pinned and read-locked. 
 *      On success exit, we have pin and read-lock on whichever page 
 *      contains the right item; on failure, we have released all buffers. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN390"></a><span class='Declare_Function'>_hash_step</span><span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN85"><span class='Ref_to_Typedef'>IndexScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bufP</span><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN392"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN88"><span class='Ref_to_Member'>indexRelation</span></a><span class='Delimiter'>; 
</span><a name="LN393"></a>    <a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a> <span class='Declare_Local'>so</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN152"><span class='Ref_to_Typedef'>HashScanOpaque</span></a><span class='Parentheses'>) </span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN104"><span class='Ref_to_Member'>opaque</span></a><span class='Delimiter'>; 
</span><a name="LN394"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>current</span><span class='Delimiter'>; 
</span><a name="LN395"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN396"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN398"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN399"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN400"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN401"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN394"><span class='Ref_To_Local'>current</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN133"><span class='Ref_to_Member'>hashso_curpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= *</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>bufP</span></a><span class='Delimiter'>; 
</span>    <a href="hashutil.c.html#LN223"><span class='Ref_to_Func'>_hash_checkpage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN392"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/hash.h.html#LN53"><span class='Ref_to_Const'>LH_BUCKET_PAGE</span></a> <span class='Operator'>| </span><a href="../../../include/access/hash.h.html#LN52"><span class='Ref_to_Const'>LH_OVERFLOW_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="hashsearch.c.html#LN397"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/hash.h.html#LN84"><span class='Ref_to_Typedef'>HashPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If _hash_step is called from _hash_first, current will not be valid, so 
     * we can't dereference it.  However, in that case, we presumably want to 
     * start at the beginning/end of the page... 
     */ 
</span>    <a href="hashsearch.c.html#LN398"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN394"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>))</span> 
        <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN394"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * 'offnum' now points to the last tuple we examined (if any). 
     * 
     * continue to step through tuples until: 1) we get to the end of the 
     * bucket chain or 2) we find a valid tuple. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>                    <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* move forward */ 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* new page, locate starting position by binary search */ 
</span>                    <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN356"><span class='Ref_to_Func'>_hash_binsearch</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * check if we're still in the range of items with the 
                     * target hash key 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="hashsearch.c.html#LN398"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * skip the tuples that are moved by split operation 
                         * for the scan that has started when split was in 
                         * progress 
                         */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>&& !</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>&& 
</span>                            <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/hash.h.html#LN236"><span class='Ref_to_Const'>INDEX_MOVED_BY_SPLIT_MASK</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* move forward */ 
</span>                            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a> <span class='Operator'>== </span><a href="hashutil.c.html#LN297"><span class='Ref_to_Func'>_hash_get_indextuple_hashkey</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>))</span> 
                            <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* yes, so exit for-loop */ 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if offnum&LT;=maxoff &raquo; </span> 
 
                    <span class='Comment_Multi_Line'>/* Before leaving current page, deal with any killed items */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="../../../include/access/hash.h.html#LN414"><span class='Ref_to_Proto'>_hash_kill_items</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * ran off the end of this page, try the next 
                     */ 
</span>                    <a href="hashsearch.c.html#LN69"><span class='Ref_to_Func'>_hash_readnext</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN397"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="hashsearch.c.html#LN398"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN356"><span class='Ref_to_Func'>_hash_binsearch</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* exit for-loop */ 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/access/sdir.h.html#LN23"><span class='Ref_to_EnumConst'>BackwardScanDirection</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>                    <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN54"><span class='Ref_to_Macro'>OffsetNumberPrev</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* move back */ 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* new page, locate starting position by binary search */ 
</span>                    <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN394"><span class='Ref_to_Func'>_hash_binsearch_last</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * check if we're still in the range of items with the 
                     * target hash key 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="hashsearch.c.html#LN398"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * skip the tuples that are moved by split operation 
                         * for the scan that has started when split was in 
                         * progress 
                         */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN139"><span class='Ref_to_Member'>hashso_buc_populated</span></a> <span class='Operator'>&& !</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN145"><span class='Ref_to_Member'>hashso_buc_split</span></a> <span class='Operator'>&& 
</span>                            <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/hash.h.html#LN236"><span class='Ref_to_Const'>INDEX_MOVED_BY_SPLIT_MASK</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN54"><span class='Ref_to_Macro'>OffsetNumberPrev</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* move back */ 
</span>                            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a> <span class='Operator'>== </span><a href="hashutil.c.html#LN297"><span class='Ref_to_Func'>_hash_get_indextuple_hashkey</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>))</span> 
                            <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* yes, so exit for-loop */ 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if offnum&GT;=FirstOffsetNu... &raquo; </span> 
 
                    <span class='Comment_Multi_Line'>/* Before leaving current page, deal with any killed items */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN149"><span class='Ref_to_Member'>numKilled</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="../../../include/access/hash.h.html#LN414"><span class='Ref_to_Proto'>_hash_kill_items</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * ran off the end of this page, try the next 
                     */ 
</span>                    <a href="hashsearch.c.html#LN135"><span class='Ref_to_Func'>_hash_readprev</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="hashsearch.c.html#LN397"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN89"><span class='Ref_to_Member'>xs_snapshot</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN392"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="hashsearch.c.html#LN398"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="hashutil.c.html#LN394"><span class='Ref_to_Func'>_hash_binsearch_last</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN396"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN112"><span class='Ref_to_Member'>hashso_sk_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* exit for-loop */ 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* NoMovementScanDirection */ 
</span>                <span class='Comment_Multi_Line'>/* this should not be reached */ 
</span>                <a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch dir &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We ran off the end of the bucket without finding a match. 
             * Release the pin on bucket buffers.  Normally, such pins are 
             * released at end of scan, however scrolling cursors can 
             * reacquire the bucket lock and pin in the same scan multiple 
             * times. 
             */ 
</span>            <span class='Operator'>*</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>bufP</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN394"><span class='Ref_To_Local'>current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="hashpage.c.html#LN295"><span class='Ref_to_Func'>_hash_dropscanbuf</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN392"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* check the tuple quals, loop around if not met */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="hashutil.c.html#LN29"><span class='Ref_to_Func'>_hash_checkqual</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN401"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if we made it to here, we've found a valid tuple */ 
</span>    <a href="hashsearch.c.html#LN400"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="hashsearch.c.html#LN390"><span class='Ref_to_Parameter'>bufP</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN393"><span class='Ref_To_Local'>so</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hash.h.html#LN120"><span class='Ref_to_Member'>hashso_curbuf</span></a> <span class='Operator'>= </span><a href="hashsearch.c.html#LN395"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><a href="hashsearch.c.html#LN394"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN400"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="hashsearch.c.html#LN399"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _hash_step &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>