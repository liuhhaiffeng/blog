<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\heap\heapam.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\heap\heapam.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:28 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * heapam.c 
 *    heap access method code 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/heap/heapam.c 
 * 
 * 
 * INTERFACE ROUTINES 
 *      relation_open   - open any relation by relation OID 
 *      relation_openrv - open any relation specified by a RangeVar 
 *      relation_close  - close any relation 
 *      heap_open       - open a heap relation by relation OID 
 *      heap_openrv     - open a heap relation specified by a RangeVar 
 *      heap_close      - (now just a macro for relation_close) 
 *      heap_beginscan  - begin relation scan 
 *      heap_rescan     - restart a relation scan 
 *      heap_endscan    - end relation scan 
 *      heap_getnext    - retrieve next tuple in scan 
 *      heap_fetch      - retrieve tuple with given tid 
 *      heap_insert     - insert tuple into a relation 
 *      heap_multi_insert - insert multiple tuples into a relation 
 *      heap_delete     - delete a tuple from a relation 
 *      heap_update     - replace a tuple in a relation with another tuple 
 *      heap_sync       - sync heap, for when no WAL has been written 
 * 
 * NOTES 
 *    This file contains the heap_ routines which implement 
 *    the POSTGRES heap access method used for all POSTGRES 
 *    relations. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/bufmask.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/hio.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/parallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/relscan.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/tuptoaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/valid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/visibilitymap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/freespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/standby.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/datum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/relcache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* GUC variable */ 
</span><a name="LN78"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>synchronize_seqscans</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
 
<a name="LN81"></a><span class='Keyword'>static </span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Prototype'>heap_beginscan_internal</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN82"></a>                        <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN83"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN84"></a>                        <a href="../../../include/access/heapam.h.html#LN100"><span class='Ref_to_Typedef'>ParallelHeapScanDesc</span></a> <span class='Declare_Parameter'>parallel_scan</span><span class='Delimiter'>, 
</span><a name="LN85"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_strat</span><span class='Delimiter'>, 
</span><a name="LN86"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_sync</span><span class='Delimiter'>, 
</span><a name="LN87"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_pagemode</span><span class='Delimiter'>, 
</span><a name="LN88"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_bitmapscan</span><span class='Delimiter'>, 
</span><a name="LN89"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_samplescan</span><span class='Delimiter'>, 
</span><a name="LN90"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>temp_snap</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN91"></a><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Prototype'>heap_parallelscan_nextpage</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN92"></a><span class='Keyword'>static </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Prototype'>heap_prepare_insert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN93"></a>                    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN94"></a><span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Prototype'>log_heap_update</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>oldbuf</span><span class='Delimiter'>, 
</span><a name="LN95"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>newbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, 
</span><a name="LN96"></a>                <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_key_tup</span><span class='Delimiter'>, 
</span><a name="LN97"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>all_visible_cleared</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>new_all_visible_cleared</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN98"></a><span class='Keyword'>static </span><a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>HeapDetermineModifiedColumns</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN99"></a>                             <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>interesting_cols</span><span class='Delimiter'>, 
</span><a name="LN100"></a>                             <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN101"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>heap_acquire_tuplock</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, 
</span><a name="LN102"></a>                     <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><a href="../../../include/nodes/lockoptions.h.html#LN35"><span class='Ref_to_Enum'>LockWaitPolicy</span></a> <span class='Declare_Parameter'>wait_policy</span><span class='Delimiter'>, 
</span><a name="LN103"></a>                     <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>have_tuple_lock</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN104"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>compute_new_xmax_infomask</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xmax</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>old_infomask</span><span class='Delimiter'>, 
</span><a name="LN105"></a>                          <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>old_infomask2</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>add_to_xmax</span><span class='Delimiter'>, 
</span><a name="LN106"></a>                          <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_update</span><span class='Delimiter'>, 
</span><a name="LN107"></a>                          <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result_xmax</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result_infomask</span><span class='Delimiter'>, 
</span><a name="LN108"></a>                          <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result_infomask2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN109"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Prototype'>heap_lock_updated_tuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, 
</span><a name="LN110"></a>                        <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ctid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN111"></a>                        <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN112"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>GetMultiXactIdHintBits</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>new_infomask</span><span class='Delimiter'>, 
</span><a name="LN113"></a>                       <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>new_infomask2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN114"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Prototype'>MultiXactIdGetUpdateXid</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xmax</span><span class='Delimiter'>, 
</span><a name="LN115"></a>                        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>t_infomask</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN116"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>DoesMultiXactIdConflict</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, 
</span><a name="LN117"></a>                        <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>MultiXactIdWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, 
</span><a name="LN119"></a>                <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ctid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN23"><span class='Ref_to_Enum'>XLTW_Oper</span></a> <span class='Declare_Parameter'>oper</span><span class='Delimiter'>, 
</span><a name="LN120"></a>                <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>remaining</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN121"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ConditionalMultiXactIdWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Delimiter'>, 
</span><a name="LN122"></a>                           <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>remaining</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN123"></a><span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Prototype'>log_heap_new_cid</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN124"></a><span class='Keyword'>static </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Prototype'>ExtractReplicaIdentity</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>key_modified</span><span class='Delimiter'>, 
</span><a name="LN125"></a>                       <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>copy</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Each tuple lock mode has a corresponding heavyweight lock, and one or two 
 * corresponding MultiXactStatuses (one to merely lock tuples, another one to 
 * update them).  This table (and the macros below) helps us determine the 
 * heavyweight lock mode and MultiXactStatus values to use for any particular 
 * tuple lock strength. 
 * 
 * Don't look at lockstatus/updstatus directly!  Use get_mxact_status_for_lock 
 * instead. 
 */ 
</span><span class='Keyword'>static const </span><span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN140"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Member'>hwlock</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>lockstatus</span><span class='Delimiter'>; 
</span><a name="LN142"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>updstatus</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN145"></a>            <span class='Declare_Var'>tupleLockExtraInfo</span><span class='Delimiter'>[</span><a href="../../../include/access/heapam.h.html#LN49"><span class='Ref_to_Const'>MaxLockTupleMode</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span><span class='Delimiter'>{ 
</span>    <span class='Delimiter'>{</span>                           <span class='Comment_Single_Line'>/* LockTupleKeyShare */ 
</span>        <a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, 
</span>        <a href="../../../include/access/multixact.h.html#LN41"><span class='Ref_to_EnumConst'>MultiXactStatusForKeyShare</span></a><span class='Delimiter'>, 
</span>        <span class='Operator'>-</span><span class='Number'>1</span>                      <span class='Comment_Single_Line'>/* KeyShare does not allow updating tuples */ 
</span>    <span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span>                           <span class='Comment_Single_Line'>/* LockTupleShare */ 
</span>        <a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Delimiter'>, 
</span>        <a href="../../../include/access/multixact.h.html#LN42"><span class='Ref_to_EnumConst'>MultiXactStatusForShare</span></a><span class='Delimiter'>, 
</span>        <span class='Operator'>-</span><span class='Number'>1</span>                      <span class='Comment_Single_Line'>/* Share does not allow updating tuples */ 
</span>    <span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span>                           <span class='Comment_Single_Line'>/* LockTupleNoKeyExclusive */ 
</span>        <a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Delimiter'>, 
</span>        <a href="../../../include/access/multixact.h.html#LN43"><span class='Ref_to_EnumConst'>MultiXactStatusForNoKeyUpdate</span></a><span class='Delimiter'>, 
</span>        <a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a> 
    <span class='Delimiter'>}, 
</span>    <span class='Delimiter'>{</span>                           <span class='Comment_Single_Line'>/* LockTupleExclusive */ 
</span>        <a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, 
</span>        <a href="../../../include/access/multixact.h.html#LN44"><span class='Ref_to_EnumConst'>MultiXactStatusForUpdate</span></a><span class='Delimiter'>, 
</span>        <a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a> 
    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end tupleLockExtraInfo &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Get the LOCKMODE for a given MultiXactStatus */ 
</span><a name="LN170"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>LOCKMODE_from_mxstatus</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>status</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <span class='Parentheses'>(</span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN200"><span class='Ref_to_Macro'>TUPLOCK_from_mxstatus</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN170"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>))</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN140"><span class='Ref_to_Member'>hwlock</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Acquire heavyweight locks on tuples, using a LockTupleMode strength value. 
 * This is more readable than having every caller translate it to lock.h's 
 * LOCKMODE. 
 */ 
</span><a name="LN178"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>LockTupleTuplock</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="../../../include/storage/lmgr.h.html#LN65"><span class='Ref_to_Proto'>LockTuple</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN178"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN178"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN178"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN140"><span class='Ref_to_Member'>hwlock</span></a><span class='Parentheses'>)</span> 
<a name="LN180"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>UnlockTupleTuplock</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="../../../include/storage/lmgr.h.html#LN68"><span class='Ref_to_Proto'>UnlockTuple</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN180"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN180"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN180"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN140"><span class='Ref_to_Member'>hwlock</span></a><span class='Parentheses'>)</span> 
<a name="LN182"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ConditionalLockTupleTuplock</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="../../../include/storage/lmgr.h.html#LN66"><span class='Ref_to_Proto'>ConditionalLockTuple</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN182"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN182"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN182"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN140"><span class='Ref_to_Member'>hwlock</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This table maps tuple lock strength values for each particular 
 * MultiXactStatus value. 
 */ 
</span><a name="LN189"></a><span class='Keyword'>static const int </span><span class='Declare_Var'>MultiXactStatusLock</span><span class='Delimiter'>[</span><a href="../../../include/access/multixact.h.html#LN51"><span class='Ref_to_Const'>MaxMultiXactStatus</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/access/heapam.h.html#LN40"><span class='Ref_to_EnumConst'>LockTupleKeyShare</span></a><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* ForKeyShare */ 
</span>    <a href="../../../include/access/heapam.h.html#LN42"><span class='Ref_to_EnumConst'>LockTupleShare</span></a><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* ForShare */ 
</span>    <a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* ForNoKeyUpdate */ 
</span>    <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* ForUpdate */ 
</span>    <a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* NoKeyUpdate */ 
</span>    <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a>          <span class='Comment_Single_Line'>/* Update */ 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* Get the LockTupleMode for a given MultiXactStatus */ 
</span><a name="LN200"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TUPLOCK_from_mxstatus</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>status</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <span class='Parentheses'>(</span><a href="heapam.c.html#LN189"><span class='Ref_to_Global_Var'>MultiXactStatusLock</span></a><span class='Delimiter'>[</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN200"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                       heap support routines 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      initscan - scan code common to heap_beginscan and heap_rescan 
 * ---------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN213"></a><span class='Declare_Function'>initscan</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>keep_startblock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN215"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>allow_strat</span><span class='Delimiter'>; 
</span><a name="LN216"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>allow_sync</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine the number of blocks we have to scan. 
     * 
     * It is sufficient to do this once at scan start, since any tuples added 
     * while the scan is in progress will be invisible to my snapshot anyway. 
     * (That is not true when using a non-MVCC snapshot.  However, we couldn't 
     * guarantee to return tuples added after scan start anyway, since they 
     * might go into pages we already scanned.  To guarantee consistent 
     * results for a non-MVCC snapshot, the caller must hold some higher-level 
     * lock that ensures the interesting tuple(s) won't change.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN36"><span class='Ref_to_Member'>phs_nblocks</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the table is large relative to NBuffers, use a bulk-read access 
     * strategy and enable synchronized scanning (see syncscan.c).  Although 
     * the thresholds for these features could be different, we make them the 
     * same so that there are only two behaviors to tune rather than four. 
     * (However, some callers need to be able to disable one or both of these 
     * behaviors, independently of the size of the table; also there is a GUC 
     * variable that can disable synchronized scanning.) 
     * 
     * Note that heap_parallelscan_initialize has a very similar test; if you 
     * change this, consider changing that one, too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN512"><span class='Ref_to_Macro'>RelationUsesLocalBuffers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>&GT; </span><a href="../../utils/init/globals.c.html#LN122"><span class='Ref_to_Global_Var'>NBuffers</span></a> <span class='Operator'>/ </span><span class='Number'>4</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN215"><span class='Ref_To_Local'>allow_strat</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN53"><span class='Ref_to_Member'>rs_allow_strat</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN216"><span class='Ref_To_Local'>allow_sync</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN54"><span class='Ref_to_Member'>rs_allow_sync</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN215"><span class='Ref_To_Local'>allow_strat</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN216"><span class='Ref_To_Local'>allow_sync</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN215"><span class='Ref_To_Local'>allow_strat</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* During a rescan, keep the previous strategy object. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN231"><span class='Ref_to_Proto'>GetAccessStrategy</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN30"><span class='Ref_to_EnumConst'>BAS_BULKREAD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN232"><span class='Ref_to_Proto'>FreeAccessStrategy</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* For parallel scan, believe whatever ParallelHeapScanDesc says. */ 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN35"><span class='Ref_to_Member'>phs_syncscan</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>keep_startblock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * When rescanning, we want to keep the previous startblock setting, 
         * so that rewinding a cursor doesn't generate surprising results. 
         * Reset the active syncscan setting, though. 
         */ 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN216"><span class='Ref_To_Local'>allow_sync</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN78"><span class='Ref_to_Global_Var'>synchronize_seqscans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN216"><span class='Ref_To_Local'>allow_sync</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN78"><span class='Ref_to_Global_Var'>synchronize_seqscans</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN196"><span class='Ref_to_Proto'>ss_get_location</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* page-at-a-time fields are always invalid when not rs_inited */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * copy the scan key, if appropriate 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>key</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN48"><span class='Ref_to_Member'>rs_nkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Currently, we don't have a stats counter for bitmap heap scans (but the 
     * underlying bitmap index scans will be counted) or sample scans (we only 
     * update stats for tuple fetches there) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN50"><span class='Ref_to_Member'>rs_bitmapscan</span></a> <span class='Operator'>&& !</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN51"><span class='Ref_to_Member'>rs_samplescan</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/pgstat.h.html#LN1247"><span class='Ref_to_Macro'>pgstat_count_heap_scan</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN213"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initscan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_setscanlimits - restrict range of a heapscan 
 * 
 * startBlk is the page to start at 
 * numBlks is number of pages to scan (InvalidBlockNumber means "all") 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN324"></a><span class='Declare_Function'>heap_setscanlimits</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>startBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>numBlks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* else too late to change */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* else rs_startblock is significant */ 
</span> 
    <span class='Comment_Multi_Line'>/* Check startBlk is valid (but allow case of zero blocks...) */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>startBlk</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>startBlk</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>startBlk</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN324"><span class='Ref_to_Parameter'>numBlks</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * heapgetpage - subroutine for heapgettup() 
 * 
 * This routine reads and pins the specified page of the relation. 
 * In page-at-a-time mode it performs additional work, namely determining 
 * which tuples on the page are visible. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN344"></a><span class='Declare_Function'>heapgetpage</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN346"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN347"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span><a name="LN348"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN349"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lines</span><span class='Delimiter'>; 
</span><a name="LN350"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ntup</span><span class='Delimiter'>; 
</span><a name="LN351"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>lineoff</span><span class='Delimiter'>; 
</span><a name="LN352"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lpp</span><span class='Delimiter'>; 
</span><a name="LN353"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release previous scan buffer, if any */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Be sure to check for interrupts at least once per page.  Checks at 
     * higher code levels won't be able to stop a seqscan that encounters many 
     * pages' worth of consecutive dead tuples. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* read page using selected strategy */ 
</span>    <a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN52"><span class='Ref_to_Member'>rs_pageatatime</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN347"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prune and repair fragmentation for the whole page, if possible. 
     */ 
</span>    <a href="pruneheap.c.html#LN73"><span class='Ref_to_Func'>heap_page_prune_opt</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must hold share lock on the buffer content while examining tuple 
     * visibility.  Afterwards, however, the tuples we have found to be 
     * visible are guaranteed good as long as we hold the buffer pin. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN348"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN347"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN348"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN349"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN348"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN350"><span class='Ref_To_Local'>ntup</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the all-visible flag indicates that all tuples on the page are 
     * visible to everyone, we can skip the per-tuple visibility tests. 
     * 
     * Note: In hot standby, a tuple that's already visible to all 
     * transactions in the master might still be invisible to a read-only 
     * transaction in the standby. We partly handle this problem by tracking 
     * the minimum xmin of visible tuples as the cut-off XID while marking a 
     * page all-visible on master and WAL log that along with the visibility 
     * map SET operation. In hot standby, we wait for (or abort) all 
     * transactions that can potentially may not see one or more tuples on the 
     * page. That's how index-only scans work fine in hot standby. A crucial 
     * difference between index-only scans and heap scans is that the 
     * index-only scan completely relies on the visibility map where as heap 
     * scan looks at the page-level PD_ALL_VISIBLE flag. We are not sure if 
     * the page-level flag can be trusted in the same way, because it might 
     * get propagated somehow without being explicitly WAL-logged, e.g. via a 
     * full page write. Until we can prove that beyond doubt, let's check each 
     * tuple for visibility the hard way. 
     */ 
</span>    <a href="heapam.c.html#LN353"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN348"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="heapam.c.html#LN347"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN351"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN352"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN348"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN351"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="heapam.c.html#LN351"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>&LT;= </span><a href="heapam.c.html#LN349"><span class='Ref_To_Local'>lines</span></a><span class='Delimiter'>; 
</span>         <a href="heapam.c.html#LN351"><span class='Ref_To_Local'>lineoff</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN352"><span class='Ref_To_Local'>lpp</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN352"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN427"></a>            <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>loctup</span><span class='Delimiter'>; 
</span><a name="LN428"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>valid</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN427"><span class='Ref_To_Local'>loctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN427"><span class='Ref_To_Local'>loctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN348"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN352"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN427"><span class='Ref_To_Local'>loctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN352"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN427"><span class='Ref_To_Local'>loctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN351"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN353"><span class='Ref_To_Local'>all_visible</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN428"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN428"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN427"><span class='Ref_To_Local'>loctup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN347"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/predicate.h.html#LN59"><span class='Ref_to_Proto'>CheckForSerializableConflictOut</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN428"><span class='Ref_To_Local'>valid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN427"><span class='Ref_To_Local'>loctup</span></a><span class='Delimiter'>, 
</span>                                            <a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN347"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN428"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN76"><span class='Ref_to_Member'>rs_vistuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN350"><span class='Ref_To_Local'>ntup</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heapam.c.html#LN351"><span class='Ref_To_Local'>lineoff</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ItemIdIsNormal(lpp) &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for lineoff=FirstOffsetNu... &raquo; </span> 
 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN346"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN350"><span class='Ref_To_Local'>ntup</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN344"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN75"><span class='Ref_to_Member'>rs_ntuples</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN350"><span class='Ref_To_Local'>ntup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heapgetpage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heapgettup - fetch next heap tuple 
 * 
 *      Initialize the scan if not already done; then advance to the next 
 *      tuple as indicated by "dir"; return the next tuple in scan-&GT;rs_ctup, 
 *      or set scan-&GT;rs_ctup.t_data = NULL if no more tuples. 
 * 
 * dir == NoMovementScanDirection means "re-fetch the tuple indicated 
 * by scan-&GT;rs_ctup". 
 * 
 * Note: the reason nkeys/key are passed separately, even though they are 
 * kept in the scan descriptor, is that the caller may not want us to check 
 * the scankeys. 
 * 
 * Note: when we fall off the end of the scan in either direction, we 
 * reset rs_inited.  This means that a further request with the same 
 * scan direction will restart the scan, which is a bit odd, but a 
 * request with the opposite scan direction will start a fresh scan 
 * in the proper direction.  The latter is required behavior for cursors, 
 * while the former case is generally undefined behavior in Postgres 
 * so we don't care too much. 
 * ---------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN478"></a><span class='Declare_Function'>heapgettup</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, 
</span><a name="LN479"></a>           <a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>dir</span><span class='Delimiter'>, 
</span><a name="LN480"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, 
</span><a name="LN481"></a>           <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN483"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN484"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Delimiter'>; 
</span><a name="LN485"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>backward</span> <span class='Operator'>= </span><a href="../../../include/access/sdir.h.html#LN40"><span class='Ref_to_Macro'>ScanDirectionIsBackward</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN479"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN486"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN487"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>finished</span><span class='Delimiter'>; 
</span><a name="LN488"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN489"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lines</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>lineoff</span><span class='Delimiter'>; 
</span><a name="LN491"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>linesleft</span><span class='Delimiter'>; 
</span><a name="LN492"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lpp</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * calculate next starting lineoff, given scan direction 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/sdir.h.html#LN54"><span class='Ref_to_Macro'>ScanDirectionIsForward</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN479"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * return null immediately if relation is empty 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN91"><span class='Ref_to_Proto'>heap_parallelscan_nextpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Other processes might have already finished the scan. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* first page */ 
</span>            <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* first offnum */ 
</span>            <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !scan-&GT;rs_inited &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* continue from previously returned page/tuple */ 
</span>            <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* current page */ 
</span>            <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>=</span>           <span class='Comment_Single_Line'>/* next offnum */ 
</span>                <a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN484"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* page and lineoff now reference the physically next tid */ 
</span> 
        <a href="heapam.c.html#LN491"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ScanDirectionIsForwar... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN485"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* backward parallel scan not supported */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * return null immediately if relation is empty 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Disable reporting to syncscan logic in a backwards scan; it's 
             * not very likely anyone else is doing the same thing at the same 
             * time, and much more likely that we'll just bollix things for 
             * forward scanners. 
             */ 
</span>            <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* start from last page of the scan */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !scan-&GT;rs_inited &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* continue from previously returned page/tuple */ 
</span>            <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* current page */ 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN484"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* final offnum */ 
</span>            <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>=</span>           <span class='Comment_Single_Line'>/* previous offnum */ 
</span>                <a href="../../../include/storage/off.h.html#LN54"><span class='Ref_to_Macro'>OffsetNumberPrev</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* page and lineoff now reference the physically previous tid */ 
</span> 
        <a href="heapam.c.html#LN491"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if backward &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * ``no movement'' scan direction: refetch prior tuple 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Since the tuple was previously fetched, needn't lock page here */ 
</span>        <a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN484"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * advance the scan until we find a qualifying tuple or run out of stuff 
     * to scan 
     */ 
</span>    <a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN491"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN642"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>valid</span><span class='Delimiter'>; 
</span> 
                <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * if current tuple qualifies, return it. 
                 */ 
</span>                <a href="heapam.c.html#LN642"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                                                     <a href="heapam.c.html#LN484"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, 
</span>                                                     <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/predicate.h.html#LN59"><span class='Ref_to_Proto'>CheckForSerializableConflictOut</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN642"><span class='Ref_To_Local'>valid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                                                <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN484"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN642"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN481"><span class='Ref_to_Parameter'>key</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/access/valid.h.html#LN21"><span class='Ref_to_Macro'>HeapKeyTest</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN480"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN481"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN642"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN642"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ItemIdIsNormal(lpp) &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * otherwise move to the next item on the page 
             */ 
</span>            <span class='Operator'>--</span><a href="heapam.c.html#LN491"><span class='Ref_To_Local'>linesleft</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN485"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Operator'>--</span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* move back in this page's ItemId array */ 
</span>                <span class='Operator'>--</span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Operator'>++</span><a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* move forward in this page's ItemId array */ 
</span>                <span class='Operator'>++</span><a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while linesleft&GT;0 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * if we get here, it means we've exhausted the items on this page and 
         * it's time to move to the next. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * advance to next/prior page and detect end of scan 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN485"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN487"><span class='Ref_To_Local'>finished</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>? --</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN91"><span class='Ref_to_Proto'>heap_parallelscan_nextpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN487"><span class='Ref_To_Local'>finished</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>&GT;= </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN487"><span class='Ref_To_Local'>finished</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>? --</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Report our new scan position for synchronization purposes. We 
             * don't do that when moving backwards, however. That would just 
             * mess up any other forward-moving scanners. 
             * 
             * Note: we do this before checking for end of scan so that the 
             * final state of the position hint is back at the start of the 
             * rel.  That's not strictly necessary, but otherwise when you run 
             * the same query multiple times the starting position would shift 
             * a little bit backwards on every invocation, which is confusing. 
             * We don't guarantee any specific ordering in general, though. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/access/heapam.h.html#LN195"><span class='Ref_to_Proto'>ss_report_location</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * return NULL if we've exhausted all the pages 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN487"><span class='Ref_To_Local'>finished</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN483"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN486"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN484"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN478"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN491"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN485"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN489"><span class='Ref_To_Local'>lines</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN490"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN492"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN488"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heapgettup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heapgettup_pagemode - fetch next heap tuple in page-at-a-time mode 
 * 
 *      Same API as heapgettup, but used in page-at-a-time mode 
 * 
 * The internal logic is much the same as heapgettup's too, but there are some 
 * differences: we do not take the buffer content lock (that only needs to 
 * happen inside heapgetpage), and we iterate through just the tuples listed 
 * in rs_vistuples[] rather than all tuples on the page.  Notice that 
 * lineindex is 0-based, where the corresponding loop variable lineoff in 
 * heapgettup is 1-based. 
 * ---------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN780"></a><span class='Declare_Function'>heapgettup_pagemode</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, 
</span><a name="LN781"></a>                    <a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>dir</span><span class='Delimiter'>, 
</span><a name="LN782"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, 
</span><a name="LN783"></a>                    <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN785"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN786"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>backward</span> <span class='Operator'>= </span><a href="../../../include/access/sdir.h.html#LN40"><span class='Ref_to_Macro'>ScanDirectionIsBackward</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN781"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN787"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN788"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>finished</span><span class='Delimiter'>; 
</span><a name="LN789"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN790"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lines</span><span class='Delimiter'>; 
</span><a name="LN791"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lineindex</span><span class='Delimiter'>; 
</span><a name="LN792"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>lineoff</span><span class='Delimiter'>; 
</span><a name="LN793"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>linesleft</span><span class='Delimiter'>; 
</span><a name="LN794"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lpp</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * calculate next starting lineindex, given scan direction 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/sdir.h.html#LN54"><span class='Ref_to_Macro'>ScanDirectionIsForward</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN781"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * return null immediately if relation is empty 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN91"><span class='Ref_to_Proto'>heap_parallelscan_nextpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Other processes might have already finished the scan. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* first page */ 
</span>            <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !scan-&GT;rs_inited &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* continue from previously returned page/tuple */ 
</span>            <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* current page */ 
</span>            <a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN74"><span class='Ref_to_Member'>rs_cindex</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN75"><span class='Ref_to_Member'>rs_ntuples</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* page and lineindex now reference the next visible tid */ 
</span> 
        <a href="heapam.c.html#LN793"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ScanDirectionIsForwar... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN786"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* backward parallel scan not supported */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * return null immediately if relation is empty 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Disable reporting to syncscan logic in a backwards scan; it's 
             * not very likely anyone else is doing the same thing at the same 
             * time, and much more likely that we'll just bollix things for 
             * forward scanners. 
             */ 
</span>            <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* start from last page of the scan */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !scan-&GT;rs_inited &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* continue from previously returned page/tuple */ 
</span>            <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* current page */ 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN75"><span class='Ref_to_Member'>rs_ntuples</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN74"><span class='Ref_to_Member'>rs_cindex</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* page and lineindex now reference the previous visible tid */ 
</span> 
        <a href="heapam.c.html#LN793"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if backward &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * ``no movement'' scan direction: refetch prior tuple 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Since the tuple was previously fetched, needn't lock page here */ 
</span>        <a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN792"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN792"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check that rs_cindex is in sync */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN74"><span class='Ref_to_Member'>rs_cindex</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN75"><span class='Ref_to_Member'>rs_ntuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN792"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN76"><span class='Ref_to_Member'>rs_vistuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN74"><span class='Ref_to_Member'>rs_cindex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * advance the scan until we find a qualifying tuple or run out of stuff 
     * to scan 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN793"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN792"><span class='Ref_To_Local'>lineoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN76"><span class='Ref_to_Member'>rs_vistuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a><span class='Delimiter'>]; 
</span>            <a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN792"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN794"><span class='Ref_To_Local'>lpp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN792"><span class='Ref_To_Local'>lineoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * if current tuple qualifies, return it. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN783"><span class='Ref_to_Parameter'>key</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN952"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>valid</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/valid.h.html#LN21"><span class='Ref_to_Macro'>HeapKeyTest</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN782"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN783"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN952"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN952"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN74"><span class='Ref_to_Member'>rs_cindex</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN74"><span class='Ref_to_Member'>rs_cindex</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * otherwise move to the next item on the page 
             */ 
</span>            <span class='Operator'>--</span><a href="heapam.c.html#LN793"><span class='Ref_To_Local'>linesleft</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN786"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>--</span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <span class='Operator'>++</span><a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while linesleft&GT;0 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * if we get here, it means we've exhausted the items on this page and 
         * it's time to move to the next. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN786"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN788"><span class='Ref_To_Local'>finished</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>? --</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN91"><span class='Ref_to_Proto'>heap_parallelscan_nextpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN788"><span class='Ref_To_Local'>finished</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>&GT;= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN788"><span class='Ref_To_Local'>finished</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN59"><span class='Ref_to_Member'>rs_startblock</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>? --</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN60"><span class='Ref_to_Member'>rs_numblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Report our new scan position for synchronization purposes. We 
             * don't do that when moving backwards, however. That would just 
             * mess up any other forward-moving scanners. 
             * 
             * Note: we do this before checking for end of scan so that the 
             * final state of the position hint is back at the start of the 
             * rel.  That's not strictly necessary, but otherwise when you run 
             * the same query multiple times the starting position would shift 
             * a little bit backwards on every invocation, which is confusing. 
             * We don't guarantee any specific ordering in general, though. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/access/heapam.h.html#LN195"><span class='Ref_to_Proto'>ss_report_location</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * return NULL if we've exhausted all the pages 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN788"><span class='Ref_To_Local'>finished</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN68"><span class='Ref_to_Member'>rs_cblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN785"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN66"><span class='Ref_to_Member'>rs_inited</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/heapam.h.html#LN122"><span class='Ref_to_Proto'>heapgetpage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN787"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN789"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN780"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN75"><span class='Ref_to_Member'>rs_ntuples</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN793"><span class='Ref_To_Local'>linesleft</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN786"><span class='Ref_To_Local'>backward</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN790"><span class='Ref_To_Local'>lines</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN791"><span class='Ref_To_Local'>lineindex</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heapgettup_pagemode &raquo; </span> 
 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>DISABLE_COMPLEX_MACRO<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 * This is formatted so oddly so that the correspondence to the macro 
 * definition in access/htup_details.h is maintained. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1053"></a><span class='Declare_Function'>fastgetattr</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, </span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupleDesc</span><span class='Delimiter'>, 
</span><a name="LN1054"></a>            <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span> 
            <span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? 
</span>            <span class='Parentheses'>(</span> 
             <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1054"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>)</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../../include/access/htup_details.h.html#LN664"><span class='Ref_to_Macro'>HeapTupleNoNulls</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span> <span class='Operator'>? 
</span>             <span class='Parentheses'>(</span> 
              <span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attcacheoff <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>? 
</span>              <span class='Parentheses'>(</span> 
               <a href="../../../include/access/tupmacs.h.html#LN36"><span class='Ref_to_Macro'>fetchatt</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>t_data <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>t_data<span class='Operator'>-&GT;</span>t_hoff <span class='Operator'>+ 
</span>                        <span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attcacheoff<span class='Parentheses'>)</span> 
               <span class='Parentheses'>)</span> 
              <span class='Operator'>: 
</span>              <a href="../common/heaptuple.c.html#LN350"><span class='Ref_to_Func'>nocachegetattr</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Parentheses'>))</span> 
              <span class='Parentheses'>)</span> 
             <span class='Operator'>: 
</span>             <span class='Parentheses'>(</span> 
              <a href="../../../include/access/tupmacs.h.html#LN20"><span class='Ref_to_Macro'>att_isnull</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>t_data<span class='Operator'>-&GT;</span>t_bits<span class='Parentheses'>)</span> <span class='Operator'>? 
</span>              <span class='Parentheses'>(</span> 
               <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1054"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>)</span> <span class='Null_Value'>NULL 
</span>               <span class='Parentheses'>)</span> 
              <span class='Operator'>: 
</span>              <span class='Parentheses'>(</span> 
               <a href="../common/heaptuple.c.html#LN350"><span class='Ref_to_Func'>nocachegetattr</span></a><span class='Parentheses'>((</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1053"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Parentheses'>))</span> 
               <span class='Parentheses'>)</span> 
              <span class='Parentheses'>)</span> 
             <span class='Parentheses'>)</span> 
            <span class='Operator'>: 
</span>            <span class='Parentheses'>(</span> 
             <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>)</span> <span class='Null_Value'>NULL 
</span>             <span class='Parentheses'>)</span> 
        <span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fastgetattr &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* defined(DISABLE_COMPLEX_MACRO) */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                   heap access method interface 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      relation_open - open any relation by relation OID 
 * 
 *      If lockmode is not "NoLock", the specified kind of lock is 
 *      obtained on the relation.  (Generally, NoLock should only be 
 *      used if the caller knows it has some appropriate lock on the 
 *      relation already.) 
 * 
 *      An error is raised if the relation does not exist. 
 * 
 *      NB: a "relation" is anything with a pg_class entry.  The caller is 
 *      expected to check whether the relkind is something it can handle. 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1113"></a><span class='Declare_Function'>relation_open</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relationId</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1115"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the lock before trying to open the relcache entry */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The relcache does all the real work... */ 
</span>    <a href="heapam.c.html#LN1115"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN33"><span class='Ref_to_Proto'>RelationIdGetRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN389"><span class='Ref_to_Macro'>RelationIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1115"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not open relation with OID %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN1113"><span class='Ref_to_Parameter'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make note that we've accessed a temporary relation */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN512"><span class='Ref_to_Macro'>RelationUsesLocalBuffers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1115"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))</span> 
        <a href="../transam/xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN86"><span class='Ref_to_Const'>XACT_FLAGS_ACCESSEDTEMPREL</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1189"><span class='Ref_to_Proto'>pgstat_initstats</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1115"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1115"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end relation_open &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      try_relation_open - open any relation by relation OID 
 * 
 *      Same as relation_open, except return NULL instead of failing 
 *      if the relation does not exist. 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1146"></a><span class='Declare_Function'>try_relation_open</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relationId</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1148"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the lock first */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have the lock, probe to see if the relation really exists 
     * or not. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/syscache.h.html#LN173"><span class='Ref_to_Macro'>SearchSysCacheExists1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>relationId</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Release useless lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Should be safe to do a relcache load */ 
</span>    <a href="heapam.c.html#LN1148"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN33"><span class='Ref_to_Proto'>RelationIdGetRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN389"><span class='Ref_to_Macro'>RelationIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1148"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not open relation with OID %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN1146"><span class='Ref_to_Parameter'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make note that we've accessed a temporary relation */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN512"><span class='Ref_to_Macro'>RelationUsesLocalBuffers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1148"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))</span> 
        <a href="../transam/xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN86"><span class='Ref_to_Const'>XACT_FLAGS_ACCESSEDTEMPREL</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1189"><span class='Ref_to_Proto'>pgstat_initstats</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1148"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1148"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end try_relation_open &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      relation_openrv - open any relation specified by a RangeVar 
 * 
 *      Same as relation_open, but the relation is specified by a RangeVar. 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1191"></a><span class='Declare_Function'>relation_openrv</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1193"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relOid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for shared-cache-inval messages before trying to open the 
     * relation.  This is needed even if we already hold a lock on the 
     * relation, because GRANT/REVOKE are executed without taking any lock on 
     * the target relation, and we want to be sure we see current ACL 
     * information.  We can skip this if asked for NoLock, on the assumption 
     * that such a call is not the first one in the current command, and so we 
     * should be reasonably up-to-date already.  (XXX this all could stand to 
     * be redesigned, but for the moment we'll keep doing this like it's been 
     * done historically.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1191"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up and lock the appropriate relation using namespace search */ 
</span>    <a href="heapam.c.html#LN1193"><span class='Ref_To_Local'>relOid</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/namespace.h.html#LN52"><span class='Ref_to_Macro'>RangeVarGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1191"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1191"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Let relation_open do the rest */ 
</span>    <span class='Control'>return</span> <a href="../../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1193"><span class='Ref_To_Local'>relOid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end relation_openrv &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      relation_openrv_extended - open any relation specified by a RangeVar 
 * 
 *      Same as relation_openrv, but with an additional missing_ok argument 
 *      allowing a NULL return rather than an error if the relation is not 
 *      found.  (Note that some other causes, such as permissions problems, 
 *      will still result in an ereport.) 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1226"></a><span class='Declare_Function'>relation_openrv_extended</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN1227"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1229"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relOid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for shared-cache-inval messages before trying to open the 
     * relation.  See comments in relation_openrv(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1226"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up and lock the appropriate relation using namespace search */ 
</span>    <a href="heapam.c.html#LN1229"><span class='Ref_To_Local'>relOid</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/namespace.h.html#LN52"><span class='Ref_to_Macro'>RangeVarGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1226"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1226"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1227"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return NULL on not-found */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1229"><span class='Ref_To_Local'>relOid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Let relation_open do the rest */ 
</span>    <span class='Control'>return</span> <a href="../../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1229"><span class='Ref_To_Local'>relOid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end relation_openrv_extended &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      relation_close - close any relation 
 * 
 *      If lockmode is not "NoLock", we then release the specified lock. 
 * 
 *      Note that it is often sensible to hold a lock beyond relation_close; 
 *      in that case, the lock is released automatically at xact end. 
 * ---------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1259"></a><span class='Declare_Function'>relation_close</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1261"></a>    <a href="../../../include/utils/rel.h.html#LN35"><span class='Ref_to_Struct'>LockRelId</span></a>   <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="heapam.c.html#LN1259"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1259"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN1259"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The relcache does the real work... */ 
</span>    <a href="../../../include/utils/relcache.h.html#LN34"><span class='Ref_to_Proto'>RelationClose</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1259"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1259"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN41"><span class='Ref_to_Proto'>UnlockRelationId</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1261"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1259"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_open - open a heap relation by relation OID 
 * 
 *      This is essentially relation_open plus check that the relation 
 *      is not an index nor a composite type.  (The caller should also 
 *      check that it's not a view or foreign table before assuming it has 
 *      storage.) 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1283"></a><span class='Declare_Function'>heap_open</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relationId</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1285"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN1285"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1283"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1283"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1285"><span class='Ref_To_Local'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is an index"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1285"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1285"><span class='Ref_To_Local'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is a composite type"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1285"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1285"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_open &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_openrv - open a heap relation specified 
 *      by a RangeVar node 
 * 
 *      As above, but relation is specified by a RangeVar. 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1311"></a><span class='Declare_Function'>heap_openrv</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1313"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN1313"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN86"><span class='Ref_to_Proto'>relation_openrv</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1311"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1311"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1313"><span class='Ref_To_Local'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is an index"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1313"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1313"><span class='Ref_To_Local'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is a composite type"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1313"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1313"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_openrv &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_openrv_extended - open a heap relation specified 
 *      by a RangeVar node 
 * 
 *      As above, but optionally return NULL instead of failing for 
 *      relation-not-found. 
 * ---------------- 
 */ 
</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN1340"></a><span class='Declare_Function'>heap_openrv_extended</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN1341"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1343"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN87"><span class='Ref_to_Proto'>relation_openrv_extended</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1340"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1340"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1341"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is an index"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is a composite type"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1343"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_openrv_extended &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_beginscan  - begin relation scan 
 * 
 * heap_beginscan is the "standard" case. 
 * 
 * heap_beginscan_catalog differs in setting up its own temporary snapshot. 
 * 
 * heap_beginscan_strat offers an extended API that lets the caller control 
 * whether a nondefault buffer access strategy can be used, and whether 
 * syncscan can be chosen (possibly resulting in the scan not starting from 
 * block zero).  Both of these default to TRUE with plain heap_beginscan. 
 * 
 * heap_beginscan_bm is an alternative entry point for setting up a 
 * HeapScanDesc for a bitmap heap scan.  Although that scan technology is 
 * really quite unlike a standard seqscan, there is just enough commonality 
 * to make it worth using the same data structure. 
 * 
 * heap_beginscan_sampling is an alternative entry point for setting up a 
 * HeapScanDesc for a TABLESAMPLE scan.  As with bitmap scans, it's worth 
 * using the same data structure although the behavior is rather different. 
 * In addition to the options offered by heap_beginscan_strat, this call 
 * also allows control of whether page-mode visibility checking is used. 
 * ---------------- 
 */ 
</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1390"></a><span class='Declare_Function'>heap_beginscan</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN1391"></a>               <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN81"><span class='Ref_to_Proto'>heap_beginscan_internal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1390"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1390"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1391"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1391"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1398"></a><span class='Declare_Function'>heap_beginscan_catalog</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1400"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1398"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1401"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN80"><span class='Ref_to_Proto'>RegisterSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN68"><span class='Ref_to_Proto'>GetCatalogSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1400"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN81"><span class='Ref_to_Proto'>heap_beginscan_internal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1398"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1401"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1398"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1398"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1408"></a><span class='Declare_Function'>heap_beginscan_strat</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN1409"></a>                     <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN1410"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_strat</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_sync</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN81"><span class='Ref_to_Proto'>heap_beginscan_internal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1408"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1408"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1409"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1409"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <a href="heapam.c.html#LN1410"><span class='Ref_to_Parameter'>allow_strat</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1410"><span class='Ref_to_Parameter'>allow_sync</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1418"></a><span class='Declare_Function'>heap_beginscan_bm</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN1419"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN81"><span class='Ref_to_Proto'>heap_beginscan_internal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1418"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1418"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1419"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1419"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1426"></a><span class='Declare_Function'>heap_beginscan_sampling</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN1427"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN1428"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_strat</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_sync</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_pagemode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN81"><span class='Ref_to_Proto'>heap_beginscan_internal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1426"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1426"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1427"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1427"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <a href="heapam.c.html#LN1428"><span class='Ref_to_Parameter'>allow_strat</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1428"><span class='Ref_to_Parameter'>allow_sync</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1428"><span class='Ref_to_Parameter'>allow_pagemode</span></a><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1436"></a><span class='Declare_Function'>heap_beginscan_internal</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN1437"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>nkeys</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN1438"></a>                        <a href="../../../include/access/heapam.h.html#LN100"><span class='Ref_to_Typedef'>ParallelHeapScanDesc</span></a> <span class='Declare_Parameter'>parallel_scan</span><span class='Delimiter'>, 
</span><a name="LN1439"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_strat</span><span class='Delimiter'>, 
</span><a name="LN1440"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_sync</span><span class='Delimiter'>, 
</span><a name="LN1441"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_pagemode</span><span class='Delimiter'>, 
</span><a name="LN1442"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_bitmapscan</span><span class='Delimiter'>, 
</span><a name="LN1443"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_samplescan</span><span class='Delimiter'>, 
</span><a name="LN1444"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>temp_snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1446"></a>    <a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * increment relation ref count while scanning relation 
     * 
     * This is just to make really sure the relcache entry won't go away while 
     * the scan has a pointer to it.  Caller should be holding the rel open 
     * anyway, so this is redundant in all normal scenarios... 
     */ 
</span>    <a href="../../../include/utils/rel.h.html#LN635"><span class='Ref_to_Proto'>RelationIncrementReferenceCount</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * allocate and initialize scan descriptor 
     */ 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/relscan.h.html#LN43"><span class='Ref_to_Struct'>HeapScanDescData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN48"><span class='Ref_to_Member'>rs_nkeys</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1437"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN50"><span class='Ref_to_Member'>rs_bitmapscan</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1442"><span class='Ref_to_Parameter'>is_bitmapscan</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN51"><span class='Ref_to_Member'>rs_samplescan</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1443"><span class='Ref_to_Parameter'>is_samplescan</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* set in initscan */ 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN53"><span class='Ref_to_Member'>rs_allow_strat</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1439"><span class='Ref_to_Parameter'>allow_strat</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN54"><span class='Ref_to_Member'>rs_allow_sync</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1440"><span class='Ref_to_Parameter'>allow_sync</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN55"><span class='Ref_to_Member'>rs_temp_snap</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1444"><span class='Ref_to_Parameter'>temp_snap</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1438"><span class='Ref_to_Parameter'>parallel_scan</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * we can use page-at-a-time mode if it's an MVCC-safe snapshot 
     */ 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN52"><span class='Ref_to_Member'>rs_pageatatime</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1441"><span class='Ref_to_Parameter'>allow_pagemode</span></a> <span class='Operator'>&& </span><a href="../../../include/utils/tqual.h.html#LN30"><span class='Ref_to_Macro'>IsMVCCSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For a seqscan in a serializable transaction, acquire a predicate lock 
     * on the entire relation. This is required not only to lock all the 
     * matching tuples, but also to conflict with new insertions into the 
     * table. In an indexscan, we take page locks on the index pages covering 
     * the range specified in the scan qual, but in a heap scan there is 
     * nothing more fine-grained to lock. A bitmap scan is a different story, 
     * there we have already scanned the index and locked the index pages 
     * covering the predicate. But in that case we still have to lock any 
     * matching heap tuples. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN1442"><span class='Ref_to_Parameter'>is_bitmapscan</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/predicate.h.html#LN50"><span class='Ref_to_Proto'>PredicateLockRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we only need to set this up once */ 
</span>    <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1436"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * we do this here instead of in initscan() because heap_rescan also calls 
     * initscan() and we don't want to allocate memory again 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1437"><span class='Ref_to_Parameter'>nkeys</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="heapam.c.html#LN1437"><span class='Ref_to_Parameter'>nkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN212"><span class='Ref_to_Func'>initscan</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1437"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1446"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_beginscan_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_rescan     - restart a relation scan 
 * ---------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1514"></a><span class='Declare_Function'>heap_rescan</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, 
</span><a name="LN1515"></a>            <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * unpin scan buffers 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1514"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1514"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * reinitialize scan descriptor 
     */ 
</span>    <a href="heapam.c.html#LN212"><span class='Ref_to_Func'>initscan</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1514"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1515"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * reset parallel scan, if present 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1514"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1533"></a>        <a href="../../../include/access/heapam.h.html#LN100"><span class='Ref_to_Typedef'>ParallelHeapScanDesc</span></a> <span class='Declare_Local'>parallel_scan</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Caller is responsible for making sure that all workers have 
         * finished the scan before calling this, so it really shouldn't be 
         * necessary to acquire the mutex at all.  We acquire it anyway, just 
         * to be tidy. 
         */ 
</span>        <a href="heapam.c.html#LN1533"><span class='Ref_To_Local'>parallel_scan</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1514"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1533"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN37"><span class='Ref_to_Member'>phs_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN1533"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1533"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1533"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN37"><span class='Ref_to_Member'>phs_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_rescan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_rescan_set_params  - restart a relation scan after changing params 
 * 
 * This call allows changing the buffer strategy, syncscan, and pagemode 
 * options before starting a fresh scan.  Note that although the actual use 
 * of syncscan might change (effectively, enabling or disabling reporting), 
 * the previously selected startblock will be kept. 
 * ---------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1558"></a><span class='Declare_Function'>heap_rescan_set_params</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN1559"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_strat</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_sync</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_pagemode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* adjust parameters */ 
</span>    <a href="heapam.c.html#LN1558"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN53"><span class='Ref_to_Member'>rs_allow_strat</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1559"><span class='Ref_to_Parameter'>allow_strat</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1558"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN54"><span class='Ref_to_Member'>rs_allow_sync</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1559"><span class='Ref_to_Parameter'>allow_sync</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1558"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN52"><span class='Ref_to_Member'>rs_pageatatime</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1559"><span class='Ref_to_Parameter'>allow_pagemode</span></a> <span class='Operator'>&& </span><a href="../../../include/utils/tqual.h.html#LN30"><span class='Ref_to_Macro'>IsMVCCSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1558"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ... and rescan */ 
</span>    <a href="../../../include/access/heapam.h.html#LN123"><span class='Ref_to_Proto'>heap_rescan</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1558"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1558"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_endscan    - end relation scan 
 * 
 *      See how to integrate with index scans. 
 *      Check handling if reldesc caching. 
 * ---------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1577"></a><span class='Declare_Function'>heap_endscan</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Note: no locking manipulations needed */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * unpin scan buffers 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN69"><span class='Ref_to_Member'>rs_cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * decrement relation reference count and free scan descriptor storage 
     */ 
</span>    <a href="../../../include/utils/rel.h.html#LN636"><span class='Ref_to_Proto'>RelationDecrementReferenceCount</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN232"><span class='Ref_to_Proto'>FreeAccessStrategy</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN62"><span class='Ref_to_Member'>rs_strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN55"><span class='Ref_to_Member'>rs_temp_snap</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN81"><span class='Ref_to_Proto'>UnregisterSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1577"><span class='Ref_to_Parameter'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_endscan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_parallelscan_estimate - estimate storage for ParallelHeapScanDesc 
 * 
 *      Sadly, this doesn't reduce to a constant, because the size required 
 *      to serialize the snapshot can vary. 
 * ---------------- 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1612"></a><span class='Declare_Function'>heap_parallelscan_estimate</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/relscan.h.html#LN32"><span class='Ref_to_Struct'>ParallelHeapScanDescData</span></a><span class='Delimiter'>, </span>phs_snapshot_data<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/snapmgr.h.html#LN107"><span class='Ref_to_Proto'>EstimateSnapshotSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1612"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_parallelscan_initialize - initialize ParallelHeapScanDesc 
 * 
 *      Must allow as many bytes of shared memory as returned by 
 *      heap_parallelscan_estimate.  Call this just once in the leader 
 *      process; then, individual workers attach via heap_beginscan_parallel. 
 * ---------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1627"></a><span class='Declare_Function'>heap_parallelscan_initialize</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN100"><span class='Ref_to_Typedef'>ParallelHeapScanDesc</span></a> <span class='Declare_Parameter'>target</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN1628"></a>                             <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN34"><span class='Ref_to_Member'>phs_relid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN36"><span class='Ref_to_Member'>phs_nblocks</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* compare phs_syncscan initialization to similar logic in initscan */ 
</span>    <a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN35"><span class='Ref_to_Member'>phs_syncscan</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN78"><span class='Ref_to_Global_Var'>synchronize_seqscans</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN512"><span class='Ref_to_Macro'>RelationUsesLocalBuffers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN36"><span class='Ref_to_Member'>phs_nblocks</span></a> <span class='Operator'>&GT; </span><a href="../../utils/init/globals.c.html#LN122"><span class='Ref_to_Global_Var'>NBuffers</span></a> <span class='Operator'>/ </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN37"><span class='Ref_to_Member'>phs_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN108"><span class='Ref_to_Proto'>SerializeSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1628"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1627"><span class='Ref_to_Parameter'>target</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN40"><span class='Ref_to_Member'>phs_snapshot_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_beginscan_parallel - join a parallel scan 
 * 
 *      Caller must hold a suitable lock on the correct relation. 
 * ---------------- 
 */ 
</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> 
<a name="LN1649"></a><span class='Declare_Function'>heap_beginscan_parallel</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN100"><span class='Ref_to_Typedef'>ParallelHeapScanDesc</span></a> <span class='Declare_Parameter'>parallel_scan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1651"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1649"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="heapam.c.html#LN1649"><span class='Ref_to_Parameter'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN34"><span class='Ref_to_Member'>phs_relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1651"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN109"><span class='Ref_to_Proto'>RestoreSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1649"><span class='Ref_to_Parameter'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN40"><span class='Ref_to_Member'>phs_snapshot_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN80"><span class='Ref_to_Proto'>RegisterSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1651"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN81"><span class='Ref_to_Proto'>heap_beginscan_internal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1649"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1651"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN1649"><span class='Ref_to_Parameter'>parallel_scan</span></a><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_parallelscan_nextpage - get the next page to scan 
 * 
 *      Get the next page to scan.  Even if there are no pages left to scan, 
 *      another backend could have grabbed a page to scan and not yet finished 
 *      looking at it, so it doesn't follow that the scan is done when the 
 *      first backend gets an InvalidBlockNumber return. 
 * ---------------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN1671"></a><span class='Declare_Function'>heap_parallelscan_nextpage</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1673"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span><a name="LN1674"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>sync_startpage</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span><a name="LN1675"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>report_page</span> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span><a name="LN1676"></a>    <a href="../../../include/access/heapam.h.html#LN100"><span class='Ref_to_Typedef'>ParallelHeapScanDesc</span></a> <span class='Declare_Local'>parallel_scan</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN71"><span class='Ref_to_Member'>rs_parallel</span></a><span class='Delimiter'>; 
</span> 
<a name="LN1681"></a><span class='Label'>retry</span><span class='Operator'>: 
</span>    <span class='Comment_Multi_Line'>/* Grab the spinlock. */ 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN37"><span class='Ref_to_Member'>phs_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the scan's startblock has not yet been initialized, we must do so 
     * now.  If this is not a synchronized scan, we just start at block 0, but 
     * if it is a synchronized scan, we must get the starting position from 
     * the synchronized scan machinery.  We can't hold the spinlock while 
     * doing that, though, so release the spinlock, get the information we 
     * need, and retry.  If nobody else has initialized the scan in the 
     * meantime, we'll fill in the value we fetched on the second time 
     * through. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN35"><span class='Ref_to_Member'>phs_syncscan</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1674"><span class='Ref_To_Local'>sync_startpage</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1674"><span class='Ref_To_Local'>sync_startpage</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN37"><span class='Ref_to_Member'>phs_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN1674"><span class='Ref_To_Local'>sync_startpage</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN196"><span class='Ref_to_Proto'>ss_get_location</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN1681"><span class='Ref_to_Label'>retry</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The current block number is the next one that needs to be scanned, 
     * unless it's InvalidBlockNumber already, in which case there are no more 
     * blocks to scan.  After remembering the current value, we must advance 
     * it so that the next call to this function returns the next block to be 
     * scanned. 
     */ 
</span>    <a href="heapam.c.html#LN1673"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1673"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>&GT;= </span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN58"><span class='Ref_to_Member'>rs_nblocks</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN39"><span class='Ref_to_Member'>phs_cblock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN1675"><span class='Ref_To_Local'>report_page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN38"><span class='Ref_to_Member'>phs_startblock</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Release the lock. */ 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1676"><span class='Ref_To_Local'>parallel_scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN37"><span class='Ref_to_Member'>phs_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report scan location.  Normally, we report the current page number. 
     * When we reach the end of the scan, though, we report the starting page, 
     * not the ending page, just so the starting positions for later scans 
     * doesn't slew backwards.  We only report the position at the end of the 
     * scan once, though: subsequent callers will have report nothing, since 
     * they will have page == InvalidBlockNumber. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN63"><span class='Ref_to_Member'>rs_syncscan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1675"><span class='Ref_To_Local'>report_page</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN1675"><span class='Ref_To_Local'>report_page</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1673"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1675"><span class='Ref_To_Local'>report_page</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/heapam.h.html#LN195"><span class='Ref_to_Proto'>ss_report_location</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1671"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1675"><span class='Ref_To_Local'>report_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN1673"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_parallelscan_nextpage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_update_snapshot 
 * 
 *      Update snapshot info in heap scan descriptor. 
 * ---------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1759"></a><span class='Declare_Function'>heap_update_snapshot</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/tqual.h.html#LN30"><span class='Ref_to_Macro'>IsMVCCSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1759"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN80"><span class='Ref_to_Proto'>RegisterSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1759"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1759"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN47"><span class='Ref_to_Member'>rs_snapshot</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1759"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1759"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN55"><span class='Ref_to_Member'>rs_temp_snap</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      heap_getnext    - retrieve next tuple in scan 
 * 
 *      Fix to work with index relations. 
 *      We don't return the buffer anymore, but you can get it from the 
 *      returned HeapTuple. 
 * ---------------- 
 */ 
</span> 
<span class='Directive'>#ifdef</span> HEAPDEBUGALL 
<a name="LN1778"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPDEBUG_1</span> <span class='Operator'>\ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"heap_getnext([%s,nkeys=%d],dir=%d) called"</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>         <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span>scan<span class='Operator'>-&GT;</span>rs_rd<span class='Parentheses'>)</span><span class='Delimiter'>, </span>scan<span class='Operator'>-&GT;</span>rs_nkeys<span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>direction<span class='Parentheses'>)</span> 
<a name="LN1781"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPDEBUG_2</span> <span class='Operator'>\ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"heap_getnext returning EOS"</span><span class='Parentheses'>) 
</span><a name="LN1783"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPDEBUG_3</span> <span class='Operator'>\ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"heap_getnext returning tuple"</span><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<a name="LN1786"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPDEBUG_1</span> 
<a name="LN1787"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPDEBUG_2</span> 
<a name="LN1788"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPDEBUG_3</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* !defined(HEAPDEBUGALL) */ 
</span> 
 
<a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN1793"></a><span class='Declare_Function'>heap_getnext</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Parameter'>scan</span><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN21"><span class='Ref_to_Enum'>ScanDirection</span></a> <span class='Declare_Parameter'>direction</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Note: no locking manipulations needed */ 
</span> 
    <a href="heapam.c.html#LN1778"><span class='Ref_to_Const'>HEAPDEBUG_1</span></a><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* heap_getnext( info ) */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN52"><span class='Ref_to_Member'>rs_pageatatime</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN779"><span class='Ref_to_Func'>heapgettup_pagemode</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>direction</span></a><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN48"><span class='Ref_to_Member'>rs_nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN477"><span class='Ref_to_Func'>heapgettup</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>direction</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN48"><span class='Ref_to_Member'>rs_nkeys</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN49"><span class='Ref_to_Member'>rs_key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN1781"><span class='Ref_to_Const'>HEAPDEBUG_2</span></a><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* heap_getnext returning EOS */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * if we get here it means we have a new current scan tuple, so point to 
     * the proper return buffer and return the tuple. 
     */ 
</span>    <a href="heapam.c.html#LN1783"><span class='Ref_to_Const'>HEAPDEBUG_3</span></a><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* heap_getnext returning tuple */ 
</span> 
    <a href="../../../include/pgstat.h.html#LN1252"><span class='Ref_to_Macro'>pgstat_count_heap_getnext</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN46"><span class='Ref_to_Member'>rs_rd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1793"><span class='Ref_to_Parameter'>scan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/relscan.h.html#LN67"><span class='Ref_to_Member'>rs_ctup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_getnext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_fetch      - retrieve tuple with given tid 
 * 
 * On entry, tuple-&GT;t_self is the TID to fetch.  We pin the buffer holding 
 * the tuple, fill in the remaining fields of *tuple, and check the tuple 
 * against the specified snapshot. 
 * 
 * If successful (tuple found and passes snapshot time qual), then *userbuf 
 * is set to the buffer holding the tuple and TRUE is returned.  The caller 
 * must unpin the buffer when done with the tuple. 
 * 
 * If the tuple is not found (ie, item number references a deleted slot), 
 * then tuple-&GT;t_data is set to NULL and FALSE is returned. 
 * 
 * If the tuple is found but fails the time qual check, then FALSE is returned 
 * but tuple-&GT;t_data is left pointing to the tuple. 
 * 
 * keep_buf determines what is done with the buffer in the FALSE-result cases. 
 * When the caller specifies keep_buf = true, we retain the pin on the buffer 
 * and return it in *userbuf (so the caller must eventually unpin it); when 
 * keep_buf = false, the pin is released and *userbuf is set to InvalidBuffer. 
 * 
 * stats_relation is the relation to charge the heap_fetch operation against 
 * for statistical purposes.  (This could be the heap rel itself, an 
 * associated index, or NULL to not count the fetch at all.) 
 * 
 * heap_fetch does not follow HOT chains: only the exact TID requested will 
 * be fetched. 
 * 
 * It is somewhat inconsistent that we ereport() on invalid block number but 
 * return false on invalid item number.  There are a couple of reasons though. 
 * One is that the caller can relatively easily check the block number for 
 * validity, but cannot check the item number without reading the page 
 * himself.  Another is that when we are following a t_ctid link, we can be 
 * reasonably confident that the page number is valid (since VACUUM shouldn't 
 * truncate off the destination page without having killed the referencing 
 * tuple first), but the item number might well not be good. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1861"></a><span class='Declare_Function'>heap_fetch</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN1862"></a>           <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN1863"></a>           <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, 
</span><a name="LN1864"></a>           <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>userbuf</span><span class='Delimiter'>, 
</span><a name="LN1865"></a>           <span class='Keyword'>bool </span><span class='Declare_Parameter'>keep_buf</span><span class='Delimiter'>, 
</span><a name="LN1866"></a>           <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>stats_relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1868"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>tid</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1869"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN1870"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN1871"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1872"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN1873"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>valid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch and pin the appropriate page of the relation. 
     */ 
</span>    <a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1861"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1868"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Need share lock on buffer to examine tuple commit status. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1871"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1862"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1861"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1871"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We'd better check for out-of-range offnum in case of VACUUM since the 
     * TID was obtained. 
     */ 
</span>    <a href="heapam.c.html#LN1872"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1868"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1872"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN1872"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1871"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1865"><span class='Ref_to_Parameter'>keep_buf</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get the item line pointer corresponding to the requested tid 
     */ 
</span>    <a href="heapam.c.html#LN1869"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1871"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1872"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Must check for deleted tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1869"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1865"><span class='Ref_to_Parameter'>keep_buf</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * fill in *tuple fields 
     */ 
</span>    <a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1871"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1869"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1869"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1861"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * check time qualification of tuple, then release lock 
     */ 
</span>    <a href="heapam.c.html#LN1873"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1862"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1873"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/predicate.h.html#LN52"><span class='Ref_to_Proto'>PredicateLockTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1861"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1862"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/predicate.h.html#LN59"><span class='Ref_to_Proto'>CheckForSerializableConflictOut</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1873"><span class='Ref_To_Local'>valid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1861"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1863"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1862"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1873"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * All checks passed, so return the tuple as valid. Caller is now 
         * responsible for releasing the buffer. 
         */ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Count the successful fetch against appropriate rel, if any */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1866"><span class='Ref_to_Parameter'>stats_relation</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/pgstat.h.html#LN1257"><span class='Ref_to_Macro'>pgstat_count_heap_fetch</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1866"><span class='Ref_to_Parameter'>stats_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Tuple failed time qual, but maybe caller wants to see it anyway. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1865"><span class='Ref_to_Parameter'>keep_buf</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1870"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN1864"><span class='Ref_to_Parameter'>userbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_fetch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_hot_search_buffer  - search HOT chain for tuple satisfying snapshot 
 * 
 * On entry, *tid is the TID of a tuple (either a simple tuple, or the root 
 * of a HOT chain), and buffer is the buffer holding this tuple.  We search 
 * for the first chain member satisfying the given snapshot.  If one is 
 * found, we update *tid to reference that tuple's offset number, and 
 * return TRUE.  If no match, return FALSE without modifying *tid. 
 * 
 * heapTuple is a caller-supplied buffer.  When a match is found, we return 
 * the tuple here, in addition to updating *tid.  If no match is found, the 
 * contents of this buffer on return are undefined. 
 * 
 * If all_dead is not NULL, we check non-visible tuples to see if they are 
 * globally dead; *all_dead is set TRUE if all members of the HOT chain 
 * are vacuumable, FALSE if not. 
 * 
 * Unlike heap_fetch, the caller must already have pin and (at least) share 
 * lock on the buffer; it is still pinned/locked at exit.  Also unlike 
 * heap_fetch, we do not report any pgstats count; caller may do so if wanted. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1996"></a><span class='Declare_Function'>heap_hot_search_buffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN1997"></a>                       <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>heapTuple</span><span class='Delimiter'>, 
</span><a name="LN1998"></a>                       <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>all_dead</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>first_call</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2000"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>dp</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2001"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>prev_xmax</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN2002"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN2003"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>at_chain_start</span><span class='Delimiter'>; 
</span><a name="LN2004"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>valid</span><span class='Delimiter'>; 
</span><a name="LN2005"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>skip</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If this is not the first call, previous call returned a (live!) tuple */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>first_call</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="../../utils/time/snapmgr.c.html#LN165"><span class='Ref_to_Global_Var'>RecentGlobalXmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2003"><span class='Ref_To_Local'>at_chain_start</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>first_call</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2005"><span class='Ref_To_Local'>skip</span></a> <span class='Operator'>= !</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>first_call</span></a><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan through possible multiple members of HOT-chain */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2023"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check for bogus TID */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2000"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN2023"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2000"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check for unused, dead, or redirected items */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2023"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We should only see a redirect at start of chain */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN104"><span class='Ref_to_Macro'>ItemIdIsRedirected</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2023"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="heapam.c.html#LN2003"><span class='Ref_To_Local'>at_chain_start</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Follow the redirect */ 
</span>                <a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN76"><span class='Ref_to_Macro'>ItemIdGetRedirect</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2023"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2003"><span class='Ref_To_Local'>at_chain_start</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* else must be end of chain */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2000"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2023"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2023"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Shouldn't see a HEAP_ONLY tuple at chain start. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2003"><span class='Ref_To_Local'>at_chain_start</span></a> <span class='Operator'>&& </span><a href="../../../include/access/htup_details.h.html#LN685"><span class='Ref_to_Macro'>HeapTupleIsHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The xmin should match the previous xmax value, else chain is 
         * broken. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2001"><span class='Ref_To_Local'>prev_xmax</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2001"><span class='Ref_To_Local'>prev_xmax</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * When first_call is true (and thus, skip is initially false) we'll 
         * return the first tuple we find.  But on later passes, heapTuple 
         * will initially be pointing to the tuple we returned last time. 
         * Returning it again would be incorrect (and would loop forever), so 
         * we skip it and return the next match we find. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN2005"><span class='Ref_To_Local'>skip</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * For the benefit of logical decoding, have t_self point at the 
             * element of the HOT chain we're currently investigating instead 
             * of the root tuple of the HOT chain. This is important because 
             * the *Satisfies routine for historical mvcc snapshots needs the 
             * correct tid to decide about the visibility in some cases. 
             */ 
</span>            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If it's visible per the snapshot, we must return it */ 
</span>            <a href="heapam.c.html#LN2004"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/predicate.h.html#LN59"><span class='Ref_to_Proto'>CheckForSerializableConflictOut</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2004"><span class='Ref_To_Local'>valid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Delimiter'>, 
</span>                                            <a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* reset to original, non-redirected, tid */ 
</span>            <a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2004"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/predicate.h.html#LN52"><span class='Ref_to_Proto'>PredicateLockTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !skip &raquo; </span> 
        <a href="heapam.c.html#LN2005"><span class='Ref_To_Local'>skip</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we can't see it, maybe no one else can either.  At caller 
         * request, check whether all chain members are dead to all 
         * transactions. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a> <span class='Operator'>&& *</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../../include/utils/tqual.h.html#LN76"><span class='Ref_to_Proto'>HeapTupleIsSurelyDead</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Delimiter'>, </span><a href="../../utils/time/snapmgr.c.html#LN165"><span class='Ref_to_Global_Var'>RecentGlobalXmin</span></a><span class='Parentheses'>))</span> 
            <span class='Operator'>*</span><a href="heapam.c.html#LN1998"><span class='Ref_to_Parameter'>all_dead</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check to see if HOT chain continues past this tuple; if so fetch 
         * the next offnum and loop around. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN676"><span class='Ref_to_Macro'>HeapTupleIsHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Parentheses'>) </span><span class='Operator'>== 
</span>                   <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1996"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2002"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2003"><span class='Ref_To_Local'>at_chain_start</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2001"><span class='Ref_To_Local'>prev_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN1997"><span class='Ref_to_Parameter'>heapTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* end of chain */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_hot_search_buffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_hot_search     - search HOT chain for tuple satisfying snapshot 
 * 
 * This has the same API as heap_hot_search_buffer, except that the caller 
 * does not provide the buffer containing the page, rather we access it 
 * locally. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN2138"></a><span class='Declare_Function'>heap_hot_search</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN2139"></a>                <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>all_dead</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2141"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN2142"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN2143"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>heapTuple</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN2142"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2138"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2138"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2142"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2141"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN137"><span class='Ref_to_Proto'>heap_hot_search_buffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2138"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2138"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2142"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2138"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="heapam.c.html#LN2143"><span class='Ref_To_Local'>heapTuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2139"><span class='Ref_to_Parameter'>all_dead</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2142"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2142"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN2141"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  heap_get_latest_tid -  get the latest tid of a specified tuple 
 * 
 * Actually, this gets the latest version that is visible according to 
 * the passed snapshot.  You can pass SnapshotDirty to get the very latest, 
 * possibly uncommitted version. 
 * 
 * *tid is both an input and an output parameter: it is updated to 
 * show the latest version of the row.  Note that it will not be changed 
 * if no version of the row passes the snapshot test. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2166"></a><span class='Declare_Function'>heap_get_latest_tid</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN2167"></a>                    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN2168"></a>                    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2170"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blk</span><span class='Delimiter'>; 
</span><a name="LN2171"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>ctid</span><span class='Delimiter'>; 
</span><a name="LN2172"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>priorXmax</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* this is to avoid Assert failures on bad input */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2168"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since this can be called with user-supplied TID, don't trust the input 
     * too much.  (RelationGetNumberOfBlocks is an expensive check, so we 
     * don't check t_ctid links again this way.  Note that it would not do to 
     * call it just once and save the result, either.) 
     */ 
</span>    <a href="heapam.c.html#LN2170"><span class='Ref_To_Local'>blk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2168"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2170"><span class='Ref_To_Local'>blk</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2166"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"block number %u is out of range for relation \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="heapam.c.html#LN2170"><span class='Ref_To_Local'>blk</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2166"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop to chase down t_ctid links.  At top of loop, ctid is the tuple we 
     * need to examine, and *tid is the TID we will return if ctid turns out 
     * to be bogus. 
     * 
     * Note that we will loop until we reach the end of the t_ctid chain. 
     * Depending on the snapshot passed, there might be at most one visible 
     * version of the row, but we don't try to optimize for that. 
     */ 
</span>    <a href="heapam.c.html#LN2171"><span class='Ref_To_Local'>ctid</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN2168"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2172"><span class='Ref_To_Local'>priorXmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* cannot check first XMIN */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2202"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN2203"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN2204"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN2205"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN2206"></a>        <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tp</span><span class='Delimiter'>; 
</span><a name="LN2207"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>valid</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Read, pin, and lock the page. 
         */ 
</span>        <a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2166"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2171"><span class='Ref_To_Local'>ctid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2203"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN263"><span class='Ref_to_Func'>TestForOldSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2167"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2166"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2203"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check for bogus item number.  This is not treated as an error 
         * condition because it can happen while following a t_ctid link. We 
         * just assume that the prior tid is OK and return it unchanged. 
         */ 
</span>        <a href="heapam.c.html#LN2204"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2171"><span class='Ref_To_Local'>ctid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2204"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN2204"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2203"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="heapam.c.html#LN2205"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2203"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2204"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2205"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* OK to access the tuple */ 
</span>        <a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2171"><span class='Ref_To_Local'>ctid</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2203"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2205"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2205"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2166"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * After following a t_ctid link, we might arrive at an unrelated 
         * tuple.  Check for XMIN match. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2172"><span class='Ref_To_Local'>priorXmax</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>          <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2172"><span class='Ref_To_Local'>priorXmax</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check time qualification of tuple; if visible, set it as the new 
         * result candidate. 
         */ 
</span>        <a href="heapam.c.html#LN2207"><span class='Ref_To_Local'>valid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2167"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/predicate.h.html#LN59"><span class='Ref_to_Proto'>CheckForSerializableConflictOut</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2207"><span class='Ref_To_Local'>valid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2166"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2167"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2207"><span class='Ref_To_Local'>valid</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN2168"><span class='Ref_to_Parameter'>tid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2171"><span class='Ref_To_Local'>ctid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If there's a valid t_ctid link, follow it, else we're done. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/utils/tqual.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderIsOnlyLocked</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN2171"><span class='Ref_To_Local'>ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2172"><span class='Ref_To_Local'>priorXmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2206"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2202"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span>                           <span class='Comment_Single_Line'>/* end of loop */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heap_get_latest_tid &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * UpdateXmaxHintBits - update tuple hint bits after xmax transaction ends 
 * 
 * This is called after we have waited for the XMAX transaction to terminate. 
 * If the transaction aborted, we guarantee the XMAX_INVALID hint bit will 
 * be set on exit.  If the transaction committed, we set the XMAX_COMMITTED 
 * hint bit if possible --- but beware that that may not yet be possible, 
 * if the transaction committed asynchronously. 
 * 
 * Note that if the transaction was a locker only, we set HEAP_XMAX_INVALID 
 * even if it commits. 
 * 
 * Hence callers should look only at XMAX_INVALID. 
 * 
 * Note this is not allowed for tuples whose xmax is a multixact. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2296"></a><span class='Declare_Function'>UpdateXmaxHintBits</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN191"><span class='Ref_to_Const'>HEAP_XMAX_COMMITTED</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/tqual.h.html#LN79"><span class='Ref_to_Proto'>HeapTupleSetHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN191"><span class='Ref_to_Const'>HEAP_XMAX_COMMITTED</span></a><span class='Delimiter'>, 
</span>                                 <a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/utils/tqual.h.html#LN79"><span class='Ref_to_Proto'>HeapTupleSetHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2296"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetBulkInsertState - prepare status object for a bulk insert 
 */ 
</span><a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> 
<a name="LN2318"></a><span class='Declare_Function'>GetBulkInsertState</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2320"></a>    <a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> <span class='Declare_Local'>bistate</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN2320"><span class='Ref_To_Local'>bistate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/hio.h.html#LN30"><span class='Ref_to_Struct'>BulkInsertStateData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2320"><span class='Ref_To_Local'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN32"><span class='Ref_to_Member'>strategy</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN231"><span class='Ref_to_Proto'>GetAccessStrategy</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN32"><span class='Ref_to_EnumConst'>BAS_BULKWRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2320"><span class='Ref_To_Local'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN33"><span class='Ref_to_Member'>current_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN2320"><span class='Ref_To_Local'>bistate</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * FreeBulkInsertState - clean up after finishing a bulk insert 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2332"></a><span class='Declare_Function'>FreeBulkInsertState</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> <span class='Declare_Parameter'>bistate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2332"><span class='Ref_to_Parameter'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN33"><span class='Ref_to_Member'>current_buf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2332"><span class='Ref_to_Parameter'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN33"><span class='Ref_to_Member'>current_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN232"><span class='Ref_to_Proto'>FreeAccessStrategy</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2332"><span class='Ref_to_Parameter'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN32"><span class='Ref_to_Member'>strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2332"><span class='Ref_to_Parameter'>bistate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ReleaseBulkInsertStatePin - release a buffer currently held in bistate 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2344"></a><span class='Declare_Function'>ReleaseBulkInsertStatePin</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> <span class='Declare_Parameter'>bistate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2344"><span class='Ref_to_Parameter'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN33"><span class='Ref_to_Member'>current_buf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2344"><span class='Ref_to_Parameter'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN33"><span class='Ref_to_Member'>current_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2344"><span class='Ref_to_Parameter'>bistate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/hio.h.html#LN33"><span class='Ref_to_Member'>current_buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_insert     - insert tuple into a heap 
 * 
 * The new tuple is stamped with current transaction ID and the specified 
 * command ID. 
 * 
 * If the HEAP_INSERT_SKIP_WAL option is specified, the new tuple is not 
 * logged in WAL, even for a non-temp relation.  Safe usage of this behavior 
 * requires that we arrange that all new tuples go into new pages not 
 * containing any tuples from other transactions, and that the relation gets 
 * fsync'd before commit.  (See also heap_sync() comments) 
 * 
 * The HEAP_INSERT_SKIP_FSM option is passed directly to 
 * RelationGetBufferForTuple, which see for more info. 
 * 
 * HEAP_INSERT_FROZEN should only be specified for inserts into 
 * relfilenodes created during the current subtransaction and when 
 * there are no prior snapshots or pre-existing portals open. 
 * This causes rows to be frozen, which is an MVCC violation and 
 * requires explicit options chosen by user. 
 * 
 * HEAP_INSERT_IS_SPECULATIVE is used on so-called "speculative insertions", 
 * which can be backed out afterwards without aborting the whole transaction. 
 * Other sessions can wait for the speculative insertion to be confirmed, 
 * turning it into a regular tuple, or aborted, as if it never existed. 
 * Speculatively inserted tuples behave as "value locks" of short duration, 
 * used to implement INSERT .. ON CONFLICT. 
 * 
 * Note that most of these options will be applied when inserting into the 
 * heap's TOAST table, too, if the tuple requires any out-of-line data.  Only 
 * HEAP_INSERT_IS_SPECULATIVE is explicitly ignored, as the toast data does 
 * not partake in speculative insertion. 
 * 
 * The BulkInsertState object (if any; bistate can be NULL for default 
 * behavior) is also just passed through to RelationGetBufferForTuple. 
 * 
 * The return value is the OID assigned to the tuple (either here or by the 
 * caller), or InvalidOid if no OID.  The header fields of *tup are updated 
 * to match the stored tuple; in particular tup-&GT;t_self receives the actual 
 * TID where the tuple was stored.  But note that any toasting of fields 
 * within the tuple data is NOT reflected into *tup. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN2395"></a><span class='Declare_Function'>heap_insert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, 
</span><a name="LN2396"></a>            <span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> <span class='Declare_Parameter'>bistate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2398"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN2399"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>heaptup</span><span class='Delimiter'>; 
</span><a name="LN2400"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN2401"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN2402"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible_cleared</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fill in tuple header fields, assign an OID, and toast the tuple if 
     * necessary. 
     * 
     * Note: below this point, heaptup is the data we actually intend to store 
     * into the relation; tup is the caller's original untoasted data. 
     */ 
</span>    <a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN92"><span class='Ref_to_Proto'>heap_prepare_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2398"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2396"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find buffer to insert this tuple into.  If the page is all visible, 
     * this will also pin the requisite visibility map page. 
     */ 
</span>    <a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/hio.h.html#LN39"><span class='Ref_to_Proto'>RelationGetBufferForTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2396"><span class='Ref_to_Parameter'>options</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2396"><span class='Ref_to_Parameter'>bistate</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="heapam.c.html#LN2401"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We're about to do the actual insert -- but check for conflict first, to 
     * avoid possibly having to roll back work we've just done. 
     * 
     * This is safe without a recheck as long as there is no possibility of 
     * another process scanning the page between this check and the insert 
     * being visible to the scan (i.e., an exclusive buffer content lock is 
     * continuously held from this point until the tuple insert is visible). 
     * 
     * For a heap insert, we only need to check for table-level SSI locks. Our 
     * new tuple can't possibly conflict with existing tuple locks, and heap 
     * page locks are only consolidated versions of tuple locks; they do not 
     * lock "gaps" as index page locks do.  So we don't need to specify a 
     * buffer when making the call, which makes for a faster check. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="hio.c.html#LN34"><span class='Ref_to_Func'>RelationPutHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Delimiter'>, 
</span>                         <span class='Parentheses'>(</span><a href="heapam.c.html#LN2396"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam.h.html#LN30"><span class='Ref_to_Const'>HEAP_INSERT_SPECULATIVE</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN2402"><span class='Ref_To_Local'>all_visible_cleared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN2401"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX Should we set PageSetPrunable on this page ? 
     * 
     * The inserting transaction may eventually abort thus making this tuple 
     * DEAD and hence available for pruning. Though we don't want to optimize 
     * for aborts, if no other tuple in this page is UPDATEd/DELETEd, the 
     * aborted tuple will never be pruned until next vacuum is triggered. 
     * 
     * If you do add PageSetPrunable here, add it in heap_xlog_insert too. 
     */ 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2396"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam.h.html#LN27"><span class='Ref_to_Const'>HEAP_INSERT_SKIP_WAL</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2469"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN129"><span class='Ref_to_Struct'>xl_heap_insert</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN2470"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN119"><span class='Ref_to_Struct'>xl_heap_header</span></a> <span class='Declare_Local'>xlhdr</span><span class='Delimiter'>; 
</span><a name="LN2471"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN2472"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2473"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN31"><span class='Ref_to_Const'>XLOG_HEAP_INSERT</span></a><span class='Delimiter'>; 
</span><a name="LN2474"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bufflags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is a catalog, we need to transmit combocids to properly 
         * decode, so log that as well. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN559"><span class='Ref_to_Macro'>RelationIsAccessibleInLogicalDecoding</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN123"><span class='Ref_to_Proto'>log_heap_new_cid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is the single and first tuple on page, we can reinit the 
         * page instead of restoring the whole thing.  Set flag, and hide 
         * buffer references from XLogInsert. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2472"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN2473"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN45"><span class='Ref_to_Const'>XLOG_HEAP_INIT_PAGE</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2474"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN2469"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN131"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2469"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN132"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2402"><span class='Ref_To_Local'>all_visible_cleared</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN2469"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN132"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN65"><span class='Ref_to_Const'>XLH_INSERT_ALL_VISIBLE_CLEARED</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2396"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam.h.html#LN30"><span class='Ref_to_Const'>HEAP_INSERT_SPECULATIVE</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN2469"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN132"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN67"><span class='Ref_to_Const'>XLH_INSERT_IS_SPECULATIVE</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * For logical decoding, we need the tuple even if we're doing a full 
         * page write, so make sure it's included even if we take a full-page 
         * image. (XXX We could alternatively store a pointer into the FPW). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN575"><span class='Ref_to_Macro'>RelationIsLogicallyLogged</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN2469"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN132"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN68"><span class='Ref_to_Const'>XLH_INSERT_CONTAINS_NEW_TUPLE</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2474"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN37"><span class='Ref_to_Const'>REGBUF_KEEP_DATA</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN2469"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN137"><span class='Ref_to_Const'>SizeOfHeapInsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN2470"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN121"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2470"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN122"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2470"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * note we mark xlhdr as belonging to buffer; if XLogInsert decides to 
         * write the whole page to the xlog, we don't need to store 
         * xl_heap_header in the xlog. 
         */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><a href="heapam.c.html#LN2474"><span class='Ref_To_Local'>bufflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN2470"><span class='Ref_To_Local'>xlhdr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* PG73FORMAT: write bitmap [+ padding] [+ oid] + data */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* filtering by origin on a row level is much more efficient */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN42"><span class='Ref_to_Proto'>XLogSetRecordFlags</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN191"><span class='Ref_to_Const'>XLOG_INCLUDE_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN2471"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="heapam.c.html#LN2473"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2472"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2471"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !(options&HEAP_INSERT... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2400"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2401"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2401"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If tuple is cachable, mark it for invalidation from the caches in case 
     * we abort.  Note it is OK to do this after releasing the buffer, because 
     * the heaptup data structure is all in local memory, not in the shared 
     * buffer. 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN37"><span class='Ref_to_Proto'>CacheInvalidateHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Note: speculative insertions are counted too, even if aborted later */ 
</span>    <a href="../../../include/pgstat.h.html#LN1287"><span class='Ref_to_Proto'>pgstat_count_heap_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If heaptup is a private copy, release it.  Don't forget to copy t_self 
     * back to the caller's image, too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2399"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2395"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine for heap_insert(). Prepares a tuple for insertion. This sets the 
 * tuple header fields, assigns an OID, and toasts the tuple if necessary. 
 * Returns a toasted version of the tuple if it was toasted, or the original 
 * tuple if not. Note that in any case, the header fields are also set in 
 * the original tuple. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN2579"></a><span class='Declare_Function'>heap_prepare_insert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN2580"></a>                    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * For now, parallel operations are required to be strictly read-only. 
     * Unlike heap_update() and heap_delete(), an insert should never create a 
     * combo CID, so it might be possible to relax this restriction, but not 
     * without more thought and testing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot insert tuples during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasoids<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
        <span class='Comment_Multi_Line'>/* this is redundant with an Assert in HeapTupleSetOid */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If the object id of this tuple has already been assigned, trust the 
         * caller.  There are a couple of ways this can happen.  At initial db 
         * creation, the backend program sets oids for tuples. When we define 
         * an index, we set the oid.  Finally, in the future, we may allow 
         * users to set their own object ids in order to support a persistent 
         * object store (objects need to contain pointers to one another). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>)))</span> 
            <a href="../../../include/access/htup_details.h.html#LN697"><span class='Ref_to_Macro'>HeapTupleSetOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/catalog.h.html#LN44"><span class='Ref_to_Proto'>GetNewOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* check there is not space for an OID */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN203"><span class='Ref_to_Const'>HEAP_XACT_MASK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN268"><span class='Ref_to_Const'>HEAP2_XACT_MASK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2580"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam.h.html#LN29"><span class='Ref_to_Const'>HEAP_INSERT_FROZEN</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN345"><span class='Ref_to_Macro'>HeapTupleHeaderSetXminFrozen</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/htup_details.h.html#LN390"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2580"><span class='Ref_to_Parameter'>cid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* for cleanliness */ 
</span>    <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the new tuple is too big for storage or contains already toasted 
     * out-of-line attributes from some other relation, invoke the toaster. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* toast table entries should never be recursively toasted */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/tuptoaster.h.html#LN54"><span class='Ref_to_Const'>TOAST_TUPLE_THRESHOLD</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="../../../include/access/tuptoaster.h.html#LN134"><span class='Ref_to_Proto'>toast_insert_or_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN2580"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="heapam.c.html#LN2579"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_prepare_insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_multi_insert   - insert multiple tuple into a heap 
 * 
 * This is like heap_insert(), but inserts multiple tuples in one operation. 
 * That's faster than calling heap_insert() in a loop, because when multiple 
 * tuples can be inserted on a single page, we can write just a single WAL 
 * record covering all of them, and only need to lock/unlock the page once. 
 * 
 * Note: this leaks memory into the current memory context. You can create a 
 * temporary context before calling this, if that's a problem. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2657"></a><span class='Declare_Function'>heap_multi_insert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuples</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntuples</span><span class='Delimiter'>, 
</span><a name="LN2658"></a>                  <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> <span class='Declare_Parameter'>bistate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2660"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN2661"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>heaptuples</span><span class='Delimiter'>; 
</span><a name="LN2662"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2663"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndone</span><span class='Delimiter'>; 
</span><a name="LN2664"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>scratch</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2665"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN2666"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needwal</span><span class='Delimiter'>; 
</span><a name="LN2667"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>saveFreeSpace</span><span class='Delimiter'>; 
</span><a name="LN2668"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_tuple_data</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN575"><span class='Ref_to_Macro'>RelationIsLogicallyLogged</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2669"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_cids</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN559"><span class='Ref_to_Macro'>RelationIsAccessibleInLogicalDecoding</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN2666"><span class='Ref_To_Local'>needwal</span></a> <span class='Operator'>= !</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2658"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam.h.html#LN27"><span class='Ref_to_Const'>HEAP_INSERT_SKIP_WAL</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN2667"><span class='Ref_To_Local'>saveFreeSpace</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN307"><span class='Ref_to_Macro'>RelationGetTargetPageFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, 
</span>                                                   <a href="../../../include/utils/rel.h.html#LN286"><span class='Ref_to_Const'>HEAP_DEFAULT_FILLFACTOR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Toast and set header data in all the tuples */ 
</span>    <a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heapam.c.html#LN92"><span class='Ref_to_Proto'>heap_prepare_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                            <a href="heapam.c.html#LN2660"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2658"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2658"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate some memory to use for constructing the WAL record. Using 
     * palloc() within a critical section is not safe, so we allocate this 
     * beforehand. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2666"><span class='Ref_To_Local'>needwal</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN2664"><span class='Ref_To_Local'>scratch</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We're about to do the actual inserts -- but check for conflict first, 
     * to minimize the possibility of having to roll back work we've just 
     * done. 
     * 
     * A check here does not definitively prevent a serialization anomaly; 
     * that check MUST be done at least past the point of acquiring an 
     * exclusive buffer content lock on every buffer that will be affected, 
     * and MAY be done after all inserts are reflected in the buffers and 
     * those locks are released; otherwise there race condition.  Since 
     * multiple buffers can be locked and unlocked in the loop below, and it 
     * would not be feasible to identify and lock all of those buffers before 
     * the loop, we must do a final check at the end. 
     * 
     * The check here could be omitted with no loss of correctness; it is 
     * present strictly as an optimization. 
     * 
     * For heap inserts, we only need to check for table-level SSI locks. Our 
     * new tuples can't possibly conflict with existing tuple locks, and heap 
     * page locks are only consolidated versions of tuple locks; they do not 
     * lock "gaps" as index page locks do.  So we don't need to specify a 
     * buffer when making the call, which makes for a faster check. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2717"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN2718"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN2719"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible_cleared</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN2720"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nthispage</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Find buffer where at least the next tuple will fit.  If the page is 
         * all-visible, this will also pin the requisite visibility map page. 
         */ 
</span>        <a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/hio.h.html#LN39"><span class='Ref_to_Proto'>RelationGetBufferForTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2658"><span class='Ref_to_Parameter'>options</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2658"><span class='Ref_to_Parameter'>bistate</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="heapam.c.html#LN2718"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN2665"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till changes are logged */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * RelationGetBufferForTuple has ensured that the first tuple fits. 
         * Put that on the page, and then as many other tuples as fit. 
         */ 
</span>        <a href="hio.c.html#LN34"><span class='Ref_to_Func'>RelationPutHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a><span class='Delimiter'>], </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2743"></a>            <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>heaptup</span> <span class='Operator'>= </span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2665"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2743"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="heapam.c.html#LN2667"><span class='Ref_To_Local'>saveFreeSpace</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <a href="hio.c.html#LN34"><span class='Ref_to_Func'>RelationPutHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2743"><span class='Ref_To_Local'>heaptup</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We don't use heap_multi_insert for catalog tuples yet, but 
             * better be prepared... 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2666"><span class='Ref_To_Local'>needwal</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN2669"><span class='Ref_To_Local'>need_cids</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN123"><span class='Ref_to_Proto'>log_heap_new_cid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2743"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2665"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN2719"><span class='Ref_To_Local'>all_visible_cleared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2665"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN2718"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * XXX Should we set PageSetPrunable on this page ? See heap_insert() 
         */ 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2666"><span class='Ref_To_Local'>needwal</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2776"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN2777"></a>            <a href="../../../include/access/heapam_xlog.h.html#LN150"><span class='Ref_to_Struct'>xl_heap_multi_insert</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN2778"></a>            <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN57"><span class='Ref_to_Const'>XLOG_HEAP2_MULTI_INSERT</span></a><span class='Delimiter'>; 
</span><a name="LN2779"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tupledata</span><span class='Delimiter'>; 
</span><a name="LN2780"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>totaldatalen</span><span class='Delimiter'>; 
</span><a name="LN2781"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>scratchptr</span> <span class='Operator'>= </span><a href="heapam.c.html#LN2664"><span class='Ref_To_Local'>scratch</span></a><span class='Delimiter'>; 
</span><a name="LN2782"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>init</span><span class='Delimiter'>; 
</span><a name="LN2783"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bufflags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the page was previously empty, we can reinit the page 
             * instead of restoring the whole thing. 
             */ 
</span>            <a href="heapam.c.html#LN2782"><span class='Ref_To_Local'>init</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& 
</span>                    <a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2665"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* allocate xl_heap_multi_insert struct from the scratch area */ 
</span>            <a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN150"><span class='Ref_to_Struct'>xl_heap_multi_insert</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a> <span class='Operator'>+= </span><a href="../../../include/access/heapam_xlog.h.html#LN157"><span class='Ref_to_Const'>SizeOfHeapMultiInsert</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Allocate offsets array. Unless we're reinitializing the page, 
             * in that case the tuples are stored in order starting at 
             * FirstOffsetNumber and we don't need to store the offsets 
             * explicitly. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN2782"><span class='Ref_To_Local'>init</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* the rest of the scratch space is used for tuple data */ 
</span>            <a href="heapam.c.html#LN2779"><span class='Ref_To_Local'>tupledata</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN152"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2719"><span class='Ref_To_Local'>all_visible_cleared</span></a> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN65"><span class='Ref_to_Const'>XLH_INSERT_ALL_VISIBLE_CLEARED</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN153"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Write out an xl_multi_insert_tuple and the tuple data itself 
             * for each tuple. 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2817"></a>                <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>heaptup</span> <span class='Operator'>= </span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2818"></a>                <a href="../../../include/access/heapam_xlog.h.html#LN159"><span class='Ref_to_Struct'>xl_multi_insert_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tuphdr</span><span class='Delimiter'>; 
</span><a name="LN2819"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>datalen</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN2782"><span class='Ref_To_Local'>init</span></a><span class='Parentheses'>) 
</span>                    <a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN154"><span class='Ref_to_Member'>offsets</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN2817"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* xl_multi_insert_tuple needs two-byte alignment. */ 
</span>                <a href="heapam.c.html#LN2818"><span class='Ref_To_Local'>tuphdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN159"><span class='Ref_to_Struct'>xl_multi_insert_tuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/c.h.html#LN583"><span class='Ref_to_Macro'>SHORTALIGN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN2818"><span class='Ref_To_Local'>tuphdr</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../../../include/access/heapam_xlog.h.html#LN168"><span class='Ref_to_Const'>SizeOfMultiInsertTuple</span></a><span class='Delimiter'>; 
</span> 
                <a href="heapam.c.html#LN2818"><span class='Ref_To_Local'>tuphdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN162"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2817"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2818"><span class='Ref_To_Local'>tuphdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN163"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2817"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2818"><span class='Ref_To_Local'>tuphdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN164"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2817"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* write bitmap [+ padding] [+ oid] + data */ 
</span>                <a href="heapam.c.html#LN2819"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2817"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN2817"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                       <a href="heapam.c.html#LN2819"><span class='Ref_To_Local'>datalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2818"><span class='Ref_To_Local'>tuphdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN161"><span class='Ref_to_Member'>datalen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2819"><span class='Ref_To_Local'>datalen</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN2819"><span class='Ref_To_Local'>datalen</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nthispage;i++ &raquo; </span> 
            <a href="heapam.c.html#LN2780"><span class='Ref_To_Local'>totaldatalen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN2779"><span class='Ref_To_Local'>tupledata</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="heapam.c.html#LN2781"><span class='Ref_To_Local'>scratchptr</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN2664"><span class='Ref_To_Local'>scratch</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2668"><span class='Ref_To_Local'>need_tuple_data</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN152"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN68"><span class='Ref_to_Const'>XLH_INSERT_CONTAINS_NEW_TUPLE</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Signal that this is the last xl_heap_multi_insert record 
             * emitted by this call to heap_multi_insert(). Needed for logical 
             * decoding so it knows when to cleanup temporary data. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN152"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN66"><span class='Ref_to_Const'>XLH_INSERT_LAST_IN_MULTI</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2782"><span class='Ref_To_Local'>init</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="heapam.c.html#LN2778"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN45"><span class='Ref_to_Const'>XLOG_HEAP_INIT_PAGE</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN2783"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we're doing logical decoding, include the new tuple data 
             * even if we take a full-page image of the page. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2668"><span class='Ref_To_Local'>need_tuple_data</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN2783"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN37"><span class='Ref_to_Const'>REGBUF_KEEP_DATA</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN2777"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2779"><span class='Ref_To_Local'>tupledata</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN2664"><span class='Ref_To_Local'>scratch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><a href="heapam.c.html#LN2783"><span class='Ref_To_Local'>bufflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN2779"><span class='Ref_To_Local'>tupledata</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2780"><span class='Ref_To_Local'>totaldatalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* filtering by origin on a row level is much more efficient */ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN42"><span class='Ref_to_Proto'>XLogSetRecordFlags</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN191"><span class='Ref_to_Const'>XLOG_INCLUDE_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN2776"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="heapam.c.html#LN2778"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2665"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2776"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if needwal &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2717"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2718"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2718"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN2663"><span class='Ref_To_Local'>ndone</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN2720"><span class='Ref_To_Local'>nthispage</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while ndone&LT;ntuples &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We're done with the actual inserts.  Check for conflicts again, to 
     * ensure that all rw-conflicts in to these inserts are detected.  Without 
     * this final check, a sequential scan of the heap may have locked the 
     * table after the "before" check, missing one opportunity to detect the 
     * conflict, and then scanned the table before the new tuples were there, 
     * missing the other chance to detect the conflict. 
     * 
     * For heap inserts, we only need to check for table-level SSI locks. Our 
     * new tuples can't possibly conflict with existing tuple locks, and heap 
     * page locks are only consolidated versions of tuple locks; they do not 
     * lock "gaps" as index page locks do.  So we don't need to specify a 
     * buffer when making the call. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If tuples are cachable, mark them for invalidation from the caches in 
     * case we abort.  Note it is OK to do this after releasing the buffer, 
     * because the heaptuples data structure is all in local memory, not in 
     * the shared buffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN31"><span class='Ref_to_Proto'>IsCatalogRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/inval.h.html#LN37"><span class='Ref_to_Proto'>CacheInvalidateHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy t_self fields back to the caller's original tuples. This does 
     * nothing for untoasted tuples (tuples[i] == heaptuples[i)], but it's 
     * probably faster to always copy than check. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2661"><span class='Ref_To_Local'>heaptuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN2662"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1287"><span class='Ref_to_Proto'>pgstat_count_heap_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2657"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_multi_insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  simple_heap_insert - insert a tuple 
 * 
 * Currently, this routine differs from heap_insert only in supplying 
 * a default command ID and not allowing access to the speedup options. 
 * 
 * This should be used rather than using heap_insert directly in most places 
 * where we are modifying system catalogs. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN2938"></a><span class='Declare_Function'>simple_heap_insert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/access/heapam.h.html#LN151"><span class='Ref_to_Proto'>heap_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN2938"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN2938"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Given infomask/infomask2, compute the bits that must be saved in the 
 * "infobits" field of xl_heap_delete, xl_heap_update, xl_heap_lock, 
 * xl_heap_lock_updated WAL records. 
 * 
 * See fix_infomask_from_infobits. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> 
<a name="LN2951"></a><span class='Declare_Function'>compute_infobits</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> 
        <span class='Parentheses'>((</span><a href="heapam.c.html#LN2951"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN239"><span class='Ref_to_Const'>XLHL_XMAX_IS_MULTI</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>| 
</span>        <span class='Parentheses'>((</span><a href="heapam.c.html#LN2951"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN240"><span class='Ref_to_Const'>XLHL_XMAX_LOCK_ONLY</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>| 
</span>        <span class='Parentheses'>((</span><a href="heapam.c.html#LN2951"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN180"><span class='Ref_to_Const'>HEAP_XMAX_EXCL_LOCK</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN241"><span class='Ref_to_Const'>XLHL_XMAX_EXCL_LOCK</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>| 
</span>    <span class='Comment_Multi_Line'>/* note we ignore HEAP_XMAX_SHR_LOCK here */ 
</span>        <span class='Parentheses'>((</span><a href="heapam.c.html#LN2951"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN178"><span class='Ref_to_Const'>HEAP_XMAX_KEYSHR_LOCK</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN242"><span class='Ref_to_Const'>XLHL_XMAX_KEYSHR_LOCK</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>| 
</span>        <span class='Parentheses'>((</span><a href="heapam.c.html#LN2951"><span class='Ref_to_Parameter'>infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>? 
</span>         <a href="../../../include/access/heapam_xlog.h.html#LN243"><span class='Ref_to_Const'>XLHL_KEYS_UPDATED</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Given two versions of the same t_infomask for a tuple, compare them and 
 * return whether the relevant status for a tuple Xmax has changed.  This is 
 * used after a buffer lock has been released and reacquired: we want to ensure 
 * that the tuple state continues to be the same it was when we previously 
 * examined it. 
 * 
 * Note the Xmax field itself must be compared separately. 
 */ 
</span><span class='Keyword'>static inline bool 
</span><a name="LN2973"></a><span class='Declare_Function'>xmax_infomask_changed</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>new_infomask</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>old_infomask</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2975"></a>    <span class='Keyword'>const </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Local'>interesting</span> <span class='Operator'>= 
</span>    <a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN186"><span class='Ref_to_Const'>HEAP_LOCK_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="heapam.c.html#LN2973"><span class='Ref_to_Parameter'>new_infomask</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN2975"><span class='Ref_To_Local'>interesting</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN2973"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN2975"><span class='Ref_To_Local'>interesting</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  heap_delete - delete a tuple 
 * 
 * NB: do not call this directly unless you are prepared to deal with 
 * concurrent-update conditions.  Use simple_heap_delete instead. 
 * 
 *  relation - table to be modified (caller must hold suitable lock) 
 *  tid - TID of tuple to be deleted 
 *  cid - delete command ID (used for visibility test, and stored into 
 *      cmax if successful) 
 *  crosscheck - if not InvalidSnapshot, also check tuple against this 
 *  wait - true if should wait for any conflicting update to commit/abort 
 *  hufd - output parameter, filled in failure cases (see below) 
 * 
 * Normal, successful return value is HeapTupleMayBeUpdated, which 
 * actually means we did delete it.  Failure return codes are 
 * HeapTupleSelfUpdated, HeapTupleUpdated, or HeapTupleBeingUpdated 
 * (the last only possible if wait == false). 
 * 
 * In the failure cases, the routine fills *hufd with the tuple's t_ctid, 
 * t_xmax (resolving a possible MultiXact, if necessary), and t_cmax 
 * (the last only for HeapTupleSelfUpdated, since we 
 * cannot obtain cmax from a combocid generated by another transaction). 
 * See comments for struct HeapUpdateFailureData for additional info. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> 
<a name="LN3010"></a><span class='Declare_Function'>heap_delete</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, 
</span><a name="LN3011"></a>            <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>crosscheck</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>wait</span><span class='Delimiter'>, 
</span><a name="LN3012"></a>            <a href="../../../include/access/heapam.h.html#LN67"><span class='Ref_to_Struct'>HeapUpdateFailureData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hufd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3014"></a>    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN3015"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN3016"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN3017"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tp</span><span class='Delimiter'>; 
</span><a name="LN3018"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN3019"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN3020"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN3021"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN3022"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>new_xmax</span><span class='Delimiter'>; 
</span><a name="LN3023"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>new_infomask</span><span class='Delimiter'>, 
</span><a name="LN3024"></a>                <span class='Declare_Local'>new_infomask2</span><span class='Delimiter'>; 
</span><a name="LN3025"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_tuple_lock</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3026"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>iscombo</span><span class='Delimiter'>; 
</span><a name="LN3027"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible_cleared</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3028"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_key_tuple</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* replica identity of the tuple */ 
</span><a name="LN3029"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>old_key_copied</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Forbid this during a parallel operation, lest it allocate a combocid. 
     * Other workers might need that combocid for visibility checks, and we 
     * have no provision for broadcasting it to them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot delete tuples during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3019"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3019"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before locking the buffer, pin the visibility map page if it appears to 
     * be necessary.  Since we haven't got the lock yet, someone else might be 
     * in the middle of changing this, so we'll need to recheck after we have 
     * the lock. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3019"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we didn't pin the visibility map page and the page has become all 
     * visible while we were busy locking the buffer, we'll have to unlock and 
     * re-lock, to avoid holding the buffer lock across an I/O.  That's a bit 
     * unfortunate, but hopefully shouldn't happen often. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3019"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN3016"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3016"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3016"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3016"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>; 
</span> 
<a name="LN3079"></a><span class='Label'>l1</span><span class='Operator'>: 
</span>    <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN72"><span class='Ref_to_Proto'>HeapTupleSatisfiesUpdate</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3011"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN121"><span class='Ref_to_EnumConst'>HeapTupleInvisible</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"attempted to delete invisible tuple"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN124"><span class='Ref_to_EnumConst'>HeapTupleBeingUpdated</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN3011"><span class='Ref_to_Parameter'>wait</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3091"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xwait</span><span class='Delimiter'>; 
</span><a name="LN3092"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>infomask</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* must copy state data before unlocking buffer */ 
</span>        <a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3092"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sleep until concurrent transaction ends -- except when there's a 
         * single locker and it's our own transaction.  Note we don't care 
         * which lock mode the locker has, because we need the strongest one. 
         * 
         * Before sleeping, we need to acquire tuple lock to establish our 
         * priority for the tuple (see heap_lock_tuple).  LockTuple will 
         * release us when we are next-in-line for the tuple. 
         * 
         * If we are forced to "start over" below, we keep the tuple lock; 
         * this arranges that we stay at the head of the line while rechecking 
         * tuple state. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3092"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* wait for multixact */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN116"><span class='Ref_to_Proto'>DoesMultiXactIdConflict</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3092"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* acquire tuple lock, if necessary */ 
</span>                <a href="heapam.c.html#LN101"><span class='Ref_to_Proto'>heap_acquire_tuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3025"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* wait for multixact */ 
</span>                <a href="heapam.c.html#LN118"><span class='Ref_to_Proto'>MultiXactIdWait</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3092"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN27"><span class='Ref_to_EnumConst'>XLTW_Delete</span></a><span class='Delimiter'>, 
</span>                                <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If xwait had just locked the tuple then some other xact 
                 * could update this tuple before we get to this point.  Check 
                 * for xmax change, and start over if so. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3092"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                    <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN3079"><span class='Ref_to_Label'>l1</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if DoesMultiXactIdConfli... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * You might think the multixact is necessarily done here, but not 
             * so: it could have surviving members, namely our own xact or 
             * other subxacts of this backend.  It is legal for us to delete 
             * the tuple in either case, however (the latter case is 
             * essentially a situation of upgrading our former shared lock to 
             * exclusive).  We don't bother changing the on-disk hint bits 
             * since we are about to overwrite the xmax altogether. 
             */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if infomask&HEAP_XMAX_IS... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Wait for regular transaction to end; but first, acquire tuple 
             * lock. 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN101"><span class='Ref_to_Proto'>heap_acquire_tuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3025"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN27"><span class='Ref_to_EnumConst'>XLTW_Delete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * xwait is done, but if xwait had just locked the tuple then some 
             * other xact could update this tuple before we get to this point. 
             * Check for xmax change, and start over if so. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3092"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN3079"><span class='Ref_to_Label'>l1</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Otherwise check if it committed or aborted */ 
</span>            <a href="heapam.c.html#LN2295"><span class='Ref_to_Func'>UpdateXmaxHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3091"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !TransactionIdIsCurre... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * We may overwrite if previous xmax aborted, or if it committed but 
         * only locked the tuple without updating it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/utils/tqual.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderIsOnlyLocked</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result==HeapTupleBein... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3011"><span class='Ref_to_Parameter'>crosscheck</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Perform additional check for transaction-snapshot mode RI updates */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3011"><span class='Ref_to_Parameter'>crosscheck</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a> <span class='Operator'>|| 
</span>               <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a> <span class='Operator'>|| 
</span>               <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN124"><span class='Ref_to_EnumConst'>HeapTupleBeingUpdated</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3012"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN69"><span class='Ref_to_Member'>ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3012"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN70"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN3012"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN71"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup.h.html#LN80"><span class='Ref_to_Proto'>HeapTupleHeaderGetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN3012"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN71"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3025"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN180"><span class='Ref_to_Macro'>UnlockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="heapam.c.html#LN3014"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We're about to do the actual delete -- check for conflict first, to 
     * avoid possibly having to roll back work we've just done. 
     * 
     * This is safe without a recheck as long as there is no possibility of 
     * another process scanning the page between this check and the delete 
     * being visible to the scan (i.e., an exclusive buffer content lock is 
     * continuously held from this point until the tuple delete is visible). 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* replace cid with a combo cid if necessary */ 
</span>    <a href="../../../include/access/htup.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderAdjustCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3011"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3026"><span class='Ref_To_Local'>iscombo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute replica identity tuple before entering the critical section so 
     * we don't PANIC upon a memory allocation failure. 
     */ 
</span>    <a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN124"><span class='Ref_to_Proto'>ExtractReplicaIdentity</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3029"><span class='Ref_To_Local'>old_key_copied</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is the first possibly-multixact-able operation in the current 
     * transaction, set my per-backend OldestMemberMXactId setting. We can be 
     * certain that the transaction will never become a member of any older 
     * MultiXactIds than that.  (We have to do this even if we end up just 
     * using our own TransactionId below, since some other backend could 
     * incorporate our XID into a MultiXact immediately afterwards.) 
     */ 
</span>    <a href="../../../include/access/multixact.h.html#LN111"><span class='Ref_to_Proto'>MultiXactIdSetOldestMember</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN104"><span class='Ref_to_Proto'>compute_new_xmax_infomask</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN3015"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="heapam.c.html#LN3022"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3023"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3024"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this transaction commits, the tuple will become DEAD sooner or 
     * later.  Set flag that this page is a candidate for pruning once our xid 
     * falls below the OldestXmin horizon.  If the transaction finally aborts, 
     * the subsequent page pruning will be a no-op and the hint will be 
     * cleared. 
     */ 
</span>    <a href="../../../include/storage/bufpage.h.html#LN394"><span class='Ref_to_Macro'>PageSetPrunable</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3015"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN3027"><span class='Ref_To_Local'>all_visible_cleared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* store transaction information of xact deleting the tuple */ 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3023"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3024"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN496"><span class='Ref_to_Macro'>HeapTupleHeaderClearHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3022"><span class='Ref_To_Local'>new_xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN398"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3011"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3026"><span class='Ref_To_Local'>iscombo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Make sure there is no forward chain link in t_ctid */ 
</span>    <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XLOG stuff 
     * 
     * NB: heap_abort_speculative() uses the same xlog record and replay 
     * routines. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3290"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN101"><span class='Ref_to_Struct'>xl_heap_delete</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN3291"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* For logical decode we need combocids to properly decode the catalog */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN559"><span class='Ref_to_Macro'>RelationIsAccessibleInLogicalDecoding</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN123"><span class='Ref_to_Proto'>log_heap_new_cid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3027"><span class='Ref_To_Local'>all_visible_cleared</span></a> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN91"><span class='Ref_to_Const'>XLH_DELETE_ALL_VISIBLE_CLEARED</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN105"><span class='Ref_to_Member'>infobits_set</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2950"><span class='Ref_to_Func'>compute_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                              <a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN103"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3022"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relreplident <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN178"><span class='Ref_to_Const'>REPLICA_IDENTITY_FULL</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN92"><span class='Ref_to_Const'>XLH_DELETE_CONTAINS_OLD_TUPLE</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN93"><span class='Ref_to_Const'>XLH_DELETE_CONTAINS_OLD_KEY</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN3290"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN109"><span class='Ref_to_Const'>SizeOfHeapDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Log replica identity of the deleted tuple if there is one 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3321"></a>            <a href="../../../include/access/heapam_xlog.h.html#LN119"><span class='Ref_to_Struct'>xl_heap_header</span></a> <span class='Declare_Local'>xlhdr</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN3321"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN121"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3321"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN122"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3321"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN3321"><span class='Ref_To_Local'>xlhdr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> 
                             <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                             <a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> 
                             <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* filtering by origin on a row level is much more efficient */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN42"><span class='Ref_to_Proto'>XLogSetRecordFlags</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN191"><span class='Ref_to_Const'>XLOG_INCLUDE_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN3291"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN32"><span class='Ref_to_Const'>XLOG_HEAP_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3018"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3291"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rela... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3021"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the tuple has toasted out-of-line attributes, we need to delete 
     * those items too.  We have to do this before releasing the buffer 
     * because we need to look at the contents of the tuple, but it's OK to 
     * release the content lock on the buffer first. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* toast table entries should never be recursively toasted */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN144"><span class='Ref_to_Proto'>toast_delete</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark tuple for invalidation from system caches at next command 
     * boundary. We have to do this before releasing the buffer because we 
     * need to look at the contents of the tuple. 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN37"><span class='Ref_to_Proto'>CacheInvalidateHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can release the buffer */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3020"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release the lmgr tuple lock, if we had it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3025"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN180"><span class='Ref_to_Macro'>UnlockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3017"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1289"><span class='Ref_to_Proto'>pgstat_count_heap_delete</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3010"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="heapam.c.html#LN3029"><span class='Ref_To_Local'>old_key_copied</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3028"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_delete &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  simple_heap_delete - delete a tuple 
 * 
 * This routine may be used to delete a tuple when concurrent updates of 
 * the target tuple are not expected (for example, because we have a lock 
 * on the relation associated with the tuple).  Any failure is reported 
 * via ereport(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3397"></a><span class='Declare_Function'>simple_heap_delete</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3399"></a>    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN3400"></a>    <a href="../../../include/access/heapam.h.html#LN67"><span class='Ref_to_Struct'>HeapUpdateFailureData</span></a> <span class='Declare_Local'>hufd</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3399"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN155"><span class='Ref_to_Proto'>heap_delete</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3397"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3397"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true </span><span class='Comment_Multi_Line'>/* wait for commit */ </span><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="heapam.c.html#LN3400"><span class='Ref_To_Local'>hufd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3399"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Tuple was already updated in current command? */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"tuple already updated by self"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* done successfully */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"tuple concurrently updated"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized heap_delete status: %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN3399"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end simple_heap_delete &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_update - replace a tuple 
 * 
 * NB: do not call this directly unless you are prepared to deal with 
 * concurrent-update conditions.  Use simple_heap_update instead. 
 * 
 *  relation - table to be modified (caller must hold suitable lock) 
 *  otid - TID of old tuple to be replaced 
 *  newtup - newly constructed tuple data to store 
 *  cid - update command ID (used for visibility test, and stored into 
 *      cmax/cmin if successful) 
 *  crosscheck - if not InvalidSnapshot, also check old tuple against this 
 *  wait - true if should wait for any conflicting update to commit/abort 
 *  hufd - output parameter, filled in failure cases (see below) 
 *  lockmode - output parameter, filled with lock mode acquired on tuple 
 * 
 * Normal, successful return value is HeapTupleMayBeUpdated, which 
 * actually means we *did* update it.  Failure return codes are 
 * HeapTupleSelfUpdated, HeapTupleUpdated, or HeapTupleBeingUpdated 
 * (the last only possible if wait == false). 
 * 
 * On success, the header fields of *newtup are updated to match the new 
 * stored tuple; in particular, newtup-&GT;t_self is set to the TID where the 
 * new tuple was inserted, and its HEAP_ONLY_TUPLE flag is set iff a HOT 
 * update was done.  However, any TOAST changes in the new tuple's 
 * data are not reflected into *newtup. 
 * 
 * In the failure cases, the routine fills *hufd with the tuple's t_ctid, 
 * t_xmax (resolving a possible MultiXact, if necessary), and t_cmax 
 * (the last only for HeapTupleSelfUpdated, since we 
 * cannot obtain cmax from a combocid generated by another transaction). 
 * See comments for struct HeapUpdateFailureData for additional info. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> 
<a name="LN3461"></a><span class='Declare_Function'>heap_update</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>otid</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, 
</span><a name="LN3462"></a>            <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>crosscheck</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>wait</span><span class='Delimiter'>, 
</span><a name="LN3463"></a>            <a href="../../../include/access/heapam.h.html#LN67"><span class='Ref_to_Struct'>HeapUpdateFailureData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hufd</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3465"></a>    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN3466"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN3467"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>hot_attrs</span><span class='Delimiter'>; 
</span><a name="LN3468"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>key_attrs</span><span class='Delimiter'>; 
</span><a name="LN3469"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>id_attrs</span><span class='Delimiter'>; 
</span><a name="LN3470"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>interesting_attrs</span><span class='Delimiter'>; 
</span><a name="LN3471"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>modified_attrs</span><span class='Delimiter'>; 
</span><a name="LN3472"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN3473"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>oldtup</span><span class='Delimiter'>; 
</span><a name="LN3474"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>heaptup</span><span class='Delimiter'>; 
</span><a name="LN3475"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_key_tuple</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN3476"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>old_key_copied</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3477"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN3478"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN3479"></a>    <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>mxact_status</span><span class='Delimiter'>; 
</span><a name="LN3480"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>, 
</span><a name="LN3481"></a>                <span class='Declare_Local'>newbuf</span><span class='Delimiter'>, 
</span><a name="LN3482"></a>                <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, 
</span><a name="LN3483"></a>                <span class='Declare_Local'>vmbuffer_new</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN3484"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_toast</span><span class='Delimiter'>; 
</span><a name="LN3485"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newtupsize</span><span class='Delimiter'>, 
</span><a name="LN3486"></a>                <span class='Declare_Local'>pagefree</span><span class='Delimiter'>; 
</span><a name="LN3487"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_tuple_lock</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3488"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>iscombo</span><span class='Delimiter'>; 
</span><a name="LN3489"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>use_hot_update</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3490"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>hot_attrs_checked</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3491"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>key_intact</span><span class='Delimiter'>; 
</span><a name="LN3492"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible_cleared</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3493"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible_cleared_new</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3494"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>checked_lockers</span><span class='Delimiter'>; 
</span><a name="LN3495"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>locker_remains</span><span class='Delimiter'>; 
</span><a name="LN3496"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmax_new_tuple</span><span class='Delimiter'>, 
</span><a name="LN3497"></a>                <span class='Declare_Local'>xmax_old_tuple</span><span class='Delimiter'>; 
</span><a name="LN3498"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>infomask_old_tuple</span><span class='Delimiter'>, 
</span><a name="LN3499"></a>                <span class='Declare_Local'>infomask2_old_tuple</span><span class='Delimiter'>, 
</span><a name="LN3500"></a>                <span class='Declare_Local'>infomask_new_tuple</span><span class='Delimiter'>, 
</span><a name="LN3501"></a>                <span class='Declare_Local'>infomask2_new_tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>otid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Forbid this during a parallel operation, lest it allocate a combocid. 
     * Other workers might need that combocid for visibility checks, and we 
     * have no provision for broadcasting it to them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot update tuples during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch the list of attributes to be checked for various operations. 
     * 
     * For HOT considerations, this is wasted effort if we fail to update or 
     * have to put the new tuple on a different page.  But we must compute the 
     * list before obtaining buffer lock --- in the worst case, if we are 
     * doing an update on one of the relevant system catalogs, we could 
     * deadlock if we try to fetch the list later.  In any case, the relcache 
     * caches the data so this is usually pretty cheap. 
     * 
     * We also need columns used by the replica identity and columns that are 
     * considered the "key" of rows in the table. 
     * 
     * Note that we get copies of each bitmap, so we need not worry about 
     * relcache flush happening midway through. 
     */ 
</span>    <a href="heapam.c.html#LN3467"><span class='Ref_To_Local'>hot_attrs</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN56"><span class='Ref_to_Proto'>RelationGetIndexAttrBitmap</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN50"><span class='Ref_to_EnumConst'>INDEX_ATTR_BITMAP_ALL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3468"><span class='Ref_To_Local'>key_attrs</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN56"><span class='Ref_to_Proto'>RelationGetIndexAttrBitmap</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN51"><span class='Ref_to_EnumConst'>INDEX_ATTR_BITMAP_KEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3469"><span class='Ref_To_Local'>id_attrs</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN56"><span class='Ref_to_Proto'>RelationGetIndexAttrBitmap</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/utils/relcache.h.html#LN53"><span class='Ref_to_EnumConst'>INDEX_ATTR_BITMAP_IDENTITY_KEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <a href="heapam.c.html#LN3478"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>otid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3478"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page is already full, there is hardly any chance of doing a HOT 
     * update on this page. It might be wasteful effort to look for index 
     * column updates only to later reject HOT updates for lack of space in 
     * the same page. So we be conservative and only fetch hot_attrs if the 
     * page is not already full. Since we are already holding a pin on the 
     * buffer, there is no chance that the buffer can get cleaned up 
     * concurrently and even if that was possible, in the worst case we lose a 
     * chance to do a HOT update. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN374"><span class='Ref_to_Macro'>PageIsFull</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN91"><span class='Ref_to_Proto'>bms_add_members</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3467"><span class='Ref_To_Local'>hot_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3490"><span class='Ref_To_Local'>hot_attrs_checked</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN91"><span class='Ref_to_Proto'>bms_add_members</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3468"><span class='Ref_To_Local'>key_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN91"><span class='Ref_to_Proto'>bms_add_members</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3469"><span class='Ref_To_Local'>id_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before locking the buffer, pin the visibility map page if it appears to 
     * be necessary.  Since we haven't got the lock yet, someone else might be 
     * in the middle of changing this, so we'll need to recheck after we have 
     * the lock. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3478"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3472"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>otid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3472"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fill in enough data in oldtup for HeapDetermineModifiedColumns to work 
     * properly. 
     */ 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3472"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3472"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>otid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* the new tuple is ready, except for this: */ 
</span>    <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fill in OID for newtup */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasoids<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
        <span class='Comment_Multi_Line'>/* this is redundant with an Assert in HeapTupleSetOid */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="../../../include/access/htup_details.h.html#LN697"><span class='Ref_to_Macro'>HeapTupleSetOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* check there is not space for an OID */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Determine columns modified by the update. */ 
</span>    <a href="heapam.c.html#LN3471"><span class='Ref_To_Local'>modified_attrs</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN98"><span class='Ref_to_Proto'>HeapDetermineModifiedColumns</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a><span class='Delimiter'>, 
</span>                                                  <span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're not updating any "key" column, we can grab a weaker lock type. 
     * This allows for more concurrency when we are running simultaneously 
     * with foreign key checks. 
     * 
     * Note that if a column gets detoasted while executing the update, but 
     * the value ends up being the same, this test will fail and we will use 
     * the stronger lock.  This is acceptable; the important case to optimize 
     * is updates that don't manipulate key columns, not those that 
     * serendipitiously arrive at the same key values. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/nodes/bitmapset.h.html#LN76"><span class='Ref_to_Proto'>bms_overlap</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3471"><span class='Ref_To_Local'>modified_attrs</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3468"><span class='Ref_To_Local'>key_attrs</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3479"><span class='Ref_To_Local'>mxact_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3491"><span class='Ref_To_Local'>key_intact</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is the first possibly-multixact-able operation in the 
         * current transaction, set my per-backend OldestMemberMXactId 
         * setting. We can be certain that the transaction will never become a 
         * member of any older MultiXactIds than that.  (We have to do this 
         * even if we end up just using our own TransactionId below, since 
         * some other backend could incorporate our XID into a MultiXact 
         * immediately afterwards.) 
         */ 
</span>        <a href="../../../include/access/multixact.h.html#LN111"><span class='Ref_to_Proto'>MultiXactIdSetOldestMember</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3479"><span class='Ref_To_Local'>mxact_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3491"><span class='Ref_To_Local'>key_intact</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: beyond this point, use oldtup not otid to refer to old tuple. 
     * otid may very well point at newtup-&GT;t_self, which we will overwrite 
     * with the new tuple's location, so there's great risk of confusion if we 
     * use otid anymore. 
     */ 
</span> 
<a name="LN3648"></a><span class='Label'>l2</span><span class='Operator'>: 
</span>    <a href="heapam.c.html#LN3494"><span class='Ref_To_Local'>checked_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3495"><span class='Ref_To_Local'>locker_remains</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN72"><span class='Ref_to_Proto'>HeapTupleSatisfiesUpdate</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* see below about the "no wait" case */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN124"><span class='Ref_to_EnumConst'>HeapTupleBeingUpdated</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>wait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN121"><span class='Ref_to_EnumConst'>HeapTupleInvisible</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"attempted to update invisible tuple"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN124"><span class='Ref_to_EnumConst'>HeapTupleBeingUpdated</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>wait</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3665"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xwait</span><span class='Delimiter'>; 
</span><a name="LN3666"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>infomask</span><span class='Delimiter'>; 
</span><a name="LN3667"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>can_continue</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * XXX note that we don't consider the "no wait" case here.  This 
         * isn't a problem currently because no caller uses that case, but it 
         * should be fixed if such a caller is introduced.  It wasn't a 
         * problem previously because this code would always wait, but now 
         * that some tuple locks do not conflict with one of the lock modes we 
         * use, it is possible that this case is interesting to handle 
         * specially. 
         * 
         * This may cause failures with third-party code that calls 
         * heap_update directly. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* must copy state data before unlocking buffer */ 
</span>        <a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now we have to do something about the existing locker.  If it's a 
         * multi, sleep on it; we might be awakened before it is completely 
         * gone (or even not sleep at all in some cases); we need to preserve 
         * it as locker, unless it is gone completely. 
         * 
         * If it's not a multi, we need to check for sleeping conditions 
         * before actually going to sleep.  If the update doesn't conflict 
         * with the locks, we just continue without sleeping (but making sure 
         * it is preserved). 
         * 
         * Before sleeping, we need to acquire tuple lock to establish our 
         * priority for the tuple (see heap_lock_tuple).  LockTuple will 
         * release us when we are next-in-line for the tuple.  Note we must 
         * not acquire the tuple lock until we're sure we're going to sleep; 
         * otherwise we're open for race conditions with other transactions 
         * holding the tuple lock which sleep on us. 
         * 
         * If we are forced to "start over" below, we keep the tuple lock; 
         * this arranges that we stay at the head of the line while rechecking 
         * tuple state. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3710"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>update_xact</span><span class='Delimiter'>; 
</span><a name="LN3711"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>remain</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN116"><span class='Ref_to_Proto'>DoesMultiXactIdConflict</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* acquire tuple lock, if necessary */ 
</span>                <a href="heapam.c.html#LN101"><span class='Ref_to_Proto'>heap_acquire_tuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3487"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* wait for multixact */ 
</span>                <a href="heapam.c.html#LN118"><span class='Ref_to_Proto'>MultiXactIdWait</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3479"><span class='Ref_To_Local'>mxact_status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN26"><span class='Ref_to_EnumConst'>XLTW_Update</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="heapam.c.html#LN3711"><span class='Ref_To_Local'>remain</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN3494"><span class='Ref_To_Local'>checked_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN3495"><span class='Ref_To_Local'>locker_remains</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3711"><span class='Ref_To_Local'>remain</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If xwait had just locked the tuple then some other xact 
                 * could update this tuple before we get to this point.  Check 
                 * for xmax change, and start over if so. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                          <a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN3648"><span class='Ref_to_Label'>l2</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if DoesMultiXactIdConfli... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * Note that the multixact may not be done by now.  It could have 
             * surviving members; our own xact or other subxacts of this 
             * backend, and also any other concurrent transaction that locked 
             * the tuple with KeyShare if we only got TupleLockUpdate.  If 
             * this is the case, we have to be careful to mark the updated 
             * tuple with the surviving members in Xmax. 
             * 
             * Note that there could have been another update in the 
             * MultiXact. In that case, we need to check whether it committed 
             * or aborted. If it aborted we are safe to update it again; 
             * otherwise there is an update conflict, and we have to return 
             * HeapTupleUpdated below. 
             * 
             * In the LockTupleExclusive case, we still need to preserve the 
             * surviving members: those would include the tuple locks we had 
             * before this one, which are important to keep in case this 
             * subxact aborts. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span> 
                <a href="heapam.c.html#LN3710"><span class='Ref_To_Local'>update_xact</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup.h.html#LN85"><span class='Ref_to_Proto'>HeapTupleGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN3710"><span class='Ref_To_Local'>update_xact</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * There was no UPDATE in the MultiXact; or it aborted. No 
             * TransactionIdIsInProgress() call needed here, since we called 
             * MultiXactIdWait() above. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3710"><span class='Ref_To_Local'>update_xact</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <a href="../../../include/access/transam.h.html#LN162"><span class='Ref_to_Proto'>TransactionIdDidAbort</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3710"><span class='Ref_To_Local'>update_xact</span></a><span class='Parentheses'>))</span> 
                <a href="heapam.c.html#LN3667"><span class='Ref_To_Local'>can_continue</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if infomask&HEAP_XMAX_IS... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The only locker is ourselves; we can avoid grabbing the tuple 
             * lock here, but must preserve our locking information. 
             */ 
</span>            <a href="heapam.c.html#LN3494"><span class='Ref_To_Local'>checked_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3495"><span class='Ref_To_Local'>locker_remains</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3667"><span class='Ref_To_Local'>can_continue</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN251"><span class='Ref_to_Macro'>HEAP_XMAX_IS_KEYSHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="heapam.c.html#LN3491"><span class='Ref_To_Local'>key_intact</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If it's just a key-share locker, and we're not changing the key 
             * columns, we don't need to wait for it to end; but we need to 
             * preserve it as locker. 
             */ 
</span>            <a href="heapam.c.html#LN3494"><span class='Ref_To_Local'>checked_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3495"><span class='Ref_To_Local'>locker_remains</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3667"><span class='Ref_To_Local'>can_continue</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Wait for regular transaction to end; but first, acquire tuple 
             * lock. 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN101"><span class='Ref_to_Proto'>heap_acquire_tuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3487"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, 
</span>                              <a href="../../../include/storage/lmgr.h.html#LN26"><span class='Ref_to_EnumConst'>XLTW_Update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3494"><span class='Ref_To_Local'>checked_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * xwait is done, but if xwait had just locked the tuple then some 
             * other xact could update this tuple before we get to this point. 
             * Check for xmax change, and start over if so. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3666"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN3648"><span class='Ref_to_Label'>l2</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Otherwise check if it committed or aborted */ 
</span>            <a href="heapam.c.html#LN2295"><span class='Ref_to_Func'>UpdateXmaxHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3665"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN3667"><span class='Ref_To_Local'>can_continue</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3667"><span class='Ref_To_Local'>can_continue</span></a> <span class='Operator'>? </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a> <span class='Operator'>: </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result==HeapTupleBein... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>crosscheck</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Perform additional check for transaction-snapshot mode RI updates */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>crosscheck</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a> <span class='Operator'>|| 
</span>               <a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a> <span class='Operator'>|| 
</span>               <a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN124"><span class='Ref_to_EnumConst'>HeapTupleBeingUpdated</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN69"><span class='Ref_to_Member'>ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN70"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN71"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup.h.html#LN80"><span class='Ref_to_Proto'>HeapTupleHeaderGetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN71"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3487"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN180"><span class='Ref_to_Macro'>UnlockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3467"><span class='Ref_To_Local'>hot_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3468"><span class='Ref_To_Local'>key_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3469"><span class='Ref_To_Local'>id_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3471"><span class='Ref_To_Local'>modified_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="heapam.c.html#LN3465"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result!=HeapTupleMayB... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we didn't pin the visibility map page and the page has become all 
     * visible while we were busy locking the buffer, or during some 
     * subsequent window during which we had it unlocked, we'll have to unlock 
     * and re-lock, to avoid holding the buffer lock across an I/O.  That's a 
     * bit unfortunate, especially since we'll now have to recheck whether the 
     * tuple has been locked or updated under us, but hopefully it won't 
     * happen very often. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3478"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN3648"><span class='Ref_to_Label'>l2</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Fill in transaction status data */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the tuple we're updating is locked, we need to preserve the locking 
     * info in the old tuple's Xmax.  Prepare a new Xmax value for this. 
     */ 
</span>    <a href="heapam.c.html#LN104"><span class='Ref_to_Proto'>compute_new_xmax_infomask</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN3466"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="heapam.c.html#LN3497"><span class='Ref_To_Local'>xmax_old_tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3498"><span class='Ref_To_Local'>infomask_old_tuple</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="heapam.c.html#LN3499"><span class='Ref_To_Local'>infomask2_old_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And also prepare an Xmax value for the new copy of the tuple.  If there 
     * was no xmax previously, or there was one but all lockers are now gone, 
     * then use InvalidXid; otherwise, get the xmax from the old tuple.  (In 
     * rare cases that might also be InvalidXid and yet not have the 
     * HEAP_XMAX_INVALID bit set; that's fine.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="heapam.c.html#LN3494"><span class='Ref_To_Local'>checked_lockers</span></a> <span class='Operator'>&& !</span><a href="heapam.c.html#LN3495"><span class='Ref_To_Local'>locker_remains</span></a><span class='Parentheses'>))</span> 
        <a href="heapam.c.html#LN3496"><span class='Ref_To_Local'>xmax_new_tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN3496"><span class='Ref_To_Local'>xmax_new_tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3496"><span class='Ref_To_Local'>xmax_new_tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN3500"><span class='Ref_To_Local'>infomask_new_tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3501"><span class='Ref_To_Local'>infomask2_new_tuple</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we found a valid Xmax for the new tuple, then the infomask bits 
         * to use on the new tuple depend on what was there on the old one. 
         * Note that since we're doing an update, the only possibility is that 
         * the lockers had FOR KEY SHARE lock. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3496"><span class='Ref_To_Local'>xmax_new_tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3500"><span class='Ref_To_Local'>infomask_new_tuple</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="heapam.c.html#LN3501"><span class='Ref_To_Local'>infomask2_new_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN3500"><span class='Ref_To_Local'>infomask_new_tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN178"><span class='Ref_to_Const'>HEAP_XMAX_KEYSHR_LOCK</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3501"><span class='Ref_To_Local'>infomask2_new_tuple</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare the new tuple with the appropriate initial values of Xmin and 
     * Xmax, as well as initial infomask bits as computed above. 
     */ 
</span>    <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN203"><span class='Ref_to_Const'>HEAP_XACT_MASK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN268"><span class='Ref_to_Const'>HEAP2_XACT_MASK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3466"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN390"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>cid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN194"><span class='Ref_to_Const'>HEAP_UPDATED</span></a> <span class='Operator'>| </span><a href="heapam.c.html#LN3500"><span class='Ref_To_Local'>infomask_new_tuple</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3501"><span class='Ref_To_Local'>infomask2_new_tuple</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3496"><span class='Ref_To_Local'>xmax_new_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Replace cid with a combo cid if necessary.  Note that we already put 
     * the plain cid into the new tuple. 
     */ 
</span>    <a href="../../../include/access/htup.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderAdjustCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3488"><span class='Ref_To_Local'>iscombo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the toaster needs to be activated, OR if the new tuple will not fit 
     * on the same page as the old, then we need to release the content lock 
     * (but not the pin!) on the old tuple's buffer while we are off doing 
     * TOAST and/or table-file-extension work.  We must mark the old tuple to 
     * show that it's locked, else other processes may try to update it 
     * themselves. 
     * 
     * We need to invoke the toaster if there are already any out-of-line 
     * toasted values present, or if the new tuple is over-threshold. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* toast table entries should never be recursively toasted */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3484"><span class='Ref_To_Local'>need_toast</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN3484"><span class='Ref_To_Local'>need_toast</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                      <a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                      <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/tuptoaster.h.html#LN54"><span class='Ref_to_Const'>TOAST_TUPLE_THRESHOLD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3486"><span class='Ref_To_Local'>pagefree</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN3485"><span class='Ref_To_Local'>newtupsize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3484"><span class='Ref_To_Local'>need_toast</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN3485"><span class='Ref_To_Local'>newtupsize</span></a> <span class='Operator'>&GT; </span><a href="heapam.c.html#LN3486"><span class='Ref_To_Local'>pagefree</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3978"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmax_lock_old_tuple</span><span class='Delimiter'>; 
</span><a name="LN3979"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>infomask_lock_old_tuple</span><span class='Delimiter'>, 
</span><a name="LN3980"></a>                    <span class='Declare_Local'>infomask2_lock_old_tuple</span><span class='Delimiter'>; 
</span><a name="LN3981"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>cleared_all_frozen</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * To prevent concurrent sessions from updating the tuple, we have to 
         * temporarily mark it locked, while we release the lock. 
         * 
         * To satisfy the rule that any xid potentially appearing in a buffer 
         * written out to disk, we unfortunately have to WAL log this 
         * temporary modification.  We can reuse xl_heap_lock for this 
         * purpose.  If we crash/error before following through with the 
         * actual update, xmax will be of an aborted transaction, allowing 
         * other sessions to proceed. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Compute xmax / infomask appropriate for locking the tuple. This has 
         * to be done separately from the lock, because the potentially 
         * created multixact would otherwise be wrong. 
         */ 
</span>        <a href="heapam.c.html#LN104"><span class='Ref_to_Proto'>compute_new_xmax_infomask</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                  <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>, 
</span>                                  <a href="heapam.c.html#LN3466"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="heapam.c.html#LN3978"><span class='Ref_To_Local'>xmax_lock_old_tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3979"><span class='Ref_To_Local'>infomask_lock_old_tuple</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="heapam.c.html#LN3980"><span class='Ref_To_Local'>infomask2_lock_old_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3979"><span class='Ref_To_Local'>infomask_lock_old_tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Clear obsolete visibility flags ... */ 
</span>        <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN682"><span class='Ref_to_Macro'>HeapTupleClearHotUpdated</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* ... and store info about transaction updating this tuple */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3978"><span class='Ref_To_Local'>xmax_lock_old_tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3978"><span class='Ref_To_Local'>xmax_lock_old_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3979"><span class='Ref_To_Local'>infomask_lock_old_tuple</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3980"><span class='Ref_To_Local'>infomask2_lock_old_tuple</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN398"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3488"><span class='Ref_To_Local'>iscombo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* temporarily make it look not-updated, but locked */ 
</span>        <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Clear all-frozen bit on visibility map if needed. We could 
         * immediately reset ALL_VISIBLE, but given that the WAL logging 
         * overhead would be unchanged, that doesn't seem necessarily 
         * worthwhile. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3478"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN3981"><span class='Ref_To_Local'>cleared_all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN4040"></a>            <a href="../../../include/access/heapam_xlog.h.html#LN249"><span class='Ref_to_Struct'>xl_heap_lock</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN4041"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN4040"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN252"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN4040"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN251"><span class='Ref_to_Member'>locking_xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3978"><span class='Ref_To_Local'>xmax_lock_old_tuple</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN4040"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN253"><span class='Ref_to_Member'>infobits_set</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2950"><span class='Ref_to_Func'>compute_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                                  <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN4040"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN254"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= 
</span>                <a href="heapam.c.html#LN3981"><span class='Ref_To_Local'>cleared_all_frozen</span></a> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN246"><span class='Ref_to_Const'>XLH_LOCK_ALL_FROZEN_CLEARED</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN4040"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN257"><span class='Ref_to_Const'>SizeOfHeapLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN4041"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN37"><span class='Ref_to_Const'>XLOG_HEAP_LOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4041"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Let the toaster do its thing, if needed. 
         * 
         * Note: below this point, heaptup is the data we actually intend to 
         * store into the relation; newtup is the caller's original untoasted 
         * data. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3484"><span class='Ref_To_Local'>need_toast</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Note we always use WAL and FSM during updates */ 
</span>            <a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN134"><span class='Ref_to_Proto'>toast_insert_or_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN3485"><span class='Ref_To_Local'>newtupsize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now, do we need a new page for the tuple, or not?  This is a bit 
         * tricky since someone else could have added tuples to the page while 
         * we weren't looking.  We have to recheck the available space after 
         * reacquiring the buffer lock.  But don't bother to do that if the 
         * former amount of free space is still not enough; it's unlikely 
         * there's more free now than before. 
         * 
         * What's more, if we need to get a new page, we will need to acquire 
         * buffer locks on both old and new pages.  To avoid deadlock against 
         * some other backend trying to get the same two locks in the other 
         * order, we must be consistent about the order we get the locks in. 
         * We use the rule "lock the lower-numbered page of the relation 
         * first".  To implement this, we must do RelationGetBufferForTuple 
         * while not holding the lock on the old page, and we must rely on it 
         * to get the locks on both pages in the correct order. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3485"><span class='Ref_To_Local'>newtupsize</span></a> <span class='Operator'>&GT; </span><a href="heapam.c.html#LN3486"><span class='Ref_To_Local'>pagefree</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Assume there's no chance to put heaptup on same page. */ 
</span>            <a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/hio.h.html#LN39"><span class='Ref_to_Proto'>RelationGetBufferForTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>, 
</span>                                               <a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                               <span class='Operator'>&</span><a href="heapam.c.html#LN3483"><span class='Ref_To_Local'>vmbuffer_new</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Re-acquire the lock on the old tuple's page. */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Re-check using the up-to-date free space */ 
</span>            <a href="heapam.c.html#LN3486"><span class='Ref_To_Local'>pagefree</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3485"><span class='Ref_To_Local'>newtupsize</span></a> <span class='Operator'>&GT; </span><a href="heapam.c.html#LN3486"><span class='Ref_To_Local'>pagefree</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Rats, it doesn't fit anymore.  We must now unlock and 
                 * relock to avoid deadlock.  Fortunately, this path should 
                 * seldom be taken. 
                 */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/hio.h.html#LN39"><span class='Ref_to_Proto'>RelationGetBufferForTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>, 
</span>                                                   <a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                                   <span class='Operator'>&</span><a href="heapam.c.html#LN3483"><span class='Ref_To_Local'>vmbuffer_new</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* OK, it fits here, so we're done. */ 
</span>                <a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if need_toast||newtupsiz... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No TOAST work needed, and it'll fit on same page */ 
</span>        <a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We're about to do the actual update -- check for conflict first, to 
     * avoid possibly having to roll back work we've just done. 
     * 
     * This is safe without a recheck as long as there is no possibility of 
     * another process scanning the pages between this check and the update 
     * being visible to the scan (i.e., exclusive buffer content lock(s) are 
     * continuously held from this point until the tuple update is visible). 
     * 
     * For the new tuple the only check needed is at the relation level, but 
     * since both tuples are in the same relation and the check for oldtup 
     * will include checking the relation level, there is no benefit to a 
     * separate check for the new tuple. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * At this point newbuf and buffer are both pinned and locked, and newbuf 
     * has enough space for the new tuple.  If they are the same buffer, only 
     * one pin is held. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Since the new tuple is going into the same page, we might be able 
         * to do a HOT update.  Check if any of the index columns have been 
         * changed. If the page was already full, we may have skipped checking 
         * for index columns. If so, HOT update is possible. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3490"><span class='Ref_To_Local'>hot_attrs_checked</span></a> <span class='Operator'>&& !</span><a href="../../../include/nodes/bitmapset.h.html#LN76"><span class='Ref_to_Proto'>bms_overlap</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3471"><span class='Ref_To_Local'>modified_attrs</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3467"><span class='Ref_To_Local'>hot_attrs</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN3489"><span class='Ref_To_Local'>use_hot_update</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Set a hint that the old page could use prune/defrag */ 
</span>        <a href="../../../include/storage/bufpage.h.html#LN376"><span class='Ref_to_Macro'>PageSetFull</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute replica identity tuple before entering the critical section so 
     * we don't PANIC upon a memory allocation failure. 
     * ExtractReplicaIdentity() will return NULL if nothing needs to be 
     * logged. 
     */ 
</span>    <a href="heapam.c.html#LN3475"><span class='Ref_To_Local'>old_key_tuple</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN124"><span class='Ref_to_Proto'>ExtractReplicaIdentity</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../../include/nodes/bitmapset.h.html#LN76"><span class='Ref_to_Proto'>bms_overlap</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3471"><span class='Ref_To_Local'>modified_attrs</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3469"><span class='Ref_To_Local'>id_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="heapam.c.html#LN3476"><span class='Ref_To_Local'>old_key_copied</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this transaction commits, the old tuple will become DEAD sooner or 
     * later.  Set flag that this page is a candidate for pruning once our xid 
     * falls below the OldestXmin horizon.  If the transaction finally aborts, 
     * the subsequent page pruning will be a no-op and the hint will be 
     * cleared. 
     * 
     * XXX Should we set hint on newbuf as well?  If the transaction aborts, 
     * there would be a prunable tuple in the newbuf; but for now we choose 
     * not to optimize for aborts.  Note that heap_xlog_update must be kept in 
     * sync if this decision changes. 
     */ 
</span>    <a href="../../../include/storage/bufpage.h.html#LN394"><span class='Ref_to_Macro'>PageSetPrunable</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3477"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3466"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3489"><span class='Ref_To_Local'>use_hot_update</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Mark the old tuple as HOT-updated */ 
</span>        <a href="../../../include/access/htup_details.h.html#LN679"><span class='Ref_to_Macro'>HeapTupleSetHotUpdated</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* And mark the new tuple as heap-only */ 
</span>        <a href="../../../include/access/htup_details.h.html#LN688"><span class='Ref_to_Macro'>HeapTupleSetHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Mark the caller's copy too, in case different from heaptup */ 
</span>        <a href="../../../include/access/htup_details.h.html#LN688"><span class='Ref_to_Macro'>HeapTupleSetHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Make sure tuples are correctly marked as not-HOT */ 
</span>        <a href="../../../include/access/htup_details.h.html#LN682"><span class='Ref_to_Macro'>HeapTupleClearHotUpdated</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN691"><span class='Ref_to_Macro'>HeapTupleClearHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN691"><span class='Ref_to_Macro'>HeapTupleClearHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="hio.c.html#LN34"><span class='Ref_to_Func'>RelationPutHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* insert new tuple */ 
</span> 
 
    <span class='Comment_Multi_Line'>/* Clear obsolete visibility flags, possibly set by ourselves above... */ 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ... and store info about transaction updating this tuple */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3497"><span class='Ref_To_Local'>xmax_old_tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3497"><span class='Ref_To_Local'>xmax_old_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3498"><span class='Ref_To_Local'>infomask_old_tuple</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN3499"><span class='Ref_To_Local'>infomask2_old_tuple</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN398"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3462"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3488"><span class='Ref_To_Local'>iscombo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* record address of new tuple in t_ctid of old one */ 
</span>    <a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* clear PD_ALL_VISIBLE flags, reset all visibilitymap bits */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN3492"><span class='Ref_To_Local'>all_visible_cleared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN3493"><span class='Ref_To_Local'>all_visible_cleared_new</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN3483"><span class='Ref_To_Local'>vmbuffer_new</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN4255"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * For logical decoding we need combocids to properly decode the 
         * catalog. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN559"><span class='Ref_to_Macro'>RelationIsAccessibleInLogicalDecoding</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN123"><span class='Ref_to_Proto'>log_heap_new_cid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN123"><span class='Ref_to_Proto'>log_heap_new_cid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN4255"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN94"><span class='Ref_to_Proto'>log_heap_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, 
</span>                                 <a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Delimiter'>, 
</span>                                 <a href="heapam.c.html#LN3475"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Delimiter'>, 
</span>                                 <a href="heapam.c.html#LN3492"><span class='Ref_To_Local'>all_visible_cleared</span></a><span class='Delimiter'>, 
</span>                                 <a href="heapam.c.html#LN3493"><span class='Ref_To_Local'>all_visible_cleared_new</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN4255"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN4255"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rela... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark old tuple for invalidation from system caches at next command 
     * boundary, and mark the new tuple for invalidation in case we abort. We 
     * have to do this before releasing the buffer because oldtup is in the 
     * buffer.  (heaptup is all in local memory, but it's necessary to process 
     * both tuple versions in one call to inval.c so we can avoid redundant 
     * sinval messages.) 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN37"><span class='Ref_to_Proto'>CacheInvalidateHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can release the buffer(s) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3481"><span class='Ref_To_Local'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3480"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3483"><span class='Ref_To_Local'>vmbuffer_new</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3483"><span class='Ref_To_Local'>vmbuffer_new</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3482"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release the lmgr tuple lock, if we had it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3487"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN180"><span class='Ref_to_Macro'>UnlockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN3473"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN3463"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1288"><span class='Ref_to_Proto'>pgstat_count_heap_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN3489"><span class='Ref_To_Local'>use_hot_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If heaptup is a private copy, release it.  Don't forget to copy t_self 
     * back to the caller's image, too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN3461"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3474"><span class='Ref_To_Local'>heaptup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN3475"><span class='Ref_To_Local'>old_key_tuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="heapam.c.html#LN3476"><span class='Ref_To_Local'>old_key_copied</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3475"><span class='Ref_To_Local'>old_key_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3467"><span class='Ref_To_Local'>hot_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3468"><span class='Ref_To_Local'>key_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3469"><span class='Ref_To_Local'>id_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3471"><span class='Ref_To_Local'>modified_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN3470"><span class='Ref_To_Local'>interesting_attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_update &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if the specified attribute's value is same in both given tuples. 
 * Subroutine for HeapDetermineModifiedColumns. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN4339"></a><span class='Declare_Function'>heap_tuple_attr_equals</span><span class='Parentheses'>(</span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attrnum</span><span class='Delimiter'>, 
</span><a name="LN4340"></a>                       <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup1</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4342"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>value1</span><span class='Delimiter'>, 
</span><a name="LN4343"></a>                <span class='Declare_Local'>value2</span><span class='Delimiter'>; 
</span><a name="LN4344"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull1</span><span class='Delimiter'>, 
</span><a name="LN4345"></a>                <span class='Declare_Local'>isnull2</span><span class='Delimiter'>; 
</span><a name="LN4346"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If it's a whole-tuple reference, say "not equal".  It's not really 
     * worth supporting this case, since it could only succeed after a no-op 
     * update, which is hardly a case worth optimizing for. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Likewise, automatically say "not equal" for any system attribute other 
     * than OID and tableOID; we cannot expect these to be consistent in a HOT 
     * chain, or even to be set correctly yet in the new tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>!= </span><a href="../../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a> <span class='Operator'>&& 
</span>            <a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>!= </span><a href="../../../include/access/sysattr.h.html#LN26"><span class='Ref_to_Const'>TableOidAttributeNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Extract the corresponding values.  XXX this is pretty inefficient if 
     * there are many indexed columns.  Should HeapDetermineModifiedColumns do 
     * a single heap_deform_tuple call on each tuple, instead?  But that 
     * doesn't work for system columns ... 
     */ 
</span>    <a href="heapam.c.html#LN4342"><span class='Ref_To_Local'>value1</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4340"><span class='Ref_to_Parameter'>tup1</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4344"><span class='Ref_To_Local'>isnull1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4343"><span class='Ref_To_Local'>value2</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4340"><span class='Ref_to_Parameter'>tup2</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4345"><span class='Ref_To_Local'>isnull2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If one value is NULL and other is not, then they are certainly not 
     * equal 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4344"><span class='Ref_To_Local'>isnull1</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN4345"><span class='Ref_To_Local'>isnull2</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If both are NULL, they can be considered equal. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4344"><span class='Ref_To_Local'>isnull1</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do simple binary comparison of the two datums.  This may be overly 
     * strict because there can be multiple binary representations for the 
     * same logical value.  But we should be OK as long as there are no false 
     * positives.  Using a type-specific equality operator is messy because 
     * there could be multiple notions of equality in different operator 
     * classes; furthermore, we cannot safely invoke user-defined functions 
     * while holding exclusive buffer lock. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The only allowed system columns are OIDs, so do this */ 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN505"><span class='Ref_to_Macro'>DatumGetObjectId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4342"><span class='Ref_To_Local'>value1</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/postgres.h.html#LN505"><span class='Ref_to_Macro'>DatumGetObjectId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4343"><span class='Ref_To_Local'>value2</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>&LT;= </span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN4346"><span class='Ref_To_Local'>att</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN4339"><span class='Ref_to_Parameter'>attrnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/datum.h.html#LN45"><span class='Ref_to_Proto'>datumIsEqual</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4342"><span class='Ref_To_Local'>value1</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4343"><span class='Ref_To_Local'>value2</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4346"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attbyval<span class='Delimiter'>, </span><a href="heapam.c.html#LN4346"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attlen<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_tuple_attr_equals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check which columns are being updated. 
 * 
 * Given an updated tuple, determine (and return into the output bitmapset), 
 * from those listed as interesting, the set of columns that changed. 
 * 
 * The input bitmapset is destructively modified; that is OK since this is 
 * invoked at most once in heap_update. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>* 
</span><a name="LN4422"></a><span class='Declare_Function'>HeapDetermineModifiedColumns</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>interesting_cols</span><span class='Delimiter'>, 
</span><a name="LN4423"></a>                             <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4425"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>attnum</span><span class='Delimiter'>; 
</span><a name="LN4426"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>modified</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="heapam.c.html#LN4425"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN97"><span class='Ref_to_Proto'>bms_first_member</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4422"><span class='Ref_to_Parameter'>interesting_cols</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN4425"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>+= </span><a href="../../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN4338"><span class='Ref_to_Func'>heap_tuple_attr_equals</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4422"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="heapam.c.html#LN4425"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4423"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4423"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN4426"><span class='Ref_To_Local'>modified</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4426"><span class='Ref_To_Local'>modified</span></a><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN4425"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>- </span><a href="../../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN4426"><span class='Ref_To_Local'>modified</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  simple_heap_update - replace a tuple 
 * 
 * This routine may be used to update a tuple when concurrent updates of 
 * the target tuple are not expected (for example, because we have a lock 
 * on the relation associated with the tuple).  Any failure is reported 
 * via ereport(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4450"></a><span class='Declare_Function'>simple_heap_update</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>otid</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4452"></a>    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN4453"></a>    <a href="../../../include/access/heapam.h.html#LN67"><span class='Ref_to_Struct'>HeapUpdateFailureData</span></a> <span class='Declare_Local'>hufd</span><span class='Delimiter'>; 
</span><a name="LN4454"></a>    <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN4452"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN160"><span class='Ref_to_Proto'>heap_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4450"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4450"><span class='Ref_to_Parameter'>otid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4450"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true </span><span class='Comment_Multi_Line'>/* wait for commit */ </span><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="heapam.c.html#LN4453"><span class='Ref_To_Local'>hufd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4454"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4452"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Tuple was already updated in current command? */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"tuple already updated by self"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* done successfully */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"tuple concurrently updated"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized heap_update status: %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN4452"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end simple_heap_update &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Return the MultiXactStatus corresponding to the given tuple lock mode. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> 
<a name="LN4486"></a><span class='Declare_Function'>get_mxact_status_for_lock</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_update</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4488"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4486"><span class='Ref_to_Parameter'>is_update</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN4488"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN4486"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN142"><span class='Ref_to_Member'>updstatus</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN4488"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN4486"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN141"><span class='Ref_to_Member'>lockstatus</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4488"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lock tuple mode %d/%s"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN4486"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, 
</span>             <a href="heapam.c.html#LN4486"><span class='Ref_to_Parameter'>is_update</span></a> <span class='Operator'>? </span><span class='String'>"true"</span> <span class='Operator'>: </span><span class='String'>"false"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN4488"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  heap_lock_tuple - lock a tuple in shared or exclusive mode 
 * 
 * Note that this acquires a buffer pin, which the caller must release. 
 * 
 * Input parameters: 
 *  relation: relation containing tuple (caller must hold suitable lock) 
 *  tuple-&GT;t_self: TID of tuple to lock (rest of struct need not be valid) 
 *  cid: current command ID (used for visibility test, and stored into 
 *      tuple's cmax if lock is successful) 
 *  mode: indicates if shared or exclusive tuple lock is desired 
 *  wait_policy: what to do if tuple lock is not available 
 *  follow_updates: if true, follow the update chain to also lock descendant 
 *      tuples. 
 * 
 * Output parameters: 
 *  *tuple: all fields filled in 
 *  *buffer: set to buffer holding tuple (pinned but not locked at exit) 
 *  *hufd: filled in failure cases (see below) 
 * 
 * Function result may be: 
 *  HeapTupleMayBeUpdated: lock was successfully acquired 
 *  HeapTupleInvisible: lock failed because tuple was never visible to us 
 *  HeapTupleSelfUpdated: lock failed because tuple updated by self 
 *  HeapTupleUpdated: lock failed because tuple updated by other xact 
 *  HeapTupleWouldBlock: lock couldn't be acquired and wait_policy is skip 
 * 
 * In the failure cases other than HeapTupleInvisible, the routine fills 
 * *hufd with the tuple's t_ctid, t_xmax (resolving a possible MultiXact, 
 * if necessary), and t_cmax (the last only for HeapTupleSelfUpdated, 
 * since we cannot obtain cmax from a combocid generated by another 
 * transaction). 
 * See comments for struct HeapUpdateFailureData for additional info. 
 * 
 * See README.tuplock for a thorough explanation of this mechanism. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> 
<a name="LN4539"></a><span class='Declare_Function'>heap_lock_tuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, 
</span><a name="LN4540"></a>                <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><a href="../../../include/nodes/lockoptions.h.html#LN35"><span class='Ref_to_Enum'>LockWaitPolicy</span></a> <span class='Declare_Parameter'>wait_policy</span><span class='Delimiter'>, 
</span><a name="LN4541"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>follow_updates</span><span class='Delimiter'>, 
</span><a name="LN4542"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN67"><span class='Ref_to_Struct'>HeapUpdateFailureData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hufd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4544"></a>    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN4545"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>tid</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN4546"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN4547"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN4548"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN4549"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN4550"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>, 
</span><a name="LN4551"></a>                <span class='Declare_Local'>xmax</span><span class='Delimiter'>; 
</span><a name="LN4552"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>old_infomask</span><span class='Delimiter'>, 
</span><a name="LN4553"></a>                <span class='Declare_Local'>new_infomask</span><span class='Delimiter'>, 
</span><a name="LN4554"></a>                <span class='Declare_Local'>new_infomask2</span><span class='Delimiter'>; 
</span><a name="LN4555"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>first_time</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN4556"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_tuple_lock</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN4557"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>cleared_all_frozen</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4545"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4549"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4545"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before locking the buffer, pin the visibility map page if it appears to 
     * be necessary.  Since we haven't got the lock yet, someone else might be 
     * in the middle of changing this, so we'll need to recheck after we have 
     * the lock. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)))</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4549"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4548"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN4547"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4546"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4547"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4545"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4546"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4547"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4546"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4546"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN4581"></a><span class='Label'>l3</span><span class='Operator'>: 
</span>    <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN72"><span class='Ref_to_Proto'>HeapTupleSatisfiesUpdate</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN121"><span class='Ref_to_EnumConst'>HeapTupleInvisible</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is possible, but only when locking a tuple for ON CONFLICT 
         * UPDATE.  We return this value here rather than throwing an error in 
         * order to give that case the opportunity to throw a more specific 
         * error. 
         */ 
</span>        <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN121"><span class='Ref_to_EnumConst'>HeapTupleInvisible</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5170"><span class='Ref_to_Label'>out_locked</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN124"><span class='Ref_to_EnumConst'>HeapTupleBeingUpdated</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN4597"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xwait</span><span class='Delimiter'>; 
</span><a name="LN4598"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>infomask</span><span class='Delimiter'>; 
</span><a name="LN4599"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>infomask2</span><span class='Delimiter'>; 
</span><a name="LN4600"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>require_sleep</span><span class='Delimiter'>; 
</span><a name="LN4601"></a>        <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>t_ctid</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* must copy state data before unlocking buffer */ 
</span>        <a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN4599"><span class='Ref_To_Local'>infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4601"><span class='Ref_To_Local'>t_ctid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If any subtransaction of the current top transaction already holds 
         * a lock as strong as or stronger than what we're requesting, we 
         * effectively hold the desired lock already.  We *must* succeed 
         * without trying to take the tuple lock, else we will deadlock 
         * against anyone wanting to acquire a stronger lock. 
         * 
         * Note we only do this the first time we loop on the HTSU result; 
         * there is no point in testing in subsequent passes, because 
         * evidently our own transaction cannot have acquired a new lock after 
         * the first time we checked. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4555"><span class='Ref_To_Local'>first_time</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN4555"><span class='Ref_To_Local'>first_time</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN4629"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN4630"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN4631"></a>                <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * We don't need to allow old multixacts here; if that had 
                 * been the case, HeapTupleSatisfiesUpdate would have returned 
                 * MayBeUpdated and we wouldn't be here. 
                 */ 
</span>                <a href="heapam.c.html#LN4630"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= 
</span>                    <a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4631"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                          <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4629"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN4629"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN4630"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN4629"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* only consider members of our own transaction */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4631"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN4629"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span> 
                        <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN200"><span class='Ref_to_Macro'>TUPLOCK_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4631"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN4629"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4631"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5173"><span class='Ref_to_Label'>out_unlocked</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4631"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4631"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if infomask&HEAP_XMAX_IS... &raquo; </span> 
            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN40"><span class='Ref_to_EnumConst'>LockTupleKeyShare</span></a><span class='Operator'>: 
</span>                        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN251"><span class='Ref_to_Macro'>HEAP_XMAX_IS_KEYSHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                               <a href="../../../include/access/htup_details.h.html#LN247"><span class='Ref_to_Macro'>HEAP_XMAX_IS_SHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                               <a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5173"><span class='Ref_to_Label'>out_unlocked</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN42"><span class='Ref_to_EnumConst'>LockTupleShare</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN247"><span class='Ref_to_Macro'>HEAP_XMAX_IS_SHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                            <a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>                            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5173"><span class='Ref_to_Label'>out_unlocked</span></a><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>                            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5173"><span class='Ref_to_Label'>out_unlocked</span></a><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                            <a href="heapam.c.html#LN4599"><span class='Ref_To_Local'>infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>)</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>                            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5173"><span class='Ref_to_Label'>out_unlocked</span></a><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch mode &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdIsCurren... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if first_time &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Initially assume that we will have to wait for the locking 
         * transaction(s) to finish.  We check various cases below in which 
         * this can be turned off. 
         */ 
</span>        <a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN40"><span class='Ref_to_EnumConst'>LockTupleKeyShare</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we're requesting KeyShare, and there's no update present, we 
             * don't need to wait.  Even if there is an update, we can still 
             * continue if the key hasn't been modified. 
             * 
             * However, if there are updates, we need to walk the update chain 
             * to mark future versions of the row as locked, too.  That way, 
             * if somebody deletes that future version, we're protected 
             * against the key going away.  This locking of future versions 
             * could block momentarily, if a concurrent transaction is 
             * deleting a key; or it could return a value to the effect that 
             * the transaction deleting the key has already committed.  So we 
             * do this before re-locking the buffer; otherwise this would be 
             * prone to deadlocks. 
             * 
             * Note that the TID we're locking was grabbed before we unlocked 
             * the buffer.  For it to change while we're not looking, the 
             * other properties we're testing for below after re-locking the 
             * buffer would also change, in which case we would restart this 
             * loop above. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4599"><span class='Ref_To_Local'>infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN4727"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>updated</span><span class='Delimiter'>; 
</span> 
                <a href="heapam.c.html#LN4727"><span class='Ref_To_Local'>updated</span></a> <span class='Operator'>= !</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If there are updates, follow the update chain; bail out if 
                 * that cannot be done. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4541"><span class='Ref_to_Parameter'>follow_updates</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN4727"><span class='Ref_To_Local'>updated</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN4737"></a>                    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
                    <a href="heapam.c.html#LN4737"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN109"><span class='Ref_to_Proto'>heap_lock_updated_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4601"><span class='Ref_To_Local'>t_ctid</span></a><span class='Delimiter'>, 
</span>                                                  <a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                                  <a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4737"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4737"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>                        <span class='Comment_Multi_Line'>/* recovery code expects to have buffer lock held */ 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5039"><span class='Ref_to_Label'>failed</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Make sure it's still an appropriate lock, else start over. 
                 * Also, if it wasn't updated before we released the lock, but 
                 * is updated now, we start over too; the reason is that we 
                 * now need to follow the update chain to lock the new 
                 * versions. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tqual.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderIsOnlyLocked</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                    <span class='Parentheses'>((</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                     <span class='Operator'>!</span><a href="heapam.c.html#LN4727"><span class='Ref_To_Local'>updated</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Things look okay, so we can skip sleeping */ 
</span>                <a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Note we allow Xmax to change here; other updaters/lockers 
                 * could have modified it before we grabbed the buffer lock. 
                 * However, this is not a problem, because with the recheck we 
                 * just did we ensure that they still don't conflict with the 
                 * lock we want. 
                 */ 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !(infomask2&HEAP_KEYS... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mode==LockTupleKeySha... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN42"><span class='Ref_to_EnumConst'>LockTupleShare</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we're requesting Share, we can similarly avoid sleeping if 
             * there's no update and no exclusive lock present. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Make sure it's still an appropriate lock, else start over. 
                 * See above about allowing xmax to change. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                    <a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mode==LockTupleShare &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we're requesting NoKeyExclusive, we might also be able to 
             * avoid sleeping; just ensure that there no conflicting lock 
             * already acquired. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN116"><span class='Ref_to_Proto'>DoesMultiXactIdConflict</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, 
</span>                                             <a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * No conflict, but if the xmax changed under us in the 
                     * meantime, start over. 
                     */ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                        <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* otherwise, we're good */ 
</span>                    <a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN251"><span class='Ref_to_Macro'>HEAP_XMAX_IS_KEYSHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* if the xmax changed in the meantime, start over */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                    <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span> 
                                    <a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* otherwise, we're good */ 
</span>                <a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mode==LockTupleNoKeyE... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * As a check independent from those above, we can also avoid sleeping 
         * if the current transaction is the sole locker of the tuple.  Note 
         * that the strength of the lock already held is irrelevant; this is 
         * not about recording the lock in Xmax (which will be done regardless 
         * of this optimization, below).  Also, note that the cases where we 
         * hold a lock stronger than we are requesting are already handled 
         * above by not doing anything. 
         * 
         * Note we only deal with the non-multixact case here; MultiXactIdWait 
         * is well equipped to deal with this situation on its own. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>&& !</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ... but if the xmax changed in the meantime, start over */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Time to sleep on the other transaction/multixact, if necessary. 
         * 
         * If the other transaction is an update that's already committed, 
         * then sleeping cannot possibly do any good: if we're required to 
         * sleep, get out to raise an error instead. 
         * 
         * By here, we either have already acquired the buffer exclusive lock, 
         * or we must wait for the locking transaction or multixact; so below 
         * we ensure that we grab buffer lock after the sleep. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5039"><span class='Ref_to_Label'>failed</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Acquire tuple lock to establish our priority for the tuple, or 
             * die trying.  LockTuple will release us when we are next-in-line 
             * for the tuple.  We must do this even if we are share-locking. 
             * 
             * If we are forced to "start over" below, we keep the tuple lock; 
             * this arranges that we stay at the head of the line while 
             * rechecking tuple state. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN101"><span class='Ref_to_Proto'>heap_acquire_tuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4545"><span class='Ref_To_Local'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>wait_policy</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="heapam.c.html#LN4556"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * This can only happen if wait_policy is Skip and the lock 
                 * couldn't be obtained. 
                 */ 
</span>                <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN125"><span class='Ref_to_EnumConst'>HeapTupleWouldBlock</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* recovery code expects to have buffer lock held */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5039"><span class='Ref_to_Label'>failed</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN4906"></a>                <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>status</span> <span class='Operator'>= </span><a href="heapam.c.html#LN4485"><span class='Ref_to_Func'>get_mxact_status_for_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* We only ever lock tuples, never update them */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4906"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Parentheses'>) 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lock mode in heap_lock_tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* wait for multixact to end, or die trying  */ 
</span>                <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>wait_policy</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Operator'>: 
</span>                        <a href="heapam.c.html#LN118"><span class='Ref_to_Proto'>MultiXactIdWait</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4906"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, 
</span>                                  <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN28"><span class='Ref_to_EnumConst'>XLTW_Lock</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN40"><span class='Ref_to_EnumConst'>LockWaitSkip</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN121"><span class='Ref_to_Proto'>ConditionalMultiXactIdWait</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, 
</span>                                                  <a href="heapam.c.html#LN4906"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN125"><span class='Ref_to_EnumConst'>HeapTupleWouldBlock</span></a><span class='Delimiter'>; 
</span>                            <span class='Comment_Multi_Line'>/* recovery code expects to have buffer lock held */ 
</span>                            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5039"><span class='Ref_to_Label'>failed</span></a><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN42"><span class='Ref_to_EnumConst'>LockWaitError</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN121"><span class='Ref_to_Proto'>ConditionalMultiXactIdWait</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, 
</span>                                                  <a href="heapam.c.html#LN4906"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_LOCK_NOT_AVAILABLE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not obtain lock on row in relation \"%s\""</span><span class='Delimiter'>, 
</span>                                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch wait_policy &raquo; </span> 
 
                <span class='Comment_Multi_Line'>/* 
                 * Of course, the multixact might not be done here: if we're 
                 * requesting a light lock mode, other transactions with light 
                 * locks could still be alive, as well as locks owned by our 
                 * own xact or other subxacts of this backend.  We need to 
                 * preserve the surviving MultiXact members.  Note that it 
                 * isn't absolutely necessary in the latter case, but doing so 
                 * is simpler. 
                 */ 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if infomask&HEAP_XMAX_IS... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* wait for regular transaction to end, or die trying */ 
</span>                <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>wait_policy</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Operator'>: 
</span>                        <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/storage/lmgr.h.html#LN28"><span class='Ref_to_EnumConst'>XLTW_Lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN40"><span class='Ref_to_EnumConst'>LockWaitSkip</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lmgr.h.html#LN75"><span class='Ref_to_Proto'>ConditionalXactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN125"><span class='Ref_to_EnumConst'>HeapTupleWouldBlock</span></a><span class='Delimiter'>; 
</span>                            <span class='Comment_Multi_Line'>/* recovery code expects to have buffer lock held */ 
</span>                            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5039"><span class='Ref_to_Label'>failed</span></a><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN42"><span class='Ref_to_EnumConst'>LockWaitError</span></a><span class='Operator'>: 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lmgr.h.html#LN75"><span class='Ref_to_Proto'>ConditionalXactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_LOCK_NOT_AVAILABLE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not obtain lock on row in relation \"%s\""</span><span class='Delimiter'>, 
</span>                                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch wait_policy &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* if there are updates, follow the update chain */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4541"><span class='Ref_to_Parameter'>follow_updates</span></a> <span class='Operator'>&& !</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN4983"></a>                <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
                <a href="heapam.c.html#LN4983"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN109"><span class='Ref_to_Proto'>heap_lock_updated_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4601"><span class='Ref_To_Local'>t_ctid</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                              <a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4983"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4983"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* recovery code expects to have buffer lock held */ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5039"><span class='Ref_to_Label'>failed</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * xwait is done, but if xwait had just locked the tuple then some 
             * other xact could update this tuple before we get to this point. 
             * Check for xmax change, and start over if so. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN2972"><span class='Ref_to_Func'>xmax_infomask_changed</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4598"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Otherwise check if it committed or aborted.  Note we cannot 
                 * be here if the tuple was only locked by somebody who didn't 
                 * conflict with us; that would have been handled above.  So 
                 * that transaction must necessarily be gone by now.  But 
                 * don't check for this in the multixact case, because some 
                 * locker transactions might still be running. 
                 */ 
</span>                <a href="heapam.c.html#LN2295"><span class='Ref_to_Func'>UpdateXmaxHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4597"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if require_sleep &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* By here, we're certain that we hold buffer exclusive lock again */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We may lock if previous xmax aborted, or if it committed but only 
         * locked the tuple without updating it; or if we didn't have to wait 
         * at all for whatever reason. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN4600"><span class='Ref_To_Local'>require_sleep</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/utils/tqual.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderIsOnlyLocked</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result==HeapTupleBein... &raquo; </span> 
 
<a name="LN5039"></a><span class='Label'>failed</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a> <span class='Operator'>|| 
</span>               <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN125"><span class='Ref_to_EnumConst'>HeapTupleWouldBlock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN69"><span class='Ref_to_Member'>ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN70"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN71"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup.h.html#LN80"><span class='Ref_to_Proto'>HeapTupleHeaderGetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>hufd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam.h.html#LN71"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5170"><span class='Ref_to_Label'>out_locked</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we didn't pin the visibility map page and the page has become all 
     * visible while we were busy locking the buffer, or during some 
     * subsequent window during which we had it unlocked, we'll have to unlock 
     * and re-lock, to avoid holding the buffer lock across I/O.  That's a bit 
     * unfortunate, especially since we'll now have to recheck whether the 
     * tuple has been locked or updated under us, but hopefully it won't 
     * happen very often. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4548"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4547"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4549"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4548"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN4581"><span class='Ref_to_Label'>l3</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN4551"><span class='Ref_To_Local'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4552"><span class='Ref_To_Local'>old_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is the first possibly-multixact-able operation in the current 
     * transaction, set my per-backend OldestMemberMXactId setting. We can be 
     * certain that the transaction will never become a member of any older 
     * MultiXactIds than that.  (We have to do this even if we end up just 
     * using our own TransactionId below, since some other backend could 
     * incorporate our XID into a MultiXact immediately afterwards.) 
     */ 
</span>    <a href="../../../include/access/multixact.h.html#LN111"><span class='Ref_to_Proto'>MultiXactIdSetOldestMember</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the new xmax and infomask to store into the tuple.  Note we do 
     * not modify the tuple just yet, because that would leave it in the wrong 
     * state if multixact.c elogs. 
     */ 
</span>    <a href="heapam.c.html#LN104"><span class='Ref_to_Proto'>compute_new_xmax_infomask</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4551"><span class='Ref_To_Local'>xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4552"><span class='Ref_To_Local'>old_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>, 
</span>                              <a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="heapam.c.html#LN4550"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4553"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN4554"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store transaction information of xact locking the tuple. 
     * 
     * Note: Cmax is meaningless in this context, so don't set it; this avoids 
     * possibly generating a useless combo CID.  Moreover, if we're locking a 
     * previously updated tuple, it's important to preserve the Cmax. 
     * 
     * Also reset the HOT UPDATE bit, but only if there's no update; otherwise 
     * we would break the HOT chain. 
     */ 
</span>    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN4553"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN4554"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4553"><span class='Ref_To_Local'>new_infomask</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/htup_details.h.html#LN496"><span class='Ref_to_Macro'>HeapTupleHeaderClearHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4550"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure there is no forward chain link in t_ctid.  Note that in the 
     * cases where the tuple has been updated, we must not overwrite t_ctid, 
     * because it was set by the updater.  Moreover, if the tuple has been 
     * updated, we need to follow the update chain to lock the new versions of 
     * the tuple as well. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4553"><span class='Ref_To_Local'>new_infomask</span></a><span class='Parentheses'>))</span> 
        <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN4545"><span class='Ref_To_Local'>tid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clear only the all-frozen bit on visibility map if needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4547"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4549"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4548"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>))</span> 
        <a href="heapam.c.html#LN4557"><span class='Ref_To_Local'>cleared_all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XLOG stuff.  You might think that we don't need an XLOG record because 
     * there is no state change worth restoring after a crash.  You would be 
     * wrong however: we have just written either a TransactionId or a 
     * MultiXactId that may never have been seen on disk before, and we need 
     * to make sure that there are XLOG entries covering those ID numbers. 
     * Else the same IDs might be re-used after a crash, which would be 
     * disastrous if this page made it to disk before the crash.  Essentially 
     * we have to enforce the WAL log-before-data rule even in this case. 
     * (Also, in a PITR log-shipping or 2PC environment, we have to have XLOG 
     * entries for everything anyway.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN5146"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN249"><span class='Ref_to_Struct'>xl_heap_lock</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN5147"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN5146"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN252"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5146"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN251"><span class='Ref_to_Member'>locking_xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4550"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5146"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN253"><span class='Ref_to_Member'>infobits_set</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2950"><span class='Ref_to_Func'>compute_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4553"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, 
</span>                                              <a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5146"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN254"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4557"><span class='Ref_To_Local'>cleared_all_frozen</span></a> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN246"><span class='Ref_to_Const'>XLH_LOCK_ALL_FROZEN_CLEARED</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN5146"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN257"><span class='Ref_to_Const'>SizeOfHeapLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we don't decode row locks atm, so no need to log the origin */ 
</span> 
        <a href="heapam.c.html#LN5147"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN37"><span class='Ref_to_Const'>XLOG_HEAP_LOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4547"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5147"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rela... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span> 
<a name="LN5170"></a><span class='Label'>out_locked</span><span class='Operator'>: 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN4542"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN5173"></a><span class='Label'>out_unlocked</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4548"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4548"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't update the visibility map here. Locking a tuple doesn't change 
     * visibility info. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have successfully marked the tuple as locked, we can 
     * release the lmgr tuple lock, if we had it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN4556"><span class='Ref_To_Local'>have_tuple_lock</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN180"><span class='Ref_to_Macro'>UnlockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN4539"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4545"><span class='Ref_To_Local'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN4540"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN4544"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_lock_tuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Acquire heavyweight lock on the given tuple, in preparation for acquiring 
 * its normal, Xmax-based tuple lock. 
 * 
 * have_tuple_lock is an input and output parameter: on input, it indicates 
 * whether the lock has previously been acquired (and this function does 
 * nothing in that case).  If this function returns success, have_tuple_lock 
 * has been flipped to true. 
 * 
 * Returns false if it was unable to obtain the lock; this can only happen if 
 * wait_policy is Skip. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5205"></a><span class='Declare_Function'>heap_acquire_tuplock</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, 
</span><a name="LN5206"></a>                     <a href="../../../include/nodes/lockoptions.h.html#LN35"><span class='Ref_to_Enum'>LockWaitPolicy</span></a> <span class='Declare_Parameter'>wait_policy</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>have_tuple_lock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN5206"><span class='Ref_to_Parameter'>have_tuple_lock</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5206"><span class='Ref_to_Parameter'>wait_policy</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN38"><span class='Ref_to_EnumConst'>LockWaitBlock</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN178"><span class='Ref_to_Macro'>LockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN40"><span class='Ref_to_EnumConst'>LockWaitSkip</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN182"><span class='Ref_to_Macro'>ConditionalLockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/nodes/lockoptions.h.html#LN42"><span class='Ref_to_EnumConst'>LockWaitError</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN182"><span class='Ref_to_Macro'>ConditionalLockTupleTuplock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_LOCK_NOT_AVAILABLE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not obtain lock on row in relation \"%s\""</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5205"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN5206"><span class='Ref_to_Parameter'>have_tuple_lock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_acquire_tuplock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given an original set of Xmax and infomask, and a transaction (identified by 
 * add_to_xmax) acquiring a new lock of some mode, compute the new Xmax and 
 * corresponding infomasks to use on the tuple. 
 * 
 * Note that this might have side effects such as creating a new MultiXactId. 
 * 
 * Most callers will have called HeapTupleSatisfiesUpdate before this function; 
 * that will have set the HEAP_XMAX_INVALID bit if the xmax was a MultiXactId 
 * but it was not running anymore. There is a race condition, which is that the 
 * MultiXactId may have finished since then, but that uncommon case is handled 
 * either here, or within MultiXactIdExpand. 
 * 
 * There is a similar race condition possible when the old xmax was a regular 
 * TransactionId.  We test TransactionIdIsInProgress again just to narrow the 
 * window, but it's still possible to end up creating an unnecessary 
 * MultiXactId.  Fortunately this is harmless. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5254"></a><span class='Declare_Function'>compute_new_xmax_infomask</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xmax</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>old_infomask</span><span class='Delimiter'>, 
</span><a name="LN5255"></a>                          <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>old_infomask2</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>add_to_xmax</span><span class='Delimiter'>, 
</span><a name="LN5256"></a>                          <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_update</span><span class='Delimiter'>, 
</span><a name="LN5257"></a>                          <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result_xmax</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result_infomask</span><span class='Delimiter'>, 
</span><a name="LN5258"></a>                          <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result_infomask2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5260"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>new_xmax</span><span class='Delimiter'>; 
</span><a name="LN5261"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>new_infomask</span><span class='Delimiter'>, 
</span><a name="LN5262"></a>                <span class='Declare_Local'>new_infomask2</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<a name="LN5266"></a><span class='Label'>l5</span><span class='Operator'>: 
</span>    <a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * No previous locker; we just insert our own TransactionId. 
         * 
         * Note that it's critical that this case be the first one checked, 
         * because there are several blocks below that come back to this one 
         * to implement certain optimizations; old_infomask might contain 
         * other dirty bits in those cases, but we don't really care. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>is_update</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN40"><span class='Ref_to_EnumConst'>LockTupleKeyShare</span></a><span class='Operator'>: 
</span>                    <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN178"><span class='Ref_to_Const'>HEAP_XMAX_KEYSHR_LOCK</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN42"><span class='Ref_to_EnumConst'>LockTupleShare</span></a><span class='Operator'>: 
</span>                    <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN184"><span class='Ref_to_Const'>HEAP_XMAX_SHR_LOCK</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Operator'>: 
</span>                    <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN180"><span class='Ref_to_Const'>HEAP_XMAX_EXCL_LOCK</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Operator'>: 
</span>                    <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN180"><span class='Ref_to_Const'>HEAP_XMAX_EXCL_LOCK</span></a><span class='Delimiter'>; 
</span>                    <a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* silence compiler */ 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lock mode"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch mode &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if old_infomask&HEAP_XMA... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5315"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>new_status</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Currently we don't allow XMAX_COMMITTED to be set for multis, so 
         * cross-check. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN191"><span class='Ref_to_Const'>HEAP_XMAX_COMMITTED</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * A multixact together with LOCK_ONLY set but neither lock bit set 
         * (i.e. a pg_upgraded share locked tuple) cannot possibly be running 
         * anymore.  This check is critical for databases upgraded by 
         * pg_upgrade; both MultiXactIdIsRunning and MultiXactIdExpand assume 
         * that such multis are never passed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5266"><span class='Ref_to_Label'>l5</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the XMAX is already a MultiXactId, then we need to expand it to 
         * include add_to_xmax; but if all the members were lockers and are 
         * all gone, we can do away with the IS_MULTI bit and just set 
         * add_to_xmax as the only locker/updater.  If all lockers are gone 
         * and we have an updater that aborted, we can also do without a 
         * multi. 
         * 
         * The cost of doing GetMultiXactIdMembers would be paid by 
         * MultiXactIdExpand if we weren't to do this, so this check is not 
         * incurring extra work anyhow. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN110"><span class='Ref_to_Proto'>MultiXactIdIsRunning</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN114"><span class='Ref_to_Proto'>MultiXactIdGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, 
</span>                                                              <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Reset these bits and restart; otherwise fall through to 
                 * create a new multi below. 
                 */ 
</span>                <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5266"><span class='Ref_to_Label'>l5</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN5315"><span class='Ref_To_Local'>new_status</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4485"><span class='Ref_to_Func'>get_mxact_status_for_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>is_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN104"><span class='Ref_to_Proto'>MultiXactIdExpand</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN5315"><span class='Ref_To_Local'>new_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if old_infomask&HEAP_XMA... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN191"><span class='Ref_to_Const'>HEAP_XMAX_COMMITTED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * It's a committed update, so we need to preserve him as updater of 
         * the tuple. 
         */ 
</span><a name="LN5377"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN5378"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>new_status</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>old_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN5377"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN5377"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN5378"><span class='Ref_To_Local'>new_status</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4485"><span class='Ref_to_Func'>get_mxact_status_for_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>is_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * since it's not running, it's obviously impossible for the old 
         * updater to be identical to the current one, so we need not check 
         * for that case as we do in the block above. 
         */ 
</span>        <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN101"><span class='Ref_to_Proto'>MultiXactIdCreate</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5377"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5378"><span class='Ref_To_Local'>new_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if old_infomask&HEAP_XMA... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If the XMAX is a valid, in-progress TransactionId, then we need to 
         * create a new MultiXactId that includes both the old locker or 
         * updater and our own TransactionId. 
         */ 
</span><a name="LN5402"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>new_status</span><span class='Delimiter'>; 
</span><a name="LN5403"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>old_status</span><span class='Delimiter'>; 
</span><a name="LN5404"></a>        <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Local'>old_mode</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN251"><span class='Ref_to_Macro'>HEAP_XMAX_IS_KEYSHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>))</span> 
                <a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN41"><span class='Ref_to_EnumConst'>MultiXactStatusForKeyShare</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN247"><span class='Ref_to_Macro'>HEAP_XMAX_IS_SHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>))</span> 
                <a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN42"><span class='Ref_to_EnumConst'>MultiXactStatusForShare</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>old_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>                    <a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN44"><span class='Ref_to_EnumConst'>MultiXactStatusForUpdate</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN43"><span class='Ref_to_EnumConst'>MultiXactStatusForNoKeyUpdate</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * LOCK_ONLY can be present alone only when a page has been 
                 * upgraded by pg_upgrade.  But in that case, 
                 * TransactionIdIsInProgress() should have returned false.  We 
                 * assume it's no longer locked in this case. 
                 */ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"LOCK_ONLY found for Xid in progress %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5266"><span class='Ref_to_Label'>l5</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HEAP_XMAX_IS_LOCKED_O... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* it's an update, but which kind? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>old_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN5404"><span class='Ref_To_Local'>old_mode</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN200"><span class='Ref_to_Macro'>TUPLOCK_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the lock to be acquired is for the same TransactionId as the 
         * existing lock, there's an optimization possible: consider only the 
         * strongest of both locks as the only one present, and restart. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Note that it's not possible for the original tuple to be 
             * updated: we wouldn't be here because the tuple would have been 
             * invisible and we wouldn't try to update it.  As a subtlety, 
             * this code can also run when traversing an update chain to lock 
             * future versions of a tuple.  But we wouldn't be here either, 
             * because the add_to_xmax would be different from the original 
             * updater. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* acquire the strongest of both */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN5404"><span class='Ref_To_Local'>old_mode</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5404"><span class='Ref_To_Local'>old_mode</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* mustn't touch is_update */ 
</span> 
            <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5266"><span class='Ref_to_Label'>l5</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if xmax==add_to_xmax &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* otherwise, just fall back to creating a new multixact */ 
</span>        <a href="heapam.c.html#LN5402"><span class='Ref_To_Local'>new_status</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4485"><span class='Ref_to_Func'>get_mxact_status_for_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>is_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN101"><span class='Ref_to_Proto'>MultiXactIdCreate</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5403"><span class='Ref_To_Local'>old_status</span></a><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5402"><span class='Ref_To_Local'>new_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdIsInProg... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>             <a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * It's a committed update, so we gotta preserve him as updater of the 
         * tuple. 
         */ 
</span><a name="LN5484"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN5485"></a>        <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>new_status</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>old_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN5484"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN5484"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN5485"><span class='Ref_To_Local'>new_status</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4485"><span class='Ref_to_Func'>get_mxact_status_for_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5256"><span class='Ref_to_Parameter'>is_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * since it's not running, it's obviously impossible for the old 
         * updater to be identical to the current one, so we need not check 
         * for that case as we do in the block above. 
         */ 
</span>        <a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN101"><span class='Ref_to_Proto'>MultiXactIdCreate</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5484"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5255"><span class='Ref_to_Parameter'>add_to_xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5485"><span class='Ref_To_Local'>new_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !HEAP_XMAX_IS_LOCKED_... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Can get here iff the locking/updating transaction was running when 
         * the infomask was extracted from the tuple, but finished before 
         * TransactionIdIsInProgress got to run.  Deal with it as if there was 
         * no locker at all in the first place. 
         */ 
</span>        <a href="heapam.c.html#LN5254"><span class='Ref_to_Parameter'>old_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5266"><span class='Ref_to_Label'>l5</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="heapam.c.html#LN5257"><span class='Ref_to_Parameter'>result_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5261"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN5258"><span class='Ref_to_Parameter'>result_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5262"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN5257"><span class='Ref_to_Parameter'>result_xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5260"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end compute_new_xmax_infomask &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine for heap_lock_updated_tuple_rec. 
 * 
 * Given a hypothetical multixact status held by the transaction identified 
 * with the given xid, does the current transaction need to wait, fail, or can 
 * it continue if it wanted to acquire a lock of the given mode?  "needwait" 
 * is set to true if waiting is necessary; if it can continue, then 
 * HeapTupleMayBeUpdated is returned.  In case of a conflict, a different 
 * HeapTupleSatisfiesUpdate return code is returned. 
 * 
 * The held status is said to be hypothetical because it might correspond to a 
 * lock held by a single Xid, i.e. not a real MultiXactId; we express it this 
 * way for simplicity of API. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> 
<a name="LN5534"></a><span class='Declare_Function'>test_lockmode_for_conflict</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN5535"></a>                           <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>needwait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5537"></a>    <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>wantedstatus</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="heapam.c.html#LN5535"><span class='Ref_to_Parameter'>needwait</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN5537"><span class='Ref_To_Local'>wantedstatus</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN4485"><span class='Ref_to_Func'>get_mxact_status_for_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5535"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we *must* check TransactionIdIsInProgress before 
     * TransactionIdDidAbort/Commit; see comment at top of tqual.c for an 
     * explanation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Updated by our own transaction? Just return failure.  This 
         * shouldn't normally happen. 
         */ 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN122"><span class='Ref_to_EnumConst'>HeapTupleSelfUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If the locking transaction is running, what we do depends on 
         * whether the lock modes conflict: if they do, then we must wait for 
         * it to finish; otherwise we can fall through to lock this tuple 
         * version without waiting. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN522"><span class='Ref_to_Proto'>DoLockModesConflict</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5537"><span class='Ref_To_Local'>wantedstatus</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN5535"><span class='Ref_to_Parameter'>needwait</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we set needwait above, then this value doesn't matter; 
         * otherwise, this value signals to caller that it's okay to proceed. 
         */ 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdIsInProg... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN162"><span class='Ref_to_Proto'>TransactionIdDidAbort</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The other transaction committed.  If it was only a locker, then the 
         * lock is completely gone now and we can return success; but if it 
         * was an update, then what we do depends on whether the two lock 
         * modes conflict.  If they conflict, then we must report error to 
         * caller. But if they don't, we can fall through to allow the current 
         * transaction to lock the tuple. 
         * 
         * Note: the reason we worry about ISUPDATE here is because as soon as 
         * a transaction ends, all its locks are gone and meaningless, and 
         * thus we can ignore them; whereas its updates persist.  In the 
         * TransactionIdIsInProgress case, above, we don't need to check 
         * because we know the lock is still "alive" and thus a conflict needs 
         * always be checked. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN54"><span class='Ref_to_Macro'>ISUPDATE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN522"><span class='Ref_to_Proto'>DoLockModesConflict</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5534"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5537"><span class='Ref_To_Local'>wantedstatus</span></a><span class='Parentheses'>)))</span> 
            <span class='Comment_Multi_Line'>/* bummer */ 
</span>            <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN123"><span class='Ref_to_EnumConst'>HeapTupleUpdated</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdDidCommi... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Not in progress, not aborted, not committed -- must have crashed */ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end test_lockmode_for_conflict &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Recursive part of heap_lock_updated_tuple 
 * 
 * Fetch the tuple pointed to by tid in rel, and mark it as locked by the given 
 * xid with the given mode; if this tuple is updated, recurse to lock the new 
 * version as well. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> 
<a name="LN5618"></a><span class='Declare_Function'>heap_lock_updated_tuple_rec</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN5619"></a>                            <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5621"></a>    <a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN5622"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>tupid</span><span class='Delimiter'>; 
</span><a name="LN5623"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>mytup</span><span class='Delimiter'>; 
</span><a name="LN5624"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN5625"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>new_infomask</span><span class='Delimiter'>, 
</span><a name="LN5626"></a>                <span class='Declare_Local'>new_infomask2</span><span class='Delimiter'>, 
</span><a name="LN5627"></a>                <span class='Declare_Local'>old_infomask</span><span class='Delimiter'>, 
</span><a name="LN5628"></a>                <span class='Declare_Local'>old_infomask2</span><span class='Delimiter'>; 
</span><a name="LN5629"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmax</span><span class='Delimiter'>, 
</span><a name="LN5630"></a>                <span class='Declare_Local'>new_xmax</span><span class='Delimiter'>; 
</span><a name="LN5631"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>priorXmax</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN5632"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>cleared_all_frozen</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN5633"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN5634"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5622"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN5625"><span class='Ref_To_Local'>new_infomask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5630"><span class='Ref_To_Local'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5634"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN5622"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN5622"><span class='Ref_To_Local'>tupid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/heapam.h.html#LN134"><span class='Ref_to_Proto'>heap_fetch</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/tqual.h.html#LN27"><span class='Ref_to_Const'>SnapshotAny</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * if we fail to find the updated version of the tuple, it's 
             * because it was vacuumed/pruned away after its creator 
             * transaction aborted.  So behave as if we got to the end of the 
             * chain, and there's no further tuple to lock: return success to 
             * caller. 
             */ 
</span>            <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<a name="LN5657"></a><span class='Label'>l4</span><span class='Operator'>: 
</span>        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Before locking the buffer, pin the visibility map page if it 
         * appears to be necessary.  Since we haven't got the lock yet, 
         * someone else might be in the middle of changing this, so we'll need 
         * to recheck after we have the lock. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)))</span> 
            <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5634"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we didn't pin the visibility map page and the page has become 
         * all visible while we were busy locking the buffer, we'll have to 
         * unlock and re-lock, to avoid holding the buffer lock across I/O. 
         * That's a bit unfortunate, but hopefully shouldn't happen often. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5634"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check the tuple XMIN against prior XMAX, if any.  If we reached the 
         * end of the chain, we're done, so return success. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5631"><span class='Ref_To_Local'>priorXmax</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="heapam.c.html#LN5631"><span class='Ref_To_Local'>priorXmax</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5889"><span class='Ref_to_Label'>out_locked</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Also check Xmin: if this tuple was created by an aborted 
         * (sub)transaction, then we already locked the last live one in the 
         * chain, thus we're done, so return success. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN162"><span class='Ref_to_Proto'>TransactionIdDidAbort</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5628"><span class='Ref_To_Local'>old_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5629"><span class='Ref_To_Local'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this tuple version has been updated or locked by some concurrent 
         * transaction(s), what we do depends on whether our lock mode 
         * conflicts with what those other transactions hold, and also on the 
         * status of them. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN5721"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>rawxmax</span><span class='Delimiter'>; 
</span><a name="LN5722"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>needwait</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN5721"><span class='Ref_To_Local'>rawxmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN5727"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN5728"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN5729"></a>                <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * We don't need a test for pg_upgrade'd tuples: this is only 
                 * applied to tuples after the first in an update chain.  Said 
                 * first tuple in the chain may well be locked-in-9.2-and- 
                 * pg_upgraded, but that one was already locked by our caller, 
                 * not us; and any subsequent ones cannot be because our 
                 * caller must necessarily have obtained a snapshot later than 
                 * the pg_upgrade itself. 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="heapam.c.html#LN5727"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5721"><span class='Ref_To_Local'>rawxmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                     <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5728"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN5728"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN5727"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN5728"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5533"><span class='Ref_to_Func'>test_lockmode_for_conflict</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN5728"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>, 
</span>                                                        <a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN5728"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                                                        <a href="heapam.c.html#LN5619"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5722"><span class='Ref_To_Local'>needwait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5722"><span class='Ref_To_Local'>needwait</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN5728"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/storage/lmgr.h.html#LN29"><span class='Ref_to_EnumConst'>XLTW_LockUpdated</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5657"><span class='Ref_to_Label'>l4</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5889"><span class='Ref_to_Label'>out_locked</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nmembers;i++ &raquo; </span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5729"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if old_infomask&HEAP_XMA... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN5770"></a>                <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * For a non-multi Xmax, we first need to compute the 
                 * corresponding MultiXactStatus by using the infomask bits. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN251"><span class='Ref_to_Macro'>HEAP_XMAX_IS_KEYSHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a><span class='Parentheses'>))</span> 
                        <a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN41"><span class='Ref_to_EnumConst'>MultiXactStatusForKeyShare</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN247"><span class='Ref_to_Macro'>HEAP_XMAX_IS_SHR_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a><span class='Parentheses'>))</span> 
                        <a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN42"><span class='Ref_to_EnumConst'>MultiXactStatusForShare</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN249"><span class='Ref_to_Macro'>HEAP_XMAX_IS_EXCL_LOCKED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5628"><span class='Ref_To_Local'>old_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>                            <a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN44"><span class='Ref_to_EnumConst'>MultiXactStatusForUpdate</span></a><span class='Delimiter'>; 
</span>                        <span class='Control'>else</span> 
                            <a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN43"><span class='Ref_to_EnumConst'>MultiXactStatusForNoKeyUpdate</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * LOCK_ONLY present alone (a pg_upgraded tuple marked 
                         * as share-locked in the old cluster) shouldn't be 
                         * seen in the middle of an update chain. 
                         */ 
</span>                        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lock status in tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HEAP_XMAX_IS_LOCKED_O... &raquo; </span> 
                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* it's an update, but which kind? */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5628"><span class='Ref_To_Local'>old_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>                        <a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5533"><span class='Ref_to_Func'>test_lockmode_for_conflict</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5770"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5721"><span class='Ref_To_Local'>rawxmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5619"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Operator'>&</span><a href="heapam.c.html#LN5722"><span class='Ref_To_Local'>needwait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5722"><span class='Ref_To_Local'>needwait</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5721"><span class='Ref_To_Local'>rawxmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/storage/lmgr.h.html#LN29"><span class='Ref_to_EnumConst'>XLTW_LockUpdated</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="heapam.c.html#LN5657"><span class='Ref_to_Label'>l4</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5889"><span class='Ref_to_Label'>out_locked</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !(old_infomask&HEAP_X... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* compute the new Xmax and infomask values for the tuple ... */ 
</span>        <a href="heapam.c.html#LN104"><span class='Ref_to_Proto'>compute_new_xmax_infomask</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5629"><span class='Ref_To_Local'>xmax</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5627"><span class='Ref_To_Local'>old_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>, 
</span>                                  <a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5619"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="heapam.c.html#LN5630"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5625"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5626"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5634"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN5632"><span class='Ref_To_Local'>cleared_all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ... and set them */ 
</span>        <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5630"><span class='Ref_To_Local'>new_xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN5625"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN5626"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5618"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN5848"></a>            <a href="../../../include/access/heapam_xlog.h.html#LN260"><span class='Ref_to_Struct'>xl_heap_lock_updated</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN5849"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN5850"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN5848"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN263"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN5848"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN262"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5630"><span class='Ref_To_Local'>new_xmax</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN5848"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN264"><span class='Ref_to_Member'>infobits_set</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2950"><span class='Ref_to_Func'>compute_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5625"><span class='Ref_To_Local'>new_infomask</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5626"><span class='Ref_To_Local'>new_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN5848"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN265"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= 
</span>                <a href="heapam.c.html#LN5632"><span class='Ref_To_Local'>cleared_all_frozen</span></a> <span class='Operator'>? </span><a href="../../../include/access/heapam_xlog.h.html#LN246"><span class='Ref_to_Const'>XLH_LOCK_ALL_FROZEN_CLEARED</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN5848"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN268"><span class='Ref_to_Const'>SizeOfHeapLockUpdated</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN5849"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN58"><span class='Ref_to_Const'>XLOG_HEAP2_LOCK_UPDATED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5850"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5849"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if we find the end of update chain, we're done. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a> <span class='Operator'>|| 
</span>            <a href="../../storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/utils/tqual.h.html#LN81"><span class='Ref_to_Proto'>HeapTupleHeaderIsOnlyLocked</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="heapam.c.html#LN5889"><span class='Ref_to_Label'>out_locked</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* tail recursion */ 
</span>        <a href="heapam.c.html#LN5631"><span class='Ref_To_Local'>priorXmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN5623"><span class='Ref_To_Local'>mytup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN5622"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
</span> 
<a name="LN5889"></a><span class='Label'>out_locked</span><span class='Operator'>: 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5624"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5633"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN5621"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heap_lock_updated_tuple_rec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_lock_updated_tuple 
 *      Follow update chain when locking an updated tuple, acquiring locks (row 
 *      marks) on the updated versions. 
 * 
 * The initial tuple is assumed to be already locked. 
 * 
 * This function doesn't check visibility, it just unconditionally marks the 
 * tuple(s) as locked.  If any tuple in the updated chain is being deleted 
 * concurrently (or updated with the key being modified), sleep until the 
 * transaction doing it is finished. 
 * 
 * Note that we don't acquire heavyweight tuple locks on the tuples we walk 
 * when we have to wait for other transactions to release them, as opposed to 
 * what heap_lock_tuple does.  The reason is that having more than one 
 * transaction walking the chain is probably uncommon enough that risk of 
 * starvation is not likely: one of the preconditions for being here is that 
 * the snapshot in use predates the update that created this tuple (because we 
 * started at an earlier version of the tuple), but at the same time such a 
 * transaction cannot be using repeatable read or serializable isolation 
 * levels, because that would lead to a serializability failure. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN118"><span class='Ref_to_Typedef'>HTSU_Result</span></a> 
<a name="LN5922"></a><span class='Declare_Function'>heap_lock_updated_tuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ctid</span><span class='Delimiter'>, 
</span><a name="LN5923"></a>                        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../storage/page/itemptr.c.html#LN27"><span class='Ref_to_Func'>ItemPointerEquals</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN5922"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5922"><span class='Ref_to_Parameter'>ctid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If this is the first possibly-multixact-able operation in the 
         * current transaction, set my per-backend OldestMemberMXactId 
         * setting. We can be certain that the transaction will never become a 
         * member of any older MultiXactIds than that.  (We have to do this 
         * even if we end up just using our own TransactionId below, since 
         * some other backend could incorporate our XID into a MultiXact 
         * immediately afterwards.) 
         */ 
</span>        <a href="../../../include/access/multixact.h.html#LN111"><span class='Ref_to_Proto'>MultiXactIdSetOldestMember</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="heapam.c.html#LN5617"><span class='Ref_to_Func'>heap_lock_updated_tuple_rec</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5922"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5922"><span class='Ref_to_Parameter'>ctid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5923"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5923"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* nothing to lock */ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN120"><span class='Ref_to_EnumConst'>HeapTupleMayBeUpdated</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_lock_updated_tuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_finish_speculative - mark speculative insertion as successful 
 * 
 * To successfully finish a speculative insertion we have to clear speculative 
 * token from tuple.  To do so the t_ctid field, which will contain a 
 * speculative token value, is modified in place to point to the tuple itself, 
 * which is characteristic of a newly inserted ordinary tuple. 
 * 
 * NB: It is not ok to commit without either finishing or aborting a 
 * speculative insertion.  We could treat speculative tuples of committed 
 * transactions implicitly as completed, but then we would have to be prepared 
 * to deal with speculative tokens on committed tuples.  That wouldn't be 
 * difficult - no-one looks at the ctid field of a tuple with invalid xmax - 
 * but clearing the token at completion isn't very expensive either. 
 * An explicit confirmation WAL record also makes logical decoding simpler. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN5962"></a><span class='Declare_Function'>heap_finish_speculative</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5964"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN5965"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN5966"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN5967"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN5968"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN5964"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5964"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN5965"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5964"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN5966"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5965"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN5966"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
        <a href="heapam.c.html#LN5967"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5965"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5966"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5965"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN5966"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5967"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN5968"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5965"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN5967"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* SpecTokenOffsetNumber should be distinguishable from any real offset */ 
</span>    <a href="../../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN27"><span class='Ref_to_Const'>MaxOffsetNumber</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/htup_details.h.html#LN284"><span class='Ref_to_Const'>SpecTokenOffsetNumber</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"invalid speculative token constant"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN422"><span class='Ref_to_Macro'>HeapTupleHeaderIsSpeculative</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5964"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Replace the speculative insertion token with a real t_ctid, pointing to 
     * itself like it does on regular tuples. 
     */ 
</span>    <a href="heapam.c.html#LN5968"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN6003"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN271"><span class='Ref_to_Struct'>xl_heap_confirm</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN6004"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN6003"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN273"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN5962"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We want the same filtering on this as on a plain insert */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN42"><span class='Ref_to_Proto'>XLogSetRecordFlags</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN191"><span class='Ref_to_Const'>XLOG_INCLUDE_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN6003"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN276"><span class='Ref_to_Const'>SizeOfHeapConfirm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN5964"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN6004"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN36"><span class='Ref_to_Const'>XLOG_HEAP_CONFIRM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5965"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6004"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN5964"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_finish_speculative &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_abort_speculative - kill a speculatively inserted tuple 
 * 
 * Marks a tuple that was speculatively inserted in the same command as dead, 
 * by setting its xmin as invalid.  That makes it immediately appear as dead 
 * to all transactions, including our own.  In particular, it makes 
 * HeapTupleSatisfiesDirty() regard the tuple as dead, so that another backend 
 * inserting a duplicate key value won't unnecessarily wait for our whole 
 * transaction to finish (it'll just wait for our speculative insertion to 
 * finish). 
 * 
 * Killing the tuple prevents "unprincipled deadlocks", which are deadlocks 
 * that arise due to a mutual dependency that is not user visible.  By 
 * definition, unprincipled deadlocks cannot be prevented by the user 
 * reordering lock acquisition in client code, because the implementation level 
 * lock acquisitions are not under the user's direct control.  If speculative 
 * inserters did not take this precaution, then under high concurrency they 
 * could deadlock with each other, which would not be acceptable. 
 * 
 * This is somewhat redundant with heap_delete, but we prefer to have a 
 * dedicated routine with stripped down requirements.  Note that this is also 
 * used to delete the TOAST tuples created during speculative insertion. 
 * 
 * This routine does not affect logical decoding as it only looks at 
 * confirmation records. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN6053"></a><span class='Declare_Function'>heap_abort_speculative</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6055"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN6056"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>tid</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN6057"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN6058"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tp</span><span class='Delimiter'>; 
</span><a name="LN6059"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN6060"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN6061"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6056"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6060"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6056"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6060"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6059"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Page can't be all visible, we just inserted into it, and are still 
     * running. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6059"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6057"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6059"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6056"><span class='Ref_To_Local'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6057"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6059"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6057"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6057"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= *</span><a href="heapam.c.html#LN6056"><span class='Ref_To_Local'>tid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Sanity check that the tuple really is a speculatively inserted tuple, 
     * inserted by us. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN147"><span class='Ref_to_Member'>t_choice</span></a><span class='Operator'>.</span>t_heap<span class='Operator'>.</span>t_xmin <span class='Operator'>!= </span><a href="heapam.c.html#LN6055"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"attempted to kill a tuple inserted by another transaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN30"><span class='Ref_to_Proto'>IsToastRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/htup_details.h.html#LN422"><span class='Ref_to_Macro'>HeapTupleHeaderIsSpeculative</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"attempted to kill a non-speculative tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN501"><span class='Ref_to_Macro'>HeapTupleHeaderIsHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need to check for serializable conflicts here.  There is never a 
     * need for a combocid, either.  No need to extract replica identity, or 
     * do anything special with infomask bits. 
     */ 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The tuple will become DEAD immediately.  Flag that this page 
     * immediately is a candidate for pruning by setting xmin to 
     * RecentGlobalXmin.  That's not pretty, but it doesn't seem worth 
     * inventing a nicer API for this. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="../../utils/time/snapmgr.c.html#LN165"><span class='Ref_to_Global_Var'>RecentGlobalXmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufpage.h.html#LN394"><span class='Ref_to_Macro'>PageSetPrunable</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6059"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../utils/time/snapmgr.c.html#LN165"><span class='Ref_to_Global_Var'>RecentGlobalXmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* store transaction information of xact deleting the tuple */ 
</span>    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the tuple header xmin to InvalidTransactionId.  This makes the 
     * tuple immediately invisible everyone.  (In particular, to any 
     * transactions waiting on the speculative token, woken up later.) 
     */ 
</span>    <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clear the speculative insertion token too */ 
</span>    <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XLOG stuff 
     * 
     * The WAL records generated here match heap_delete().  The same recovery 
     * routines are used. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN6136"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN101"><span class='Ref_to_Struct'>xl_heap_delete</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN6137"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN6136"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN94"><span class='Ref_to_Const'>XLH_DELETE_IS_SUPER</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6136"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN105"><span class='Ref_to_Member'>infobits_set</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2950"><span class='Ref_to_Func'>compute_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                              <a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6136"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6136"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN103"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6055"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN6136"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN109"><span class='Ref_to_Const'>SizeOfHeapDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No replica identity & replication origin logged */ 
</span> 
        <a href="heapam.c.html#LN6137"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN32"><span class='Ref_to_Const'>XLOG_HEAP_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6059"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6137"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rela... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/catalog/catalog.h.html#LN30"><span class='Ref_to_Proto'>IsToastRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tuptoaster.h.html#LN144"><span class='Ref_to_Proto'>toast_delete</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6058"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Never need to mark tuple for invalidation, since catalogs don't support 
     * speculative insertion 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can release the buffer */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6061"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* count deletion, as we counted the insertion too */ 
</span>    <a href="../../../include/pgstat.h.html#LN1289"><span class='Ref_to_Proto'>pgstat_count_heap_delete</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6053"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_abort_speculative &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_inplace_update - update a tuple "in place" (ie, overwrite it) 
 * 
 * Overwriting violates both MVCC and transactional safety, so the uses 
 * of this function in Postgres are extremely limited.  Nonetheless we 
 * find some places to use it. 
 * 
 * The tuple cannot change size, and therefore it's reasonable to assume 
 * that its null bitmap (if any) doesn't change either.  So we just 
 * overwrite the data portion of the tuple without touching the null 
 * bitmap or any of the header fields. 
 * 
 * tuple is an in-memory tuple structure containing the data to be written 
 * over the target tuple.  Also, tuple-&GT;t_self identifies the target tuple. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN6194"></a><span class='Declare_Function'>heap_inplace_update</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6196"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN6197"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN6198"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN6199"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN6200"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN6201"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>oldlen</span><span class='Delimiter'>; 
</span><a name="LN6202"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newlen</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For now, parallel operations are required to be strictly read-only. 
     * Unlike a regular update, this should never create a combo CID, so it 
     * might be possible to relax this restriction, but not without more 
     * thought and testing.  It's not clear that it would be useful, anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot update tuples during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6196"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6196"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6197"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6196"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6198"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6197"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN6198"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
        <a href="heapam.c.html#LN6199"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6197"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6198"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6197"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN6198"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6199"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6197"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6199"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6201"><span class='Ref_To_Local'>oldlen</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6199"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6202"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6201"><span class='Ref_To_Local'>oldlen</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN6202"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>|| </span><a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong tuple length"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>, 
</span>           <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>, 
</span>           <a href="heapam.c.html#LN6202"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6196"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN6245"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN279"><span class='Ref_to_Struct'>xl_heap_inplace</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN6246"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN6245"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN281"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN6245"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN285"><span class='Ref_to_Const'>SizeOfHeapInplace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN6196"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN6200"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6202"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* inplace updates aren't decoded atm, don't log the origin */ 
</span> 
        <a href="heapam.c.html#LN6246"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN38"><span class='Ref_to_Const'>XLOG_HEAP_INPLACE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6197"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6246"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6196"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Send out shared cache inval if necessary.  Note that because we only 
     * pass the new version of the tuple, this mustn't be used for any 
     * operations that could change catcache lookup keys.  But we aren't 
     * bothering with index updates either, so that's true a fortiori. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/inval.h.html#LN37"><span class='Ref_to_Proto'>CacheInvalidateHeapTuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6194"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_inplace_update &raquo; </span> 
 
<a name="LN6277"></a><span class='Keyword'>#define</span>     <span class='Declare_Constant'>FRM_NOOP</span>                <span class='Number'>0x0001</span> 
<a name="LN6278"></a><span class='Keyword'>#define</span>     <span class='Declare_Constant'>FRM_INVALIDATE_XMAX</span>     <span class='Number'>0x0002</span> 
<a name="LN6279"></a><span class='Keyword'>#define</span>     <span class='Declare_Constant'>FRM_RETURN_IS_XID</span>       <span class='Number'>0x0004</span> 
<a name="LN6280"></a><span class='Keyword'>#define</span>     <span class='Declare_Constant'>FRM_RETURN_IS_MULTI</span>     <span class='Number'>0x0008</span> 
<a name="LN6281"></a><span class='Keyword'>#define</span>     <span class='Declare_Constant'>FRM_MARK_COMMITTED</span>      <span class='Number'>0x0010</span> 
 
<span class='Comment_Multi_Line'>/* 
 * FreezeMultiXactId 
 *      Determine what to do during freezing when a tuple is marked by a 
 *      MultiXactId. 
 * 
 * NB -- this might have the side-effect of creating a new MultiXactId! 
 * 
 * "flags" is an output value; it's used to tell caller what to do on return. 
 * Possible flags are: 
 * FRM_NOOP 
 *      don't do anything -- keep existing Xmax 
 * FRM_INVALIDATE_XMAX 
 *      mark Xmax as InvalidTransactionId and set XMAX_INVALID flag. 
 * FRM_RETURN_IS_XID 
 *      The Xid return value is a single update Xid to set as xmax. 
 * FRM_MARK_COMMITTED 
 *      Xmax can be marked as HEAP_XMAX_COMMITTED 
 * FRM_RETURN_IS_MULTI 
 *      The return value is a new MultiXactId to set as new Xmax. 
 *      (caller must obtain proper infomask bits using GetMultiXactIdHintBits) 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN6305"></a><span class='Declare_Function'>FreezeMultiXactId</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>t_infomask</span><span class='Delimiter'>, 
</span><a name="LN6306"></a>                  <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>cutoff_multi</span><span class='Delimiter'>, 
</span><a name="LN6307"></a>                  <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6309"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN6310"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN6311"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN6312"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN6313"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_replace</span><span class='Delimiter'>; 
</span><a name="LN6314"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nnewmembers</span><span class='Delimiter'>; 
</span><a name="LN6315"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newmembers</span><span class='Delimiter'>; 
</span><a name="LN6316"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_lockers</span><span class='Delimiter'>; 
</span><a name="LN6317"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>update_xid</span><span class='Delimiter'>; 
</span><a name="LN6318"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>update_committed</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We should only be called in Multis */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>t_infomask</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Ensure infomask bits are appropriately set/reset */ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6278"><span class='Ref_to_Const'>FRM_INVALIDATE_XMAX</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6306"><span class='Ref_to_Parameter'>cutoff_multi</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This old multi cannot possibly have members still running.  If it 
         * was a locker only, it can be removed without any further 
         * consideration; but if it contained an update, we might need to 
         * preserve it. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN110"><span class='Ref_to_Proto'>MultiXactIdIsRunning</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>t_infomask</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>t_infomask</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6278"><span class='Ref_to_Const'>FRM_INVALIDATE_XMAX</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* not strictly necessary */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* replace multi by update xid */ 
</span>            <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN114"><span class='Ref_to_Proto'>MultiXactIdGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>t_infomask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* wasn't only a lock, xid needs to be valid */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the xid is older than the cutoff, it has to have aborted, 
             * otherwise the tuple would have gotten pruned away. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6306"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6278"><span class='Ref_to_Const'>FRM_INVALIDATE_XMAX</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* not strictly necessary */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6279"><span class='Ref_to_Const'>FRM_RETURN_IS_XID</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Control'>return</span> <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if MultiXactIdPrecedes(m... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * This multixact might have or might not have members still running, but 
     * we know it's valid and is newer than the cutoff point for multis. 
     * However, some member(s) of it may be below the cutoff for Xids, so we 
     * need to walk the whole members array to figure out what to do, if 
     * anything. 
     */ 
</span> 
    <a href="heapam.c.html#LN6312"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6305"><span class='Ref_to_Parameter'>t_infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6312"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Nothing worth keeping */ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6278"><span class='Ref_to_Const'>FRM_INVALIDATE_XMAX</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* is there anything older than the cutoff? */ 
</span>    <a href="heapam.c.html#LN6313"><span class='Ref_To_Local'>need_replace</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN6312"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6306"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN6313"><span class='Ref_To_Local'>need_replace</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In the simplest case, there is no member older than the cutoff; we can 
     * keep the existing MultiXactId as is. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN6313"><span class='Ref_To_Local'>need_replace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6277"><span class='Ref_to_Const'>FRM_NOOP</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the multi needs to be updated, figure out which members do we need 
     * to keep. 
     */ 
</span>    <a href="heapam.c.html#LN6314"><span class='Ref_To_Local'>nnewmembers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6315"><span class='Ref_To_Local'>newmembers</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="heapam.c.html#LN6312"><span class='Ref_To_Local'>nmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6316"><span class='Ref_To_Local'>has_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6318"><span class='Ref_To_Local'>update_committed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN6312"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Determine whether to keep this member or ignore it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN54"><span class='Ref_to_Macro'>ISUPDATE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN6431"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * It's an update; should we keep it?  If the transaction is known 
             * aborted or crashed then it's okay to ignore it, otherwise not. 
             * Note that an updater older than cutoff_xid cannot possibly be 
             * committed, because HeapTupleSatisfiesVacuum would have returned 
             * HEAPTUPLE_DEAD and we would not be trying to freeze the tuple. 
             * 
             * As with all tuple visibility routines, it's critical to test 
             * TransactionIdIsInProgress before TransactionIdDidCommit, 
             * because of race conditions explained in detail in tqual.c. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6431"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6431"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6431"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6431"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The transaction committed, so we can tell caller to set 
                 * HEAP_XMAX_COMMITTED.  (We can only do this because we know 
                 * the transaction is not running.) 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN6318"><span class='Ref_To_Local'>update_committed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6431"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Not in progress, not committed -- must be aborted or crashed; 
             * we can ignore it. 
             */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Since the tuple wasn't marked HEAPTUPLE_DEAD by vacuum, the 
             * update Xid cannot possibly be older than the xid cutoff. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                   <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6306"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we determined that it's an Xid corresponding to an update 
             * that must be retained, additionally add it to the list of 
             * members of the new Multi, in case we end up using that.  (We 
             * might still decide to use only an update Xid and not a multi, 
             * but it's easier to maintain the list as we walk the old members 
             * list.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Parentheses'>))</span> 
                <a href="heapam.c.html#LN6315"><span class='Ref_To_Local'>newmembers</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6314"><span class='Ref_To_Local'>nnewmembers</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ISUPDATE_from_mxstatu... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We only keep lockers if they are still running */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* running locker cannot possibly be older than the cutoff */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6306"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN6315"><span class='Ref_To_Local'>newmembers</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6314"><span class='Ref_To_Local'>nnewmembers</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6310"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <a href="heapam.c.html#LN6316"><span class='Ref_To_Local'>has_lockers</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nmembers;i++ &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6311"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6314"><span class='Ref_To_Local'>nnewmembers</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* nothing worth keeping!? Tell caller to remove the whole thing */ 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6278"><span class='Ref_to_Const'>FRM_INVALIDATE_XMAX</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="heapam.c.html#LN6316"><span class='Ref_To_Local'>has_lockers</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If there's a single member and it's an update, pass it back alone 
         * without creating a new Multi.  (XXX we could do this when there's a 
         * single remaining locker, too, but that would complicate the API too 
         * much; moreover, the case with the single updater is more 
         * interesting, because those are longer-lived.) 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6314"><span class='Ref_To_Local'>nnewmembers</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6279"><span class='Ref_to_Const'>FRM_RETURN_IS_XID</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6318"><span class='Ref_To_Local'>update_committed</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6281"><span class='Ref_to_Const'>FRM_MARK_COMMITTED</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6317"><span class='Ref_To_Local'>update_xid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Create a new multixact with the surviving members of the previous 
         * one, to set as new Xmax in the tuple. 
         */ 
</span>        <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN106"><span class='Ref_to_Proto'>MultiXactIdCreateFromMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6314"><span class='Ref_To_Local'>nnewmembers</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6315"><span class='Ref_To_Local'>newmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN6307"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6280"><span class='Ref_to_Const'>FRM_RETURN_IS_MULTI</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6315"><span class='Ref_To_Local'>newmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN6309"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreezeMultiXactId &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_prepare_freeze_tuple 
 * 
 * Check to see whether any of the XID fields of a tuple (xmin, xmax, xvac) 
 * are older than the specified cutoff XID and cutoff MultiXactId.  If so, 
 * setup enough state (in the *frz output argument) to later execute and 
 * WAL-log what we would need to do, and return TRUE.  Return FALSE if nothing 
 * is to be changed.  In addition, set *totally_frozen_p to true if the tuple 
 * will be totally frozen after these operations are performed and false if 
 * more freezing will eventually be required. 
 * 
 * Caller is responsible for setting the offset field, if appropriate. 
 * 
 * It is assumed that the caller has checked the tuple with 
 * HeapTupleSatisfiesVacuum() and determined that it is not HEAPTUPLE_DEAD 
 * (else we should be removing the tuple, not freezing it). 
 * 
 * NB: cutoff_xid *must* be &LT;= the current global xmin, to ensure that any 
 * XID older than it could neither be running nor seen as running by any 
 * open transaction.  This ensures that the replacement will not change 
 * anyone's idea of the tuple state. 
 * Similarly, cutoff_multi must be less than or equal to the smallest 
 * MultiXactId used by any transaction currently open. 
 * 
 * If the tuple is in a shared buffer, caller must hold an exclusive lock on 
 * that buffer. 
 * 
 * NB: It is not enough to set hint bits to indicate something is 
 * committed/invalid -- they might not be set on a standby, or after crash 
 * recovery.  We really need to remove old xids. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN6569"></a><span class='Declare_Function'>heap_prepare_freeze_tuple</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, 
</span><a name="LN6570"></a>                          <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_multi</span><span class='Delimiter'>, 
</span><a name="LN6571"></a>                          <a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>frz</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>totally_frozen_p</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6573"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>changed</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN6574"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>freeze_xmax</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN6575"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN6576"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>totally_frozen</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN301"><span class='Ref_to_Member'>frzflags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN299"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN297"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process xmin */ 
</span>    <a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN190"><span class='Ref_to_Const'>HEAP_XMIN_FROZEN</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6573"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN6576"><span class='Ref_To_Local'>totally_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process xmax.  To thoroughly examine the current Xmax value we need to 
     * resolve a MultiXactId to its member Xids, in case some of them are 
     * below the given cutoff for Xids.  In that case, those values might need 
     * freezing, too.  Also, if a multi needs freezing, we cannot simply take 
     * it out --- if there's a live updater Xid, it needs to be kept. 
     * 
     * Make sure to keep heap_tuple_needs_freeze in sync with this. 
     */ 
</span>    <a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN6609"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>newxmax</span><span class='Delimiter'>; 
</span><a name="LN6610"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN6609"><span class='Ref_To_Local'>newxmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6304"><span class='Ref_to_Func'>FreezeMultiXactId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                    <a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6570"><span class='Ref_to_Parameter'>cutoff_multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6610"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6610"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN6278"><span class='Ref_to_Const'>FRM_INVALIDATE_XMAX</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN6574"><span class='Ref_To_Local'>freeze_xmax</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6610"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN6279"><span class='Ref_to_Const'>FRM_RETURN_IS_XID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * NB -- some of these transformations are only valid because we 
             * know the return Xid is a tuple updater (i.e. not merely a 
             * locker.) Also note that the only reason we don't explicitly 
             * worry about HEAP_KEYS_UPDATED is because it lives in 
             * t_infomask2 rather than t_infomask. 
             */ 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN297"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6609"><span class='Ref_To_Local'>newxmax</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6610"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN6281"><span class='Ref_to_Const'>FRM_MARK_COMMITTED</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= </span><a href="../../../include/access/htup_details.h.html#LN191"><span class='Ref_to_Const'>HEAP_XMAX_COMMITTED</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6573"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6576"><span class='Ref_To_Local'>totally_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6610"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN6280"><span class='Ref_to_Const'>FRM_RETURN_IS_MULTI</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN6635"></a>            <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>newbits</span><span class='Delimiter'>; 
</span><a name="LN6636"></a>            <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>newbits2</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We can't use GetMultiXactIdHintBits directly on the new multi 
             * here; that routine initializes the masks to all zeroes, which 
             * would lose other bits we need.  Doing it this way ensures all 
             * unrelated bits remain untouched. 
             */ 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN299"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdHintBits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6609"><span class='Ref_To_Local'>newxmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6635"><span class='Ref_To_Local'>newbits</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6636"><span class='Ref_To_Local'>newbits2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6635"><span class='Ref_To_Local'>newbits</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN299"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= </span><a href="heapam.c.html#LN6636"><span class='Ref_To_Local'>newbits2</span></a><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN297"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6609"><span class='Ref_To_Local'>newxmax</span></a><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN6573"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6576"><span class='Ref_To_Local'>totally_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if flags&FRM_RETURN_IS_M... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6610"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>& </span><a href="heapam.c.html#LN6277"><span class='Ref_to_Const'>FRM_NOOP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tuple-&GT;t_infomask&HEA... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
            <a href="heapam.c.html#LN6574"><span class='Ref_To_Local'>freeze_xmax</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="heapam.c.html#LN6576"><span class='Ref_To_Local'>totally_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6574"><span class='Ref_To_Local'>freeze_xmax</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN297"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The tuple might be marked either XMAX_INVALID or XMAX_COMMITTED + 
         * LOCKED.  Normalize to INVALID just to be sure no one gets confused. 
         * Also get rid of the HEAP_KEYS_UPDATED bit. 
         */ 
</span>        <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN299"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN265"><span class='Ref_to_Const'>HEAP_HOT_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN299"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN6573"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Old-style VACUUM FULL is gone, but we have to keep this code as long as 
     * we support having MOVED_OFF/MOVED_IN tuples in the database. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN408"><span class='Ref_to_Macro'>HeapTupleHeaderGetXvac</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * For Xvac, we ignore the cutoff_xid and just always perform the 
         * freeze operation.  The oldest release in which such a value can 
         * actually be set is PostgreSQL 8.4, because old-style VACUUM FULL 
         * was removed in PostgreSQL 9.0.  Note that if we were to respect 
         * cutoff_xid here, we'd need to make surely to clear totally_frozen 
         * when we skipped freezing on that basis. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6575"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If a MOVED_OFF tuple is not dead, the xvac transaction must 
             * have failed; whereas a non-dead MOVED_IN tuple must mean the 
             * xvac transaction succeeded. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN195"><span class='Ref_to_Const'>HEAP_MOVED_OFF</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN301"><span class='Ref_to_Member'>frzflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN293"><span class='Ref_to_Const'>XLH_INVALID_XVAC</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN301"><span class='Ref_to_Member'>frzflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN292"><span class='Ref_to_Const'>XLH_FREEZE_XVAC</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Might as well fix the hint bits too; usually XMIN_COMMITTED 
             * will already be set here, but there's a small chance not. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6569"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN189"><span class='Ref_to_Const'>HEAP_XMIN_INVALID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN188"><span class='Ref_to_Const'>HEAP_XMIN_COMMITTED</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6573"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdIsNormal... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tuple-&GT;t_infomask&HEA... &raquo; </span> 
 
    <span class='Operator'>*</span><a href="heapam.c.html#LN6571"><span class='Ref_to_Parameter'>totally_frozen_p</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6576"><span class='Ref_To_Local'>totally_frozen</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN6573"><span class='Ref_To_Local'>changed</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_prepare_freeze_tuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_execute_freeze_tuple 
 *      Execute the prepared freezing of a tuple. 
 * 
 * Caller is responsible for ensuring that no other backend can access the 
 * storage underlying this tuple, either by holding an exclusive lock on the 
 * buffer containing it (which is what lazy VACUUM does), or by having it be 
 * in private storage (which is what CLUSTER and friends do). 
 * 
 * Note: it might seem we could make the changes without exclusive lock, since 
 * TransactionId read/write is assumed atomic anyway.  However there is a race 
 * condition: someone who just fetched an old XID that we overwrite here could 
 * conceivably not finish checking the XID against pg_xact before we finish 
 * the VACUUM and perhaps truncate off the part of pg_xact he needs.  Getting 
 * exclusive lock ensures no other backend is in process of checking the 
 * tuple status.  Also, getting exclusive lock makes it safe to adjust the 
 * infomask bits. 
 * 
 * NB: All code in here must be safe to execute during crash recovery! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN6747"></a><span class='Declare_Function'>heap_execute_freeze_tuple</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>frz</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN297"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN301"><span class='Ref_to_Member'>frzflags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN292"><span class='Ref_to_Const'>XLH_FREEZE_XVAC</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN416"><span class='Ref_to_Macro'>HeapTupleHeaderSetXvac</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN32"><span class='Ref_to_Const'>FrozenTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN301"><span class='Ref_to_Member'>frzflags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN293"><span class='Ref_to_Const'>XLH_INVALID_XVAC</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN416"><span class='Ref_to_Macro'>HeapTupleHeaderSetXvac</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN300"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6747"><span class='Ref_to_Parameter'>frz</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN299"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * heap_freeze_tuple 
 *      Freeze tuple in place, without WAL logging. 
 * 
 * Useful for callers like CLUSTER that perform their own WAL logging. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN6768"></a><span class='Declare_Function'>heap_freeze_tuple</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, 
</span><a name="LN6769"></a>                  <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_multi</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6771"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Declare_Local'>frz</span><span class='Delimiter'>; 
</span><a name="LN6772"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>do_freeze</span><span class='Delimiter'>; 
</span><a name="LN6773"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>tuple_totally_frozen</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6772"><span class='Ref_To_Local'>do_freeze</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN391"><span class='Ref_to_Proto'>heap_prepare_freeze_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6768"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6768"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6769"><span class='Ref_to_Parameter'>cutoff_multi</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="heapam.c.html#LN6771"><span class='Ref_To_Local'>frz</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6773"><span class='Ref_To_Local'>tuple_totally_frozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that because this is not a WAL-logged operation, we don't need to 
     * fill in the offset in the freeze record. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6772"><span class='Ref_To_Local'>do_freeze</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/heapam_xlog.h.html#LN396"><span class='Ref_to_Proto'>heap_execute_freeze_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6768"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6771"><span class='Ref_To_Local'>frz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN6772"><span class='Ref_To_Local'>do_freeze</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_freeze_tuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * For a given MultiXactId, return the hint bits that should be set in the 
 * tuple's infomask. 
 * 
 * Normally this should be called for a multixact that was just created, and 
 * so is on our local cache, so the GetMembers call is fast. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6796"></a><span class='Declare_Function'>GetMultiXactIdHintBits</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>new_infomask</span><span class='Delimiter'>, 
</span><a name="LN6797"></a>                       <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>new_infomask2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6799"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN6800"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN6801"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN6802"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>bits</span> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Delimiter'>; 
</span><a name="LN6803"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>bits2</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN6804"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_update</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN6805"></a>    <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Local'>strongest</span> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN40"><span class='Ref_to_EnumConst'>LockTupleKeyShare</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We only use this in multis we just created, so they cannot be values 
     * pre-pg_upgrade. 
     */ 
</span>    <a href="heapam.c.html#LN6799"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6796"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6800"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6801"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN6801"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN6799"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN6801"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN6815"></a>        <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Local'>mode</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Remember the strongest lock mode held by any member of the 
         * multixact. 
         */ 
</span>        <a href="heapam.c.html#LN6815"><span class='Ref_To_Local'>mode</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN200"><span class='Ref_to_Macro'>TUPLOCK_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6800"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6801"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6815"><span class='Ref_To_Local'>mode</span></a> <span class='Operator'>&GT; </span><a href="heapam.c.html#LN6805"><span class='Ref_To_Local'>strongest</span></a><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN6805"><span class='Ref_To_Local'>strongest</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6815"><span class='Ref_To_Local'>mode</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* See what other bits we need */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6800"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6801"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN41"><span class='Ref_to_EnumConst'>MultiXactStatusForKeyShare</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN42"><span class='Ref_to_EnumConst'>MultiXactStatusForShare</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN43"><span class='Ref_to_EnumConst'>MultiXactStatusForNoKeyUpdate</span></a><span class='Operator'>: 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN44"><span class='Ref_to_EnumConst'>MultiXactStatusForUpdate</span></a><span class='Operator'>: 
</span>                <a href="heapam.c.html#LN6803"><span class='Ref_To_Local'>bits2</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Operator'>: 
</span>                <a href="heapam.c.html#LN6804"><span class='Ref_To_Local'>has_update</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Operator'>: 
</span>                <a href="heapam.c.html#LN6803"><span class='Ref_To_Local'>bits2</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN6804"><span class='Ref_To_Local'>has_update</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch members[i].status &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nmembers;i++ &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6805"><span class='Ref_To_Local'>strongest</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a> <span class='Operator'>|| 
</span>        <a href="heapam.c.html#LN6805"><span class='Ref_To_Local'>strongest</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN44"><span class='Ref_to_EnumConst'>LockTupleNoKeyExclusive</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN6802"><span class='Ref_To_Local'>bits</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN180"><span class='Ref_to_Const'>HEAP_XMAX_EXCL_LOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6805"><span class='Ref_To_Local'>strongest</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN42"><span class='Ref_to_EnumConst'>LockTupleShare</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN6802"><span class='Ref_To_Local'>bits</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN184"><span class='Ref_to_Const'>HEAP_XMAX_SHR_LOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6805"><span class='Ref_To_Local'>strongest</span></a> <span class='Operator'>== </span><a href="../../../include/access/heapam.h.html#LN40"><span class='Ref_to_EnumConst'>LockTupleKeyShare</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN6802"><span class='Ref_To_Local'>bits</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN178"><span class='Ref_to_Const'>HEAP_XMAX_KEYSHR_LOCK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN6804"><span class='Ref_To_Local'>has_update</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN6802"><span class='Ref_To_Local'>bits</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6799"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6800"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="heapam.c.html#LN6796"><span class='Ref_to_Parameter'>new_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6802"><span class='Ref_To_Local'>bits</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN6797"><span class='Ref_to_Parameter'>new_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6803"><span class='Ref_To_Local'>bits2</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetMultiXactIdHintBits &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdGetUpdateXid 
 * 
 * Given a multixact Xmax and corresponding infomask, which does not have the 
 * HEAP_XMAX_LOCK_ONLY bit set, obtain and return the Xid of the updating 
 * transaction. 
 * 
 * Caller is expected to check the status of the updating transaction, if 
 * necessary. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN6877"></a><span class='Declare_Function'>MultiXactIdGetUpdateXid</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xmax</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>t_infomask</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6879"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>update_xact</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN6880"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN6881"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6877"><span class='Ref_to_Parameter'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6877"><span class='Ref_to_Parameter'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we know the LOCK_ONLY bit is not set, this cannot be a multi from 
     * pre-pg_upgrade. 
     */ 
</span>    <a href="heapam.c.html#LN6881"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6877"><span class='Ref_to_Parameter'>xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6880"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6881"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN6894"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6894"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN6894"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN6881"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN6894"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Ignore lockers */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN54"><span class='Ref_to_Macro'>ISUPDATE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6880"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6894"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* there can be at most one updater */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN6879"><span class='Ref_To_Local'>update_xact</span></a> <span class='Operator'>== </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN6879"><span class='Ref_To_Local'>update_xact</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6880"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6894"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> USE_ASSERT_CHECKING 
 
            <span class='Comment_Multi_Line'>/* 
             * in an assert-enabled build, walk the whole array to ensure 
             * there's no other updater. 
             */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6880"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nmembers&GT;0 &raquo; </span> 
 
    <span class='Control'>return</span> <a href="heapam.c.html#LN6879"><span class='Ref_To_Local'>update_xact</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdGetUpdateXid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * HeapTupleGetUpdateXid 
 *      As above, but use a HeapTupleHeader 
 * 
 * See also HeapTupleHeaderGetUpdateXid, which can be used without previously 
 * checking the hint bits. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN6929"></a><span class='Declare_Function'>HeapTupleGetUpdateXid</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN114"><span class='Ref_to_Proto'>MultiXactIdGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6929"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="heapam.c.html#LN6929"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Does the given multixact conflict with the current transaction grabbing a 
 * tuple lock of the given strength? 
 * 
 * The passed infomask pairs up with the given multixact in the tuple header. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN6942"></a><span class='Declare_Function'>DoesMultiXactIdConflict</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, 
</span><a name="LN6943"></a>                        <a href="../../../include/access/heapam.h.html#LN37"><span class='Ref_to_Enum'>LockTupleMode</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6945"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN6946"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN6947"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN6948"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>wanted</span> <span class='Operator'>= </span><a href="heapam.c.html#LN145"><span class='Ref_to_Global_Var'>tupleLockExtraInfo</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6943"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="heapam.c.html#LN140"><span class='Ref_to_Member'>hwlock</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6942"><span class='Ref_to_Parameter'>infomask</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN6945"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6942"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN6946"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                     <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6942"><span class='Ref_to_Parameter'>infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6945"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN6957"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN6957"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN6957"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN6945"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN6957"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN6961"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>memxid</span><span class='Delimiter'>; 
</span><a name="LN6962"></a>            <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>memlockmode</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN6962"><span class='Ref_To_Local'>memlockmode</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6946"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6957"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* ignore members that don't conflict with the lock we want */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lock.h.html#LN522"><span class='Ref_to_Proto'>DoLockModesConflict</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6962"><span class='Ref_To_Local'>memlockmode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN6948"><span class='Ref_To_Local'>wanted</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* ignore members from current xact */ 
</span>            <a href="heapam.c.html#LN6961"><span class='Ref_To_Local'>memxid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN6946"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6957"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6961"><span class='Ref_To_Local'>memxid</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN54"><span class='Ref_to_Macro'>ISUPDATE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6946"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN6957"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* ignore aborted updaters */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN162"><span class='Ref_to_Proto'>TransactionIdDidAbort</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6961"><span class='Ref_To_Local'>memxid</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* ignore lockers-only that are no longer in progress */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6961"><span class='Ref_To_Local'>memxid</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Whatever remains are either live lockers that conflict with our 
             * wanted lock, and updaters that are not aborted.  Those conflict 
             * with what we want, so return true. 
             */ 
</span>            <a href="heapam.c.html#LN6947"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nmembers;i++ &raquo; </span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN6946"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nmembers&GT;=0 &raquo; </span> 
 
    <span class='Control'>return</span> <a href="heapam.c.html#LN6947"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DoesMultiXactIdConflict &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Do_MultiXactIdWait 
 *      Actual implementation for the two functions below. 
 * 
 * 'multi', 'status' and 'infomask' indicate what to sleep on (the status is 
 * needed to ensure we only sleep on conflicting members, and the infomask is 
 * used to optimize multixact access in case it's a lock-only multi); 'nowait' 
 * indicates whether to use conditional lock acquisition, to allow callers to 
 * fail if lock is unavailable.  'rel', 'ctid' and 'oper' are used to set up 
 * context information for error messages.  'remaining', if not NULL, receives 
 * the number of members that are still running, including any (non-aborted) 
 * subtransactions of our own transaction. 
 * 
 * We do this by sleeping on each member using XactLockTableWait.  Any 
 * members that belong to the current backend are *not* waited for, however; 
 * this would not merely be useless but would lead to Assert failure inside 
 * XactLockTableWait.  By the time this returns, it is certain that all 
 * transactions *of other backends* that were members of the MultiXactId 
 * that conflict with the requested status are dead (and no new ones can have 
 * been added, since it is not legal to add members to an existing 
 * MultiXactId). 
 * 
 * But by the time we finish sleeping, someone else may have changed the Xmax 
 * of the containing tuple, so the caller needs to iterate on us somehow. 
 * 
 * Note that in case we return false, the number of remaining members is 
 * not to be trusted. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN7031"></a><span class='Declare_Function'>Do_MultiXactIdWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Delimiter'>, 
</span><a name="LN7032"></a>                   <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Delimiter'>, 
</span><a name="LN7033"></a>                   <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ctid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN23"><span class='Ref_to_Enum'>XLTW_Oper</span></a> <span class='Declare_Parameter'>oper</span><span class='Delimiter'>, 
</span><a name="LN7034"></a>                   <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>remaining</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7036"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN7037"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN7038"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN7039"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>remain</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* for pre-pg_upgrade tuples, no need to sleep at all */ 
</span>    <a href="heapam.c.html#LN7038"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7032"><span class='Ref_to_Parameter'>infomask</span></a><span class='Parentheses'>) </span><span class='Operator'>? -</span><span class='Number'>1</span> <span class='Operator'>: 
</span>        <a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7031"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7037"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7032"><span class='Ref_to_Parameter'>infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7038"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN7048"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7048"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN7048"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN7038"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN7048"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN7052"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>memxid</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7037"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7048"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span><a name="LN7053"></a>            <a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Local'>memstatus</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7037"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7048"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7052"><span class='Ref_To_Local'>memxid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="heapam.c.html#LN7039"><span class='Ref_To_Local'>remain</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lock.h.html#LN522"><span class='Ref_to_Proto'>DoLockModesConflict</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7053"><span class='Ref_To_Local'>memstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="heapam.c.html#LN170"><span class='Ref_to_Macro'>LOCKMODE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7031"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7034"><span class='Ref_to_Parameter'>remaining</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7052"><span class='Ref_To_Local'>memxid</span></a><span class='Parentheses'>))</span> 
                    <a href="heapam.c.html#LN7039"><span class='Ref_To_Local'>remain</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * This member conflicts with our multi, so we have to sleep (or 
             * return failure, if asked to avoid waiting.) 
             * 
             * Note that we don't set up an error context callback ourselves, 
             * but instead we pass the info down to XactLockTableWait.  This 
             * might seem a bit wasteful because the context is set up and 
             * tore down for each member of the multixact, but in reality it 
             * should be barely noticeable, and it avoids duplicate code. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7032"><span class='Ref_to_Parameter'>nowait</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="heapam.c.html#LN7036"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lmgr.h.html#LN75"><span class='Ref_to_Proto'>ConditionalXactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7052"><span class='Ref_To_Local'>memxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN7036"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7052"><span class='Ref_To_Local'>memxid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7033"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7033"><span class='Ref_to_Parameter'>ctid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7033"><span class='Ref_to_Parameter'>oper</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nmembers;i++ &raquo; </span> 
 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7037"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nmembers&GT;=0 &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7034"><span class='Ref_to_Parameter'>remaining</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN7034"><span class='Ref_to_Parameter'>remaining</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7039"><span class='Ref_To_Local'>remain</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7036"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end Do_MultiXactIdWait &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdWait 
 *      Sleep on a MultiXactId. 
 * 
 * By the time we finish sleeping, someone else may have changed the Xmax 
 * of the containing tuple, so the caller needs to iterate on us somehow. 
 * 
 * We return (in *remaining, if not NULL) the number of members that are still 
 * running, including any (non-aborted) subtransactions of our own transaction. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN7109"></a><span class='Declare_Function'>MultiXactIdWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, 
</span><a name="LN7110"></a>                <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ctid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN23"><span class='Ref_to_Enum'>XLTW_Oper</span></a> <span class='Declare_Parameter'>oper</span><span class='Delimiter'>, 
</span><a name="LN7111"></a>                <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>remaining</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7030"><span class='Ref_to_Func'>Do_MultiXactIdWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7109"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7109"><span class='Ref_to_Parameter'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7109"><span class='Ref_to_Parameter'>infomask</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN7110"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7110"><span class='Ref_to_Parameter'>ctid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7110"><span class='Ref_to_Parameter'>oper</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7111"><span class='Ref_to_Parameter'>remaining</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ConditionalMultiXactIdWait 
 *      As above, but only lock if we can get the lock without blocking. 
 * 
 * By the time we finish sleeping, someone else may have changed the Xmax 
 * of the containing tuple, so the caller needs to iterate on us somehow. 
 * 
 * If the multixact is now all gone, return true.  Returns false if some 
 * transactions might still be running. 
 * 
 * We return (in *remaining, if not NULL) the number of members that are still 
 * running, including any (non-aborted) subtransactions of our own transaction. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN7131"></a><span class='Declare_Function'>ConditionalMultiXactIdWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Delimiter'>, 
</span><a name="LN7132"></a>                           <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>remaining</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="heapam.c.html#LN7030"><span class='Ref_to_Func'>Do_MultiXactIdWait</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7131"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7131"><span class='Ref_to_Parameter'>status</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7132"><span class='Ref_to_Parameter'>infomask</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN7132"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN25"><span class='Ref_to_EnumConst'>XLTW_None</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7132"><span class='Ref_to_Parameter'>remaining</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * heap_tuple_needs_eventual_freeze 
 * 
 * Check to see whether any of the XID fields of a tuple (xmin, xmax, xvac) 
 * will eventually require freezing.  Similar to heap_tuple_needs_freeze, 
 * but there's no cutoff, since we're trying to figure out whether freezing 
 * will ever be needed, not whether it's needed now. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN7147"></a><span class='Declare_Function'>heap_tuple_needs_eventual_freeze</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7149"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If xmin is a normal transaction ID, this tuple is definitely not 
     * frozen. 
     */ 
</span>    <a href="heapam.c.html#LN7149"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7147"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7149"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If xmax is a valid xact or multixact, this tuple is also not frozen. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7147"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN7164"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multi</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN7164"><span class='Ref_To_Local'>multi</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7147"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7164"><span class='Ref_To_Local'>multi</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN7149"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7147"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7149"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7147"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN7149"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN408"><span class='Ref_to_Macro'>HeapTupleHeaderGetXvac</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7147"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7149"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_tuple_needs_eventual_freeze &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_tuple_needs_freeze 
 * 
 * Check to see whether any of the XID fields of a tuple (xmin, xmax, xvac) 
 * are older than the specified cutoff XID or MultiXactId.  If so, return TRUE. 
 * 
 * It doesn't matter whether the tuple is alive or dead, we are checking 
 * to see if a tuple needs to be removed or frozen to avoid wraparound. 
 * 
 * NB: Cannot rely on hint bits here, they might not be set after a crash or 
 * on a standby. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN7200"></a><span class='Declare_Function'>heap_tuple_needs_freeze</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, 
</span><a name="LN7201"></a>                        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>cutoff_multi</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7203"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The considerations for multixacts are complicated; look at 
     * heap_prepare_freeze_tuple for justifications.  This routine had better 
     * be in sync with that one! 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN7217"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multi</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN7217"><span class='Ref_To_Local'>multi</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7217"><span class='Ref_To_Local'>multi</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* no xmax set, ignore */ 
</span>            <span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN237"><span class='Ref_to_Macro'>HEAP_LOCKED_UPGRADED</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7217"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7201"><span class='Ref_to_Parameter'>cutoff_multi</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN7231"></a>            <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN7232"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN7233"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* need to check whether any member of the mxact is too old */ 
</span> 
            <a href="heapam.c.html#LN7232"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7217"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7231"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN7233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN7232"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN7233"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7231"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7233"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7231"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7232"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7231"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tuple-&GT;t_infomask&HEA... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN408"><span class='Ref_to_Macro'>HeapTupleHeaderGetXvac</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7203"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7200"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_tuple_needs_freeze &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * If 'tuple' contains any visible XID greater than latestRemovedXid, 
 * ratchet forwards latestRemovedXid to the greatest one found. 
 * This is used as the basis for generating Hot Standby conflicts, so 
 * if a tuple was never visible then removing it should not conflict 
 * with queries. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN7279"></a><span class='Declare_Function'>HeapTupleHeaderAdvanceLatestRemovedXid</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, 
</span><a name="LN7280"></a>                                       <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latestRemovedXid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7282"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmin</span> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7279"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7283"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmax</span> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN358"><span class='Ref_to_Macro'>HeapTupleHeaderGetUpdateXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7279"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7284"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xvac</span> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN408"><span class='Ref_to_Macro'>HeapTupleHeaderGetXvac</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7279"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7279"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="heapam.c.html#LN7280"><span class='Ref_to_Parameter'>latestRemovedXid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7284"><span class='Ref_To_Local'>xvac</span></a><span class='Parentheses'>))</span> 
            <span class='Operator'>*</span><a href="heapam.c.html#LN7280"><span class='Ref_to_Parameter'>latestRemovedXid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7284"><span class='Ref_To_Local'>xvac</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ignore tuples inserted by an aborted transaction or if the tuple was 
     * updated/deleted by the inserting transaction. 
     * 
     * Look for a committed hint bit, or if no xmin bit is set, check clog. 
     * This needs to work on both master and standby, where it is used to 
     * assess btree delete records. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN317"><span class='Ref_to_Macro'>HeapTupleHeaderXminCommitted</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7279"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN322"><span class='Ref_to_Macro'>HeapTupleHeaderXminInvalid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7279"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7282"><span class='Ref_To_Local'>xmin</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7283"><span class='Ref_To_Local'>xmax</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN7282"><span class='Ref_To_Local'>xmin</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7283"><span class='Ref_To_Local'>xmax</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="heapam.c.html#LN7280"><span class='Ref_to_Parameter'>latestRemovedXid</span></a><span class='Parentheses'>))</span> 
            <span class='Operator'>*</span><a href="heapam.c.html#LN7280"><span class='Ref_to_Parameter'>latestRemovedXid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7283"><span class='Ref_To_Local'>xmax</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* *latestRemovedXid may still be invalid at end */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end HeapTupleHeaderAdvanceLatestRemovedXid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform XLogInsert to register a heap cleanup info message. These 
 * messages are sent once per VACUUM and are required because 
 * of the phasing of removal operations during a lazy VACUUM. 
 * see comments for vacuum_log_cleanup_info(). 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN7318"></a><span class='Declare_Function'>log_heap_cleanup_info</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>latestRemovedXid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7320"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN230"><span class='Ref_to_Struct'>xl_heap_cleanup_info</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN7321"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7320"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN232"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7318"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7320"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN233"><span class='Ref_to_Member'>latestRemovedXid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7318"><span class='Ref_to_Parameter'>latestRemovedXid</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7320"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN236"><span class='Ref_to_Const'>SizeOfHeapCleanupInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7321"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN55"><span class='Ref_to_Const'>XLOG_HEAP2_CLEANUP_INFO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7321"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Perform XLogInsert for a heap-clean operation.  Caller must already 
 * have modified the buffer and marked it dirty. 
 * 
 * Note: prior to Postgres 8.3, the entries in the nowunused[] array were 
 * zero-based tuple indexes.  Now they are one-based like other uses 
 * of OffsetNumber. 
 * 
 * We also include latestRemovedXid, which is the greatest XID present in 
 * the removed tuples. That allows recovery processing to cancel or wait 
 * for long standby queries that can still see these tuples. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN7347"></a><span class='Declare_Function'>log_heap_clean</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN7348"></a>               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>redirected</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nredirected</span><span class='Delimiter'>, 
</span><a name="LN7349"></a>               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nowdead</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ndead</span><span class='Delimiter'>, 
</span><a name="LN7350"></a>               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nowunused</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nunused</span><span class='Delimiter'>, 
</span><a name="LN7351"></a>               <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>latestRemovedXid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7353"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN215"><span class='Ref_to_Struct'>xl_heap_clean</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN7354"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Caller should not call me on a non-WAL-logged relation */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7347"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7353"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN217"><span class='Ref_to_Member'>latestRemovedXid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7351"><span class='Ref_to_Parameter'>latestRemovedXid</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7353"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN218"><span class='Ref_to_Member'>nredirected</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7348"><span class='Ref_to_Parameter'>nredirected</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7353"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN219"><span class='Ref_to_Member'>ndead</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7349"><span class='Ref_to_Parameter'>ndead</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7353"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN223"><span class='Ref_to_Const'>SizeOfHeapClean</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN7347"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The OffsetNumber arrays are not actually in the buffer, but we pretend 
     * that they are.  When XLogInsert stores the whole buffer, the offset 
     * arrays need not be stored too.  Note that even if all three arrays are 
     * empty, we want to expose the buffer as a candidate for whole-page 
     * storage, since this record type implies a defragmentation operation 
     * even if no item pointers changed state. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7348"><span class='Ref_to_Parameter'>nredirected</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7348"><span class='Ref_to_Parameter'>redirected</span></a><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN7348"><span class='Ref_to_Parameter'>nredirected</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7349"><span class='Ref_to_Parameter'>ndead</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7349"><span class='Ref_to_Parameter'>nowdead</span></a><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN7349"><span class='Ref_to_Parameter'>ndead</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7350"><span class='Ref_to_Parameter'>nunused</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7350"><span class='Ref_to_Parameter'>nowunused</span></a><span class='Delimiter'>, 
</span>                            <a href="heapam.c.html#LN7350"><span class='Ref_to_Parameter'>nunused</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7354"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN53"><span class='Ref_to_Const'>XLOG_HEAP2_CLEAN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7354"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end log_heap_clean &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform XLogInsert for a heap-freeze operation.  Caller must have already 
 * modified the buffer and marked it dirty. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN7398"></a><span class='Declare_Function'>log_heap_freeze</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, 
</span><a name="LN7399"></a>                <a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuples</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntuples</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7401"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN310"><span class='Ref_to_Struct'>xl_heap_freeze_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN7402"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Caller should not call me on a non-WAL-logged relation */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7398"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* nor when there are no tuples to freeze */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7399"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7401"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN312"><span class='Ref_to_Member'>cutoff_xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7398"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7401"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN313"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7399"><span class='Ref_to_Parameter'>ntuples</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7401"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN316"><span class='Ref_to_Const'>SizeOfHeapFreezePage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The freeze plan array is not actually in the buffer, but pretend that 
     * it is.  When XLogInsert stores the whole buffer, the freeze plan need 
     * not be stored too. 
     */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN7398"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7399"><span class='Ref_to_Parameter'>tuples</span></a><span class='Delimiter'>, 
</span>                        <a href="heapam.c.html#LN7399"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7402"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN54"><span class='Ref_to_Const'>XLOG_HEAP2_FREEZE_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7402"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end log_heap_freeze &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform XLogInsert for a heap-visible operation.  'block' is the block 
 * being marked all-visible, and vm_buffer is the buffer containing the 
 * corresponding visibility map block.  Both should have already been modified 
 * and dirtied. 
 * 
 * If checksums are enabled, we also generate a full-page image of 
 * heap_buffer, if necessary. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN7439"></a><span class='Declare_Function'>log_heap_visible</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>heap_buffer</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>vm_buffer</span><span class='Delimiter'>, 
</span><a name="LN7440"></a>                 <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>vmflags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7442"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN324"><span class='Ref_to_Struct'>xl_heap_visible</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN7443"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN7444"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7439"><span class='Ref_to_Parameter'>heap_buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7439"><span class='Ref_to_Parameter'>vm_buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7442"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN326"><span class='Ref_to_Member'>cutoff_xid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7440"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7442"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN327"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7440"><span class='Ref_to_Parameter'>vmflags</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7442"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN330"><span class='Ref_to_Const'>SizeOfHeapVisible</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN7439"><span class='Ref_to_Parameter'>vm_buffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7444"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlog.h.html#LN155"><span class='Ref_to_Macro'>XLogHintBitIsNeeded</span></a><span class='Parentheses'>())</span> 
        <a href="heapam.c.html#LN7444"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN30"><span class='Ref_to_Const'>REGBUF_NO_IMAGE</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN7439"><span class='Ref_to_Parameter'>heap_buffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7444"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7443"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN56"><span class='Ref_to_Const'>XLOG_HEAP2_VISIBLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7443"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end log_heap_visible &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform XLogInsert for a heap-update operation.  Caller must already 
 * have modified the buffer(s) and marked them dirty. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN7471"></a><span class='Declare_Function'>log_heap_update</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>oldbuf</span><span class='Delimiter'>, 
</span><a name="LN7472"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>newbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, 
</span><a name="LN7473"></a>                <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_key_tuple</span><span class='Delimiter'>, 
</span><a name="LN7474"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>all_visible_cleared</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>new_all_visible_cleared</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7476"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN187"><span class='Ref_to_Struct'>xl_heap_update</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN7477"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN119"><span class='Ref_to_Struct'>xl_heap_header</span></a> <span class='Declare_Local'>xlhdr</span><span class='Delimiter'>; 
</span><a name="LN7478"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN119"><span class='Ref_to_Struct'>xl_heap_header</span></a> <span class='Declare_Local'>xlhdr_idx</span><span class='Delimiter'>; 
</span><a name="LN7479"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span><a name="LN7480"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>prefix_suffix</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN7481"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>prefixlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN7482"></a>                <span class='Declare_Local'>suffixlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN7483"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN7484"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7485"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_tuple_data</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN575"><span class='Ref_to_Macro'>RelationIsLogicallyLogged</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7471"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7486"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>init</span><span class='Delimiter'>; 
</span><a name="LN7487"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bufflags</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Caller should not call me on a non-WAL-logged relation */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7471"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN685"><span class='Ref_to_Macro'>HeapTupleIsHeapOnly</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>))</span> 
        <a href="heapam.c.html#LN7479"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN35"><span class='Ref_to_Const'>XLOG_HEAP_HOT_UPDATE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN7479"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN33"><span class='Ref_to_Const'>XLOG_HEAP_UPDATE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the old and new tuple are on the same page, we only need to log the 
     * parts of the new tuple that were changed.  That saves on the amount of 
     * WAL we need to write.  Currently, we just count any unchanged bytes in 
     * the beginning and end of the tuple.  That's quick to check, and 
     * perfectly covers the common case that only one field is updated. 
     * 
     * We could do this even if the old and new tuple are on different pages, 
     * but only if we don't make a full-page image of the old page, which is 
     * difficult to know in advance.  Also, if the old tuple is corrupt for 
     * some reason, it would allow the corruption to propagate the new page, 
     * so it seems best to avoid.  Under the general assumption that most 
     * updates tend to create the new tuple version on the same page, there 
     * isn't much to be gained by doing this across pages anyway. 
     * 
     * Skip this if we're taking a full-page image of the new page, as we 
     * don't include the new tuple in the WAL record in that case.  Also 
     * disable if wal_level='logical', as logical decoding needs to be able to 
     * read the new tuple in whole from the WAL record alone. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7471"><span class='Ref_to_Parameter'>oldbuf</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newbuf</span></a> <span class='Operator'>&& !</span><a href="heapam.c.html#LN7485"><span class='Ref_To_Local'>need_tuple_data</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/access/xloginsert.h.html#LN52"><span class='Ref_to_Proto'>XLogCheckBufferNeedsBackup</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN7522"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>oldp</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span><a name="LN7523"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>newp</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span><a name="LN7524"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>oldlen</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span><a name="LN7525"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>newlen</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check for common prefix between old and new tuple */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&LT; </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7524"><span class='Ref_To_Local'>oldlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7525"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7523"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="heapam.c.html#LN7522"><span class='Ref_To_Local'>oldp</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Storing the length of the prefix takes 2 bytes, so we need to save 
         * at least 3 bytes or there's no point. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Same for suffix */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&LT; </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7524"><span class='Ref_To_Local'>oldlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7525"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7523"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7525"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="heapam.c.html#LN7522"><span class='Ref_To_Local'>oldp</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7524"><span class='Ref_To_Local'>oldlen</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>            <a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldbuf==newbuf&&!need... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Prepare main WAL data chain */ 
</span>    <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7474"><span class='Ref_to_Parameter'>all_visible_cleared</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN74"><span class='Ref_to_Const'>XLH_UPDATE_OLD_ALL_VISIBLE_CLEARED</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7474"><span class='Ref_to_Parameter'>new_all_visible_cleared</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN76"><span class='Ref_to_Const'>XLH_UPDATE_NEW_ALL_VISIBLE_CLEARED</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN80"><span class='Ref_to_Const'>XLH_UPDATE_PREFIX_FROM_OLD</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN81"><span class='Ref_to_Const'>XLH_UPDATE_SUFFIX_FROM_OLD</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7485"><span class='Ref_To_Local'>need_tuple_data</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN79"><span class='Ref_to_Const'>XLH_UPDATE_CONTAINS_NEW_TUPLE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7471"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relreplident <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN178"><span class='Ref_to_Const'>REPLICA_IDENTITY_FULL</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN77"><span class='Ref_to_Const'>XLH_UPDATE_CONTAINS_OLD_TUPLE</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN78"><span class='Ref_to_Const'>XLH_UPDATE_CONTAINS_OLD_KEY</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If new tuple is the single and first tuple on page... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& 
</span>        <a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7484"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN7479"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>|= </span><a href="../../../include/access/heapam_xlog.h.html#LN45"><span class='Ref_to_Const'>XLOG_HEAP_INIT_PAGE</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7486"><span class='Ref_To_Local'>init</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN7486"><span class='Ref_To_Local'>init</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare WAL data for the old page */ 
</span>    <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN190"><span class='Ref_to_Member'>old_offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN189"><span class='Ref_to_Member'>old_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN191"><span class='Ref_to_Member'>old_infobits_set</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN2950"><span class='Ref_to_Func'>compute_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                              <a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare WAL data for the new page */ 
</span>    <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN194"><span class='Ref_to_Member'>new_offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN193"><span class='Ref_to_Member'>new_xmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN368"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7487"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7486"><span class='Ref_To_Local'>init</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN7487"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7485"><span class='Ref_To_Local'>need_tuple_data</span></a><span class='Parentheses'>) 
</span>        <a href="heapam.c.html#LN7487"><span class='Ref_To_Local'>bufflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN37"><span class='Ref_to_Const'>REGBUF_KEEP_DATA</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newbuf</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7487"><span class='Ref_To_Local'>bufflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7471"><span class='Ref_to_Parameter'>oldbuf</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newbuf</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN7471"><span class='Ref_to_Parameter'>oldbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7476"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN202"><span class='Ref_to_Const'>SizeOfHeapUpdate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare WAL data for the new tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN7480"><span class='Ref_To_Local'>prefix_suffix</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN7480"><span class='Ref_To_Local'>prefix_suffix</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7480"><span class='Ref_To_Local'>prefix_suffix</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN7477"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN121"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7477"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN122"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7477"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&LT;= </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * PG73FORMAT: write bitmap [+ padding] [+ oid] + data 
     * 
     * The 'data' doesn't include the common prefix or suffix. 
     */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7477"><span class='Ref_To_Local'>xlhdr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                          <a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Have to write the null bitmap and data after the common prefix as 
         * two separate rdata entries. 
         */ 
</span>        <span class='Comment_Multi_Line'>/* bitmap [+ padding] [+ oid] */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                           <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                             <a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* data after common prefix */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, 
</span>              <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>, 
</span>             <a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7472"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7481"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7482"><span class='Ref_To_Local'>suffixlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* We need to log a tuple identity */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7485"><span class='Ref_To_Local'>need_tuple_data</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* don't really need this, but its more comfy to decode */ 
</span>        <a href="heapam.c.html#LN7478"><span class='Ref_To_Local'>xlhdr_idx</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN121"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7478"><span class='Ref_To_Local'>xlhdr_idx</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN122"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7478"><span class='Ref_To_Local'>xlhdr_idx</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7478"><span class='Ref_To_Local'>xlhdr_idx</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* PG73FORMAT: write bitmap [+ padding] [+ oid] + data */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                         <a href="heapam.c.html#LN7473"><span class='Ref_to_Parameter'>old_key_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* filtering by origin on a row level is much more efficient */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN42"><span class='Ref_to_Proto'>XLogSetRecordFlags</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN191"><span class='Ref_to_Const'>XLOG_INCLUDE_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7483"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP_ID<span class='Delimiter'>, </span><a href="heapam.c.html#LN7479"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7483"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end log_heap_update &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform XLogInsert of an XLOG_HEAP2_NEW_CID record 
 * 
 * This is only used in wal_level &GT;= WAL_LEVEL_LOGICAL, and only for catalog 
 * tuples. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN7693"></a><span class='Declare_Function'>log_heap_new_cid</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7695"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN332"><span class='Ref_to_Struct'>xl_heap_new_cid</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
<a name="LN7697"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN7698"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>hdr</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7693"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN7693"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7693"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN338"><span class='Ref_to_Member'>top_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN331"><span class='Ref_to_Proto'>GetTopTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN352"><span class='Ref_to_Member'>target_node</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7693"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN353"><span class='Ref_to_Member'>target_tid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7693"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the tuple got inserted & deleted in the same TX we definitely have a 
     * combocid, set cmin and cmax. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN179"><span class='Ref_to_Const'>HEAP_COMBOCID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN322"><span class='Ref_to_Macro'>HeapTupleHeaderXminInvalid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup.h.html#LN79"><span class='Ref_to_Proto'>HeapTupleHeaderGetCmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup.h.html#LN80"><span class='Ref_to_Proto'>HeapTupleHeaderGetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN347"><span class='Ref_to_Member'>combocid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN384"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawCommandId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* No combocid, so only cmin or cmax can be set by this TX */ 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Tuple inserted. 
         * 
         * We need to check for LOCK ONLY because multixacts might be 
         * transferred to the new tuple in case of FOR KEY SHARE updates in 
         * which case there will be an xmax, although the tuple just got 
         * inserted. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a> <span class='Operator'>|| 
</span>            <a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN384"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawCommandId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* Tuple from a different tx updated or deleted. */ 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN384"><span class='Ref_to_Macro'>HeapTupleHeaderGetRawCommandId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7698"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Delimiter'>} 
</span>        <a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN347"><span class='Ref_to_Member'>combocid</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Note that we don't need to register the buffer here, because this 
     * operation does not modify the page. The insert/update/delete that 
     * called us certainly did, but that's WAL-logged separately. 
     */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN7695"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN356"><span class='Ref_to_Const'>SizeOfHeapNewCid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* will be looked at irrespective of origin */ 
</span> 
    <a href="heapam.c.html#LN7697"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_HEAP2_ID<span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN59"><span class='Ref_to_Const'>XLOG_HEAP2_NEW_CID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7697"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end log_heap_new_cid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build a heap tuple representing the configured REPLICA IDENTITY to represent 
 * the old tuple in a UPDATE or DELETE. 
 * 
 * Returns NULL if there's no need to log an identity or if there's no suitable 
 * key in the Relation relation. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN7769"></a><span class='Declare_Function'>ExtractReplicaIdentity</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tp</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>key_changed</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>copy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7771"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>desc</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7772"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>replidindex</span><span class='Delimiter'>; 
</span><a name="LN7773"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>idx_rel</span><span class='Delimiter'>; 
</span><a name="LN7774"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>idx_desc</span><span class='Delimiter'>; 
</span><a name="LN7775"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>replident</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relreplident<span class='Delimiter'>; 
</span><a name="LN7776"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>key_tuple</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN7777"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN7778"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN7779"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natt</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>copy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN575"><span class='Ref_to_Macro'>RelationIsLogicallyLogged</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7775"><span class='Ref_To_Local'>replident</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN176"><span class='Ref_to_Const'>REPLICA_IDENTITY_NOTHING</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7775"><span class='Ref_To_Local'>replident</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN178"><span class='Ref_to_Const'>REPLICA_IDENTITY_FULL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * When logging the entire old tuple, it very well could contain 
         * toasted columns. If so, force them to be inlined. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>tp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>copy</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>tp</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN183"><span class='Ref_to_Proto'>toast_flatten_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>tp</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>tp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* if the key hasn't changed and we're only logging the key, we're done */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>key_changed</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* find the replica identity index */ 
</span>    <a href="heapam.c.html#LN7772"><span class='Ref_To_Local'>replidindex</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN44"><span class='Ref_to_Proto'>RelationGetReplicaIndex</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7772"><span class='Ref_To_Local'>replidindex</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"could not find configured replica identity for table \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN7773"><span class='Ref_To_Local'>idx_rel</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN33"><span class='Ref_to_Proto'>RelationIdGetRelation</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7772"><span class='Ref_To_Local'>replidindex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN7774"><span class='Ref_To_Local'>idx_desc</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7773"><span class='Ref_To_Local'>idx_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* deform tuple, so we have fast access to columns */ 
</span>    <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>tp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7771"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7778"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7777"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set all columns to NULL, regardless of whether they actually are */ 
</span>    memset<span class='Parentheses'>(</span><a href="heapam.c.html#LN7777"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7777"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now set all columns contained in the index to NOT NULL, they cannot 
     * currently be NULL. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7779"><span class='Ref_To_Local'>natt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN7779"><span class='Ref_To_Local'>natt</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN7774"><span class='Ref_To_Local'>idx_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN7779"><span class='Ref_To_Local'>natt</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN7831"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>attno</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7773"><span class='Ref_To_Local'>idx_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN158"><span class='Ref_to_Member'>rd_index</span></a><span class='Operator'>-&GT;</span>indkey<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="heapam.c.html#LN7779"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7831"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The OID column can appear in an index definition, but that's 
             * OK, because we always copy the OID if present (see below). 
             * Other system columns may not. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7831"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>== </span><a href="../../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"system column in index"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="heapam.c.html#LN7777"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN7831"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heapam.c.html#LN7776"><span class='Ref_To_Local'>key_tuple</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7771"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7778"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7777"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>copy</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relcache.h.html#LN34"><span class='Ref_to_Proto'>RelationClose</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7773"><span class='Ref_To_Local'>idx_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Always copy oids if the table has them, even if not included in the 
     * index. The space in the logged tuple is used anyway, so there's little 
     * point in not including the information. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasoids<span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN697"><span class='Ref_to_Macro'>HeapTupleSetOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7776"><span class='Ref_To_Local'>key_tuple</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>tp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the tuple, which by here only contains indexed columns, still has 
     * toasted columns, force them to be inlined. This is somewhat unlikely 
     * since there's limits on the size of indexed columns, so we don't 
     * duplicate toast_flatten_tuple()s functionality in the above loop over 
     * the indexed columns, even if it would be more efficient. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN673"><span class='Ref_to_Macro'>HeapTupleHasExternal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7776"><span class='Ref_To_Local'>key_tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN7868"></a>        <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>oldtup</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7776"><span class='Ref_To_Local'>key_tuple</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN7776"><span class='Ref_To_Local'>key_tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN183"><span class='Ref_to_Proto'>toast_flatten_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7868"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7769"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7868"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="heapam.c.html#LN7776"><span class='Ref_To_Local'>key_tuple</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExtractReplicaIdentity &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handles CLEANUP_INFO 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN7881"></a><span class='Declare_Function'>heap_xlog_cleanup_info</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7883"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN230"><span class='Ref_to_Struct'>xl_heap_cleanup_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN230"><span class='Ref_to_Struct'>xl_heap_cleanup_info</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7881"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/standby.h.html#LN29"><span class='Ref_to_Proto'>ResolveRecoveryConflictWithSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7883"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN233"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7883"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN232"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Actual operation is a no-op. Record type exists to provide a means for 
     * conflict processing to occur before we begin index vacuum actions. see 
     * vacuumlazy.c and also comments in btvacuumpage() 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Backup blocks are not used in cleanup_info records */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlogreader.h.html#LN221"><span class='Ref_to_Macro'>XLogRecHasAnyBlockRefs</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7881"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handles HEAP2_CLEAN record type 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN7902"></a><span class='Declare_Function'>heap_xlog_clean</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7904"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7902"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN7905"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN215"><span class='Ref_to_Struct'>xl_heap_clean</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN215"><span class='Ref_to_Struct'>xl_heap_clean</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7902"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7906"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN7907"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN7908"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN7909"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN7910"></a>    <a href="../../../include/access/xlogutils.h.html#LN26"><span class='Ref_to_Typedef'>XLogRedoAction</span></a> <span class='Declare_Local'>action</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7902"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7908"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7909"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We're about to remove tuples. In Hot Standby mode, ensure that there's 
     * no queries running for which the removed tuples are still visible. 
     * 
     * Not all HEAP2_CLEAN records remove tuples with xids, so we only want to 
     * conflict on the records that cause MVCC failures for user queries. If 
     * latestRemovedXid is invalid, skip conflict processing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a> <span class='Operator'>&& </span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7905"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN217"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/standby.h.html#LN29"><span class='Ref_to_Proto'>ResolveRecoveryConflictWithSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7905"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN217"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7908"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we have a full-page image, restore it (using a cleanup lock) and 
     * we're done. 
     */ 
</span>    <a href="heapam.c.html#LN7910"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN38"><span class='Ref_to_Proto'>XLogReadBufferForRedoExtended</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7902"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="heapam.c.html#LN7906"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7910"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN7933"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7906"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7934"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>end</span><span class='Delimiter'>; 
</span><a name="LN7935"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>redirected</span><span class='Delimiter'>; 
</span><a name="LN7936"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nowdead</span><span class='Delimiter'>; 
</span><a name="LN7937"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nowunused</span><span class='Delimiter'>; 
</span><a name="LN7938"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nredirected</span><span class='Delimiter'>; 
</span><a name="LN7939"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ndead</span><span class='Delimiter'>; 
</span><a name="LN7940"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nunused</span><span class='Delimiter'>; 
</span><a name="LN7941"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>datalen</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN7935"><span class='Ref_To_Local'>redirected</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN230"><span class='Ref_to_Proto'>XLogRecGetBlockData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7902"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7941"><span class='Ref_To_Local'>datalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN7938"><span class='Ref_To_Local'>nredirected</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7905"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN218"><span class='Ref_to_Member'>nredirected</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7939"><span class='Ref_To_Local'>ndead</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7905"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN219"><span class='Ref_to_Member'>ndead</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7934"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN7935"><span class='Ref_To_Local'>redirected</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7941"><span class='Ref_To_Local'>datalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7936"><span class='Ref_To_Local'>nowdead</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7935"><span class='Ref_To_Local'>redirected</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7938"><span class='Ref_To_Local'>nredirected</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7937"><span class='Ref_To_Local'>nowunused</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN7936"><span class='Ref_To_Local'>nowdead</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN7939"><span class='Ref_To_Local'>ndead</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN7940"><span class='Ref_To_Local'>nunused</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7934"><span class='Ref_To_Local'>end</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN7937"><span class='Ref_To_Local'>nowunused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN7940"><span class='Ref_To_Local'>nunused</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update all item pointers per the record, and repair fragmentation */ 
</span>        <a href="../../../include/access/heapam.h.html#LN188"><span class='Ref_to_Proto'>heap_page_prune_execute</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7906"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN7935"><span class='Ref_To_Local'>redirected</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7938"><span class='Ref_To_Local'>nredirected</span></a><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN7936"><span class='Ref_To_Local'>nowdead</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7939"><span class='Ref_To_Local'>ndead</span></a><span class='Delimiter'>, 
</span>                                <a href="heapam.c.html#LN7937"><span class='Ref_To_Local'>nowunused</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7940"><span class='Ref_To_Local'>nunused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN7907"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7933"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* needed to update FSM below */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note: we don't worry about updating the page's prunability hints. 
         * At worst this will cause an extra prune cycle to occur soon. 
         */ 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7933"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7904"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7906"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if action==BLK_NEEDS_RED... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7906"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7906"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update the FSM as well. 
     * 
     * XXX: Don't do this if the page was restored from full page image. We 
     * don't bother to update the FSM in that case, it doesn't need to be 
     * totally accurate anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7910"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/freespace.h.html#LN29"><span class='Ref_to_Proto'>XLogRecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7908"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7909"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7907"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_clean &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Replay XLOG_HEAP2_VISIBLE record. 
 * 
 * The critical integrity requirement here is that we must never end up with 
 * a situation where the visibility map bit is set, and the page-level 
 * PD_ALL_VISIBLE bit is clear.  If that were to occur, then a subsequent 
 * page modification would fail to clear the visibility map bit. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN7992"></a><span class='Declare_Function'>heap_xlog_visible</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN7994"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN7992"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN7995"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN324"><span class='Ref_to_Struct'>xl_heap_visible</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN324"><span class='Ref_to_Struct'>xl_heap_visible</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7992"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN7996"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN7997"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN7998"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN7999"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN8000"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN8001"></a>    <a href="../../../include/access/xlogutils.h.html#LN26"><span class='Ref_to_Typedef'>XLogRedoAction</span></a> <span class='Declare_Local'>action</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7992"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7999"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8000"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there are any Hot Standby transactions running that have an xmin 
     * horizon old enough that this page isn't all-visible for them, they 
     * might incorrectly decide that an index-only scan can skip a heap fetch. 
     * 
     * NB: It might be better to throw some kind of "soft" conflict here that 
     * forces any index-only scan that is in flight to perform heap fetches, 
     * rather than killing the transaction outright. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/standby.h.html#LN29"><span class='Ref_to_Proto'>ResolveRecoveryConflictWithSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7995"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN326"><span class='Ref_to_Member'>cutoff_xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7999"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the heap page, if it still exists. If the heap file has dropped or 
     * truncated later in recovery, we don't need to update the page, but we'd 
     * better still update the visibility map. 
     */ 
</span>    <a href="heapam.c.html#LN8001"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7992"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7997"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8001"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We don't bump the LSN of the heap page when setting the visibility 
         * map bit (unless checksums or wal_hint_bits is enabled, in which 
         * case we must), because that would generate an unworkable volume of 
         * full-page writes.  This exposes us to torn page hazards, but since 
         * we're not inspecting the existing page contents in any way, we 
         * don't care. 
         * 
         * However, all operations that clear the visibility map bit *do* bump 
         * the LSN, and those operations will only be replayed if the XLOG LSN 
         * follows the page LSN.  Thus, if the page LSN has advanced past our 
         * XLOG record's LSN, we mustn't mark the page all-visible, because 
         * the subsequent update won't be replayed to clear the flag. 
         */ 
</span>        <a href="heapam.c.html#LN7998"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7997"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN383"><span class='Ref_to_Macro'>PageSetAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7998"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7997"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if action==BLK_NEEDS_RED... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8001"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN30"><span class='Ref_to_EnumConst'>BLK_RESTORED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If heap block was backed up, we already restored it and there's 
         * nothing more to do. (This can only happen with checksums or 
         * wal_log_hints enabled.) 
         */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7997"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7997"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Even if we skipped the heap page update due to the LSN interlock, it's 
     * still safe to update the visibility map.  Any WAL record that clears 
     * the visibility map bit does so before checking the page LSN, so any 
     * bits that need to be cleared will still be cleared. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN38"><span class='Ref_to_Proto'>XLogReadBufferForRedoExtended</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7992"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN44"><span class='Ref_to_EnumConst'>RBM_ZERO_ON_ERROR</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN8065"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>vmpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8066"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* initialize the page if it was read as zeros */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8065"><span class='Ref_To_Local'>vmpage</span></a><span class='Parentheses'>))</span> 
            <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8065"><span class='Ref_To_Local'>vmpage</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * XLogReadBufferForRedoExtended locked the buffer. But 
         * visibilitymap_set will handle locking itself. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8066"><span class='Ref_To_Local'>reln</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7999"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8066"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8000"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Don't set the bit if replay has already passed this point. 
         * 
         * It might be safe to do this unconditionally; if replay has passed 
         * this point, we'll replay at least as far this time as we did 
         * before, and if this bit needs to be cleared, the record responsible 
         * for doing so should be again replayed, and clear it.  For right 
         * now, out of an abundance of conservatism, we use the same test here 
         * we did for the heap page.  If this results in a dropped bit, no 
         * real harm is done; and the next VACUUM will fix it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN7994"><span class='Ref_To_Local'>lsn</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8065"><span class='Ref_To_Local'>vmpage</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/visibilitymap.h.html#LN41"><span class='Ref_to_Proto'>visibilitymap_set</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8066"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8000"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7994"><span class='Ref_To_Local'>lsn</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, 
</span>                              <a href="heapam.c.html#LN7995"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN326"><span class='Ref_to_Member'>cutoff_xid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN7995"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN327"><span class='Ref_to_Member'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8066"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN7996"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_visible &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Replay XLOG_HEAP2_FREEZE_PAGE records 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN8107"></a><span class='Declare_Function'>heap_xlog_freeze_page</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8109"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8107"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8110"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN310"><span class='Ref_to_Struct'>xl_heap_freeze_page</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN310"><span class='Ref_to_Struct'>xl_heap_freeze_page</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8107"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8111"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>cutoff_xid</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8110"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN312"><span class='Ref_to_Member'>cutoff_xid</span></a><span class='Delimiter'>; 
</span><a name="LN8112"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8113"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ntup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In Hot Standby mode, ensure that there's no queries running which still 
     * consider the frozen xids as running. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8121"></a>        <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN8122"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latestRemovedXid</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8111"><span class='Ref_To_Local'>cutoff_xid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/transam.h.html#LN55"><span class='Ref_to_Macro'>TransactionIdRetreat</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8122"><span class='Ref_To_Local'>latestRemovedXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8107"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8121"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/standby.h.html#LN29"><span class='Ref_to_Proto'>ResolveRecoveryConflictWithSnapshot</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8122"><span class='Ref_To_Local'>latestRemovedXid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8121"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8107"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8112"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN8132"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8112"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8133"></a>        <a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tuples</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8133"><span class='Ref_To_Local'>tuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN230"><span class='Ref_to_Proto'>XLogRecGetBlockData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8107"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* now execute freeze plan for each frozen tuple */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8113"><span class='Ref_To_Local'>ntup</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN8113"><span class='Ref_To_Local'>ntup</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN8110"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN313"><span class='Ref_to_Member'>ntuples</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN8113"><span class='Ref_To_Local'>ntup</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN8140"></a>            <a href="../../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec_tp</span><span class='Delimiter'>; 
</span><a name="LN8141"></a>            <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN8142"></a>            <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN8140"><span class='Ref_To_Local'>xlrec_tp</span></a> <span class='Operator'>= &</span><a href="heapam.c.html#LN8133"><span class='Ref_To_Local'>tuples</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN8113"><span class='Ref_To_Local'>ntup</span></a><span class='Delimiter'>]; 
</span>            <a href="heapam.c.html#LN8141"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8132"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8140"><span class='Ref_To_Local'>xlrec_tp</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN298"><span class='Ref_to_Member'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* offsets are one-based */ 
</span>            <a href="heapam.c.html#LN8142"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8132"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8141"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam_xlog.h.html#LN396"><span class='Ref_to_Proto'>heap_execute_freeze_tuple</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8142"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8140"><span class='Ref_To_Local'>xlrec_tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8132"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8109"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8112"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8112"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8112"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_freeze_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given an "infobits" field from an XLog record, set the correct bits in the 
 * given infomask and infomask2 for the tuple touched by the record. 
 * 
 * (This is the reverse of compute_infobits). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN8165"></a><span class='Declare_Function'>fix_infomask_from_infobits</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>infobits</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>infomask</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>infomask2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a> <span class='Operator'>| 
</span>                   <a href="../../../include/access/htup_details.h.html#LN178"><span class='Ref_to_Const'>HEAP_XMAX_KEYSHR_LOCK</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN180"><span class='Ref_to_Const'>HEAP_XMAX_EXCL_LOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infobits</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN239"><span class='Ref_to_Const'>XLHL_XMAX_IS_MULTI</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN193"><span class='Ref_to_Const'>HEAP_XMAX_IS_MULTI</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infobits</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN240"><span class='Ref_to_Const'>XLHL_XMAX_LOCK_ONLY</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN181"><span class='Ref_to_Const'>HEAP_XMAX_LOCK_ONLY</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infobits</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN241"><span class='Ref_to_Const'>XLHL_XMAX_EXCL_LOCK</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN180"><span class='Ref_to_Const'>HEAP_XMAX_EXCL_LOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* note HEAP_XMAX_SHR_LOCK isn't considered here */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infobits</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN242"><span class='Ref_to_Const'>XLHL_XMAX_KEYSHR_LOCK</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN178"><span class='Ref_to_Const'>HEAP_XMAX_KEYSHR_LOCK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infobits</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN243"><span class='Ref_to_Const'>XLHL_KEYS_UPDATED</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heapam.c.html#LN8165"><span class='Ref_to_Parameter'>infomask2</span></a> <span class='Operator'>|= </span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fix_infomask_from_infobits &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN8186"></a><span class='Declare_Function'>heap_xlog_delete</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8188"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8186"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8189"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN101"><span class='Ref_to_Struct'>xl_heap_delete</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN101"><span class='Ref_to_Struct'>xl_heap_delete</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8186"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8190"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8191"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN8192"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN8193"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN8194"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN8195"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>target_node</span><span class='Delimiter'>; 
</span><a name="LN8196"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>target_tid</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8186"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8195"><span class='Ref_To_Local'>target_node</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8194"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN114"><span class='Ref_to_Macro'>ItemPointerSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8196"><span class='Ref_To_Local'>target_tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8194"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8196"><span class='Ref_To_Local'>target_tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN91"><span class='Ref_to_Const'>XLH_DELETE_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8208"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8195"><span class='Ref_To_Local'>target_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8209"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8208"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8194"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8209"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8208"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8194"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8209"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8209"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8208"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8186"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8190"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8190"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="heapam.c.html#LN8192"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8192"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8192"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN496"><span class='Ref_to_Macro'>HeapTupleHeaderClearHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8164"><span class='Ref_to_Func'>fix_infomask_from_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN105"><span class='Ref_to_Member'>infobits_set</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN94"><span class='Ref_to_Const'>XLH_DELETE_IS_SUPER</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN103"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN398"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark the page as a candidate for pruning */ 
</span>        <a href="../../../include/storage/bufpage.h.html#LN394"><span class='Ref_to_Macro'>PageSetPrunable</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8186"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8189"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN106"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN91"><span class='Ref_to_Const'>XLH_DELETE_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Make sure there is no forward chain link in t_ctid */ 
</span>        <a href="heapam.c.html#LN8193"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8196"><span class='Ref_To_Local'>target_tid</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8191"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8188"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8190"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8190"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8190"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_delete &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN8256"></a><span class='Declare_Function'>heap_xlog_insert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8258"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8259"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN129"><span class='Ref_to_Struct'>xl_heap_insert</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN129"><span class='Ref_to_Struct'>xl_heap_insert</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8260"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8261"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN8264"></a>        <a href="../../../include/access/htup_details.h.html#LN141"><span class='Ref_to_Struct'>HeapTupleHeaderData</span></a> <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span><a name="LN8265"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>data</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Delimiter'>]; 
</span><a name="LN8266"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>tbuf</span><span class='Delimiter'>; 
</span><a name="LN8267"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN8268"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN119"><span class='Ref_to_Struct'>xl_heap_header</span></a> <span class='Declare_Local'>xlhdr</span><span class='Delimiter'>; 
</span><a name="LN8269"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newlen</span><span class='Delimiter'>; 
</span><a name="LN8270"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN8271"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>target_node</span><span class='Delimiter'>; 
</span><a name="LN8272"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN8273"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>target_tid</span><span class='Delimiter'>; 
</span><a name="LN8274"></a>    <a href="../../../include/access/xlogutils.h.html#LN26"><span class='Ref_to_Typedef'>XLogRedoAction</span></a> <span class='Declare_Local'>action</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8271"><span class='Ref_To_Local'>target_node</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8272"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN114"><span class='Ref_to_Macro'>ItemPointerSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8273"><span class='Ref_To_Local'>target_tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8272"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8273"><span class='Ref_To_Local'>target_tid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8259"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN131"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8259"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN132"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN65"><span class='Ref_to_Const'>XLH_INSERT_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8286"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8271"><span class='Ref_To_Local'>target_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8287"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8286"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8272"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8287"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8286"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8272"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8287"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8287"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8286"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we inserted the first and only tuple on the page, re-initialize the 
     * page from scratch. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN45"><span class='Ref_to_Const'>XLOG_HEAP_INIT_PAGE</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN37"><span class='Ref_to_Proto'>XLogInitBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8274"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN8274"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8274"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8310"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>datalen</span><span class='Delimiter'>; 
</span><a name="LN8311"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN8259"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN131"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid max offset number"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8311"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN230"><span class='Ref_to_Proto'>XLogRecGetBlockData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8310"><span class='Ref_To_Local'>datalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8269"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8310"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>- </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8310"><span class='Ref_To_Local'>datalen</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN8269"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN8268"><span class='Ref_To_Local'>xlhdr</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8311"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8311"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= &</span><a href="heapam.c.html#LN8266"><span class='Ref_To_Local'>tbuf</span></a><span class='Operator'>.</span><a href="heapam.c.html#LN8264"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* PG73FORMAT: get bitmap [+ padding] [+ oid] + data */ 
</span>        memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>               <a href="heapam.c.html#LN8311"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, 
</span>               <a href="heapam.c.html#LN8269"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8269"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>+= </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8268"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN121"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8268"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN122"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8268"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8256"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN390"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8273"><span class='Ref_To_Local'>target_tid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN8267"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8269"><span class='Ref_To_Local'>newlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8259"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN131"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>, 
</span>                        <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8270"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* needed to update FSM below */ 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8258"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8259"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN132"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN65"><span class='Ref_to_Const'>XLH_INSERT_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8261"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if action==BLK_NEEDS_RED... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8260"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page is running low on free space, update the FSM as well. 
     * Arbitrarily, our definition of "low" is less than 20%. We can't do much 
     * better than that without knowing the fill-factor for the table. 
     * 
     * XXX: Don't do this if the page was restored from full page image. We 
     * don't bother to update the FSM in that case, it doesn't need to be 
     * totally accurate anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8274"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN8270"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>&LT; </span>BLCKSZ <span class='Operator'>/ </span><span class='Number'>5</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/freespace.h.html#LN29"><span class='Ref_to_Proto'>XLogRecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8271"><span class='Ref_To_Local'>target_node</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8272"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8270"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handles MULTI_INSERT record type. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN8372"></a><span class='Declare_Function'>heap_xlog_multi_insert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8374"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8375"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN150"><span class='Ref_to_Struct'>xl_heap_multi_insert</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN8376"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN8377"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN8378"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8379"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN8382"></a>        <a href="../../../include/access/htup_details.h.html#LN141"><span class='Ref_to_Struct'>HeapTupleHeaderData</span></a> <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span><a name="LN8383"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>data</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Delimiter'>]; 
</span><a name="LN8384"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>tbuf</span><span class='Delimiter'>; 
</span><a name="LN8385"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN8386"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newlen</span><span class='Delimiter'>; 
</span><a name="LN8387"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN8388"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN8389"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isinit</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN45"><span class='Ref_to_Const'>XLOG_HEAP_INIT_PAGE</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN8390"></a>    <a href="../../../include/access/xlogutils.h.html#LN26"><span class='Ref_to_Typedef'>XLogRedoAction</span></a> <span class='Declare_Local'>action</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insertion doesn't overwrite MVCC data, so no conflict processing is 
     * required. 
     */ 
</span>    <a href="heapam.c.html#LN8375"><span class='Ref_To_Local'>xlrec</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN150"><span class='Ref_to_Struct'>xl_heap_multi_insert</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8376"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8377"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8375"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN152"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN65"><span class='Ref_to_Const'>XLH_INSERT_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8406"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8376"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8407"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8406"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8377"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8407"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8406"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8377"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8407"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8407"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8406"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8389"><span class='Ref_To_Local'>isinit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN37"><span class='Ref_to_Proto'>XLogInitBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8390"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN8390"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8390"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8426"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tupdata</span><span class='Delimiter'>; 
</span><a name="LN8427"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>endptr</span><span class='Delimiter'>; 
</span><a name="LN8428"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Tuples are stored as block data */ 
</span>        <a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN230"><span class='Ref_to_Proto'>XLogRecGetBlockData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8428"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8427"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8428"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8388"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN8388"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN8375"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN153"><span class='Ref_to_Member'>ntuples</span></a><span class='Delimiter'>; </span><a href="heapam.c.html#LN8388"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN8438"></a>            <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN8439"></a>            <a href="../../../include/access/heapam_xlog.h.html#LN159"><span class='Ref_to_Struct'>xl_multi_insert_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlhdr</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we're reinitializing the page, the tuples are stored in 
             * order from FirstOffsetNumber. Otherwise there's an array of 
             * offsets in the WAL record, and the tuples come after that. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8389"><span class='Ref_To_Local'>isinit</span></a><span class='Parentheses'>) 
</span>                <a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8388"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8375"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN154"><span class='Ref_to_Member'>offsets</span></a><span class='Delimiter'>[</span><a href="heapam.c.html#LN8388"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid max offset number"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN8439"><span class='Ref_To_Local'>xlhdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN159"><span class='Ref_to_Struct'>xl_multi_insert_tuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/c.h.html#LN583"><span class='Ref_to_Macro'>SHORTALIGN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8439"><span class='Ref_To_Local'>xlhdr</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../../../include/access/heapam_xlog.h.html#LN168"><span class='Ref_to_Const'>SizeOfMultiInsertTuple</span></a><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN8386"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8439"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN161"><span class='Ref_to_Member'>datalen</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8386"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= &</span><a href="heapam.c.html#LN8384"><span class='Ref_To_Local'>tbuf</span></a><span class='Operator'>.</span><a href="heapam.c.html#LN8382"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* PG73FORMAT: get bitmap [+ padding] [+ oid] + data */ 
</span>            memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a><span class='Delimiter'>, 
</span>                   <a href="heapam.c.html#LN8386"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8386"><span class='Ref_To_Local'>newlen</span></a><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN8386"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>+= </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8439"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN162"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8439"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN163"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8439"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN164"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8372"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/htup_details.h.html#LN390"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/itemptr.h.html#LN114"><span class='Ref_to_Macro'>ItemPointerSetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8377"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/itemptr.h.html#LN124"><span class='Ref_to_Macro'>ItemPointerSetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN8385"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8386"><span class='Ref_To_Local'>newlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8438"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;xlrec-&GT;ntuples;... &raquo; </span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8426"><span class='Ref_To_Local'>tupdata</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN8427"><span class='Ref_To_Local'>endptr</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"total tuple length mismatch"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8387"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* needed to update FSM below */ 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8374"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8375"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN152"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN65"><span class='Ref_to_Const'>XLH_INSERT_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8379"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if action==BLK_NEEDS_RED... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8378"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page is running low on free space, update the FSM as well. 
     * Arbitrarily, our definition of "low" is less than 20%. We can't do much 
     * better than that without knowing the fill-factor for the table. 
     * 
     * XXX: Don't do this if the page was restored from full page image. We 
     * don't bother to update the FSM in that case, it doesn't need to be 
     * totally accurate anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8390"><span class='Ref_To_Local'>action</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN8387"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>&LT; </span>BLCKSZ <span class='Operator'>/ </span><span class='Number'>5</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/freespace.h.html#LN29"><span class='Ref_to_Proto'>XLogRecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8376"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8377"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8387"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_multi_insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handles UPDATE and HOT_UPDATE 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN8511"></a><span class='Declare_Function'>heap_xlog_update</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>hot_update</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8513"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8514"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN187"><span class='Ref_to_Struct'>xl_heap_update</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN187"><span class='Ref_to_Struct'>xl_heap_update</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8515"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN8516"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>oldblk</span><span class='Delimiter'>; 
</span><a name="LN8517"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>newblk</span><span class='Delimiter'>; 
</span><a name="LN8518"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>newtid</span><span class='Delimiter'>; 
</span><a name="LN8519"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>obuffer</span><span class='Delimiter'>, 
</span><a name="LN8520"></a>                <span class='Declare_Local'>nbuffer</span><span class='Delimiter'>; 
</span><a name="LN8521"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN8522"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN8523"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN8524"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>oldtup</span><span class='Delimiter'>; 
</span><a name="LN8525"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN8526"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>prefixlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN8527"></a>                <span class='Declare_Local'>suffixlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN8528"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>newp</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN8531"></a>        <a href="../../../include/access/htup_details.h.html#LN141"><span class='Ref_to_Struct'>HeapTupleHeaderData</span></a> <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span><a name="LN8532"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>data</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Delimiter'>]; 
</span><a name="LN8533"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>tbuf</span><span class='Delimiter'>; 
</span><a name="LN8534"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN119"><span class='Ref_to_Struct'>xl_heap_header</span></a> <span class='Declare_Local'>xlhdr</span><span class='Delimiter'>; 
</span><a name="LN8535"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newlen</span><span class='Delimiter'>; 
</span><a name="LN8536"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN8537"></a>    <a href="../../../include/access/xlogutils.h.html#LN26"><span class='Ref_to_Typedef'>XLogRedoAction</span></a> <span class='Declare_Local'>oldaction</span><span class='Delimiter'>; 
</span><a name="LN8538"></a>    <a href="../../../include/access/xlogutils.h.html#LN26"><span class='Ref_to_Typedef'>XLogRedoAction</span></a> <span class='Declare_Local'>newaction</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize to keep the compiler quiet */ 
</span>    <a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8515"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* HOT updates are never done across pages */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>hot_update</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8518"><span class='Ref_To_Local'>newtid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN194"><span class='Ref_to_Member'>new_offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN74"><span class='Ref_to_Const'>XLH_UPDATE_OLD_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8561"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8515"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8562"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8561"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8562"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8561"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8562"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8562"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8561"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In normal operation, it is important to lock the two pages in 
     * page-number order, to avoid possible deadlocks against other update 
     * operations going the other way.  However, during WAL replay there can 
     * be no other update happening, so we don't need to worry about that. But 
     * we *do* need to worry that we don't expose an inconsistent state to Hot 
     * Standby queries --- so the original page can't be unlocked before we've 
     * added the new tuple to the new page. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Deal with old tuple version */ 
</span>    <a href="heapam.c.html#LN8537"><span class='Ref_To_Local'>oldaction</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8537"><span class='Ref_To_Local'>oldaction</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN190"><span class='Ref_to_Member'>old_offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="heapam.c.html#LN8523"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8523"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8523"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8523"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>hot_update</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/htup_details.h.html#LN491"><span class='Ref_to_Macro'>HeapTupleHeaderSetHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/access/htup_details.h.html#LN496"><span class='Ref_to_Macro'>HeapTupleHeaderClearHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8164"><span class='Ref_to_Func'>fix_infomask_from_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN191"><span class='Ref_to_Member'>old_infobits_set</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN189"><span class='Ref_to_Member'>old_xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN398"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Set forward chain link in t_ctid */ 
</span>        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8518"><span class='Ref_To_Local'>newtid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark the page as a candidate for pruning */ 
</span>        <a href="../../../include/storage/bufpage.h.html#LN394"><span class='Ref_to_Macro'>PageSetPrunable</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN74"><span class='Ref_to_Const'>XLH_UPDATE_OLD_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8513"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldaction==BLK_NEEDS_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Read the page the new tuple goes into, if different from old. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8538"><span class='Ref_To_Local'>newaction</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8537"><span class='Ref_To_Local'>oldaction</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN45"><span class='Ref_to_Const'>XLOG_HEAP_INIT_PAGE</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN37"><span class='Ref_to_Proto'>XLogInitBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8538"><span class='Ref_To_Local'>newaction</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heapam.c.html#LN8538"><span class='Ref_To_Local'>newaction</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN76"><span class='Ref_to_Const'>XLH_UPDATE_NEW_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8645"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8515"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8646"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8645"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8646"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8645"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8646"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8646"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8645"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Deal with new tuple */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8538"><span class='Ref_To_Local'>newaction</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8657"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>recdata</span><span class='Delimiter'>; 
</span><a name="LN8658"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>recdata_end</span><span class='Delimiter'>; 
</span><a name="LN8659"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>datalen</span><span class='Delimiter'>; 
</span><a name="LN8660"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>tuplen</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN230"><span class='Ref_to_Proto'>XLogRecGetBlockData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8659"><span class='Ref_To_Local'>datalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8658"><span class='Ref_To_Local'>recdata_end</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8659"><span class='Ref_To_Local'>datalen</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN194"><span class='Ref_to_Member'>new_offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid max offset number"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN80"><span class='Ref_to_Const'>XLH_UPDATE_PREFIX_FROM_OLD</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8526"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN81"><span class='Ref_to_Const'>XLH_UPDATE_SUFFIX_FROM_OLD</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN8516"><span class='Ref_To_Local'>oldblk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8527"><span class='Ref_To_Local'>suffixlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="heapam.c.html#LN8534"><span class='Ref_To_Local'>xlhdr</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+= </span><a href="../../../include/access/heapam_xlog.h.html#LN126"><span class='Ref_to_Const'>SizeOfHeapHeader</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8658"><span class='Ref_To_Local'>recdata_end</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= &</span><a href="heapam.c.html#LN8533"><span class='Ref_To_Local'>tbuf</span></a><span class='Operator'>.</span><a href="heapam.c.html#LN8531"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Reconstruct the new tuple using the prefix and/or suffix from the 
         * old tuple, and the data stored in the WAL record. 
         */ 
</span>        <a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8526"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN8700"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* copy bitmap [+ padding] [+ oid] from WAL record */ 
</span>            <a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8534"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* copy prefix from old tuple */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8526"><span class='Ref_To_Local'>prefixlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8526"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* copy new tuple data from WAL record */ 
</span>            <a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8534"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8700"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if prefixlen&GT;0 &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * copy bitmap [+ padding] [+ oid] + data from record, all in one 
             * go 
             */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a><span class='Delimiter'>; 
</span>            <a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a> <span class='Operator'>+= </span><a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heapam.c.html#LN8657"><span class='Ref_To_Local'>recdata</span></a> <span class='Operator'>== </span><a href="heapam.c.html#LN8658"><span class='Ref_To_Local'>recdata_end</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* copy suffix from old tuple */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8527"><span class='Ref_To_Local'>suffixlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            memcpy<span class='Parentheses'>(</span><a href="heapam.c.html#LN8528"><span class='Ref_To_Local'>newp</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8524"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>- </span><a href="heapam.c.html#LN8527"><span class='Ref_To_Local'>suffixlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8527"><span class='Ref_To_Local'>suffixlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8535"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8660"><span class='Ref_To_Local'>tuplen</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8526"><span class='Ref_To_Local'>prefixlen</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8527"><span class='Ref_To_Local'>suffixlen</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8534"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN121"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8534"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN122"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8534"><span class='Ref_To_Local'>xlhdr</span></a><span class='Operator'>.</span><a href="../../../include/access/heapam_xlog.h.html#LN123"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/htup_details.h.html#LN312"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN390"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN193"><span class='Ref_to_Member'>new_xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Make sure there is no forward chain link in t_ctid */ 
</span>        <a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8518"><span class='Ref_To_Local'>newtid</span></a><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN8525"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8535"><span class='Ref_To_Local'>newlen</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8522"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8514"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN192"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN76"><span class='Ref_to_Const'>XLH_UPDATE_NEW_ALL_VISIBLE_CLEARED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8536"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* needed to update FSM below */ 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8521"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8513"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if newaction==BLK_NEEDS_... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8520"><span class='Ref_To_Local'>nbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8519"><span class='Ref_To_Local'>obuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the new page is running low on free space, update the FSM as well. 
     * Arbitrarily, our definition of "low" is less than 20%. We can't do much 
     * better than that without knowing the fill-factor for the table. 
     * 
     * However, don't update the FSM on HOT updates, because after crash 
     * recovery, either the old or the new tuple will certainly be dead and 
     * prunable. After pruning, the page will have roughly as much free space 
     * as it did before the update, assuming the new tuple is about the same 
     * size as the old one. 
     * 
     * XXX: Don't do this if the page was restored from full page image. We 
     * don't bother to update the FSM in that case, it doesn't need to be 
     * totally accurate anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8538"><span class='Ref_To_Local'>newaction</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a> <span class='Operator'>&& !</span><a href="heapam.c.html#LN8511"><span class='Ref_to_Parameter'>hot_update</span></a> <span class='Operator'>&& </span><a href="heapam.c.html#LN8536"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>&LT; </span>BLCKSZ <span class='Operator'>/ </span><span class='Number'>5</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/freespace.h.html#LN29"><span class='Ref_to_Proto'>XLogRecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8515"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8517"><span class='Ref_To_Local'>newblk</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8536"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_update &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN8783"></a><span class='Declare_Function'>heap_xlog_confirm</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8785"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8783"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8786"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN271"><span class='Ref_to_Struct'>xl_heap_confirm</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN271"><span class='Ref_to_Struct'>xl_heap_confirm</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8783"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8787"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8788"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN8789"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN8790"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN8791"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8783"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8787"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8788"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8787"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8789"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8786"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN273"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8788"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN8789"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="heapam.c.html#LN8790"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8788"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8789"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8788"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN8789"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8790"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8791"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8788"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8790"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Confirm tuple as actually inserted 
         */ 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8791"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8787"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN8789"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8788"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8785"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8787"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8787"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8787"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_confirm &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN8819"></a><span class='Declare_Function'>heap_xlog_lock</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8821"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8819"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8822"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN249"><span class='Ref_to_Struct'>xl_heap_lock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN249"><span class='Ref_to_Struct'>xl_heap_lock</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8819"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8823"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8824"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN8825"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN8826"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN8827"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8822"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN254"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN246"><span class='Ref_to_Const'>XLH_LOCK_ALL_FROZEN_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8835"></a>        <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN8836"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN8837"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN8838"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8819"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8835"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8837"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8838"><span class='Ref_To_Local'>reln</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8835"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8838"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8837"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8836"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8838"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8837"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8836"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8836"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8838"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8819"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8823"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8824"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8823"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8825"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8822"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN252"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8824"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN8825"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="heapam.c.html#LN8826"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8824"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8825"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8824"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN8825"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8826"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8824"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8826"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8164"><span class='Ref_to_Func'>fix_infomask_from_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8822"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN253"><span class='Ref_to_Member'>infobits_set</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Clear relevant update flags, but only if the modified infomask says 
         * there's no update. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN215"><span class='Ref_to_Macro'>HEAP_XMAX_IS_LOCKED_ONLY</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/htup_details.h.html#LN496"><span class='Ref_to_Macro'>HeapTupleHeaderClearHotUpdated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Make sure there is no forward chain link in t_ctid */ 
</span>            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8823"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="heapam.c.html#LN8825"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8822"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN251"><span class='Ref_to_Member'>locking_xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN398"><span class='Ref_to_Macro'>HeapTupleHeaderSetCmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8827"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8824"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8821"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8823"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8823"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8823"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_lock &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN8890"></a><span class='Declare_Function'>heap_xlog_lock_updated</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8892"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8890"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8893"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN260"><span class='Ref_to_Struct'>xl_heap_lock_updated</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN8894"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8895"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN8896"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN8897"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN8898"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span> 
    <a href="heapam.c.html#LN8893"><span class='Ref_To_Local'>xlrec</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN260"><span class='Ref_to_Struct'>xl_heap_lock_updated</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8890"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The visibility map may need to be fixed even if the heap page is 
     * already up-to-date. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8893"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN265"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN246"><span class='Ref_to_Const'>XLH_LOCK_ALL_FROZEN_CLEARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN8908"></a>        <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN8909"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN8910"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN8911"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>reln</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xlogreader.h.html#LN231"><span class='Ref_to_Proto'>XLogRecGetBlockTag</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8890"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8908"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8910"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8911"><span class='Ref_To_Local'>reln</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogutils.h.html#LN46"><span class='Ref_to_Proto'>CreateFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8908"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8911"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8910"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8909"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8911"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8910"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8909"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8909"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xlogutils.h.html#LN47"><span class='Ref_to_Proto'>FreeFakeRelcacheEntry</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8911"><span class='Ref_To_Local'>reln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8890"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8894"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heapam.c.html#LN8895"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8894"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8896"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8893"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN263"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8895"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN8896"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="heapam.c.html#LN8897"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8895"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8896"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8895"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN8896"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8897"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8898"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8895"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8897"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8898"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN255"><span class='Ref_to_Const'>HEAP_XMAX_BITS</span></a> <span class='Operator'>| </span><a href="../../../include/access/htup_details.h.html#LN201"><span class='Ref_to_Const'>HEAP_MOVED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8898"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN263"><span class='Ref_to_Const'>HEAP_KEYS_UPDATED</span></a><span class='Delimiter'>; 
</span>        <a href="heapam.c.html#LN8164"><span class='Ref_to_Func'>fix_infomask_from_infobits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8893"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN264"><span class='Ref_to_Member'>infobits_set</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8898"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="heapam.c.html#LN8898"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN373"><span class='Ref_to_Macro'>HeapTupleHeaderSetXmax</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8898"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8893"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN262"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8895"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8892"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8894"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8894"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8894"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_lock_updated &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN8950"></a><span class='Declare_Function'>heap_xlog_inplace</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8952"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span> <span class='Operator'>= </span><a href="heapam.c.html#LN8950"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN8953"></a>    <a href="../../../include/access/heapam_xlog.h.html#LN279"><span class='Ref_to_Struct'>xl_heap_inplace</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/heapam_xlog.h.html#LN279"><span class='Ref_to_Struct'>xl_heap_inplace</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8950"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN8954"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN8955"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN8956"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN8957"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN8958"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span><a name="LN8959"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>oldlen</span><span class='Delimiter'>; 
</span><a name="LN8960"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newlen</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogutils.h.html#LN35"><span class='Ref_to_Proto'>XLogReadBufferForRedo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8950"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8954"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/xlogutils.h.html#LN28"><span class='Ref_to_EnumConst'>BLK_NEEDS_REDO</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN8964"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>newtup</span> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN230"><span class='Ref_to_Proto'>XLogRecGetBlockData</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8950"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heapam.c.html#LN8960"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8955"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8954"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8956"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="heapam.c.html#LN8953"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN281"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8955"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="heapam.c.html#LN8956"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="heapam.c.html#LN8957"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8955"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8956"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8955"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="heapam.c.html#LN8956"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>|| !</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8957"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"invalid lp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8958"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8955"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8957"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN8959"><span class='Ref_To_Local'>oldlen</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8957"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="heapam.c.html#LN8958"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8959"><span class='Ref_To_Local'>oldlen</span></a> <span class='Operator'>!= </span><a href="heapam.c.html#LN8960"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"wrong tuple length"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heapam.c.html#LN8958"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN8958"><span class='Ref_To_Local'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8964"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8960"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8955"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN8952"><span class='Ref_To_Local'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8954"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if XLogReadBufferForRedo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8954"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8954"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_xlog_inplace &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN8991"></a><span class='Declare_Function'>heap_redo</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN8993"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& ~</span><a href="../../../include/access/xlogrecord.h.html#LN61"><span class='Ref_to_Const'>XLR_INFO_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * These operations don't overwrite MVCC data so no conflict processing is 
     * required. The ones in heap2 rmgr do. 
     */ 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN8993"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN40"><span class='Ref_to_Const'>XLOG_HEAP_OPMASK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN31"><span class='Ref_to_Const'>XLOG_HEAP_INSERT</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8255"><span class='Ref_to_Func'>heap_xlog_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN32"><span class='Ref_to_Const'>XLOG_HEAP_DELETE</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8185"><span class='Ref_to_Func'>heap_xlog_delete</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN33"><span class='Ref_to_Const'>XLOG_HEAP_UPDATE</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8510"><span class='Ref_to_Func'>heap_xlog_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN35"><span class='Ref_to_Const'>XLOG_HEAP_HOT_UPDATE</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8510"><span class='Ref_to_Func'>heap_xlog_update</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN36"><span class='Ref_to_Const'>XLOG_HEAP_CONFIRM</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8782"><span class='Ref_to_Func'>heap_xlog_confirm</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN37"><span class='Ref_to_Const'>XLOG_HEAP_LOCK</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8818"><span class='Ref_to_Func'>heap_xlog_lock</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN38"><span class='Ref_to_Const'>XLOG_HEAP_INPLACE</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8949"><span class='Ref_to_Func'>heap_xlog_inplace</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN8991"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"heap_redo: unknown op code %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN8993"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch info&XLOG_HEAP_OPMASK &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heap_redo &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN9029"></a><span class='Declare_Function'>heap2_redo</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN9031"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& ~</span><a href="../../../include/access/xlogrecord.h.html#LN61"><span class='Ref_to_Const'>XLR_INFO_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN9031"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>& </span><a href="../../../include/access/heapam_xlog.h.html#LN40"><span class='Ref_to_Const'>XLOG_HEAP_OPMASK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN53"><span class='Ref_to_Const'>XLOG_HEAP2_CLEAN</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN7901"><span class='Ref_to_Func'>heap_xlog_clean</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN54"><span class='Ref_to_Const'>XLOG_HEAP2_FREEZE_PAGE</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8106"><span class='Ref_to_Func'>heap_xlog_freeze_page</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN55"><span class='Ref_to_Const'>XLOG_HEAP2_CLEANUP_INFO</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN7880"><span class='Ref_to_Func'>heap_xlog_cleanup_info</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN56"><span class='Ref_to_Const'>XLOG_HEAP2_VISIBLE</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN7991"><span class='Ref_to_Func'>heap_xlog_visible</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN57"><span class='Ref_to_Const'>XLOG_HEAP2_MULTI_INSERT</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8371"><span class='Ref_to_Func'>heap_xlog_multi_insert</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN58"><span class='Ref_to_Const'>XLOG_HEAP2_LOCK_UPDATED</span></a><span class='Operator'>: 
</span>            <a href="heapam.c.html#LN8889"><span class='Ref_to_Func'>heap_xlog_lock_updated</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN59"><span class='Ref_to_Const'>XLOG_HEAP2_NEW_CID</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Nothing to do on a real replay, only used during logical 
             * decoding. 
             */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/heapam_xlog.h.html#LN52"><span class='Ref_to_Const'>XLOG_HEAP2_REWRITE</span></a><span class='Operator'>: 
</span>            <a href="../../../include/access/heapam_xlog.h.html#LN379"><span class='Ref_to_Proto'>heap_xlog_logical_rewrite</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9029"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"heap2_redo: unknown op code %u"</span><span class='Delimiter'>, </span><a href="heapam.c.html#LN9031"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch info&XLOG_HEAP_OPMASK &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heap2_redo &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  heap_sync       - sync a heap, for use when no WAL has been written 
 * 
 * This forces the heap contents (including TOAST heap if any) down to disk. 
 * If we skipped using WAL, and WAL is otherwise needed, we must force the 
 * relation down to disk before it's safe to commit the transaction.  This 
 * requires writing out any dirty buffers and then doing a forced fsync. 
 * 
 * Indexes are not touched.  (Currently, index operations associated with 
 * the commands that use this are WAL-logged and so do not need fsync. 
 * That behavior might change someday, but in any case it's likely that 
 * any fsync decisions required would be per-index and hence not appropriate 
 * to be done here.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN9083"></a><span class='Declare_Function'>heap_sync</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* non-WAL-logged tables never need fsync */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9083"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* main heap */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN191"><span class='Ref_to_Proto'>FlushRelationBuffers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9083"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* FlushRelationBuffers will have opened rd_smgr */ 
</span>    <a href="../../../include/storage/smgr.h.html#LN107"><span class='Ref_to_Proto'>smgrimmedsync</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9083"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* FSM is not critical, don't bother syncing it */ 
</span> 
    <span class='Comment_Multi_Line'>/* toast heap, if any */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9083"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN9099"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN9099"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9083"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN191"><span class='Ref_to_Proto'>FlushRelationBuffers</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9099"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN107"><span class='Ref_to_Proto'>smgrimmedsync</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9099"><span class='Ref_To_Local'>toastrel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9099"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_sync &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Mask a heap page before performing consistency checks on it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN9112"></a><span class='Declare_Function'>heap_mask</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pagedata</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN9114"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN9112"><span class='Ref_to_Parameter'>pagedata</span></a><span class='Delimiter'>; 
</span><a name="LN9115"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/bufmask.h.html#LN25"><span class='Ref_to_Proto'>mask_page_lsn</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9114"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/bufmask.h.html#LN26"><span class='Ref_to_Proto'>mask_page_hint_bits</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9114"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/bufmask.h.html#LN27"><span class='Ref_to_Proto'>mask_unused_space</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9114"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN9115"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN9115"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9114"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="heapam.c.html#LN9115"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN9124"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>iid</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9114"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN9115"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN9125"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>page_item</span><span class='Delimiter'>; 
</span> 
        <a href="heapam.c.html#LN9125"><span class='Ref_To_Local'>page_item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="heapam.c.html#LN9114"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>+ </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9124"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9124"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN9131"></a>            <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>page_htup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="heapam.c.html#LN9125"><span class='Ref_To_Local'>page_item</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If xmin of a tuple is not yet frozen, we should ignore 
             * differences in hint bits, since they can be set without 
             * emitting WAL. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup_details.h.html#LN328"><span class='Ref_to_Macro'>HeapTupleHeaderXminFrozen</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Parentheses'>))</span> 
                <a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN203"><span class='Ref_to_Const'>HEAP_XACT_MASK</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Still we need to mask xmax hint bits. */ 
</span>                <a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN192"><span class='Ref_to_Const'>HEAP_XMAX_INVALID</span></a><span class='Delimiter'>; 
</span>                <a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN191"><span class='Ref_to_Const'>HEAP_XMAX_COMMITTED</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * During replay, we set Command Id to FirstCommandId. Hence, mask 
             * it. See heap_xlog_insert() for details. 
             */ 
</span>            <a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN147"><span class='Ref_to_Member'>t_choice</span></a><span class='Operator'>.</span>t_heap<span class='Operator'>.</span>t_field3<span class='Operator'>.</span>t_cid <span class='Operator'>= </span><a href="../../../include/access/bufmask.h.html#LN23"><span class='Ref_to_Const'>MASK_MARKER</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * For a speculative tuple, heap_insert() does not set ctid in the 
             * caller-passed heap tuple itself, leaving the ctid field to 
             * contain a speculative token value - a per-backend monotonically 
             * increasing identifier. Besides, it does not WAL-log ctid under 
             * any circumstances. 
             * 
             * During redo, heap_xlog_insert() sets t_ctid to current block 
             * number and self offset number. It doesn't care about any 
             * speculative insertions in master. Hence, we set t_ctid to 
             * current block number and self offset number to ignore any 
             * inconsistency. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN422"><span class='Ref_to_Macro'>HeapTupleHeaderIsSpeculative</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heapam.c.html#LN9131"><span class='Ref_To_Local'>page_htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN9112"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN9115"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ItemIdIsNormal(iid) &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Ignore any padding bytes after the tuple, when the length of the 
         * item is not MAXALIGNed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9124"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN9176"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9124"><span class='Ref_To_Local'>iid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN9177"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>padlen</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="heapam.c.html#LN9176"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="heapam.c.html#LN9176"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heapam.c.html#LN9177"><span class='Ref_To_Local'>padlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                memset<span class='Parentheses'>(</span><a href="heapam.c.html#LN9125"><span class='Ref_To_Local'>page_item</span></a> <span class='Operator'>+ </span><a href="heapam.c.html#LN9176"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="../../../include/access/bufmask.h.html#LN23"><span class='Ref_to_Const'>MASK_MARKER</span></a><span class='Delimiter'>, </span><a href="heapam.c.html#LN9177"><span class='Ref_To_Local'>padlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for off=1;off&LT;=PageGetMax... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end heap_mask &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>