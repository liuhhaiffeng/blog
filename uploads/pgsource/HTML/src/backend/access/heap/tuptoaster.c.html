<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\heap\tuptoaster.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\heap\tuptoaster.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:29 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * tuptoaster.c 
 *    Support routines for external and compressed storage of 
 *    variable size attributes. 
 * 
 * Copyright (c) 2000-2017, PostgreSQL Global Development Group 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/heap/tuptoaster.c 
 * 
 * 
 * INTERFACE ROUTINES 
 *      toast_insert_or_update - 
 *          Try to make a given tuple fit into one page by compressing 
 *          or moving off attributes 
 * 
 *      toast_delete - 
 *          Reclaim toast storage when a tuple is deleted 
 * 
 *      heap_tuple_untoast_attr - 
 *          Fetch back a given value from the "secondary" relation 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/tuptoaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/pg_lzcompress.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/expandeddatum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Keyword'>#undef </span>TOAST_DEBUG 
 
<span class='Comment_Multi_Line'>/* 
 *  The information at the start of the compressed toast data. 
 */ 
</span><a name="LN52"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>toast_compress_header</span> 
<span class='Delimiter'>{ 
</span><a name="LN54"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>vl_len_</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* varlena header (do not touch directly!) */ 
</span><a name="LN55"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>rawsize</span><span class='Delimiter'>; 
</span><a name="LN56"></a>} <span class='Declare_Typedef'>toast_compress_header</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Utilities for manipulation of header information for compressed 
 * toast entries. 
 */ 
</span><a name="LN62"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TOAST_COMPRESS_HDRSZ</span>        <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN52"><span class='Ref_to_Struct'>toast_compress_header</span></a><span class='Parentheses'>))</span> 
<a name="LN63"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TOAST_COMPRESS_RAWSIZE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) (((</span><a href="tuptoaster.c.html#LN52"><span class='Ref_to_Struct'>toast_compress_header</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="tuptoaster.c.html#LN63"><span class='Ref_to_Parameter'>ptr</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>rawsize<span class='Parentheses'>)</span> 
<a name="LN64"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TOAST_COMPRESS_RAWDATA</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="tuptoaster.c.html#LN64"><span class='Ref_to_Parameter'>ptr</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN62"><span class='Ref_to_Const'>TOAST_COMPRESS_HDRSZ</span></a><span class='Parentheses'>)</span> 
<a name="LN66"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TOAST_COMPRESS_SET_RAWSIZE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(((</span><a href="tuptoaster.c.html#LN52"><span class='Ref_to_Struct'>toast_compress_header</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="tuptoaster.c.html#LN66"><span class='Ref_to_Parameter'>ptr</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>rawsize <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN66"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>))</span> 
 
<a name="LN69"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>toast_delete_datum</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_speculative</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>toast_save_datum</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, 
</span><a name="LN71"></a>                 <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>oldexternal</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN72"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>toastrel_valueid_exists</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>toastrel</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>valueid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN73"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>toastid_valueid_exists</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastrelid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>valueid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>toast_fetch_datum</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN75"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>toast_fetch_datum_slice</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Delimiter'>, 
</span><a name="LN76"></a>                        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>sliceoffset</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>length</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN77"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>toast_decompress_datum</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>toast_open_indexes</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>toastrel</span><span class='Delimiter'>, 
</span><a name="LN79"></a>                   <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lock</span><span class='Delimiter'>, 
</span><a name="LN80"></a>                   <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>toastidxs</span><span class='Delimiter'>, 
</span><a name="LN81"></a>                   <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>num_indexes</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>toast_close_indexes</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>toastidxs</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>num_indexes</span><span class='Delimiter'>, 
</span><a name="LN83"></a>                    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lock</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN84"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>init_toast_snapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>toast_snapshot</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * heap_tuple_fetch_attr - 
 * 
 *  Public entry point to get back a toasted value from 
 *  external source (possibly still in compressed format). 
 * 
 * This will return a datum that contains all the data internally, ie, not 
 * relying on external storage or memory, but it can still be compressed or 
 * have a short header.  Note some callers assume that if the input is an 
 * EXTERNAL datum, the result will be a pfree'able chunk. 
 * ---------- 
 */ 
</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* 
</span><a name="LN100"></a><span class='Declare_Function'>heap_tuple_fetch_attr</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN102"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is an external stored plain value 
         */ 
</span>        <a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN74"><span class='Ref_to_Proto'>toast_fetch_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is an indirect pointer --- dereference it 
         */ 
</span><a name="LN116"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN84"><span class='Ref_to_Struct'>varatt_indirect</span></a> <span class='Declare_Local'>redirect</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN116"><span class='Ref_To_Local'>redirect</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN116"><span class='Ref_To_Local'>redirect</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* nested indirect Datums aren't allowed */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* recurse if value is still external in some other way */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="tuptoaster.c.html#LN99"><span class='Ref_to_Func'>heap_tuple_fetch_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Copy into the caller's memory context, in case caller tries to 
         * pfree the result. 
         */ 
</span>        <a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if VARATT_IS_EXTERNAL_IN... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN322"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_EXPANDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is an expanded-object pointer --- get flat format 
         */ 
</span><a name="LN140"></a>        <a href="../../../include/utils/expandeddatum.h.html#LN97"><span class='Ref_to_Struct'>ExpandedObjectHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>eoh</span><span class='Delimiter'>; 
</span><a name="LN141"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>resultsize</span><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN140"><span class='Ref_To_Local'>eoh</span></a> <span class='Operator'>= </span><a href="../../utils/adt/expandeddatum.c.html#LN27"><span class='Ref_to_Func'>DatumGetEOHP</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN141"><span class='Ref_To_Local'>resultsize</span></a> <span class='Operator'>= </span><a href="../../utils/adt/expandeddatum.c.html#LN73"><span class='Ref_to_Func'>EOH_get_flat_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN140"><span class='Ref_To_Local'>eoh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN141"><span class='Ref_To_Local'>resultsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../utils/adt/expandeddatum.c.html#LN79"><span class='Ref_to_Func'>EOH_flatten_into</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN140"><span class='Ref_To_Local'>eoh</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN141"><span class='Ref_To_Local'>resultsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is a plain value inside of the main tuple - why am I called? 
         */ 
</span>        <a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN100"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN102"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_tuple_fetch_attr &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * heap_tuple_untoast_attr - 
 * 
 *  Public entry point to get back a toasted value from compression 
 *  or external storage.  The result is always non-extended varlena form. 
 * 
 * Note some callers assume that if the input is an EXTERNAL or COMPRESSED 
 * datum, the result will be a pfree'able chunk. 
 * ---------- 
 */ 
</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* 
</span><a name="LN171"></a><span class='Declare_Function'>heap_tuple_untoast_attr</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is an externally stored datum --- fetch it back from there 
         */ 
</span>        <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN74"><span class='Ref_to_Proto'>toast_fetch_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* If it's compressed, decompress it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN182"></a>            <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>; 
</span> 
            <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN77"><span class='Ref_to_Proto'>toast_decompress_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN182"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN182"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is an indirect pointer --- dereference it 
         */ 
</span><a name="LN193"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN84"><span class='Ref_to_Struct'>varatt_indirect</span></a> <span class='Declare_Local'>redirect</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN193"><span class='Ref_To_Local'>redirect</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN193"><span class='Ref_To_Local'>redirect</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* nested indirect Datums aren't allowed */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* recurse in case value is still extended in some other way */ 
</span>        <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN163"><span class='Ref_to_Proto'>heap_tuple_untoast_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if it isn't, we'd better copy it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN193"><span class='Ref_To_Local'>redirect</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN207"></a>            <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
            <a href="tuptoaster.c.html#LN207"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN207"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN207"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if VARATT_IS_EXTERNAL_IN... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN322"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_EXPANDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is an expanded-object pointer --- get flat format 
         */ 
</span>        <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN99"><span class='Ref_to_Func'>heap_tuple_fetch_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* flatteners are not allowed to produce compressed/short output */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN325"><span class='Ref_to_Macro'>VARATT_IS_EXTENDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is a compressed value inside of the main tuple 
         */ 
</span>        <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN77"><span class='Ref_to_Proto'>toast_decompress_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is a short-header varlena --- convert to 4-byte header format 
         */ 
</span><a name="LN235"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>data_size</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a><span class='Delimiter'>; 
</span><a name="LN236"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>new_size</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN235"><span class='Ref_To_Local'>data_size</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span><a name="LN237"></a>        <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_attr</span><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN237"><span class='Ref_To_Local'>new_attr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN236"><span class='Ref_To_Local'>new_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN237"><span class='Ref_To_Local'>new_attr</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN236"><span class='Ref_To_Local'>new_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN237"><span class='Ref_To_Local'>new_attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN306"><span class='Ref_to_Macro'>VARDATA_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN235"><span class='Ref_To_Local'>data_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN237"><span class='Ref_To_Local'>new_attr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN171"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_tuple_untoast_attr &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * heap_tuple_untoast_attr_slice - 
 * 
 *      Public entry point to get back part of a toasted value 
 *      from compression or external storage. 
 * ---------- 
 */ 
</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* 
</span><a name="LN257"></a><span class='Declare_Function'>heap_tuple_untoast_attr_slice</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Delimiter'>, 
</span><a name="LN258"></a>                              <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>sliceoffset</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>slicelength</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN260"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>preslice</span><span class='Delimiter'>; 
</span><a name="LN261"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN262"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>attrdata</span><span class='Delimiter'>; 
</span><a name="LN263"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>attrsize</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN267"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN267"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* fast path for non-compressed external datums */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/tuptoaster.h.html#LN110"><span class='Ref_to_Macro'>VARATT_EXTERNAL_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN267"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="tuptoaster.c.html#LN75"><span class='Ref_to_Proto'>toast_fetch_datum_slice</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* fetch it back (compressed marker will get set automatically) */ 
</span>        <a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN74"><span class='Ref_to_Proto'>toast_fetch_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN280"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN84"><span class='Ref_to_Struct'>varatt_indirect</span></a> <span class='Declare_Local'>redirect</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN280"><span class='Ref_To_Local'>redirect</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* nested indirect Datums aren't allowed */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN280"><span class='Ref_To_Local'>redirect</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../../include/access/tuptoaster.h.html#LN172"><span class='Ref_to_Proto'>heap_tuple_untoast_attr_slice</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN280"><span class='Ref_To_Local'>redirect</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Delimiter'>, 
</span>                                             <a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN322"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_EXPANDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* pass it off to heap_tuple_fetch_attr to flatten */ 
</span>        <a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN99"><span class='Ref_to_Func'>heap_tuple_fetch_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN302"></a>        <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN77"><span class='Ref_to_Proto'>toast_decompress_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN302"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN302"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>!= </span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN302"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN262"><span class='Ref_To_Local'>attrdata</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN306"><span class='Ref_to_Macro'>VARDATA_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN263"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN262"><span class='Ref_To_Local'>attrdata</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN263"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* slicing of datum for compressed cases and plain value */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>&GT;= </span><a href="tuptoaster.c.html#LN263"><span class='Ref_To_Local'>attrsize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN263"><span class='Ref_To_Local'>attrsize</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN263"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN261"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN261"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN261"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN262"><span class='Ref_To_Local'>attrdata</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>sliceoffset</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN258"><span class='Ref_to_Parameter'>slicelength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a> <span class='Operator'>!= </span><a href="tuptoaster.c.html#LN257"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN260"><span class='Ref_To_Local'>preslice</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN261"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_tuple_untoast_attr_slice &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_raw_datum_size - 
 * 
 *  Return the raw (detoasted) size of a varlena datum 
 *  (including the VARHDRSZ header) 
 * ---------- 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN352"></a><span class='Declare_Function'>toast_raw_datum_size</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN354"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN355"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* va_rawsize is the size of the original datum -- including header */ 
</span><a name="LN360"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN360"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN355"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN360"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN69"><span class='Ref_to_Member'>va_rawsize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN367"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN84"><span class='Ref_to_Struct'>varatt_indirect</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN367"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* nested indirect Datums aren't allowed */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN367"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../../include/access/tuptoaster.h.html#LN220"><span class='Ref_to_Proto'>toast_raw_datum_size</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN367"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN322"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_EXPANDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN355"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../utils/adt/expandeddatum.c.html#LN73"><span class='Ref_to_Func'>EOH_get_flat_size</span></a><span class='Parentheses'>(</span><a href="../../utils/adt/expandeddatum.c.html#LN27"><span class='Ref_to_Func'>DatumGetEOHP</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* here, va_rawsize is just the payload size */ 
</span>        <a href="tuptoaster.c.html#LN355"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN283"><span class='Ref_to_Macro'>VARRAWSIZE_4B_C</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * we have to normalize the header length to VARHDRSZ or else the 
         * callers of this function will be confused. 
         */ 
</span>        <a href="tuptoaster.c.html#LN355"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* plain untoasted datum */ 
</span>        <a href="tuptoaster.c.html#LN355"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN354"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN355"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_raw_datum_size &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_datum_size 
 * 
 *  Return the physical storage size (possibly compressed) of a varlena datum 
 * ---------- 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN408"></a><span class='Declare_Function'>toast_datum_size</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN410"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN411"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Attribute is stored externally - return the extsize whether 
         * compressed or not.  We do not count the size of the toast pointer 
         * ... should we? 
         */ 
</span><a name="LN420"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN420"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN411"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN420"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN427"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN84"><span class='Ref_to_Struct'>varatt_indirect</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN427"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* nested indirect Datums aren't allowed */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN316"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_INDIRECT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../../include/access/tuptoaster.h.html#LN228"><span class='Ref_to_Proto'>toast_datum_size</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN427"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN322"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_EXPANDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN411"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../utils/adt/expandeddatum.c.html#LN73"><span class='Ref_to_Func'>EOH_get_flat_size</span></a><span class='Parentheses'>(</span><a href="../../utils/adt/expandeddatum.c.html#LN27"><span class='Ref_to_Func'>DatumGetEOHP</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN411"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Attribute is stored inline either compressed or not, just calculate 
         * the size of the datum in either case. 
         */ 
</span>        <a href="tuptoaster.c.html#LN411"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN410"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN411"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_datum_size &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_delete - 
 * 
 *  Cascaded delete toast-entries on DELETE 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN463"></a><span class='Declare_Function'>toast_delete</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_speculative</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN465"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupleDesc</span><span class='Delimiter'>; 
</span><a name="LN466"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numAttrs</span><span class='Delimiter'>; 
</span><a name="LN468"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN469"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>toast_values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN470"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_isnull</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We should only ever be called for tuples of plain relations or 
     * materialized views --- recursing on a toast rel is bad news. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN463"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>           <a href="tuptoaster.c.html#LN463"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the tuple descriptor and break down the tuple into fields. 
     * 
     * NOTE: it's debatable whether to use heap_deform_tuple() here or just 
     * heap_getattr() only the varlena columns.  The latter could win if there 
     * are few varlena columns and many non-varlena ones. However, 
     * heap_deform_tuple costs only O(N) while the heap_getattr way would cost 
     * O(N^2) if there are many varlena columns, so it seems better to err on 
     * the side of linear cost.  (We won't even be here unless there's at 
     * least one varlena column, by the way.) 
     */ 
</span>    <a href="tuptoaster.c.html#LN465"><span class='Ref_To_Local'>tupleDesc</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN463"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN466"><span class='Ref_To_Local'>att</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN465"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN467"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN465"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN467"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN463"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN465"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN469"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN470"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for external stored attributes and delete them from the secondary 
     * relation. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN468"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN468"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN467"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN468"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN466"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN468"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN505"></a>            <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>value</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN469"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN468"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN470"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN468"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)))</span> 
                <a href="tuptoaster.c.html#LN69"><span class='Ref_to_Proto'>toast_delete_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN463"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN463"><span class='Ref_to_Parameter'>is_speculative</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end toast_delete &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_insert_or_update - 
 * 
 *  Delete no-longer-used toast-entries and create new ones to 
 *  make the new tuple fit on INSERT or UPDATE 
 * 
 * Inputs: 
 *  newtup: the candidate new tuple to be inserted 
 *  oldtup: the old row version for UPDATE, or NULL for INSERT 
 *  options: options to be passed to heap_insert() for toast rows 
 * Result: 
 *  either newtup if no toasting is needed, or a palloc'd modified tuple 
 *  that is what should actually get stored 
 * 
 * NOTE: neither newtup nor oldtup will be modified.  This is a change 
 * from the pre-8.1 API of this routine. 
 * ---------- 
 */ 
</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN535"></a><span class='Declare_Function'>toast_insert_or_update</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, 
</span><a name="LN536"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN538"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>result_tuple</span><span class='Delimiter'>; 
</span><a name="LN539"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupleDesc</span><span class='Delimiter'>; 
</span><a name="LN540"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span><span class='Delimiter'>; 
</span><a name="LN541"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numAttrs</span><span class='Delimiter'>; 
</span><a name="LN542"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
<a name="LN544"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_change</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN545"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_free</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN546"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>need_delold</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN547"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_nulls</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN549"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>maxDataLen</span><span class='Delimiter'>; 
</span><a name="LN550"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>hoff</span><span class='Delimiter'>; 
</span> 
<a name="LN552"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>toast_action</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN553"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_isnull</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN554"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_oldisnull</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN555"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>toast_values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN556"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>toast_oldvalues</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN557"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>toast_oldexternal</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN558"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>toast_sizes</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN559"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_free</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN560"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_delold</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ignore the INSERT_SPECULATIVE option. Speculative insertions/super 
     * deletions just normally insert/delete the toast values. It seems 
     * easiest to deal with that here, instead on, potentially, multiple 
     * callers. 
     */ 
</span>    <a href="tuptoaster.c.html#LN536"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/heapam.h.html#LN30"><span class='Ref_to_Const'>HEAP_INSERT_SPECULATIVE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We should only ever be called for tuples of plain relations or 
     * materialized views --- recursing on a toast rel is bad news. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>           <a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the tuple descriptor and break down the tuple(s) into fields. 
     */ 
</span>    <a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>oldtup</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN556"><span class='Ref_To_Local'>toast_oldvalues</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN554"><span class='Ref_To_Local'>toast_oldisnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ---------- 
     * Then collect information about the values given 
     * 
     * NOTE: toast_action[i] can have these values: 
     *      ' '     default handling 
     *      'p'     already processed --- don't touch it 
     *      'x'     incompressible, but OK to move off 
     * 
     * NOTE: toast_sizes[i] is only made valid for varlena attributes with 
     *      toast_action[i] different from 'p'. 
     * ---------- 
     */ 
</span>    memset<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>, </span><span class='String'>' '</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN557"><span class='Ref_To_Local'>toast_oldexternal</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN560"><span class='Ref_To_Local'>toast_delold</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN608"></a>        <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>old_value</span><span class='Delimiter'>; 
</span><a name="LN609"></a>        <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_value</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>oldtup</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * For UPDATE get the old and new values of this attribute 
             */ 
</span>            <a href="tuptoaster.c.html#LN608"><span class='Ref_To_Local'>old_value</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN556"><span class='Ref_To_Local'>toast_oldvalues</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the old value is stored on disk, check if it has changed so 
             * we have to delete it later. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>&& !</span><a href="tuptoaster.c.html#LN554"><span class='Ref_To_Local'>toast_oldisnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&& 
</span>                <a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN608"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>|| !</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                    memcmp<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN608"><span class='Ref_To_Local'>old_value</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/postgres.h.html#LN309"><span class='Ref_to_Macro'>VARSIZE_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN608"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * The old external stored value isn't needed any more 
                     * after the update 
                     */ 
</span>                    <a href="tuptoaster.c.html#LN560"><span class='Ref_To_Local'>toast_delold</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="tuptoaster.c.html#LN546"><span class='Ref_To_Local'>need_delold</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * This attribute isn't changed by this update so we reuse 
                     * the original reference to the old value in the new 
                     * tuple. 
                     */ 
</span>                    <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if att[i]-&GT;attlen==-1&&!... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldtup!=NULL &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * For INSERT simply get the new value 
             */ 
</span>            <a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Handle NULL attributes 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN547"><span class='Ref_To_Local'>has_nulls</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now look at varlena attributes 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If the table's attribute says PLAIN always, force it so. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>                <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We took care of UPDATE above, so any external value we find 
             * still in the tuple must be someone else's that we cannot reuse 
             * (this includes the case of an out-of-line in-memory datum). 
             * Fetch it back (without decompression, unless we are forcing 
             * PLAIN storage).  If necessary, we'll push it out as a new 
             * external value below. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN557"><span class='Ref_To_Local'>toast_oldexternal</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>                    <a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN163"><span class='Ref_to_Proto'>heap_tuple_untoast_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN99"><span class='Ref_to_Func'>heap_tuple_fetch_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Remember the size of this attribute 
             */ 
</span>            <a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN609"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if att[i]-&GT;attlen==-1 &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Not a varlena attribute, plain storage always 
             */ 
</span>            <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;numAttrs;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ---------- 
     * Compress and/or save external until data fits into target length 
     * 
     *  1: Inline compress attributes with attstorage 'x', and store very 
     *     large attributes with attstorage 'x' or 'e' external immediately 
     *  2: Store attributes with attstorage 'x' or 'e' external 
     *  3: Inline compress attributes with attstorage 'm' 
     *  4: Store attributes with attstorage 'm' external 
     * ---------- 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* compute header overhead --- this should match heap_form_tuple() */ 
</span>    <a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN547"><span class='Ref_To_Local'>has_nulls</span></a><span class='Parentheses'>) 
</span>        <a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a> <span class='Operator'>+= </span><a href="../../../include/access/htup_details.h.html#LN547"><span class='Ref_to_Macro'>BITMAPLEN</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>) 
</span>        <a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* now convert to a limit on the tuple data size */ 
</span>    <a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN56"><span class='Ref_to_Const'>TOAST_TUPLE_TARGET</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look for attributes with attstorage 'x' to compress.  Also find large 
     * attributes with attstorage 'x' or 'e', and store them external. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../common/heaptuple.c.html#LN83"><span class='Ref_to_Func'>heap_compute_data_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                                  <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN741"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>biggest_attno</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN742"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>biggest_size</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN98"><span class='Ref_to_Const'>TOAST_POINTER_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN743"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>old_value</span><span class='Delimiter'>; 
</span><a name="LN744"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_value</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Search for the biggest yet unprocessed internal attribute 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>' '</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* can't happen, toast_action would be 'p' */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'x'</span> <span class='Operator'>&& </span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'e'</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN742"><span class='Ref_To_Local'>biggest_size</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN741"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN742"><span class='Ref_To_Local'>biggest_size</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN741"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Attempt to compress it inline, if it has attstorage 'x' 
         */ 
</span>        <a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN741"><span class='Ref_To_Local'>biggest_attno</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>== </span><span class='String'>'x'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tuptoaster.c.html#LN743"><span class='Ref_To_Local'>old_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="tuptoaster.c.html#LN744"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN212"><span class='Ref_to_Proto'>toast_compress_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN743"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN744"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* successful compression */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN743"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tuptoaster.c.html#LN744"><span class='Ref_To_Local'>new_value</span></a><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* incompressible, ignore on subsequent compression passes */ 
</span>                <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'x'</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if att[i]-&GT;attstorage=='... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* has attstorage 'e', ignore on subsequent compression passes */ 
</span>            <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'x'</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this value is by itself more than maxDataLen (after compression 
         * if any), push it out to the toast table immediately, if possible. 
         * This avoids uselessly compressing other fields in the common case 
         * where we have one long field and several short ones. 
         * 
         * XXX maybe the threshold should be less than maxDataLen? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a> <span class='Operator'>&& 
</span>            <a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tuptoaster.c.html#LN743"><span class='Ref_To_Local'>old_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tuptoaster.c.html#LN70"><span class='Ref_to_Proto'>toast_save_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                               <a href="tuptoaster.c.html#LN557"><span class='Ref_To_Local'>toast_oldexternal</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="tuptoaster.c.html#LN536"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN743"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while heap_compute_data_siz... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Second we look for attributes of attstorage 'x' or 'e' that are still 
     * inline.  But skip this if there's no toast table to push them to. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../common/heaptuple.c.html#LN83"><span class='Ref_to_Func'>heap_compute_data_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                                  <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a> <span class='Operator'>&& 
</span>           <a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN832"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>biggest_attno</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN833"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>biggest_size</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN98"><span class='Ref_to_Const'>TOAST_POINTER_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN834"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>old_value</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/*------ 
         * Search for the biggest yet inlined attribute with 
         * attstorage equals 'x' or 'e' 
         *------ 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* can't happen, toast_action would be 'p' */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'x'</span> <span class='Operator'>&& </span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'e'</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN833"><span class='Ref_To_Local'>biggest_size</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN832"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN833"><span class='Ref_To_Local'>biggest_size</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN832"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Store this external 
         */ 
</span>        <a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN832"><span class='Ref_To_Local'>biggest_attno</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN834"><span class='Ref_To_Local'>old_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tuptoaster.c.html#LN70"><span class='Ref_to_Proto'>toast_save_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                           <a href="tuptoaster.c.html#LN557"><span class='Ref_To_Local'>toast_oldexternal</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="tuptoaster.c.html#LN536"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN834"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while heap_compute_data_siz... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Round 3 - this time we take attributes with storage 'm' into 
     * compression 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../common/heaptuple.c.html#LN83"><span class='Ref_to_Func'>heap_compute_data_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                                  <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN882"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>biggest_attno</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN883"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>biggest_size</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN98"><span class='Ref_to_Const'>TOAST_POINTER_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN884"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>old_value</span><span class='Delimiter'>; 
</span><a name="LN885"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_value</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Search for the biggest yet uncompressed internal attribute 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>' '</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* can't happen, toast_action would be 'p' */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'m'</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN883"><span class='Ref_To_Local'>biggest_size</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN882"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN883"><span class='Ref_To_Local'>biggest_size</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN882"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Attempt to compress it inline 
         */ 
</span>        <a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN882"><span class='Ref_To_Local'>biggest_attno</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN884"><span class='Ref_To_Local'>old_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="tuptoaster.c.html#LN885"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN212"><span class='Ref_to_Proto'>toast_compress_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN884"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN885"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* successful compression */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN884"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tuptoaster.c.html#LN885"><span class='Ref_To_Local'>new_value</span></a><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* incompressible, ignore on subsequent compression passes */ 
</span>            <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'x'</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while heap_compute_data_siz... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Finally we store attributes of type 'm' externally.  At this point we 
     * increase the target tuple size, so that 'm' attributes aren't stored 
     * externally unless really necessary. 
     */ 
</span>    <a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN67"><span class='Ref_to_Const'>TOAST_TUPLE_TARGET_MAIN</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN550"><span class='Ref_To_Local'>hoff</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../common/heaptuple.c.html#LN83"><span class='Ref_to_Func'>heap_compute_data_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                                  <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN549"><span class='Ref_To_Local'>maxDataLen</span></a> <span class='Operator'>&& 
</span>           <a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN946"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>biggest_attno</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN947"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>biggest_size</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN98"><span class='Ref_to_Const'>TOAST_POINTER_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN948"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>old_value</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/*-------- 
         * Search for the biggest yet inlined attribute with 
         * attstorage = 'm' 
         *-------- 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* can't happen, toast_action would be 'p' */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN540"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'m'</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN947"><span class='Ref_To_Local'>biggest_size</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN946"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN947"><span class='Ref_To_Local'>biggest_size</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN558"><span class='Ref_To_Local'>toast_sizes</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN946"><span class='Ref_To_Local'>biggest_attno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Store this external 
         */ 
</span>        <a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN946"><span class='Ref_To_Local'>biggest_attno</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN948"><span class='Ref_To_Local'>old_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="tuptoaster.c.html#LN552"><span class='Ref_To_Local'>toast_action</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tuptoaster.c.html#LN70"><span class='Ref_to_Proto'>toast_save_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                           <a href="tuptoaster.c.html#LN557"><span class='Ref_To_Local'>toast_oldexternal</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="tuptoaster.c.html#LN536"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN948"><span class='Ref_To_Local'>old_value</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while heap_compute_data_siz... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * In the case we toasted any values, we need to build a new heap tuple 
     * with the changed values. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN544"><span class='Ref_To_Local'>need_change</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN995"></a>        <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>olddata</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>; 
</span><a name="LN996"></a>        <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>new_data</span><span class='Delimiter'>; 
</span><a name="LN997"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>new_header_len</span><span class='Delimiter'>; 
</span><a name="LN998"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>new_data_len</span><span class='Delimiter'>; 
</span><a name="LN999"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>new_tuple_len</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate the new size of the tuple. 
         * 
         * Note: we used to assume here that the old tuple's t_hoff must equal 
         * the new_header_len value, but that was incorrect.  The old tuple 
         * might have a smaller-than-current natts, if there's been an ALTER 
         * TABLE ADD COLUMN since it was stored; and that would lead to a 
         * different conclusion about the size of the null bitmap, or even 
         * whether there needs to be one at all. 
         */ 
</span>        <a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN547"><span class='Ref_To_Local'>has_nulls</span></a><span class='Parentheses'>) 
</span>            <a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>+= </span><a href="../../../include/access/htup_details.h.html#LN547"><span class='Ref_to_Macro'>BITMAPLEN</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN995"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>) 
</span>            <a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN998"><span class='Ref_To_Local'>new_data_len</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN83"><span class='Ref_to_Func'>heap_compute_data_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                                              <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN999"><span class='Ref_To_Local'>new_tuple_len</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN998"><span class='Ref_To_Local'>new_data_len</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allocate and zero the space needed, and fill HeapTupleData fields. 
         */ 
</span>        <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN71"><span class='Ref_to_Const'>HEAPTUPLESIZE</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN999"><span class='Ref_To_Local'>new_tuple_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN999"><span class='Ref_To_Local'>new_tuple_len</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup.h.html#LN71"><span class='Ref_to_Const'>HEAPTUPLESIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Copy the existing tuple header, but adjust natts and t_hoff. 
         */ 
</span>        memcpy<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN995"><span class='Ref_To_Local'>olddata</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN534"><span class='Ref_to_Macro'>HeapTupleHeaderSetNatts</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN995"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/htup_details.h.html#LN472"><span class='Ref_to_Macro'>HeapTupleHeaderSetOid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN464"><span class='Ref_to_Macro'>HeapTupleHeaderGetOid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN995"><span class='Ref_To_Local'>olddata</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Copy over the data, and fill the null bitmap if needed */ 
</span>        <a href="../common/heaptuple.c.html#LN144"><span class='Ref_to_Func'>heap_fill_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN539"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN553"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN997"><span class='Ref_To_Local'>new_header_len</span></a><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN998"><span class='Ref_To_Local'>new_data_len</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN547"><span class='Ref_To_Local'>has_nulls</span></a> <span class='Operator'>? </span><a href="tuptoaster.c.html#LN996"><span class='Ref_To_Local'>new_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN162"><span class='Ref_to_Member'>t_bits</span></a> <span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if need_change &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free allocated temp values 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN545"><span class='Ref_To_Local'>need_free</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN559"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN555"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete external values from the old tuple 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN546"><span class='Ref_To_Local'>need_delold</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN541"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN560"><span class='Ref_To_Local'>toast_delold</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <a href="tuptoaster.c.html#LN69"><span class='Ref_to_Proto'>toast_delete_datum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN535"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN556"><span class='Ref_To_Local'>toast_oldvalues</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN542"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN538"><span class='Ref_To_Local'>result_tuple</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_insert_or_update &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_flatten_tuple - 
 * 
 *  "Flatten" a tuple to contain no out-of-line toasted fields. 
 *  (This does not eliminate compressed or short-header datums.) 
 * 
 *  Note: we expect the caller already checked HeapTupleHasExternal(tup), 
 *  so there is no need for a short-circuit path. 
 * ---------- 
 */ 
</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN1083"></a><span class='Declare_Function'>toast_flatten_tuple</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupleDesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1085"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_tuple</span><span class='Delimiter'>; 
</span><a name="LN1086"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>; 
</span><a name="LN1087"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numAttrs</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN1088"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1089"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>toast_values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN1090"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_isnull</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN1091"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_free</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Break down the tuple into fields. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1087"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1089"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1090"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1091"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1087"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1087"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Look at non-null varlena attributes 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN1090"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&& </span><a href="tuptoaster.c.html#LN1086"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1108"></a>            <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_value</span><span class='Delimiter'>; 
</span> 
            <a href="tuptoaster.c.html#LN1108"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1089"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1108"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN1108"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN99"><span class='Ref_to_Func'>heap_tuple_fetch_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1108"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN1089"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1108"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN1091"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Form the reconfigured tuple. 
     */ 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1089"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1090"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Be sure to copy the tuple's OID and identity fields.  We also make a 
     * point of copying visibility info, just in case anybody looks at those 
     * fields in a syscache entry. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN78"><span class='Ref_to_Member'>tdhasoid</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN697"><span class='Ref_to_Macro'>HeapTupleSetOid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN147"><span class='Ref_to_Member'>t_choice</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN147"><span class='Ref_to_Member'>t_choice</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN149"><span class='Ref_to_Member'>t_ctid</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN203"><span class='Ref_to_Const'>HEAP_XACT_MASK</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>|= 
</span>        <a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN203"><span class='Ref_to_Const'>HEAP_XACT_MASK</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/htup_details.h.html#LN268"><span class='Ref_to_Const'>HEAP2_XACT_MASK</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>|= 
</span>        <a href="tuptoaster.c.html#LN1083"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN154"><span class='Ref_to_Member'>t_infomask2</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN268"><span class='Ref_to_Const'>HEAP2_XACT_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free allocated temp values 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1087"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1091"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1089"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1088"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN1085"><span class='Ref_To_Local'>new_tuple</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_flatten_tuple &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_flatten_tuple_to_datum - 
 * 
 *  "Flatten" a tuple containing out-of-line toasted fields into a Datum. 
 *  The result is always palloc'd in the current memory context. 
 * 
 *  We have a general rule that Datums of container types (rows, arrays, 
 *  ranges, etc) must not contain any external TOAST pointers.  Without 
 *  this rule, we'd have to look inside each Datum when preparing a tuple 
 *  for storage, which would be expensive and would fail to extend cleanly 
 *  to new sorts of container types. 
 * 
 *  However, we don't want to say that tuples represented as HeapTuples 
 *  can't contain toasted fields, so instead this routine should be called 
 *  when such a HeapTuple is being converted into a Datum. 
 * 
 *  While we're at it, we decompress any compressed fields too.  This is not 
 *  necessary for correctness, but reflects an expectation that compression 
 *  will be more effective if applied to the whole tuple not individual 
 *  fields.  We are not so concerned about that that we want to deconstruct 
 *  and reconstruct tuples just to get rid of compressed fields, however. 
 *  So callers typically won't call this unless they see that the tuple has 
 *  at least one external field. 
 * 
 *  On the other hand, in-line short-header varlena fields are left alone. 
 *  If we "untoasted" them here, they'd just get changed back to short-header 
 *  format anyway within heap_fill_tuple. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1186"></a><span class='Declare_Function'>toast_flatten_tuple_to_datum</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN1187"></a>                             <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>tup_len</span><span class='Delimiter'>, 
</span><a name="LN1188"></a>                             <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupleDesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1190"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>new_data</span><span class='Delimiter'>; 
</span><a name="LN1191"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>new_header_len</span><span class='Delimiter'>; 
</span><a name="LN1192"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>new_data_len</span><span class='Delimiter'>; 
</span><a name="LN1193"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>new_tuple_len</span><span class='Delimiter'>; 
</span><a name="LN1194"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tmptup</span><span class='Delimiter'>; 
</span><a name="LN1195"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>; 
</span><a name="LN1196"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numAttrs</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN1197"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1198"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_nulls</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1199"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>toast_values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN1200"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_isnull</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN1201"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>toast_free</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Build a temporary HeapTuple control structure */ 
</span>    <a href="tuptoaster.c.html#LN1194"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1187"><span class='Ref_to_Parameter'>tup_len</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1194"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1194"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1194"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1186"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Break down the tuple into fields. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1196"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1194"><span class='Ref_To_Local'>tmptup</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1199"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1200"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1201"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1196"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1196"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Look at non-null varlena attributes 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1200"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="tuptoaster.c.html#LN1198"><span class='Ref_To_Local'>has_nulls</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1195"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1226"></a>            <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_value</span><span class='Delimiter'>; 
</span> 
            <a href="tuptoaster.c.html#LN1226"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1199"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1226"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1226"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN1226"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="../../../include/access/tuptoaster.h.html#LN163"><span class='Ref_to_Proto'>heap_tuple_untoast_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1226"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN1199"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1226"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN1201"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;numAttrs;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Calculate the new size of the tuple. 
     * 
     * This should match the reconstruction code in toast_insert_or_update. 
     */ 
</span>    <a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1198"><span class='Ref_To_Local'>has_nulls</span></a><span class='Parentheses'>) 
</span>        <a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>+= </span><a href="../../../include/access/htup_details.h.html#LN547"><span class='Ref_to_Macro'>BITMAPLEN</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1196"><span class='Ref_To_Local'>numAttrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1186"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>) 
</span>        <a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1192"><span class='Ref_To_Local'>new_data_len</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN83"><span class='Ref_to_Func'>heap_compute_data_size</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                                          <a href="tuptoaster.c.html#LN1199"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1200"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1193"><span class='Ref_To_Local'>new_tuple_len</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN1192"><span class='Ref_To_Local'>new_data_len</span></a><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1193"><span class='Ref_To_Local'>new_tuple_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy the existing tuple header, but adjust natts and t_hoff. 
     */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1186"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN534"><span class='Ref_to_Macro'>HeapTupleHeaderSetNatts</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1196"><span class='Ref_To_Local'>numAttrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN158"><span class='Ref_to_Member'>t_hoff</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1186"><span class='Ref_to_Parameter'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a> <span class='Operator'>& </span><a href="../../../include/access/htup_details.h.html#LN177"><span class='Ref_to_Const'>HEAP_HASOID</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/htup_details.h.html#LN472"><span class='Ref_to_Macro'>HeapTupleHeaderSetOid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="../../../include/access/htup_details.h.html#LN464"><span class='Ref_to_Macro'>HeapTupleHeaderGetOid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1186"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set the composite-Datum header fields correctly */ 
</span>    <a href="../../../include/access/htup_details.h.html#LN441"><span class='Ref_to_Macro'>HeapTupleHeaderSetDatumLength</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1193"><span class='Ref_To_Local'>new_tuple_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN449"><span class='Ref_to_Macro'>HeapTupleHeaderSetTypeId</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN76"><span class='Ref_to_Member'>tdtypeid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/htup_details.h.html#LN459"><span class='Ref_to_Macro'>HeapTupleHeaderSetTypMod</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN77"><span class='Ref_to_Member'>tdtypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy over the data, and fill the null bitmap if needed */ 
</span>    <a href="../common/heaptuple.c.html#LN144"><span class='Ref_to_Func'>heap_fill_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1188"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Delimiter'>, 
</span>                    <a href="tuptoaster.c.html#LN1199"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>, 
</span>                    <a href="tuptoaster.c.html#LN1200"><span class='Ref_To_Local'>toast_isnull</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN1191"><span class='Ref_To_Local'>new_header_len</span></a><span class='Delimiter'>, 
</span>                    <a href="tuptoaster.c.html#LN1192"><span class='Ref_To_Local'>new_data_len</span></a><span class='Delimiter'>, 
</span>                    <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN156"><span class='Ref_to_Member'>t_infomask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="tuptoaster.c.html#LN1198"><span class='Ref_To_Local'>has_nulls</span></a> <span class='Operator'>? </span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup_details.h.html#LN162"><span class='Ref_to_Member'>t_bits</span></a> <span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free allocated temp values 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1196"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1201"><span class='Ref_To_Local'>toast_free</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1199"><span class='Ref_To_Local'>toast_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1190"><span class='Ref_To_Local'>new_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_flatten_tuple_to_datum &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_build_flattened_tuple - 
 * 
 *  Build a tuple containing no out-of-line toasted fields. 
 *  (This does not eliminate compressed or short-header datums.) 
 * 
 *  This is essentially just like heap_form_tuple, except that it will 
 *  expand any external-data pointers beforehand. 
 * 
 *  It's not very clear whether it would be preferable to decompress 
 *  in-line compressed datums while at it.  For now, we don't. 
 * ---------- 
 */ 
</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> 
<a name="LN1304"></a><span class='Declare_Function'>toast_build_flattened_tuple</span><span class='Parentheses'>(</span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupleDesc</span><span class='Delimiter'>, 
</span><a name="LN1305"></a>                            <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, 
</span><a name="LN1306"></a>                            <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1308"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_tuple</span><span class='Delimiter'>; 
</span><a name="LN1309"></a>    <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1304"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>; 
</span><a name="LN1310"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numAttrs</span> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1304"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN1311"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_to_free</span><span class='Delimiter'>; 
</span><a name="LN1312"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1313"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN1314"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>freeable_values</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can pass the caller's isnull array directly to heap_form_tuple, but 
     * we potentially need to modify the values array. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1310"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1313"><span class='Ref_To_Local'>new_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1305"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1310"><span class='Ref_To_Local'>numAttrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1311"><span class='Ref_To_Local'>num_to_free</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1310"><span class='Ref_To_Local'>numAttrs</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Look at non-null varlena attributes 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN1306"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&& </span><a href="tuptoaster.c.html#LN1309"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1331"></a>            <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_value</span><span class='Delimiter'>; 
</span> 
            <a href="tuptoaster.c.html#LN1331"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1313"><span class='Ref_To_Local'>new_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1331"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN1331"><span class='Ref_To_Local'>new_value</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN99"><span class='Ref_to_Func'>heap_tuple_fetch_attr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1331"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN1313"><span class='Ref_To_Local'>new_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1331"><span class='Ref_To_Local'>new_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tuptoaster.c.html#LN1314"><span class='Ref_To_Local'>freeable_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1311"><span class='Ref_To_Local'>num_to_free</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="tuptoaster.c.html#LN1331"><span class='Ref_To_Local'>new_value</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Form the reconfigured tuple. 
     */ 
</span>    <a href="tuptoaster.c.html#LN1308"><span class='Ref_To_Local'>new_tuple</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1304"><span class='Ref_to_Parameter'>tupleDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1313"><span class='Ref_To_Local'>new_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1306"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free allocated temp values 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1311"><span class='Ref_To_Local'>num_to_free</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1314"><span class='Ref_To_Local'>freeable_values</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN1308"><span class='Ref_To_Local'>new_tuple</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_build_flattened_tuple &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_compress_datum - 
 * 
 *  Create a compressed version of a varlena datum 
 * 
 *  If we fail (ie, compressed result is actually bigger than original) 
 *  then return NULL.  We must not use compressed data if it'd expand 
 *  the tuple! 
 * 
 *  We use VAR{SIZE,DATA}_ANY so we can handle short varlenas here without 
 *  copying them.  But we can't handle external or compressed datums. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1372"></a><span class='Declare_Function'>toast_compress_datum</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1374"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span><a name="LN1375"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>valsize</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN339"><span class='Ref_to_Macro'>VARSIZE_ANY_EXHDR</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN1376"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No point in wasting a palloc cycle if value size is out of the allowed 
     * range for compression 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1375"><span class='Ref_To_Local'>valsize</span></a> <span class='Operator'>&LT; </span><a href="../../../common/pg_lzcompress.c.html#LN229"><span class='Ref_to_Global_Var'>PGLZ_strategy_default</span></a><span class='Operator'>-&GT;</span><a href="../../../include/common/pg_lzcompress.h.html#LN58"><span class='Ref_to_Member'>min_input_size</span></a> <span class='Operator'>|| 
</span>        <a href="tuptoaster.c.html#LN1375"><span class='Ref_To_Local'>valsize</span></a> <span class='Operator'>&GT; </span><a href="../../../common/pg_lzcompress.c.html#LN229"><span class='Ref_to_Global_Var'>PGLZ_strategy_default</span></a><span class='Operator'>-&GT;</span><a href="../../../include/common/pg_lzcompress.h.html#LN59"><span class='Ref_to_Member'>max_input_size</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1374"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/common/pg_lzcompress.h.html#LN20"><span class='Ref_to_Macro'>PGLZ_MAX_OUTPUT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1375"><span class='Ref_To_Local'>valsize</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                    <a href="tuptoaster.c.html#LN62"><span class='Ref_to_Const'>TOAST_COMPRESS_HDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We recheck the actual size even if pglz_compress() reports success, 
     * because it might be satisfied with having saved as little as one byte 
     * in the compressed data --- which could turn into a net loss once you 
     * consider header and alignment padding.  Worst case, the compressed 
     * format might require three padding bytes (plus header, which is 
     * included in VARSIZE(tmp)), whereas the uncompressed format would take 
     * only one header byte and no padding if the value is short enough.  So 
     * we insist on a savings of more than 2 bytes to ensure we have a gain. 
     */ 
</span>    <a href="tuptoaster.c.html#LN1376"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../include/common/pg_lzcompress.h.html#LN85"><span class='Ref_to_Proto'>pglz_compress</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN346"><span class='Ref_to_Macro'>VARDATA_ANY</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN1375"><span class='Ref_To_Local'>valsize</span></a><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN64"><span class='Ref_to_Macro'>TOAST_COMPRESS_RAWDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1374"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../common/pg_lzcompress.c.html#LN229"><span class='Ref_to_Global_Var'>PGLZ_strategy_default</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1376"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <a href="tuptoaster.c.html#LN1376"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN62"><span class='Ref_to_Const'>TOAST_COMPRESS_HDRSZ</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1375"><span class='Ref_To_Local'>valsize</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN66"><span class='Ref_to_Macro'>TOAST_COMPRESS_SET_RAWSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1374"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1375"><span class='Ref_To_Local'>valsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/postgres.h.html#LN329"><span class='Ref_to_Macro'>SET_VARSIZE_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1374"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1376"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN62"><span class='Ref_to_Const'>TOAST_COMPRESS_HDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* successful compression */ 
</span>        <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1374"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* incompressible data */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1374"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end toast_compress_datum &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_get_valid_index 
 * 
 *  Get OID of valid index associated to given toast relation. A toast 
 *  relation can have only one valid index at the same time. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1430"></a><span class='Declare_Function'>toast_get_valid_index</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastoid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1432"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_indexes</span><span class='Delimiter'>; 
</span><a name="LN1433"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>validIndex</span><span class='Delimiter'>; 
</span><a name="LN1434"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>validIndexOid</span><span class='Delimiter'>; 
</span><a name="LN1435"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Delimiter'>; 
</span><a name="LN1436"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open the toast relation */ 
</span>    <a href="tuptoaster.c.html#LN1436"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1430"><span class='Ref_to_Parameter'>toastoid</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1430"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look for the valid index of the toast relation */ 
</span>    <a href="tuptoaster.c.html#LN1433"><span class='Ref_To_Local'>validIndex</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN78"><span class='Ref_to_Proto'>toast_open_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1436"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                    <a href="tuptoaster.c.html#LN1430"><span class='Ref_to_Parameter'>lock</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1435"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1432"><span class='Ref_To_Local'>num_indexes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1434"><span class='Ref_To_Local'>validIndexOid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1435"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1433"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close the toast relation and all its indexes */ 
</span>    <a href="tuptoaster.c.html#LN82"><span class='Ref_to_Proto'>toast_close_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1435"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1432"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1430"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1436"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1430"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN1434"><span class='Ref_To_Local'>validIndexOid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_get_valid_index &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_save_datum - 
 * 
 *  Save one single datum into the secondary relation and return 
 *  a Datum reference for it. 
 * 
 * rel: the main relation we're working with (not the toast rel!) 
 * value: datum to be pushed to toast storage 
 * oldexternal: if not NULL, toast pointer previously representing the datum 
 * options: options to be passed to heap_insert() for toast rows 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1469"></a><span class='Declare_Function'>toast_save_datum</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, 
</span><a name="LN1470"></a>                 <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>oldexternal</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1472"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span><a name="LN1473"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Delimiter'>; 
</span><a name="LN1474"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>toasttup</span><span class='Delimiter'>; 
</span><a name="LN1475"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>toasttupDesc</span><span class='Delimiter'>; 
</span><a name="LN1476"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>t_values</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN1477"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>t_isnull</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN1478"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Local'>mycid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1479"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1480"></a>    <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1483"></a>        <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* this is to make the union big enough for a chunk: */ 
</span><a name="LN1485"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>data</span><span class='Delimiter'>[</span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>]; 
</span>        <span class='Comment_Multi_Line'>/* ensure union is aligned well enough: */ 
</span><a name="LN1487"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>align_it</span><span class='Delimiter'>; 
</span><a name="LN1488"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>chunk_data</span><span class='Delimiter'>; 
</span><a name="LN1489"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chunk_size</span><span class='Delimiter'>; 
</span><a name="LN1490"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chunk_seq</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1491"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data_p</span><span class='Delimiter'>; 
</span><a name="LN1492"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>data_todo</span><span class='Delimiter'>; 
</span><a name="LN1493"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>dval</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1494"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_indexes</span><span class='Delimiter'>; 
</span><a name="LN1495"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>validIndex</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the toast relation and its indexes.  We can use the index to check 
     * uniqueness of the OID we assign to the toasted item, even though it has 
     * additional columns besides OID. 
     */ 
</span>    <a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1475"><span class='Ref_To_Local'>toasttupDesc</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open all the toast indexes and look for the valid one */ 
</span>    <a href="tuptoaster.c.html#LN1495"><span class='Ref_To_Local'>validIndex</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN78"><span class='Ref_to_Proto'>toast_open_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1494"><span class='Ref_To_Local'>num_indexes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the data pointer and length, and compute va_rawsize and va_extsize. 
     * 
     * va_rawsize is the size of the equivalent fully uncompressed datum, so 
     * we have to adjust for short headers. 
     * 
     * va_extsize is the actual size of the data payload in the toast records. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN1491"><span class='Ref_To_Local'>data_p</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN306"><span class='Ref_to_Macro'>VARDATA_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN69"><span class='Ref_to_Member'>va_rawsize</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* as if not short */ 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN1491"><span class='Ref_To_Local'>data_p</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* rawsize in a compressed datum is just the size of the payload */ 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN69"><span class='Ref_to_Member'>va_rawsize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN283"><span class='Ref_to_Macro'>VARRAWSIZE_4B_C</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Assert that the numbers look like it's compressed */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN110"><span class='Ref_to_Macro'>VARATT_EXTERNAL_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN1491"><span class='Ref_To_Local'>data_p</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN69"><span class='Ref_to_Member'>va_rawsize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1493"><span class='Ref_To_Local'>dval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insert the correct table OID into the result TOAST pointer. 
     * 
     * Normally this is the actual OID of the target toast table, but during 
     * table-rewriting operations such as CLUSTER, we have to insert the OID 
     * of the table's real permanent toast table instead.  rd_toastoid is set 
     * if we have to substitute such an OID. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN214"><span class='Ref_to_Member'>rd_toastoid</span></a><span class='Parentheses'>))</span> 
        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN72"><span class='Ref_to_Member'>va_toastrelid</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN214"><span class='Ref_to_Member'>rd_toastoid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN72"><span class='Ref_to_Member'>va_toastrelid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Choose an OID to use as the value ID for this toast value. 
     * 
     * Normally we just choose an unused OID within the toast table.  But 
     * during table-rewriting operations where we are preserving an existing 
     * toast table OID, we want to preserve toast value OIDs too.  So, if 
     * rd_toastoid is set and we had a prior external value from that same 
     * toast table, re-use its value ID.  If we didn't have a prior external 
     * value (which is a corner case, but possible if the table's attstorage 
     * options have been changed), we have to pick a value ID that doesn't 
     * conflict with either new or existing toast value OIDs. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN214"><span class='Ref_to_Member'>rd_toastoid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* normal case: just choose an unused OID */ 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/catalog/catalog.h.html#LN45"><span class='Ref_to_Proto'>GetNewOidWithIndex</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1495"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* rewrite case: check to see if value was in old toast table */ 
</span>        <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1470"><span class='Ref_to_Parameter'>oldexternal</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1585"></a>            <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>old_toast_pointer</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1470"><span class='Ref_to_Parameter'>oldexternal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Must copy to access aligned fields */ 
</span>            <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1585"><span class='Ref_To_Local'>old_toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1470"><span class='Ref_to_Parameter'>oldexternal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1585"><span class='Ref_To_Local'>old_toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN72"><span class='Ref_to_Member'>va_toastrelid</span></a> <span class='Operator'>== </span><a href="tuptoaster.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN214"><span class='Ref_to_Member'>rd_toastoid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* This value came from the old toast table; reuse its OID */ 
</span>                <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1585"><span class='Ref_To_Local'>old_toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * There is a corner case here: the table rewrite might have 
                 * to copy both live and recently-dead versions of a row, and 
                 * those versions could easily reference the same toast value. 
                 * When we copy the second or later version of such a row, 
                 * reusing the OID will mean we select an OID that's already 
                 * in the new toast table.  Check for that, and if so, just 
                 * fall through without writing the data again. 
                 * 
                 * While annoying and ugly-looking, this is a good thing 
                 * because it ensures that we wind up with only one copy of 
                 * the toast value when there is only one copy in the old 
                 * toast table.  Before we detected this case, we'd have made 
                 * multiple copies, wasting space; and what's worse, the 
                 * copies belonging to already-deleted heap tuples would not 
                 * be reclaimed by VACUUM. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN72"><span class='Ref_to_Proto'>toastrel_valueid_exists</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                            <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Match, so short-circuit the data storage loop below */ 
</span>                    <a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if old_toast_pointer.va_... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldexternal!=NULL &raquo; </span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * new value; must choose an OID that doesn't conflict in either 
             * old or new toast table 
             */ 
</span>            <span class='Control'>do</span> 
            <span class='Delimiter'>{ 
</span>                <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a> <span class='Operator'>= 
</span>                    <a href="../../../include/catalog/catalog.h.html#LN45"><span class='Ref_to_Proto'>GetNewOidWithIndex</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1495"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN73"><span class='Ref_to_Proto'>toastid_valueid_exists</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1469"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN214"><span class='Ref_to_Member'>rd_toastoid</span></a><span class='Delimiter'>, 
</span>                                            <a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Initialize constant parts of the tuple data 
     */ 
</span>    <a href="tuptoaster.c.html#LN1476"><span class='Ref_To_Local'>t_values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1476"><span class='Ref_To_Local'>t_values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1488"><span class='Ref_To_Local'>chunk_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1477"><span class='Ref_To_Local'>t_isnull</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1477"><span class='Ref_To_Local'>t_isnull</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1477"><span class='Ref_To_Local'>t_isnull</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Split up the item into chunks 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1651"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate the size of this chunk 
         */ 
</span>        <a href="tuptoaster.c.html#LN1489"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Build a tuple and store it 
         */ 
</span>        <a href="tuptoaster.c.html#LN1476"><span class='Ref_To_Local'>t_values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1490"><span class='Ref_To_Local'>chunk_seq</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1488"><span class='Ref_To_Local'>chunk_data</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1489"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1488"><span class='Ref_To_Local'>chunk_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1491"><span class='Ref_To_Local'>data_p</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1489"><span class='Ref_To_Local'>chunk_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1474"><span class='Ref_To_Local'>toasttup</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1475"><span class='Ref_To_Local'>toasttupDesc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1476"><span class='Ref_To_Local'>t_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1477"><span class='Ref_To_Local'>t_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/heapam.h.html#LN151"><span class='Ref_to_Proto'>heap_insert</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1474"><span class='Ref_To_Local'>toasttup</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1478"><span class='Ref_To_Local'>mycid</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1470"><span class='Ref_to_Parameter'>options</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create the index entry.  We cheat a little here by not using 
         * FormIndexDatum: this relies on the knowledge that the index columns 
         * are the same as the initial columns of the table for all the 
         * indexes.  We also cheat by not providing an IndexInfo: this is okay 
         * for now because btree doesn't need one, but we might have to be 
         * more honest someday. 
         * 
         * Note also that there had better not be any user-created index on 
         * the TOAST table, since we don't bother to update anything else. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1651"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1651"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1494"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN1651"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Only index relations marked as ready can be updated */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/catalog/pg_index.h.html#LN107"><span class='Ref_to_Macro'>IndexIsReady</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1651"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN158"><span class='Ref_to_Member'>rd_index</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/access/genam.h.html#LN132"><span class='Ref_to_Proto'>index_insert</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1651"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="tuptoaster.c.html#LN1476"><span class='Ref_To_Local'>t_values</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1477"><span class='Ref_To_Local'>t_isnull</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1474"><span class='Ref_To_Local'>toasttup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                             <a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1651"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN158"><span class='Ref_to_Member'>rd_index</span></a><span class='Operator'>-&GT;</span>indisunique <span class='Operator'>? 
</span>                             <a href="../../../include/access/genam.h.html#LN113"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_YES</span></a> <span class='Operator'>: </span><a href="../../../include/access/genam.h.html#LN112"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_NO</span></a><span class='Delimiter'>, 
</span>                             <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Free memory 
         */ 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1474"><span class='Ref_To_Local'>toasttup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Move on to next chunk 
         */ 
</span>        <a href="tuptoaster.c.html#LN1492"><span class='Ref_To_Local'>data_todo</span></a> <span class='Operator'>-= </span><a href="tuptoaster.c.html#LN1489"><span class='Ref_To_Local'>chunk_size</span></a><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1491"><span class='Ref_To_Local'>data_p</span></a> <span class='Operator'>+= </span><a href="tuptoaster.c.html#LN1489"><span class='Ref_To_Local'>chunk_size</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while data_todo&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Done - close toast relation and its indexes 
     */ 
</span>    <a href="tuptoaster.c.html#LN82"><span class='Ref_to_Proto'>toast_close_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1473"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1494"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1472"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the TOAST pointer value that we'll return 
     */ 
</span>    <a href="tuptoaster.c.html#LN1479"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN98"><span class='Ref_to_Const'>TOAST_POINTER_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postgres.h.html#LN331"><span class='Ref_to_Macro'>SET_VARTAG_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1479"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN116"><span class='Ref_to_EnumConst'>VARTAG_ONDISK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN310"><span class='Ref_to_Macro'>VARDATA_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1479"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1480"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1479"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_save_datum &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_delete_datum - 
 * 
 *  Delete a single external stored value. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1729"></a><span class='Declare_Function'>toast_delete_datum</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_speculative</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1731"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1732"></a>    <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span><a name="LN1733"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span><a name="LN1734"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Delimiter'>; 
</span><a name="LN1735"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>toastkey</span><span class='Delimiter'>; 
</span><a name="LN1736"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>toastscan</span><span class='Delimiter'>; 
</span><a name="LN1737"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>toasttup</span><span class='Delimiter'>; 
</span><a name="LN1738"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_indexes</span><span class='Delimiter'>; 
</span><a name="LN1739"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>validIndex</span><span class='Delimiter'>; 
</span><a name="LN1740"></a>    <a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Local'>SnapshotToast</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1731"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must copy to access aligned fields */ 
</span>    <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1732"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1731"><span class='Ref_To_Local'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the toast relation and its indexes 
     */ 
</span>    <a href="tuptoaster.c.html#LN1733"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1732"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN72"><span class='Ref_to_Member'>va_toastrelid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch valid relation used for process */ 
</span>    <a href="tuptoaster.c.html#LN1739"><span class='Ref_To_Local'>validIndex</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN78"><span class='Ref_to_Proto'>toast_open_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1733"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1734"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1738"><span class='Ref_To_Local'>num_indexes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup a scan key to find chunks with matching va_valueid 
     */ 
</span>    <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1735"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1732"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find all the chunks.  (We don't actually care whether we see them in 
     * sequence or not, but since we've already locked the index we might as 
     * well use systable_beginscan_ordered.) 
     */ 
</span>    <a href="tuptoaster.c.html#LN84"><span class='Ref_to_Proto'>init_toast_snapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1740"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1736"><span class='Ref_To_Local'>toastscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1733"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1734"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1739"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>], 
</span>                                           <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1740"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1735"><span class='Ref_To_Local'>toastkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN1737"><span class='Ref_To_Local'>toasttup</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1736"><span class='Ref_To_Local'>toastscan</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Have a chunk, delete it 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1729"><span class='Ref_to_Parameter'>is_speculative</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/heapam.h.html#LN159"><span class='Ref_to_Proto'>heap_abort_speculative</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1733"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1737"><span class='Ref_To_Local'>toasttup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/access/heapam.h.html#LN176"><span class='Ref_to_Proto'>simple_heap_delete</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1733"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1737"><span class='Ref_To_Local'>toasttup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * End scan and close relations 
     */ 
</span>    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1736"><span class='Ref_To_Local'>toastscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN82"><span class='Ref_to_Proto'>toast_close_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1734"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1738"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1733"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_delete_datum &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toastrel_valueid_exists - 
 * 
 *  Test whether a toast value with the given ID exists in the toast relation 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1802"></a><span class='Declare_Function'>toastrel_valueid_exists</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>toastrel</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>valueid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1804"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1805"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>toastkey</span><span class='Delimiter'>; 
</span><a name="LN1806"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>toastscan</span><span class='Delimiter'>; 
</span><a name="LN1807"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_indexes</span><span class='Delimiter'>; 
</span><a name="LN1808"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>validIndex</span><span class='Delimiter'>; 
</span><a name="LN1809"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Delimiter'>; 
</span><a name="LN1810"></a>    <a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Local'>SnapshotToast</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch a valid index relation */ 
</span>    <a href="tuptoaster.c.html#LN1808"><span class='Ref_To_Local'>validIndex</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN78"><span class='Ref_to_Proto'>toast_open_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1802"><span class='Ref_to_Parameter'>toastrel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1809"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1807"><span class='Ref_To_Local'>num_indexes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup a scan key to find chunks with matching va_valueid 
     */ 
</span>    <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1805"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1802"><span class='Ref_to_Parameter'>valueid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Is there any such chunk? 
     */ 
</span>    <a href="tuptoaster.c.html#LN84"><span class='Ref_to_Proto'>init_toast_snapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1810"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1806"><span class='Ref_To_Local'>toastscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1802"><span class='Ref_to_Parameter'>toastrel</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1809"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1808"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1810"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1805"><span class='Ref_To_Local'>toastkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1806"><span class='Ref_To_Local'>toastscan</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="tuptoaster.c.html#LN1804"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1806"><span class='Ref_To_Local'>toastscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up */ 
</span>    <a href="tuptoaster.c.html#LN82"><span class='Ref_to_Proto'>toast_close_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1809"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1807"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN1804"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toastrel_valueid_exists &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toastid_valueid_exists - 
 * 
 *  As above, but work from toast rel's OID not an open relation 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1852"></a><span class='Declare_Function'>toastid_valueid_exists</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastrelid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>valueid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1854"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1855"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1855"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1852"><span class='Ref_to_Parameter'>toastrelid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1854"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN72"><span class='Ref_to_Proto'>toastrel_valueid_exists</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1855"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1852"><span class='Ref_to_Parameter'>valueid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1855"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN1854"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_fetch_datum - 
 * 
 *  Reconstruct an in memory Datum from the chunks saved 
 *  in the toast relation 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* 
</span><a name="LN1875"></a><span class='Declare_Function'>toast_fetch_datum</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1877"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span><a name="LN1878"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Delimiter'>; 
</span><a name="LN1879"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>toastkey</span><span class='Delimiter'>; 
</span><a name="LN1880"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>toastscan</span><span class='Delimiter'>; 
</span><a name="LN1881"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>ttup</span><span class='Delimiter'>; 
</span><a name="LN1882"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>toasttupDesc</span><span class='Delimiter'>; 
</span><a name="LN1883"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1884"></a>    <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span><a name="LN1885"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>ressize</span><span class='Delimiter'>; 
</span><a name="LN1886"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>residx</span><span class='Delimiter'>, 
</span><a name="LN1887"></a>                <span class='Declare_Local'>nextidx</span><span class='Delimiter'>; 
</span><a name="LN1888"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>numchunks</span><span class='Delimiter'>; 
</span><a name="LN1889"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span><a name="LN1890"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN1891"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>chunkdata</span><span class='Delimiter'>; 
</span><a name="LN1892"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chunksize</span><span class='Delimiter'>; 
</span><a name="LN1893"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_indexes</span><span class='Delimiter'>; 
</span><a name="LN1894"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>validIndex</span><span class='Delimiter'>; 
</span><a name="LN1895"></a>    <a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Local'>SnapshotToast</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1875"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"toast_fetch_datum shouldn't be called for non-ondisk datums"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must copy to access aligned fields */ 
</span>    <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1875"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1888"><span class='Ref_To_Local'>numchunks</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN1883"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN110"><span class='Ref_to_Macro'>VARATT_EXTERNAL_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/postgres.h.html#LN329"><span class='Ref_to_Macro'>SET_VARSIZE_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1883"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1883"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the toast relation and its indexes 
     */ 
</span>    <a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN72"><span class='Ref_to_Member'>va_toastrelid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1882"><span class='Ref_To_Local'>toasttupDesc</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look for the valid index of the toast relation */ 
</span>    <a href="tuptoaster.c.html#LN1894"><span class='Ref_To_Local'>validIndex</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN78"><span class='Ref_to_Proto'>toast_open_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1878"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1893"><span class='Ref_To_Local'>num_indexes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup a scan key to fetch from the index by va_valueid 
     */ 
</span>    <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1879"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the chunks by index 
     * 
     * Note that because the index is actually on (valueid, chunkidx) we will 
     * see the chunks in chunkidx order, even though we didn't explicitly ask 
     * for it. 
     */ 
</span>    <a href="tuptoaster.c.html#LN1887"><span class='Ref_To_Local'>nextidx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN84"><span class='Ref_to_Proto'>init_toast_snapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1895"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN1880"><span class='Ref_To_Local'>toastscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1878"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN1894"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>], 
</span>                                           <span class='Operator'>&</span><a href="tuptoaster.c.html#LN1895"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1879"><span class='Ref_To_Local'>toastkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN1881"><span class='Ref_To_Local'>ttup</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1880"><span class='Ref_To_Local'>toastscan</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Have a chunk, extract the sequence number and the data 
         */ 
</span>        <a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1881"><span class='Ref_To_Local'>ttup</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1882"><span class='Ref_To_Local'>toasttupDesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1890"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN1890"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1881"><span class='Ref_To_Local'>ttup</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1882"><span class='Ref_To_Local'>toasttupDesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN1890"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN1890"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN325"><span class='Ref_to_Macro'>VARATT_IS_EXTENDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN1891"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* could happen due to heap_form_tuple doing its thing */ 
</span>            <a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN1891"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN306"><span class='Ref_to_Macro'>VARDATA_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1889"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* should never happen */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"found toasted toast chunk for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <a href="tuptoaster.c.html#LN1891"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Some checks on the data we've found 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>!= </span><a href="tuptoaster.c.html#LN1887"><span class='Ref_To_Local'>nextidx</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk number %d (expected %d) for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1887"><span class='Ref_To_Local'>nextidx</span></a><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN1888"><span class='Ref_To_Local'>numchunks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>!= </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk size %d (expected %d) in chunk %d of %d for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1888"><span class='Ref_To_Local'>numchunks</span></a><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>== </span><a href="tuptoaster.c.html#LN1888"><span class='Ref_To_Local'>numchunks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>* </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk size %d (expected %d) in final chunk %d for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="tuptoaster.c.html#LN1885"><span class='Ref_To_Local'>ressize</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>* </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk number %d (out of range %d..%d) for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, 
</span>                 <span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1888"><span class='Ref_To_Local'>numchunks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Copy the data into proper place in our result 
         */ 
</span>        memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1883"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="tuptoaster.c.html#LN1886"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>* </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>, 
</span>               <a href="tuptoaster.c.html#LN1891"><span class='Ref_To_Local'>chunkdata</span></a><span class='Delimiter'>, 
</span>               <a href="tuptoaster.c.html#LN1892"><span class='Ref_To_Local'>chunksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN1887"><span class='Ref_To_Local'>nextidx</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (ttup=systable_getnex... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Final checks that we successfully fetched the datum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1887"><span class='Ref_To_Local'>nextidx</span></a> <span class='Operator'>!= </span><a href="tuptoaster.c.html#LN1888"><span class='Ref_To_Local'>numchunks</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing chunk number %d for toast value %u in %s"</span><span class='Delimiter'>, 
</span>             <a href="tuptoaster.c.html#LN1887"><span class='Ref_To_Local'>nextidx</span></a><span class='Delimiter'>, 
</span>             <a href="tuptoaster.c.html#LN1884"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * End scan and close relations 
     */ 
</span>    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1880"><span class='Ref_To_Local'>toastscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN82"><span class='Ref_to_Proto'>toast_close_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1878"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN1893"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN1877"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN1883"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_fetch_datum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_fetch_datum_slice - 
 * 
 *  Reconstruct a segment of a Datum from the chunks saved 
 *  in the toast relation 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* 
</span><a name="LN2046"></a><span class='Declare_Function'>toast_fetch_datum_slice</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>sliceoffset</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>length</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2048"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span><span class='Delimiter'>; 
</span><a name="LN2049"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Delimiter'>; 
</span><a name="LN2050"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>toastkey</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN2051"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nscankeys</span><span class='Delimiter'>; 
</span><a name="LN2052"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>toastscan</span><span class='Delimiter'>; 
</span><a name="LN2053"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>ttup</span><span class='Delimiter'>; 
</span><a name="LN2054"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>toasttupDesc</span><span class='Delimiter'>; 
</span><a name="LN2055"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN2056"></a>    <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span><a name="LN2057"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>attrsize</span><span class='Delimiter'>; 
</span><a name="LN2058"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>residx</span><span class='Delimiter'>; 
</span><a name="LN2059"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>nextidx</span><span class='Delimiter'>; 
</span><a name="LN2060"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numchunks</span><span class='Delimiter'>; 
</span><a name="LN2061"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>startchunk</span><span class='Delimiter'>; 
</span><a name="LN2062"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>endchunk</span><span class='Delimiter'>; 
</span><a name="LN2063"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>startoffset</span><span class='Delimiter'>; 
</span><a name="LN2064"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>endoffset</span><span class='Delimiter'>; 
</span><a name="LN2065"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>totalchunks</span><span class='Delimiter'>; 
</span><a name="LN2066"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span><a name="LN2067"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN2068"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>chunkdata</span><span class='Delimiter'>; 
</span><a name="LN2069"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chunksize</span><span class='Delimiter'>; 
</span><a name="LN2070"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chcpystrt</span><span class='Delimiter'>; 
</span><a name="LN2071"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chcpyend</span><span class='Delimiter'>; 
</span><a name="LN2072"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_indexes</span><span class='Delimiter'>; 
</span><a name="LN2073"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>validIndex</span><span class='Delimiter'>; 
</span><a name="LN2074"></a>    <a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Local'>SnapshotToast</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN314"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL_ONDISK</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"toast_fetch_datum_slice shouldn't be called for non-ondisk datums"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must copy to access aligned fields */ 
</span>    <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's nonsense to fetch slices of a compressed datum -- this isn't lo_* 
     * we can't return a compressed datum which is meaningful to toast later 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/tuptoaster.h.html#LN110"><span class='Ref_to_Macro'>VARATT_EXTERNAL_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2065"><span class='Ref_To_Local'>totalchunks</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>&GT;= </span><a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN2055"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN110"><span class='Ref_to_Macro'>VARATT_EXTERNAL_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/postgres.h.html#LN329"><span class='Ref_to_Macro'>SET_VARSIZE_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2055"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2055"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="tuptoaster.c.html#LN2055"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Can save a lot of work at this point! */ 
</span> 
    <a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>/ </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2062"><span class='Ref_To_Local'>endchunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2060"><span class='Ref_To_Local'>numchunks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2062"><span class='Ref_To_Local'>endchunk</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN2063"><span class='Ref_To_Local'>startoffset</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>% </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2064"><span class='Ref_To_Local'>endoffset</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>length</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the toast relation and its indexes 
     */ 
</span>    <a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN72"><span class='Ref_to_Member'>va_toastrelid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2054"><span class='Ref_To_Local'>toasttupDesc</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look for the valid index of toast relation */ 
</span>    <a href="tuptoaster.c.html#LN2073"><span class='Ref_To_Local'>validIndex</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN78"><span class='Ref_to_Proto'>toast_open_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN2049"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="tuptoaster.c.html#LN2072"><span class='Ref_To_Local'>num_indexes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup a scan key to fetch from the index. This is either two keys or 
     * three depending on the number of chunks. 
     */ 
</span>    <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2050"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use equality condition for one chunk, a range condition otherwise: 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2060"><span class='Ref_To_Local'>numchunks</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2050"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4EQ<span class='Delimiter'>, 
</span>                    <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN2051"><span class='Ref_To_Local'>nscankeys</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2050"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/access/stratnum.h.html#LN31"><span class='Ref_to_Const'>BTGreaterEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4GE<span class='Delimiter'>, 
</span>                    <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2050"><span class='Ref_To_Local'>toastkey</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/access/stratnum.h.html#LN29"><span class='Ref_to_Const'>BTLessEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4LE<span class='Delimiter'>, 
</span>                    <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2062"><span class='Ref_To_Local'>endchunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN2051"><span class='Ref_To_Local'>nscankeys</span></a> <span class='Operator'>= </span><span class='Number'>3</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the chunks by index 
     * 
     * The index is on (valueid, chunkidx) so they will come in order 
     */ 
</span>    <a href="tuptoaster.c.html#LN84"><span class='Ref_to_Proto'>init_toast_snapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2074"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2059"><span class='Ref_To_Local'>nextidx</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN2052"><span class='Ref_To_Local'>toastscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2049"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN2073"><span class='Ref_To_Local'>validIndex</span></a><span class='Delimiter'>], 
</span>                                        <span class='Operator'>&</span><a href="tuptoaster.c.html#LN2074"><span class='Ref_To_Local'>SnapshotToast</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2051"><span class='Ref_To_Local'>nscankeys</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2050"><span class='Ref_To_Local'>toastkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN2053"><span class='Ref_To_Local'>ttup</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2052"><span class='Ref_To_Local'>toastscan</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Have a chunk, extract the sequence number and the data 
         */ 
</span>        <a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2053"><span class='Ref_To_Local'>ttup</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2054"><span class='Ref_To_Local'>toasttupDesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2067"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN2067"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2053"><span class='Ref_To_Local'>ttup</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2054"><span class='Ref_To_Local'>toasttupDesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tuptoaster.c.html#LN2067"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN2067"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN325"><span class='Ref_to_Macro'>VARATT_IS_EXTENDED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN2068"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* could happen due to heap_form_tuple doing its thing */ 
</span>            <a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN2068"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN306"><span class='Ref_to_Macro'>VARDATA_SHORT</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2066"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* should never happen */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"found toasted toast chunk for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <a href="tuptoaster.c.html#LN2068"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Some checks on the data we've found 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>!= </span><a href="tuptoaster.c.html#LN2059"><span class='Ref_To_Local'>nextidx</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>&GT; </span><a href="tuptoaster.c.html#LN2062"><span class='Ref_To_Local'>endchunk</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk number %d (expected %d) for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2059"><span class='Ref_To_Local'>nextidx</span></a><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN2065"><span class='Ref_To_Local'>totalchunks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>!= </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk size %d (expected %d) in chunk %d of %d for toast value %u in %s when fetching slice"</span><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2065"><span class='Ref_To_Local'>totalchunks</span></a><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>== </span><a href="tuptoaster.c.html#LN2065"><span class='Ref_To_Local'>totalchunks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>* </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk size %d (expected %d) in final chunk %d for toast value %u in %s when fetching slice"</span><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="tuptoaster.c.html#LN2057"><span class='Ref_To_Local'>attrsize</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>* </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, 
</span>                     <a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected chunk number %d (out of range %d..%d) for toast value %u in %s"</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a><span class='Delimiter'>, 
</span>                 <span class='Number'>0</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2065"><span class='Ref_To_Local'>totalchunks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                 <a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Copy the data into proper place in our result 
         */ 
</span>        <a href="tuptoaster.c.html#LN2070"><span class='Ref_To_Local'>chcpystrt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="tuptoaster.c.html#LN2071"><span class='Ref_To_Local'>chcpyend</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2069"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>== </span><a href="tuptoaster.c.html#LN2061"><span class='Ref_To_Local'>startchunk</span></a><span class='Parentheses'>) 
</span>            <a href="tuptoaster.c.html#LN2070"><span class='Ref_To_Local'>chcpystrt</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2063"><span class='Ref_To_Local'>startoffset</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>== </span><a href="tuptoaster.c.html#LN2062"><span class='Ref_To_Local'>endchunk</span></a><span class='Parentheses'>) 
</span>            <a href="tuptoaster.c.html#LN2071"><span class='Ref_To_Local'>chcpyend</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2064"><span class='Ref_To_Local'>endoffset</span></a><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2055"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>               <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2058"><span class='Ref_To_Local'>residx</span></a> <span class='Operator'>* </span><a href="../../../include/access/tuptoaster.h.html#LN90"><span class='Ref_to_Const'>TOAST_MAX_CHUNK_SIZE</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN2046"><span class='Ref_to_Parameter'>sliceoffset</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="tuptoaster.c.html#LN2070"><span class='Ref_To_Local'>chcpystrt</span></a><span class='Delimiter'>, 
</span>               <a href="tuptoaster.c.html#LN2068"><span class='Ref_To_Local'>chunkdata</span></a> <span class='Operator'>+ </span><a href="tuptoaster.c.html#LN2070"><span class='Ref_To_Local'>chcpystrt</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2071"><span class='Ref_To_Local'>chcpyend</span></a> <span class='Operator'>- </span><a href="tuptoaster.c.html#LN2070"><span class='Ref_To_Local'>chcpystrt</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="tuptoaster.c.html#LN2059"><span class='Ref_To_Local'>nextidx</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (ttup=systable_getnex... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Final checks that we successfully fetched the datum 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2059"><span class='Ref_To_Local'>nextidx</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2062"><span class='Ref_To_Local'>endchunk</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing chunk number %d for toast value %u in %s"</span><span class='Delimiter'>, 
</span>             <a href="tuptoaster.c.html#LN2059"><span class='Ref_To_Local'>nextidx</span></a><span class='Delimiter'>, 
</span>             <a href="tuptoaster.c.html#LN2056"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * End scan and close relations 
     */ 
</span>    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2052"><span class='Ref_To_Local'>toastscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tuptoaster.c.html#LN82"><span class='Ref_to_Proto'>toast_close_indexes</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2049"><span class='Ref_To_Local'>toastidxs</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2072"><span class='Ref_To_Local'>num_indexes</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2048"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN2055"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_fetch_datum_slice &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_decompress_datum - 
 * 
 * Decompress a compressed version of a varlena datum 
 */ 
</span><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* 
</span><a name="LN2278"></a><span class='Declare_Function'>toast_decompress_datum</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>attr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2280"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN312"><span class='Ref_to_Macro'>VARATT_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2278"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tuptoaster.c.html#LN2280"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN63"><span class='Ref_to_Macro'>TOAST_COMPRESS_RAWSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2278"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2280"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN63"><span class='Ref_to_Macro'>TOAST_COMPRESS_RAWSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2278"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/common/pg_lzcompress.h.html#LN87"><span class='Ref_to_Proto'>pglz_decompress</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN64"><span class='Ref_to_Macro'>TOAST_COMPRESS_RAWDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2278"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2278"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="tuptoaster.c.html#LN62"><span class='Ref_to_Const'>TOAST_COMPRESS_HDRSZ</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2280"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="tuptoaster.c.html#LN63"><span class='Ref_to_Macro'>TOAST_COMPRESS_RAWSIZE</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2278"><span class='Ref_to_Parameter'>attr</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"compressed data is corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN2280"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_open_indexes 
 * 
 *  Get an array of the indexes associated to the given toast relation 
 *  and return as well the position of the valid index used by the toast 
 *  relation in this array. It is the responsibility of the caller of this 
 *  function to close the indexes as well as free them. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2307"></a><span class='Declare_Function'>toast_open_indexes</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>toastrel</span><span class='Delimiter'>, 
</span><a name="LN2308"></a>                   <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lock</span><span class='Delimiter'>, 
</span><a name="LN2309"></a>                   <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>toastidxs</span><span class='Delimiter'>, 
</span><a name="LN2310"></a>                   <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>num_indexes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2312"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2313"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2314"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN2315"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>indexlist</span><span class='Delimiter'>; 
</span><a name="LN2316"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get index list of the toast relation */ 
</span>    <a href="tuptoaster.c.html#LN2315"><span class='Ref_To_Local'>indexlist</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN40"><span class='Ref_to_Proto'>RelationGetIndexList</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2307"><span class='Ref_to_Parameter'>toastrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2315"><span class='Ref_To_Local'>indexlist</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="tuptoaster.c.html#LN2310"><span class='Ref_to_Parameter'>num_indexes</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2315"><span class='Ref_To_Local'>indexlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open all the index relations */ 
</span>    <span class='Operator'>*</span><a href="tuptoaster.c.html#LN2309"><span class='Ref_to_Parameter'>toastidxs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tuptoaster.c.html#LN2310"><span class='Ref_to_Parameter'>num_indexes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2316"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2315"><span class='Ref_To_Local'>indexlist</span></a><span class='Parentheses'>) 
</span><a name="LN2327"></a>        <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Local'>toastidxs</span><span class='Parentheses'>)</span><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN2312"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2316"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2308"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch the first valid index in list */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2312"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN2312"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; *</span><a href="tuptoaster.c.html#LN2310"><span class='Ref_to_Parameter'>num_indexes</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN2312"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2332"></a>        <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastidx</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tuptoaster.c.html#LN2309"><span class='Ref_to_Parameter'>toastidxs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN2312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2332"><span class='Ref_To_Local'>toastidx</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN158"><span class='Ref_to_Member'>rd_index</span></a><span class='Operator'>-&GT;</span>indisvalid<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tuptoaster.c.html#LN2313"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="tuptoaster.c.html#LN2312"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <a href="tuptoaster.c.html#LN2314"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free index list, not necessary anymore as relations are opened and a 
     * valid index has been found. 
     */ 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2315"><span class='Ref_To_Local'>indexlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The toast relation should have one valid index, so something is going 
     * wrong if there is nothing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tuptoaster.c.html#LN2314"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no valid index found for toast relation with Oid %u"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2307"><span class='Ref_to_Parameter'>toastrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tuptoaster.c.html#LN2313"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end toast_open_indexes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * toast_close_indexes 
 * 
 *  Close an array of indexes for a toast relation and free it. This should 
 *  be called for a set of indexes opened previously with toast_open_indexes. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2366"></a><span class='Declare_Function'>toast_close_indexes</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>toastidxs</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>num_indexes</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2368"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close relations and clean up things */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN2368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tuptoaster.c.html#LN2366"><span class='Ref_to_Parameter'>num_indexes</span></a><span class='Delimiter'>; </span><a href="tuptoaster.c.html#LN2368"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2366"><span class='Ref_to_Parameter'>toastidxs</span></a><span class='Delimiter'>[</span><a href="tuptoaster.c.html#LN2368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="tuptoaster.c.html#LN2366"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2366"><span class='Ref_to_Parameter'>toastidxs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * init_toast_snapshot 
 * 
 *  Initialize an appropriate TOAST snapshot.  We must use an MVCC snapshot 
 *  to initialize the TOAST snapshot; since we don't know which one to use, 
 *  just use the oldest one.  This is safe: at worst, we will get a "snapshot 
 *  too old" error that might have been avoided otherwise. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2385"></a><span class='Declare_Function'>init_toast_snapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>toast_snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2387"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN66"><span class='Ref_to_Proto'>GetOldestSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tuptoaster.c.html#LN2387"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no known snapshots"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/tqual.h.html#LN106"><span class='Ref_to_Macro'>InitToastSnapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tuptoaster.c.html#LN2385"><span class='Ref_to_Parameter'>toast_snapshot</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2387"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN111"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>, </span><a href="tuptoaster.c.html#LN2387"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN110"><span class='Ref_to_Member'>whenTaken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>