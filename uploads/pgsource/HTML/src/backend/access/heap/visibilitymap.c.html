<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\heap\visibilitymap.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\heap\visibilitymap.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:29 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * visibilitymap.c 
 *    bitmap for tracking visibility of heap tuples 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/heap/visibilitymap.c 
 * 
 * INTERFACE ROUTINES 
 *      visibilitymap_clear  - clear bits for one page in the visibility map 
 *      visibilitymap_pin    - pin a map page for setting a bit 
 *      visibilitymap_pin_ok - check whether correct map page is already pinned 
 *      visibilitymap_set    - set a bit in a previously pinned page 
 *      visibilitymap_get_status - get status of bits 
 *      visibilitymap_count  - count number of bits set in visibility map 
 *      visibilitymap_truncate  - truncate the visibility map 
 * 
 * NOTES 
 * 
 * The visibility map is a bitmap with two bits (all-visible and all-frozen) 
 * per heap page. A set all-visible bit means that all tuples on the page are 
 * known visible to all transactions, and therefore the page doesn't need to 
 * be vacuumed. A set all-frozen bit means that all tuples on the page are 
 * completely frozen, and therefore the page doesn't need to be vacuumed even 
 * if whole table scanning vacuum is required (e.g. anti-wraparound vacuum). 
 * The all-frozen bit must be set only when the page is already all-visible. 
 * 
 * The map is conservative in the sense that we make sure that whenever a bit 
 * is set, we know the condition is true, but if a bit is not set, it might or 
 * might not be true. 
 * 
 * Clearing visibility map bits is not separately WAL-logged.  The callers 
 * must make sure that whenever a bit is cleared, the bit is cleared on WAL 
 * replay of the updating operation as well. 
 * 
 * When we *set* a visibility map during VACUUM, we must write WAL.  This may 
 * seem counterintuitive, since the bit is basically a hint: if it is clear, 
 * it may still be the case that every tuple on the page is visible to all 
 * transactions; we just don't know that for certain.  The difficulty is that 
 * there are two bits which are typically set together: the PD_ALL_VISIBLE bit 
 * on the page itself, and the visibility map bit.  If a crash occurs after the 
 * visibility map page makes it to disk and before the updated heap page makes 
 * it to disk, redo must set the bit on the heap page.  Otherwise, the next 
 * insert, update, or delete on the heap page will fail to realize that the 
 * visibility map bit must be cleared, possibly causing index-only scans to 
 * return wrong answers. 
 * 
 * VACUUM will normally skip pages for which the visibility map bit is set; 
 * such pages can't contain any dead tuples and therefore don't need vacuuming. 
 * 
 * LOCKING 
 * 
 * In heapam.c, whenever a page is modified so that not all tuples on the 
 * page are visible to everyone anymore, the corresponding bit in the 
 * visibility map is cleared. In order to be crash-safe, we need to do this 
 * while still holding a lock on the heap page and in the same critical 
 * section that logs the page modification. However, we don't want to hold 
 * the buffer lock over any I/O that may be required to read in the visibility 
 * map page.  To avoid this, we examine the heap page before locking it; 
 * if the page-level PD_ALL_VISIBLE bit is set, we pin the visibility map 
 * bit.  Then, we lock the buffer.  But this creates a race condition: there 
 * is a possibility that in the time it takes to lock the buffer, the 
 * PD_ALL_VISIBLE bit gets set.  If that happens, we have to unlock the 
 * buffer, pin the visibility map page, and relock the buffer.  This shouldn't 
 * happen often, because only VACUUM currently sets visibility map bits, 
 * and the race will only occur if VACUUM processes a given page at almost 
 * exactly the same time that someone tries to further modify it. 
 * 
 * To set a bit, you need to hold a lock on the heap page. That prevents 
 * the race condition where VACUUM sees that all tuples on the page are 
 * visible to everyone, but another backend modifies the page before VACUUM 
 * sets the bit in the visibility map. 
 * 
 * When a bit is set, the LSN of the visibility map page is updated to make 
 * sure that the visibility map update doesn't get written to disk before the 
 * WAL record of the changes that made it possible to set the bit is flushed. 
 * But when a bit is cleared, we don't have to do that because it's always 
 * safe to clear a bit in the map from correctness point of view. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/visibilitymap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
 
 
<span class='Comment_Multi_Line'>/*#define TRACE_VISIBILITYMAP */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Size of the bitmap on each visibility map page, in bytes. There's no 
 * extra headers, so the whole page minus the standard page header is 
 * used for the bitmap. 
 */ 
</span><a name="LN104"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAPSIZE</span> <span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>- </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* Number of heap blocks we can represent in one byte */ 
</span><a name="LN107"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPBLOCKS_PER_BYTE</span> <span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN105"><span class='Ref_to_Const'>BITS_PER_BYTE</span></a> <span class='Operator'>/ </span><a href="../../../include/access/visibilitymap.h.html#LN22"><span class='Ref_to_Const'>BITS_PER_HEAPBLOCK</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Number of heap blocks we can represent in one visibility map page. */ 
</span><a name="LN110"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HEAPBLOCKS_PER_PAGE</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN104"><span class='Ref_to_Const'>MAPSIZE</span></a> <span class='Operator'>* </span><a href="visibilitymap.c.html#LN107"><span class='Ref_to_Const'>HEAPBLOCKS_PER_BYTE</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Mapping from heap block number to the right bit in the visibility map */ 
</span><a name="LN113"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>HEAPBLK_TO_MAPBLOCK</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>) ((</span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="visibilitymap.c.html#LN110"><span class='Ref_to_Const'>HEAPBLOCKS_PER_PAGE</span></a><span class='Parentheses'>)</span> 
<a name="LN114"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>HEAPBLK_TO_MAPBYTE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>) (((</span><a href="visibilitymap.c.html#LN114"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="visibilitymap.c.html#LN110"><span class='Ref_to_Const'>HEAPBLOCKS_PER_PAGE</span></a><span class='Parentheses'>)</span> <span class='Operator'>/ </span><a href="visibilitymap.c.html#LN107"><span class='Ref_to_Const'>HEAPBLOCKS_PER_BYTE</span></a><span class='Parentheses'>)</span> 
<a name="LN115"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>HEAPBLK_TO_OFFSET</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>) (((</span><a href="visibilitymap.c.html#LN115"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="visibilitymap.c.html#LN107"><span class='Ref_to_Const'>HEAPBLOCKS_PER_BYTE</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="../../../include/access/visibilitymap.h.html#LN22"><span class='Ref_to_Const'>BITS_PER_HEAPBLOCK</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* tables for fast counting of set bits for visible and frozen */ 
</span><a name="LN118"></a><span class='Keyword'>static const </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Var'>number_of_ones_for_visible</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span> 
<span class='Delimiter'>}; 
</span><a name="LN136"></a><span class='Keyword'>static const </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Var'>number_of_ones_for_frozen</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* prototypes for internal routines */ 
</span><a name="LN156"></a><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Prototype'>vm_readbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>extend</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN157"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>vm_extend</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>nvmblocks</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_clear - clear specified bits for one page in visibility map 
 * 
 * You must pass a buffer containing the correct map page to this function. 
 * Call visibilitymap_pin first to pin the right one. This function doesn't do 
 * any I/O.  Returns true if any bits have been cleared and false otherwise. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN168"></a><span class='Declare_Function'>visibilitymap_clear</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN170"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapBlock</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBLOCK</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN171"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mapByte</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN114"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBYTE</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN172"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mapOffset</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN115"><span class='Ref_to_Macro'>HEAPBLK_TO_OFFSET</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN173"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>mask</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>&LT;&LT; </span><a href="visibilitymap.c.html#LN172"><span class='Ref_To_Local'>mapOffset</span></a><span class='Delimiter'>; 
</span><a name="LN174"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>map</span><span class='Delimiter'>; 
</span><a name="LN175"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>cleared</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRACE_VISIBILITYMAP 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"vm_clear %s %d"</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="visibilitymap.c.html#LN170"><span class='Ref_To_Local'>mapBlock</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong buffer passed to visibilitymap_clear"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="visibilitymap.c.html#LN174"><span class='Ref_To_Local'>map</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN174"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN171"><span class='Ref_To_Local'>mapByte</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><a href="visibilitymap.c.html#LN173"><span class='Ref_To_Local'>mask</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="visibilitymap.c.html#LN174"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN171"><span class='Ref_To_Local'>mapByte</span></a><span class='Delimiter'>] </span><span class='Operator'>&= ~</span><a href="visibilitymap.c.html#LN173"><span class='Ref_To_Local'>mask</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="visibilitymap.c.html#LN175"><span class='Ref_To_Local'>cleared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN168"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="visibilitymap.c.html#LN175"><span class='Ref_To_Local'>cleared</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end visibilitymap_clear &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_pin - pin a map page for setting a bit 
 * 
 * Setting a bit in the visibility map is a two-phase operation. First, call 
 * visibilitymap_pin, to pin the visibility map page containing the bit for 
 * the heap page. Because that can require I/O to read the map page, you 
 * shouldn't hold a lock on the heap page while doing that. Then, call 
 * visibilitymap_set to actually set the bit. 
 * 
 * On entry, *buf should be InvalidBuffer or a valid buffer returned by 
 * an earlier call to visibilitymap_pin or visibilitymap_get_status on the same 
 * relation. On return, *buf is a valid buffer with the map page containing 
 * the bit for heapBlk. 
 * 
 * If the page doesn't exist in the map file yet, it is extended. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN219"></a><span class='Declare_Function'>visibilitymap_pin</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN221"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapBlock</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBLOCK</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN219"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reuse the old pinned buffer if possible */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN219"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN219"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="visibilitymap.c.html#LN221"><span class='Ref_To_Local'>mapBlock</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN219"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="visibilitymap.c.html#LN219"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN156"><span class='Ref_to_Proto'>vm_readbuf</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN219"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN221"><span class='Ref_To_Local'>mapBlock</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_pin_ok - do we already have the correct page pinned? 
 * 
 * On entry, buf should be InvalidBuffer or a valid buffer returned by 
 * an earlier call to visibilitymap_pin or visibilitymap_get_status on the same 
 * relation.  The return value indicates whether the buffer covers the 
 * given heapBlk. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN243"></a><span class='Declare_Function'>visibilitymap_pin_ok</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN245"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapBlock</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBLOCK</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN243"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN243"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN243"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="visibilitymap.c.html#LN245"><span class='Ref_To_Local'>mapBlock</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_set - set bit(s) on a previously pinned page 
 * 
 * recptr is the LSN of the XLOG record we're replaying, if we're in recovery, 
 * or InvalidXLogRecPtr in normal running.  The page LSN is advanced to the 
 * one provided; in normal running, we generate a new XLOG record and set the 
 * page LSN to that value.  cutoff_xid is the largest xmin on the page being 
 * marked all-visible; it is needed for Hot Standby, and can be 
 * InvalidTransactionId if the page contains no tuples.  It can also be set 
 * to InvalidTransactionId when a page that is already all-visible is being 
 * marked all-frozen. 
 * 
 * Caller is expected to set the heap page's PD_ALL_VISIBLE bit before calling 
 * this function. Except in recovery, caller should also pass the heap 
 * buffer. When checksums are enabled and we're not in recovery, we must add 
 * the heap buffer to the WAL chain to protect it from being torn. 
 * 
 * You must pass a buffer containing the correct map page to this function. 
 * Call visibilitymap_pin first to pin the right one. This function doesn't do 
 * any I/O. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN272"></a><span class='Declare_Function'>visibilitymap_set</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>heapBuf</span><span class='Delimiter'>, 
</span><a name="LN273"></a>                  <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recptr</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>vmBuf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff_xid</span><span class='Delimiter'>, 
</span><a name="LN274"></a>                  <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN276"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapBlock</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBLOCK</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN277"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>mapByte</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN114"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBYTE</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN278"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>mapOffset</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN115"><span class='Ref_to_Macro'>HEAPBLK_TO_OFFSET</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN279"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN280"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>map</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRACE_VISIBILITYMAP 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"vm_set %s %d"</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a> <span class='Operator'>|| </span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>recptr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a> <span class='Operator'>|| </span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN274"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that we have the right heap page pinned, if present */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong heap buffer passed to visibilitymap_set"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that we have the right VM page pinned */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="visibilitymap.c.html#LN276"><span class='Ref_To_Local'>mapBlock</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong VM buffer passed to visibilitymap_set"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="visibilitymap.c.html#LN279"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="visibilitymap.c.html#LN280"><span class='Ref_To_Local'>map</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN279"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN274"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN280"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN277"><span class='Ref_To_Local'>mapByte</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;&GT; </span><a href="visibilitymap.c.html#LN278"><span class='Ref_To_Local'>mapOffset</span></a> <span class='Operator'>& </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="visibilitymap.c.html#LN280"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN277"><span class='Ref_To_Local'>mapByte</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN274"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>&LT;&LT; </span><a href="visibilitymap.c.html#LN278"><span class='Ref_To_Local'>mapOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>recptr</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam_xlog.h.html#LN398"><span class='Ref_to_Proto'>log_heap_visible</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBuf</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Delimiter'>, 
</span>                                          <a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>cutoff_xid</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN274"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If data checksums are enabled (or wal_log_hints=on), we 
                 * need to protect the heap page from being torn. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN155"><span class='Ref_to_Macro'>XLogHintBitIsNeeded</span></a><span class='Parentheses'>())</span> 
                <span class='Delimiter'>{ 
</span><a name="LN323"></a>                    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>heapPage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN272"><span class='Ref_to_Parameter'>heapBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* caller is expected to set PD_ALL_VISIBLE first */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN323"><span class='Ref_To_Local'>heapPage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN323"><span class='Ref_To_Local'>heapPage</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN279"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if flags!=(map[mapByte]&GT;... &raquo; </span> 
 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN273"><span class='Ref_to_Parameter'>vmBuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end visibilitymap_set &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_get_status - get status of bits 
 * 
 * Are all tuples on heapBlk visible to all or are marked frozen, according 
 * to the visibility map? 
 * 
 * On entry, *buf should be InvalidBuffer or a valid buffer returned by an 
 * earlier call to visibilitymap_pin or visibilitymap_get_status on the same 
 * relation. On return, *buf is a valid buffer with the map page containing 
 * the bit for heapBlk, or InvalidBuffer. The caller is responsible for 
 * releasing *buf after it's done testing and setting bits. 
 * 
 * NOTE: This function is typically called without a lock on the heap page, 
 * so somebody else could change the bit just after we look at it.  In fact, 
 * since we don't lock the visibility map page either, it's even possible that 
 * someone else could have changed the bit just before we look at it, but yet 
 * we might see the old value.  It is the caller's responsibility to deal with 
 * all concurrency issues! 
 */ 
</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> 
<a name="LN359"></a><span class='Declare_Function'>visibilitymap_get_status</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>heapBlk</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN361"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapBlock</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBLOCK</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN362"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>mapByte</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN114"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBYTE</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN363"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>mapOffset</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN115"><span class='Ref_to_Macro'>HEAPBLK_TO_OFFSET</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN364"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>map</span><span class='Delimiter'>; 
</span><a name="LN365"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRACE_VISIBILITYMAP 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"vm_get_status %s %d"</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>heapBlk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Reuse the old pinned buffer if possible */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="visibilitymap.c.html#LN361"><span class='Ref_To_Local'>mapBlock</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN156"><span class='Ref_to_Proto'>vm_readbuf</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN361"><span class='Ref_To_Local'>mapBlock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="visibilitymap.c.html#LN364"><span class='Ref_To_Local'>map</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="visibilitymap.c.html#LN359"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * A single byte read is atomic.  There could be memory-ordering effects 
     * here, but for performance reasons we make it the caller's job to worry 
     * about that. 
     */ 
</span>    <a href="visibilitymap.c.html#LN365"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="visibilitymap.c.html#LN364"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN362"><span class='Ref_To_Local'>mapByte</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;&GT; </span><a href="visibilitymap.c.html#LN363"><span class='Ref_To_Local'>mapOffset</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="visibilitymap.c.html#LN365"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end visibilitymap_get_status &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_count  - count number of bits set in visibility map 
 * 
 * Note: we ignore the possibility of race conditions when the table is being 
 * extended concurrently with the call.  New pages added to the table aren't 
 * going to be marked all-visible or all-frozen, so they won't affect the result. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN407"></a><span class='Declare_Function'>visibilitymap_count</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>all_visible</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>all_frozen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN409"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>mapBlock</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* all_visible must be specified */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_visible</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_visible</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_frozen</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN409"><span class='Ref_To_Local'>mapBlock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;; </span><a href="visibilitymap.c.html#LN409"><span class='Ref_To_Local'>mapBlock</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN420"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>mapBuffer</span><span class='Delimiter'>; 
</span><a name="LN421"></a>        <span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Local'>map</span><span class='Delimiter'>; 
</span><a name="LN422"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Read till we fall off the end of the map.  We assume that any extra 
         * bytes in the last page are zeroed, so we don't bother excluding 
         * them from the count. 
         */ 
</span>        <a href="visibilitymap.c.html#LN420"><span class='Ref_To_Local'>mapBuffer</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN156"><span class='Ref_to_Proto'>vm_readbuf</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN409"><span class='Ref_To_Local'>mapBlock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN420"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We choose not to lock the page, since the result is going to be 
         * immediately stale anyway if anyone is concurrently setting or 
         * clearing bits, and we only really need an approximate value. 
         */ 
</span>        <a href="visibilitymap.c.html#LN421"><span class='Ref_To_Local'>map</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN420"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN422"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="visibilitymap.c.html#LN422"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="visibilitymap.c.html#LN104"><span class='Ref_to_Const'>MAPSIZE</span></a><span class='Delimiter'>; </span><a href="visibilitymap.c.html#LN422"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_visible</span></a> <span class='Operator'>+= </span><a href="visibilitymap.c.html#LN118"><span class='Ref_to_Global_Var'>number_of_ones_for_visible</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN421"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN422"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]]; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_frozen</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="visibilitymap.c.html#LN407"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>+= </span><a href="visibilitymap.c.html#LN136"><span class='Ref_to_Global_Var'>number_of_ones_for_frozen</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN421"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN422"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]]; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN420"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for mapBlock=0;;mapBlock+... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end visibilitymap_count &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  visibilitymap_truncate - truncate the visibility map 
 * 
 * The caller must hold AccessExclusiveLock on the relation, to ensure that 
 * other backends receive the smgr invalidation event that this function sends 
 * before they access the VM again. 
 * 
 * nheapblocks is the new size of the heap. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN461"></a><span class='Declare_Function'>visibilitymap_truncate</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>nheapblocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN463"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>newnblocks</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* last remaining block, byte, and bit */ 
</span><a name="LN466"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>truncBlock</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN113"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBLOCK</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>nheapblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>truncByte</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN114"><span class='Ref_to_Macro'>HEAPBLK_TO_MAPBYTE</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>nheapblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN468"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>truncOffset</span> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN115"><span class='Ref_to_Macro'>HEAPBLK_TO_OFFSET</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>nheapblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TRACE_VISIBILITYMAP 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"vm_truncate %s %d"</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>nheapblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If no visibility map has been created yet for this relation, there's 
     * nothing to truncate. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/smgr.h.html#LN84"><span class='Ref_to_Proto'>smgrexists</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unless the new size is exactly at a visibility map page boundary, the 
     * tail bits in the last remaining map page, representing truncated heap 
     * blocks, need to be cleared. This is not only tidy, but also necessary 
     * because we don't get a chance to clear the bits if the heap is extended 
     * again. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN467"><span class='Ref_To_Local'>truncByte</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="visibilitymap.c.html#LN468"><span class='Ref_To_Local'>truncOffset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN492"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>mapBuffer</span><span class='Delimiter'>; 
</span><a name="LN493"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN494"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>map</span><span class='Delimiter'>; 
</span> 
        <a href="visibilitymap.c.html#LN463"><span class='Ref_To_Local'>newnblocks</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN466"><span class='Ref_To_Local'>truncBlock</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN156"><span class='Ref_to_Proto'>vm_readbuf</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN466"><span class='Ref_To_Local'>truncBlock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* nothing to do, the file was already smaller */ 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="visibilitymap.c.html#LN493"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="visibilitymap.c.html#LN494"><span class='Ref_To_Local'>map</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN493"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till changes are logged */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Clear out the unwanted bytes. */ 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="visibilitymap.c.html#LN494"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN467"><span class='Ref_To_Local'>truncByte</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN104"><span class='Ref_to_Const'>MAPSIZE</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN467"><span class='Ref_To_Local'>truncByte</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/*---- 
         * Mask out the unwanted bits of the last remaining byte. 
         * 
         * ((1 &LT;&LT; 0) - 1) = 00000000 
         * ((1 &LT;&LT; 1) - 1) = 00000001 
         * ... 
         * ((1 &LT;&LT; 6) - 1) = 00111111 
         * ((1 &LT;&LT; 7) - 1) = 01111111 
         *---- 
         */ 
</span>        <a href="visibilitymap.c.html#LN494"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>[</span><a href="visibilitymap.c.html#LN467"><span class='Ref_To_Local'>truncByte</span></a><span class='Delimiter'>] </span><span class='Operator'>&= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="visibilitymap.c.html#LN468"><span class='Ref_To_Local'>truncOffset</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Truncation of a relation is WAL-logged at a higher-level, and we 
         * will be called at WAL replay. But if checksums are enabled, we need 
         * to still write a WAL record to protect against a torn page, if the 
         * page is flushed to disk before the truncation WAL record. We cannot 
         * use MarkBufferDirtyHint here, because that will not dirty the page 
         * during recovery. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a> <span class='Operator'>&& </span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/xlog.h.html#LN155"><span class='Ref_to_Macro'>XLogHintBitIsNeeded</span></a><span class='Parentheses'>())</span> 
            <a href="../../../include/access/xloginsert.h.html#LN56"><span class='Ref_to_Proto'>log_newpage_buffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN492"><span class='Ref_To_Local'>mapBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if truncByte!=0||truncOf... &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="visibilitymap.c.html#LN463"><span class='Ref_To_Local'>newnblocks</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN466"><span class='Ref_To_Local'>truncBlock</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN104"><span class='Ref_to_Proto'>smgrnblocks</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="visibilitymap.c.html#LN463"><span class='Ref_To_Local'>newnblocks</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* nothing to do, the file was already smaller than requested size */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Truncate the unused VM pages, and send smgr inval message */ 
</span>    <a href="../../../include/storage/smgr.h.html#LN105"><span class='Ref_to_Proto'>smgrtruncate</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN463"><span class='Ref_To_Local'>newnblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We might as well update the local smgr_vm_nblocks setting. smgrtruncate 
     * sent an smgr cache inval message, which will cause other backends to 
     * invalidate their copy of smgr_vm_nblocks, and this one too at the next 
     * command boundary.  But this ensures it isn't outright wrong until then. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Parentheses'>) 
</span>        <a href="visibilitymap.c.html#LN461"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN463"><span class='Ref_To_Local'>newnblocks</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end visibilitymap_truncate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read a visibility map page. 
 * 
 * If the page doesn't exist, InvalidBuffer is returned, or if 'extend' is 
 * true, the visibility map file is extended. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN573"></a><span class='Declare_Function'>vm_readbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>extend</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN575"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We might not have opened the relation at the smgr level yet, or we 
     * might have been forced to close it by a sinval message.  The code below 
     * won't necessarily notice relation extension immediately when extend = 
     * false, so we rely on sinval messages to ensure that our ideas about the 
     * size of the map aren't too far out of date. 
     */ 
</span>    <a href="../../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we haven't cached the size of the visibility map fork yet, check it 
     * first. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN84"><span class='Ref_to_Proto'>smgrexists</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Parentheses'>))</span> 
            <a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN104"><span class='Ref_to_Proto'>smgrnblocks</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, 
</span>                                                      <a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Handle requests beyond EOF */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>&GT;= </span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>extend</span></a><span class='Parentheses'>) 
</span>            <a href="visibilitymap.c.html#LN157"><span class='Ref_to_Proto'>vm_extend</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use ZERO_ON_ERROR mode, and initialize the page if necessary. It's 
     * always safe to clear bits, so it's better to clear corrupt pages than 
     * error out. 
     */ 
</span>    <a href="visibilitymap.c.html#LN575"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN573"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/storage/bufmgr.h.html#LN44"><span class='Ref_to_EnumConst'>RBM_ZERO_ON_ERROR</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN575"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)))</span> 
        <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN575"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="visibilitymap.c.html#LN575"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end vm_readbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Ensure that the visibility map fork is at least vm_nblocks long, extending 
 * it if necessary with zeroed pages. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN625"></a><span class='Declare_Function'>vm_extend</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>vm_nblocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN627"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>vm_nblocks_now</span><span class='Delimiter'>; 
</span><a name="LN628"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>pg</span><span class='Delimiter'>; 
</span> 
    <a href="visibilitymap.c.html#LN628"><span class='Ref_To_Local'>pg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN628"><span class='Ref_To_Local'>pg</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We use the relation extension lock to lock out other backends trying to 
     * extend the visibility map at the same time. It also locks out extension 
     * of the main fork, unnecessarily, but extending the visibility map 
     * happens seldom enough that it doesn't seem worthwhile to have a 
     * separate lock tag type for it. 
     * 
     * Note that another backend might have extended or created the relation 
     * by the time we get the lock. 
     */ 
</span>    <a href="../../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Might have to re-open if a cache flush happened */ 
</span>    <a href="../../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the file first if it doesn't exist.  If smgr_vm_nblocks is 
     * positive then it must exist, no need for an smgrexists call. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>         <a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/storage/smgr.h.html#LN84"><span class='Ref_to_Proto'>smgrexists</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/smgr.h.html#LN90"><span class='Ref_to_Proto'>smgrcreate</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="visibilitymap.c.html#LN627"><span class='Ref_To_Local'>vm_nblocks_now</span></a> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN104"><span class='Ref_to_Proto'>smgrnblocks</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now extend the file */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN627"><span class='Ref_To_Local'>vm_nblocks_now</span></a> <span class='Operator'>&LT; </span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>vm_nblocks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufpage.h.html#LN436"><span class='Ref_to_Proto'>PageSetChecksumInplace</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN628"><span class='Ref_To_Local'>pg</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN627"><span class='Ref_To_Local'>vm_nblocks_now</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/smgr.h.html#LN94"><span class='Ref_to_Proto'>smgrextend</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN28"><span class='Ref_to_EnumConst'>VISIBILITYMAP_FORKNUM</span></a><span class='Delimiter'>, </span><a href="visibilitymap.c.html#LN627"><span class='Ref_To_Local'>vm_nblocks_now</span></a><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="visibilitymap.c.html#LN628"><span class='Ref_To_Local'>pg</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="visibilitymap.c.html#LN627"><span class='Ref_To_Local'>vm_nblocks_now</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Send a shared-inval message to force other backends to close any smgr 
     * references they may have for this rel, which we are about to change. 
     * This is a useful optimization because it means that backends don't have 
     * to keep checking for creation or extension of the file, which happens 
     * infrequently. 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN51"><span class='Ref_to_Proto'>CacheInvalidateSmgr</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update local cache with the up-to-date size */ 
</span>    <a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN56"><span class='Ref_to_Member'>smgr_vm_nblocks</span></a> <span class='Operator'>= </span><a href="visibilitymap.c.html#LN627"><span class='Ref_To_Local'>vm_nblocks_now</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN625"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="visibilitymap.c.html#LN628"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end vm_extend &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>