<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\nbtree\nbtinsert.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\nbtree\nbtinsert.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:29 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * nbtinsert.c 
 *    Item insertion in Lehman and Yao btrees for Postgres. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/nbtree/nbtinsert.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/nbtree.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/nbtxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* context data for _bt_checksplitloc */ 
</span><a name="LN31"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>newitemsz</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* size of new item to be inserted */ 
</span><a name="LN32"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fillfactor</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* needed when splitting rightmost page */ 
</span><a name="LN33"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>is_leaf</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* T if splitting a leaf page */ 
</span><a name="LN34"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>is_rightmost</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* T if splitting a rightmost page */ 
</span><a name="LN35"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Member'>newitemoff</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* where the new item is to be inserted */ 
</span><a name="LN36"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>leftspace</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* space available for items on left page */ 
</span><a name="LN37"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>rightspace</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* space available for items on right page */ 
</span><a name="LN38"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>olddataitemstotal</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* space taken by old items */ 
</span> 
<a name="LN40"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>have_split</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* found a valid split? */ 
</span> 
    <span class='Comment_Multi_Line'>/* these fields valid only if have_split is true */ 
</span><a name="LN43"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>newitemonleft</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* new item on left or right of best split */ 
</span><a name="LN44"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Member'>firstright</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* best split point */ 
</span><a name="LN45"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>best_delta</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* best size delta so far */ 
</span><a name="LN46"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>FindSplitData</span><span class='Delimiter'>; 
</span> 
 
<a name="LN49"></a><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Prototype'>_bt_newroot</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>lbuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>rbuf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN51"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Prototype'>_bt_check_unique</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN52"></a>                 <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, 
</span><a name="LN53"></a>                 <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>itup_scankey</span><span class='Delimiter'>, 
</span><a name="LN54"></a>                 <a href="../../../include/access/genam.h.html#LN110"><span class='Ref_to_Enum'>IndexUniqueCheck</span></a> <span class='Declare_Parameter'>checkUnique</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>is_unique</span><span class='Delimiter'>, 
</span><a name="LN55"></a>                 <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>speculativeToken</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN56"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_findinsertloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN57"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bufptr</span><span class='Delimiter'>, 
</span><a name="LN58"></a>                  <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>offsetptr</span><span class='Delimiter'>, 
</span><a name="LN59"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>keysz</span><span class='Delimiter'>, 
</span><a name="LN60"></a>                  <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>scankey</span><span class='Delimiter'>, 
</span><a name="LN61"></a>                  <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, 
</span><a name="LN62"></a>                  <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN63"></a>                  <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_insertonpg</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>cbuf</span><span class='Delimiter'>, 
</span><a name="LN65"></a>               <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN66"></a>               <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN67"></a>               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>newitemoff</span><span class='Delimiter'>, 
</span><a name="LN68"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>split_only_page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Prototype'>_bt_split</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>cbuf</span><span class='Delimiter'>, 
</span><a name="LN70"></a>          <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>firstright</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>newitemoff</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newitemsz</span><span class='Delimiter'>, 
</span><a name="LN71"></a>          <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>newitem</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>newitemonleft</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN72"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_insert_parent</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>rbuf</span><span class='Delimiter'>, 
</span><a name="LN73"></a>                  <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_root</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_only</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Prototype'>_bt_findsplitloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN75"></a>                 <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>newitemoff</span><span class='Delimiter'>, 
</span><a name="LN76"></a>                 <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newitemsz</span><span class='Delimiter'>, 
</span><a name="LN77"></a>                 <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>newitemonleft</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_checksplitloc</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN28"><span class='Ref_to_Typedef'>FindSplitData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN79"></a>                  <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>firstoldonright</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>newitemonleft</span><span class='Delimiter'>, 
</span><a name="LN80"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>dataitemstoleft</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>firstoldonrightsz</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN81"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>_bt_pgaddtup</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsize</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN82"></a>             <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>itup_off</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN83"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>_bt_isequal</span><span class='Parentheses'>(</span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>itupdesc</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Delimiter'>, 
</span><a name="LN84"></a>            <span class='Keyword'>int </span><span class='Declare_Parameter'>keysz</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>scankey</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN85"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_vacuum_one_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_doinsert() -- Handle insertion of a single index tuple in the tree. 
 * 
 *      This routine is called by the public interface routine, btinsert. 
 *      By here, itup is filled in, including the TID. 
 * 
 *      If checkUnique is UNIQUE_CHECK_NO or UNIQUE_CHECK_PARTIAL, this 
 *      will allow duplicates.  Otherwise (UNIQUE_CHECK_YES or 
 *      UNIQUE_CHECK_EXISTING) it will throw error for a duplicate. 
 *      For UNIQUE_CHECK_EXISTING we merely run the duplicate check, and 
 *      don't actually insert. 
 * 
 *      The result value is only significant for UNIQUE_CHECK_PARTIAL: 
 *      it must be TRUE if the entry is known unique, else FALSE. 
 *      (In the current implementation we'll also return TRUE after a 
 *      successful UNIQUE_CHECK_YES or UNIQUE_CHECK_EXISTING call, but 
 *      that's just a coding artifact.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN107"></a><span class='Declare_Function'>_bt_doinsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN108"></a>             <a href="../../../include/access/genam.h.html#LN110"><span class='Ref_to_Enum'>IndexUniqueCheck</span></a> <span class='Declare_Parameter'>checkUnique</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN110"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_unique</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN111"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnatts<span class='Delimiter'>; 
</span><a name="LN112"></a>    <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a>     <span class='Declare_Local'>itup_scankey</span><span class='Delimiter'>; 
</span><a name="LN113"></a>    <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a>     <span class='Declare_Local'>stack</span><span class='Delimiter'>; 
</span><a name="LN114"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN115"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we need an insertion scan key to do our search, so build one */ 
</span>    <a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a> <span class='Operator'>= </span><a href="nbtutils.c.html#LN60"><span class='Ref_to_Func'>_bt_mkscankey</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN120"></a><span class='Label'>top</span><span class='Operator'>: 
</span>    <span class='Comment_Multi_Line'>/* find the first page containing this key */ 
</span>    <a href="nbtinsert.c.html#LN113"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="nbtsearch.c.html#LN95"><span class='Ref_to_Func'>_bt_search</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN111"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN115"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* trade in our read lock for a write lock */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page was split between the time that we surrendered our read 
     * lock and acquired our write lock, then this page may no longer be the 
     * right place for the key we want to insert.  In this case, we need to 
     * move right in the tree.  See Lehman and Yao for an excruciatingly 
     * precise description. 
     */ 
</span>    <a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="nbtsearch.c.html#LN212"><span class='Ref_to_Func'>_bt_moveright</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN111"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                        <span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN113"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're not allowing duplicates, make sure the key isn't already in 
     * the index. 
     * 
     * NOTE: obviously, _bt_check_unique can only detect keys that are already 
     * in the index; so it cannot defend against concurrent insertions of the 
     * same key.  We protect against that by means of holding a write lock on 
     * the target page.  Any other would-be inserter of the same key must 
     * acquire a write lock on the same target page, so only one would-be 
     * inserter can be making the check at one time.  Furthermore, once we are 
     * past the check we hold write locks continuously until we have performed 
     * our insertion, so no later inserter can fail to see our insertion. 
     * (This requires some care in _bt_insertonpg.) 
     * 
     * If we must wait for another xact, we release the lock while waiting, 
     * and then must start over completely. 
     * 
     * For a partial uniqueness check, we don't wait for the other xact. Just 
     * let the tuple in and return false for possibly non-unique, or true for 
     * definitely unique. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN108"><span class='Ref_to_Parameter'>checkUnique</span></a> <span class='Operator'>!= </span><a href="../../../include/access/genam.h.html#LN112"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_NO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN163"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xwait</span><span class='Delimiter'>; 
</span><a name="LN164"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>speculativeToken</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN115"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="nbtsearch.c.html#LN321"><span class='Ref_to_Func'>_bt_binsrch</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN111"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN163"><span class='Ref_To_Local'>xwait</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN51"><span class='Ref_to_Proto'>_bt_check_unique</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN108"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN115"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Delimiter'>, 
</span>                                 <a href="nbtinsert.c.html#LN108"><span class='Ref_to_Parameter'>checkUnique</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN110"><span class='Ref_To_Local'>is_unique</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN164"><span class='Ref_To_Local'>speculativeToken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN163"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Have to wait for the other guy ... */ 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If it's a speculative insertion, wait for it to finish (ie. to 
             * go ahead with the insertion, or kill the tuple).  Otherwise 
             * wait for the transaction to finish as usual. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN164"><span class='Ref_To_Local'>speculativeToken</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/lmgr.h.html#LN84"><span class='Ref_to_Proto'>SpeculativeInsertionWait</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN163"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN164"><span class='Ref_To_Local'>speculativeToken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN163"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN30"><span class='Ref_to_EnumConst'>XLTW_InsertIndex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* start over... */ 
</span>            <a href="nbtutils.c.html#LN162"><span class='Ref_to_Func'>_bt_freestack</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN113"><span class='Ref_To_Local'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="nbtinsert.c.html#LN120"><span class='Ref_to_Label'>top</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if checkUnique!=UNIQUE_C... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN108"><span class='Ref_to_Parameter'>checkUnique</span></a> <span class='Operator'>!= </span><a href="../../../include/access/genam.h.html#LN115"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_EXISTING</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The only conflict predicate locking cares about for indexes is when 
         * an index tuple insert conflicts with an existing lock.  Since the 
         * actual location of the insert is hard to predict because of the 
         * random search used to prevent O(N^2) performance when there are 
         * many duplicate entries, we can just use the "first valid" page. 
         */ 
</span>        <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* do the insertion */ 
</span>        <a href="nbtinsert.c.html#LN56"><span class='Ref_to_Proto'>_bt_findinsertloc</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN115"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN111"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, 
</span>                          <a href="nbtinsert.c.html#LN113"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN108"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN64"><span class='Ref_to_Proto'>_bt_insertonpg</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN113"><span class='Ref_To_Local'>stack</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN115"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* just release the buffer */ 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN107"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN114"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* be tidy */ 
</span>    <a href="nbtutils.c.html#LN162"><span class='Ref_to_Func'>_bt_freestack</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN113"><span class='Ref_To_Local'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtutils.c.html#LN153"><span class='Ref_to_Func'>_bt_freeskey</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN112"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtinsert.c.html#LN110"><span class='Ref_To_Local'>is_unique</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_doinsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_check_unique() -- Check for violation of unique index constraint 
 * 
 * offset points to the first possible item that could conflict. It can 
 * also point to end-of-page, which means that the first tuple to check 
 * is the first tuple on the next page. 
 * 
 * Returns InvalidTransactionId if there is no conflict, else an xact ID 
 * we must wait for to see if it commits a conflicting tuple.   If an actual 
 * conflict is detected, no return --- just ereport().  If an xact ID is 
 * returned, and the conflicting tuple still has a speculative insertion in 
 * progress, *speculativeToken is set to non-zero, and the caller can wait for 
 * the verdict on the insertion using SpeculativeInsertionWait(). 
 * 
 * However, if checkUnique == UNIQUE_CHECK_PARTIAL, we always return 
 * InvalidTransactionId because we don't want to wait.  In this case we 
 * set *is_unique to false if there is a potential conflict, and the 
 * core code must redo the uniqueness check later. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN239"></a><span class='Declare_Function'>_bt_check_unique</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Delimiter'>, 
</span><a name="LN240"></a>                 <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>itup_scankey</span><span class='Delimiter'>, 
</span><a name="LN241"></a>                 <a href="../../../include/access/genam.h.html#LN110"><span class='Ref_to_Enum'>IndexUniqueCheck</span></a> <span class='Declare_Parameter'>checkUnique</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>is_unique</span><span class='Delimiter'>, 
</span><a name="LN242"></a>                 <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>speculativeToken</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN244"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>itupdesc</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN245"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnatts<span class='Delimiter'>; 
</span><a name="LN246"></a>    <a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Local'>SnapshotDirty</span><span class='Delimiter'>; 
</span><a name="LN247"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN248"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN249"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN250"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>nbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN251"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assume unique until we find a duplicate */ 
</span>    <span class='Operator'>*</span><a href="nbtinsert.c.html#LN241"><span class='Ref_to_Parameter'>is_unique</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/tqual.h.html#LN99"><span class='Ref_to_Macro'>InitDirtySnapshot</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN246"><span class='Ref_To_Local'>SnapshotDirty</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN247"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan over all equal tuples, looking for live conflicts. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN267"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>curitemid</span><span class='Delimiter'>; 
</span><a name="LN268"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>curitup</span><span class='Delimiter'>; 
</span><a name="LN269"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * make sure the offset points to an actual item before trying to 
         * examine it... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN247"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtinsert.c.html#LN267"><span class='Ref_To_Local'>curitemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We can skip items that are marked killed. 
             * 
             * Formerly, we applied _bt_isequal() before checking the kill 
             * flag, so as to fall out of the item loop as soon as possible. 
             * However, in the presence of heavy update activity an index may 
             * contain many killed items with the same key; running 
             * _bt_isequal() on each killed item gets expensive. Furthermore 
             * it is likely that the non-killed version of each key appears 
             * first, so that we didn't actually get to exit any sooner 
             * anyway. So now we just advance over killed items as quickly as 
             * we can. We only apply _bt_isequal() when we get to a non-killed 
             * item or the end of the page. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN267"><span class='Ref_To_Local'>curitemid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN295"></a>                <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Local'>htid</span><span class='Delimiter'>; 
</span><a name="LN296"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_dead</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * _bt_compare returns 0 for (1,NULL) and (1,NULL) - this's 
                 * how we handling NULLs - and so we must not use _bt_compare 
                 * in real comparison, but only for ordering/finding items on 
                 * pages. - vadim 03/24/97 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN83"><span class='Ref_to_Proto'>_bt_isequal</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN244"><span class='Ref_To_Local'>itupdesc</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN245"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>itup_scankey</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* we're past all the equal tuples */ 
</span> 
                <span class='Comment_Multi_Line'>/* okay, we gotta fetch the heap tuple ... */ 
</span>                <a href="nbtinsert.c.html#LN268"><span class='Ref_To_Local'>curitup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN267"><span class='Ref_To_Local'>curitemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN295"><span class='Ref_To_Local'>htid</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN268"><span class='Ref_To_Local'>curitup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If we are doing a recheck, we expect to find the tuple we 
                 * are rechecking.  It's not a duplicate, but we have to keep 
                 * scanning. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN241"><span class='Ref_to_Parameter'>checkUnique</span></a> <span class='Operator'>== </span><a href="../../../include/access/genam.h.html#LN115"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_EXISTING</span></a> <span class='Operator'>&& 
</span>                    <a href="../../storage/page/itemptr.c.html#LN50"><span class='Ref_to_Func'>ItemPointerCompare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN295"><span class='Ref_To_Local'>htid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="nbtinsert.c.html#LN251"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * We check the whole HOT-chain to see if there is any tuple 
                 * that satisfies SnapshotDirty.  This is necessary because we 
                 * have just a single index entry for the entire chain. 
                 */ 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN140"><span class='Ref_to_Proto'>heap_hot_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN295"><span class='Ref_To_Local'>htid</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN246"><span class='Ref_To_Local'>SnapshotDirty</span></a><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="nbtinsert.c.html#LN296"><span class='Ref_To_Local'>all_dead</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span><a name="LN330"></a>                    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xwait</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * It is a duplicate. If we are only doing a partial 
                     * check, then don't bother checking if the tuple is being 
                     * updated in another transaction. Just return the fact 
                     * that it is a potential conflict and leave the full 
                     * check till later. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN241"><span class='Ref_to_Parameter'>checkUnique</span></a> <span class='Operator'>== </span><a href="../../../include/access/genam.h.html#LN114"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_PARTIAL</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>                            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Operator'>*</span><a href="nbtinsert.c.html#LN241"><span class='Ref_to_Parameter'>is_unique</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Control'>return</span> <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * If this tuple is being updated by other transaction 
                     * then we have to wait for its commit/abort. 
                     */ 
</span>                    <a href="nbtinsert.c.html#LN330"><span class='Ref_To_Local'>xwait</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN246"><span class='Ref_To_Local'>SnapshotDirty</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> <span class='Operator'>? 
</span>                        <a href="nbtinsert.c.html#LN246"><span class='Ref_To_Local'>SnapshotDirty</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>: </span><a href="nbtinsert.c.html#LN246"><span class='Ref_To_Local'>SnapshotDirty</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN330"><span class='Ref_To_Local'>xwait</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>                            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Comment_Multi_Line'>/* Tell _bt_doinsert to wait... */ 
</span>                        <span class='Operator'>*</span><a href="nbtinsert.c.html#LN242"><span class='Ref_to_Parameter'>speculativeToken</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN246"><span class='Ref_To_Local'>SnapshotDirty</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN101"><span class='Ref_to_Member'>speculativeToken</span></a><span class='Delimiter'>; 
</span>                        <span class='Control'>return</span> <a href="nbtinsert.c.html#LN330"><span class='Ref_To_Local'>xwait</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Otherwise we have a definite conflict.  But before 
                     * complaining, look to see if the tuple we want to insert 
                     * is itself now committed dead --- if so, don't complain. 
                     * This is a waste of time in normal scenarios but we must 
                     * do it to support CREATE INDEX CONCURRENTLY. 
                     * 
                     * We must follow HOT-chains here because during 
                     * concurrent index build, we insert the root TID though 
                     * the actual tuple may be somewhere in the HOT-chain. 
                     * While following the chain we might not stop at the 
                     * exact tuple which triggered the insert, but that's OK 
                     * because if we find a live tuple anywhere in this chain, 
                     * we have a unique key conflict.  The other live tuple is 
                     * not part of this chain because it had a different index 
                     * entry. 
                     */ 
</span>                    <a href="nbtinsert.c.html#LN295"><span class='Ref_To_Local'>htid</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/heapam.h.html#LN140"><span class='Ref_to_Proto'>heap_hot_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN295"><span class='Ref_To_Local'>htid</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/tqual.h.html#LN26"><span class='Ref_to_Const'>SnapshotSelf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* Normal case --- it's still live */ 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * It's been deleted, so no error, and no need to 
                         * continue searching 
                         */ 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Check for a conflict-in as we would if we were going to 
                     * write to this page.  We aren't actually going to write, 
                     * but we want a chance to report SSI conflicts that would 
                     * otherwise be masked by this unique constraint 
                     * violation. 
                     */ 
</span>                    <a href="../../../include/storage/predicate.h.html#LN61"><span class='Ref_to_Proto'>CheckForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * This is a definite conflict.  Break the tuple down into 
                     * datums and report the error.  But first, make sure we 
                     * release the buffer locks we're holding --- 
                     * BuildIndexValueDescription could make catalog accesses, 
                     * which in the worst case might touch this same index and 
                     * cause deadlocks. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>                        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Delimiter'>{ 
</span><a name="LN416"></a>                        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN417"></a>                        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN418"></a>                        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>key_desc</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/access/itup.h.html#LN146"><span class='Ref_to_Proto'>index_deform_tuple</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                           <a href="nbtinsert.c.html#LN416"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN417"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="nbtinsert.c.html#LN418"><span class='Ref_To_Local'>key_desc</span></a> <span class='Operator'>= </span><a href="../index/genam.c.html#LN175"><span class='Ref_to_Func'>BuildIndexValueDescription</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN416"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, 
</span>                                                              <a href="nbtinsert.c.html#LN417"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNIQUE_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate key value violates unique constraint \"%s\""</span><span class='Delimiter'>, 
</span>                                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                               <a href="nbtinsert.c.html#LN418"><span class='Ref_To_Local'>key_desc</span></a> <span class='Operator'>? </span><a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Key %s already exists."</span><span class='Delimiter'>, 
</span>                                                    <a href="nbtinsert.c.html#LN418"><span class='Ref_To_Local'>key_desc</span></a><span class='Parentheses'>)</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if heap_hot_search(&htid... &raquo; </span> 
                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN296"><span class='Ref_To_Local'>all_dead</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * The conflicting tuple (or whole HOT chain) is dead to 
                     * everyone, so we may as well mark the index entry 
                     * killed. 
                     */ 
</span>                    <a href="../../../include/storage/itemid.h.html#LN177"><span class='Ref_to_Macro'>ItemIdMarkDead</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN267"><span class='Ref_To_Local'>curitemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/nbtree.h.html#LN75"><span class='Ref_to_Const'>BTP_HAS_GARBAGE</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Mark buffer with a dirty hint, since state is not 
                     * crucial. Be sure to mark the proper buffer dirty. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN211"><span class='Ref_to_Proto'>MarkBufferDirtyHint</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="../../../include/storage/bufmgr.h.html#LN211"><span class='Ref_to_Proto'>MarkBufferDirtyHint</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !ItemIdIsDead(curitem... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if offset&LT;=maxoff &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Advance to next tuple to continue checking. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN247"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>            <a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* If scankey == hikey we gotta check the next page too */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN83"><span class='Ref_to_Proto'>_bt_isequal</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN244"><span class='Ref_To_Local'>itupdesc</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Delimiter'>, 
</span>                             <a href="nbtinsert.c.html#LN245"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>itup_scankey</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Advance to next non-dead page --- there must be one */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="nbtinsert.c.html#LN269"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN483"><span class='Ref_to_Proto'>_bt_relandgetbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN269"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN180"><span class='Ref_to_Macro'>P_IGNORE</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"fell off the end of index \"%s\""</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="nbtinsert.c.html#LN247"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN248"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN240"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN249"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we are doing a recheck then we should have found the tuple we are 
     * checking.  Otherwise there's something very wrong --- probably, the 
     * index is on a non-immutable expression. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN241"><span class='Ref_to_Parameter'>checkUnique</span></a> <span class='Operator'>== </span><a href="../../../include/access/genam.h.html#LN115"><span class='Ref_to_EnumConst'>UNIQUE_CHECK_EXISTING</span></a> <span class='Operator'>&& !</span><a href="nbtinsert.c.html#LN251"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"failed to re-find tuple within index \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>         <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"This may be because of a non-immutable index expression."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN239"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN250"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_check_unique &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_findinsertloc() -- Finds an insert location for a tuple 
 * 
 *      If the new key is equal to one or more existing keys, we can 
 *      legitimately place it anywhere in the series of equal keys --- in fact, 
 *      if the new key is equal to the page's "high key" we can place it on 
 *      the next page.  If it is equal to the high key, and there's not room 
 *      to insert the new tuple on the current page without splitting, then 
 *      we can move right hoping to find more free space and avoid a split. 
 *      (We should not move right indefinitely, however, since that leads to 
 *      O(N^2) insertion behavior in the presence of many equal keys.) 
 *      Once we have chosen the page to put the key on, we'll insert it before 
 *      any existing equal keys because of the way _bt_binsrch() works. 
 * 
 *      If there's not enough room in the space, we try to make room by 
 *      removing any LP_DEAD tuples. 
 * 
 *      On entry, *bufptr and *offsetptr point to the first legal position 
 *      where the new tuple could be inserted.  The caller should hold an 
 *      exclusive lock on *bufptr.  *offsetptr can also be set to 
 *      InvalidOffsetNumber, in which case the function will search for the 
 *      right location within the page if needed.  On exit, they point to the 
 *      chosen insert location.  If _bt_findinsertloc decides to move right, 
 *      the lock and pin on the original page will be released and the new 
 *      page returned to the caller is exclusively locked instead. 
 * 
 *      newtup is the new tuple we're inserting, and scankey is an insertion 
 *      type scan key for it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN540"></a><span class='Declare_Function'>_bt_findinsertloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN541"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bufptr</span><span class='Delimiter'>, 
</span><a name="LN542"></a>                  <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>offsetptr</span><span class='Delimiter'>, 
</span><a name="LN543"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>keysz</span><span class='Delimiter'>, 
</span><a name="LN544"></a>                  <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>scankey</span><span class='Delimiter'>, 
</span><a name="LN545"></a>                  <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, 
</span><a name="LN546"></a>                  <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN547"></a>                  <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN549"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span> <span class='Operator'>= *</span><a href="nbtinsert.c.html#LN541"><span class='Ref_to_Parameter'>bufptr</span></a><span class='Delimiter'>; 
</span><a name="LN550"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN549"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN551"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itemsz</span><span class='Delimiter'>; 
</span><a name="LN552"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lpageop</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>movedright</span><span class='Delimiter'>, 
</span><a name="LN554"></a>                <span class='Declare_Local'>vacuumed</span><span class='Delimiter'>; 
</span><a name="LN555"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>newitemoff</span><span class='Delimiter'>; 
</span><a name="LN556"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>firstlegaloff</span> <span class='Operator'>= *</span><a href="nbtinsert.c.html#LN542"><span class='Ref_to_Parameter'>offsetptr</span></a><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN70"><span class='Ref_to_Macro'>IndexTupleDSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="nbtinsert.c.html#LN545"><span class='Ref_to_Parameter'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Multi_Line'>/* be safe, PageAddItem will do this but we 
                                 * need to be consistent */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check whether the item can fit on a btree page at all. (Eventually, we 
     * ought to try to apply TOAST methods if not.) We actually need to be 
     * able to fit three items on every page, so restrict any one item to 1/3 
     * the per-page available space. Note that at this point, itemsz doesn't 
     * include the ItemId. 
     * 
     * NOTE: if you change this, see also the similar code in _bt_buildadd(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/nbtree.h.html#LN118"><span class='Ref_to_Macro'>BTMaxItemSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                   <a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN118"><span class='Ref_to_Macro'>BTMaxItemSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Values larger than 1/3 of a buffer page cannot be indexed.\n"</span> 
                <span class='String'>"Consider a function index of an MD5 hash of the value, "</span> 
                <span class='String'>"or use full text indexing."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN547"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * If we will need to split the page to put the item on this page, 
     * check whether we can put the tuple somewhere to the right, 
     * instead.  Keep scanning right until we 
     *      (a) find a page with enough free space, 
     *      (b) reach the last page where the tuple can legally go, or 
     *      (c) get tired of searching. 
     * (c) is not flippant; it is important because if there are many 
     * pages' worth of equal keys, it's better to split one of the early 
     * pages than to scan all the way to the end of the run of equal keys 
     * on every insert.  We implement "get tired" as a random choice, 
     * since stopping after scanning a fixed number of pages wouldn't work 
     * well (we'd never reach the right-hand side of previously split 
     * pages).  Currently the probability of moving right is set at 0.99, 
     * which may seem too high to change the behavior much, but it does an 
     * excellent job of preventing O(N^2) behavior with many equal keys. 
     *---------- 
     */ 
</span>    <a href="nbtinsert.c.html#LN553"><span class='Ref_To_Local'>movedright</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN554"><span class='Ref_To_Local'>vacuumed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN607"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuf</span><span class='Delimiter'>; 
</span><a name="LN608"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rblkno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * before considering moving right, see if we can obtain enough space 
         * by erasing LP_DEAD items 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/nbtree.h.html#LN181"><span class='Ref_to_Macro'>P_HAS_GARBAGE</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="nbtinsert.c.html#LN85"><span class='Ref_to_Proto'>_bt_vacuum_one_page</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN549"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN547"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * remember that we vacuumed this page, because that makes the 
             * hint supplied by the caller invalid 
             */ 
</span>            <a href="nbtinsert.c.html#LN554"><span class='Ref_To_Local'>vacuumed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="nbtinsert.c.html#LN551"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* OK, now we have enough space */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * nope, so check conditions (b) and (c) enumerated above 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="nbtsearch.c.html#LN426"><span class='Ref_to_Func'>_bt_compare</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN543"><span class='Ref_to_Parameter'>keysz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN544"><span class='Ref_to_Parameter'>scankey</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN199"><span class='Ref_to_Const'>MAX_RANDOM_VALUE</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * step right to next non-dead page 
         * 
         * must write-lock that page before releasing write lock on current 
         * page; else someone else's _bt_check_unique scan could fail to see 
         * our insertion.  write locks on intermediate dead pages won't do 
         * because we don't know when they will get de-linked from the tree. 
         */ 
</span>        <a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN608"><span class='Ref_To_Local'>rblkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN483"><span class='Ref_to_Proto'>_bt_relandgetbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN608"><span class='Ref_To_Local'>rblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN550"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If this page was incompletely split, finish the split now. We 
             * do this while holding a lock on the left sibling, which is not 
             * good because finishing the split could be a fairly lengthy 
             * operation.  But this should happen very seldom. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/nbtree.h.html#LN472"><span class='Ref_to_Proto'>_bt_finish_split</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN546"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN180"><span class='Ref_to_Macro'>P_IGNORE</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"fell off the end of index \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="nbtinsert.c.html#LN608"><span class='Ref_To_Local'>rblkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN549"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN549"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN607"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN553"><span class='Ref_To_Local'>movedright</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN554"><span class='Ref_To_Local'>vacuumed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while PageGetFreeSpace(page... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Now we are on the right page, so find the insert position. If we moved 
     * right at all, we know we should insert at the start of the page. If we 
     * didn't move right, we can use the firstlegaloff hint if the caller 
     * supplied one, unless we vacuumed the page which might have moved tuples 
     * around making the hint invalid. If we didn't move right or can't use 
     * the hint, find the position by searching. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN553"><span class='Ref_To_Local'>movedright</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN555"><span class='Ref_To_Local'>newitemoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN552"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN556"><span class='Ref_To_Local'>firstlegaloff</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a> <span class='Operator'>&& !</span><a href="nbtinsert.c.html#LN554"><span class='Ref_To_Local'>vacuumed</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN555"><span class='Ref_To_Local'>newitemoff</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN556"><span class='Ref_To_Local'>firstlegaloff</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nbtinsert.c.html#LN555"><span class='Ref_To_Local'>newitemoff</span></a> <span class='Operator'>= </span><a href="nbtsearch.c.html#LN321"><span class='Ref_to_Func'>_bt_binsrch</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN540"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN549"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN543"><span class='Ref_to_Parameter'>keysz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN544"><span class='Ref_to_Parameter'>scankey</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="nbtinsert.c.html#LN541"><span class='Ref_to_Parameter'>bufptr</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN549"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="nbtinsert.c.html#LN542"><span class='Ref_to_Parameter'>offsetptr</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN555"><span class='Ref_To_Local'>newitemoff</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_findinsertloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/*---------- 
 *  _bt_insertonpg() -- Insert a tuple on a particular page in the index. 
 * 
 *      This recursive procedure does the following things: 
 * 
 *          +  if necessary, splits the target page (making sure that the 
 *             split is equitable as far as post-insert free space goes). 
 *          +  inserts the tuple. 
 *          +  if the page was split, pops the parent stack, and finds the 
 *             right place to insert the new child pointer (by walking 
 *             right using information stored in the parent stack). 
 *          +  invokes itself with the appropriate tuple for the right 
 *             child page on the parent. 
 *          +  updates the metapage if a true root or fast root is split. 
 * 
 *      On entry, we must have the correct buffer in which to do the 
 *      insertion, and the buffer must be pinned and write-locked.  On return, 
 *      we will have dropped both the pin and the lock on the buffer. 
 * 
 *      When inserting to a non-leaf page, 'cbuf' is the left-sibling of the 
 *      page we're inserting the downlink for.  This function will clear the 
 *      INCOMPLETE_SPLIT flag on it, and release the buffer. 
 * 
 *      The locking interactions in this code are critical.  You should 
 *      grok Lehman and Yao's paper before making any changes.  In addition, 
 *      you need to understand how we disambiguate duplicate keys in this 
 *      implementation, in order to be able to find our location using 
 *      L&Y "move right" operations.  Since we may insert duplicate user 
 *      keys, and since these dups may propagate up the tree, we use the 
 *      'afteritem' parameter to position ourselves correctly for the 
 *      insertion on internal pages. 
 *---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN733"></a><span class='Declare_Function'>_bt_insertonpg</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN734"></a>               <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN735"></a>               <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>cbuf</span><span class='Delimiter'>, 
</span><a name="LN736"></a>               <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN737"></a>               <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN738"></a>               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>newitemoff</span><span class='Delimiter'>, 
</span><a name="LN739"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>split_only_page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN741"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN742"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lpageop</span><span class='Delimiter'>; 
</span><a name="LN743"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>firstright</span> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span><a name="LN744"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itemsz</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN741"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN741"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* child buffer must be given iff inserting on an internal page */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>) </span><span class='Operator'>== !</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The caller should've finished any incomplete splits already. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot insert to incompletely split page %u"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN70"><span class='Ref_to_Macro'>IndexTupleDSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="nbtinsert.c.html#LN737"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Multi_Line'>/* be safe, PageAddItem will do this but we 
                                 * need to be consistent */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do we need to split the page to fit the item on it? 
     * 
     * Note: PageGetFreeSpace() subtracts sizeof(ItemIdData) from its result, 
     * so this comparison is correct even though we appear to be accounting 
     * only for the item and not for its line pointer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN741"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN770"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_root</span> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN176"><span class='Ref_to_Macro'>P_ISROOT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN771"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_only</span> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN173"><span class='Ref_to_Macro'>P_LEFTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN772"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>newitemonleft</span><span class='Delimiter'>; 
</span><a name="LN773"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuf</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Choose the split point */ 
</span>        <a href="nbtinsert.c.html#LN743"><span class='Ref_To_Local'>firstright</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN74"><span class='Ref_to_Proto'>_bt_findsplitloc</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN741"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, 
</span>                                      <a href="nbtinsert.c.html#LN738"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="nbtinsert.c.html#LN772"><span class='Ref_To_Local'>newitemonleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* split the buffer into left and right halves */ 
</span>        <a href="nbtinsert.c.html#LN773"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN69"><span class='Ref_to_Proto'>_bt_split</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN743"><span class='Ref_To_Local'>firstright</span></a><span class='Delimiter'>, 
</span>                         <a href="nbtinsert.c.html#LN738"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN737"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN772"><span class='Ref_To_Local'>newitemonleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/predicate.h.html#LN53"><span class='Ref_to_Proto'>PredicateLockPageSplit</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN773"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/*---------- 
         * By here, 
         * 
         *      +  our target page has been split; 
         *      +  the original tuple has been inserted; 
         *      +  we have write locks on both the old (left half) 
         *         and new (right half) buffers, after the split; and 
         *      +  we know the key we want to insert into the parent 
         *         (it's the "high key" on the left child page). 
         * 
         * We're ready to do the parent insertion.  We need to hold onto the 
         * locks for the child pages until we locate the parent, but we can 
         * release them before doing the actual insertion (see Lehman and Yao 
         * for the reasoning). 
         *---------- 
         */ 
</span>        <a href="nbtinsert.c.html#LN72"><span class='Ref_to_Proto'>_bt_insert_parent</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN773"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN736"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN770"><span class='Ref_To_Local'>is_root</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN771"><span class='Ref_To_Local'>is_only</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PageGetFreeSpace(page... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN807"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN808"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN809"></a>        <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN810"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>itup_off</span><span class='Delimiter'>; 
</span><a name="LN811"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>itup_blkno</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN810"><span class='Ref_To_Local'>itup_off</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN738"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN811"><span class='Ref_To_Local'>itup_blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we are doing this insert because we split a page that was the 
         * only one on its tree level, but was not the root, it may have been 
         * the "fast root".  We need to ensure that the fast root link points 
         * at or above the current page.  We can safely acquire a lock on the 
         * metapage here --- see comments for _bt_newroot(). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN739"><span class='Ref_to_Parameter'>split_only_page</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN808"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN808"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>&GT;= </span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* no update wanted */ 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Do the update.  No ereport(ERROR) until changes are logged */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN81"><span class='Ref_to_Proto'>_bt_pgaddtup</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN741"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN744"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN737"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN738"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add new item to block %u in index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="nbtinsert.c.html#LN811"><span class='Ref_To_Local'>itup_blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN811"><span class='Ref_To_Local'>itup_blkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* clear INCOMPLETE_SPLIT flag on child if inserting a downlink */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN858"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>cpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN859"></a>            <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>cpageop</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN858"><span class='Ref_To_Local'>cpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN859"><span class='Ref_To_Local'>cpageop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN859"><span class='Ref_To_Local'>cpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/nbtree.h.html#LN76"><span class='Ref_to_Const'>BTP_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN869"></a>            <a href="../../../include/access/nbtxlog.h.html#LN63"><span class='Ref_to_Struct'>xl_btree_insert</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN870"></a>            <a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a> <span class='Declare_Local'>xlmeta</span><span class='Delimiter'>; 
</span><a name="LN871"></a>            <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>xlinfo</span><span class='Delimiter'>; 
</span><a name="LN872"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN873"></a>            <a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a> <span class='Declare_Local'>trunctuple</span><span class='Delimiter'>; 
</span> 
            <a href="nbtinsert.c.html#LN869"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN65"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN810"><span class='Ref_To_Local'>itup_off</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN869"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN68"><span class='Ref_to_Const'>SizeOfBtreeInsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
                <a href="nbtinsert.c.html#LN871"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtxlog.h.html#LN25"><span class='Ref_to_Const'>XLOG_BTREE_INSERT_LEAF</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Register the left child whose INCOMPLETE_SPLIT flag was 
                 * cleared. 
                 */ 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="nbtinsert.c.html#LN871"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtxlog.h.html#LN26"><span class='Ref_to_Const'>XLOG_BTREE_INSERT_UPPER</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nbtinsert.c.html#LN870"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN47"><span class='Ref_to_Member'>root</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN870"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN48"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN870"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN49"><span class='Ref_to_Member'>fastroot</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN870"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN50"><span class='Ref_to_Member'>fastlevel</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN809"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN870"><span class='Ref_To_Local'>xlmeta</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="nbtinsert.c.html#LN871"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtxlog.h.html#LN27"><span class='Ref_to_Const'>XLOG_BTREE_INSERT_META</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Read comments in _bt_pgaddtup */ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="nbtinsert.c.html#LN738"><span class='Ref_to_Parameter'>newitemoff</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN742"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nbtinsert.c.html#LN873"><span class='Ref_To_Local'>trunctuple</span></a> <span class='Operator'>= *</span><a href="nbtinsert.c.html#LN737"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN873"><span class='Ref_To_Local'>trunctuple</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN873"><span class='Ref_To_Local'>trunctuple</span></a><span class='Delimiter'>, 
</span>                                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN737"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN70"><span class='Ref_to_Macro'>IndexTupleDSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="nbtinsert.c.html#LN737"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="nbtinsert.c.html#LN872"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN871"><span class='Ref_To_Local'>xlinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN808"><span class='Ref_To_Local'>metapg</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN872"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN872"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN741"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN872"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* release buffers */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN807"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN735"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN733"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN734"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _bt_insertonpg &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_split() -- split a page in the btree. 
 * 
 *      On entry, buf is the page to split, and is pinned and write-locked. 
 *      firstright is the item index of the first item to be moved to the 
 *      new right page.  newitemoff etc. tell us about the new item that 
 *      must be inserted along with the data from the old page. 
 * 
 *      When splitting a non-leaf page, 'cbuf' is the left-sibling of the 
 *      page we're inserting the downlink for.  This function will clear the 
 *      INCOMPLETE_SPLIT flag on it, and release the buffer. 
 * 
 *      Returns the new right sibling of buf, pinned and write-locked. 
 *      The pin and lock on buf are maintained. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN959"></a><span class='Declare_Function'>_bt_split</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>cbuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>firstright</span><span class='Delimiter'>, 
</span><a name="LN960"></a>          <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>newitemoff</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newitemsz</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>newitem</span><span class='Delimiter'>, 
</span><a name="LN961"></a>          <span class='Keyword'>bool </span><span class='Declare_Parameter'>newitemonleft</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN963"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuf</span><span class='Delimiter'>; 
</span><a name="LN964"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>origpage</span><span class='Delimiter'>; 
</span><a name="LN965"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>leftpage</span><span class='Delimiter'>, 
</span><a name="LN966"></a>                <span class='Declare_Local'>rightpage</span><span class='Delimiter'>; 
</span><a name="LN967"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>origpagenumber</span><span class='Delimiter'>, 
</span><a name="LN968"></a>                <span class='Declare_Local'>rightpagenumber</span><span class='Delimiter'>; 
</span><a name="LN969"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>ropaque</span><span class='Delimiter'>, 
</span><a name="LN970"></a>                <span class='Declare_Local'>lopaque</span><span class='Delimiter'>, 
</span><a name="LN971"></a>                <span class='Declare_Local'>oopaque</span><span class='Delimiter'>; 
</span><a name="LN972"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>sbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN973"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>spage</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN974"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>sopaque</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN975"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itemsz</span><span class='Delimiter'>; 
</span><a name="LN976"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN977"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span><a name="LN978"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>leftoff</span><span class='Delimiter'>, 
</span><a name="LN979"></a>                <span class='Declare_Local'>rightoff</span><span class='Delimiter'>; 
</span><a name="LN980"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN981"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN982"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isroot</span><span class='Delimiter'>; 
</span><a name="LN983"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isleaf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Acquire a new page to split into */ 
</span>    <a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * origpage is the original page to be split.  leftpage is a temporary 
     * buffer that receives the left-sibling data, which will be copied back 
     * into origpage on success.  rightpage is the new page that receives the 
     * right-sibling data.  If we fail before reaching the critical section, 
     * origpage hasn't been modified and leftpage is only workspace. In 
     * principle we shouldn't need to worry about rightpage either, because it 
     * hasn't been linked into the btree page structure; but to avoid leaving 
     * possibly-confusing junk behind, we are careful to rewrite rightpage as 
     * zeroes before throwing any error. 
     */ 
</span>    <a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a> <span class='Operator'>= </span><a href="../../storage/page/bufpage.c.html#LN346"><span class='Ref_to_Func'>PageGetTempPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN968"><span class='Ref_To_Local'>rightpagenumber</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/nbtree.h.html#LN486"><span class='Ref_to_Proto'>_bt_pageinit</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* rightpage was already initialized by _bt_getbuf */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy the original page's LSN into leftpage, which will become the 
     * updated version of the page.  We need this because XLogInsert will 
     * examine the LSN and possibly dump it in a page image. 
     */ 
</span>    <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* init btree private data */ 
</span>    <a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN982"><span class='Ref_To_Local'>isroot</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN176"><span class='Ref_to_Macro'>P_ISROOT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN983"><span class='Ref_To_Local'>isleaf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if we're splitting this page, it won't be the root when we're done */ 
</span>    <span class='Comment_Multi_Line'>/* also, clear the SPLIT_END and HAS_GARBAGE flags in both pages */ 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN70"><span class='Ref_to_Const'>BTP_ROOT</span></a> <span class='Operator'>| </span><a href="../../../include/access/nbtree.h.html#LN74"><span class='Ref_to_Const'>BTP_SPLIT_END</span></a> <span class='Operator'>| </span><a href="../../../include/access/nbtree.h.html#LN75"><span class='Ref_to_Const'>BTP_HAS_GARBAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* set flag in left page indicating that the right page has no downlink */ 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/nbtree.h.html#LN76"><span class='Ref_to_Const'>BTP_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN968"><span class='Ref_To_Local'>rightpagenumber</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>= </span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>= </span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Since we already have write-lock on both pages, ok to read cycleid */ 
</span>    <a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN530"><span class='Ref_to_Proto'>_bt_vacuum_cycleid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN970"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the page we're splitting is not the rightmost page at its level in 
     * the tree, then the first entry on the page is the high key for the 
     * page.  We need to copy that to the right half.  Otherwise (meaning the 
     * rightmost page case), all the items on the right half will be user 
     * data. 
     */ 
</span>    <a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Delimiter'>, 
</span>                        <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add hikey to the right sibling"</span> 
                 <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The "high key" for the new left page will be the first key that's going 
     * to go into the new right page.  This might be either the existing data 
     * item at position firstright, or the incoming tuple. 
     */ 
</span>    <a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN961"><span class='Ref_to_Parameter'>newitemonleft</span></a> <span class='Operator'>&& </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemoff</span></a> <span class='Operator'>== </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>firstright</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* incoming tuple will become first on right page */ 
</span>        <a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemsz</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitem</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* existing item at firstright will become first on right page */ 
</span>        <a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>firstright</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add hikey to the left sibling"</span> 
             <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now transfer all the data items to the appropriate page. 
     * 
     * Note: we *must* insert at least the right page's items in item-number 
     * order, for the benefit of _bt_restore_page(). 
     */ 
</span>    <a href="nbtinsert.c.html#LN980"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN980"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* does new item belong before this one? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN961"><span class='Ref_to_Parameter'>newitemonleft</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN81"><span class='Ref_to_Proto'>_bt_pgaddtup</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitem</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add new item to the left sibling"</span> 
                         <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                         <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN81"><span class='Ref_to_Proto'>_bt_pgaddtup</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitem</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add new item to the right sibling"</span> 
                         <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                         <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if i==newitemoff &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* decide which page to put it on */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>firstright</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN81"><span class='Ref_to_Proto'>_bt_pgaddtup</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add old item to the left sibling"</span> 
                     <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN978"><span class='Ref_To_Local'>leftoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN81"><span class='Ref_to_Proto'>_bt_pgaddtup</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN975"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add old item to the right sibling"</span> 
                     <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=P_FIRSTDATAKEY(oopa... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* cope with possibility that newitem goes at the end */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN981"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Can't have newitemonleft here; that would imply we were told to put 
         * *everything* on the left page, which cannot fit (if it could, we'd 
         * not be splitting the page). 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN961"><span class='Ref_to_Parameter'>newitemonleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN81"><span class='Ref_to_Proto'>_bt_pgaddtup</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemsz</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitem</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add new item to the right sibling"</span> 
                 <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN979"><span class='Ref_To_Local'>rightoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have to grab the right sibling (if any) and fix the prev pointer 
     * there. We are guaranteed that this is deadlock-free since no other 
     * writer will be holding a lock on that page and trying to move left, and 
     * all readers release locks on a page before trying to fetch its 
     * neighbors. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtinsert.c.html#LN972"><span class='Ref_To_Local'>sbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN973"><span class='Ref_To_Local'>spage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN972"><span class='Ref_To_Local'>sbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN974"><span class='Ref_To_Local'>sopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN973"><span class='Ref_To_Local'>spage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN974"><span class='Ref_To_Local'>sopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>!= </span><a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            memset<span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"right sibling's left-link doesn't match: "</span> 
               <span class='String'>"block %u links to %u instead of expected %u in index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="nbtinsert.c.html#LN971"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN974"><span class='Ref_To_Local'>sopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN967"><span class='Ref_To_Local'>origpagenumber</span></a><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check to see if we can set the SPLIT_END flag in the right-hand 
         * split page; this can save some I/O for vacuum since it need not 
         * proceed to the right sibling.  We can set the flag if the right 
         * sibling has a different cycleid: that means it could not be part of 
         * a group of pages that were all split off from the same ancestor 
         * page.  If you're confused, imagine that page A splits to A B and 
         * then again, yielding A C B, while vacuum is in progress.  Tuples 
         * originally in A could now be in either B or C, hence vacuum must 
         * examine both pages.  But if D, our right sibling, has a different 
         * cycleid then it could not contain any tuples that were in A when 
         * the vacuum started. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN974"><span class='Ref_To_Local'>sopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>!= </span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a><span class='Parentheses'>) 
</span>            <a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/nbtree.h.html#LN74"><span class='Ref_to_Const'>BTP_SPLIT_END</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !P_RIGHTMOST(oopaque) &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Right sibling is locked, new siblings are prepared, but original page 
     * is not updated yet. 
     * 
     * NO EREPORT(ERROR) till right sibling is updated.  We can get away with 
     * not starting the critical section till here because we haven't been 
     * scribbling on the original page yet; see comments above. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * By here, the original data page has been split into two new halves, and 
     * these are correct.  The algorithm requires that the left page never 
     * move during a split, so we copy the new left page back on top of the 
     * original.  Note that this is not a waste of time, since we also require 
     * (in the page management code) that the center of a page always be 
     * clean, and the most efficient way to guarantee this is just to compact 
     * the data by reinserting it into a new left page.  (XXX the latter 
     * comment is probably obsolete; but in any case it's good to not scribble 
     * on the original page until we enter the critical section.) 
     * 
     * We need to do this before writing the WAL record, so that XLogInsert 
     * can WAL log an image of the page if necessary. 
     */ 
</span>    <a href="../../storage/page/bufpage.c.html#LN405"><span class='Ref_to_Func'>PageRestoreTempPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN965"><span class='Ref_To_Local'>leftpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* leftpage, lopaque must not be used below here */ 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtinsert.c.html#LN974"><span class='Ref_To_Local'>sopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN968"><span class='Ref_To_Local'>rightpagenumber</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN972"><span class='Ref_To_Local'>sbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear INCOMPLETE_SPLIT flag on child if inserting the new item finishes 
     * a split. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN983"><span class='Ref_To_Local'>isleaf</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1260"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>cpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1261"></a>        <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>cpageop</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1260"><span class='Ref_To_Local'>cpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN1261"><span class='Ref_To_Local'>cpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/nbtree.h.html#LN76"><span class='Ref_to_Const'>BTP_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1270"></a>        <a href="../../../include/access/nbtxlog.h.html#LN102"><span class='Ref_to_Struct'>xl_btree_split</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN1271"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>xlinfo</span><span class='Delimiter'>; 
</span><a name="LN1272"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN1270"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN104"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1270"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN105"><span class='Ref_to_Member'>firstright</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>firstright</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1270"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN106"><span class='Ref_to_Member'>newitemoff</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1270"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN109"><span class='Ref_to_Const'>SizeOfBtreeSplit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Log the right sibling, because we've changed its prev-pointer. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN972"><span class='Ref_To_Local'>sbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Log the new item, if it was inserted on the left page. (If it was 
         * put on the right page, we don't need to explicitly WAL log it 
         * because it's included with all the other items on the right page.) 
         * Show the new item as belonging to the left page buffer, so that it 
         * is not stored if XLogInsert decides it needs a full-page image of 
         * the left page.  We store the offset anyway, though, to support 
         * archive compression of these records. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN961"><span class='Ref_to_Parameter'>newitemonleft</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitem</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN960"><span class='Ref_to_Parameter'>newitemsz</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Log left page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN983"><span class='Ref_To_Local'>isleaf</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We must also log the left page's high key, because the right 
             * page's leftmost key is suppressed on non-leaf levels.  Show it 
             * as belonging to the left page buffer, so that it is not stored 
             * if XLogInsert decides it needs a full-page image of the left 
             * page. 
             */ 
</span>            <a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN976"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN977"><span class='Ref_To_Local'>item</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Log the contents of the right page in the format understood by 
         * _bt_restore_page(). We set lastrdata-&GT;buffer to InvalidBuffer, 
         * because we're going to recreate the whole page anyway, so it should 
         * never be stored by XLogInsert. 
         * 
         * Direct access to page is not good but faster - we should implement 
         * some new func in page API.  Note we only store the tuples 
         * themselves, knowing that they were inserted in item-number order 
         * and so the item pointers can be reconstructed.  See comments for 
         * _bt_restore_page(). 
         */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a> <span class='Operator'>+ </span><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Delimiter'>, 
</span>                            <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_special <span class='Operator'>- </span><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN982"><span class='Ref_To_Local'>isroot</span></a><span class='Parentheses'>) 
</span>            <a href="nbtinsert.c.html#LN1271"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN961"><span class='Ref_to_Parameter'>newitemonleft</span></a> <span class='Operator'>? </span><a href="../../../include/access/nbtxlog.h.html#LN30"><span class='Ref_to_Const'>XLOG_BTREE_SPLIT_L_ROOT</span></a> <span class='Operator'>: </span><a href="../../../include/access/nbtxlog.h.html#LN31"><span class='Ref_to_Const'>XLOG_BTREE_SPLIT_R_ROOT</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="nbtinsert.c.html#LN1271"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN961"><span class='Ref_to_Parameter'>newitemonleft</span></a> <span class='Operator'>? </span><a href="../../../include/access/nbtxlog.h.html#LN28"><span class='Ref_to_Const'>XLOG_BTREE_SPLIT_L</span></a> <span class='Operator'>: </span><a href="../../../include/access/nbtxlog.h.html#LN29"><span class='Ref_to_Const'>XLOG_BTREE_SPLIT_R</span></a><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN1272"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1271"><span class='Ref_To_Local'>xlinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN964"><span class='Ref_To_Local'>origpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1272"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN966"><span class='Ref_To_Local'>rightpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1272"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN973"><span class='Ref_To_Local'>spage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1272"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN983"><span class='Ref_To_Local'>isleaf</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1272"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release the old right sibling */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN969"><span class='Ref_To_Local'>ropaque</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN972"><span class='Ref_To_Local'>sbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release the child */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN983"><span class='Ref_To_Local'>isleaf</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN959"><span class='Ref_to_Parameter'>cbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* split's done */ 
</span>    <span class='Control'>return</span> <a href="nbtinsert.c.html#LN963"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_split &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_findsplitloc() -- find an appropriate place to split a page. 
 * 
 * The idea here is to equalize the free space that will be on each split 
 * page, *after accounting for the inserted tuple*.  (If we fail to account 
 * for it, we might find ourselves with too little room on the page that 
 * it needs to go into!) 
 * 
 * If the page is the rightmost page on its level, we instead try to arrange 
 * to leave the left split page fillfactor% full.  In this way, when we are 
 * inserting successively increasing keys (consider sequences, timestamps, 
 * etc) we will end up with a tree whose pages are about fillfactor% full, 
 * instead of the 50% full result that we'd get without this special case. 
 * This is the same as nbtsort.c produces for a newly-created tree.  Note 
 * that leaf and nonleaf pages use different fillfactors. 
 * 
 * We are passed the intended insert position of the new tuple, expressed as 
 * the offsetnumber of the tuple it must go in front of.  (This could be 
 * maxoff+1 if the tuple is to go at the end.) 
 * 
 * We return the index of the first existing tuple that should go on the 
 * righthand page, plus a boolean indicating whether the new tuple goes on 
 * the left or right page.  The bool is necessary to disambiguate the case 
 * where firstright == newitemoff. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> 
<a name="LN1391"></a><span class='Declare_Function'>_bt_findsplitloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN1392"></a>                 <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN1393"></a>                 <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>newitemoff</span><span class='Delimiter'>, 
</span><a name="LN1394"></a>                 <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newitemsz</span><span class='Delimiter'>, 
</span><a name="LN1395"></a>                 <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>newitemonleft</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1397"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN1398"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span><a name="LN1399"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN1400"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1401"></a>    <a href="nbtinsert.c.html#LN28"><span class='Ref_to_Typedef'>FindSplitData</span></a> <span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN1402"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>leftspace</span><span class='Delimiter'>, 
</span><a name="LN1403"></a>                <span class='Declare_Local'>rightspace</span><span class='Delimiter'>, 
</span><a name="LN1404"></a>                <span class='Declare_Local'>goodenough</span><span class='Delimiter'>, 
</span><a name="LN1405"></a>                <span class='Declare_Local'>olddataitemstotal</span><span class='Delimiter'>, 
</span><a name="LN1406"></a>                <span class='Declare_Local'>olddataitemstoleft</span><span class='Delimiter'>; 
</span><a name="LN1407"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>goodenoughfound</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN1397"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1392"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Passed-in newitemsz is MAXALIGNED but does not include line pointer */ 
</span>    <a href="nbtinsert.c.html#LN1394"><span class='Ref_to_Parameter'>newitemsz</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Total free space available on a btree page, after fixed overhead */ 
</span>    <a href="nbtinsert.c.html#LN1402"><span class='Ref_To_Local'>leftspace</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1403"><span class='Ref_To_Local'>rightspace</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/storage/bufpage.h.html#LN264"><span class='Ref_to_Macro'>PageGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1392"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>- 
</span>        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN53"><span class='Ref_to_Struct'>BTPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The right page will have the same high key as the old page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1397"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtinsert.c.html#LN1400"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1392"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1403"><span class='Ref_To_Local'>rightspace</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1400"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Count up total space in data items without actually scanning 'em */ 
</span>    <a href="nbtinsert.c.html#LN1405"><span class='Ref_To_Local'>olddataitemstotal</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1403"><span class='Ref_To_Local'>rightspace</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1392"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN31"><span class='Ref_to_Member'>newitemsz</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1394"><span class='Ref_to_Parameter'>newitemsz</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN33"><span class='Ref_to_Member'>is_leaf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1397"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN34"><span class='Ref_to_Member'>is_rightmost</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1397"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN40"><span class='Ref_to_Member'>have_split</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN33"><span class='Ref_to_Member'>is_leaf</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN32"><span class='Ref_to_Member'>fillfactor</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN292"><span class='Ref_to_Macro'>RelationGetFillFactor</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1391"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/access/nbtree.h.html#LN131"><span class='Ref_to_Const'>BTREE_DEFAULT_FILLFACTOR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN32"><span class='Ref_to_Member'>fillfactor</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN132"><span class='Ref_to_Const'>BTREE_NONLEAF_FILLFACTOR</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN43"><span class='Ref_to_Member'>newitemonleft</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* these just to keep compiler quiet */ 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN44"><span class='Ref_to_Member'>firstright</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN45"><span class='Ref_to_Member'>best_delta</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN36"><span class='Ref_to_Member'>leftspace</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1402"><span class='Ref_To_Local'>leftspace</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN37"><span class='Ref_to_Member'>rightspace</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1403"><span class='Ref_To_Local'>rightspace</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN38"><span class='Ref_to_Member'>olddataitemstotal</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1405"><span class='Ref_To_Local'>olddataitemstotal</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN35"><span class='Ref_to_Member'>newitemoff</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1393"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Finding the best possible split would require checking all the possible 
     * split points, because of the high-key and left-key special cases. 
     * That's probably more work than it's worth; instead, stop as soon as we 
     * find a "good-enough" split, where good-enough is defined as an 
     * imbalance in free space of no more than pagesize/16 (arbitrary...) This 
     * should let us stop near the middle on most pages, instead of plowing to 
     * the end. 
     */ 
</span>    <a href="nbtinsert.c.html#LN1404"><span class='Ref_To_Local'>goodenough</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1402"><span class='Ref_To_Local'>leftspace</span></a> <span class='Operator'>/ </span><span class='Number'>16</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan through the data items and calculate space usage for a split at 
     * each possible position. 
     */ 
</span>    <a href="nbtinsert.c.html#LN1406"><span class='Ref_To_Local'>olddataitemstoleft</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1407"><span class='Ref_To_Local'>goodenoughfound</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1399"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1392"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1397"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN1399"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>         <a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1470"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itemsz</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN1400"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1392"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1470"><span class='Ref_To_Local'>itemsz</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1400"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Will the new item go to left or right of split? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT; </span><a href="nbtinsert.c.html#LN1393"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Parentheses'>) 
</span>            <a href="nbtinsert.c.html#LN78"><span class='Ref_to_Proto'>_bt_checksplitloc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <a href="nbtinsert.c.html#LN1406"><span class='Ref_To_Local'>olddataitemstoleft</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1470"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN1393"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Parentheses'>) 
</span>            <a href="nbtinsert.c.html#LN78"><span class='Ref_to_Proto'>_bt_checksplitloc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <a href="nbtinsert.c.html#LN1406"><span class='Ref_To_Local'>olddataitemstoleft</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1470"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* need to try it both ways! */ 
</span>            <a href="nbtinsert.c.html#LN78"><span class='Ref_to_Proto'>_bt_checksplitloc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <a href="nbtinsert.c.html#LN1406"><span class='Ref_To_Local'>olddataitemstoleft</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1470"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtinsert.c.html#LN78"><span class='Ref_to_Proto'>_bt_checksplitloc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1398"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                              <a href="nbtinsert.c.html#LN1406"><span class='Ref_To_Local'>olddataitemstoleft</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1470"><span class='Ref_To_Local'>itemsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Abort scan once we find a good-enough choice */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN40"><span class='Ref_to_Member'>have_split</span></a> <span class='Operator'>&& </span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN45"><span class='Ref_to_Member'>best_delta</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN1404"><span class='Ref_To_Local'>goodenough</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtinsert.c.html#LN1407"><span class='Ref_To_Local'>goodenoughfound</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="nbtinsert.c.html#LN1406"><span class='Ref_To_Local'>olddataitemstoleft</span></a> <span class='Operator'>+= </span><a href="nbtinsert.c.html#LN1470"><span class='Ref_To_Local'>itemsz</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offnum=P_FIRSTDATAKEY... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If the new item goes as the last item, check for splitting so that all 
     * the old items go to the left page and the new item goes to the right 
     * page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1393"><span class='Ref_to_Parameter'>newitemoff</span></a> <span class='Operator'>&GT; </span><a href="nbtinsert.c.html#LN1399"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>&& !</span><a href="nbtinsert.c.html#LN1407"><span class='Ref_To_Local'>goodenoughfound</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN78"><span class='Ref_to_Proto'>_bt_checksplitloc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1393"><span class='Ref_to_Parameter'>newitemoff</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1405"><span class='Ref_To_Local'>olddataitemstotal</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * I believe it is not possible to fail to find a feasible split, but just 
     * in case ... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN40"><span class='Ref_to_Member'>have_split</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find a feasible split point for index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1391"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="nbtinsert.c.html#LN1395"><span class='Ref_to_Parameter'>newitemonleft</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN43"><span class='Ref_to_Member'>newitemonleft</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="nbtinsert.c.html#LN1401"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="nbtinsert.c.html#LN44"><span class='Ref_to_Member'>firstright</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_findsplitloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine to analyze a particular possible split choice (ie, firstright 
 * and newitemonleft settings), and record the best split so far in *state. 
 * 
 * firstoldonright is the offset of the first item on the original page 
 * that goes to the right page, and firstoldonrightsz is the size of that 
 * tuple. firstoldonright can be &GT; max offset, which means that all the old 
 * items go to the left page and only the new item goes to the right page. 
 * In that case, firstoldonrightsz is not used. 
 * 
 * olddataitemstoleft is the total size of all old items to the left of 
 * firstoldonright. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1539"></a><span class='Declare_Function'>_bt_checksplitloc</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN28"><span class='Ref_to_Typedef'>FindSplitData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN1540"></a>                  <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>firstoldonright</span><span class='Delimiter'>, 
</span><a name="LN1541"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>newitemonleft</span><span class='Delimiter'>, 
</span><a name="LN1542"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>olddataitemstoleft</span><span class='Delimiter'>, 
</span><a name="LN1543"></a>                  <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>firstoldonrightsz</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1545"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>leftfree</span><span class='Delimiter'>, 
</span><a name="LN1546"></a>                <span class='Declare_Local'>rightfree</span><span class='Delimiter'>; 
</span><a name="LN1547"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>firstrightitemsz</span><span class='Delimiter'>; 
</span><a name="LN1548"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>newitemisfirstonright</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Is the new item going to be the first item on the right page? */ 
</span>    <a href="nbtinsert.c.html#LN1548"><span class='Ref_To_Local'>newitemisfirstonright</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1540"><span class='Ref_to_Parameter'>firstoldonright</span></a> <span class='Operator'>== </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN35"><span class='Ref_to_Member'>newitemoff</span></a> 
                             <span class='Operator'>&& !</span><a href="nbtinsert.c.html#LN1541"><span class='Ref_to_Parameter'>newitemonleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1548"><span class='Ref_To_Local'>newitemisfirstonright</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN1547"><span class='Ref_To_Local'>firstrightitemsz</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN31"><span class='Ref_to_Member'>newitemsz</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nbtinsert.c.html#LN1547"><span class='Ref_To_Local'>firstrightitemsz</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1543"><span class='Ref_to_Parameter'>firstoldonrightsz</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Account for all the old tuples */ 
</span>    <a href="nbtinsert.c.html#LN1545"><span class='Ref_To_Local'>leftfree</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN36"><span class='Ref_to_Member'>leftspace</span></a> <span class='Operator'>- </span><a href="nbtinsert.c.html#LN1542"><span class='Ref_to_Parameter'>olddataitemstoleft</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1546"><span class='Ref_To_Local'>rightfree</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN37"><span class='Ref_to_Member'>rightspace</span></a> <span class='Operator'>- 
</span>        <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN38"><span class='Ref_to_Member'>olddataitemstotal</span></a> <span class='Operator'>- </span><a href="nbtinsert.c.html#LN1542"><span class='Ref_to_Parameter'>olddataitemstoleft</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The first item on the right page becomes the high key of the left page; 
     * therefore it counts against left space as well as right space. 
     */ 
</span>    <a href="nbtinsert.c.html#LN1545"><span class='Ref_To_Local'>leftfree</span></a> <span class='Operator'>-= </span><a href="nbtinsert.c.html#LN1547"><span class='Ref_To_Local'>firstrightitemsz</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* account for the new item */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1541"><span class='Ref_to_Parameter'>newitemonleft</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN1545"><span class='Ref_To_Local'>leftfree</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN31"><span class='Ref_to_Member'>newitemsz</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nbtinsert.c.html#LN1546"><span class='Ref_To_Local'>rightfree</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN31"><span class='Ref_to_Member'>newitemsz</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are not on the leaf level, we will be able to discard the key 
     * data from the first item that winds up on the right page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN33"><span class='Ref_to_Member'>is_leaf</span></a><span class='Parentheses'>) 
</span>        <a href="nbtinsert.c.html#LN1546"><span class='Ref_To_Local'>rightfree</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1547"><span class='Ref_To_Local'>firstrightitemsz</span></a> <span class='Operator'>- 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If feasible split point, remember best delta. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1545"><span class='Ref_To_Local'>leftfree</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="nbtinsert.c.html#LN1546"><span class='Ref_To_Local'>rightfree</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1589"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>delta</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN34"><span class='Ref_to_Member'>is_rightmost</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If splitting a rightmost page, try to put (100-fillfactor)% of 
             * free space on left page. See comments for _bt_findsplitloc. 
             */ 
</span>            <a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN32"><span class='Ref_to_Member'>fillfactor</span></a> <span class='Operator'>* </span><a href="nbtinsert.c.html#LN1545"><span class='Ref_To_Local'>leftfree</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>- </span><span class='Parentheses'>((</span><span class='Number'>100</span> <span class='Operator'>- </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN32"><span class='Ref_to_Member'>fillfactor</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="nbtinsert.c.html#LN1546"><span class='Ref_To_Local'>rightfree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Otherwise, aim for equal free space on both sides */ 
</span>            <a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1545"><span class='Ref_To_Local'>leftfree</span></a> <span class='Operator'>- </span><a href="nbtinsert.c.html#LN1546"><span class='Ref_To_Local'>rightfree</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a> <span class='Operator'>= -</span><a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN40"><span class='Ref_to_Member'>have_split</span></a> <span class='Operator'>|| </span><a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a> <span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN45"><span class='Ref_to_Member'>best_delta</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN40"><span class='Ref_to_Member'>have_split</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN43"><span class='Ref_to_Member'>newitemonleft</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1541"><span class='Ref_to_Parameter'>newitemonleft</span></a><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN44"><span class='Ref_to_Member'>firstright</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1540"><span class='Ref_to_Parameter'>firstoldonright</span></a><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1539"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtinsert.c.html#LN45"><span class='Ref_to_Member'>best_delta</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1589"><span class='Ref_To_Local'>delta</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if leftfree&GT;=0&&rightfre... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _bt_checksplitloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * _bt_insert_parent() -- Insert downlink into parent after a page split. 
 * 
 * On entry, buf and rbuf are the left and right split pages, which we 
 * still hold write locks on per the L&Y algorithm.  We release the 
 * write locks once we have write lock on the parent page.  (Any sooner, 
 * and it'd be possible for some other process to try to split or delete 
 * one of these pages, and get confused because it cannot find the downlink.) 
 * 
 * stack - stack showing how we got here.  May be NULL in cases that don't 
 *          have to be efficient (concurrent ROOT split, WAL recovery) 
 * is_root - we split the true root 
 * is_only - we split a page alone on its level (might have been fast root) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1633"></a><span class='Declare_Function'>_bt_insert_parent</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN1634"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN1635"></a>                  <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>rbuf</span><span class='Delimiter'>, 
</span><a name="LN1636"></a>                  <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN1637"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_root</span><span class='Delimiter'>, 
</span><a name="LN1638"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_only</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Here we have to do something Lehman and Yao don't talk about: deal with 
     * a root split and construction of a new root.  If our stack is empty 
     * then we have just split a node on what had been the root level when we 
     * descended the tree.  If it was still the root then we perform a 
     * new-root construction.  If it *wasn't* the root anymore, search to find 
     * the next higher level that someone constructed meanwhile, and find the 
     * right place to insert as for the normal case. 
     * 
     * If we have to search for the parent level, we do so by re-descending 
     * from the root.  This is not super-efficient, but it's rare enough not 
     * to matter. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1637"><span class='Ref_to_Parameter'>is_root</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1655"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rootbuf</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1638"><span class='Ref_to_Parameter'>is_only</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* create a new root node and update the metapage */ 
</span>        <a href="nbtinsert.c.html#LN1655"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN49"><span class='Ref_to_Proto'>_bt_newroot</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1634"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1635"><span class='Ref_to_Parameter'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* release the split buffers */ 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1655"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1635"><span class='Ref_to_Parameter'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1634"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1668"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>bknum</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1634"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1669"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rbknum</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1635"><span class='Ref_to_Parameter'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1670"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1634"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1671"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>new_item</span><span class='Delimiter'>; 
</span><a name="LN1672"></a>        <a href="../../../include/access/nbtree.h.html#LN250"><span class='Ref_to_Struct'>BTStackData</span></a> <span class='Declare_Local'>fakestack</span><span class='Delimiter'>; 
</span><a name="LN1673"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>ritem</span><span class='Delimiter'>; 
</span><a name="LN1674"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>pbuf</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1678"></a>            <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lpageop</span><span class='Delimiter'>; 
</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"concurrent ROOT page split"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1678"><span class='Ref_To_Local'>lpageop</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1670"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Find the leftmost page at the next level up */ 
</span>            <a href="nbtinsert.c.html#LN1674"><span class='Ref_To_Local'>pbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN510"><span class='Ref_to_Proto'>_bt_get_endpoint</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1678"><span class='Ref_To_Local'>lpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                    <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Set up a phony stack entry pointing there */ 
</span>            <a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a> <span class='Operator'>= &</span><a href="nbtinsert.c.html#LN1672"><span class='Ref_To_Local'>fakestack</span></a><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN252"><span class='Ref_to_Member'>bts_blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1674"><span class='Ref_To_Local'>pbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN253"><span class='Ref_to_Member'>bts_offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* bts_btentry will be initialized below */ 
</span>            <a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN255"><span class='Ref_to_Member'>bts_parent</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1674"><span class='Ref_To_Local'>pbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* get high key from left page == lowest key on new right page */ 
</span>        <a href="nbtinsert.c.html#LN1673"><span class='Ref_To_Local'>ritem</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1670"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1670"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* form an index tuple that points at the new right page */ 
</span>        <a href="nbtinsert.c.html#LN1671"><span class='Ref_To_Local'>new_item</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1673"><span class='Ref_To_Local'>ritem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1671"><span class='Ref_To_Local'>new_item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1669"><span class='Ref_To_Local'>rbknum</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Find the parent buffer and get the parent page. 
         * 
         * Oops - if we were moved right then we need to change stack item! We 
         * want to find parent pointing to where we are, right ?    - vadim 
         * 05/27/97 
         */ 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN254"><span class='Ref_to_Member'>bts_btentry</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1668"><span class='Ref_To_Local'>bknum</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1674"><span class='Ref_To_Local'>pbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN471"><span class='Ref_to_Proto'>_bt_getstackbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now we can unlock the right child. The left child will be unlocked 
         * by _bt_insertonpg(). 
         */ 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1635"><span class='Ref_to_Parameter'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check for error only after writing children */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1674"><span class='Ref_To_Local'>pbuf</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find parent key in index \"%s\" for split pages %u/%u"</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1668"><span class='Ref_To_Local'>bknum</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1669"><span class='Ref_To_Local'>rbknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Recursively update the parent */ 
</span>        <a href="nbtinsert.c.html#LN64"><span class='Ref_to_Proto'>_bt_insertonpg</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1633"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1674"><span class='Ref_To_Local'>pbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1634"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN255"><span class='Ref_to_Member'>bts_parent</span></a><span class='Delimiter'>, 
</span>                       <a href="nbtinsert.c.html#LN1671"><span class='Ref_To_Local'>new_item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1636"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN253"><span class='Ref_to_Member'>bts_offset</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                       <a href="nbtinsert.c.html#LN1638"><span class='Ref_to_Parameter'>is_only</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* be tidy */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1671"><span class='Ref_To_Local'>new_item</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _bt_insert_parent &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * _bt_finish_split() -- Finish an incomplete split 
 * 
 * A crash or other failure can leave a split incomplete.  The insertion 
 * routines won't allow to insert on a page that is incompletely split. 
 * Before inserting on such a page, call _bt_finish_split(). 
 * 
 * On entry, 'lbuf' must be locked in write-mode.  On exit, it is unlocked 
 * and unpinned. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1744"></a><span class='Declare_Function'>_bt_finish_split</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>lbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1746"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>lpage</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1747"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lpageop</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1746"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1748"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuf</span><span class='Delimiter'>; 
</span><a name="LN1749"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>rpage</span><span class='Delimiter'>; 
</span><a name="LN1750"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>rpageop</span><span class='Delimiter'>; 
</span><a name="LN1751"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>was_root</span><span class='Delimiter'>; 
</span><a name="LN1752"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>was_only</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1747"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lock right sibling, the one missing the downlink */ 
</span>    <a href="nbtinsert.c.html#LN1748"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1747"><span class='Ref_To_Local'>lpageop</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1749"><span class='Ref_To_Local'>rpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1748"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1750"><span class='Ref_To_Local'>rpageop</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1749"><span class='Ref_To_Local'>rpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Could this be a root split? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>stack</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1764"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN1765"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span><span class='Delimiter'>; 
</span><a name="LN1766"></a>        <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* acquire lock on the metapage */ 
</span>        <a href="nbtinsert.c.html#LN1764"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1765"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1764"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1766"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1765"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN1751"><span class='Ref_To_Local'>was_root</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1766"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1764"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="nbtinsert.c.html#LN1751"><span class='Ref_To_Local'>was_root</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Was this the only page on the level before split? */ 
</span>    <a href="nbtinsert.c.html#LN1752"><span class='Ref_To_Local'>was_only</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN173"><span class='Ref_to_Macro'>P_LEFTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1747"><span class='Ref_To_Local'>lpageop</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1750"><span class='Ref_To_Local'>rpageop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"finishing incomplete split of %u/%u"</span><span class='Delimiter'>, 
</span>         <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1748"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN72"><span class='Ref_to_Proto'>_bt_insert_parent</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1748"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1744"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1751"><span class='Ref_To_Local'>was_root</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1752"><span class='Ref_To_Local'>was_only</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_finish_split &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_getstackbuf() -- Walk back up the tree one step, and find the item 
 *                       we last looked at in the parent. 
 * 
 *      This is possible because we save the downlink from the parent item, 
 *      which is enough to uniquely identify it.  Insertions into the parent 
 *      level could cause the item to move right; deletions could cause it 
 *      to move left, but not left of the page we previously found it in. 
 * 
 *      Adjusts bts_blkno & bts_offset if changed. 
 * 
 *      Returns InvalidBuffer if item not found (should not happen). 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN1803"></a><span class='Declare_Function'>_bt_getstackbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1805"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN1806"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>start</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN1805"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN252"><span class='Ref_to_Member'>bts_blkno</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN253"><span class='Ref_to_Member'>bts_offset</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1813"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1814"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1815"></a>        <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1805"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1815"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a> <span class='Operator'>&& </span><a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1815"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/nbtree.h.html#LN472"><span class='Ref_to_Proto'>_bt_finish_split</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN255"><span class='Ref_to_Member'>bts_parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN180"><span class='Ref_to_Macro'>P_IGNORE</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1815"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1829"></a>            <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN1830"></a>                        <span class='Declare_Local'>minoff</span><span class='Delimiter'>, 
</span><a name="LN1831"></a>                        <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN1832"></a>            <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1833"></a>            <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span> 
            <a href="nbtinsert.c.html#LN1830"><span class='Ref_To_Local'>minoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1815"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtinsert.c.html#LN1831"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * start = InvalidOffsetNumber means "search the whole page". We 
             * need this test anyway due to possibility that page has a high 
             * key now when it didn't before. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>&LT; </span><a href="nbtinsert.c.html#LN1830"><span class='Ref_To_Local'>minoff</span></a><span class='Parentheses'>) 
</span>                <a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1830"><span class='Ref_To_Local'>minoff</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Need this check too, to guard against possibility that page 
             * split since we visited it originally. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>&GT; </span><a href="nbtinsert.c.html#LN1831"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>                <a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1831"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * These loops will check every item on the page --- but in an 
             * order that's attuned to the probability of where it actually 
             * is.  Scan to the right first, then to the left. 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a><span class='Delimiter'>; 
</span>                 <a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN1831"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>                 <a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nbtinsert.c.html#LN1832"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN1833"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1832"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN155"><span class='Ref_to_Macro'>BTEntrySame</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1833"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN254"><span class='Ref_to_Member'>bts_btentry</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Return accurate pointer to where link is now */ 
</span>                    <a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN252"><span class='Ref_to_Member'>bts_blkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1805"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>                    <a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN253"><span class='Ref_to_Member'>bts_offset</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN54"><span class='Ref_to_Macro'>OffsetNumberPrev</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                 <a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT;= </span><a href="nbtinsert.c.html#LN1830"><span class='Ref_To_Local'>minoff</span></a><span class='Delimiter'>; 
</span>                 <a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN54"><span class='Ref_to_Macro'>OffsetNumberPrev</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nbtinsert.c.html#LN1832"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtinsert.c.html#LN1833"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1814"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1832"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN155"><span class='Ref_to_Macro'>BTEntrySame</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1833"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN254"><span class='Ref_to_Member'>bts_btentry</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Return accurate pointer to where link is now */ 
</span>                    <a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN252"><span class='Ref_to_Member'>bts_blkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1805"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>                    <a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN253"><span class='Ref_to_Member'>bts_offset</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1829"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !P_IGNORE(opaque) &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * The item we're looking for moved right at least one page. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1815"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="nbtinsert.c.html#LN1805"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1815"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN1806"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1803"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1813"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _bt_getstackbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_newroot() -- Create a new root page for the index. 
 * 
 *      We've just split the old root page and need to create a new one. 
 *      In order to do this, we add a new root page to the file, then lock 
 *      the metadata page and update it.  This is guaranteed to be deadlock- 
 *      free, because all readers release their locks on the metadata page 
 *      before trying to lock the root, and all writers lock the root before 
 *      trying to lock the metadata page.  We have a write lock on the old 
 *      root page, so we have not introduced any cycles into the waits-for 
 *      graph. 
 * 
 *      On entry, lbuf (the old root) and rbuf (its new peer) are write- 
 *      locked. On exit, a new root page exists with entries for the 
 *      two new children, metapage is updated and unlocked/unpinned. 
 *      The new root buffer is returned to caller which has to unlock/unpin 
 *      lbuf, rbuf & rootbuf. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN1922"></a><span class='Declare_Function'>_bt_newroot</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>lbuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>rbuf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1924"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rootbuf</span><span class='Delimiter'>; 
</span><a name="LN1925"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>lpage</span><span class='Delimiter'>, 
</span><a name="LN1926"></a>                <span class='Declare_Local'>rootpage</span><span class='Delimiter'>; 
</span><a name="LN1927"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>lbkno</span><span class='Delimiter'>, 
</span><a name="LN1928"></a>                <span class='Declare_Local'>rbkno</span><span class='Delimiter'>; 
</span><a name="LN1929"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rootblknum</span><span class='Delimiter'>; 
</span><a name="LN1930"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>rootopaque</span><span class='Delimiter'>; 
</span><a name="LN1931"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lopaque</span><span class='Delimiter'>; 
</span><a name="LN1932"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1933"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span><a name="LN1934"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>left_item</span><span class='Delimiter'>; 
</span><a name="LN1935"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>left_item_sz</span><span class='Delimiter'>; 
</span><a name="LN1936"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>right_item</span><span class='Delimiter'>; 
</span><a name="LN1937"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>right_item_sz</span><span class='Delimiter'>; 
</span><a name="LN1938"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN1939"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span><span class='Delimiter'>; 
</span><a name="LN1940"></a>    <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN1927"><span class='Ref_To_Local'>lbkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1928"><span class='Ref_To_Local'>rbkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1925"><span class='Ref_To_Local'>lpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1931"><span class='Ref_To_Local'>lopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1925"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get a new root page */ 
</span>    <a href="nbtinsert.c.html#LN1924"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1924"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1929"><span class='Ref_To_Local'>rootblknum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1924"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* acquire lock on the metapage */ 
</span>    <a href="nbtinsert.c.html#LN1938"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1939"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1938"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1939"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create downlink item for left page (old root).  Since this will be the 
     * first item in a non-leaf page, it implicitly has minus-infinity key 
     * value, so we need not store any actual key in it. 
     */ 
</span>    <a href="nbtinsert.c.html#LN1935"><span class='Ref_To_Local'>left_item_sz</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1934"><span class='Ref_To_Local'>left_item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1935"><span class='Ref_To_Local'>left_item_sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1934"><span class='Ref_To_Local'>left_item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1935"><span class='Ref_To_Local'>left_item_sz</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1934"><span class='Ref_To_Local'>left_item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1927"><span class='Ref_To_Local'>lbkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create downlink item for right page.  The key for it is obtained from 
     * the "high key" position in the left page. 
     */ 
</span>    <a href="nbtinsert.c.html#LN1932"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1925"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1937"><span class='Ref_To_Local'>right_item_sz</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1932"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1933"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1925"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1932"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1936"><span class='Ref_To_Local'>right_item</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1933"><span class='Ref_To_Local'>item</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1936"><span class='Ref_To_Local'>right_item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1928"><span class='Ref_To_Local'>rbkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NO EREPORT(ERROR) from here till newroot op is logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set btree special data */ 
</span>    <a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN70"><span class='Ref_to_Const'>BTP_ROOT</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>= 
</span>        <span class='Parentheses'>((</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1925"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>btpo<span class='Operator'>.</span>level <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* update metapage data */ 
</span>    <a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1929"><span class='Ref_To_Local'>rootblknum</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1929"><span class='Ref_To_Local'>rootblknum</span></a><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1930"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insert the left page pointer into the new root page.  The root page is 
     * the rightmost page on its level so there is no "high key" in it; the 
     * two items will go into positions P_HIKEY and P_FIRSTKEY. 
     * 
     * Note: we *must* insert the two items in item-number order, for the 
     * benefit of _bt_restore_page(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1934"><span class='Ref_To_Local'>left_item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1935"><span class='Ref_To_Local'>left_item_sz</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add leftkey to new root page"</span> 
             <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * insert the right page pointer into the new root page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1936"><span class='Ref_To_Local'>right_item</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1937"><span class='Ref_To_Local'>right_item_sz</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add rightkey to new root page"</span> 
             <span class='String'>" while splitting block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clear the incomplete-split flag in the left child */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1931"><span class='Ref_To_Local'>lopaque</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN1931"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/nbtree.h.html#LN76"><span class='Ref_to_Const'>BTP_INCOMPLETE_SPLIT</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1924"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1938"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2028"></a>        <a href="../../../include/access/nbtxlog.h.html#LN237"><span class='Ref_to_Struct'>xl_btree_newroot</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN2029"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN2030"></a>        <a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a> <span class='Declare_Local'>md</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN2028"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN239"><span class='Ref_to_Member'>rootblk</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1929"><span class='Ref_To_Local'>rootblknum</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2028"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN240"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN2028"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN243"><span class='Ref_to_Const'>SizeOfBtreeNewroot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1924"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>lbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1938"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN2030"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN47"><span class='Ref_to_Member'>root</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1929"><span class='Ref_To_Local'>rootblknum</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2030"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN48"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2030"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN49"><span class='Ref_to_Member'>fastroot</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1929"><span class='Ref_To_Local'>rootblknum</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2030"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN50"><span class='Ref_to_Member'>fastlevel</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN1940"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN2030"><span class='Ref_To_Local'>md</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Direct access to page is not good but faster - we should implement 
         * some new func in page API. 
         */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a> <span class='Operator'>+ </span><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Delimiter'>, 
</span>                            <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_special <span class='Operator'>- 
</span>                            <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN2029"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN35"><span class='Ref_to_Const'>XLOG_BTREE_NEWROOT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1925"><span class='Ref_To_Local'>lpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2029"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1926"><span class='Ref_To_Local'>rootpage</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2029"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1939"><span class='Ref_To_Local'>metapg</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2029"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* done with metapage */ 
</span>    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1922"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN1938"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1934"><span class='Ref_To_Local'>left_item</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN1936"><span class='Ref_To_Local'>right_item</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtinsert.c.html#LN1924"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_newroot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_pgaddtup() -- add a tuple to a particular page in the index. 
 * 
 *      This routine adds the tuple to the page as requested.  It does 
 *      not affect pin/lock status, but you'd better have a write lock 
 *      and pin on the target buffer!  Don't forget to write and release 
 *      the buffer afterwards, either. 
 * 
 *      The main difference between this routine and a bare PageAddItem call 
 *      is that this code knows that the leftmost index tuple on a non-leaf 
 *      btree page doesn't need to have a key.  Therefore, it strips such 
 *      tuples down to just the tuple header.  CAUTION: this works ONLY if 
 *      we insert the tuples in order, so that the given itup_off does 
 *      represent the final position of the tuple! 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2092"></a><span class='Declare_Function'>_bt_pgaddtup</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN2093"></a>             <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsize</span><span class='Delimiter'>, 
</span><a name="LN2094"></a>             <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN2095"></a>             <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>itup_off</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2097"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2092"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2098"></a>    <a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a> <span class='Declare_Local'>trunctuple</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2097"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="nbtinsert.c.html#LN2095"><span class='Ref_to_Parameter'>itup_off</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2097"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtinsert.c.html#LN2098"><span class='Ref_To_Local'>trunctuple</span></a> <span class='Operator'>= *</span><a href="nbtinsert.c.html#LN2094"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2098"><span class='Ref_To_Local'>trunctuple</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2094"><span class='Ref_to_Parameter'>itup</span></a> <span class='Operator'>= &</span><a href="nbtinsert.c.html#LN2098"><span class='Ref_To_Local'>trunctuple</span></a><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2093"><span class='Ref_to_Parameter'>itemsize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2092"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="nbtinsert.c.html#LN2094"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2093"><span class='Ref_to_Parameter'>itemsize</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2095"><span class='Ref_to_Parameter'>itup_off</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_pgaddtup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * _bt_isequal - used in _bt_doinsert in check for duplicates. 
 * 
 * This is very similar to _bt_compare, except for NULL handling. 
 * Rule is simple: NOT_NULL not equal NULL, NULL not equal NULL too. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2122"></a><span class='Declare_Function'>_bt_isequal</span><span class='Parentheses'>(</span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>itupdesc</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Delimiter'>, 
</span><a name="LN2123"></a>            <span class='Keyword'>int </span><span class='Declare_Parameter'>keysz</span><span class='Delimiter'>, </span><a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a> <span class='Declare_Parameter'>scankey</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2125"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN2126"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Better be comparing to a leaf item */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>((</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2122"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="nbtinsert.c.html#LN2125"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2122"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2122"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2122"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2126"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="nbtinsert.c.html#LN2126"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>keysz</span></a><span class='Delimiter'>; </span><a href="nbtinsert.c.html#LN2126"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2135"></a>        <a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a>  <span class='Declare_Local'>attno</span><span class='Delimiter'>; 
</span><a name="LN2136"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span><a name="LN2137"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull</span><span class='Delimiter'>; 
</span><a name="LN2138"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN2135"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>scankey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN66"><span class='Ref_to_Member'>sk_attno</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2135"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>== </span><a href="nbtinsert.c.html#LN2126"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtinsert.c.html#LN2136"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2125"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2135"><span class='Ref_To_Local'>attno</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2122"><span class='Ref_to_Parameter'>itupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN2137"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* NULLs are never equal to anything */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2137"><span class='Ref_To_Local'>isNull</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>scankey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN65"><span class='Ref_to_Member'>sk_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/skey.h.html#LN114"><span class='Ref_to_Const'>SK_ISNULL</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN2138"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>scankey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN70"><span class='Ref_to_Member'>sk_func</span></a><span class='Delimiter'>, 
</span>                                                 <a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>scankey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN69"><span class='Ref_to_Member'>sk_collation</span></a><span class='Delimiter'>, 
</span>                                                 <a href="nbtinsert.c.html#LN2136"><span class='Ref_To_Local'>datum</span></a><span class='Delimiter'>, 
</span>                                                 <a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>scankey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN71"><span class='Ref_to_Member'>sk_argument</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2138"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="nbtinsert.c.html#LN2123"><span class='Ref_to_Parameter'>scankey</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;=keysz;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* if we get here, the keys are equal */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_isequal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * _bt_vacuum_one_page - vacuum just one index page. 
 * 
 * Try to remove LP_DEAD items from the given page.  The passed buffer 
 * must be exclusive-locked, but unlike a real VACUUM, we don't need a 
 * super-exclusive "cleanup" lock (see nbtree/README). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2171"></a><span class='Declare_Function'>_bt_vacuum_one_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2173"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>deletable</span><span class='Delimiter'>[</span><a href="../../../include/storage/off.h.html#LN27"><span class='Ref_to_Const'>MaxOffsetNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN2174"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndeletable</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2175"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN2176"></a>                <span class='Declare_Local'>minoff</span><span class='Delimiter'>, 
</span><a name="LN2177"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN2178"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2171"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2179"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2178"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan over all items to see which ones need to be deleted according to 
     * LP_DEAD flags. 
     */ 
</span>    <a href="nbtinsert.c.html#LN2176"><span class='Ref_To_Local'>minoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2179"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtinsert.c.html#LN2177"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2178"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2175"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="nbtinsert.c.html#LN2176"><span class='Ref_To_Local'>minoff</span></a><span class='Delimiter'>; 
</span>         <a href="nbtinsert.c.html#LN2175"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="nbtinsert.c.html#LN2177"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>         <a href="nbtinsert.c.html#LN2175"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2175"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2191"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemId</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2178"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2175"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2191"><span class='Ref_To_Local'>itemId</span></a><span class='Parentheses'>))</span> 
            <a href="nbtinsert.c.html#LN2173"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>[</span><a href="nbtinsert.c.html#LN2174"><span class='Ref_To_Local'>ndeletable</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="nbtinsert.c.html#LN2175"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2174"><span class='Ref_To_Local'>ndeletable</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/nbtree.h.html#LN488"><span class='Ref_to_Proto'>_bt_delitems_delete</span></a><span class='Parentheses'>(</span><a href="nbtinsert.c.html#LN2171"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2171"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2173"><span class='Ref_To_Local'>deletable</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2174"><span class='Ref_To_Local'>ndeletable</span></a><span class='Delimiter'>, </span><a href="nbtinsert.c.html#LN2171"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: if we didn't find any LP_DEAD items, then the page's 
     * BTP_HAS_GARBAGE hint bit is falsely set.  We do not bother expending a 
     * separate write to clear it, however.  We will clear it when we split 
     * the page. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end _bt_vacuum_one_page &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>