<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\nbtree\nbtpage.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\nbtree\nbtpage.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:29 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * nbtpage.c 
 *    BTree-specific page management code for the Postgres btree access 
 *    method. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/nbtree/nbtpage.c 
 * 
 *  NOTES 
 *     Postgres btree pages look like ordinary relation pages.  The opaque 
 *     data at high addresses includes pointers to left and right siblings 
 *     and flag data describing page state.  The first page in a btree, page 
 *     zero, is special -- it stores meta-information describing the tree. 
 *     Pages one and higher store the actual tree data. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/nbtree.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/nbtxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/indexfsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
 
<a name="LN35"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>_bt_mark_page_halfdead</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN36"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>_bt_unlink_halfdead_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>leafbuf</span><span class='Delimiter'>, 
</span><a name="LN37"></a>                         <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>rightsib_empty</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN38"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>_bt_lock_branch_parent</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Delimiter'>, 
</span><a name="LN39"></a>                       <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>topparent</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>topoff</span><span class='Delimiter'>, 
</span><a name="LN40"></a>                       <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>target</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rightsib</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN41"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_log_reuse_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, 
</span><a name="LN42"></a>                   <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>latestRemovedXid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _bt_initmetapage() -- Fill a page buffer with a correct metapage image 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN48"></a><span class='Declare_Function'>_bt_initmetapage</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>rootbknum</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN50"></a>    <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span><span class='Delimiter'>; 
</span><a name="LN51"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>metaopaque</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/nbtree.h.html#LN486"><span class='Ref_to_Proto'>_bt_pageinit</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN97"><span class='Ref_to_Member'>btm_magic</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN109"><span class='Ref_to_Const'>BTREE_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>rootbknum</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>rootbknum</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN51"><span class='Ref_To_Local'>metaopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN51"><span class='Ref_To_Local'>metaopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN72"><span class='Ref_to_Const'>BTP_META</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set pd_lower just past the end of the metadata.  This is not essential 
     * but it makes the page look compressible to xlog.c. 
     */ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>= 
</span>        <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN50"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a><span class='Parentheses'>))</span> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN48"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_initmetapage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_getroot() -- Get the root page of the btree. 
 * 
 *      Since the root page can move around the btree file, we have to read 
 *      its location from the metadata page, and then read the root page 
 *      itself.  If no root page exists yet, we have to create one.  The 
 *      standard class of race conditions exists here; I think I covered 
 *      them all in the Hopi Indian rain dance of lock requests below. 
 * 
 *      The access type parameter (BT_READ or BT_WRITE) controls whether 
 *      a new root page will be created or not.  If access = BT_READ, 
 *      and no root page exists, we just return InvalidBuffer.  For 
 *      BT_WRITE, we try to create the root page if it doesn't exist. 
 *      NOTE that the returned root page will have only a read lock set 
 *      on it even if access = BT_WRITE! 
 * 
 *      The returned page is not necessarily the true root --- it could be 
 *      a "fast root" (a page that is alone in its level due to deletions). 
 *      Also, if the root page is split while we are "in flight" to it, 
 *      what we will return is the old root, which is now just the leftmost 
 *      page on a probably-not-very-wide level.  For most purposes this is 
 *      as good as or better than the true root, so we do not bother to 
 *      insist on finding the true root.  We do, however, guarantee to 
 *      return a live (not deleted or half-dead) page. 
 * 
 *      On successful return, the root page is pinned and read-locked. 
 *      The metadata page is not locked or pinned on exit. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN103"></a><span class='Declare_Function'>_bt_getroot</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN105"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>metaopaque</span><span class='Delimiter'>; 
</span><a name="LN108"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rootbuf</span><span class='Delimiter'>; 
</span><a name="LN109"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>rootpage</span><span class='Delimiter'>; 
</span><a name="LN110"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>rootopaque</span><span class='Delimiter'>; 
</span><a name="LN111"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rootblkno</span><span class='Delimiter'>; 
</span><a name="LN112"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>rootlevel</span><span class='Delimiter'>; 
</span><a name="LN113"></a>    <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to use previously-cached metapage data to find the root.  This 
     * normally saves one buffer access per index search, which is a very 
     * helpful savings in bufmgr traffic and hence contention. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* We shouldn't have cached it if any of these fail */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN97"><span class='Ref_to_Member'>btm_magic</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN109"><span class='Ref_to_Const'>BTREE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN112"><span class='Ref_To_Local'>rootlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Since the cache might be stale, we check the page more carefully 
         * here than normal.  We *must* check that it's not deleted. If it's 
         * not alone on its level, then we reject too --- this may be overly 
         * paranoid but better safe than sorry.  Note we don't check P_ISROOT, 
         * because that's not set in a "fast root". 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN180"><span class='Ref_to_Macro'>P_IGNORE</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>== </span><a href="nbtpage.c.html#LN112"><span class='Ref_To_Local'>rootlevel</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/access/nbtree.h.html#LN173"><span class='Ref_to_Macro'>P_LEFTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* OK, accept cached page as the root */ 
</span>            <span class='Control'>return</span> <a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Cache is stale, throw it away */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rel-&GT;rd_amcache!=NULL &raquo; </span> 
 
    <a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN106"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN107"><span class='Ref_To_Local'>metaopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN106"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN106"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sanity-check the metapage */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN107"><span class='Ref_To_Local'>metaopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/nbtree.h.html#LN72"><span class='Ref_to_Const'>BTP_META</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN97"><span class='Ref_to_Member'>btm_magic</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN109"><span class='Ref_to_Const'>BTREE_MAGIC</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" is not a btree"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"version mismatch in index \"%s\": file version %d, code version %d"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if no root page initialized yet, do it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If access = BT_READ, caller doesn't want us to create root yet */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* trade in our read lock for a write lock */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Race condition:  if someone else initialized the metadata between 
         * the time we released the read lock and acquired the write lock, we 
         * must avoid doing it again. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Metadata initialized by someone else.  In order to guarantee no 
             * deadlocks, we have to release the metadata page and start all 
             * over again.  (Is that really true? But it's hardly worth trying 
             * to optimize this case.) 
             */ 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="nbtpage.c.html#LN102"><span class='Ref_to_Func'>_bt_getroot</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get, initialize, write, and leave a lock of the appropriate type on 
         * the new root page.  Since this is the first page in the tree, it's 
         * a leaf as well as the root. 
         */ 
</span>        <a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN69"><span class='Ref_to_Const'>BTP_LEAF</span></a> <span class='Operator'>| </span><a href="../../../include/access/nbtree.h.html#LN70"><span class='Ref_to_Const'>BTP_ROOT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* NO ELOG(ERROR) till meta is updated */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN237"></a>            <a href="../../../include/access/nbtxlog.h.html#LN237"><span class='Ref_to_Struct'>xl_btree_newroot</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN238"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN239"></a>            <a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a> <span class='Declare_Local'>md</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtpage.c.html#LN239"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN47"><span class='Ref_to_Member'>root</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN239"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN48"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN239"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN49"><span class='Ref_to_Member'>fastroot</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN239"><span class='Ref_To_Local'>md</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN50"><span class='Ref_to_Member'>fastlevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN239"><span class='Ref_To_Local'>md</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="nbtpage.c.html#LN237"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN239"><span class='Ref_to_Member'>rootblk</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN237"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN240"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN237"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN243"><span class='Ref_to_Const'>SizeOfBtreeNewroot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtpage.c.html#LN238"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN35"><span class='Ref_to_Const'>XLOG_BTREE_NEWROOT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN238"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN106"><span class='Ref_To_Local'>metapg</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN238"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * swap root write lock for read lock.  There is no danger of anyone 
         * else accessing the new root page while it's unlocked, since no one 
         * else knows where it is yet. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* okay, metadata is correct, release lock on it */ 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if metad-&GT;btm_root==P_NO... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN112"><span class='Ref_To_Local'>rootlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Cache the metapage data for next time 
         */ 
</span>        <a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN178"><span class='Ref_to_Member'>rd_indexcxt</span></a><span class='Delimiter'>, 
</span>                                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN113"><span class='Ref_To_Local'>metad</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We are done with the metapage; arrange to release it via first 
         * _bt_relandgetbuf call 
         */ 
</span>        <a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN105"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN483"><span class='Ref_to_Proto'>_bt_relandgetbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN109"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN180"><span class='Ref_to_Macro'>P_IGNORE</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* it's dead, Jim.  step right one page */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no live root page found in index \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Note: can't check btpo.level on deleted pages */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>!= </span><a href="nbtpage.c.html#LN112"><span class='Ref_To_Local'>rootlevel</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"root page %u of index \"%s\" has level %u, expected %u"</span><span class='Delimiter'>, 
</span>                 <a href="nbtpage.c.html#LN111"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN103"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="nbtpage.c.html#LN110"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>, </span><a href="nbtpage.c.html#LN112"><span class='Ref_To_Local'>rootlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * By here, we have a pin and read lock on the root page, and no lock set 
     * on the metadata page.  Return the root page's buffer. 
     */ 
</span>    <span class='Control'>return</span> <a href="nbtpage.c.html#LN108"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_getroot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_gettrueroot() -- Get the true root page of the btree. 
 * 
 *      This is the same as the BT_READ case of _bt_getroot(), except 
 *      we follow the true-root link not the fast-root link. 
 * 
 * By the time we acquire lock on the root page, it might have been split and 
 * not be the true root anymore.  This is okay for the present uses of this 
 * routine; we only really need to be able to move up at least one tree level 
 * from whatever non-root page we were at.  If we ever do need to lock the 
 * one true root page, we could loop here, re-reading the metapage on each 
 * failure.  (Note that it wouldn't do to hold the lock on the metapage while 
 * moving to the root --- that'd deadlock against any concurrent root split.) 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN340"></a><span class='Declare_Function'>_bt_gettrueroot</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN342"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN343"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>metaopaque</span><span class='Delimiter'>; 
</span><a name="LN345"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rootbuf</span><span class='Delimiter'>; 
</span><a name="LN346"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>rootpage</span><span class='Delimiter'>; 
</span><a name="LN347"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>rootopaque</span><span class='Delimiter'>; 
</span><a name="LN348"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rootblkno</span><span class='Delimiter'>; 
</span><a name="LN349"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>rootlevel</span><span class='Delimiter'>; 
</span><a name="LN350"></a>    <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't try to use cached metapage data here, since (a) this path is 
     * not performance-critical, and (b) if we are here it suggests our cache 
     * is out-of-date anyway.  In light of point (b), it's probably safest to 
     * actively flush any cached metapage info. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN342"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN343"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN342"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN344"><span class='Ref_To_Local'>metaopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN343"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN343"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN344"><span class='Ref_To_Local'>metaopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/nbtree.h.html#LN72"><span class='Ref_to_Const'>BTP_META</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN97"><span class='Ref_to_Member'>btm_magic</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN109"><span class='Ref_to_Const'>BTREE_MAGIC</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" is not a btree"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"version mismatch in index \"%s\": file version %d, code version %d"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if no root page initialized yet, fail */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN342"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="nbtpage.c.html#LN348"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN349"><span class='Ref_To_Local'>rootlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN350"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We are done with the metapage; arrange to release it via first 
     * _bt_relandgetbuf call 
     */ 
</span>    <a href="nbtpage.c.html#LN345"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN342"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN345"><span class='Ref_To_Local'>rootbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN483"><span class='Ref_to_Proto'>_bt_relandgetbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN345"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN348"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN346"><span class='Ref_To_Local'>rootpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN345"><span class='Ref_To_Local'>rootbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN347"><span class='Ref_To_Local'>rootopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN346"><span class='Ref_To_Local'>rootpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN180"><span class='Ref_to_Macro'>P_IGNORE</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN347"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* it's dead, Jim.  step right one page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN347"><span class='Ref_To_Local'>rootopaque</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no live root page found in index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN348"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN347"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Note: can't check btpo.level on deleted pages */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN347"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>!= </span><a href="nbtpage.c.html#LN349"><span class='Ref_To_Local'>rootlevel</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"root page %u of index \"%s\" has level %u, expected %u"</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN348"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN340"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN347"><span class='Ref_To_Local'>rootopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>, </span><a href="nbtpage.c.html#LN349"><span class='Ref_To_Local'>rootlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtpage.c.html#LN345"><span class='Ref_To_Local'>rootbuf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_gettrueroot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_getrootheight() -- Get the height of the btree search tree. 
 * 
 *      We return the level (counting from zero) of the current fast root. 
 *      This represents the number of tree levels we'd have to descend through 
 *      to start any btree index search. 
 * 
 *      This is used by the planner for cost-estimation purposes.  Since it's 
 *      only an estimate, slightly-stale data is fine, hence we don't worry 
 *      about updating previously cached data. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN434"></a><span class='Declare_Function'>_bt_getrootheight</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN436"></a>    <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can get what we need from the cached metapage data.  If it's not 
     * cached yet, load it.  Sanity checks here must match _bt_getroot(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN444"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span><span class='Delimiter'>; 
</span><a name="LN445"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span><span class='Delimiter'>; 
</span><a name="LN446"></a>        <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>metaopaque</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN444"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN445"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN444"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN446"><span class='Ref_To_Local'>metaopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN445"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN445"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* sanity-check the metapage */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN446"><span class='Ref_To_Local'>metaopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/nbtree.h.html#LN72"><span class='Ref_to_Const'>BTP_META</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN97"><span class='Ref_to_Member'>btm_magic</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN109"><span class='Ref_to_Const'>BTREE_MAGIC</span></a><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" is not a btree"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"version mismatch in index \"%s\": file version %d, code version %d"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If there's no root page yet, _bt_getroot() doesn't expect a cache 
         * to be made, so just stop here and report the index height is zero. 
         * (XXX perhaps _bt_getroot() should be changed to allow this case.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN444"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Cache the metapage data for next time 
         */ 
</span>        <a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN178"><span class='Ref_to_Member'>rd_indexcxt</span></a><span class='Delimiter'>, 
</span>                                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN444"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rel-&GT;rd_amcache==NULL &raquo; </span> 
 
    <a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN434"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We shouldn't have cached it if any of these fail */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN97"><span class='Ref_to_Member'>btm_magic</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN109"><span class='Ref_to_Const'>BTREE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN98"><span class='Ref_to_Member'>btm_version</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN110"><span class='Ref_to_Const'>BTREE_VERSION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtpage.c.html#LN436"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_getrootheight &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_checkpage() -- Verify that a freshly-read page looks sane. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN502"></a><span class='Declare_Function'>_bt_checkpage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN504"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN502"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ReadBuffer verifies that every newly-read page passes 
     * PageHeaderIsValid, which means it either contains a reasonably sane 
     * page header or is all-zero.  We have to defend against the all-zero 
     * case, however. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN504"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" contains unexpected zero page at block %u"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN502"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN502"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Please REINDEX it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Additionally check that the special area looks sane. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN296"><span class='Ref_to_Macro'>PageGetSpecialSize</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN504"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN53"><span class='Ref_to_Struct'>BTPageOpaqueData</span></a><span class='Parentheses'>)))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" contains corrupted page at block %u"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN502"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN502"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Please REINDEX it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_checkpage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Log the reuse of a page from the FSM. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN536"></a><span class='Declare_Function'>_bt_log_reuse_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>latestRemovedXid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN538"></a>    <a href="../../../include/access/nbtxlog.h.html#LN132"><span class='Ref_to_Struct'>xl_btree_reuse_page</span></a> <span class='Declare_Local'>xlrec_reuse</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that we don't register the buffer with the record, because this 
     * operation doesn't modify the page. This record only exists to provide a 
     * conflict point for Hot Standby. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <a href="nbtpage.c.html#LN538"><span class='Ref_To_Local'>xlrec_reuse</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN134"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN536"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN538"><span class='Ref_To_Local'>xlrec_reuse</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN135"><span class='Ref_to_Member'>block</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN536"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN538"><span class='Ref_To_Local'>xlrec_reuse</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN136"><span class='Ref_to_Member'>latestRemovedXid</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN536"><span class='Ref_to_Parameter'>latestRemovedXid</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN538"><span class='Ref_To_Local'>xlrec_reuse</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN139"><span class='Ref_to_Const'>SizeOfBtreeReusePage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN39"><span class='Ref_to_Const'>XLOG_BTREE_REUSE_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_log_reuse_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_getbuf() -- Get a buffer by block number for read or write. 
 * 
 *      blkno == P_NEW means to get an unallocated index page.  The page 
 *      will be initialized before returning it. 
 * 
 *      When this routine returns, the appropriate lock is set on the 
 *      requested buffer and its reference count has been incremented 
 *      (ie, the buffer is "locked and pinned").  Also, we apply 
 *      _bt_checkpage to sanity-check the page (except in P_NEW case). 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN569"></a><span class='Declare_Function'>_bt_getbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN571"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Read an existing block of the relation */ 
</span>        <a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/nbtree.h.html#LN481"><span class='Ref_to_Proto'>_bt_checkpage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN582"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>needLock</span><span class='Delimiter'>; 
</span><a name="LN583"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>access</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * First see if the FSM knows of any free pages. 
         * 
         * We can't trust the FSM's report unreservedly; we have to check that 
         * the page is still free.  (For example, an already-free page could 
         * have been re-used between the time the last VACUUM scanned it and 
         * the time the VACUUM made its FSM updates.) 
         * 
         * In fact, it's worse than that: we can't even assume that it's safe 
         * to take a lock on the reported page.  If somebody else has a lock 
         * on it, or even worse our own caller does, we could deadlock.  (The 
         * own-caller scenario is actually not improbable. Consider an index 
         * on a serial or timestamp column.  Nearly all splits will be at the 
         * rightmost page, so it's entirely likely that _bt_split will call us 
         * while holding a lock on the page most recently acquired from FSM. A 
         * VACUUM running concurrently with the previous split could well have 
         * placed that page back in FSM.) 
         * 
         * To get around that, we ask for only a conditional lock on the 
         * reported page.  If we fail, then someone else is using the page, 
         * and we may reasonably assume it's not free.  (If we happen to be 
         * wrong, the worst consequence is the page will be lost to use till 
         * the next VACUUM, which is no big problem.) 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/indexfsm.h.html#LN19"><span class='Ref_to_Proto'>GetFreeIndexPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN487"><span class='Ref_to_Proto'>_bt_page_recyclable</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * If we are generating WAL for Hot Standby then create a 
                     * WAL record that will allow us to conflict with queries 
                     * running on standby. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN158"><span class='Ref_to_Macro'>XLogStandbyInfoActive</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span><a name="LN629"></a>                        <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="nbtpage.c.html#LN41"><span class='Ref_to_Proto'>_bt_log_reuse_page</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN629"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>xact<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* Okay to use page.  Re-initialize and return it */ 
</span>                    <a href="../../../include/access/nbtree.h.html#LN486"><span class='Ref_to_Proto'>_bt_pageinit</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"FSM returned nonrecyclable page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ConditionalLockBuffer... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"FSM returned nonlockable page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* couldn't get lock, so just drop pin */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Extend the relation by one page. 
         * 
         * We have to use a lock to ensure no one else is extending the rel at 
         * the same time, else we will both try to initialize the same new 
         * page.  We can skip locking for new or temp relations, however, 
         * since no one else could be accessing them. 
         */ 
</span>        <a href="nbtpage.c.html#LN582"><span class='Ref_To_Local'>needLock</span></a> <span class='Operator'>= !</span><a href="../../../include/utils/rel.h.html#LN523"><span class='Ref_to_Macro'>RELATION_IS_LOCAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN582"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Acquire buffer lock on new page */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Release the file-extension lock; it's now OK for someone else to 
         * extend the relation some more.  Note that we cannot release this 
         * lock before we have buffer lock on the new page, or we risk a race 
         * condition against btvacuumscan --- see comments therein. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN582"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN569"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize the new page before returning it */ 
</span>        <a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/nbtree.h.html#LN486"><span class='Ref_to_Proto'>_bt_pageinit</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN583"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ref count and lock type are correct */ 
</span>    <span class='Control'>return</span> <a href="nbtpage.c.html#LN571"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_getbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _bt_relandgetbuf() -- release a locked buffer and get another one. 
 * 
 * This is equivalent to _bt_relbuf followed by _bt_getbuf, with the 
 * exception that blkno may not be P_NEW.  Also, if obuf is InvalidBuffer 
 * then it reduces to just _bt_getbuf; allowing this case simplifies some 
 * callers. 
 * 
 * The original motivation for using this was to avoid two entries to the 
 * bufmgr when one would do.  However, now it's mainly just a notational 
 * convenience.  The only case where it saves work over _bt_relbuf/_bt_getbuf 
 * is when the target page is the same one already in the buffer. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN700"></a><span class='Declare_Function'>_bt_relandgetbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>obuf</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>access</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN702"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>obuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN702"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN178"><span class='Ref_to_Proto'>ReleaseAndReadBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>obuf</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN702"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>access</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/nbtree.h.html#LN481"><span class='Ref_to_Proto'>_bt_checkpage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN700"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN702"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="nbtpage.c.html#LN702"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _bt_relbuf() -- release a locked buffer. 
 * 
 * Lock and pin (refcount) are both dropped. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN719"></a><span class='Declare_Function'>_bt_relbuf</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN719"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _bt_pageinit() -- Initialize a new page. 
 * 
 * On return, the page header is initialized; data space is empty; 
 * special space is zeroed out. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN731"></a><span class='Declare_Function'>_bt_pageinit</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN731"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN731"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN53"><span class='Ref_to_Struct'>BTPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  _bt_page_recyclable() -- Is an existing page recyclable? 
 * 
 * This exists to make sure _bt_getbuf and btvacuumscan have the same 
 * policy about whether a page is safe to re-use. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN743"></a><span class='Declare_Function'>_bt_page_recyclable</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN745"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's possible to find an all-zeroes page in an index --- for example, a 
     * backend might successfully extend the relation one page and then crash 
     * before it is able to make a WAL entry for adding the page. If we find a 
     * zeroed page then reclaim it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN743"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise, recycle if deleted and too old to have any processes 
     * interested in it. 
     */ 
</span>    <a href="nbtpage.c.html#LN745"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN743"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN177"><span class='Ref_to_Macro'>P_ISDELETED</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN745"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN745"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>xact<span class='Delimiter'>, </span><a href="../../utils/time/snapmgr.c.html#LN165"><span class='Ref_to_Global_Var'>RecentGlobalXmin</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_page_recyclable &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete item(s) from a btree page during VACUUM. 
 * 
 * This must only be used for deleting leaf items.  Deleting an item on a 
 * non-leaf page has to be done as part of an atomic action that includes 
 * deleting the page it points to. 
 * 
 * This routine assumes that the caller has pinned and locked the buffer. 
 * Also, the given itemnos *must* appear in increasing order in the array. 
 * 
 * We record VACUUMs and b-tree deletes differently in WAL. InHotStandby 
 * we need to be able to pin all of the blocks in the btree in physical 
 * order when replaying the effects of a VACUUM, just as we do for the 
 * original VACUUM itself. lastBlockVacuumed allows us to tell whether an 
 * intermediate range of blocks has had no changes at all by VACUUM, 
 * and so must be scanned anyway during replay. We always write a WAL record 
 * for the last block in the index, whether or not it contained any items 
 * to be removed. This allows us to scan right up to end of index to 
 * ensure correct locking. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN788"></a><span class='Declare_Function'>_bt_delitems_vacuum</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN789"></a>                    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itemnos</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN790"></a>                    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>lastBlockVacuumed</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN792"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN788"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN793"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No ereport(ERROR) until changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fix the page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN789"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufpage.h.html#LN431"><span class='Ref_to_Proto'>PageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN792"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN789"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN789"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can clear the vacuum cycle ID since this page has certainly been 
     * processed by the current vacuum scan. 
     */ 
</span>    <a href="nbtpage.c.html#LN793"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN792"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN793"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the page as not containing any LP_DEAD items.  This is not 
     * certainly true (there might be some that have recently been marked, but 
     * weren't included in our target-item list), but it will almost always be 
     * true and it doesn't seem worth an additional page scan to check it. 
     * Remember that BTP_HAS_GARBAGE is only a hint anyway. 
     */ 
</span>    <a href="nbtpage.c.html#LN793"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/nbtree.h.html#LN75"><span class='Ref_to_Const'>BTP_HAS_GARBAGE</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN788"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN788"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN823"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN824"></a>        <a href="../../../include/access/nbtxlog.h.html#LN164"><span class='Ref_to_Struct'>xl_btree_vacuum</span></a> <span class='Declare_Local'>xlrec_vacuum</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN824"><span class='Ref_To_Local'>xlrec_vacuum</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN166"><span class='Ref_to_Member'>lastBlockVacuumed</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN790"><span class='Ref_to_Parameter'>lastBlockVacuumed</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN788"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN824"><span class='Ref_To_Local'>xlrec_vacuum</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN171"><span class='Ref_to_Const'>SizeOfBtreeVacuum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The target-offsets array is not in the buffer, but pretend that it 
         * is.  When XLogInsert stores the whole buffer, the offsets array 
         * need not be stored too. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN789"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN789"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN789"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN823"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN37"><span class='Ref_to_Const'>XLOG_BTREE_VACUUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN792"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN823"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_delitems_vacuum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete item(s) from a btree page during single-page cleanup. 
 * 
 * As above, must only be used on leaf pages. 
 * 
 * This routine assumes that the caller has pinned and locked the buffer. 
 * Also, the given itemnos *must* appear in increasing order in the array. 
 * 
 * This is nearly the same as _bt_delitems_vacuum as far as what it does to 
 * the page, but the WAL logging considerations are quite different.  See 
 * comments for _bt_delitems_vacuum. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN861"></a><span class='Declare_Function'>_bt_delitems_delete</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN862"></a>                    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itemnos</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN863"></a>                    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN865"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN861"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN866"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Shouldn't be called unless there's something to do */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN862"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No ereport(ERROR) until changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fix the page */ 
</span>    <a href="../../../include/storage/bufpage.h.html#LN431"><span class='Ref_to_Proto'>PageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN865"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN862"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN862"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unlike _bt_delitems_vacuum, we *must not* clear the vacuum cycle ID, 
     * because this is not called by VACUUM. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the page as not containing any LP_DEAD items.  This is not 
     * certainly true (there might be some that have recently been marked, but 
     * weren't included in our target-item list), but it will almost always be 
     * true and it doesn't seem worth an additional page scan to check it. 
     * Remember that BTP_HAS_GARBAGE is only a hint anyway. 
     */ 
</span>    <a href="nbtpage.c.html#LN866"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN865"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN866"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/nbtree.h.html#LN75"><span class='Ref_to_Const'>BTP_HAS_GARBAGE</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN861"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN861"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN897"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN898"></a>        <a href="../../../include/access/nbtxlog.h.html#LN118"><span class='Ref_to_Struct'>xl_btree_delete</span></a> <span class='Declare_Local'>xlrec_delete</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN898"><span class='Ref_To_Local'>xlrec_delete</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN120"><span class='Ref_to_Member'>hnode</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN863"><span class='Ref_to_Parameter'>heapRel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN898"><span class='Ref_To_Local'>xlrec_delete</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN122"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN862"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN861"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN898"><span class='Ref_To_Local'>xlrec_delete</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN127"><span class='Ref_to_Const'>SizeOfBtreeDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We need the target-offsets array whether or not we store the whole 
         * buffer, to allow us to find the latestRemovedXid on a standby 
         * server. 
         */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtpage.c.html#LN862"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN862"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN897"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN32"><span class='Ref_to_Const'>XLOG_BTREE_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN865"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN897"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_delitems_delete &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns true, if the given block has the half-dead flag set. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN926"></a><span class='Declare_Function'>_bt_is_page_halfdead</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blk</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN928"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN929"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN930"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN931"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN928"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN926"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN926"><span class='Ref_to_Parameter'>blk</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN929"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN928"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN930"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN929"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN931"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN930"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN926"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN928"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtpage.c.html#LN931"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Subroutine to find the parent of the branch we're deleting.  This climbs 
 * up the tree until it finds a page with more than one child, i.e. a page 
 * that will not be totally emptied by the deletion.  The chain of pages below 
 * it, with one downlink each, will form the branch that we need to delete. 
 * 
 * If we cannot remove the downlink from the parent, because it's the 
 * rightmost entry, returns false.  On success, *topparent and *topoff are set 
 * to the buffer holding the parent, and the offset of the downlink in it. 
 * *topparent is write-locked, the caller is responsible for releasing it when 
 * done.  *target is set to the topmost page in the branch to-be-deleted, i.e. 
 * the page whose downlink *topparent / *topoff point to, and *rightsib to its 
 * right sibling. 
 * 
 * "child" is the leaf page we wish to delete, and "stack" is a search stack 
 * leading to it (approximately).  Note that we will update the stack 
 * entry(s) to reflect current downlink positions --- this is harmless and 
 * indeed saves later search effort in _bt_pagedel.  The caller should 
 * initialize *target and *rightsib to the leaf page and its right sibling. 
 * 
 * Note: it's OK to release page locks on any internal pages between the leaf 
 * and *topparent, because a safe deletion can't become unsafe due to 
 * concurrent activity.  An internal page can only acquire an entry if the 
 * child is split, but that cannot happen as long as we hold a lock on the 
 * leaf. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN970"></a><span class='Declare_Function'>_bt_lock_branch_parent</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>child</span><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Delimiter'>, 
</span><a name="LN971"></a>                       <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>topparent</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>topoff</span><span class='Delimiter'>, 
</span><a name="LN972"></a>                       <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>target</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rightsib</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN974"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>parent</span><span class='Delimiter'>; 
</span><a name="LN975"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>poffset</span><span class='Delimiter'>, 
</span><a name="LN976"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN977"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>pbuf</span><span class='Delimiter'>; 
</span><a name="LN978"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN979"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN980"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leftsib</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Locate the downlink of "child" in the parent (updating the stack entry 
     * if needed) 
     */ 
</span>    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN254"><span class='Ref_to_Member'>bts_btentry</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>child</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN471"><span class='Ref_to_Proto'>_bt_getstackbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find parent key in index \"%s\" for deletion target page %u"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN974"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN252"><span class='Ref_to_Member'>bts_blkno</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN975"><span class='Ref_To_Local'>poffset</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN253"><span class='Ref_to_Member'>bts_offset</span></a><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN978"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN978"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN976"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN978"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the target is the rightmost child of its parent, then we can't 
     * delete, unless it's also the only child. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN975"><span class='Ref_To_Local'>poffset</span></a> <span class='Operator'>&GT;= </span><a href="nbtpage.c.html#LN976"><span class='Ref_To_Local'>maxoff</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* It's rightmost child... */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN975"><span class='Ref_To_Local'>poffset</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * It's only child, so safe if parent would itself be removable. 
             * We have to check the parent itself, and then recurse to test 
             * the conditions at the parent's parent. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/nbtree.h.html#LN176"><span class='Ref_to_Macro'>P_ISROOT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Operator'>*</span><a href="nbtpage.c.html#LN972"><span class='Ref_to_Parameter'>target</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN974"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="nbtpage.c.html#LN972"><span class='Ref_to_Parameter'>rightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN980"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN979"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Like in _bt_pagedel, check that the left sibling is not marked 
             * with INCOMPLETE_SPLIT flag.  That would mean that there is no 
             * downlink to the page to be deleted, and the page deletion 
             * algorithm isn't prepared to handle that. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN980"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1033"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>lbuf</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>                <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>lpage</span><span class='Delimiter'>; 
</span><a name="LN1035"></a>                <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lopaque</span><span class='Delimiter'>; 
</span> 
                <a href="nbtpage.c.html#LN1033"><span class='Ref_To_Local'>lbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN980"><span class='Ref_To_Local'>leftsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtpage.c.html#LN1034"><span class='Ref_To_Local'>lpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1033"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtpage.c.html#LN1035"><span class='Ref_To_Local'>lopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1034"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If the left sibling was concurrently split, so that its 
                 * next-pointer doesn't point to the current page anymore, the 
                 * split that created the current page must be completed. (We 
                 * don't allow splitting an incompletely split page again 
                 * until the previous split has been completed) 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1035"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>== </span><a href="nbtpage.c.html#LN974"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>&& 
</span>                    <a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1035"><span class='Ref_To_Local'>lopaque</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1033"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1033"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if leftsib!=P_NONE &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * Perform the same check on this internal level that 
             * _bt_mark_page_halfdead performed on the leaf level. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN925"><span class='Ref_to_Func'>_bt_is_page_halfdead</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="nbtpage.c.html#LN972"><span class='Ref_to_Parameter'>rightsib</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"could not delete page %u because its right sibling %u is half-dead"</span><span class='Delimiter'>, 
</span>                     <a href="nbtpage.c.html#LN974"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="nbtpage.c.html#LN972"><span class='Ref_to_Parameter'>rightsib</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>return</span> <a href="nbtpage.c.html#LN38"><span class='Ref_to_Proto'>_bt_lock_branch_parent</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN974"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>stack</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN255"><span class='Ref_to_Member'>bts_parent</span></a><span class='Delimiter'>, 
</span>                                        <a href="nbtpage.c.html#LN971"><span class='Ref_to_Parameter'>topparent</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN971"><span class='Ref_to_Parameter'>topoff</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN972"><span class='Ref_to_Parameter'>target</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN972"><span class='Ref_to_Parameter'>rightsib</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if poffset==P_FIRSTDATAK... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Unsafe to delete */ 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN970"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if poffset&GT;=maxoff &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Not rightmost child, so safe to delete */ 
</span>        <span class='Operator'>*</span><a href="nbtpage.c.html#LN971"><span class='Ref_to_Parameter'>topparent</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN977"><span class='Ref_To_Local'>pbuf</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="nbtpage.c.html#LN971"><span class='Ref_to_Parameter'>topoff</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN975"><span class='Ref_To_Local'>poffset</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end _bt_lock_branch_parent &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * _bt_pagedel() -- Delete a page from the b-tree, if legal to do so. 
 * 
 * This action unlinks the page from the b-tree structure, removing all 
 * pointers leading to it --- but not touching its own left and right links. 
 * The page cannot be physically reclaimed right away, since other processes 
 * may currently be trying to follow links leading to the page; they have to 
 * be allowed to use its right-link to recover.  See nbtree/README. 
 * 
 * On entry, the target buffer must be pinned and locked (either read or write 
 * lock is OK).  This lock and pin will be dropped before exiting. 
 * 
 * Returns the number of pages successfully deleted (zero if page cannot 
 * be deleted now; could be more than one if parent or sibling pages were 
 * deleted too). 
 * 
 * NOTE: this leaks memory.  Rather than trying to clean up everything 
 * carefully, it's better to run it in a temp context that can be reset 
 * frequently. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1108"></a><span class='Declare_Function'>_bt_pagedel</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1110"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndeleted</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1111"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rightsib</span><span class='Delimiter'>; 
</span><a name="LN1112"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>rightsib_empty</span><span class='Delimiter'>; 
</span><a name="LN1113"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1114"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * "stack" is a search stack leading (approximately) to the target page. 
     * It is initially NULL, but when iterating, we keep it to avoid 
     * duplicated search effort. 
     * 
     * Also, when "stack" is not NULL, we have already checked that the 
     * current page is not the right half of an incomplete split, i.e. the 
     * left sibling does not have its INCOMPLETE_SPLIT flag set. 
     */ 
</span><a name="LN1125"></a>    <a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a>     <span class='Declare_Local'>stack</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1113"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1113"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Internal pages are never deleted directly, only as part of deleting 
         * the whole branch all the way down to leaf level. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Pre-9.4 page deletion only marked internal pages as half-dead, 
             * but now we only use that flag on leaf pages. The old algorithm 
             * was never supposed to leave half-dead pages in the tree, it was 
             * just a transient state, but it was nevertheless possible in 
             * error scenarios. We don't know how to deal with them here. They 
             * are harmless as far as searches are considered, but inserts 
             * into the deleted keyspace could add out-of-order downlinks in 
             * the upper levels. Log a notice, hopefully the admin will notice 
             * and reindex. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDEX_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" contains a half-dead internal page"</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"This can be caused by an interrupted VACUUM in version 9.3 or older, before upgrade. Please REINDEX it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !P_ISLEAF(opaque) &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * We can never delete rightmost pages nor root pages.  While at it, 
         * check that page is not already deleted and is empty. 
         * 
         * To keep the algorithm simple, we also never delete an incompletely 
         * split page (they should be rare enough that this doesn't make any 
         * meaningful difference to disk usage): 
         * 
         * The INCOMPLETE_SPLIT flag on the page tells us if the page is the 
         * left half of an incomplete split, but ensuring that it's not the 
         * right half is more complicated.  For that, we have to check that 
         * the left sibling doesn't have its INCOMPLETE_SPLIT flag set.  On 
         * the first iteration, we temporarily release the lock on the current 
         * page, and check the left sibling and also construct a search stack 
         * to.  On subsequent iterations, we know we stepped right from a page 
         * that passed these tests, so it's OK. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/nbtree.h.html#LN176"><span class='Ref_to_Macro'>P_ISROOT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/nbtree.h.html#LN177"><span class='Ref_to_Macro'>P_ISDELETED</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1113"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Should never fail to delete a half-dead page */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * First, remove downlink pointing to the page (or a parent of the 
         * page, if we are going to delete a taller branch), and mark the page 
         * as half-dead. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We need an approximate pointer to the page's parent page.  We 
             * use the standard search mechanism to search for the page's high 
             * key; this will give us a link to either the current parent or 
             * someplace to its left (if there are multiple equal high keys). 
             * 
             * Also check if this is the right-half of an incomplete split 
             * (see comment above). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtpage.c.html#LN1125"><span class='Ref_To_Local'>stack</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1205"></a>                <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a>     <span class='Declare_Local'>itup_scankey</span><span class='Delimiter'>; 
</span><a name="LN1206"></a>                <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1207"></a>                <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>targetkey</span><span class='Delimiter'>; 
</span><a name="LN1208"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>lbuf</span><span class='Delimiter'>; 
</span><a name="LN1209"></a>                <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leftsib</span><span class='Delimiter'>; 
</span> 
                <a href="nbtpage.c.html#LN1206"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1113"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtpage.c.html#LN1207"><span class='Ref_To_Local'>targetkey</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>((</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1113"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1206"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="nbtpage.c.html#LN1209"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * To avoid deadlocks, we'd better drop the leaf page lock 
                 * before going further. 
                 */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Fetch the left sibling, to check that it's not marked with 
                 * INCOMPLETE_SPLIT flag.  That would mean that the page 
                 * to-be-deleted doesn't have a downlink, and the page 
                 * deletion algorithm isn't prepared to handle that. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN173"><span class='Ref_to_Macro'>P_LEFTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span><a name="LN1230"></a>                    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>lopaque</span><span class='Delimiter'>; 
</span><a name="LN1231"></a>                    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>lpage</span><span class='Delimiter'>; 
</span> 
                    <a href="nbtpage.c.html#LN1208"><span class='Ref_To_Local'>lbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1209"><span class='Ref_To_Local'>leftsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="nbtpage.c.html#LN1231"><span class='Ref_To_Local'>lpage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1208"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="nbtpage.c.html#LN1230"><span class='Ref_To_Local'>lopaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1231"><span class='Ref_To_Local'>lpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * If the left sibling is split again by another backend, 
                     * after we released the lock, we know that the first 
                     * split must have finished, because we don't allow an 
                     * incompletely-split page to be split again.  So we don't 
                     * need to walk right here. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1230"><span class='Ref_To_Local'>lopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>== </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                        <a href="../../../include/access/nbtree.h.html#LN182"><span class='Ref_to_Macro'>P_INCOMPLETE_SPLIT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1230"><span class='Ref_To_Local'>lopaque</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1208"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>return</span> <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1208"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !P_LEFTMOST(opaque) &raquo; </span> 
 
                <span class='Comment_Multi_Line'>/* we need an insertion scan key for the search, so build one */ 
</span>                <a href="nbtpage.c.html#LN1205"><span class='Ref_To_Local'>itup_scankey</span></a> <span class='Operator'>= </span><a href="nbtutils.c.html#LN60"><span class='Ref_to_Func'>_bt_mkscankey</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1207"><span class='Ref_To_Local'>targetkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* find the leftmost leaf page containing this key */ 
</span>                <a href="nbtpage.c.html#LN1125"><span class='Ref_To_Local'>stack</span></a> <span class='Operator'>= </span><a href="nbtsearch.c.html#LN95"><span class='Ref_to_Func'>_bt_search</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnatts<span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1205"><span class='Ref_To_Local'>itup_scankey</span></a><span class='Delimiter'>, 
</span>                                   <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1208"><span class='Ref_To_Local'>lbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* don't need a pin on the page */ 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1208"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Re-lock the leaf page, and start over, to re-check that the 
                 * page can still be deleted. 
                 */ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !stack &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtpage.c.html#LN35"><span class='Ref_to_Proto'>_bt_mark_page_halfdead</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1125"><span class='Ref_To_Local'>stack</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !P_ISHALFDEAD(opaque) &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Then unlink it from its siblings.  Each call to 
         * _bt_unlink_halfdead_page unlinks the topmost page from the branch, 
         * making it shallower.  Iterate until the leaf page is gone. 
         */ 
</span>        <a href="nbtpage.c.html#LN1112"><span class='Ref_To_Local'>rightsib_empty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtpage.c.html#LN36"><span class='Ref_to_Proto'>_bt_unlink_halfdead_page</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1112"><span class='Ref_To_Local'>rightsib_empty</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* _bt_unlink_halfdead_page already released buffer */ 
</span>                <span class='Control'>return</span> <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="nbtpage.c.html#LN1111"><span class='Ref_To_Local'>rightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1114"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The page has now been deleted. If its right sibling is completely 
         * empty, it's possible that the reason we haven't deleted it earlier 
         * is that it was the rightmost child of the parent. Now that we 
         * removed the downlink for this page, the right sibling might now be 
         * the only child of the parent, and could be removed. It would be 
         * picked up by the next vacuum anyway, but might as well try to 
         * remove it now, so loop back to process the right sibling. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtpage.c.html#LN1112"><span class='Ref_To_Local'>rightsib_empty</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1108"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1111"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>return</span> <a href="nbtpage.c.html#LN1110"><span class='Ref_To_Local'>ndeleted</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_pagedel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * First stage of page deletion.  Remove the downlink to the top of the 
 * branch being deleted, and mark the leaf page as half-dead. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1320"></a><span class='Declare_Function'>_bt_mark_page_halfdead</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>leafbuf</span><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN258"><span class='Ref_to_Typedef'>BTStack</span></a> <span class='Declare_Parameter'>stack</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1322"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leafblkno</span><span class='Delimiter'>; 
</span><a name="LN1323"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leafrightsib</span><span class='Delimiter'>; 
</span><a name="LN1324"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>; 
</span><a name="LN1325"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rightsib</span><span class='Delimiter'>; 
</span><a name="LN1326"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1327"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1328"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN1329"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>topparent</span><span class='Delimiter'>; 
</span><a name="LN1330"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>topoff</span><span class='Delimiter'>; 
</span><a name="LN1331"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>nextoffset</span><span class='Delimiter'>; 
</span><a name="LN1332"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>; 
</span><a name="LN1333"></a>    <a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a> <span class='Declare_Local'>trunctuple</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="../../../include/access/nbtree.h.html#LN176"><span class='Ref_to_Macro'>P_ISROOT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="../../../include/access/nbtree.h.html#LN177"><span class='Ref_to_Macro'>P_ISDELETED</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>           <span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>           <a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Save info about the leaf page. 
     */ 
</span>    <a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1323"><span class='Ref_To_Local'>leafrightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Before attempting to lock the parent page, check that the right sibling 
     * is not in half-dead state.  A half-dead right sibling would have no 
     * downlink in the parent, which would be highly confusing later when we 
     * delete the downlink that follows the current page's downlink. (I 
     * believe the deletion would work correctly, but it would fail the 
     * cross-check we make that the following downlink points to the right 
     * sibling of the delete page.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN925"><span class='Ref_to_Func'>_bt_is_page_halfdead</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1323"><span class='Ref_To_Local'>leafrightsib</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"could not delete page %u because its right sibling %u is half-dead"</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1323"><span class='Ref_To_Local'>leafrightsib</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We cannot delete a page that is the rightmost child of its immediate 
     * parent, unless it is the only child --- in which case the parent has to 
     * be deleted too, and the same condition applies recursively to it. We 
     * have to check this condition all the way up before trying to delete, 
     * and lock the final parent of the to-be-deleted branch. 
     */ 
</span>    <a href="nbtpage.c.html#LN1325"><span class='Ref_To_Local'>rightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1323"><span class='Ref_To_Local'>leafrightsib</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtpage.c.html#LN38"><span class='Ref_to_Proto'>_bt_lock_branch_parent</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>stack</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1330"><span class='Ref_To_Local'>topoff</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1325"><span class='Ref_To_Local'>rightsib</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the parent-page index items we're about to delete/overwrite 
     * contain what we expect.  This can fail if the index has become corrupt 
     * for some reason.  We want to throw any error before entering the 
     * critical section --- otherwise it'd be a PANIC. 
     * 
     * The test on the target item is just an Assert because 
     * _bt_lock_branch_parent should have guaranteed it has the expected 
     * contents.  The test on the next-child downlink is known to sometimes 
     * fail in the field, though. 
     */ 
</span>    <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
    <a href="nbtpage.c.html#LN1326"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1330"><span class='Ref_To_Local'>topoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1326"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="nbtpage.c.html#LN1331"><span class='Ref_To_Local'>nextoffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1330"><span class='Ref_To_Local'>topoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1326"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1331"><span class='Ref_To_Local'>nextoffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1326"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1325"><span class='Ref_To_Local'>rightsib</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"right sibling %u of block %u is not next child %u of block %u in index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN1325"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>             <a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Any insert which would have gone on the leaf block will now go to its 
     * right sibling. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN54"><span class='Ref_to_Proto'>PredicateLockPageCombine</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1323"><span class='Ref_To_Local'>leafrightsib</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No ereport(ERROR) until changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update parent.  The normal case is a tad tricky because we want to 
     * delete the target's downlink and the *following* key.  Easiest way is 
     * to copy the right sibling's downlink over the target downlink, and then 
     * delete the following item. 
     */ 
</span>    <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN1326"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1330"><span class='Ref_To_Local'>topoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1326"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1332"><span class='Ref_To_Local'>itup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1325"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN1331"><span class='Ref_To_Local'>nextoffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1330"><span class='Ref_To_Local'>topoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1331"><span class='Ref_To_Local'>nextoffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the leaf page as half-dead, and stamp it with a pointer to the 
     * highest internal page in the branch we're deleting.  We use the tid of 
     * the high key to store it. 
     */ 
</span>    <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/nbtree.h.html#LN73"><span class='Ref_to_Const'>BTP_HALF_DEAD</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1333"><span class='Ref_To_Local'>trunctuple</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1333"><span class='Ref_To_Local'>trunctuple</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1333"><span class='Ref_To_Local'>trunctuple</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1333"><span class='Ref_To_Local'>trunctuple</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1333"><span class='Ref_To_Local'>trunctuple</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not add dummy high key to half-dead page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must mark buffers dirty before XLogInsert */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1458"></a>        <a href="../../../include/access/nbtxlog.h.html#LN183"><span class='Ref_to_Struct'>xl_btree_mark_page_halfdead</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN1459"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN185"><span class='Ref_to_Member'>poffset</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1330"><span class='Ref_To_Local'>topoff</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN188"><span class='Ref_to_Member'>leafblk</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1322"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>            <a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN191"><span class='Ref_to_Member'>topparent</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1324"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN191"><span class='Ref_to_Member'>topparent</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN189"><span class='Ref_to_Member'>leftblk</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN190"><span class='Ref_to_Member'>rightblk</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1328"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1458"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN194"><span class='Ref_to_Const'>SizeOfBtreeMarkPageHalfDead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1459"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN36"><span class='Ref_to_Const'>XLOG_BTREE_MARK_PAGE_HALFDEAD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1459"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1459"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1320"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1329"><span class='Ref_To_Local'>topparent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_mark_page_halfdead &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Unlink a page in a branch of half-dead pages from its siblings. 
 * 
 * If the leaf page still has a downlink pointing to it, unlinks the highest 
 * parent in the to-be-deleted branch instead of the leaf page.  To get rid 
 * of the whole branch, including the leaf page itself, iterate until the 
 * leaf page is deleted. 
 * 
 * Returns 'false' if the page could not be unlinked (shouldn't happen). 
 * If the (new) right sibling of the page is empty, *rightsib_empty is set 
 * to true. 
 * 
 * Must hold pin and lock on leafbuf at entry (read or write doesn't matter). 
 * On success exit, we'll be holding pin and write lock.  On failure exit, 
 * we'll release both pin and lock before returning (we define it that way 
 * to avoid having to reacquire a lock we already released). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1511"></a><span class='Declare_Function'>_bt_unlink_halfdead_page</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>leafbuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>rightsib_empty</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1513"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leafblkno</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1514"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leafleftsib</span><span class='Delimiter'>; 
</span><a name="LN1515"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leafrightsib</span><span class='Delimiter'>; 
</span><a name="LN1516"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>; 
</span><a name="LN1517"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leftsib</span><span class='Delimiter'>; 
</span><a name="LN1518"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rightsib</span><span class='Delimiter'>; 
</span><a name="LN1519"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>lbuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN1520"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1521"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>rbuf</span><span class='Delimiter'>; 
</span><a name="LN1522"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN1523"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapg</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1524"></a>    <a href="../../../include/access/nbtree.h.html#LN95"><span class='Ref_to_Struct'>BTMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metad</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1525"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1526"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1527"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span><a name="LN1528"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>rightsib_is_rightmost</span><span class='Delimiter'>; 
</span><a name="LN1529"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>targetlevel</span><span class='Delimiter'>; 
</span><a name="LN1530"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>leafhikey</span><span class='Delimiter'>; 
</span><a name="LN1531"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nextchild</span><span class='Delimiter'>; 
</span> 
    <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remember some information about the leaf page. 
     */ 
</span>    <a href="nbtpage.c.html#LN1525"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1530"><span class='Ref_To_Local'>leafhikey</span></a> <span class='Operator'>= &</span><span class='Parentheses'>((</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1525"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>t_tid<span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1514"><span class='Ref_To_Local'>leafleftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1515"><span class='Ref_To_Local'>leafrightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the leaf page still has a parent pointing to it (or a chain of 
     * parents), we don't unlink the leaf page yet, but the topmost remaining 
     * parent in the branch.  Set 'target' and 'buf' to reference the page 
     * actually being unlinked. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1530"><span class='Ref_To_Local'>leafhikey</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1530"><span class='Ref_To_Local'>leafhikey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* fetch the block number of the topmost parent's left sibling */ 
</span>        <a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN237"><span class='Ref_to_Const'>BT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1529"><span class='Ref_To_Local'>targetlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * To avoid deadlocks, we'd better drop the target page lock before 
         * going further. 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1514"><span class='Ref_To_Local'>leafleftsib</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1529"><span class='Ref_To_Local'>targetlevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have to lock the pages we need to modify in the standard order: 
     * moving right, then up.  Else we will deadlock against other writers. 
     * 
     * So, first lock the leaf page, if it's not the target.  Then find and 
     * write-lock the current left sibling of the target page.  The sibling 
     * that was current a moment ago could have split, so we may have to move 
     * right.  This search could fail if either the sibling or the target page 
     * was deleted by someone else meanwhile; if so, give up.  (Right now, 
     * that should never happen, since page deletion is only done in VACUUM 
     * and there shouldn't be multiple VACUUMs concurrently on the same 
     * table.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>!= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN177"><span class='Ref_to_Macro'>P_ISDELETED</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* step right one page */ 
</span>            <a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"no left sibling (concurrent deletion?) of block %u in \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* we have only a pin on target, but pin+lock on leafbuf */ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* we have only a pin on leafbuf */ 
</span>                    <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while P_ISDELETED(opaque)||... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if leftsib!=P_NONE &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Next write-lock the target page itself.  It should be okay to take just 
     * a write lock not a superexclusive lock, since no scans would stop on an 
     * empty page. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check page is still empty etc, else abandon deletion.  This is just for 
     * paranoia's sake; a half-dead page cannot resurrect because there can be 
     * only one vacuum process running at a time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/nbtree.h.html#LN176"><span class='Ref_to_Macro'>P_ISROOT</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/nbtree.h.html#LN177"><span class='Ref_to_Macro'>P_ISDELETED</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"half-dead page changed status unexpectedly in block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"left link changed unexpectedly in block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>== </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>|| !</span><a href="../../../include/access/nbtree.h.html#LN179"><span class='Ref_to_Macro'>P_ISHALFDEAD</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"half-dead page changed status unexpectedly in block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"half-dead page changed status unexpectedly in block %u of index \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remember the next non-leaf child down in the branch. */ 
</span>        <a href="nbtpage.c.html#LN1525"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>((</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1525"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>t_tid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a> <span class='Operator'>== </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>            <a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And next write-lock the (current) right sibling. 
     */ 
</span>    <a href="nbtpage.c.html#LN1518"><span class='Ref_To_Local'>rightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1518"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"right sibling's left-link doesn't match: "</span> 
             <span class='String'>"block %u links to %u instead of expected %u in index \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="nbtpage.c.html#LN1518"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1528"><span class='Ref_To_Local'>rightsib_is_rightmost</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rightsib_empty</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN204"><span class='Ref_to_Macro'>P_FIRSTDATAKEY</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are deleting the next-to-last page on the target's level, then 
     * the rightsib is a candidate to become the new fast root. (In theory, it 
     * might be possible to push the fast root even further down, but the odds 
     * of doing so are slim, and the locking considerations daunting.) 
     * 
     * We don't support handling this in the case where the parent is becoming 
     * half-dead, even though it theoretically could occur. 
     * 
     * We can safely acquire a lock on the metapage here --- see comments for 
     * _bt_newroot(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a> <span class='Operator'>&& </span><a href="nbtpage.c.html#LN1528"><span class='Ref_To_Local'>rightsib_is_rightmost</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN174"><span class='Ref_to_Macro'>P_RIGHTMOST</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* rightsib will be the only one left on the level */ 
</span>            <a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN482"><span class='Ref_to_Proto'>_bt_getbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN238"><span class='Ref_to_Const'>BT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1523"><span class='Ref_To_Local'>metapg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN105"><span class='Ref_to_Macro'>BTPageGetMeta</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1523"><span class='Ref_To_Local'>metapg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The expected case here is btm_fastlevel == targetlevel+1; if 
             * the fastlevel is &LT;= targetlevel, something is wrong, and we 
             * choose to overwrite it to fix it. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>&GT; </span><a href="nbtpage.c.html#LN1529"><span class='Ref_To_Local'>targetlevel</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* no update wanted */ 
</span>                <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if leftsib==P_NONE&&righ... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Here we begin doing the deletion. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* No ereport(ERROR) until changes are logged */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update siblings' side-links.  Note the target page's side-links will 
     * continue to point to the siblings.  Asserts here are just rechecking 
     * things we already verified above. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>== </span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1518"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>== </span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we deleted a parent of the targeted leaf page, instead of the leaf 
     * itself, update the leaf to point to the next remaining child in the 
     * branch. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1530"><span class='Ref_To_Local'>leafhikey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1530"><span class='Ref_To_Local'>leafhikey</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the page itself deleted.  It can be recycled when all current 
     * transactions are gone.  Storing GetTopTransactionId() would work, but 
     * we're in VACUUM and would not otherwise have an XID.  Having already 
     * updated links to the target, ReadNewTransactionId() suffices as an 
     * upper bound.  Any scan having retained a now-stale link is advertising 
     * in its PGXACT an xmin less than or equal to the value we read here.  It 
     * will continue to do so, holding back RecentGlobalXmin, for the duration 
     * of that scan. 
     */ 
</span>    <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>&= ~</span><a href="../../../include/access/nbtree.h.html#LN73"><span class='Ref_to_Const'>BTP_HALF_DEAD</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/nbtree.h.html#LN71"><span class='Ref_to_Const'>BTP_DELETED</span></a><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>xact <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN178"><span class='Ref_to_Proto'>ReadNewTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And update the metapage, if needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1518"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1529"><span class='Ref_To_Local'>targetlevel</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Must mark buffers dirty before XLogInsert */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1801"></a>        <a href="../../../include/access/nbtxlog.h.html#LN207"><span class='Ref_to_Struct'>xl_btree_unlink_page</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN1802"></a>        <a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a> <span class='Declare_Local'>xlmeta</span><span class='Delimiter'>; 
</span><a name="LN1803"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>xlinfo</span><span class='Delimiter'>; 
</span><a name="LN1804"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* information on the unlinked block */ 
</span>        <a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN209"><span class='Ref_to_Member'>leftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1517"><span class='Ref_To_Local'>leftsib</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN210"><span class='Ref_to_Member'>rightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1518"><span class='Ref_To_Local'>rightsib</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN220"><span class='Ref_to_Member'>btpo_xact</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1527"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>xact<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* information needed to recreate the leaf block (if not the target) */ 
</span>        <a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN216"><span class='Ref_to_Member'>leafleftsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1514"><span class='Ref_To_Local'>leafleftsib</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN217"><span class='Ref_to_Member'>leafrightsib</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1515"><span class='Ref_To_Local'>leafrightsib</span></a><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN218"><span class='Ref_to_Member'>topparent</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1531"><span class='Ref_To_Local'>nextchild</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1801"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtxlog.h.html#LN224"><span class='Ref_to_Const'>SizeOfBtreeUnlinkPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtpage.c.html#LN1802"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN47"><span class='Ref_to_Member'>root</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN99"><span class='Ref_to_Member'>btm_root</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1802"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN48"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN100"><span class='Ref_to_Member'>btm_level</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1802"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN49"><span class='Ref_to_Member'>fastroot</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN101"><span class='Ref_to_Member'>btm_fastroot</span></a><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1802"><span class='Ref_To_Local'>xlmeta</span></a><span class='Operator'>.</span><a href="../../../include/access/nbtxlog.h.html#LN50"><span class='Ref_to_Member'>fastlevel</span></a> <span class='Operator'>= </span><a href="nbtpage.c.html#LN1524"><span class='Ref_To_Local'>metad</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN102"><span class='Ref_to_Member'>btm_fastlevel</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN50"><span class='Ref_to_Proto'>XLogRegisterBufData</span></a><span class='Parentheses'>(</span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="nbtpage.c.html#LN1802"><span class='Ref_To_Local'>xlmeta</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/nbtxlog.h.html#LN45"><span class='Ref_to_Struct'>xl_btree_metadata</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="nbtpage.c.html#LN1803"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtxlog.h.html#LN34"><span class='Ref_to_Const'>XLOG_BTREE_UNLINK_PAGE_META</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="nbtpage.c.html#LN1803"><span class='Ref_To_Local'>xlinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtxlog.h.html#LN33"><span class='Ref_to_Const'>XLOG_BTREE_UNLINK_PAGE</span></a><span class='Delimiter'>; 
</span> 
        <a href="nbtpage.c.html#LN1804"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_BTREE_ID<span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1803"><span class='Ref_To_Local'>xlinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1523"><span class='Ref_To_Local'>metapg</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1804"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1804"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1804"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1804"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>leafbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1526"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1804"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(rel) &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release metapage */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1522"><span class='Ref_To_Local'>metabuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release siblings */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1519"><span class='Ref_To_Local'>lbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1521"><span class='Ref_To_Local'>rbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release the target, if it was not the leaf block.  The leaf is always 
     * kept locked. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1516"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>!= </span><a href="nbtpage.c.html#LN1513"><span class='Ref_To_Local'>leafblkno</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/nbtree.h.html#LN485"><span class='Ref_to_Proto'>_bt_relbuf</span></a><span class='Parentheses'>(</span><a href="nbtpage.c.html#LN1511"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="nbtpage.c.html#LN1520"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_unlink_halfdead_page &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>