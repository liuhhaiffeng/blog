<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\nbtree\nbtsort.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\nbtree\nbtsort.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:29 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * nbtsort.c 
 *      Build a btree from sorted input by loading leaf pages sequentially. 
 * 
 * NOTES 
 * 
 * We use tuplesort.c to sort the given index tuples into order. 
 * Then we scan the index tuples in order and build the btree pages 
 * for each level.  We load source tuples into leaf-level pages. 
 * Whenever we fill a page at one level, we add a link to it to its 
 * parent level (starting a new parent level if necessary).  When 
 * done, we write out each final page on each level, adding it to 
 * its parent level.  When we have only one page on a level, it must be 
 * the root -- it can be attached to the btree metapage and we are done. 
 * 
 * This code is moderately slow (~10% slower) compared to the regular 
 * btree (insertion) build code on sorted or well-clustered data.  On 
 * random data, however, the insertion build code is unusable -- the 
 * difference on a 60MB heap is a factor of 15 because the random 
 * probes into the btree thrash the buffer pool.  (NOTE: the above 
 * "10%" estimate is probably obsolete, since it refers to an old and 
 * not very good external sort implementation that used to exist in 
 * this module.  tuplesort.c is almost certainly faster.) 
 * 
 * It is not wise to pack the pages entirely full, since then *any* 
 * insertion would cause a split (and not only of the leaf page; the need 
 * for a split would cascade right up the tree).  The steady-state load 
 * factor for btrees is usually estimated at 70%.  We choose to pack leaf 
 * pages to the user-controllable fill factor (default 90%) while upper pages 
 * are always packed to 70%.  This gives us reasonable density (there aren't 
 * many upper pages if the keys are reasonable-size) without risking a lot of 
 * cascading splits during early insertions. 
 * 
 * Formerly the index pages being built were kept in shared buffers, but 
 * that is of no value (since other backends have no interest in them yet) 
 * and it created locking problems for CHECKPOINT, because the upper-level 
 * pages were held exclusive-locked for long periods.  Now we just build 
 * the pages in local memory and smgrwrite or smgrextend them as we finish 
 * them.  They will need to be re-read into shared buffers on first use after 
 * the build finishes. 
 * 
 * Since the index will never be used unless it is completely built, 
 * from a crash-recovery point of view there is no need to WAL-log the 
 * steps of the build.  After completing the index build, we can just sync 
 * the whole file to disk using smgrimmedsync() before exiting this module. 
 * This can be seen to be sufficient for crash recovery by considering that 
 * it's effectively equivalent to what would happen if a CHECKPOINT occurred 
 * just after the index build.  However, it is clearly not sufficient if the 
 * DBA is using the WAL log for PITR or replication purposes, since another 
 * machine would not be able to reconstruct the index from WAL.  Therefore, 
 * we log the completed index pages to WAL if and only if WAL archiving is 
 * active. 
 * 
 * This code isn't concerned about the FSM at all. The caller is responsible 
 * for initializing that. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/nbtree/nbtsort.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/nbtree.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/sortsupport.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tuplesort.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Status record for spooling/sorting phase.  (Note we may have two of 
 * these due to the special requirements for uniqueness-checking with 
 * dead tuples.) 
 */ 
</span><a name="LN84"></a><span class='Control'>struct</span> <span class='Declare_Struct'>BTSpool</span> 
<span class='Delimiter'>{ 
</span><a name="LN86"></a>    <a href="../../utils/sort/tuplesort.c.html#LN270"><span class='Ref_to_Struct'>Tuplesortstate</span></a> <span class='Operator'>*</span><span class='Declare_Member'>sortstate</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* state data for tuplesort.c */ 
</span><a name="LN87"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>heap</span><span class='Delimiter'>; 
</span><a name="LN88"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>index</span><span class='Delimiter'>; 
</span><a name="LN89"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>isunique</span><span class='Delimiter'>; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Status record for a btree page being built.  We have one of these 
 * for each active tree level. 
 * 
 * The reason we need to store a copy of the minimum key is that we'll 
 * need to propagate it to the parent node when this page is linked 
 * into its parent.  However, if the page is not a leaf page, the first 
 * entry on the page doesn't need to contain a key, so we will not have 
 * stored the key itself on the page.  (You might think we could skip 
 * copying the minimum key on leaf pages, but actually we must have a 
 * writable copy anyway because we'll poke the page's address into it 
 * before passing it up to the parent...) 
 */ 
</span><a name="LN105"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>BTPageState</span> 
<span class='Delimiter'>{ 
</span><a name="LN107"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Member'>btps_page</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* workspace for page building */ 
</span><a name="LN108"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>btps_blkno</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* block # to write this page at */ 
</span><a name="LN109"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Member'>btps_minkey</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* copy of minimum key (first item) on page */ 
</span><a name="LN110"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Member'>btps_lastoff</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* last item offset loaded */ 
</span><a name="LN111"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>btps_level</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* tree level (0 = leaf) */ 
</span><a name="LN112"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>btps_full</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* "full" if less than this much free space */ 
</span><a name="LN113"></a>    <span class='Control'>struct</span> <a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>btps_next</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* link to parent level, if any */ 
</span><a name="LN114"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>BTPageState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Overall status record for index writing phase. 
 */ 
</span><a name="LN119"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>BTWriteState</span> 
<span class='Delimiter'>{ 
</span><a name="LN121"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>heap</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>index</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>btws_use_wal</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* dump pages to WAL? */ 
</span><a name="LN124"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>btws_pages_alloced</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* # pages allocated */ 
</span><a name="LN125"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>btws_pages_written</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* # pages written out */ 
</span><a name="LN126"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Member'>btws_zeropage</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* workspace for filling zeroes */ 
</span><a name="LN127"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>BTWriteState</span><span class='Delimiter'>; 
</span> 
 
<a name="LN130"></a><span class='Keyword'>static </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Prototype'>_bt_blnewpage</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>level</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN131"></a><span class='Keyword'>static </span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>_bt_pagestate</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>level</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN132"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_slideleft</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN133"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_sortaddtup</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsize</span><span class='Delimiter'>, 
</span><a name="LN134"></a>               <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>itup_off</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN135"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_buildadd</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN136"></a>             <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN137"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_uppershutdown</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN138"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_bt_load</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, 
</span><a name="LN139"></a>         <a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Interface routines 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * create and initialize a spool structure 
 */ 
</span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>* 
</span><a name="LN151"></a><span class='Declare_Function'>_bt_spoolinit</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heap</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isunique</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdead</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN153"></a>    <a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>btspool</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN154"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>btKbytes</span><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN153"><span class='Ref_To_Local'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN87"><span class='Ref_to_Member'>heap</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN153"><span class='Ref_To_Local'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN88"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN153"><span class='Ref_To_Local'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN89"><span class='Ref_to_Member'>isunique</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>isunique</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We size the sort area as maintenance_work_mem rather than work_mem to 
     * speed index creation.  This should be OK since a single backend can't 
     * run multiple index creations in parallel.  Note that creation of a 
     * unique index actually requires two BTSpool objects.  We expect that the 
     * second one (for dead tuples) won't get very full, so we give it only 
     * work_mem. 
     */ 
</span>    <a href="nbtsort.c.html#LN154"><span class='Ref_To_Local'>btKbytes</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>isdead</span></a> <span class='Operator'>? </span><a href="../../utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a> <span class='Operator'>: </span><a href="../../utils/init/globals.c.html#LN113"><span class='Ref_to_Global_Var'>maintenance_work_mem</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN153"><span class='Ref_To_Local'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN68"><span class='Ref_to_Proto'>tuplesort_begin_index_btree</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>heap</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN151"><span class='Ref_to_Parameter'>isunique</span></a><span class='Delimiter'>, 
</span>                                                     <a href="nbtsort.c.html#LN154"><span class='Ref_To_Local'>btKbytes</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtsort.c.html#LN153"><span class='Ref_To_Local'>btspool</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_spoolinit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * clean up a spool structure and its substructures. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN179"></a><span class='Declare_Function'>_bt_spooldestroy</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN106"><span class='Ref_to_Proto'>tuplesort_end</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN179"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN179"><span class='Ref_to_Parameter'>btspool</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * spool an index entry into the sort file. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN189"></a><span class='Declare_Function'>_bt_spool</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>self</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN88"><span class='Ref_to_Proto'>tuplesort_putindextuplevalues</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN189"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN189"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN88"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, 
</span>                                  <a href="nbtsort.c.html#LN189"><span class='Ref_to_Parameter'>self</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN189"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN189"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * given a spool loaded by successive calls to _bt_spool, 
 * create an entire btree. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN200"></a><span class='Declare_Function'>_bt_leafbuild</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN202"></a>    <a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Declare_Local'>wstate</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> BTREE_BUILD_STATS 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/guc.c.html#LN442"><span class='Ref_to_Global_Var'>log_btree_build_stats</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/tcop/tcopprot.h.html#LN83"><span class='Ref_to_Proto'>ShowUsage</span></a><span class='Parentheses'>(</span><span class='String'>"BTREE BUILD (Spool) STATISTICS"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/tcop/tcopprot.h.html#LN82"><span class='Ref_to_Proto'>ResetUsage</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* BTREE_BUILD_STATS */ 
</span> 
    <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool2</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool2</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN121"><span class='Ref_to_Member'>heap</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN87"><span class='Ref_to_Member'>heap</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN88"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to log index creation in WAL iff WAL archiving/streaming is 
     * enabled UNLESS the index isn't WAL-logged anyway. 
     */ 
</span>    <a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN123"><span class='Ref_to_Member'>btws_use_wal</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlog.h.html#LN144"><span class='Ref_to_Macro'>XLogIsNeeded</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* reserve the metapage */ 
</span>    <a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN124"><span class='Ref_to_Member'>btws_pages_alloced</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN125"><span class='Ref_to_Member'>btws_pages_written</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Operator'>.</span><a href="nbtsort.c.html#LN126"><span class='Ref_to_Member'>btws_zeropage</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* until needed */ 
</span> 
    <a href="nbtsort.c.html#LN138"><span class='Ref_to_Proto'>_bt_load</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtsort.c.html#LN202"><span class='Ref_To_Local'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN200"><span class='Ref_to_Parameter'>btspool2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_leafbuild &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Internal routines. 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * allocate workspace for a new, clean btree page, not linked to any siblings. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> 
<a name="LN243"></a><span class='Declare_Function'>_bt_blnewpage</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN245"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN246"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN245"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Zero the page and set up standard page header info */ 
</span>    <a href="../../../include/access/nbtree.h.html#LN486"><span class='Ref_to_Proto'>_bt_pageinit</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN245"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize BT opaque state */ 
</span>    <a href="nbtsort.c.html#LN246"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN245"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN246"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN246"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN246"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN61"><span class='Ref_to_Member'>btpo</span></a><span class='Operator'>.</span>level <span class='Operator'>= </span><a href="nbtsort.c.html#LN243"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN246"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN243"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><a href="../../../include/access/nbtree.h.html#LN69"><span class='Ref_to_Const'>BTP_LEAF</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN246"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN63"><span class='Ref_to_Member'>btpo_cycleid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make the P_HIKEY line pointer appear allocated */ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN245"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtsort.c.html#LN245"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_blnewpage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * emit a completed btree page, and release the working storage. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN270"></a><span class='Declare_Function'>_bt_blwritepage</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Ensure rd_smgr is open (could have been closed by relcache flush!) */ 
</span>    <a href="../../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN123"><span class='Ref_to_Member'>btws_use_wal</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We use the heap NEWPAGE record type for this */ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN54"><span class='Ref_to_Proto'>log_newpage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we have to write pages nonsequentially, fill in the space with 
     * zeroes until we come back and overwrite.  This is not logically 
     * necessary on standard Unix filesystems (unwritten space will read as 
     * zeroes anyway), but it should help to avoid fragmentation. The dummy 
     * pages aren't WAL-logged though. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>&GT; </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN125"><span class='Ref_to_Member'>btws_pages_written</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN126"><span class='Ref_to_Member'>btws_zeropage</span></a><span class='Parentheses'>) 
</span>            <a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN126"><span class='Ref_to_Member'>btws_zeropage</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* don't set checksum for all-zero page */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN94"><span class='Ref_to_Proto'>smgrextend</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, 
</span>                   <a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN125"><span class='Ref_to_Member'>btws_pages_written</span></a><span class='Operator'>++</span><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN126"><span class='Ref_to_Member'>btws_zeropage</span></a><span class='Delimiter'>, 
</span>                   <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/bufpage.h.html#LN436"><span class='Ref_to_Proto'>PageSetChecksumInplace</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now write the page.  There's no need for smgr to schedule an fsync for 
     * this write; we'll do it ourselves before ending the build. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>== </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN125"><span class='Ref_to_Member'>btws_pages_written</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* extending the file... */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN94"><span class='Ref_to_Proto'>smgrextend</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN125"><span class='Ref_to_Member'>btws_pages_written</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* overwriting a block we zero-filled before */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN100"><span class='Ref_to_Proto'>smgrwrite</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN270"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_blwritepage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * allocate and initialize a new BTPageState.  the returned structure 
 * is suitable for immediate use by _bt_buildadd. 
 */ 
</span><span class='Keyword'>static </span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>* 
</span><a name="LN328"></a><span class='Declare_Function'>_bt_pagestate</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN330"></a>    <a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create initial page for level */ 
</span>    <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN130"><span class='Ref_to_Proto'>_bt_blnewpage</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN328"><span class='Ref_to_Parameter'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and assign it a page position */ 
</span>    <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN108"><span class='Ref_to_Member'>btps_blkno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN328"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN124"><span class='Ref_to_Member'>btws_pages_alloced</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* initialize lastoff so first item goes into P_FIRSTKEY */ 
</span>    <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN110"><span class='Ref_to_Member'>btps_lastoff</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN111"><span class='Ref_to_Member'>btps_level</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN328"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* set "full" threshold based on level.  See notes at head of file. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN328"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN112"><span class='Ref_to_Member'>btps_full</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>* </span><span class='Parentheses'>(</span><span class='Number'>100</span> <span class='Operator'>- </span><a href="../../../include/access/nbtree.h.html#LN132"><span class='Ref_to_Const'>BTREE_NONLEAF_FILLFACTOR</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>100</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN112"><span class='Ref_to_Member'>btps_full</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN307"><span class='Ref_to_Macro'>RelationGetTargetPageFreeSpace</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN328"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, 
</span>                                                   <a href="../../../include/access/nbtree.h.html#LN131"><span class='Ref_to_Const'>BTREE_DEFAULT_FILLFACTOR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* no parent level, yet */ 
</span>    <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nbtsort.c.html#LN330"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_pagestate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * slide an array of ItemIds back one slot (from P_FIRSTKEY to 
 * P_HIKEY, overwriting P_HIKEY).  we need to do this when we discover 
 * that we have built an ItemId array in what has turned out to be a 
 * P_RIGHTMOST page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN361"></a><span class='Declare_Function'>_bt_slideleft</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN363"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN364"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN365"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>previi</span><span class='Delimiter'>; 
</span><a name="LN366"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>thisii</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN361"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtsort.c.html#LN364"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN361"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN365"><span class='Ref_To_Local'>previi</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN361"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN363"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN363"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT;= </span><a href="nbtsort.c.html#LN364"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN363"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN363"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="nbtsort.c.html#LN366"><span class='Ref_To_Local'>thisii</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN361"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN363"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="nbtsort.c.html#LN365"><span class='Ref_To_Local'>previi</span></a> <span class='Operator'>= *</span><a href="nbtsort.c.html#LN366"><span class='Ref_To_Local'>thisii</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN365"><span class='Ref_To_Local'>previi</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN366"><span class='Ref_To_Local'>thisii</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN361"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>-= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end _bt_slideleft &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add an item to a page being built. 
 * 
 * The main difference between this routine and a bare PageAddItem call 
 * is that this code knows that the leftmost data item on a non-leaf 
 * btree page doesn't need to have a key.  Therefore, it strips such 
 * items down to just the item header. 
 * 
 * This is almost like nbtinsert.c's _bt_pgaddtup(), but we can't use 
 * that because it assumes that P_RIGHTMOST() will return the correct 
 * answer for the page.  Here, we don't know yet if the page will be 
 * rightmost.  Offset P_FIRSTKEY is always the first data key. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN396"></a><span class='Declare_Function'>_bt_sortaddtup</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN397"></a>               <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>itemsize</span><span class='Delimiter'>, 
</span><a name="LN398"></a>               <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Delimiter'>, 
</span><a name="LN399"></a>               <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>itup_off</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN401"></a>    <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN396"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN402"></a>    <a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a> <span class='Declare_Local'>trunctuple</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/nbtree.h.html#LN175"><span class='Ref_to_Macro'>P_ISLEAF</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN401"><span class='Ref_To_Local'>opaque</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="nbtsort.c.html#LN399"><span class='Ref_to_Parameter'>itup_off</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="nbtsort.c.html#LN402"><span class='Ref_To_Local'>trunctuple</span></a> <span class='Operator'>= *</span><a href="nbtsort.c.html#LN398"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN402"><span class='Ref_To_Local'>trunctuple</span></a><span class='Operator'>.</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN398"><span class='Ref_to_Parameter'>itup</span></a> <span class='Operator'>= &</span><a href="nbtsort.c.html#LN402"><span class='Ref_To_Local'>trunctuple</span></a><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN397"><span class='Ref_to_Parameter'>itemsize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN34"><span class='Ref_to_Struct'>IndexTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN396"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN398"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN397"><span class='Ref_to_Parameter'>itemsize</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN399"><span class='Ref_to_Parameter'>itup_off</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item to the index page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_sortaddtup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/*---------- 
 * Add an item to a disk page from the sort output. 
 * 
 * We must be careful to observe the page layout conventions of nbtsearch.c: 
 * - rightmost pages start data items at P_HIKEY instead of at P_FIRSTKEY. 
 * - on non-leaf pages, the key portion of the first item need not be 
 *   stored, we should store only the link. 
 * 
 * A leaf page being built looks like: 
 * 
 * +----------------+---------------------------------+ 
 * | PageHeaderData | linp0 linp1 linp2 ...           | 
 * +-----------+----+---------------------------------+ 
 * | ... linpN |                                      | 
 * +-----------+--------------------------------------+ 
 * |     ^ last                                       | 
 * |                                                  | 
 * +-------------+------------------------------------+ 
 * |             | itemN ...                          | 
 * +-------------+------------------+-----------------+ 
 * |          ... item3 item2 item1 | "special space" | 
 * +--------------------------------+-----------------+ 
 * 
 * Contrast this with the diagram in bufpage.h; note the mismatch 
 * between linps and items.  This is because we reserve linp0 as a 
 * placeholder for the pointer to the "high key" item; when we have 
 * filled up the page, we will set linp0 to point to itemN and clear 
 * linpN.  On the other hand, if we find this is the last (rightmost) 
 * page, we leave the items alone and slide the linp array over. 
 * 
 * 'last' pointer indicates the last offset added to the page. 
 *---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN451"></a><span class='Declare_Function'>_bt_buildadd</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a> <span class='Declare_Parameter'>itup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN453"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>npage</span><span class='Delimiter'>; 
</span><a name="LN454"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblkno</span><span class='Delimiter'>; 
</span><a name="LN455"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>last_off</span><span class='Delimiter'>; 
</span><a name="LN456"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pgspc</span><span class='Delimiter'>; 
</span><a name="LN457"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>itupsz</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is a handy place to check for cancel interrupts during the btree 
     * load phase of index creation. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN454"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN108"><span class='Ref_to_Member'>btps_blkno</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN110"><span class='Ref_to_Member'>btps_lastoff</span></a><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN456"><span class='Ref_To_Local'>pgspc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN70"><span class='Ref_to_Macro'>IndexTupleDSize</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check whether the item can fit on a btree page at all. (Eventually, we 
     * ought to try to apply TOAST methods if not.) We actually need to be 
     * able to fit three items on every page, so restrict any one item to 1/3 
     * the per-page available space. Note that at this point, itupsz doesn't 
     * include the ItemId. 
     * 
     * NOTE: similar code appears in _bt_insertonpg() to defend against 
     * oversize items being inserted into an already-existing index. But 
     * during creation of an index, we don't go through there. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/nbtree.h.html#LN118"><span class='Ref_to_Macro'>BTMaxItemSize</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                   <a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN118"><span class='Ref_to_Macro'>BTMaxItemSize</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Values larger than 1/3 of a buffer page cannot be indexed.\n"</span> 
                <span class='String'>"Consider a function index of an MD5 hash of the value, "</span> 
                <span class='String'>"or use full text indexing."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN121"><span class='Ref_to_Member'>heap</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to see if page is "full".  It's definitely full if the item won't 
     * fit.  Otherwise, compare to the target freespace derived from the 
     * fillfactor.  However, we must put at least two items on each page, so 
     * disregard fillfactor if we don't have that many. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN456"><span class='Ref_To_Local'>pgspc</span></a> <span class='Operator'>&LT; </span><a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN456"><span class='Ref_To_Local'>pgspc</span></a> <span class='Operator'>&LT; </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN112"><span class='Ref_to_Member'>btps_full</span></a> <span class='Operator'>&& </span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Finish off the page and write it out. 
         */ 
</span><a name="LN507"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>opage</span> <span class='Operator'>= </span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>; 
</span><a name="LN508"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>oblkno</span> <span class='Operator'>= </span><a href="nbtsort.c.html#LN454"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>; 
</span><a name="LN509"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>ii</span><span class='Delimiter'>; 
</span><a name="LN510"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>hii</span><span class='Delimiter'>; 
</span><a name="LN511"></a>        <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>oitup</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create new page of same level */ 
</span>        <a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN130"><span class='Ref_to_Proto'>_bt_blnewpage</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN111"><span class='Ref_to_Member'>btps_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* and assign it a page position */ 
</span>        <a href="nbtsort.c.html#LN454"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN124"><span class='Ref_to_Member'>btws_pages_alloced</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We copy the last item on the page into the new page, and then 
         * rearrange the old page so that the 'last item' becomes its high key 
         * rather than a true data item.  There had better be at least two 
         * items on the page already, else the page would be empty of useful 
         * data. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN509"><span class='Ref_To_Local'>ii</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN507"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN511"><span class='Ref_To_Local'>oitup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN507"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN509"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN133"><span class='Ref_to_Proto'>_bt_sortaddtup</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN509"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN511"><span class='Ref_To_Local'>oitup</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Move 'last' into the high key position on opage 
         */ 
</span>        <a href="nbtsort.c.html#LN510"><span class='Ref_To_Local'>hii</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN507"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="nbtsort.c.html#LN510"><span class='Ref_To_Local'>hii</span></a> <span class='Operator'>= *</span><a href="nbtsort.c.html#LN509"><span class='Ref_To_Local'>ii</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemid.h.html#LN126"><span class='Ref_to_Macro'>ItemIdSetUnused</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN509"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* redundant */ 
</span>        <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="nbtsort.c.html#LN507"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower <span class='Operator'>-= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Link the old page into its parent, using its minimum key. If we 
         * don't have a parent, we have to create one; this adds a new btree 
         * level. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN131"><span class='Ref_to_Proto'>_bt_pagestate</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN111"><span class='Ref_to_Member'>btps_level</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN508"><span class='Ref_To_Local'>oblkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN135"><span class='Ref_to_Proto'>_bt_buildadd</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Save a copy of the minimum key for the new page.  We have to copy 
         * it off the old page, not the new one, in case we are not at leaf 
         * level. 
         */ 
</span>        <a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN511"><span class='Ref_To_Local'>oitup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Set the sibling links for both pages. 
         */ 
</span>        <span class='Delimiter'>{ 
</span><a name="LN563"></a>            <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>oopaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN507"><span class='Ref_To_Local'>opage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN564"></a>            <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>nopaque</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtsort.c.html#LN563"><span class='Ref_To_Local'>oopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN454"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN564"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN55"><span class='Ref_to_Member'>btpo_prev</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN508"><span class='Ref_To_Local'>oblkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN564"><span class='Ref_To_Local'>nopaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN56"><span class='Ref_to_Member'>btpo_next</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* redundant */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Write out the old page.  We never need to touch it again, so we can 
         * free the opage workspace too. 
         */ 
</span>        <a href="nbtsort.c.html#LN269"><span class='Ref_to_Func'>_bt_blwritepage</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN507"><span class='Ref_To_Local'>opage</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN508"><span class='Ref_To_Local'>oblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Reset last_off to point to new page 
         */ 
</span>        <a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN203"><span class='Ref_to_Const'>P_FIRSTKEY</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pgspc&LT;itupsz||(pgspc&LT;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If the new item is the first for its page, stash a copy for later. Note 
     * this will only happen for the first item on a level; on later pages, 
     * the first item for a page is copied from the prior page in the code 
     * above. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a> <span class='Operator'>== </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN148"><span class='Ref_to_Proto'>CopyIndexTuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add the new item into the current page. 
     */ 
</span>    <a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN133"><span class='Ref_to_Proto'>_bt_sortaddtup</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN457"><span class='Ref_To_Local'>itupsz</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>itup</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN453"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN108"><span class='Ref_to_Member'>btps_blkno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN454"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN451"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN110"><span class='Ref_to_Member'>btps_lastoff</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN455"><span class='Ref_To_Local'>last_off</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_buildadd &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Finish writing out the completed btree. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN610"></a><span class='Declare_Function'>_bt_uppershutdown</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN612"></a>    <a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN613"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>rootblkno</span> <span class='Operator'>= </span><a href="../../../include/access/nbtree.h.html#LN167"><span class='Ref_to_Const'>P_NONE</span></a><span class='Delimiter'>; 
</span><a name="LN614"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>rootlevel</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN615"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>metapage</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Each iteration of this loop completes one more level of the tree. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN610"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN622"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN623"></a>        <a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
        <a href="nbtsort.c.html#LN622"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN108"><span class='Ref_to_Member'>btps_blkno</span></a><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN623"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/nbtree.h.html#LN66"><span class='Ref_to_Typedef'>BTPageOpaque</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have to link the last page on this level to somewhere. 
         * 
         * If we're at the top, it's the root, so attach it to the metapage. 
         * Otherwise, add an entry for it to its parent using its minimum key. 
         * This may cause the last page of the parent level to split, but 
         * that's not a problem -- we haven't gotten to it yet. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtsort.c.html#LN623"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/nbtree.h.html#LN62"><span class='Ref_to_Member'>btpo_flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/nbtree.h.html#LN70"><span class='Ref_to_Const'>BTP_ROOT</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN613"><span class='Ref_To_Local'>rootblkno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN622"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN614"><span class='Ref_To_Local'>rootlevel</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN111"><span class='Ref_to_Member'>btps_level</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN622"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN202"><span class='Ref_to_Const'>P_HIKEY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN135"><span class='Ref_to_Proto'>_bt_buildadd</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN610"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN113"><span class='Ref_to_Member'>btps_next</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN109"><span class='Ref_to_Member'>btps_minkey</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This is the rightmost page, so the ItemId array needs to be slid 
         * back one slot.  Then we can dump out the page. 
         */ 
</span>        <a href="nbtsort.c.html#LN132"><span class='Ref_to_Proto'>_bt_slideleft</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN269"><span class='Ref_to_Func'>_bt_blwritepage</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN610"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN108"><span class='Ref_to_Member'>btps_blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN612"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN107"><span class='Ref_to_Member'>btps_page</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* writepage freed the workspace */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for s=state;s!=NULL;s=s-&GT;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * As the last step in the process, construct the metapage and make it 
     * point to the new root (unless we had no data at all, in which case it's 
     * set to point to "P_NONE").  This changes the index to the "valid" state 
     * by filling in a valid magic number in the metapage. 
     */ 
</span>    <a href="nbtsort.c.html#LN615"><span class='Ref_To_Local'>metapage</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtpage.c.html#LN47"><span class='Ref_to_Func'>_bt_initmetapage</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN615"><span class='Ref_To_Local'>metapage</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN613"><span class='Ref_To_Local'>rootblkno</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN614"><span class='Ref_To_Local'>rootlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nbtsort.c.html#LN269"><span class='Ref_to_Func'>_bt_blwritepage</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN610"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN615"><span class='Ref_To_Local'>metapage</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN108"><span class='Ref_to_Const'>BTREE_METAPAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _bt_uppershutdown &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read tuples in correct sort order from tuplesort, and load them into 
 * btree leaves. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN676"></a><span class='Declare_Function'>_bt_load</span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN119"><span class='Ref_to_Struct'>BTWriteState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wstate</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool</span><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN84"><span class='Ref_to_Struct'>BTSpool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btspool2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN678"></a>    <a href="nbtsort.c.html#LN105"><span class='Ref_to_Struct'>BTPageState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN679"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>merge</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>btspool2</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN680"></a>    <a href="../../../include/access/itup.h.html#LN52"><span class='Ref_to_Typedef'>IndexTuple</span></a>  <span class='Declare_Local'>itup</span><span class='Delimiter'>, 
</span><a name="LN681"></a>                <span class='Declare_Local'>itup2</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN682"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>load1</span><span class='Delimiter'>; 
</span><a name="LN683"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdes</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN684"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN685"></a>                <span class='Declare_Local'>keysz</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN422"><span class='Ref_to_Macro'>RelationGetNumberOfAttributes</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN686"></a>    <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a>     <span class='Declare_Local'>indexScanKey</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN687"></a>    <a href="../../../include/utils/sortsupport.h.html#LN57"><span class='Ref_to_Typedef'>SortSupport</span></a> <span class='Declare_Local'>sortKeys</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN679"><span class='Ref_To_Local'>merge</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Another BTSpool for dead tuples exists. Now we have to merge 
         * btspool and btspool2. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* the preparation of merge */ 
</span>        <a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN99"><span class='Ref_to_Proto'>tuplesort_getindextuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN681"><span class='Ref_To_Local'>itup2</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN99"><span class='Ref_to_Proto'>tuplesort_getindextuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>btspool2</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nbtsort.c.html#LN686"><span class='Ref_To_Local'>indexScanKey</span></a> <span class='Operator'>= </span><a href="nbtutils.c.html#LN113"><span class='Ref_to_Func'>_bt_mkscankey_nodata</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prepare SortSupport data for each column */ 
</span>        <a href="nbtsort.c.html#LN687"><span class='Ref_To_Local'>sortKeys</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/sortsupport.h.html#LN57"><span class='Ref_to_Typedef'>SortSupport</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN685"><span class='Ref_To_Local'>keysz</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/sortsupport.h.html#LN59"><span class='Ref_to_Struct'>SortSupportData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nbtsort.c.html#LN685"><span class='Ref_To_Local'>keysz</span></a><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN706"></a>            <a href="../../../include/utils/sortsupport.h.html#LN57"><span class='Ref_to_Typedef'>SortSupport</span></a> <span class='Declare_Local'>sortKey</span> <span class='Operator'>= </span><a href="nbtsort.c.html#LN687"><span class='Ref_To_Local'>sortKeys</span></a> <span class='Operator'>+ </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span><a name="LN707"></a>            <a href="../../../include/access/skey.h.html#LN74"><span class='Ref_to_Typedef'>ScanKey</span></a>     <span class='Declare_Local'>scanKey</span> <span class='Operator'>= </span><a href="nbtsort.c.html#LN686"><span class='Ref_To_Local'>indexScanKey</span></a> <span class='Operator'>+ </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span><a name="LN708"></a>            <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>strategy</span><span class='Delimiter'>; 
</span> 
            <a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sortsupport.h.html#LN65"><span class='Ref_to_Member'>ssup_cxt</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sortsupport.h.html#LN66"><span class='Ref_to_Member'>ssup_collation</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN707"><span class='Ref_To_Local'>scanKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN69"><span class='Ref_to_Member'>sk_collation</span></a><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sortsupport.h.html#LN74"><span class='Ref_to_Member'>ssup_nulls_first</span></a> <span class='Operator'>= 
</span>                <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN707"><span class='Ref_To_Local'>scanKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN65"><span class='Ref_to_Member'>sk_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/nbtree.h.html#LN427"><span class='Ref_to_Const'>SK_BT_NULLS_FIRST</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sortsupport.h.html#LN80"><span class='Ref_to_Member'>ssup_attno</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN707"><span class='Ref_To_Local'>scanKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN66"><span class='Ref_to_Member'>sk_attno</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Abbreviation is not supported here */ 
</span>            <a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sortsupport.h.html#LN155"><span class='Ref_to_Member'>abbreviate</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sortsupport.h.html#LN80"><span class='Ref_to_Member'>ssup_attno</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtsort.c.html#LN708"><span class='Ref_To_Local'>strategy</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN707"><span class='Ref_To_Local'>scanKey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/skey.h.html#LN65"><span class='Ref_to_Member'>sk_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/nbtree.h.html#LN426"><span class='Ref_to_Const'>SK_BT_DESC</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>? 
</span>                <a href="../../../include/access/stratnum.h.html#LN32"><span class='Ref_to_Const'>BTGreaterStrategyNumber</span></a> <span class='Operator'>: </span><a href="../../../include/access/stratnum.h.html#LN28"><span class='Ref_to_Const'>BTLessStrategyNumber</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../utils/sort/sortsupport.c.html#LN158"><span class='Ref_to_Func'>PrepareSortSupportFromIndexRel</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN708"><span class='Ref_To_Local'>strategy</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN706"><span class='Ref_To_Local'>sortKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;keysz;i++ &raquo; </span> 
 
        <a href="nbtutils.c.html#LN153"><span class='Ref_to_Func'>_bt_freeskey</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN686"><span class='Ref_To_Local'>indexScanKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nbtsort.c.html#LN682"><span class='Ref_To_Local'>load1</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* load BTSpool next ? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN681"><span class='Ref_To_Local'>itup2</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="nbtsort.c.html#LN685"><span class='Ref_To_Local'>keysz</span></a><span class='Delimiter'>; </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN740"></a>                    <a href="../../../include/utils/sortsupport.h.html#LN57"><span class='Ref_to_Typedef'>SortSupport</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN741"></a>                    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>attrDatum1</span><span class='Delimiter'>, 
</span><a name="LN742"></a>                                <span class='Declare_Local'>attrDatum2</span><span class='Delimiter'>; 
</span><a name="LN743"></a>                    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull1</span><span class='Delimiter'>, 
</span><a name="LN744"></a>                                <span class='Declare_Local'>isNull2</span><span class='Delimiter'>; 
</span><a name="LN745"></a>                    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>compare</span><span class='Delimiter'>; 
</span> 
                    <a href="nbtsort.c.html#LN740"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN687"><span class='Ref_To_Local'>sortKeys</span></a> <span class='Operator'>+ </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                    <a href="nbtsort.c.html#LN741"><span class='Ref_To_Local'>attrDatum1</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN683"><span class='Ref_To_Local'>tupdes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtsort.c.html#LN743"><span class='Ref_To_Local'>isNull1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="nbtsort.c.html#LN742"><span class='Ref_To_Local'>attrDatum2</span></a> <span class='Operator'>= </span><a href="../../../include/access/itup.h.html#LN99"><span class='Ref_to_Macro'>index_getattr</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN681"><span class='Ref_To_Local'>itup2</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN683"><span class='Ref_To_Local'>tupdes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nbtsort.c.html#LN744"><span class='Ref_To_Local'>isNull2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="nbtsort.c.html#LN745"><span class='Ref_To_Local'>compare</span></a> <span class='Operator'>= </span><a href="../../../include/utils/sortsupport.h.html#LN199"><span class='Ref_to_Func'>ApplySortComparator</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN741"><span class='Ref_To_Local'>attrDatum1</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN743"><span class='Ref_To_Local'>isNull1</span></a><span class='Delimiter'>, 
</span>                                                  <a href="nbtsort.c.html#LN742"><span class='Ref_To_Local'>attrDatum2</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN744"><span class='Ref_To_Local'>isNull2</span></a><span class='Delimiter'>, 
</span>                                                  <a href="nbtsort.c.html#LN740"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN745"><span class='Ref_To_Local'>compare</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="nbtsort.c.html#LN682"><span class='Ref_To_Local'>load1</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN745"><span class='Ref_To_Local'>compare</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;=keysz;i++ &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if itup!=NULL &raquo; </span> 
            <span class='Control'>else</span> 
                <a href="nbtsort.c.html#LN682"><span class='Ref_To_Local'>load1</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* When we see first tuple, create first index page */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN131"><span class='Ref_to_Proto'>_bt_pagestate</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN682"><span class='Ref_To_Local'>load1</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="nbtsort.c.html#LN135"><span class='Ref_to_Proto'>_bt_buildadd</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN99"><span class='Ref_to_Proto'>tuplesort_getindextuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nbtsort.c.html#LN135"><span class='Ref_to_Proto'>_bt_buildadd</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN681"><span class='Ref_To_Local'>itup2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nbtsort.c.html#LN681"><span class='Ref_To_Local'>itup2</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN99"><span class='Ref_to_Proto'>tuplesort_getindextuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>btspool2</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN687"><span class='Ref_To_Local'>sortKeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if merge &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* merge is unnecessary */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN99"><span class='Ref_to_Proto'>tuplesort_getindextuple</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>btspool</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN86"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, 
</span>                                               <span class='Boolean'>true</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* When we see first tuple, create first index page */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="nbtsort.c.html#LN131"><span class='Ref_to_Proto'>_bt_pagestate</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nbtsort.c.html#LN135"><span class='Ref_to_Proto'>_bt_buildadd</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN680"><span class='Ref_To_Local'>itup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Close down final pages and write the metapage */ 
</span>    <a href="nbtsort.c.html#LN137"><span class='Ref_to_Proto'>_bt_uppershutdown</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Delimiter'>, </span><a href="nbtsort.c.html#LN678"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the index is WAL-logged, we must fsync it down to disk before it's 
     * safe to commit the transaction.  (For a non-WAL-logged index we don't 
     * care since the index will be uninteresting after a crash anyway.) 
     * 
     * It's obvious that we must do this when not WAL-logging the build. It's 
     * less obvious that we have to do it even if we did WAL-log the index 
     * pages.  The reason is that since we're building outside shared buffers, 
     * a CHECKPOINT occurring during the build has no way to flush the 
     * previously written data to disk (indeed it won't know the index even 
     * exists).  A crash later on would replay WAL from the checkpoint, 
     * therefore it wouldn't replay our earlier WAL entries. If we do not 
     * fsync those pages here, they might still not be on disk when the crash 
     * occurs. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN107"><span class='Ref_to_Proto'>smgrimmedsync</span></a><span class='Parentheses'>(</span><a href="nbtsort.c.html#LN676"><span class='Ref_to_Parameter'>wstate</span></a><span class='Operator'>-&GT;</span><a href="nbtsort.c.html#LN122"><span class='Ref_to_Member'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end _bt_load &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>