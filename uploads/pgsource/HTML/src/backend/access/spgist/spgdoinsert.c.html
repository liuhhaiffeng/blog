<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\spgist\spgdoinsert.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\spgist\spgdoinsert.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:30 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * spgdoinsert.c 
 *    implementation of insert algorithm 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/spgist/spgdoinsert.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/spgist_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/spgxlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * SPPageDesc tracks all info about a page we are inserting into.  In some 
 * situations it actually identifies a tuple, or even a specific node within 
 * an inner tuple.  But any of the fields can be invalid.  If the buffer 
 * field is valid, it implies we hold pin and exclusive lock on that buffer. 
 * page pointer should be valid exactly when buffer is. 
 */ 
</span><a name="LN33"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>SPPageDesc</span> 
<span class='Delimiter'>{ 
</span><a name="LN35"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>blkno</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* block number, or InvalidBlockNumber */ 
</span><a name="LN36"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Member'>buffer</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* page's buffer number, or InvalidBuffer */ 
</span><a name="LN37"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Member'>page</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* pointer to page buffer, or NULL */ 
</span><a name="LN38"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Member'>offnum</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* offset of tuple, or InvalidOffsetNumber */ 
</span><a name="LN39"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>node</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* node number within inner tuple, or -1 */ 
</span><a name="LN40"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>SPPageDesc</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Set the item pointer in the nodeN'th entry in inner tuple tup.  This 
 * is used to update the parent inner tuple's downlink after a move or 
 * split operation. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN49"></a><span class='Declare_Function'>spgUpdateNodeLink</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nodeN</span><span class='Delimiter'>, 
</span><a name="LN50"></a>                  <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN52"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN53"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN49"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN52"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN53"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN52"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN49"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN53"><span class='Ref_To_Local'>node</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN50"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN50"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to find requested node %d in SPGiST inner tuple"</span><span class='Delimiter'>, 
</span>         <a href="spgdoinsert.c.html#LN49"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Form a new inner tuple containing one more node than the given one, with 
 * the specified label datum, inserted at offset "offset" in the node array. 
 * The new tuple's prefix is the same as the old one's. 
 * 
 * Note that the new node initially has an invalid downlink.  We'll find a 
 * page to point it to later. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> 
<a name="LN77"></a><span class='Declare_Function'>addNode</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>label</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN79"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span><span class='Delimiter'>, 
</span><a name="LN80"></a>               <span class='Operator'>*</span><span class='Declare_Local'>nodes</span><span class='Delimiter'>; 
</span><a name="LN81"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if offset is negative, insert at end */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&GT; </span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid offset for adding node to SPGiST inner tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN80"><span class='Ref_To_Local'>nodes</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN81"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN79"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN81"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN80"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN81"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN79"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="spgdoinsert.c.html#LN80"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN81"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN79"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="spgdoinsert.c.html#LN80"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN396"><span class='Ref_to_Proto'>spgFormNodeTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>label</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/spgist_private.h.html#LN398"><span class='Ref_to_Proto'>spgFormInnerTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN214"><span class='Ref_to_Member'>prefixSize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../../include/access/spgist_private.h.html#LN230"><span class='Ref_to_Macro'>SGITDATUM</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="spgdoinsert.c.html#LN77"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                             <a href="spgdoinsert.c.html#LN80"><span class='Ref_To_Local'>nodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end addNode &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* qsort comparator for sorting OffsetNumbers */ 
</span><span class='Keyword'>static int 
</span><a name="LN109"></a><span class='Declare_Function'>cmpOffsetNumbers</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN109"><span class='Ref_to_Parameter'>a</span></a> <span class='Operator'>== *</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN109"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN109"><span class='Ref_to_Parameter'>a</span></a> <span class='Operator'>&GT; *</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN109"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: -</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Delete multiple tuples from an index page, preserving tuple offset numbers. 
 * 
 * The first tuple in the given list is replaced with a dead tuple of type 
 * "firststate" (REDIRECT/DEAD/PLACEHOLDER); the remaining tuples are replaced 
 * with dead tuples of type "reststate".  If either firststate or reststate 
 * is REDIRECT, blkno/offnum specify where to link to. 
 * 
 * NB: this is used during WAL replay, so beware of trying to make it too 
 * smart.  In particular, it shouldn't use "state" except for calling 
 * spgFormDeadTuple().  This is also used in a critical section, so no 
 * pallocs either! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN130"></a><span class='Declare_Function'>spgPageIndexMultiDelete</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN131"></a>                        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itemnos</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN132"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>firststate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>reststate</span><span class='Delimiter'>, 
</span><a name="LN133"></a>                        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN135"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>firstItem</span><span class='Delimiter'>; 
</span><a name="LN136"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>sortednos</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN137"></a>    <a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a> <span class='Declare_Local'>tuple</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN138"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For efficiency we want to use PageIndexMultiDelete, which requires the 
     * targets to be listed in sorted order, so we have to sort the itemnos 
     * array.  (This also greatly simplifies the math for reinserting the 
     * replacement tuples.)  However, we must not scribble on the caller's 
     * array, so we have to make a copy. 
     */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN136"><span class='Ref_To_Local'>sortednos</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN136"><span class='Ref_To_Local'>sortednos</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN108"><span class='Ref_to_Func'>cmpOffsetNumbers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufpage.h.html#LN431"><span class='Ref_to_Proto'>PageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN130"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN136"><span class='Ref_To_Local'>sortednos</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN135"><span class='Ref_To_Local'>firstItem</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN138"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN138"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN131"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN138"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN160"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>itemno</span> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN136"><span class='Ref_To_Local'>sortednos</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN138"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN161"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>tupstate</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN161"><span class='Ref_To_Local'>tupstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN160"><span class='Ref_To_Local'>itemno</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN135"><span class='Ref_To_Local'>firstItem</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="spgdoinsert.c.html#LN132"><span class='Ref_to_Parameter'>firststate</span></a> <span class='Operator'>: </span><a href="spgdoinsert.c.html#LN132"><span class='Ref_to_Parameter'>reststate</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN137"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="spgdoinsert.c.html#LN137"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN319"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN161"><span class='Ref_To_Local'>tupstate</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN137"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN401"><span class='Ref_to_Proto'>spgFormDeadTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN130"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN161"><span class='Ref_To_Local'>tupstate</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN133"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN133"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN130"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN137"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN137"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN320"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                        <a href="spgdoinsert.c.html#LN160"><span class='Ref_To_Local'>itemno</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN160"><span class='Ref_To_Local'>itemno</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>                 <a href="spgdoinsert.c.html#LN137"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN320"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN161"><span class='Ref_To_Local'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN197"><span class='Ref_to_Const'>SPGIST_REDIRECT</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN130"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>nRedirection<span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN161"><span class='Ref_To_Local'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN130"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>nPlaceholder<span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end spgPageIndexMultiDelete &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update the parent inner tuple's downlink, and mark the parent buffer 
 * dirty (this must be the last change to the parent page in the current 
 * WAL action). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN185"></a><span class='Declare_Function'>saveNodeLink</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, 
</span><a name="LN186"></a>             <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN188"></a>    <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Local'>innerTuple</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN188"><span class='Ref_To_Local'>innerTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN185"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN185"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN185"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN48"><span class='Ref_to_Func'>spgUpdateNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN188"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN185"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN186"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN186"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN185"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add a leaf tuple to a leaf page where there is known to be room for it 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN202"></a><span class='Declare_Function'>addLeafTuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Parameter'>leafTuple</span><span class='Delimiter'>, 
</span><a name="LN203"></a>           <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNulls</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNew</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN205"></a>    <a href="../../../include/access/spgxlog.h.html#LN45"><span class='Ref_to_Struct'>spgxlogAddLeaf</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN47"><span class='Ref_to_Member'>newPage</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>isNew</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN48"><span class='Ref_to_Member'>storesNulls</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>isNulls</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* these will be filled below as needed */ 
</span>    <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN49"><span class='Ref_to_Member'>offnumLeaf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN50"><span class='Ref_to_Member'>offnumHeadLeaf</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN52"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN53"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Tuple is not part of a chain */ 
</span>        <a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                           <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN49"><span class='Ref_to_Member'>offnumLeaf</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Must update parent's downlink if any */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN52"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN53"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN184"><span class='Ref_to_Func'>saveNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if current-&GT;offnum==Inva... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Tuple must be inserted into existing chain.  We mustn't change the 
         * chain's head address, but we don't need to chase the entire chain 
         * to put the tuple at the end; we can insert it second. 
         * 
         * Also, it's possible that the "chain" consists only of a DEAD tuple, 
         * in which case we should replace the DEAD tuple in-place. 
         */ 
</span><a name="LN248"></a>        <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>head</span><span class='Delimiter'>; 
</span><a name="LN249"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                              <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN196"><span class='Ref_to_Const'>SPGIST_LIVE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN249"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * re-get head of list because it could have been moved on page, 
             * and set new second element 
             */ 
</span>            <a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                              <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN249"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN49"><span class='Ref_to_Member'>offnumLeaf</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN249"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN50"><span class='Ref_to_Member'>offnumHeadLeaf</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN198"><span class='Ref_to_Const'>SPGIST_DEAD</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                            <a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>                     <a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* WAL replay distinguishes this case by equal offnums */ 
</span>            <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN49"><span class='Ref_to_Member'>offnumLeaf</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN50"><span class='Ref_to_Member'>offnumHeadLeaf</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected SPGiST tuple state: %d"</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN248"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN293"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN294"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN202"><span class='Ref_to_Parameter'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN294"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN47"><span class='Ref_to_Member'>newPage</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN294"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN294"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN52"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN293"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_SPGIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN21"><span class='Ref_to_Const'>XLOG_SPGIST_ADD_LEAF</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN293"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* update parent only if we actually changed it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN205"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN52"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN203"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN293"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(inde... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end addLeafTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Count the number and total size of leaf tuples in the chain starting at 
 * current-&GT;offnum.  Return number into *nToSplit and total size as function 
 * result. 
 * 
 * Klugy special case when considering the root page (i.e., root is a leaf 
 * page, but we're about to split for the first time): return fake large 
 * values to force spgdoinsert() to take the doPickSplit rather than 
 * moveLeafs code path.  moveLeafs is not prepared to deal with root page. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN332"></a><span class='Declare_Function'>checkSplitConditions</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN333"></a>                     <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nToSplit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN335"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN336"></a>                <span class='Declare_Local'>n</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN337"></a>                <span class='Declare_Local'>totalSize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* return impossible values to force split */ 
</span>        <span class='Operator'>*</span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>nToSplit</span></a> <span class='Operator'>= </span>BLCKSZ<span class='Delimiter'>; 
</span>        <span class='Control'>return</span> BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN349"></a>        <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& 
</span>               <a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN196"><span class='Ref_to_Const'>SPGIST_LIVE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN336"><span class='Ref_To_Local'>n</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN337"><span class='Ref_To_Local'>totalSize</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN198"><span class='Ref_to_Const'>SPGIST_DEAD</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We could see a DEAD tuple as first/only chain item */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Don't count it in result, because it won't go to other page */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected SPGiST tuple state: %d"</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN335"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN349"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while i!=InvalidOffsetNumbe... &raquo; </span> 
 
    <span class='Operator'>*</span><a href="spgdoinsert.c.html#LN333"><span class='Ref_to_Parameter'>nToSplit</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN336"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="spgdoinsert.c.html#LN337"><span class='Ref_To_Local'>totalSize</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end checkSplitConditions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * current points to a leaf-tuple chain that we wanted to add newLeafTuple to, 
 * but the chain has to be moved because there's not enough room to add 
 * newLeafTuple to its page.  We use this method when the chain contains 
 * very little data so a split would be inefficient.  We are sure we can 
 * fit the chain plus newLeafTuple on one other page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN386"></a><span class='Declare_Function'>moveLeafs</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN387"></a>          <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, 
</span><a name="LN388"></a>          <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Parameter'>newLeafTuple</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNulls</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN390"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN391"></a>                <span class='Declare_Local'>nDelete</span><span class='Delimiter'>, 
</span><a name="LN392"></a>                <span class='Declare_Local'>nInsert</span><span class='Delimiter'>, 
</span><a name="LN393"></a>                <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN394"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>nbuf</span><span class='Delimiter'>; 
</span><a name="LN395"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>npage</span><span class='Delimiter'>; 
</span><a name="LN396"></a>    <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span><a name="LN397"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>r</span> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, 
</span><a name="LN398"></a>                <span class='Declare_Local'>startOffset</span> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span><a name="LN399"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replaceDead</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN400"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>toDelete</span><span class='Delimiter'>; 
</span><a name="LN401"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>toInsert</span><span class='Delimiter'>; 
</span><a name="LN402"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblkno</span><span class='Delimiter'>; 
</span><a name="LN403"></a>    <a href="../../../include/access/spgxlog.h.html#LN63"><span class='Ref_to_Struct'>spgxlogMoveLeafs</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN404"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>leafdata</span><span class='Delimiter'>, 
</span><a name="LN405"></a>               <span class='Operator'>*</span><span class='Declare_Local'>leafptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This doesn't work on root page */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Locate the tuples to be moved, and count up the space needed */ 
</span>    <a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN400"><span class='Ref_To_Local'>toDelete</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN401"><span class='Ref_To_Local'>toInsert</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN393"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN422"></a>        <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& 
</span>               <a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN196"><span class='Ref_to_Const'>SPGIST_LIVE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN400"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN393"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN198"><span class='Ref_to_Const'>SPGIST_DEAD</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We could see a DEAD tuple as first/only chain item */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* We don't want to move it, so don't count it in size */ 
</span>            <a href="spgdoinsert.c.html#LN400"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN399"><span class='Ref_To_Local'>replaceDead</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected SPGiST tuple state: %d"</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN422"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while i!=InvalidOffsetNumbe... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Find a leaf page that will hold them */ 
</span>    <a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN357"><span class='Ref_to_Func'>SpGistGetBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN373"><span class='Ref_to_Const'>GBUF_LEAF</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>isNulls</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN375"><span class='Ref_to_Const'>GBUF_NULLS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="spgdoinsert.c.html#LN393"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN66"><span class='Ref_to_Member'>newPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN395"><span class='Ref_To_Local'>npage</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN402"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN402"><span class='Ref_To_Local'>nblkno</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN404"><span class='Ref_To_Local'>leafdata</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN405"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN393"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* copy all the old tuples to new page, unless they're dead */ 
</span>    <a href="spgdoinsert.c.html#LN392"><span class='Ref_To_Local'>nInsert</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN399"><span class='Ref_To_Local'>replaceDead</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN400"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN390"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN196"><span class='Ref_to_Const'>SPGIST_LIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Update chain link (notice the chain order gets reversed, but we 
             * don't care).  We're modifying the tuple on the source page 
             * here, but it's okay since we're about to delete it. 
             */ 
</span>            <a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN395"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN398"><span class='Ref_To_Local'>startOffset</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN401"><span class='Ref_To_Local'>toInsert</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN392"><span class='Ref_To_Local'>nInsert</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN392"><span class='Ref_To_Local'>nInsert</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* save modified tuple into leafdata as well */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN405"><span class='Ref_To_Local'>leafptr</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN405"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN396"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nDelete;i++ &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !replaceDead &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* add the new tuple as well */ 
</span>    <a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN395"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN398"><span class='Ref_To_Local'>startOffset</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN401"><span class='Ref_To_Local'>toInsert</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN392"><span class='Ref_To_Local'>nInsert</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN392"><span class='Ref_To_Local'>nInsert</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN405"><span class='Ref_To_Local'>leafptr</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN405"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now delete the old tuples, leaving a redirection pointer behind for the 
     * first one, unless we're doing an index build; in which case there can't 
     * be any concurrent scan so we need not provide a redirect. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN129"><span class='Ref_to_Func'>spgPageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN400"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Delimiter'>, 
</span>                       <a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN128"><span class='Ref_to_Member'>isBuild</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a> <span class='Operator'>: </span><a href="../../../include/access/spgist_private.h.html#LN197"><span class='Ref_to_Const'>SPGIST_REDIRECT</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Delimiter'>, 
</span>                            <a href="spgdoinsert.c.html#LN402"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update parent's downlink and mark parent page dirty */ 
</span>    <a href="spgdoinsert.c.html#LN184"><span class='Ref_to_Func'>saveNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN402"><span class='Ref_To_Local'>nblkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN397"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mark the leaf pages too */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN520"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* prepare WAL info */ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN356"><span class='Ref_to_Macro'>STORE_STATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN74"><span class='Ref_to_Member'>stateSrc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN65"><span class='Ref_to_Member'>nMoves</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN67"><span class='Ref_to_Member'>replaceDead</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN399"><span class='Ref_To_Local'>replaceDead</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN68"><span class='Ref_to_Member'>storesNulls</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN388"><span class='Ref_to_Parameter'>isNulls</span></a><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN71"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN72"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN90"><span class='Ref_to_Const'>SizeOfSpgxlogMoveLeafs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN400"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN391"><span class='Ref_To_Local'>nDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN401"><span class='Ref_To_Local'>toInsert</span></a><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN392"><span class='Ref_To_Local'>nInsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN404"><span class='Ref_To_Local'>leafdata</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN405"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>- </span><a href="spgdoinsert.c.html#LN404"><span class='Ref_To_Local'>leafdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN403"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN66"><span class='Ref_to_Member'>newPage</span></a> <span class='Operator'>? </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN520"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_SPGIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN22"><span class='Ref_to_Const'>XLOG_SPGIST_MOVE_LEAFS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN520"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN395"><span class='Ref_To_Local'>npage</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN520"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN387"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN520"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(inde... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update local free-space cache and release new buffer */ 
</span>    <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN386"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN394"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end moveLeafs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update previously-created redirection tuple with appropriate destination 
 * 
 * We use this when it's not convenient to know the destination first. 
 * The tuple should have been made with the "impossible" destination of 
 * the metapage. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN566"></a><span class='Declare_Function'>setRedirectionTuple</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>position</span><span class='Delimiter'>, 
</span><a name="LN567"></a>                    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN569"></a>    <a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a> <span class='Declare_Local'>dt</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN569"><span class='Ref_To_Local'>dt</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN566"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN566"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN566"><span class='Ref_to_Parameter'>position</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN569"><span class='Ref_To_Local'>dt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN319"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN197"><span class='Ref_to_Const'>SPGIST_REDIRECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN569"><span class='Ref_To_Local'>dt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN322"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN24"><span class='Ref_to_Const'>SPGIST_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN569"><span class='Ref_To_Local'>dt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN322"><span class='Ref_to_Member'>pointer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN567"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN567"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Test to see if the user-defined picksplit function failed to do its job, 
 * ie, it put all the leaf tuples into the same node. 
 * If so, randomly divide the tuples into several nodes (all with the same 
 * label) and return TRUE to select allTheSame mode for this inner tuple. 
 * 
 * (This code is also used to forcibly select allTheSame mode for nulls.) 
 * 
 * If we know that the leaf tuples wouldn't all fit on one page, then we 
 * exclude the last tuple (which is the incoming new tuple that forced a split) 
 * from the check to see if more than one node is used.  The reason for this 
 * is that if the existing tuples are put into only one chain, then even if 
 * we move them all to an empty page, there would still not be room for the 
 * new tuple, so we'd get into an infinite loop of picksplit attempts. 
 * Forcing allTheSame mode dodges this problem by ensuring the old tuples will 
 * be split across pages.  (Exercise for the reader: figure out why this 
 * fixes the problem even when there is only one old tuple.) 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN597"></a><span class='Declare_Function'>checkAllTheSame</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist.h.html#LN110"><span class='Ref_to_Struct'>spgPickSplitIn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>in</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist.h.html#LN117"><span class='Ref_to_Struct'>spgPickSplitOut</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>tooBig</span><span class='Delimiter'>, 
</span><a name="LN598"></a>                <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>includeNew</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN600"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>theNode</span><span class='Delimiter'>; 
</span><a name="LN601"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>limit</span><span class='Delimiter'>; 
</span><a name="LN602"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* For the moment, assume we can include the new leaf tuple */ 
</span>    <span class='Operator'>*</span><a href="spgdoinsert.c.html#LN598"><span class='Ref_to_Parameter'>includeNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there's only the new leaf tuple, don't select allTheSame mode */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>in</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>&LT;= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If tuple set doesn't fit on one page, ignore the new tuple in test */ 
</span>    <a href="spgdoinsert.c.html#LN601"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>tooBig</span></a> <span class='Operator'>? </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>in</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span> <span class='Operator'>: </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>in</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check to see if more than one node is populated */ 
</span>    <a href="spgdoinsert.c.html#LN600"><span class='Ref_To_Local'>theNode</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN601"><span class='Ref_To_Local'>limit</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN600"><span class='Ref_To_Local'>theNode</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Nope, so override the picksplit function's decisions */ 
</span> 
    <span class='Comment_Multi_Line'>/* If the new tuple is in its own node, it can't be included in split */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>tooBig</span></a> <span class='Operator'>&& </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>in</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN600"><span class='Ref_To_Local'>theNode</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="spgdoinsert.c.html#LN598"><span class='Ref_to_Parameter'>includeNew</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a> <span class='Operator'>= </span><span class='Number'>8</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* arbitrary number of child nodes */ 
</span> 
    <span class='Comment_Multi_Line'>/* Random assignment of tuples to nodes (note we include new tuple) */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>in</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>% </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The opclass may not use node labels, but if it does, duplicate 'em */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN637"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>theLabel</span> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN600"><span class='Ref_To_Local'>theNode</span></a><span class='Delimiter'>]; 
</span> 
        <a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN597"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN637"><span class='Ref_To_Local'>theLabel</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* We don't touch the prefix or the leaf tuple datum assignments */ 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end checkAllTheSame &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * current points to a leaf-tuple chain that we wanted to add newLeafTuple to, 
 * but the chain has to be split because there's not enough room to add 
 * newLeafTuple to its page. 
 * 
 * This function splits the leaf tuple set according to picksplit's rules, 
 * creating one or more new chains that are spread across the current page 
 * and an additional leaf page (we assume that two leaf pages will be 
 * sufficient).  A new inner tuple is created, and the parent downlink 
 * pointer is updated to point to that inner tuple instead of the leaf chain. 
 * 
 * On exit, current contains the address of the new inner tuple. 
 * 
 * Returns true if we successfully inserted newLeafTuple during this function, 
 * false if caller still has to do it (meaning another picksplit operation is 
 * probably needed).  Failure could occur if the picksplit result is fairly 
 * unbalanced, or if newLeafTuple is just plain too big to fit on a page. 
 * Because we force the picksplit result to be at least two chains, each 
 * cycle will get rid of at least one leaf tuple from the chain, so the loop 
 * will eventually terminate if lack of balance is the issue.  If the tuple 
 * is too big, we assume that repeated picksplit operations will eventually 
 * make it small enough by repeated prefix-stripping.  A broken opclass could 
 * make this an infinite loop, though. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN674"></a><span class='Declare_Function'>doPickSplit</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN675"></a>            <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, 
</span><a name="LN676"></a>            <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Parameter'>newLeafTuple</span><span class='Delimiter'>, 
</span><a name="LN677"></a>            <span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNulls</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isNew</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN679"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>insertedNew</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN680"></a>    <a href="../../../include/access/spgist.h.html#LN110"><span class='Ref_to_Struct'>spgPickSplitIn</span></a> <span class='Declare_Local'>in</span><span class='Delimiter'>; 
</span><a name="LN681"></a>    <a href="../../../include/access/spgist.h.html#LN117"><span class='Ref_to_Struct'>spgPickSplitOut</span></a> <span class='Declare_Local'>out</span><span class='Delimiter'>; 
</span><a name="LN682"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>procinfo</span><span class='Delimiter'>; 
</span><a name="LN683"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>includeNew</span><span class='Delimiter'>; 
</span><a name="LN684"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN685"></a>                <span class='Declare_Local'>max</span><span class='Delimiter'>, 
</span><a name="LN686"></a>                <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN687"></a>    <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Local'>innerTuple</span><span class='Delimiter'>; 
</span><a name="LN688"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span><span class='Delimiter'>, 
</span><a name="LN689"></a>               <span class='Operator'>*</span><span class='Declare_Local'>nodes</span><span class='Delimiter'>; 
</span><a name="LN690"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>newInnerBuffer</span><span class='Delimiter'>, 
</span><a name="LN691"></a>                <span class='Declare_Local'>newLeafBuffer</span><span class='Delimiter'>; 
</span><a name="LN692"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>heapPtrs</span><span class='Delimiter'>; 
</span><a name="LN693"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>leafPageSelect</span><span class='Delimiter'>; 
</span><a name="LN694"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>leafSizes</span><span class='Delimiter'>; 
</span><a name="LN695"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>toDelete</span><span class='Delimiter'>; 
</span><a name="LN696"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>toInsert</span><span class='Delimiter'>; 
</span><a name="LN697"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>redirectTuplePos</span> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span><a name="LN698"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>startOffsets</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN699"></a>    <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newLeafs</span><span class='Delimiter'>; 
</span><a name="LN700"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>spaceToDelete</span><span class='Delimiter'>; 
</span><a name="LN701"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>currentFreeSpace</span><span class='Delimiter'>; 
</span><a name="LN702"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>totalLeafSizes</span><span class='Delimiter'>; 
</span><a name="LN703"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>allTheSame</span><span class='Delimiter'>; 
</span><a name="LN704"></a>    <a href="../../../include/access/spgxlog.h.html#LN164"><span class='Ref_to_Struct'>spgxlogPickSplit</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN705"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>leafdata</span><span class='Delimiter'>, 
</span><a name="LN706"></a>               <span class='Operator'>*</span><span class='Declare_Local'>leafptr</span><span class='Delimiter'>; 
</span><a name="LN707"></a>    <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a>  <span class='Declare_Local'>saveCurrent</span><span class='Delimiter'>; 
</span><a name="LN708"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nToDelete</span><span class='Delimiter'>, 
</span><a name="LN709"></a>                <span class='Declare_Local'>nToInsert</span><span class='Delimiter'>, 
</span><a name="LN710"></a>                <span class='Declare_Local'>maxToInclude</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN114"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate per-leaf-tuple work arrays with max possible size 
     */ 
</span>    <a href="spgdoinsert.c.html#LN685"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN685"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN113"><span class='Ref_to_Member'>datums</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN692"><span class='Ref_To_Local'>heapPtrs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN696"><span class='Ref_To_Local'>toInsert</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN693"><span class='Ref_To_Local'>leafPageSelect</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/spgist_private.h.html#LN356"><span class='Ref_to_Macro'>STORE_STATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN184"><span class='Ref_to_Member'>stateSrc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Form list of leaf tuples which will be distributed as split result; 
     * also, count up the amount of space that will be freed from current. 
     * (Note that in the non-root case, we won't actually delete the old 
     * tuples, only replace them with redirects or placeholders.) 
     * 
     * Note: the SGLTDATUM calls here are safe even when dealing with a nulls 
     * page.  For a pass-by-value data type we will fetch a word that must 
     * exist even though it may contain garbage (because of the fact that leaf 
     * tuples must have size at least SGDTSIZE).  For a pass-by-reference type 
     * we are just computing a pointer that isn't going to get dereferenced. 
     * So it's not worth guarding the calls with isNulls checks. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN700"><span class='Ref_To_Local'>spaceToDelete</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We are splitting the root (which up to now is also a leaf page). 
         * Its tuples are not linked, so scan sequentially to get them all. We 
         * ignore the original value of current-&GT;offnum. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="spgdoinsert.c.html#LN685"><span class='Ref_To_Local'>max</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN753"></a>            <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN753"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN753"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN196"><span class='Ref_to_Const'>SPGIST_LIVE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN113"><span class='Ref_to_Member'>datums</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN302"><span class='Ref_to_Macro'>SGLTDATUM</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN753"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN692"><span class='Ref_To_Local'>heapPtrs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN753"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN294"><span class='Ref_to_Member'>heapPtr</span></a><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* we will delete the tuple altogether, so count full space */ 
</span>                <a href="spgdoinsert.c.html#LN700"><span class='Ref_To_Local'>spaceToDelete</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN753"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span>    <span class='Comment_Single_Line'>/* tuples on root should be live */ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected SPGiST tuple state: %d"</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN753"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SpGistBlockIsRoot(cur... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Normal case, just collect the leaf tuples in the chain */ 
</span>        <a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN777"></a>            <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a> <span class='Operator'>&& </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="spgdoinsert.c.html#LN685"><span class='Ref_To_Local'>max</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN196"><span class='Ref_to_Const'>SPGIST_LIVE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN113"><span class='Ref_to_Member'>datums</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN302"><span class='Ref_to_Macro'>SGLTDATUM</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN692"><span class='Ref_To_Local'>heapPtrs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN294"><span class='Ref_to_Member'>heapPtr</span></a><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* we will not delete the tuple, only replace with dead */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN700"><span class='Ref_To_Local'>spaceToDelete</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>- </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN198"><span class='Ref_to_Const'>SPGIST_DEAD</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* We could see a DEAD tuple as first/only chain item */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* replacing it with redirect will save no space */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected SPGiST tuple state: %d"</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN291"><span class='Ref_to_Member'>tupstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN777"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while i!=InvalidOffsetNumbe... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We may not actually insert new tuple because another picksplit may be 
     * necessary due to too large value, but we will try to allocate enough 
     * space to include it; and in any case it has to be included in the input 
     * for the picksplit function.  So don't increment nToInsert yet. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN113"><span class='Ref_to_Member'>datums</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN302"><span class='Ref_to_Macro'>SGLTDATUM</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN676"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN692"><span class='Ref_To_Local'>heapPtrs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN676"><span class='Ref_to_Parameter'>newLeafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN294"><span class='Ref_to_Member'>heapPtr</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNulls</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Perform split using user-defined method. 
         */ 
</span>        <a href="spgdoinsert.c.html#LN682"><span class='Ref_To_Local'>procinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist.h.html#LN29"><span class='Ref_to_Const'>SPGIST_PICKSPLIT_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN682"><span class='Ref_To_Local'>procinfo</span></a><span class='Delimiter'>, 
</span>                          <a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form new leaf tuples and count up the total space needed. 
         */ 
</span>        <a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN393"><span class='Ref_to_Proto'>spgFormLeafTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN692"><span class='Ref_To_Local'>heapPtrs</span></a> <span class='Operator'>+ </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                                           <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN126"><span class='Ref_to_Member'>leafTupleDatums</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                           <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !isNulls &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Perform dummy split that puts all tuples into one node. 
         * checkAllTheSame will override this and force allTheSame mode. 
         */ 
</span>        <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN119"><span class='Ref_to_Member'>hasPrefix</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form new leaf tuples and count up the total space needed. 
         */ 
</span>        <a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN393"><span class='Ref_to_Proto'>spgFormLeafTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN692"><span class='Ref_To_Local'>heapPtrs</span></a> <span class='Operator'>+ </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                                           <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                           <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Check to see if the picksplit function failed to separate the values, 
     * ie, it put them all into the same child node.  If so, select allTheSame 
     * mode and create a random split instead.  See comments for 
     * checkAllTheSame as to why we need to know if the new leaf tuples could 
     * fit on one page. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN703"><span class='Ref_To_Local'>allTheSame</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN596"><span class='Ref_to_Func'>checkAllTheSame</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Delimiter'>, 
</span>                                 <a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN683"><span class='Ref_To_Local'>includeNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If checkAllTheSame decided we must exclude the new tuple, don't 
     * consider it any further. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN683"><span class='Ref_To_Local'>includeNew</span></a><span class='Parentheses'>) 
</span>        <a href="spgdoinsert.c.html#LN710"><span class='Ref_To_Local'>maxToInclude</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN710"><span class='Ref_To_Local'>maxToInclude</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>-= </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate per-node work arrays.  Since checkAllTheSame could replace 
     * out.nNodes with a value larger than the number of tuples on the input 
     * page, we can't allocate these arrays before here. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Form nodes of inner tuple and inner tuple itself 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN905"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>label</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN906"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>labelisnull</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN906"><span class='Ref_To_Local'>labelisnull</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN905"><span class='Ref_To_Local'>label</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN123"><span class='Ref_to_Member'>nodeLabels</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN396"><span class='Ref_to_Proto'>spgFormNodeTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN905"><span class='Ref_To_Local'>label</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN906"><span class='Ref_To_Local'>labelisnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN398"><span class='Ref_to_Proto'>spgFormInnerTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                   <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN119"><span class='Ref_to_Member'>hasPrefix</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN120"><span class='Ref_to_Member'>prefixDatum</span></a><span class='Delimiter'>, 
</span>                                   <a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN212"><span class='Ref_to_Member'>allTheSame</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN703"><span class='Ref_To_Local'>allTheSame</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update nodes[] array to point into the newly formed innerTuple, so that 
     * we can adjust their downlinks below. 
     */ 
</span>    <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN688"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN688"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Re-scan new leaf tuples and count up the space needed under each node. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN710"><span class='Ref_To_Local'>maxToInclude</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&GT;= </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"inconsistent result of SPGiST picksplit function"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>] </span><span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To perform the split, we must insert a new inner tuple, which can't go 
     * on a leaf page; and unless we are splitting the root page, we must then 
     * update the parent tuple's downlink to point to the inner tuple.  If 
     * there is room, we'll put the new inner tuple on the same page as the 
     * parent tuple, otherwise we need another non-leaf buffer. But if the 
     * parent page is the root, we can't add the new inner tuple there, 
     * because the root page must have only one inner tuple. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN175"><span class='Ref_to_Member'>initInner</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN347"><span class='Ref_to_Macro'>SpGistPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&GT;= 
</span>         <a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* New inner tuple will fit on parent page */ 
</span>        <a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Send tuple to page with next triple parity (see README) */ 
</span>        <a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN357"><span class='Ref_to_Func'>SpGistGetBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../../include/access/spgist_private.h.html#LN374"><span class='Ref_to_Macro'>GBUF_INNER_PARITY</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>| 
</span>                                         <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNulls</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN375"><span class='Ref_to_Const'>GBUF_NULLS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN175"><span class='Ref_to_Member'>initInner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Root page split ... inner tuple will go to root page */ 
</span>        <a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The new leaf tuples converted from the existing ones should require the 
     * same or less space, and therefore should all fit onto one page 
     * (although that's not necessarily the current page, since we can't 
     * delete the old tuples but only replace them with placeholders). 
     * However, the incoming new tuple might not also fit, in which case we 
     * might need another picksplit cycle to reduce it some more. 
     * 
     * If there's not room to put everything back onto the current page, then 
     * we decide on a per-node basis which tuples go to the new page. (We do 
     * it like that because leaf tuple chains can't cross pages, so we must 
     * place all leaf tuples belonging to the same parent node on the same 
     * page.) 
     * 
     * If we are splitting the root page (turning it from a leaf page into an 
     * inner page), then no leaf tuples can go back to the current page; they 
     * must all go somewhere else. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span> 
        <a href="spgdoinsert.c.html#LN701"><span class='Ref_To_Local'>currentFreeSpace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="spgdoinsert.c.html#LN700"><span class='Ref_To_Local'>spaceToDelete</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="spgdoinsert.c.html#LN701"><span class='Ref_To_Local'>currentFreeSpace</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* prevent assigning any tuples to current */ 
</span> 
    <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN171"><span class='Ref_to_Member'>initDest</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>&LT;= </span><a href="spgdoinsert.c.html#LN701"><span class='Ref_To_Local'>currentFreeSpace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* All the leaf tuples will fit on current page */ 
</span>        <a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* mark new leaf tuple as included in insertions, if allowed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN683"><span class='Ref_To_Local'>includeNew</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN679"><span class='Ref_To_Local'>insertedNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN693"><span class='Ref_To_Local'>leafPageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* signifies current page */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We're trying to split up a long value by repeated suffixing, but 
         * it's not going to fit yet.  Don't bother allocating a second leaf 
         * buffer that we won't be able to use. 
         */ 
</span>        <a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN683"><span class='Ref_To_Local'>includeNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We will need another leaf page */ 
</span><a name="LN1022"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>nodePageSelect</span><span class='Delimiter'>; 
</span><a name="LN1023"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>curspace</span><span class='Delimiter'>; 
</span><a name="LN1024"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>newspace</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN357"><span class='Ref_to_Func'>SpGistGetBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/access/spgist_private.h.html#LN373"><span class='Ref_to_Const'>GBUF_LEAF</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNulls</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN375"><span class='Ref_to_Const'>GBUF_NULLS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        <a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN171"><span class='Ref_to_Member'>initDest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Attempt to assign node groups to the two pages.  We might fail to 
         * do so, even if totalLeafSizes is less than the available space, 
         * because we can't split a group across pages. 
         */ 
</span>        <a href="spgdoinsert.c.html#LN1022"><span class='Ref_To_Local'>nodePageSelect</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN701"><span class='Ref_To_Local'>currentFreeSpace</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1024"><span class='Ref_To_Local'>newspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="spgdoinsert.c.html#LN1022"><span class='Ref_To_Local'>nodePageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* signifies current page */ 
</span>                <a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a> <span class='Operator'>-= </span><a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="spgdoinsert.c.html#LN1022"><span class='Ref_To_Local'>nodePageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* signifies new leaf page */ 
</span>                <a href="spgdoinsert.c.html#LN1024"><span class='Ref_To_Local'>newspace</span></a> <span class='Operator'>-= </span><a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="spgdoinsert.c.html#LN1024"><span class='Ref_To_Local'>newspace</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Successful assignment, so we can include the new leaf tuple */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN683"><span class='Ref_To_Local'>includeNew</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN679"><span class='Ref_To_Local'>insertedNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN683"><span class='Ref_To_Local'>includeNew</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We must exclude the new leaf tuple from the split */ 
</span><a name="LN1066"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nodeOfNewTuple</span> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
            <a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN1066"><span class='Ref_To_Local'>nodeOfNewTuple</span></a><span class='Delimiter'>] </span><span class='Operator'>-= 
</span>                <a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN680"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN112"><span class='Ref_to_Member'>nTuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Repeat the node assignment process --- should succeed now */ 
</span>            <a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN701"><span class='Ref_To_Local'>currentFreeSpace</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN1024"><span class='Ref_To_Local'>newspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN122"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="spgdoinsert.c.html#LN1022"><span class='Ref_To_Local'>nodePageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* signifies current page */ 
</span>                    <a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a> <span class='Operator'>-= </span><a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="spgdoinsert.c.html#LN1022"><span class='Ref_To_Local'>nodePageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* signifies new leaf page */ 
</span>                    <a href="spgdoinsert.c.html#LN1024"><span class='Ref_To_Local'>newspace</span></a> <span class='Operator'>-= </span><a href="spgdoinsert.c.html#LN694"><span class='Ref_To_Local'>leafSizes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1023"><span class='Ref_To_Local'>curspace</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="spgdoinsert.c.html#LN1024"><span class='Ref_To_Local'>newspace</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to divide leaf tuple groups across pages"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if includeNew &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* oops, we already excluded new tuple ... should not get here */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to divide leaf tuple groups across pages"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* Expand the per-node assignments to be shown per leaf tuple */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="spgdoinsert.c.html#LN693"><span class='Ref_To_Local'>leafPageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1022"><span class='Ref_To_Local'>nodePageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Start preparing WAL record */ 
</span>    <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN168"><span class='Ref_to_Member'>nDelete</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN170"><span class='Ref_to_Member'>initSrc</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNew</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN177"><span class='Ref_to_Member'>storesNulls</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNulls</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN166"><span class='Ref_to_Member'>isRootSplit</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN705"><span class='Ref_To_Local'>leafdata</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN706"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN702"><span class='Ref_To_Local'>totalLeafSizes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Here we begin making the changes to the target pages */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete old leaf tuples from current buffer, except when we're splitting 
     * the root; in that case there's no need because we'll re-init the page 
     * below.  We do this first to make room for reinserting new leaf tuples. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Init buffer instead of deleting individual tuples, but only if 
         * there aren't any other live tuples and only during build; otherwise 
         * we need to set a redirection tuple for concurrent scans. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN128"><span class='Ref_to_Member'>isBuild</span></a> <span class='Operator'>&& 
</span>            <a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a> <span class='Operator'>+ </span><a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>nPlaceholder <span class='Operator'>== 
</span>            <a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/spgist_private.h.html#LN390"><span class='Ref_to_Proto'>SpGistInitBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/access/spgist_private.h.html#LN52"><span class='Ref_to_Const'>SPGIST_LEAF</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNulls</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN53"><span class='Ref_to_Const'>SPGIST_NULLS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN170"><span class='Ref_to_Member'>initSrc</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNew</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* don't expose the freshly init'd buffer as a backup block */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN168"><span class='Ref_to_Member'>nDelete</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN128"><span class='Ref_to_Member'>isBuild</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Need to create redirect tuple (it will point to new inner 
                 * tuple) but right now the new tuple's location is not known 
                 * yet.  So, set the redirection pointer to "impossible" value 
                 * and remember its position to update tuple later. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="spgdoinsert.c.html#LN697"><span class='Ref_To_Local'>redirectTuplePos</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>                <a href="spgdoinsert.c.html#LN129"><span class='Ref_to_Func'>spgPageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                        <a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/access/spgist_private.h.html#LN197"><span class='Ref_to_Const'>SPGIST_REDIRECT</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/access/spgist_private.h.html#LN24"><span class='Ref_to_Const'>SPGIST_METAPAGE_BLKNO</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * During index build there is not concurrent searches, so we 
                 * don't need to create redirection tuple. 
                 */ 
</span>                <a href="spgdoinsert.c.html#LN129"><span class='Ref_to_Func'>spgPageIndexMultiDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                        <a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN708"><span class='Ref_To_Local'>nToDelete</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !SpGistBlockIsRoot(cu... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Put leaf tuples on proper pages, and update downlinks in innerTuple's 
     * nodes. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN698"><span class='Ref_To_Local'>startOffsets</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN698"><span class='Ref_To_Local'>startOffsets</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1183"></a>        <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>it</span> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1184"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>leafBuffer</span><span class='Delimiter'>; 
</span><a name="LN1185"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>leafBlock</span><span class='Delimiter'>; 
</span><a name="LN1186"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>newoffset</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Which page is it going to? */ 
</span>        <a href="spgdoinsert.c.html#LN1184"><span class='Ref_To_Local'>leafBuffer</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN693"><span class='Ref_To_Local'>leafPageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>? </span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>: </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1185"><span class='Ref_To_Local'>leafBlock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1184"><span class='Ref_To_Local'>leafBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Link tuple into correct chain for its node */ 
</span>        <a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN681"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN125"><span class='Ref_to_Member'>mapTuplesToNodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="spgdoinsert.c.html#LN1185"><span class='Ref_To_Local'>leafBlock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN1183"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="spgdoinsert.c.html#LN1183"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Insert it on page */ 
</span>        <a href="spgdoinsert.c.html#LN1186"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1184"><span class='Ref_To_Local'>leafBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1183"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1183"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN698"><span class='Ref_To_Local'>startOffsets</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN693"><span class='Ref_To_Local'>leafPageSelect</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]], 
</span>                                         <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN696"><span class='Ref_To_Local'>toInsert</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1186"><span class='Ref_To_Local'>newoffset</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ... and complete the chain linking */ 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN689"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN686"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1185"><span class='Ref_To_Local'>leafBlock</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1186"><span class='Ref_To_Local'>newoffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Also copy leaf tuple into WAL data */ 
</span>        memcpy<span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN706"><span class='Ref_To_Local'>leafptr</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN706"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN699"><span class='Ref_To_Local'>newLeafs</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nToInsert;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We're done modifying the other leaf buffer (if any), so mark it dirty. 
     * current-&GT;buffer will be marked below, after we're entirely done 
     * modifying it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Remember current buffer, since we're about to change "current" */ 
</span>    <a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a> <span class='Operator'>= *</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store the new innerTuple 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>&& </span><a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * new inner tuple goes to parent page 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Repoint "current" at the new inner tuple */ 
</span>        <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN174"><span class='Ref_to_Member'>offnumInner</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update parent node link and mark parent page dirty 
         */ 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN180"><span class='Ref_to_Member'>innerIsParent</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN181"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN182"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN184"><span class='Ref_to_Func'>saveNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update redirection link (in old current buffer) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN697"><span class='Ref_To_Local'>redirectTuplePos</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN565"><span class='Ref_to_Func'>setRedirectionTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN697"><span class='Ref_To_Local'>redirectTuplePos</span></a><span class='Delimiter'>, 
</span>                                <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done modifying old current buffer, mark it dirty */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if newInnerBuffer==paren... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * new inner tuple will be stored on a new page 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Repoint "current" at the new inner tuple */ 
</span>        <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN690"><span class='Ref_To_Local'>newInnerBuffer</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN174"><span class='Ref_to_Member'>offnumInner</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done modifying new current buffer, mark it dirty */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update parent node link and mark parent page dirty 
         */ 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN180"><span class='Ref_to_Member'>innerIsParent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN181"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN182"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN184"><span class='Ref_to_Func'>saveNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update redirection link (in old current buffer) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN697"><span class='Ref_To_Local'>redirectTuplePos</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN565"><span class='Ref_to_Func'>setRedirectionTuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN697"><span class='Ref_To_Local'>redirectTuplePos</span></a><span class='Delimiter'>, 
</span>                                <a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done modifying old current buffer, mark it dirty */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parent-&GT;buffer!=Inval... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Splitting root page, which was a leaf but now becomes inner page 
         * (and so "current" continues to point at it) 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN697"><span class='Ref_To_Local'>redirectTuplePos</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/spgist_private.h.html#LN390"><span class='Ref_to_Proto'>SpGistInitBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN677"><span class='Ref_to_Parameter'>isNulls</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN53"><span class='Ref_to_Const'>SPGIST_NULLS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN175"><span class='Ref_to_Member'>initInner</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN180"><span class='Ref_to_Member'>innerIsParent</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN174"><span class='Ref_to_Member'>offnumInner</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>                 <a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No parent link to update, nor redirection to do */ 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN181"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN182"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done modifying new current buffer, mark it dirty */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* saveCurrent doesn't represent a different buffer */ 
</span>        <a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1338"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN1339"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN169"><span class='Ref_to_Member'>nInsert</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN709"><span class='Ref_To_Local'>nToInsert</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN198"><span class='Ref_to_Const'>SizeOfSpgxlogPickSplit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN695"><span class='Ref_To_Local'>toDelete</span></a><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN168"><span class='Ref_to_Member'>nDelete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN696"><span class='Ref_To_Local'>toInsert</span></a><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN169"><span class='Ref_to_Member'>nInsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN693"><span class='Ref_To_Local'>leafPageSelect</span></a><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN169"><span class='Ref_to_Member'>nInsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN687"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN705"><span class='Ref_To_Local'>leafdata</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN706"><span class='Ref_To_Local'>leafptr</span></a> <span class='Operator'>- </span><a href="spgdoinsert.c.html#LN705"><span class='Ref_To_Local'>leafdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Old leaf page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN170"><span class='Ref_to_Member'>initSrc</span></a><span class='Parentheses'>) 
</span>                <a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* New leaf page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN171"><span class='Ref_to_Member'>initDest</span></a><span class='Parentheses'>) 
</span>                <a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Inner page */ 
</span>        <a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN175"><span class='Ref_to_Member'>initInner</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1339"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Parent page, if different from inner page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN704"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN180"><span class='Ref_to_Member'>innerIsParent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Issue the WAL record */ 
</span>        <a href="spgdoinsert.c.html#LN1338"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_SPGIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN25"><span class='Ref_to_Const'>XLOG_SPGIST_PICKSPLIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update page LSNs on all affected pages */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1394"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1394"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1338"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1401"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1401"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1338"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1338"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN675"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1338"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(inde... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update local free-space cache and unlock buffers */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN691"><span class='Ref_To_Local'>newLeafBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN674"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN707"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="spgdoinsert.c.html#LN679"><span class='Ref_To_Local'>insertedNew</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end doPickSplit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * spgMatchNode action: descend to N'th child node of current inner tuple 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1435"></a><span class='Declare_Function'>spgMatchNodeAction</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN1436"></a>                   <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Parameter'>innerTuple</span><span class='Delimiter'>, 
</span><a name="LN1437"></a>                   <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nodeN</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1439"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1440"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release previous parent buffer if any */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& 
</span>        <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1435"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Repoint parent to specified node of current inner tuple */ 
</span>    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Locate that node */ 
</span>    <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1436"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1439"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1440"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1439"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1439"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to find requested node %d in SPGiST inner tuple"</span><span class='Delimiter'>, 
</span>             <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Point current to the downlink location, if any */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1440"><span class='Ref_To_Local'>node</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1440"><span class='Ref_To_Local'>node</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1440"><span class='Ref_To_Local'>node</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Downlink is empty, so we'll need to find a new page */ 
</span>        <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1437"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgMatchNodeAction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * spgAddNode action: add a node to the inner tuple at current 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1489"></a><span class='Declare_Function'>spgAddNodeAction</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN1490"></a>                 <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Parameter'>innerTuple</span><span class='Delimiter'>, 
</span><a name="LN1491"></a>                 <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, 
</span><a name="LN1492"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>nodeN</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>nodeLabel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1494"></a>    <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Local'>newInnerTuple</span><span class='Delimiter'>; 
</span><a name="LN1495"></a>    <a href="../../../include/access/spgxlog.h.html#LN98"><span class='Ref_to_Struct'>spgxlogAddNode</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Should not be applied to nulls */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Construct new inner tuple with additional node */ 
</span>    <a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN76"><span class='Ref_to_Func'>addNode</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1490"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1492"><span class='Ref_to_Parameter'>nodeLabel</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1492"><span class='Ref_to_Parameter'>nodeN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare WAL record */ 
</span>    <a href="../../../include/access/spgist_private.h.html#LN356"><span class='Ref_to_Macro'>STORE_STATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN129"><span class='Ref_to_Member'>stateSrc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN104"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we don't fill these unless we need to change the parent downlink */ 
</span>    <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN124"><span class='Ref_to_Member'>parentBlk</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN125"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN127"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we don't fill these unless tuple has to be moved */ 
</span>    <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN110"><span class='Ref_to_Member'>offnumNew</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN111"><span class='Ref_to_Member'>newPage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= 
</span>        <a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>- </span><a href="spgdoinsert.c.html#LN1490"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We can replace the inner tuple by new version in-place 
         */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                        <a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>                 <a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1535"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN1535"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_SPGIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN23"><span class='Ref_to_Const'>XLOG_SPGIST_ADD_NODE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1535"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PageGetExactFreeSpace... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * move inner tuple to another page, and update parent 
         */ 
</span><a name="LN1555"></a>        <a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a> <span class='Declare_Local'>dt</span><span class='Delimiter'>; 
</span><a name="LN1556"></a>        <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a>  <span class='Declare_Local'>saveCurrent</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * It should not be possible to get here for the root page, since we 
         * allow only one inner tuple on the root page, and spgFormInnerTuple 
         * always checks that inner tuples don't exceed the size of a page. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot enlarge root tuple any more"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a> <span class='Operator'>= *</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN125"><span class='Ref_to_Member'>offnumParent</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN127"><span class='Ref_to_Member'>nodeI</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * obtain new buffer with the same parity as current, since it will be 
         * a child of same parent tuple 
         */ 
</span>        <a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN357"><span class='Ref_to_Func'>SpGistGetBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/access/spgist_private.h.html#LN374"><span class='Ref_to_Macro'>GBUF_INNER_PARITY</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN111"><span class='Ref_to_Member'>newPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Let's just make real sure new current isn't same as old.  Right now 
         * that's impossible, but if SpGistGetBuffer ever got smart enough to 
         * delete placeholder tuples before checking space, maybe it wouldn't 
         * be impossible.  The case would appear to work except that WAL 
         * replay would be subtly wrong, so I think a mere assert isn't enough 
         * here. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPGiST new buffer shouldn't be same as old buffer"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * New current and parent buffer will both be modified; but note that 
         * parent buffer could be same as either new or old current. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN124"><span class='Ref_to_Member'>parentBlk</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>== </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN124"><span class='Ref_to_Member'>parentBlk</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN124"><span class='Ref_to_Member'>parentBlk</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* insert new ... */ 
</span>        <a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN110"><span class='Ref_to_Member'>offnumNew</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* update parent's downlink and mark parent page dirty */ 
</span>        <a href="spgdoinsert.c.html#LN184"><span class='Ref_to_Func'>saveNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Replace old tuple with a placeholder or redirection tuple.  Unless 
         * doing an index build, we have to insert a redirection tuple for 
         * possible concurrent scans.  We can't just delete it in any case, 
         * because that could change the offsets of other tuples on the page, 
         * breaking downlinks from their parents. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN128"><span class='Ref_to_Member'>isBuild</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN1555"><span class='Ref_To_Local'>dt</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN401"><span class='Ref_to_Proto'>spgFormDeadTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="spgdoinsert.c.html#LN1555"><span class='Ref_To_Local'>dt</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN401"><span class='Ref_to_Proto'>spgFormDeadTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN197"><span class='Ref_to_Const'>SPGIST_REDIRECT</span></a><span class='Delimiter'>, 
</span>                                  <a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1555"><span class='Ref_To_Local'>dt</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1555"><span class='Ref_To_Local'>dt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN320"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                        <a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>, 
</span>                        <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>                 <a href="spgdoinsert.c.html#LN1555"><span class='Ref_To_Local'>dt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN320"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN128"><span class='Ref_to_Member'>isBuild</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>nPlaceholder<span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>nRedirection<span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1648"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN1649"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* orig page */ 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* new page */ 
</span>            <a href="spgdoinsert.c.html#LN1649"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN111"><span class='Ref_to_Member'>newPage</span></a><span class='Parentheses'>) 
</span>                <a href="spgdoinsert.c.html#LN1649"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1649"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* parent page (if different from orig and new) */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN124"><span class='Ref_to_Member'>parentBlk</span></a> <span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>                <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1495"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1494"><span class='Ref_To_Local'>newInnerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN1648"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_SPGIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN23"><span class='Ref_to_Const'>XLOG_SPGIST_ADD_NODE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* we don't bother to check if any of these are redundant */ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1648"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1648"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1648"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release saveCurrent if it's not same as current or parent */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>&& 
</span>            <a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1491"><span class='Ref_to_Parameter'>parent</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1489"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1556"><span class='Ref_To_Local'>saveCurrent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end spgAddNodeAction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * spgSplitNode action: split inner tuple at current into prefix and postfix 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1691"></a><span class='Declare_Function'>spgSplitNodeAction</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN1692"></a>                   <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Parameter'>innerTuple</span><span class='Delimiter'>, 
</span><a name="LN1693"></a>                   <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>current</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist.h.html#LN74"><span class='Ref_to_Struct'>spgChooseOut</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>out</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1695"></a>    <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Local'>prefixTuple</span><span class='Delimiter'>, 
</span><a name="LN1696"></a>                <span class='Declare_Local'>postfixTuple</span><span class='Delimiter'>; 
</span><a name="LN1697"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span><span class='Delimiter'>, 
</span><a name="LN1698"></a>               <span class='Operator'>*</span><span class='Declare_Local'>nodes</span><span class='Delimiter'>; 
</span><a name="LN1699"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>postfixBlkno</span><span class='Delimiter'>; 
</span><a name="LN1700"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>postfixOffset</span><span class='Delimiter'>; 
</span><a name="LN1701"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1702"></a>    <a href="../../../include/access/spgxlog.h.html#LN140"><span class='Ref_to_Struct'>spgxlogSplitTuple</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN1703"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>newBuffer</span> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Should not be applied to nulls */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check opclass gave us sane values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN223"><span class='Ref_to_Const'>SGITMAXNNODES</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid number of prefix nodes: %d"</span><span class='Delimiter'>, 
</span>             <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>childNodeN <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>childNodeN <span class='Operator'>&GT;= 
</span>        <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes<span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid child node number: %d"</span><span class='Delimiter'>, 
</span>             <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>childNodeN<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Construct new prefix tuple with requested number of nodes.  We'll fill 
     * in the childNodeN'th node's downlink below. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN1698"><span class='Ref_To_Local'>nodes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* 
</span>                                       <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes<span class='Delimiter'>; </span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1728"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>label</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1729"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>labelisnull</span><span class='Delimiter'>; 
</span> 
        <a href="spgdoinsert.c.html#LN1729"><span class='Ref_To_Local'>labelisnull</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNodeLabels <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1729"><span class='Ref_To_Local'>labelisnull</span></a><span class='Parentheses'>) 
</span>            <a href="spgdoinsert.c.html#LN1728"><span class='Ref_To_Local'>label</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNodeLabels<span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="spgdoinsert.c.html#LN1698"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN396"><span class='Ref_to_Proto'>spgFormNodeTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1728"><span class='Ref_To_Local'>label</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1729"><span class='Ref_To_Local'>labelisnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN398"><span class='Ref_to_Proto'>spgFormInnerTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                    <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixHasPrefix<span class='Delimiter'>, 
</span>                                    <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixPrefixDatum<span class='Delimiter'>, 
</span>                                    <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>prefixNNodes<span class='Delimiter'>, 
</span>                                    <a href="spgdoinsert.c.html#LN1698"><span class='Ref_To_Local'>nodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* it must fit in the space that innerTuple now occupies */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&GT; </span><a href="spgdoinsert.c.html#LN1692"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPGiST inner-tuple split must not produce longer prefix"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Construct new postfix tuple, containing all nodes of innerTuple with 
     * same node datums, but with the prefix specified by the picksplit 
     * function. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN1698"><span class='Ref_To_Local'>nodes</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgdoinsert.c.html#LN1692"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1692"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1697"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN1698"><span class='Ref_To_Local'>nodes</span></a><span class='Delimiter'>[</span><a href="spgdoinsert.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1697"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN398"><span class='Ref_to_Proto'>spgFormInnerTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                     <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>postfixHasPrefix<span class='Delimiter'>, 
</span>                                   <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>postfixPrefixDatum<span class='Delimiter'>, 
</span>                                     <a href="spgdoinsert.c.html#LN1692"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1698"><span class='Ref_To_Local'>nodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Postfix tuple is allTheSame if original tuple was */ 
</span>    <a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN212"><span class='Ref_to_Member'>allTheSame</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1692"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN212"><span class='Ref_to_Member'>allTheSame</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prep data for WAL record */ 
</span>    <a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN147"><span class='Ref_to_Member'>newPage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we can't fit both tuples on the current page, get a new page for the 
     * postfix tuple.  In particular, can't split to the root page. 
     * 
     * For the space calculation, note that prefixTuple replaces innerTuple 
     * but postfixTuple will be a new entry. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN29"><span class='Ref_to_Macro'>SpGistBlockIsRoot</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/access/spgist_private.h.html#LN347"><span class='Ref_to_Macro'>SpGistPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="spgdoinsert.c.html#LN1692"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&LT; 
</span>        <a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Choose page with next triple parity, because postfix tuple is a 
         * child of prefix one 
         */ 
</span>        <a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN357"><span class='Ref_to_Func'>SpGistGetBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/access/spgist_private.h.html#LN374"><span class='Ref_to_Macro'>GBUF_INNER_PARITY</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN147"><span class='Ref_to_Member'>newPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Replace old tuple by prefix tuple 
     */ 
</span>    <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN143"><span class='Ref_to_Member'>offnumPrefix</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                     <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                     <a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN143"><span class='Ref_to_Member'>offnumPrefix</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>             <a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * put postfix tuple into appropriate page 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN1699"><span class='Ref_To_Local'>postfixBlkno</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN146"><span class='Ref_to_Member'>offnumPostfix</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1700"><span class='Ref_To_Local'>postfixOffset</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN148"><span class='Ref_to_Member'>postfixBlkSame</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="spgdoinsert.c.html#LN1699"><span class='Ref_To_Local'>postfixBlkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN146"><span class='Ref_to_Member'>offnumPostfix</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1700"><span class='Ref_To_Local'>postfixOffset</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/access/spgist_private.h.html#LN405"><span class='Ref_to_Proto'>SpGistPageAddNewItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN148"><span class='Ref_to_Member'>postfixBlkSame</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And set downlink pointer in the prefix tuple to point to postfix tuple. 
     * (We can't avoid this step by doing the above two steps in opposite 
     * order, because there might not be enough space on the page to insert 
     * the postfix tuple first.)  We have to update the local copy of the 
     * prefixTuple too, because that's what will be written to WAL. 
     */ 
</span>    <a href="spgdoinsert.c.html#LN48"><span class='Ref_to_Func'>spgUpdateNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>childNodeN<span class='Delimiter'>, 
</span>                      <a href="spgdoinsert.c.html#LN1699"><span class='Ref_To_Local'>postfixBlkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1700"><span class='Ref_To_Local'>postfixOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                              <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN48"><span class='Ref_to_Func'>spgUpdateNodeLink</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>splitTuple<span class='Operator'>.</span>childNodeN<span class='Delimiter'>, 
</span>                      <a href="spgdoinsert.c.html#LN1699"><span class='Ref_To_Local'>postfixBlkno</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1700"><span class='Ref_To_Local'>postfixOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1844"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1695"><span class='Ref_To_Local'>prefixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1696"><span class='Ref_To_Local'>postfixTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1854"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN1854"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN34"><span class='Ref_to_Const'>REGBUF_STANDARD</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1702"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/spgxlog.h.html#LN147"><span class='Ref_to_Member'>newPage</span></a><span class='Parentheses'>) 
</span>                <a href="spgdoinsert.c.html#LN1854"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xloginsert.h.html#LN31"><span class='Ref_to_Const'>REGBUF_WILL_INIT</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN46"><span class='Ref_to_Proto'>XLogRegisterBuffer</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1854"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="spgdoinsert.c.html#LN1844"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_SPGIST_ID<span class='Delimiter'>, </span><a href="../../../include/access/spgxlog.h.html#LN24"><span class='Ref_to_Const'>XLOG_SPGIST_SPLIT_TUPLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1693"><span class='Ref_to_Parameter'>current</span></a><span class='Operator'>-&GT;</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1844"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1844"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationNeedsWAL(inde... &raquo; </span> 
 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update local free-space cache and release buffer */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1691"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1703"><span class='Ref_To_Local'>newBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end spgSplitNodeAction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Insert one item into the index. 
 * 
 * Returns true on success, false if we failed to complete the insertion 
 * because of conflict with a concurrent insert.  In the latter case, 
 * caller should re-call spgdoinsert() with the same args. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1890"></a><span class='Declare_Function'>spgdoinsert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, 
</span><a name="LN1891"></a>            <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>heapPtr</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>datum</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1893"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>level</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1894"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>leafDatum</span><span class='Delimiter'>; 
</span><a name="LN1895"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>leafSize</span><span class='Delimiter'>; 
</span><a name="LN1896"></a>    <a href="spgdoinsert.c.html#LN33"><span class='Ref_to_Struct'>SPPageDesc</span></a>  <span class='Declare_Local'>current</span><span class='Delimiter'>, 
</span><a name="LN1897"></a>                <span class='Declare_Local'>parent</span><span class='Delimiter'>; 
</span><a name="LN1898"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>procinfo</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up FmgrInfo of the user-defined choose function once, to save 
     * cycles in the loop below. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgdoinsert.c.html#LN1898"><span class='Ref_To_Local'>procinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist.h.html#LN28"><span class='Ref_to_Const'>SPGIST_CHOOSE_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we don't use index_form_tuple in this AM, we have to make sure 
     * value to be inserted is not toasted; FormIndexDatum doesn't guarantee 
     * that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>&& </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN121"><span class='Ref_to_Member'>attType</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN114"><span class='Ref_to_Member'>attlen</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>datum</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN204"><span class='Ref_to_Macro'>PG_DETOAST_DATUM</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="spgdoinsert.c.html#LN1894"><span class='Ref_To_Local'>leafDatum</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>datum</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute space needed for a leaf tuple containing the given datum. 
     * 
     * If it isn't gonna fit, and the opclass can't reduce the datum size by 
     * suffixing, bail out now rather than getting into an endless loop. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgdoinsert.c.html#LN1895"><span class='Ref_To_Local'>leafSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN300"><span class='Ref_to_Const'>SGLTHDRSZ</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>            <a href="../../../include/access/spgist_private.h.html#LN392"><span class='Ref_to_Proto'>SpGistGetTypeSize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN121"><span class='Ref_to_Member'>attType</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1894"><span class='Ref_To_Local'>leafDatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="spgdoinsert.c.html#LN1895"><span class='Ref_To_Local'>leafSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1895"><span class='Ref_To_Local'>leafSize</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a> <span class='Operator'>&& !</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN119"><span class='Ref_to_Member'>config</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN47"><span class='Ref_to_Member'>longValuesOK</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row size %zu exceeds maximum %zu for index \"%s\""</span><span class='Delimiter'>, 
</span>                   <a href="spgdoinsert.c.html#LN1895"><span class='Ref_To_Local'>leafSize</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Values larger than a buffer page cannot be indexed."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize "current" to the appropriate root page */ 
</span>    <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN26"><span class='Ref_to_Const'>SPGIST_NULL_BLKNO</span></a> <span class='Operator'>: </span><a href="../../../include/access/spgist_private.h.html#LN25"><span class='Ref_to_Const'>SPGIST_ROOT_BLKNO</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* "parent" is invalid for the moment */ 
</span>    <a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN39"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1954"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNew</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Bail out if query cancel is pending.  We must have this somewhere 
         * in the loop since a broken opclass could produce an infinite 
         * picksplit loop. 
         */ 
</span>        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Create a leaf page.  If leafSize is too large to fit on a page, 
             * we won't actually use the page yet, but it simplifies the API 
             * for doPickSplit to always have a leaf page at hand; so just 
             * quietly limit our request to a page size. 
             */ 
</span>            <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= 
</span>                <a href="spgutils.c.html#LN357"><span class='Ref_to_Func'>SpGistGetBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/access/spgist_private.h.html#LN373"><span class='Ref_to_Const'>GBUF_LEAF</span></a> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN375"><span class='Ref_to_Const'>GBUF_NULLS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1895"><span class='Ref_To_Local'>leafSize</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1954"><span class='Ref_To_Local'>isNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>== </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we hold no parent-page lock, so no deadlock is possible */ 
</span>            <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* descend to a new child page */ 
</span>            <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Attempt to acquire lock on child page.  We must beware of 
             * deadlock against another insertion process descending from that 
             * page to our parent page (see README).  If we fail to get lock, 
             * abandon the insertion and tell our caller to start over. 
             * 
             * XXX this could be improved, because failing to get lock on a 
             * buffer is not proof of a deadlock situation; the lock might be 
             * held by a reader, or even just background writer/checkpointer 
             * process.  Perhaps it'd be worth retrying after sleeping a bit? 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if current.blkno!=parent... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* inner tuple can be stored on the same page as parent one */ 
</span>            <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* should not arrive at a page of the wrong type */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a> <span class='Operator'>? !</span><a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>: 
</span>            <a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPGiST index page %u has wrong nulls flag"</span><span class='Delimiter'>, 
</span>                 <a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN35"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN58"><span class='Ref_to_Macro'>SpGistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2022"></a>            <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>leafTuple</span><span class='Delimiter'>; 
</span><a name="LN2023"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nToSplit</span><span class='Delimiter'>, 
</span><a name="LN2024"></a>                        <span class='Declare_Local'>sizeToSplit</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN393"><span class='Ref_to_Proto'>spgFormLeafTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>heapPtr</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1894"><span class='Ref_To_Local'>leafDatum</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= 
</span>                <a href="../../../include/access/spgist_private.h.html#LN347"><span class='Ref_to_Macro'>SpGistPageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* it fits on page, so insert it and we're done */ 
</span>                <a href="spgdoinsert.c.html#LN201"><span class='Ref_to_Func'>addLeafTuple</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1954"><span class='Ref_To_Local'>isNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="spgdoinsert.c.html#LN2024"><span class='Ref_To_Local'>sizeToSplit</span></a> <span class='Operator'>= 
</span>                      <a href="spgdoinsert.c.html#LN331"><span class='Ref_to_Func'>checkSplitConditions</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN2023"><span class='Ref_To_Local'>nToSplit</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a> <span class='Operator'>/ </span><span class='Number'>2</span> <span class='Operator'>&& 
</span>                     <a href="spgdoinsert.c.html#LN2023"><span class='Ref_To_Local'>nToSplit</span></a> <span class='Operator'>&LT; </span><span class='Number'>64</span> <span class='Operator'>&& 
</span>                     <a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="spgdoinsert.c.html#LN2024"><span class='Ref_To_Local'>sizeToSplit</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * the amount of data is pretty small, so just move the whole 
                 * chain to another leaf page rather than splitting it. 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1954"><span class='Ref_To_Local'>isNew</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="spgdoinsert.c.html#LN385"><span class='Ref_to_Func'>moveLeafs</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* we're done */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* picksplit */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN673"><span class='Ref_to_Func'>doPickSplit</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, 
</span>                                <a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1893"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1954"><span class='Ref_To_Local'>isNew</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* doPickSplit installed new tuples */ 
</span> 
                <span class='Comment_Multi_Line'>/* leaf tuple will not be inserted yet */ 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2022"><span class='Ref_To_Local'>leafTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * current now describes new inner tuple, go insert into it 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN58"><span class='Ref_to_Macro'>SpGistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="spgdoinsert.c.html#LN2082"><span class='Ref_to_Label'>process_inner_tuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SpGistPageIsLeaf(curr... &raquo; </span> 
        <span class='Control'>else</span>    <span class='Comment_Single_Line'>/* non-leaf page */ 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Apply the opclass choose function to figure out how to insert 
             * the given datum into the current inner tuple. 
             */ 
</span><a name="LN2072"></a>            <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Local'>innerTuple</span><span class='Delimiter'>; 
</span><a name="LN2073"></a>            <a href="../../../include/access/spgist.h.html#LN53"><span class='Ref_to_Struct'>spgChooseIn</span></a> <span class='Declare_Local'>in</span><span class='Delimiter'>; 
</span><a name="LN2074"></a>            <a href="../../../include/access/spgist.h.html#LN74"><span class='Ref_to_Struct'>spgChooseOut</span></a> <span class='Declare_Local'>out</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * spgAddNode and spgSplitTuple cases will loop back to here to 
             * complete the insertion operation.  Just in case the choose 
             * function is broken and produces add or split requests 
             * repeatedly, check for query cancel. 
             */ 
</span><a name="LN2082"></a>    <span class='Label'>process_inner_tuple</span><span class='Operator'>: 
</span>            <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN37"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN38"><span class='Ref_to_Member'>offnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN55"><span class='Ref_to_Member'>datum</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>datum</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN56"><span class='Ref_to_Member'>leafDatum</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1894"><span class='Ref_To_Local'>leafDatum</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN57"><span class='Ref_to_Member'>level</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN1893"><span class='Ref_To_Local'>level</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN60"><span class='Ref_to_Member'>allTheSame</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN212"><span class='Ref_to_Member'>allTheSame</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN61"><span class='Ref_to_Member'>hasPrefix</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN214"><span class='Ref_to_Member'>prefixSize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN62"><span class='Ref_to_Member'>prefixDatum</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN230"><span class='Ref_to_Macro'>SGITDATUM</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN63"><span class='Ref_to_Member'>nNodes</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; 
</span>            <a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN64"><span class='Ref_to_Member'>nodeLabels</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN403"><span class='Ref_to_Proto'>spgExtractNodeLabels</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* use user-defined choose method */ 
</span>                <a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1898"><span class='Ref_To_Local'>procinfo</span></a><span class='Delimiter'>, 
</span>                                  <a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                                  <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* force "match" action (to insert to random subnode) */ 
</span>                <a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN76"><span class='Ref_to_Member'>resultType</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN69"><span class='Ref_to_EnumConst'>spgMatchNode</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN212"><span class='Ref_to_Member'>allTheSame</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * It's not allowed to do an AddNode at an allTheSame tuple. 
                 * Opclass must say "match", in which case we choose a random 
                 * one of the nodes to descend into, or "split". 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN76"><span class='Ref_to_Member'>resultType</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist.h.html#LN70"><span class='Ref_to_EnumConst'>spgAddNode</span></a><span class='Parentheses'>) 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot add a node to an allTheSame inner tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN76"><span class='Ref_to_Member'>resultType</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist.h.html#LN69"><span class='Ref_to_EnumConst'>spgMatchNode</span></a><span class='Parentheses'>) 
</span>                    <a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>matchNode<span class='Operator'>.</span>nodeN <span class='Operator'>= </span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>% </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN76"><span class='Ref_to_Member'>resultType</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../../include/access/spgist.h.html#LN69"><span class='Ref_to_EnumConst'>spgMatchNode</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* Descend to N'th child node */ 
</span>                    <a href="spgdoinsert.c.html#LN1434"><span class='Ref_to_Func'>spgMatchNodeAction</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, 
</span>                                       <a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>matchNode<span class='Operator'>.</span>nodeN<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Adjust level as per opclass request */ 
</span>                    <a href="spgdoinsert.c.html#LN1893"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>+= </span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>matchNode<span class='Operator'>.</span>levelAdd<span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Replace leafDatum and recompute leafSize */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgdoinsert.c.html#LN1891"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="spgdoinsert.c.html#LN1894"><span class='Ref_To_Local'>leafDatum</span></a> <span class='Operator'>= </span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>matchNode<span class='Operator'>.</span>restDatum<span class='Delimiter'>; 
</span>                        <a href="spgdoinsert.c.html#LN1895"><span class='Ref_To_Local'>leafSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN300"><span class='Ref_to_Const'>SGLTHDRSZ</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                            <a href="../../../include/access/spgist_private.h.html#LN392"><span class='Ref_to_Proto'>SpGistGetTypeSize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN121"><span class='Ref_to_Member'>attType</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1894"><span class='Ref_To_Local'>leafDatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Loop around and attempt to insert the new leafDatum at 
                     * "current" (which might reference an existing child 
                     * tuple, or might be invalid to force us to find a new 
                     * page for the tuple). 
                     * 
                     * Note: if the opclass sets longValuesOK, we rely on the 
                     * choose function to eventually shorten the leafDatum 
                     * enough to fit on a page.  We could add a test here to 
                     * complain if the datum doesn't get visibly shorter each 
                     * time, but that could get in the way of opclasses that 
                     * "simplify" datums in a way that doesn't necessarily 
                     * lead to physical shortening on every cycle. 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../../include/access/spgist.h.html#LN70"><span class='Ref_to_EnumConst'>spgAddNode</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* AddNode is not sensible if nodes don't have labels */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN2073"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN64"><span class='Ref_to_Member'>nodeLabels</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot add a node to an inner tuple without node labels"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Add node to inner tuple, per request */ 
</span>                    <a href="spgdoinsert.c.html#LN1488"><span class='Ref_to_Func'>spgAddNodeAction</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, 
</span>                                     <a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>addNode<span class='Operator'>.</span>nodeN<span class='Delimiter'>, 
</span>                                     <a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN104"><span class='Ref_to_Member'>result</span></a><span class='Operator'>.</span>addNode<span class='Operator'>.</span>nodeLabel<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Retry insertion into the enlarged node.  We assume that 
                     * we'll get a MatchNode result this time. 
                     */ 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="spgdoinsert.c.html#LN2082"><span class='Ref_to_Label'>process_inner_tuple</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../../include/access/spgist.h.html#LN71"><span class='Ref_to_EnumConst'>spgSplitTuple</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* Split inner tuple, per request */ 
</span>                    <a href="spgdoinsert.c.html#LN1690"><span class='Ref_to_Func'>spgSplitNodeAction</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN2072"><span class='Ref_To_Local'>innerTuple</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Retry insertion into the split node */ 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="spgdoinsert.c.html#LN2082"><span class='Ref_to_Label'>process_inner_tuple</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized SPGiST choose result: %d"</span><span class='Delimiter'>, 
</span>                         <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="spgdoinsert.c.html#LN2074"><span class='Ref_To_Local'>out</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN76"><span class='Ref_to_Member'>resultType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch out.resultType &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span>                           <span class='Comment_Single_Line'>/* end loop */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release any buffers we're still holding.  Beware of possibility that 
     * current and parent reference same buffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a> <span class='Operator'>&& 
</span>        <a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>!= </span><a href="spgdoinsert.c.html#LN1896"><span class='Ref_To_Local'>current</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN388"><span class='Ref_to_Proto'>SpGistSetLastUsedPage</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1890"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgdoinsert.c.html#LN1897"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>.</span><a href="spgdoinsert.c.html#LN36"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgdoinsert &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>