<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\spgist\spgutils.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\spgist\spgutils.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:30 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * spgutils.c 
 *    various support functions for SP-GiST 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *          src/backend/access/spgist/spgutils.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/spgist_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/indexfsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/index_selfuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * SP-GiST handler function: return IndexAmRoutine with access method parameters 
 * and callbacks. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN34"></a><span class='Declare_Function'>spghandler</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN36"></a>    <a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amroutine</span> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN166"><span class='Ref_to_Member'>amstrategies</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN168"><span class='Ref_to_Member'>amsupport</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN32"><span class='Ref_to_Const'>SPGISTNProc</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN172"><span class='Ref_to_Member'>amcanorderbyop</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN174"><span class='Ref_to_Member'>amcanbackward</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN176"><span class='Ref_to_Member'>amcanunique</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN178"><span class='Ref_to_Member'>amcanmulticol</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN180"><span class='Ref_to_Member'>amoptionalkey</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN182"><span class='Ref_to_Member'>amsearcharray</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN184"><span class='Ref_to_Member'>amsearchnulls</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN186"><span class='Ref_to_Member'>amstorage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN188"><span class='Ref_to_Member'>amclusterable</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN190"><span class='Ref_to_Member'>ampredlocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN192"><span class='Ref_to_Member'>amcanparallel</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN194"><span class='Ref_to_Member'>amkeytype</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN197"><span class='Ref_to_Member'>ambuild</span></a> <span class='Operator'>= </span><a href="spginsert.c.html#LN68"><span class='Ref_to_Func'>spgbuild</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN198"><span class='Ref_to_Member'>ambuildempty</span></a> <span class='Operator'>= </span><a href="spginsert.c.html#LN155"><span class='Ref_to_Func'>spgbuildempty</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN199"><span class='Ref_to_Member'>aminsert</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN191"><span class='Ref_to_Proto'>spginsert</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN200"><span class='Ref_to_Member'>ambulkdelete</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN206"><span class='Ref_to_Proto'>spgbulkdelete</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN201"><span class='Ref_to_Member'>amvacuumcleanup</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN210"><span class='Ref_to_Proto'>spgvacuumcleanup</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN202"><span class='Ref_to_Member'>amcanreturn</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN203"><span class='Ref_to_Proto'>spgcanreturn</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN203"><span class='Ref_to_Member'>amcostestimate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/index_selfuncs.h.html#LN56"><span class='Ref_to_Proto'>spgcostestimate</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN204"><span class='Ref_to_Member'>amoptions</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN185"><span class='Ref_to_Proto'>spgoptions</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN205"><span class='Ref_to_Member'>amproperty</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN206"><span class='Ref_to_Member'>amvalidate</span></a> <span class='Operator'>= </span><a href="spgvalidate.c.html#LN36"><span class='Ref_to_Func'>spgvalidate</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN207"><span class='Ref_to_Member'>ambeginscan</span></a> <span class='Operator'>= </span><a href="spgscan.c.html#LN179"><span class='Ref_to_Func'>spgbeginscan</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN208"><span class='Ref_to_Member'>amrescan</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN199"><span class='Ref_to_Proto'>spgrescan</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN209"><span class='Ref_to_Member'>amgettuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN202"><span class='Ref_to_Proto'>spggettuple</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN210"><span class='Ref_to_Member'>amgetbitmap</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN201"><span class='Ref_to_Proto'>spggetbitmap</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN211"><span class='Ref_to_Member'>amendscan</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist.h.html#LN198"><span class='Ref_to_Proto'>spgendscan</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN212"><span class='Ref_to_Member'>ammarkpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN213"><span class='Ref_to_Member'>amrestrpos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN216"><span class='Ref_to_Member'>amestimateparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN217"><span class='Ref_to_Member'>aminitparallelscan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/amapi.h.html#LN218"><span class='Ref_to_Member'>amparallelrescan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN36"><span class='Ref_To_Local'>amroutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spghandler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Fill in a SpGistTypeDesc struct with info about the specified data type */ 
</span><span class='Keyword'>static void 
</span><a name="LN80"></a><span class='Declare_Function'>fillTypeDesc</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN110"><span class='Ref_to_Struct'>SpGistTypeDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="spgutils.c.html#LN80"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN112"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN80"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/lsyscache.h.html#LN135"><span class='Ref_to_Proto'>get_typlenbyval</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN80"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgutils.c.html#LN80"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN114"><span class='Ref_to_Member'>attlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgutils.c.html#LN80"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN113"><span class='Ref_to_Member'>attbyval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fetch local cache of AM-specific info about the index, initializing it 
 * if necessary 
 */ 
</span><a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>* 
</span><a name="LN91"></a><span class='Declare_Function'>spgGetCache</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN93"></a>    <a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN97"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>atttype</span><span class='Delimiter'>; 
</span><a name="LN98"></a>        <a href="../../../include/access/spgist.h.html#LN37"><span class='Ref_to_Struct'>spgConfigIn</span></a> <span class='Declare_Local'>in</span><span class='Delimiter'>; 
</span><a name="LN99"></a>        <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>procinfo</span><span class='Delimiter'>; 
</span><a name="LN100"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuffer</span><span class='Delimiter'>; 
</span><a name="LN101"></a>        <a href="../../../include/access/spgist_private.h.html#LN93"><span class='Ref_to_Struct'>SpGistMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN178"><span class='Ref_to_Member'>rd_indexcxt</span></a><span class='Delimiter'>, 
</span>                                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* SPGiST doesn't support multi-column indexes */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get the actual data type of the indexed column from the index 
         * tupdesc.  We pass this to the opclass config function so that 
         * polymorphic opclasses are possible. 
         */ 
</span>        <a href="spgutils.c.html#LN97"><span class='Ref_To_Local'>atttype</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Call the config function to get config info for the opclass */ 
</span>        <a href="spgutils.c.html#LN98"><span class='Ref_To_Local'>in</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN39"><span class='Ref_to_Member'>attType</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN97"><span class='Ref_To_Local'>atttype</span></a><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN99"><span class='Ref_To_Local'>procinfo</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN174"><span class='Ref_to_Proto'>index_getprocinfo</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist.h.html#LN27"><span class='Ref_to_Const'>SPGIST_CONFIG_PROC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN99"><span class='Ref_To_Local'>procinfo</span></a><span class='Delimiter'>, 
</span>                          <a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN192"><span class='Ref_to_Member'>rd_indcollation</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN98"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN178"><span class='Ref_to_Member'>config</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the information we need about each relevant datatype */ 
</span>        <a href="spgutils.c.html#LN79"><span class='Ref_to_Func'>fillTypeDesc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN180"><span class='Ref_to_Member'>attType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN97"><span class='Ref_To_Local'>atttype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN79"><span class='Ref_to_Func'>fillTypeDesc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN181"><span class='Ref_to_Member'>attPrefixType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN178"><span class='Ref_to_Member'>config</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN44"><span class='Ref_to_Member'>prefixType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN79"><span class='Ref_to_Func'>fillTypeDesc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN182"><span class='Ref_to_Member'>attLabelType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN178"><span class='Ref_to_Member'>config</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist.h.html#LN45"><span class='Ref_to_Member'>labelType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Last, get the lastUsedPages data from the metapage */ 
</span>        <a href="spgutils.c.html#LN100"><span class='Ref_To_Local'>metabuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN24"><span class='Ref_to_Const'>SPGIST_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN100"><span class='Ref_To_Local'>metabuffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN101"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN101"><span class='Ref_to_Macro'>SpGistPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN100"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN101"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN95"><span class='Ref_to_Member'>magicNumber</span></a> <span class='Operator'>!= </span><a href="../../../include/access/spgist_private.h.html#LN99"><span class='Ref_to_Const'>SPGIST_MAGIC_NUMBER</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"index \"%s\" is not an SP-GiST index"</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN184"><span class='Ref_to_Member'>lastUsedPages</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN101"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN96"><span class='Ref_to_Member'>lastUsedPages</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN100"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if index-&GT;rd_amcache==NU... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* assume it's up to date */ 
</span>        <a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgutils.c.html#LN91"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN93"><span class='Ref_To_Local'>cache</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgGetCache &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Initialize SpGistState for working with the given index */ 
</span><span class='Keyword'>void 
</span><a name="LN157"></a><span class='Declare_Function'>initSpGistState</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN159"></a>    <a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get cached static information about index */ 
</span>    <a href="spgutils.c.html#LN159"><span class='Ref_To_Local'>cache</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN90"><span class='Ref_to_Func'>spgGetCache</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN119"><span class='Ref_to_Member'>config</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN159"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN178"><span class='Ref_to_Member'>config</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN121"><span class='Ref_to_Member'>attType</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN159"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN180"><span class='Ref_to_Member'>attType</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN122"><span class='Ref_to_Member'>attPrefixType</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN159"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN181"><span class='Ref_to_Member'>attPrefixType</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN123"><span class='Ref_to_Member'>attLabelType</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN159"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN182"><span class='Ref_to_Member'>attLabelType</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make workspace for constructing dead tuples */ 
</span>    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN125"><span class='Ref_to_Member'>deadTupleStorage</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set XID to use in redirection tuples */ 
</span>    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN127"><span class='Ref_to_Member'>myXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN332"><span class='Ref_to_Proto'>GetTopTransactionIdIfAny</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assume we're not in an index build (spgbuild will override) */ 
</span>    <a href="spgutils.c.html#LN157"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN128"><span class='Ref_to_Member'>isBuild</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initSpGistState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate a new page (either by recycling, or by extending the index file). 
 * 
 * The returned buffer is already pinned and exclusive-locked. 
 * Caller is responsible for initializing the page by calling SpGistInitBuffer. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN186"></a><span class='Declare_Function'>SpGistNewBuffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN188"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN189"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needLock</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First, try to get a page from FSM */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN194"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../../include/storage/indexfsm.h.html#LN19"><span class='Ref_to_Proto'>GetFreeIndexPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN186"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN194"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* nothing known to FSM */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The fixed pages shouldn't ever be listed in FSM, but just in case 
         * one is, ignore it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN31"><span class='Ref_to_Macro'>SpGistBlockIsFixed</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN194"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN186"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN194"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have to guard against the possibility that someone else already 
         * recycled this page; the buffer may be locked if so. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN214"></a>            <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OK to use, if never initialized */ 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN57"><span class='Ref_to_Macro'>SpGistPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN214"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OK to use */ 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Can't use it, so release buffer and try again */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Must extend the file */ 
</span>    <a href="spgutils.c.html#LN189"><span class='Ref_To_Local'>needLock</span></a> <span class='Operator'>= !</span><a href="../../../include/utils/rel.h.html#LN523"><span class='Ref_to_Macro'>RELATION_IS_LOCAL</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN186"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN189"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN186"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN186"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN81"><span class='Ref_to_Const'>P_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN189"><span class='Ref_To_Local'>needLock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN186"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN188"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SpGistNewBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update index metapage's lastUsedPages info from local cache, if possible 
 * 
 * Updating meta page isn't critical for index working, so 
 * 1 use ConditionalLockBuffer to improve concurrency 
 * 2 don't WAL-log metabuffer changes to decrease WAL traffic 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN251"></a><span class='Declare_Function'>SpGistUpdateMetaPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN253"></a>    <a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="spgutils.c.html#LN251"><span class='Ref_to_Parameter'>index</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN191"><span class='Ref_to_Member'>rd_amcache</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN253"><span class='Ref_To_Local'>cache</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN257"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>metabuffer</span><span class='Delimiter'>; 
</span><a name="LN258"></a>        <a href="../../../include/access/spgist_private.h.html#LN93"><span class='Ref_to_Struct'>SpGistMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN257"><span class='Ref_To_Local'>metabuffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN251"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN24"><span class='Ref_to_Const'>SPGIST_METAPAGE_BLKNO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN257"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="spgutils.c.html#LN258"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN101"><span class='Ref_to_Macro'>SpGistPageGetMeta</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN257"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="spgutils.c.html#LN258"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN96"><span class='Ref_to_Member'>lastUsedPages</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN253"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN184"><span class='Ref_to_Member'>lastUsedPages</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN257"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN257"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN257"><span class='Ref_To_Local'>metabuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cache!=NULL &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SpGistUpdateMetaPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Macro to select proper element of lastUsedPages cache depending on flags */ 
/* Masking flags with SPGIST_CACHED_PAGES is just for paranoia's sake */ 
</span><a name="LN279"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>GET_LUP</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>f</span><span class='Parentheses'>)</span>  <span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="spgutils.c.html#LN279"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>lastUsedPages<span class='Operator'>.</span>cachedPage<span class='Delimiter'>[</span><span class='Parentheses'>((</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) (</span><a href="spgutils.c.html#LN279"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>))</span> <span class='Operator'>% </span><a href="../../../include/access/spgist_private.h.html#LN83"><span class='Ref_to_Const'>SPGIST_CACHED_PAGES</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate and initialize a new buffer of the type and parity specified by 
 * flags.  The returned buffer is already pinned and exclusive-locked. 
 * 
 * When requesting an inner page, if we get one with the wrong parity, 
 * we just release the buffer and try again.  We will get a different page 
 * because GetFreeIndexPage will have marked the page used in FSM.  The page 
 * is entered in our local lastUsedPages cache, so there's some hope of 
 * making use of it later in this session, but otherwise we rely on VACUUM 
 * to eventually re-enter the page in FSM, making it available for recycling. 
 * Note that such a page does not get marked dirty here, so unless it's used 
 * fairly soon, the buffer will just get discarded and the page will remain 
 * as it was on disk. 
 * 
 * When we return a buffer to the caller, the page is *not* entered into 
 * the lastUsedPages cache; we expect the caller will do so after it's taken 
 * whatever space it will use.  This is because after the caller has used up 
 * some space, the page might have less space than whatever was cached already 
 * so we'd rather not trash the old cache entry. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN302"></a><span class='Declare_Function'>allocNewBuffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN304"></a>    <a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache</span> <span class='Operator'>= </span><a href="spgutils.c.html#LN90"><span class='Ref_to_Func'>spgGetCache</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN302"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN305"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>pageflags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN378"><span class='Ref_to_Macro'>GBUF_REQ_LEAF</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN302"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>))</span> 
        <a href="spgutils.c.html#LN305"><span class='Ref_To_Local'>pageflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/spgist_private.h.html#LN52"><span class='Ref_to_Const'>SPGIST_LEAF</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN379"><span class='Ref_to_Macro'>GBUF_REQ_NULLS</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN302"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>))</span> 
        <a href="spgutils.c.html#LN305"><span class='Ref_To_Local'>pageflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/spgist_private.h.html#LN53"><span class='Ref_to_Const'>SPGIST_NULLS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN314"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN185"><span class='Ref_to_Func'>SpGistNewBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN302"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/spgist_private.h.html#LN390"><span class='Ref_to_Proto'>SpGistInitBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN305"><span class='Ref_To_Local'>pageflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN305"><span class='Ref_To_Local'>pageflags</span></a> <span class='Operator'>& </span><a href="../../../include/access/spgist_private.h.html#LN52"><span class='Ref_to_Const'>SPGIST_LEAF</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Leaf pages have no parity concerns, so just use it */ 
</span>            <span class='Control'>return</span> <a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN326"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN327"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>blkFlags</span> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN374"><span class='Ref_to_Macro'>GBUF_INNER_PARITY</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN326"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="spgutils.c.html#LN302"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/spgist_private.h.html#LN377"><span class='Ref_to_Const'>GBUF_PARITY_MASK</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="spgutils.c.html#LN327"><span class='Ref_To_Local'>blkFlags</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Page has right parity, use it */ 
</span>                <span class='Control'>return</span> <a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Page has wrong parity, record it in cache and try again */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN305"><span class='Ref_To_Local'>pageflags</span></a> <span class='Operator'>& </span><a href="../../../include/access/spgist_private.h.html#LN53"><span class='Ref_to_Const'>SPGIST_NULLS</span></a><span class='Parentheses'>) 
</span>                    <a href="spgutils.c.html#LN327"><span class='Ref_To_Local'>blkFlags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/spgist_private.h.html#LN375"><span class='Ref_to_Const'>GBUF_NULLS</span></a><span class='Delimiter'>; 
</span>                <a href="spgutils.c.html#LN304"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN184"><span class='Ref_to_Member'>lastUsedPages</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN87"><span class='Ref_to_Member'>cachedPage</span></a><span class='Delimiter'>[</span><a href="spgutils.c.html#LN327"><span class='Ref_To_Local'>blkFlags</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN326"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>                <a href="spgutils.c.html#LN304"><span class='Ref_To_Local'>cache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN184"><span class='Ref_to_Member'>lastUsedPages</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN87"><span class='Ref_to_Member'>cachedPage</span></a><span class='Delimiter'>[</span><a href="spgutils.c.html#LN327"><span class='Ref_To_Local'>blkFlags</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN79"><span class='Ref_to_Member'>freeSpace</span></a> <span class='Operator'>= 
</span>                    <a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN314"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end allocNewBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get a buffer of the type and parity specified by flags, having at least 
 * as much free space as indicated by needSpace.  We use the lastUsedPages 
 * cache to assign the same buffer previously requested when possible. 
 * The returned buffer is already pinned and exclusive-locked. 
 * 
 * *isNew is set true if the page was initialized here, false if it was 
 * already valid. 
 */ 
</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> 
<a name="LN358"></a><span class='Declare_Function'>SpGistGetBuffer</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>needSpace</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>isNew</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN360"></a>    <a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache</span> <span class='Operator'>= </span><a href="spgutils.c.html#LN90"><span class='Ref_to_Func'>spgGetCache</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN361"></a>    <a href="../../../include/access/spgist_private.h.html#LN76"><span class='Ref_to_Struct'>SpGistLastUsedPage</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Bail out if even an empty page wouldn't meet the demand */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"desired SPGiST tuple size is too big"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If possible, increase the space request to include relation's 
     * fillfactor.  This ensures that when we add unrelated tuples to a page, 
     * we try to keep 100-fillfactor% available for adding tuples that are 
     * related to the ones already on it.  But fillfactor mustn't cause an 
     * error for requests that would otherwise be legal. 
     */ 
</span>    <a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/rel.h.html#LN307"><span class='Ref_to_Macro'>RelationGetTargetPageFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/access/spgist.h.html#LN24"><span class='Ref_to_Const'>SPGIST_DEFAULT_FILLFACTOR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the cache entry for this flags setting */ 
</span>    <a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN279"><span class='Ref_to_Macro'>GET_LUP</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN360"><span class='Ref_To_Local'>cache</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we have nothing cached, just turn it over to allocNewBuffer */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>isNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="spgutils.c.html#LN301"><span class='Ref_to_Func'>allocNewBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* fixed pages should never be in cache */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/spgist_private.h.html#LN31"><span class='Ref_to_Macro'>SpGistBlockIsFixed</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If cached freeSpace isn't enough, don't bother looking at the page */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN79"><span class='Ref_to_Member'>freeSpace</span></a> <span class='Operator'>&GT;= </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN394"></a>        <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN395"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
        <a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN167"><span class='Ref_to_Proto'>ReadBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufmgr.h.html#LN215"><span class='Ref_to_Proto'>ConditionalLockBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * buffer is locked by another process, so return a new buffer 
             */ 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>isNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="spgutils.c.html#LN301"><span class='Ref_to_Func'>allocNewBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/spgist_private.h.html#LN57"><span class='Ref_to_Macro'>SpGistPageIsDeleted</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* OK to initialize the page */ 
</span><a name="LN414"></a>            <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>pageflags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN378"><span class='Ref_to_Macro'>GBUF_REQ_LEAF</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>))</span> 
                <a href="spgutils.c.html#LN414"><span class='Ref_To_Local'>pageflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/spgist_private.h.html#LN52"><span class='Ref_to_Const'>SPGIST_LEAF</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN379"><span class='Ref_to_Macro'>GBUF_REQ_NULLS</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>))</span> 
                <a href="spgutils.c.html#LN414"><span class='Ref_To_Local'>pageflags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/spgist_private.h.html#LN53"><span class='Ref_to_Const'>SPGIST_NULLS</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/spgist_private.h.html#LN390"><span class='Ref_to_Proto'>SpGistInitBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN414"><span class='Ref_To_Local'>pageflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN79"><span class='Ref_to_Member'>freeSpace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>isNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check that page is of right type and has enough space.  We must 
         * recheck this since our cache isn't necessarily up to date. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/access/spgist_private.h.html#LN378"><span class='Ref_to_Macro'>GBUF_REQ_LEAF</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN58"><span class='Ref_to_Macro'>SpGistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>: !</span><a href="../../../include/access/spgist_private.h.html#LN58"><span class='Ref_to_Macro'>SpGistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN379"><span class='Ref_to_Macro'>GBUF_REQ_NULLS</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>: !</span><a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN433"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>freeSpace</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN395"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN433"><span class='Ref_To_Local'>freeSpace</span></a> <span class='Operator'>&GT;= </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Success, update freespace info and return the buffer */ 
</span>                <a href="spgutils.c.html#LN361"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN79"><span class='Ref_to_Member'>freeSpace</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN433"><span class='Ref_To_Local'>freeSpace</span></a> <span class='Operator'>- </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>needSpace</span></a><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>isNew</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * fallback to allocation of new buffer 
         */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN394"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if lup-&GT;freeSpace&GT;=needS... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* No success with cache, so return a new buffer */ 
</span>    <span class='Operator'>*</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>isNew</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="spgutils.c.html#LN301"><span class='Ref_to_Func'>allocNewBuffer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN358"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SpGistGetBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update lastUsedPages cache when done modifying a page. 
 * 
 * We update the appropriate cache entry if it already contained this page 
 * (its freeSpace is likely obsolete), or if this page has more space than 
 * whatever we had cached. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN463"></a><span class='Declare_Function'>SpGistSetLastUsedPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN465"></a>    <a href="../../../include/access/spgist_private.h.html#LN176"><span class='Ref_to_Struct'>SpGistCache</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache</span> <span class='Operator'>= </span><a href="spgutils.c.html#LN90"><span class='Ref_to_Func'>spgGetCache</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN463"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN466"></a>    <a href="../../../include/access/spgist_private.h.html#LN76"><span class='Ref_to_Struct'>SpGistLastUsedPage</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lup</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>freeSpace</span><span class='Delimiter'>; 
</span><a name="LN468"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN463"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN469"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN463"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN470"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Never enter fixed pages (root pages) in cache, though */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN31"><span class='Ref_to_Macro'>SpGistBlockIsFixed</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN469"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN58"><span class='Ref_to_Macro'>SpGistPageIsLeaf</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN468"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="spgutils.c.html#LN470"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN373"><span class='Ref_to_Const'>GBUF_LEAF</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="spgutils.c.html#LN470"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN374"><span class='Ref_to_Macro'>GBUF_INNER_PARITY</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN469"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN59"><span class='Ref_to_Macro'>SpGistPageStoresNulls</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN468"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <a href="spgutils.c.html#LN470"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../../include/access/spgist_private.h.html#LN375"><span class='Ref_to_Const'>GBUF_NULLS</span></a><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN466"><span class='Ref_To_Local'>lup</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN279"><span class='Ref_to_Macro'>GET_LUP</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN465"><span class='Ref_To_Local'>cache</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN470"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN467"><span class='Ref_To_Local'>freeSpace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN468"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN466"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a> <span class='Operator'>|| </span><a href="spgutils.c.html#LN466"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>== </span><a href="spgutils.c.html#LN469"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>|| 
</span>        <a href="spgutils.c.html#LN466"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN79"><span class='Ref_to_Member'>freeSpace</span></a> <span class='Operator'>&LT; </span><a href="spgutils.c.html#LN467"><span class='Ref_To_Local'>freeSpace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="spgutils.c.html#LN466"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN469"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN466"><span class='Ref_To_Local'>lup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN79"><span class='Ref_to_Member'>freeSpace</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN467"><span class='Ref_To_Local'>freeSpace</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end SpGistSetLastUsedPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize an SPGiST page to empty, with specified flags 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN498"></a><span class='Declare_Function'>SpGistInitPage</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN500"></a>    <a href="../../../include/access/spgist_private.h.html#LN46"><span class='Ref_to_Typedef'>SpGistPageOpaque</span></a> <span class='Declare_Local'>opaque</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN498"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN37"><span class='Ref_to_Struct'>SpGistPageOpaqueData</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN500"><span class='Ref_To_Local'>opaque</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN498"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="spgutils.c.html#LN500"><span class='Ref_To_Local'>opaque</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN37"><span class='Ref_to_Struct'>SpGistPageOpaqueData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN500"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN39"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN498"><span class='Ref_to_Parameter'>f</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN500"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN43"><span class='Ref_to_Member'>spgist_page_id</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN69"><span class='Ref_to_Const'>SPGIST_PAGE_ID</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize a buffer's page to empty, with specified flags 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN513"></a><span class='Declare_Function'>SpGistInitBuffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>b</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN513"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/spgist_private.h.html#LN389"><span class='Ref_to_Proto'>SpGistInitPage</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN513"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="spgutils.c.html#LN513"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize metadata page 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN523"></a><span class='Declare_Function'>SpGistInitMetapage</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN525"></a>    <a href="../../../include/access/spgist_private.h.html#LN93"><span class='Ref_to_Struct'>SpGistMetaPageData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>metadata</span><span class='Delimiter'>; 
</span><a name="LN526"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/spgist_private.h.html#LN389"><span class='Ref_to_Proto'>SpGistInitPage</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN523"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN49"><span class='Ref_to_Const'>SPGIST_META</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN525"><span class='Ref_To_Local'>metadata</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN101"><span class='Ref_to_Macro'>SpGistPageGetMeta</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN523"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="spgutils.c.html#LN525"><span class='Ref_To_Local'>metadata</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN93"><span class='Ref_to_Struct'>SpGistMetaPageData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN525"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN95"><span class='Ref_to_Member'>magicNumber</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN99"><span class='Ref_to_Const'>SPGIST_MAGIC_NUMBER</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize last-used-page cache to empty */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN526"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgutils.c.html#LN526"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/spgist_private.h.html#LN83"><span class='Ref_to_Const'>SPGIST_CACHED_PAGES</span></a><span class='Delimiter'>; </span><a href="spgutils.c.html#LN526"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN525"><span class='Ref_To_Local'>metadata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN96"><span class='Ref_to_Member'>lastUsedPages</span></a><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN87"><span class='Ref_to_Member'>cachedPage</span></a><span class='Delimiter'>[</span><a href="spgutils.c.html#LN526"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/spgist_private.h.html#LN78"><span class='Ref_to_Member'>blkno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * reloptions processing for SPGiST 
 */ 
</span><a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>* 
</span><a name="LN542"></a><span class='Declare_Function'>spgoptions</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>validate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/access/reloptions.h.html#LN272"><span class='Ref_to_Proto'>default_reloptions</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN542"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN542"><span class='Ref_to_Parameter'>validate</span></a><span class='Delimiter'>, </span><a href="../../../include/access/reloptions.h.html#LN47"><span class='Ref_to_EnumConst'>RELOPT_KIND_SPGIST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get the space needed to store a non-null datum of the indicated type. 
 * Note the result is already rounded up to a MAXALIGN boundary. 
 * Also, we follow the SPGiST convention that pass-by-val types are 
 * just stored in their Datum representation (compare memcpyDatum). 
 */ 
</span><span class='Keyword'>unsigned int 
</span><a name="LN554"></a><span class='Declare_Function'>SpGistGetTypeSize</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN110"><span class='Ref_to_Struct'>SpGistTypeDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>att</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>datum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN556"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN554"><span class='Ref_to_Parameter'>att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN113"><span class='Ref_to_Member'>attbyval</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN556"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN554"><span class='Ref_to_Parameter'>att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN114"><span class='Ref_to_Member'>attlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN556"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN554"><span class='Ref_to_Parameter'>att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN114"><span class='Ref_to_Member'>attlen</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="spgutils.c.html#LN556"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN554"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN556"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Copy the given non-null datum to *target 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN572"></a><span class='Declare_Function'>memcpyDatum</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>target</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN110"><span class='Ref_to_Struct'>SpGistTypeDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>att</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>datum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN574"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN113"><span class='Ref_to_Member'>attbyval</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>target</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>datum</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="spgutils.c.html#LN574"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN114"><span class='Ref_to_Member'>attlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>att</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN114"><span class='Ref_to_Member'>attlen</span></a> <span class='Operator'>: </span><a href="../../../include/postgres.h.html#LN333"><span class='Ref_to_Macro'>VARSIZE_ANY</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>target</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN572"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="spgutils.c.html#LN574"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Construct a leaf tuple containing the given heap TID and datum value 
 */ 
</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> 
<a name="LN591"></a><span class='Declare_Function'>spgFormLeafTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>heapPtr</span><span class='Delimiter'>, 
</span><a name="LN592"></a>                 <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>datum</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN594"></a>    <a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a> <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN595"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* compute space needed (note result is already maxaligned) */ 
</span>    <a href="spgutils.c.html#LN595"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN300"><span class='Ref_to_Const'>SGLTHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgutils.c.html#LN592"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN595"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="../../../include/access/spgist_private.h.html#LN392"><span class='Ref_to_Proto'>SpGistGetTypeSize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN591"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN121"><span class='Ref_to_Member'>attType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN592"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that we can replace the tuple with a dead tuple later.  This 
     * test is unnecessary when !isnull, but let's be safe. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN595"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN595"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, form the tuple */ 
</span>    <a href="spgutils.c.html#LN594"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN298"><span class='Ref_to_Typedef'>SpGistLeafTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN595"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN594"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN292"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN595"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN594"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN293"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN594"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN294"><span class='Ref_to_Member'>heapPtr</span></a> <span class='Operator'>= *</span><a href="spgutils.c.html#LN591"><span class='Ref_to_Parameter'>heapPtr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgutils.c.html#LN592"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN571"><span class='Ref_to_Func'>memcpyDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN301"><span class='Ref_to_Macro'>SGLTDATAPTR</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN594"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgutils.c.html#LN591"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN121"><span class='Ref_to_Member'>attType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN592"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN594"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgFormLeafTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct a node (to go into an inner tuple) containing the given label 
 * 
 * Note that the node's downlink is just set invalid here.  Caller will fill 
 * it in later. 
 */ 
</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> 
<a name="LN628"></a><span class='Declare_Function'>spgFormNodeTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>label</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN630"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN631"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN632"></a>    <span class='Keyword'>unsigned short </span><span class='Declare_Local'>infomask</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* compute space needed (note result is already maxaligned) */ 
</span>    <a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN257"><span class='Ref_to_Const'>SGNTHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="../../../include/access/spgist_private.h.html#LN392"><span class='Ref_to_Proto'>SpGistGetTypeSize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN123"><span class='Ref_to_Member'>attLabelType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>label</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Here we make sure that the size will fit in the field reserved for it 
     * in t_info. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>& </span><a href="../../../include/access/itup.h.html#LN64"><span class='Ref_to_Const'>INDEX_SIZE_MASK</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index row requires %zu bytes, maximum size is %zu"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="../../../include/access/itup.h.html#LN64"><span class='Ref_to_Const'>INDEX_SIZE_MASK</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN630"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN632"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>|= </span><a href="../../../include/access/itup.h.html#LN67"><span class='Ref_to_Const'>INDEX_NULL_MASK</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* we don't bother setting the INDEX_VAR_MASK bit */ 
</span>    <a href="spgutils.c.html#LN632"><span class='Ref_To_Local'>infomask</span></a> <span class='Operator'>|= </span><a href="spgutils.c.html#LN631"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN630"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN48"><span class='Ref_to_Member'>t_info</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN632"><span class='Ref_To_Local'>infomask</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The TID field will be filled in later */ 
</span>    <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN630"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/itup.h.html#LN36"><span class='Ref_to_Member'>t_tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN571"><span class='Ref_to_Func'>memcpyDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN258"><span class='Ref_to_Macro'>SGNTDATAPTR</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN630"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN123"><span class='Ref_to_Member'>attLabelType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN628"><span class='Ref_to_Parameter'>label</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN630"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgFormNodeTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct an inner tuple containing the given prefix and node array 
 */ 
</span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> 
<a name="LN670"></a><span class='Declare_Function'>spgFormInnerTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>hasPrefix</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>prefix</span><span class='Delimiter'>, 
</span><a name="LN671"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>nNodes</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nodes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN673"></a>    <a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN674"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN675"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>prefixSize</span><span class='Delimiter'>; 
</span><a name="LN676"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN677"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compute size needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN670"><span class='Ref_to_Parameter'>hasPrefix</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN675"><span class='Ref_To_Local'>prefixSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN392"><span class='Ref_to_Proto'>SpGistGetTypeSize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN670"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN122"><span class='Ref_to_Member'>attPrefixType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN670"><span class='Ref_to_Parameter'>prefix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="spgutils.c.html#LN675"><span class='Ref_To_Local'>prefixSize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN227"><span class='Ref_to_Const'>SGITHDRSZ</span></a> <span class='Operator'>+ </span><a href="spgutils.c.html#LN675"><span class='Ref_To_Local'>prefixSize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Note: we rely on node tuple sizes to be maxaligned already */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgutils.c.html#LN671"><span class='Ref_to_Parameter'>nNodes</span></a><span class='Delimiter'>; </span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN671"><span class='Ref_to_Parameter'>nodes</span></a><span class='Delimiter'>[</span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that we can replace the tuple with a dead tuple later.  This 
     * test is unnecessary given current tuple layouts, but let's be safe. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Inner tuple should be small enough to fit on a page 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SP-GiST inner tuple size %zu exceeds maximum %zu"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/access/spgist_private.h.html#LN338"><span class='Ref_to_Const'>SPGIST_PAGE_CAPACITY</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Values larger than a buffer page cannot be indexed."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for overflow of header fields --- probably can't fail if the 
     * above succeeded, but let's be paranoid 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN225"><span class='Ref_to_Const'>SGITMAXSIZE</span></a> <span class='Operator'>|| 
</span>        <a href="spgutils.c.html#LN675"><span class='Ref_To_Local'>prefixSize</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN224"><span class='Ref_to_Const'>SGITMAXPREFIXSIZE</span></a> <span class='Operator'>|| 
</span>        <a href="spgutils.c.html#LN671"><span class='Ref_to_Parameter'>nNodes</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/spgist_private.h.html#LN223"><span class='Ref_to_Const'>SGITMAXNNODES</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPGiST inner tuple header field is too small"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, form the tuple */ 
</span>    <a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN671"><span class='Ref_to_Parameter'>nNodes</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN214"><span class='Ref_to_Member'>prefixSize</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN675"><span class='Ref_To_Local'>prefixSize</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN215"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN674"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN670"><span class='Ref_to_Parameter'>hasPrefix</span></a><span class='Parentheses'>) 
</span>        <a href="spgutils.c.html#LN571"><span class='Ref_to_Func'>memcpyDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN229"><span class='Ref_to_Macro'>SGITDATAPTR</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="spgutils.c.html#LN670"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN122"><span class='Ref_to_Member'>attPrefixType</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN670"><span class='Ref_to_Parameter'>prefix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN677"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/spgist_private.h.html#LN235"><span class='Ref_to_Macro'>SGITNODEPTR</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="spgutils.c.html#LN671"><span class='Ref_to_Parameter'>nNodes</span></a><span class='Delimiter'>; </span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN732"></a>        <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span> <span class='Operator'>= </span><a href="spgutils.c.html#LN671"><span class='Ref_to_Parameter'>nodes</span></a><span class='Delimiter'>[</span><a href="spgutils.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="spgutils.c.html#LN677"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN732"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>, </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN732"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN677"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="../../../include/access/itup.h.html#LN69"><span class='Ref_to_Macro'>IndexTupleSize</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN732"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN673"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgFormInnerTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct a "dead" tuple to replace a tuple being deleted. 
 * 
 * The state can be SPGIST_REDIRECT, SPGIST_DEAD, or SPGIST_PLACEHOLDER. 
 * For a REDIRECT tuple, a pointer (blkno+offset) must be supplied, and 
 * the xid field is filled in automatically. 
 * 
 * This is called in critical sections, so we don't use palloc; the tuple 
 * is built in preallocated storage.  It should be copied before another 
 * call with different parameters can occur. 
 */ 
</span><a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a> 
<a name="LN753"></a><span class='Declare_Function'>spgFormDeadTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tupstate</span><span class='Delimiter'>, 
</span><a name="LN754"></a>                 <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN756"></a>    <a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a> <span class='Declare_Local'>tuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a><span class='Parentheses'>) </span><a href="spgutils.c.html#LN753"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN125"><span class='Ref_to_Member'>deadTupleStorage</span></a><span class='Delimiter'>; 
</span> 
    <a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN319"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN753"><span class='Ref_to_Parameter'>tupstate</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN320"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a><span class='Delimiter'>; 
</span>    <a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN321"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN753"><span class='Ref_to_Parameter'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN197"><span class='Ref_to_Const'>SPGIST_REDIRECT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN322"><span class='Ref_to_Member'>pointer</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN754"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN754"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN753"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN127"><span class='Ref_to_Member'>myXid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN323"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN753"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN127"><span class='Ref_to_Member'>myXid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/itemptr.h.html#LN148"><span class='Ref_to_Macro'>ItemPointerSetInvalid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN322"><span class='Ref_to_Member'>pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN323"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN756"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end spgFormDeadTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Extract the label datums of the nodes within innerTuple 
 * 
 * Returns NULL if label datums are NULLs 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>* 
</span><a name="LN783"></a><span class='Declare_Function'>spgExtractNodeLabels</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/spgist_private.h.html#LN220"><span class='Ref_to_Typedef'>SpGistInnerTuple</span></a> <span class='Declare_Parameter'>innerTuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN785"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>nodeLabels</span><span class='Delimiter'>; 
</span><a name="LN786"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN787"></a>    <a href="../../../include/access/spgist_private.h.html#LN255"><span class='Ref_to_Typedef'>SpGistNodeTuple</span></a> <span class='Declare_Local'>node</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Either all the labels must be NULL, or none. */ 
</span>    <a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN235"><span class='Ref_to_Macro'>SGITNODEPTR</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN783"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN71"><span class='Ref_to_Macro'>IndexTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN783"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN786"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/itup.h.html#LN71"><span class='Ref_to_Macro'>IndexTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"some but not all node labels are null in SPGiST inner tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* They're all null, so just return NULL */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="spgutils.c.html#LN785"><span class='Ref_To_Local'>nodeLabels</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="spgutils.c.html#LN783"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN213"><span class='Ref_to_Member'>nNodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/spgist_private.h.html#LN238"><span class='Ref_to_Macro'>SGITITERATE</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN783"><span class='Ref_to_Parameter'>innerTuple</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN786"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/itup.h.html#LN71"><span class='Ref_to_Macro'>IndexTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"some but not all node labels are null in SPGiST inner tuple"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="spgutils.c.html#LN785"><span class='Ref_To_Local'>nodeLabels</span></a><span class='Delimiter'>[</span><a href="spgutils.c.html#LN786"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN259"><span class='Ref_to_Macro'>SGNTDATUM</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN787"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN783"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <a href="spgutils.c.html#LN785"><span class='Ref_To_Local'>nodeLabels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end spgExtractNodeLabels &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a new item to the page, replacing a PLACEHOLDER item if possible. 
 * Return the location it's inserted at, or InvalidOffsetNumber on failure. 
 * 
 * If startOffset isn't NULL, we start searching for placeholders at 
 * *startOffset, and update that to the next place to search.  This is just 
 * an optimization for repeated insertions. 
 * 
 * If errorOK is false, we throw error when there's not enough room, 
 * rather than returning InvalidOffsetNumber. 
 */ 
</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> 
<a name="LN826"></a><span class='Declare_Function'>SpGistPageAddNewItem</span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN117"><span class='Ref_to_Struct'>SpGistState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a> <span class='Declare_Parameter'>item</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Delimiter'>, 
</span><a name="LN827"></a>                     <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>startOffset</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>errorOK</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN829"></a>    <a href="../../../include/access/spgist_private.h.html#LN46"><span class='Ref_to_Typedef'>SpGistPageOpaque</span></a> <span class='Declare_Local'>opaque</span> <span class='Operator'>= </span><a href="../../../include/access/spgist_private.h.html#LN55"><span class='Ref_to_Macro'>SpGistPageGetOpaque</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN830"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN831"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>, 
</span><a name="LN832"></a>                <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN829"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN41"><span class='Ref_to_Member'>nPlaceholder</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <a href="../../../include/storage/bufpage.h.html#LN428"><span class='Ref_to_Proto'>PageGetExactFreeSpace</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../../include/access/spgist_private.h.html#LN328"><span class='Ref_to_Const'>SGDTSIZE</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Try to replace a placeholder */ 
</span>        <a href="spgutils.c.html#LN831"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a> <span class='Operator'>&& *</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>                <a href="spgutils.c.html#LN830"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= *</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="spgutils.c.html#LN830"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="spgutils.c.html#LN830"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="spgutils.c.html#LN831"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; </span><a href="spgutils.c.html#LN830"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN849"></a>                <a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a> <span class='Declare_Local'>it</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/spgist_private.h.html#LN326"><span class='Ref_to_Typedef'>SpGistDeadTuple</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, 
</span>                                                     <a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN830"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN849"><span class='Ref_To_Local'>it</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN319"><span class='Ref_to_Member'>tupstate</span></a> <span class='Operator'>== </span><a href="../../../include/access/spgist_private.h.html#LN199"><span class='Ref_to_Const'>SPGIST_PLACEHOLDER</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN830"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Done if we found a placeholder */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a> <span class='Operator'>&& *</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Hint was no good, re-search from beginning */ 
</span>                <span class='Operator'>*</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Hmm, no placeholder found? */ 
</span>            <a href="spgutils.c.html#LN829"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN41"><span class='Ref_to_Member'>nPlaceholder</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Replace the placeholder tuple */ 
</span>            <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>item</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We should not have failed given the size check at the top of 
             * the function, but test anyway.  If we did fail, we must PANIC 
             * because we've already deleted the placeholder tuple, and 
             * there's no other way to keep the damage from getting to disk. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="spgutils.c.html#LN829"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN41"><span class='Ref_to_Member'>nPlaceholder</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="spgutils.c.html#LN829"><span class='Ref_To_Local'>opaque</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/spgist_private.h.html#LN41"><span class='Ref_to_Member'>nPlaceholder</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>startOffset</span></a> <span class='Operator'>= </span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if offnum!=InvalidOffset... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if opaque-&GT;nPlaceholder&GT;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* No luck in replacing a placeholder, so just add it to the page */ 
</span>    <a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN412"><span class='Ref_to_Macro'>PageAddItem</span></a><span class='Parentheses'>(</span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>item</span></a><span class='Delimiter'>, </span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>== </span><a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a> <span class='Operator'>&& !</span><a href="spgutils.c.html#LN827"><span class='Ref_to_Parameter'>errorOK</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to add item of size %u to SPGiST index page"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="spgutils.c.html#LN826"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="spgutils.c.html#LN832"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SpGistPageAddNewItem &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>