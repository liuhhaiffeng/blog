<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\transam\multixact.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\transam\multixact.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:30 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * multixact.c 
 *      PostgreSQL multi-transaction-log manager 
 * 
 * The pg_multixact manager is a pg_xact-like manager that stores an array of 
 * MultiXactMember for each MultiXactId.  It is a fundamental part of the 
 * shared-row-lock implementation.  Each MultiXactMember is comprised of a 
 * TransactionId and a set of flag bits.  The name is a bit historical: 
 * originally, a MultiXactId consisted of more than one TransactionId (except 
 * in rare corner cases), hence "multi".  Nowadays, however, it's perfectly 
 * legitimate to have MultiXactIds that only include a single Xid. 
 * 
 * The meaning of the flag bits is opaque to this module, but they are mostly 
 * used in heapam.c to identify lock modes that each of the member transactions 
 * is holding on any given tuple.  This module just contains support to store 
 * and retrieve the arrays. 
 * 
 * We use two SLRU areas, one for storing the offsets at which the data 
 * starts for each MultiXactId in the other one.  This trick allows us to 
 * store variable length arrays of TransactionIds.  (We could alternatively 
 * use one area containing counts and TransactionIds, with valid MultiXactId 
 * values pointing at slots containing counts; but that way seems less robust 
 * since it would get completely confused if someone inquired about a bogus 
 * MultiXactId that pointed to an intermediate slot containing an XID.) 
 * 
 * XLOG interactions: this module generates a record whenever a new OFFSETs or 
 * MEMBERs page is initialized to zeroes, as well as an 
 * XLOG_MULTIXACT_CREATE_ID record whenever a new MultiXactId is defined. 
 * This module ignores the WAL rule "write xlog before data," because it 
 * suffices that actions recording a MultiXactId in a heap xmax do follow that 
 * rule.  The only way for the MXID to be referenced from any data page is for 
 * heap_lock_tuple() or heap_update() to have put it there, and each generates 
 * an XLOG record that must follow ours.  The normal LSN interlock between the 
 * data page and that XLOG record will ensure that our XLOG record reaches 
 * disk first.  If the SLRU members/offsets data reaches disk sooner than the 
 * XLOG records, we do not care; after recovery, no xmax will refer to it.  On 
 * the flip side, to ensure that all referenced entries _do_ reach disk, this 
 * module's XLOG records completely rebuild the data entered since the last 
 * checkpoint.  We flush and sync all dirty OFFSETs and MEMBERs pages to disk 
 * before each checkpoint is considered complete. 
 * 
 * Like clog.c, and unlike subtrans.c, we have to preserve state across 
 * crashes and ensure that MXID and offset numbering increases monotonically 
 * across a crash.  We do this in the same way as it's done for transaction 
 * IDs: the WAL record is guaranteed to contain evidence of every MXID we 
 * could need to worry about, and we just make sure that at the end of 
 * replay, the next-MXID and next-offset counters are at least as large as 
 * anything we saw during replay. 
 * 
 * We are able to remove segments no longer necessary by carefully tracking 
 * each table's used values: during vacuum, any multixact older than a certain 
 * value is removed; the cutoff value is stored in pg_class.  The minimum value 
 * across all tables in each database is stored in pg_database, and the global 
 * minimum across all databases is part of pg_control and is kept in shared 
 * memory.  Whenever that minimum is advanced, the SLRUs are truncated. 
 * 
 * When new multixactid values are to be created, care is taken that the 
 * counter does not fall within the wraparound horizon considering the global 
 * minimum value. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * src/backend/access/transam/multixact.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/slru.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase_rmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/ilist.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pmsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Defines for MultiXactOffset page sizes.  A page is the same BLCKSZ as is 
 * used everywhere else in Postgres. 
 * 
 * Note: because MultiXactOffsets are 32 bits and wrap around at 0xFFFFFFFF, 
 * MultiXact page numbering also wraps around at 
 * 0xFFFFFFFF/MULTIXACT_OFFSETS_PER_PAGE, and segment numbering at 
 * 0xFFFFFFFF/MULTIXACT_OFFSETS_PER_PAGE/SLRU_PAGES_PER_SEGMENT.  We need 
 * take no explicit notice of that fact in this module, except when comparing 
 * segment and page numbers in TruncateMultiXact (see 
 * MultiXactOffsetPagePrecedes). 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* We need four bytes per offset */ 
</span><a name="LN108"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_OFFSETS_PER_PAGE</span> <span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a><span class='Parentheses'>))</span> 
 
<a name="LN110"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MultiXactIdToOffsetPage</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="multixact.c.html#LN110"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN108"><span class='Ref_to_Const'>MULTIXACT_OFFSETS_PER_PAGE</span></a><span class='Parentheses'>)</span> 
<a name="LN112"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MultiXactIdToOffsetEntry</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="multixact.c.html#LN112"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN108"><span class='Ref_to_Const'>MULTIXACT_OFFSETS_PER_PAGE</span></a><span class='Parentheses'>)</span> 
<a name="LN114"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MultiXactIdToOffsetSegment</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) (</span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN114"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The situation for members is a bit more complex: we store one byte of 
 * additional flag bits for each TransactionId.  To do this without getting 
 * into alignment issues, we store four bytes of flags, and then the 
 * corresponding 4 Xids.  Each such 5-word (20-byte) set we call a "group", and 
 * are stored as a whole in pages.  Thus, with 8kB BLCKSZ, we keep 409 groups 
 * per page.  This wastes 12 bytes per page, but that's OK -- simplicity (and 
 * performance) trumps space efficiency here. 
 * 
 * Note that the "offset" macros work with byte offset, not array indexes, so 
 * arithmetic must be done using "char *" pointers. 
 */ 
/* We need eight bits per xact, so one xact fits in a byte */ 
</span><a name="LN129"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MXACT_MEMBER_BITS_PER_XACT</span>          <span class='Number'>8</span> 
<a name="LN130"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MXACT_MEMBER_FLAGS_PER_BYTE</span>         <span class='Number'>1</span> 
<a name="LN131"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MXACT_MEMBER_XACT_BITMASK</span>   <span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="multixact.c.html#LN129"><span class='Ref_to_Const'>MXACT_MEMBER_BITS_PER_XACT</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* how many full bytes of flags are there in a group? */ 
</span><a name="LN134"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_FLAGBYTES_PER_GROUP</span>       <span class='Number'>4</span> 
<a name="LN135"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_MEMBERS_PER_MEMBERGROUP</span>   <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="multixact.c.html#LN134"><span class='Ref_to_Const'>MULTIXACT_FLAGBYTES_PER_GROUP</span></a> <span class='Operator'>* </span><a href="multixact.c.html#LN130"><span class='Ref_to_Const'>MXACT_MEMBER_FLAGS_PER_BYTE</span></a><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* size in bytes of a complete group */ 
</span><a name="LN138"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_MEMBERGROUP_SIZE</span> <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="multixact.c.html#LN135"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_MEMBERGROUP</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN134"><span class='Ref_to_Const'>MULTIXACT_FLAGBYTES_PER_GROUP</span></a><span class='Parentheses'>)</span> 
<a name="LN140"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_MEMBERGROUPS_PER_PAGE</span> <span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>/ </span><a href="multixact.c.html#LN138"><span class='Ref_to_Const'>MULTIXACT_MEMBERGROUP_SIZE</span></a><span class='Parentheses'>) 
</span><a name="LN141"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_MEMBERS_PER_PAGE</span>  <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="multixact.c.html#LN140"><span class='Ref_to_Const'>MULTIXACT_MEMBERGROUPS_PER_PAGE</span></a> <span class='Operator'>* </span><a href="multixact.c.html#LN135"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_MEMBERGROUP</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Because the number of items per page is not a divisor of the last item 
 * number (member 0xFFFFFFFF), the last segment does not use the maximum number 
 * of pages, and moreover the last used page therein does not use the same 
 * number of items as previous pages.  (Another way to say it is that the 
 * 0xFFFFFFFF member is somewhere in the middle of the last page, so the page 
 * has some empty space after that item.) 
 * 
 * This constant is the number of members in the last page of the last segment. 
 */ 
</span><a name="LN154"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_MEMBERS_IN_LAST_MEMBERS_PAGE</span> <span class='Operator'>\ 
</span>        <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>((</span><span class='Number'>0xFFFFFFFF</span> <span class='Operator'>% </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* page in which a member is to be found */ 
</span><a name="LN158"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MXOffsetToMemberPage</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) ((</span><a href="multixact.c.html#LN158"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a><span class='Parentheses'>)</span> 
<a name="LN159"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MXOffsetToMemberSegment</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) (</span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN159"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* Location (byte offset within page) of flag word for a given member */ 
</span><a name="LN162"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MXOffsetToFlagsOffset</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((((</span><a href="multixact.c.html#LN162"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN135"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_MEMBERGROUP</span></a><span class='Parentheses'>)</span> <span class='Operator'>% \ 
</span>      <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span> <a href="multixact.c.html#LN140"><span class='Ref_to_Const'>MULTIXACT_MEMBERGROUPS_PER_PAGE</span></a><span class='Parentheses'>)</span> <span class='Operator'>* \ 
</span>     <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span> <a href="multixact.c.html#LN138"><span class='Ref_to_Const'>MULTIXACT_MEMBERGROUP_SIZE</span></a><span class='Parentheses'>)</span> 
<a name="LN166"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MXOffsetToFlagsBitShift</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(((</span><a href="multixact.c.html#LN166"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN135"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_MEMBERGROUP</span></a><span class='Parentheses'>)</span> <span class='Operator'>* \ 
</span>     <a href="multixact.c.html#LN129"><span class='Ref_to_Const'>MXACT_MEMBER_BITS_PER_XACT</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* Location (byte offset within page) of TransactionId of given member */ 
</span><a name="LN171"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MXOffsetToMemberOffset</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="multixact.c.html#LN162"><span class='Ref_to_Macro'>MXOffsetToFlagsOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN171"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="multixact.c.html#LN134"><span class='Ref_to_Const'>MULTIXACT_FLAGBYTES_PER_GROUP</span></a> <span class='Operator'>+ \ 
</span>     <span class='Parentheses'>((</span><a href="multixact.c.html#LN171"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="multixact.c.html#LN135"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_MEMBERGROUP</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* Multixact members wraparound thresholds. */ 
</span><a name="LN176"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_MEMBER_SAFE_THRESHOLD</span>     <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN28"><span class='Ref_to_Const'>MaxMultiXactOffset</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>) 
</span><a name="LN177"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MULTIXACT_MEMBER_DANGER_THRESHOLD</span>   <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN28"><span class='Ref_to_Const'>MaxMultiXactOffset</span></a> <span class='Operator'>- </span><a href="../../../include/access/multixact.h.html#LN28"><span class='Ref_to_Const'>MaxMultiXactOffset</span></a> <span class='Operator'>/ </span><span class='Number'>4</span><span class='Parentheses'>) 
</span> 
<a name="LN180"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PreviousMultiXactId</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="multixact.c.html#LN180"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a> <span class='Operator'>? </span><a href="../../../include/access/multixact.h.html#LN24"><span class='Ref_to_Const'>MaxMultiXactId</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN180"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Links to shared-memory data structures for MultiXact control 
 */ 
</span><a name="LN186"></a><span class='Keyword'>static </span><a href="../../../include/access/slru.h.html#LN116"><span class='Ref_to_Struct'>SlruCtlData</span></a> <span class='Declare_Var'>MultiXactOffsetCtlData</span><span class='Delimiter'>; 
</span><a name="LN187"></a><span class='Keyword'>static </span><a href="../../../include/access/slru.h.html#LN116"><span class='Ref_to_Struct'>SlruCtlData</span></a> <span class='Declare_Var'>MultiXactMemberCtlData</span><span class='Delimiter'>; 
</span> 
<a name="LN189"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MultiXactOffsetCtl</span>  <span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN186"><span class='Ref_to_Global_Var'>MultiXactOffsetCtlData</span></a><span class='Parentheses'>) 
</span><a name="LN190"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MultiXactMemberCtl</span>  <span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN187"><span class='Ref_to_Global_Var'>MultiXactMemberCtlData</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * MultiXact state shared across all backends.  All this state is protected 
 * by MultiXactGenLock.  (We also use MultiXactOffsetControlLock and 
 * MultiXactMemberControlLock to guard accesses to the two sets of SLRU 
 * buffers.  For concurrency's sake, we avoid holding more than one of these 
 * locks at a time.) 
 */ 
</span><a name="LN199"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>MultiXactStateData</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* next-to-be-assigned MultiXactId */ 
</span><a name="LN202"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>nextMXact</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* next-to-be-assigned offset */ 
</span><a name="LN205"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Member'>nextOffset</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Have we completed multixact startup? */ 
</span><a name="LN208"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>finishedStartup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Oldest multixact that is still potentially referenced by a relation. 
     * Anything older than this should not be consulted.  These values are 
     * updated by vacuum. 
     */ 
</span><a name="LN215"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>oldestMultiXactId</span><span class='Delimiter'>; 
</span><a name="LN216"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>oldestMultiXactDB</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Oldest multixact offset that is potentially referenced by a multixact 
     * referenced by a relation.  We don't always know this value, so there's 
     * a flag here to indicate whether or not we currently do. 
     */ 
</span><a name="LN223"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Member'>oldestOffset</span><span class='Delimiter'>; 
</span><a name="LN224"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>oldestOffsetKnown</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* support for anti-wraparound measures */ 
</span><a name="LN227"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>multiVacLimit</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>multiWarnLimit</span><span class='Delimiter'>; 
</span><a name="LN229"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>multiStopLimit</span><span class='Delimiter'>; 
</span><a name="LN230"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>multiWrapLimit</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* support for members anti-wraparound measures */ 
</span><a name="LN233"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Member'>offsetStopLimit</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* known if oldestOffsetKnown */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Per-backend data starts here.  We have two arrays stored in the area 
     * immediately following the MultiXactStateData struct. Each is indexed by 
     * BackendId. 
     * 
     * In both arrays, there's a slot for all normal backends (1..MaxBackends) 
     * followed by a slot for max_prepared_xacts prepared transactions. Valid 
     * BackendIds start from 1; element zero of each array is never used. 
     * 
     * OldestMemberMXactId[k] is the oldest MultiXactId each backend's current 
     * transaction(s) could possibly be a member of, or InvalidMultiXactId 
     * when the backend has no live transaction that could possibly be a 
     * member of a MultiXact.  Each backend sets its entry to the current 
     * nextMXact counter just before first acquiring a shared lock in a given 
     * transaction, and clears it at transaction end. (This works because only 
     * during or after acquiring a shared lock could an XID possibly become a 
     * member of a MultiXact, and that MultiXact would have to be created 
     * during or after the lock acquisition.) 
     * 
     * OldestVisibleMXactId[k] is the oldest MultiXactId each backend's 
     * current transaction(s) think is potentially live, or InvalidMultiXactId 
     * when not in a transaction or not in a transaction that's paid any 
     * attention to MultiXacts yet.  This is computed when first needed in a 
     * given transaction, and cleared at transaction end.  We can compute it 
     * as the minimum of the valid OldestMemberMXactId[] entries at the time 
     * we compute it (using nextMXact if none are valid).  Each backend is 
     * required not to attempt to access any SLRU data for MultiXactIds older 
     * than its own OldestVisibleMXactId[] setting; this is necessary because 
     * the checkpointer could truncate away such data at any instant. 
     * 
     * The oldest valid value among all of the OldestMemberMXactId[] and 
     * OldestVisibleMXactId[] entries is considered by vacuum as the earliest 
     * possible value still having any live member transaction.  Subtracting 
     * vacuum_multixact_freeze_min_age from that value we obtain the freezing 
     * point for multixacts for that table.  Any value older than that is 
     * removed from tuple headers (or "frozen"; see FreezeMultiXactId.  Note 
     * that multis that have member xids that are older than the cutoff point 
     * for xids must also be frozen, even if the multis themselves are newer 
     * than the multixid cutoff point).  Whenever a full table vacuum happens, 
     * the freezing point so computed is used as the new pg_class.relminmxid 
     * value.  The minimum of all those values in a database is stored as 
     * pg_database.datminmxid.  In turn, the minimum of all of those values is 
     * stored in pg_control and used as truncation point for pg_multixact.  At 
     * checkpoint or restartpoint, unneeded segments are removed. 
     */ 
</span><a name="LN280"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>perBackendXactIds</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN281"></a>}<span class='Auto_Annotations'> &laquo; end MultiXactStateData &raquo; </span> <span class='Declare_Typedef'>MultiXactStateData</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Last element of OldestMemberMXactID and OldestVisibleMXactId arrays. 
 * Valid elements are (1..MaxOldestSlot); element 0 is never used. 
 */ 
</span><a name="LN287"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MaxOldestSlot</span>   <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>+ </span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Pointers to the state data in shared memory */ 
</span><a name="LN290"></a><span class='Keyword'>static </span><a href="multixact.c.html#LN199"><span class='Ref_to_Struct'>MultiXactStateData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>MultiXactState</span><span class='Delimiter'>; 
</span><a name="LN291"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Declare_Var'>OldestMemberMXactId</span><span class='Delimiter'>; 
</span><a name="LN292"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Declare_Var'>OldestVisibleMXactId</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Definitions for the backend-local MultiXactId cache. 
 * 
 * We use this cache to store known MultiXacts, so we don't need to go to 
 * SLRU areas every time. 
 * 
 * The cache lasts for the duration of a single transaction, the rationale 
 * for this being that most entries will contain our own TransactionId and 
 * so they will be uninteresting by the time our next transaction starts. 
 * (XXX not clear that this is correct --- other members of the MultiXact 
 * could hang around longer than we did.  However, it's not clear what a 
 * better policy for flushing old cache entries would be.)  FIXME actually 
 * this is plain wrong now that multixact's may contain update Xids. 
 * 
 * We allocate the cache entries in a memory context that is deleted at 
 * transaction end, so we don't need to do retail freeing of entries. 
 */ 
</span><a name="LN312"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>mXactCacheEnt</span> 
<span class='Delimiter'>{ 
</span><a name="LN314"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>multi</span><span class='Delimiter'>; 
</span><a name="LN315"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN316"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>node</span><span class='Delimiter'>; 
</span><a name="LN317"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Declare_Member'>members</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN318"></a>} <span class='Declare_Typedef'>mXactCacheEnt</span><span class='Delimiter'>; 
</span> 
<a name="LN320"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_CACHE_ENTRIES</span>   <span class='Number'>256</span> 
<a name="LN321"></a><span class='Keyword'>static </span><a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a> <span class='Declare_Var'>MXactCache</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN247"><span class='Ref_to_Macro'>DLIST_STATIC_INIT</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN322"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>MXactCacheMembers</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN323"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>MXactContext</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> MULTIXACT_DEBUG 
<a name="LN326"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog2</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) </span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN326"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN326"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>) 
</span><a name="LN327"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog3</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) </span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN327"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN327"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN327"><span class='Ref_to_Parameter'>c</span></a><span class='Parentheses'>) 
</span><a name="LN328"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog4</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Parentheses'>) </span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN328"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN328"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN328"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN328"><span class='Ref_to_Parameter'>d</span></a><span class='Parentheses'>) 
</span><a name="LN329"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog5</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>e</span><span class='Parentheses'>) </span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN329"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN329"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN329"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN329"><span class='Ref_to_Parameter'>d</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN329"><span class='Ref_to_Parameter'>e</span></a><span class='Parentheses'>) 
</span><a name="LN330"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog6</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>e</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>f</span><span class='Parentheses'>) </span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN330"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN330"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN330"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN330"><span class='Ref_to_Parameter'>d</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN330"><span class='Ref_to_Parameter'>e</span></a><span class='Delimiter'>,</span><a href="multixact.c.html#LN330"><span class='Ref_to_Parameter'>f</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<a name="LN332"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog2</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><a name="LN333"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog3</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) 
</span><a name="LN334"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog4</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Parentheses'>) 
</span><a name="LN335"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog5</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>e</span><span class='Parentheses'>) 
</span><a name="LN336"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>debug_elog6</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>e</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>f</span><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* internal MultiXactId management */ 
</span><a name="LN340"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>MultiXactIdSetOldestVisible</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN341"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RecordNewMultiXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, 
</span><a name="LN342"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN343"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Prototype'>GetNewMultiXactId</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>offset</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* MultiXact cache management */ 
</span><a name="LN346"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>mxactMemberComparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN347"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Prototype'>mXactCacheGetBySet</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN348"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>mXactCacheGetById</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN349"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>mXactCachePut</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, 
</span><a name="LN350"></a>              <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN352"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>mxstatus_to_string</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* management of SLRU infrastructure */ 
</span><a name="LN355"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>ZeroMultiXactOffsetPage</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pageno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>writeXlog</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN356"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>ZeroMultiXactMemberPage</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pageno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>writeXlog</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN357"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>MultiXactOffsetPagePrecedes</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>page1</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>page2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN358"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>MultiXactMemberPagePrecedes</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>page1</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>page2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN359"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>MultiXactOffsetPrecedes</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset1</span><span class='Delimiter'>, 
</span><a name="LN360"></a>                        <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN361"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExtendMultiXactOffset</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN362"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExtendMultiXactMember</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN363"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>MultiXactOffsetWouldWrap</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>boundary</span><span class='Delimiter'>, 
</span><a name="LN364"></a>                         <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>start</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>distance</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN365"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>SetOffsetVacuumLimit</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_startup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN366"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>find_multixact_start</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN367"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WriteMZeroPageXlogRec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pageno</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>info</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN368"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WriteMTruncateXlogRec</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldestMultiDB</span><span class='Delimiter'>, 
</span><a name="LN369"></a>                      <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>startOff</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>endOff</span><span class='Delimiter'>, 
</span><a name="LN370"></a>                      <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>startMemb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>endMemb</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdCreate 
 *      Construct a MultiXactId representing two TransactionIds. 
 * 
 * The two XIDs must be different, or be requesting different statuses. 
 * 
 * NB - we don't worry about our local MultiXactId cache here, because that 
 * is handled by the lower-level routines. 
 */ 
</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN383"></a><span class='Declare_Function'>MultiXactIdCreate</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid1</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status1</span><span class='Delimiter'>, 
</span><a name="LN384"></a>                  <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid2</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN386"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>newMulti</span><span class='Delimiter'>; 
</span><a name="LN387"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Declare_Local'>members</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN383"><span class='Ref_to_Parameter'>xid1</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN384"><span class='Ref_to_Parameter'>xid2</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN383"><span class='Ref_to_Parameter'>xid1</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN384"><span class='Ref_to_Parameter'>xid2</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN383"><span class='Ref_to_Parameter'>status1</span></a> <span class='Operator'>!= </span><a href="multixact.c.html#LN384"><span class='Ref_to_Parameter'>status2</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* MultiXactIdSetOldestMember() must have been called already. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: unlike MultiXactIdExpand, we don't bother to check that both XIDs 
     * are still running.  In typical usage, xid2 will be our own XID and the 
     * caller just did a check on xid1, so it'd be wasted effort. 
     */ 
</span> 
    <a href="multixact.c.html#LN387"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN383"><span class='Ref_to_Parameter'>xid1</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN387"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN383"><span class='Ref_to_Parameter'>status1</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN387"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN384"><span class='Ref_to_Parameter'>xid2</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN387"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN384"><span class='Ref_to_Parameter'>status2</span></a><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN386"><span class='Ref_To_Local'>newMulti</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN106"><span class='Ref_to_Proto'>MultiXactIdCreateFromMembers</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN387"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Create: %s"</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN386"><span class='Ref_To_Local'>newMulti</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN387"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN386"><span class='Ref_To_Local'>newMulti</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdCreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdExpand 
 *      Add a TransactionId to a pre-existing MultiXactId. 
 * 
 * If the TransactionId is already a member of the passed MultiXactId with the 
 * same status, just return it as-is. 
 * 
 * Note that we do NOT actually modify the membership of a pre-existing 
 * MultiXactId; instead we create a new one.  This is necessary to avoid 
 * a race condition against code trying to wait for one MultiXactId to finish; 
 * see notes in heapam.c. 
 * 
 * NB - we don't worry about our local MultiXactId cache here, because that 
 * is handled by the lower-level routines. 
 * 
 * Note: It is critical that MultiXactIds that come from an old cluster (i.e. 
 * one upgraded by pg_upgrade from a cluster older than this feature) are not 
 * passed in. 
 */ 
</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN436"></a><span class='Declare_Function'>MultiXactIdExpand</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN438"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>newMulti</span><span class='Delimiter'>; 
</span><a name="LN439"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN440"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newMembers</span><span class='Delimiter'>; 
</span><a name="LN441"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN442"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN443"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* MultiXactIdSetOldestMember() must have been called already. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN329"><span class='Ref_to_Macro'>debug_elog5</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Expand: received multi %u, xid %u status %s"</span><span class='Delimiter'>, 
</span>                <a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN352"><span class='Ref_to_Proto'>mxstatus_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we don't allow for old multis here.  The reason is that the only 
     * caller of this function does a check that the multixact is no longer 
     * running. 
     */ 
</span>    <a href="multixact.c.html#LN441"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN441"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN463"></a>        <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Declare_Local'>member</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The MultiXactId is obsolete.  This can only happen if all the 
         * MultiXactId members stop running between the caller checking and 
         * passing it to us.  It would be better to return that fact to the 
         * caller, but it would complicate the API and it's unlikely to happen 
         * too often, so just deal with it by creating a singleton MultiXact. 
         */ 
</span>        <a href="multixact.c.html#LN463"><span class='Ref_To_Local'>member</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN463"><span class='Ref_To_Local'>member</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>status</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN438"><span class='Ref_To_Local'>newMulti</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN106"><span class='Ref_to_Proto'>MultiXactIdCreateFromMembers</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN463"><span class='Ref_To_Local'>member</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Expand: %u has no members, create singleton %u"</span><span class='Delimiter'>, 
</span>                    <a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN438"><span class='Ref_To_Local'>newMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="multixact.c.html#LN438"><span class='Ref_To_Local'>newMulti</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the TransactionId is already a member of the MultiXactId with the 
     * same status, just return the existing MultiXactId. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN441"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Expand: %u is already a member of %u"</span><span class='Delimiter'>, 
</span>                        <a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine which of the members of the MultiXactId are still of 
     * interest. This is any running transaction, and also any transaction 
     * that grabbed something stronger than just a lock and was committed. (An 
     * update that aborted is of no interest here; and having more than one 
     * update Xid in a multixact would cause errors elsewhere.) 
     * 
     * Removing dead members is not just an optimization: freezing of tuples 
     * whose Xmax are multis depends on this behavior. 
     * 
     * Note we have the same race condition here as above: j could be 0 at the 
     * end of the loop. 
     */ 
</span>    <a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN441"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN443"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN441"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN54"><span class='Ref_to_Macro'>ISUPDATE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>             <a href="transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN443"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span>            <a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN443"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN442"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN443"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN443"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN436"><span class='Ref_to_Parameter'>status</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN438"><span class='Ref_To_Local'>newMulti</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN106"><span class='Ref_to_Proto'>MultiXactIdCreateFromMembers</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN443"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN439"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN440"><span class='Ref_To_Local'>newMembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Expand: returning new multi %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN438"><span class='Ref_To_Local'>newMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN438"><span class='Ref_To_Local'>newMulti</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdExpand &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdIsRunning 
 *      Returns whether a MultiXactId is "running". 
 * 
 * We return true if at least one member of the given MultiXactId is still 
 * running.  Note that a "false" result is certain not to change, 
 * because it is not legal to add members to an existing MultiXactId. 
 * 
 * Caller is expected to have verified that the multixact does not come from 
 * a pg_upgraded share-locked tuple. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN548"></a><span class='Declare_Function'>MultiXactIdIsRunning</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isLockOnly</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN550"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN551"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN552"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"IsRunning %u?"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN548"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * "false" here means we assume our callers have checked that the given 
     * multi cannot possibly come from a pg_upgraded database. 
     */ 
</span>    <a href="multixact.c.html#LN551"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN548"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN548"><span class='Ref_to_Parameter'>isLockOnly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN551"><span class='Ref_To_Local'>nmembers</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"IsRunning: no members"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Checking for myself is cheap compared to looking in shared memory; 
     * return true if any live subtransaction of the current top-level 
     * transaction is a member. 
     * 
     * This is not needed for correctness, it's just a fast path. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN551"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"IsRunning: I (%d) am running!"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This could be made faster by having another entry point in procarray.c, 
     * walking the PGPROC array only once for all the members.  But in most 
     * cases nmembers should be small enough that it doesn't much matter. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN551"><span class='Ref_To_Local'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"IsRunning: member %d (%u) is running"</span><span class='Delimiter'>, 
</span>                        <a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN552"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN550"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"IsRunning: %u is not running"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN548"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdIsRunning &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdSetOldestMember 
 *      Save the oldest MultiXactId this transaction could be a member of. 
 * 
 * We set the OldestMemberMXactId for a given transaction the first time it's 
 * going to do some operation that might require a MultiXactId (tuple lock, 
 * update or delete).  We need to do this even if we end up using a 
 * TransactionId instead of a MultiXactId, because there is a chance that 
 * another transaction would add our XID to a MultiXactId. 
 * 
 * The value to set is the next-to-be-assigned MultiXactId, so this is meant to 
 * be called just before doing any such possibly-MultiXactId-able operation. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN622"></a><span class='Declare_Function'>MultiXactIdSetOldestMember</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN626"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMXact</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * You might think we don't need to acquire a lock here, since 
         * fetching and storing of TransactionIds is probably atomic, but in 
         * fact we do: suppose we pick up nextMXact and then lose the CPU for 
         * a long time.  Someone else could advance nextMXact, and then 
         * another someone else could compute an OldestVisibleMXactId that 
         * would be after the value we are going to store when we get control 
         * back.  Which would be wrong. 
         * 
         * Note that a shared lock is sufficient, because it's enough to stop 
         * someone from advancing nextMXact; and nobody else could be trying 
         * to write to our OldestMember entry, only reading (and we assume 
         * storing it is atomic.) 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have to beware of the possibility that nextMXact is in the 
         * wrapped-around state.  We don't fix the counter itself here, but we 
         * must be sure to store a valid value in our array entry. 
         */ 
</span>        <a href="multixact.c.html#LN626"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN626"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>            <a href="multixact.c.html#LN626"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="multixact.c.html#LN626"><span class='Ref_To_Local'>nextMXact</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"MultiXact: setting OldestMember[%d] = %u"</span><span class='Delimiter'>, 
</span>                    <a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN626"><span class='Ref_To_Local'>nextMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !MultiXactIdIsValid(O... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdSetOldestMember &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdSetOldestVisible 
 *      Save the oldest MultiXactId this transaction considers possibly live. 
 * 
 * We set the OldestVisibleMXactId for a given transaction the first time 
 * it's going to inspect any MultiXactId.  Once we have set this, we are 
 * guaranteed that the checkpointer won't truncate off SLRU data for 
 * MultiXactIds at or after our OldestVisibleMXactId. 
 * 
 * The value to set is the oldest of nextMXact and all the valid per-backend 
 * OldestMemberMXactId[] entries.  Because of the locking we do, we can be 
 * certain that no subsequent call to MultiXactIdSetOldestMember can set 
 * an OldestMemberMXactId[] entry older than what we compute here.  Therefore 
 * there is no live transaction, now or later, that can be a member of any 
 * MultiXactId older than the OldestVisibleMXactId we compute here. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN679"></a><span class='Declare_Function'>MultiXactIdSetOldestVisible</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN683"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMXact</span><span class='Delimiter'>; 
</span><a name="LN684"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We have to beware of the possibility that nextMXact is in the 
         * wrapped-around state.  We don't fix the counter itself here, but we 
         * must be sure to store a valid value in our array entry. 
         */ 
</span>        <a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>            <a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN684"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="multixact.c.html#LN287"><span class='Ref_to_Const'>MaxOldestSlot</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN699"></a>            <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>thisoldest</span> <span class='Operator'>= </span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN684"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN699"><span class='Ref_To_Local'>thisoldest</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN699"><span class='Ref_To_Local'>thisoldest</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Parentheses'>))</span> 
                <a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN699"><span class='Ref_To_Local'>thisoldest</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"MultiXact: setting OldestVisible[%d] = %u"</span><span class='Delimiter'>, 
</span>                    <a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN683"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !MultiXactIdIsValid(O... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdSetOldestVisible &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReadNextMultiXactId 
 *      Return the next MultiXactId to be assigned, but don't allocate it 
 */ 
</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN720"></a><span class='Declare_Function'>ReadNextMultiXactId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN722"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>mxid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XXX we could presumably do this without a lock. */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN722"><span class='Ref_To_Local'>mxid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN722"><span class='Ref_To_Local'>mxid</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN722"><span class='Ref_To_Local'>mxid</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN722"><span class='Ref_To_Local'>mxid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdCreateFromMembers 
 *      Make a new MultiXactId from the specified set of members 
 * 
 * Make XLOG, SLRU and cache entries for a new MultiXactId, recording the 
 * given TransactionIds as members.  Returns the newly created MultiXactId. 
 * 
 * NB: the passed members[] array will be sorted in-place. 
 */ 
</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN745"></a><span class='Declare_Function'>MultiXactIdCreateFromMembers</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN747"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multi</span><span class='Delimiter'>; 
</span><a name="LN748"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN749"></a>    <a href="../../../include/access/multixact.h.html#LN75"><span class='Ref_to_Struct'>xl_multixact_create</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Create: %s"</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * See if the same set of members already exists in our cache; if so, just 
     * re-use that MultiXactId.  (Note: it might seem that looking in our 
     * cache is insufficient, and we ought to search disk to see if a 
     * duplicate definition already exists.  But since we only ever create 
     * MultiXacts containing our own XID, in most cases any such MultiXacts 
     * were in fact created by us, and so will be in our cache.  There are 
     * corner cases where someone else added us to a MultiXact without our 
     * knowledge, but it's not worth checking for.) 
     */ 
</span>    <a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN347"><span class='Ref_to_Proto'>mXactCacheGetBySet</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Create: in cache!"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Verify that there is a single update Xid among the given members. */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN773"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN774"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_update</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN773"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN773"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN773"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN54"><span class='Ref_to_Macro'>ISUPDATE_from_mxstatus</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN773"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN774"><span class='Ref_To_Local'>has_update</span></a><span class='Parentheses'>) 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"new multixact has more than one updating member"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="multixact.c.html#LN774"><span class='Ref_To_Local'>has_update</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Assign the MXID and offsets range to use, and make sure there is space 
     * in the OFFSETs and MEMBERs files.  NB: this routine does 
     * START_CRIT_SECTION(). 
     * 
     * Note: unlike MultiXactIdCreate and MultiXactIdExpand, we do not check 
     * that we've called MultiXactIdSetOldestMember here.  This is because 
     * this routine is used in some places to create new MultiXactIds of which 
     * the current backend is not a member, notably during freezing of multis 
     * in vacuum.  During vacuum, in particular, it would be unacceptable to 
     * keep OldestMulti set, in case it runs for long. 
     */ 
</span>    <a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN343"><span class='Ref_to_Proto'>GetNewMultiXactId</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN748"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make an XLOG entry describing the new MXID. */ 
</span>    <a href="multixact.c.html#LN749"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN77"><span class='Ref_to_Member'>mid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN749"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN78"><span class='Ref_to_Member'>moff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN748"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN749"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN79"><span class='Ref_to_Member'>nmembers</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX Note: there's a lot of padding space in MultiXactMember.  We could 
     * find a more compact representation of this Xlog record -- perhaps all 
     * the status flags in one XLogRecData, then all the xids in another one? 
     * Not clear that it's worth the trouble though. 
     */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="multixact.c.html#LN749"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN83"><span class='Ref_to_Const'>SizeOfMultiXactCreate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_MULTIXACT_ID<span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN72"><span class='Ref_to_Const'>XLOG_MULTIXACT_CREATE_ID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now enter the information into the OFFSETs and MEMBERs logs */ 
</span>    <a href="multixact.c.html#LN341"><span class='Ref_to_Proto'>RecordNewMultiXact</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN748"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Done with critical section */ 
</span>    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Store the new MultiXactId in the local cache, too */ 
</span>    <a href="multixact.c.html#LN349"><span class='Ref_to_Proto'>mXactCachePut</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN745"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Create: all done"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN747"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactIdCreateFromMembers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RecordNewMultiXact 
 *      Write info about a new multixact into the offsets and members files 
 * 
 * This is broken out of MultiXactIdCreateFromMembers so that xlog replay can 
 * use it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN840"></a><span class='Declare_Function'>RecordNewMultiXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, 
</span><a name="LN841"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN843"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN844"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>prev_pageno</span><span class='Delimiter'>; 
</span><a name="LN845"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>entryno</span><span class='Delimiter'>; 
</span><a name="LN846"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span><a name="LN847"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Local'>offptr</span><span class='Delimiter'>; 
</span><a name="LN848"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN843"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN845"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN112"><span class='Ref_to_Macro'>MultiXactIdToOffsetEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we pass the MultiXactId to SimpleLruReadPage as the "transaction" 
     * to complain about if there's any I/O error.  This is kinda bogus, but 
     * since the errors will always give the full pathname, it should be clear 
     * enough that a MultiXactId is really involved.  Perhaps someday we'll 
     * take the trouble to generalize the slru.c error reporting code. 
     */ 
</span>    <a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN843"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN847"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]; 
</span>    <a href="multixact.c.html#LN847"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN845"><span class='Ref_To_Local'>entryno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="multixact.c.html#LN847"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Exchange our lock */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN844"><span class='Ref_To_Local'>prev_pageno</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN848"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN848"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN841"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN848"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>offset</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN879"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>memberptr</span><span class='Delimiter'>; 
</span><a name="LN880"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>flagsptr</span><span class='Delimiter'>; 
</span><a name="LN881"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>flagsval</span><span class='Delimiter'>; 
</span><a name="LN882"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bshift</span><span class='Delimiter'>; 
</span><a name="LN883"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flagsoff</span><span class='Delimiter'>; 
</span><a name="LN884"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>memberoff</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN841"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN848"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN843"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN884"><span class='Ref_To_Local'>memberoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN171"><span class='Ref_to_Macro'>MXOffsetToMemberOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN883"><span class='Ref_To_Local'>flagsoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN162"><span class='Ref_to_Macro'>MXOffsetToFlagsOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN882"><span class='Ref_To_Local'>bshift</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN166"><span class='Ref_to_Macro'>MXOffsetToFlagsBitShift</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN843"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>!= </span><a href="multixact.c.html#LN844"><span class='Ref_To_Local'>prev_pageno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN843"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN840"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="multixact.c.html#LN844"><span class='Ref_To_Local'>prev_pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN843"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="multixact.c.html#LN879"><span class='Ref_To_Local'>memberptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><a href="multixact.c.html#LN884"><span class='Ref_To_Local'>memberoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>*</span><a href="multixact.c.html#LN879"><span class='Ref_To_Local'>memberptr</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN841"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN848"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN880"><span class='Ref_To_Local'>flagsptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><a href="multixact.c.html#LN883"><span class='Ref_To_Local'>flagsoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN881"><span class='Ref_To_Local'>flagsval</span></a> <span class='Operator'>= *</span><a href="multixact.c.html#LN880"><span class='Ref_To_Local'>flagsptr</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN881"><span class='Ref_To_Local'>flagsval</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="multixact.c.html#LN129"><span class='Ref_to_Const'>MXACT_MEMBER_BITS_PER_XACT</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><a href="multixact.c.html#LN882"><span class='Ref_To_Local'>bshift</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN881"><span class='Ref_To_Local'>flagsval</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN841"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN848"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>&LT;&LT; </span><a href="multixact.c.html#LN882"><span class='Ref_To_Local'>bshift</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="multixact.c.html#LN880"><span class='Ref_To_Local'>flagsptr</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN881"><span class='Ref_To_Local'>flagsval</span></a><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN846"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nmembers;i++,of... &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecordNewMultiXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetNewMultiXactId 
 *      Get the next MultiXactId. 
 * 
 * Also, reserve the needed amount of space in the "members" area.  The 
 * starting offset of the reserved space is returned in *offset. 
 * 
 * This may generate XLOG records for expansion of the offsets and/or members 
 * files.  Unfortunately, we have to do that while holding MultiXactGenLock 
 * to avoid race conditions --- the XLOG record for zeroing a page must appear 
 * before any backend can possibly try to store data in that page! 
 * 
 * We start a critical section before advancing the shared counters.  The 
 * caller must end the critical section after writing SLRU data. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN934"></a><span class='Declare_Function'>GetNewMultiXactId</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN936"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN937"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>nextOffset</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"GetNew: for %d xids"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* safety check, we should never get this far in a HS slave */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot assign MultiXactIds during recovery"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Handle wraparound of the nextMXact counter */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assign the MXID */ 
</span>    <a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Check to see if it's safe to assign another MultiXactId.  This protects 
     * against catastrophic data loss due to multixact wraparound.  The basic 
     * rules are: 
     * 
     * If we're past multiVacLimit or the safe threshold for member storage 
     * space, or we don't know what the safe threshold for member storage is, 
     * start trying to force autovacuum cycles. 
     * If we're past multiWarnLimit, start issuing warnings. 
     * If we're past multiStopLimit, refuse to create new MultiXactIds. 
     * 
     * Note these are pretty much the same protections in GetNewTransactionId. 
     *---------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN227"><span class='Ref_to_Member'>multiVacLimit</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * For safety's sake, we release MultiXactGenLock while sending 
         * signals, warnings, etc.  This is not so much because we care about 
         * preserving concurrency in this situation, as to avoid any 
         * possibility of deadlock while doing get_database_name(). First, 
         * copy all the shared values we'll need in this path. 
         */ 
</span><a name="LN977"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiWarnLimit</span> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN228"><span class='Ref_to_Member'>multiWarnLimit</span></a><span class='Delimiter'>; 
</span><a name="LN978"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiStopLimit</span> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN229"><span class='Ref_to_Member'>multiStopLimit</span></a><span class='Delimiter'>; 
</span><a name="LN979"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiWrapLimit</span> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN230"><span class='Ref_to_Member'>multiWrapLimit</span></a><span class='Delimiter'>; 
</span><a name="LN980"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>oldest_datoid</span> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN978"><span class='Ref_To_Local'>multiStopLimit</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN987"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>oldest_datname</span> <span class='Operator'>= </span><a href="../../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN980"><span class='Ref_To_Local'>oldest_datoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Immediately kick autovacuum into action as we're already in 
             * ERROR territory. 
             */ 
</span>            <a href="../../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/pmsignal.h.html#LN28"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_LAUNCHER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* complain even if that DB has disappeared */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN987"><span class='Ref_To_Local'>oldest_datname</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database is not accepting commands that generate new MultiXactIds to avoid wraparound data loss in database \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="multixact.c.html#LN987"><span class='Ref_To_Local'>oldest_datname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Execute a database-wide VACUUM in that database.\n"</span> 
                         <span class='String'>"You might also need to commit or roll back old prepared transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database is not accepting commands that generate new MultiXactIds to avoid wraparound data loss in database with OID %u"</span><span class='Delimiter'>, 
</span>                                <a href="multixact.c.html#LN980"><span class='Ref_To_Local'>oldest_datoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Execute a database-wide VACUUM in that database.\n"</span> 
                         <span class='String'>"You might also need to commit or roll back old prepared transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsUnderPostmaster&&!M... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * To avoid swamping the postmaster with signals, we issue the autovac 
         * request only once per 64K multis generated.  This still gives 
         * plenty of chances before we get into real trouble. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>% </span><span class='Number'>65536</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/pmsignal.h.html#LN28"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_LAUNCHER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN977"><span class='Ref_To_Local'>multiWarnLimit</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1022"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>oldest_datname</span> <span class='Operator'>= </span><a href="../../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN980"><span class='Ref_To_Local'>oldest_datoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* complain even if that DB has disappeared */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1022"><span class='Ref_To_Local'>oldest_datname</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" must be vacuumed before %u more MultiXactId is used"</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"database \"%s\" must be vacuumed before %u more MultiXactIds are used"</span><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN979"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN1022"><span class='Ref_To_Local'>oldest_datname</span></a><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN979"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Execute a database-wide VACUUM in that database.\n"</span> 
                         <span class='String'>"You might also need to commit or roll back old prepared transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"database with OID %u must be vacuumed before %u more MultiXactId is used"</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"database with OID %u must be vacuumed before %u more MultiXactIds are used"</span><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN979"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN980"><span class='Ref_To_Local'>oldest_datoid</span></a><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN979"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Execute a database-wide VACUUM in that database.\n"</span> 
                         <span class='String'>"You might also need to commit or roll back old prepared transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !MultiXactIdPrecedes(... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Re-acquire lock and start over */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>            <a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !MultiXactIdPrecedes(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Make sure there is room for the MXID in the file.  */ 
</span>    <a href="multixact.c.html#LN361"><span class='Ref_to_Proto'>ExtendMultiXactOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reserve the members space, similarly to above.  Also, be careful not to 
     * return zero as the starting offset for any multixact. See 
     * GetMultiXactIdMembers() for motivation. 
     */ 
</span>    <a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* allocate member slot 0 too */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Operator'>*</span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Protect against overrun of the members space as well, with the 
     * following rules: 
     * 
     * If we're past offsetStopLimit, refuse to generate more multis. 
     * If we're close to offsetStopLimit, emit a warning. 
     * 
     * Arbitrarily, we start emitting warnings when we're 20 segments or less 
     * from offsetStopLimit. 
     * 
     * Note we haven't updated the shared state yet, so if we fail at this 
     * point, the multixact ID we grabbed can still be used by the next guy. 
     * 
     * Note that there is no point in forcing autovacuum runs here: the 
     * multixact freeze settings would have to be reduced for that to have any 
     * effect. 
     *---------- 
     */ 
</span><a name="LN1087"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>OFFSET_WARN_SEGMENTS</span>    <span class='Number'>20</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN224"><span class='Ref_to_Member'>oldestOffsetKnown</span></a> <span class='Operator'>&& 
</span>        <a href="multixact.c.html#LN363"><span class='Ref_to_Proto'>MultiXactOffsetWouldWrap</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>, 
</span>                                 <a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* see comment in the corresponding offsets wraparound case */ 
</span>        <a href="../../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/pmsignal.h.html#LN28"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_LAUNCHER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multixact \"members\" limit exceeded"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/elog.h.html#LN150"><span class='Ref_to_Func'>errdetail_plural</span></a><span class='Parentheses'>(</span><span class='String'>"This command would create a multixact with %u members, but the remaining space is only enough for %u member."</span><span class='Delimiter'>, 
</span>                                  <span class='String'>"This command would create a multixact with %u members, but the remaining space is only enough for %u members."</span><span class='Delimiter'>, 
</span>                            <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                  <a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, 
</span>                           <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Execute a database-wide VACUUM in database with OID %u with reduced vacuum_multixact_freeze_min_age and vacuum_multixact_freeze_table_age settings."</span><span class='Delimiter'>, 
</span>                         <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check whether we should kick autovacuum into action, to prevent members 
     * wraparound. NB we use a much larger window to trigger autovacuum than 
     * just the warning limit. The warning is just a measure of last resort - 
     * this is in line with GetNewTransactionId's behaviour. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN224"><span class='Ref_to_Member'>oldestOffsetKnown</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN223"><span class='Ref_to_Member'>oldestOffset</span></a> 
         <span class='Operator'>&GT; </span><a href="multixact.c.html#LN176"><span class='Ref_to_Const'>MULTIXACT_MEMBER_SAFE_THRESHOLD</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * To avoid swamping the postmaster with signals, we issue the autovac 
         * request only when crossing a segment boundary. With default 
         * compilation settings that's roughly after 50k members.  This still 
         * gives plenty of chances before we get into real trouble. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= 
</span>            <span class='Parentheses'>(</span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/pmsignal.h.html#LN28"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_LAUNCHER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN224"><span class='Ref_to_Member'>oldestOffsetKnown</span></a> <span class='Operator'>&& 
</span>        <a href="multixact.c.html#LN363"><span class='Ref_to_Proto'>MultiXactOffsetWouldWrap</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a><span class='Delimiter'>, 
</span>                                 <a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>, 
</span>                                 <a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a> <span class='Operator'>* </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a> <span class='Operator'>* </span><a href="multixact.c.html#LN1087"><span class='Ref_to_Const'>OFFSET_WARN_SEGMENTS</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"database with OID %u must be vacuumed before %d more multixact member is used"</span><span class='Delimiter'>, 
</span>                               <span class='String'>"database with OID %u must be vacuumed before %d more multixact members are used"</span><span class='Delimiter'>, 
</span>                     <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, 
</span>                               <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a><span class='Delimiter'>, 
</span>                    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Execute a database-wide VACUUM in that database with reduced vacuum_multixact_freeze_min_age and vacuum_multixact_freeze_table_age settings."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN362"><span class='Ref_to_Proto'>ExtendMultiXactMember</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN937"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Critical section from here until caller has written the data into the 
     * just-reserved SLRU space; we don't want to error out with a partly 
     * written MultiXact structure.  (In particular, failing to write our 
     * start offset after advancing nextMXact would effectively corrupt the 
     * previous MultiXact.) 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance counters.  As in GetNewTransactionId(), this must not happen 
     * until after file extension has succeeded! 
     * 
     * We don't care about MultiXactId wraparound here; it will be handled by 
     * the next iteration.  But note that nextMXact may be InvalidMultiXactId 
     * or the first value on a segment-beginning page after this routine 
     * exits, so anyone else looking at the variable must be prepared to deal 
     * with either case.  Similarly, nextOffset may be zero, but we won't use 
     * that as the actual start offset of the next multixact. 
     */ 
</span>    <span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"GetNew: returning %u offset %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="multixact.c.html#LN934"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="multixact.c.html#LN936"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetNewMultiXactId &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetMultiXactIdMembers 
 *      Return the set of MultiXactMembers that make up a MultiXactId 
 * 
 * Return value is the number of members found, or -1 if there are none, 
 * and *members is set to a newly palloc'ed array of members.  It's the 
 * caller's responsibility to free it when done with it. 
 * 
 * from_pgupgrade must be passed as true if and only if only the multixact 
 * corresponds to a value from a tuple that was locked in a 9.2-or-older 
 * installation and later pg_upgrade'd (that is, the infomask is 
 * HEAP_LOCKED_UPGRADED).  In this case, we know for certain that no members 
 * can still be running, so we return -1 just like for an empty multixact 
 * without any further checking.  It would be wrong to try to resolve such a 
 * multixact: either the multixact is within the current valid multixact 
 * range, in which case the returned result would be bogus, or outside that 
 * range, in which case an error would be raised. 
 * 
 * In all other cases, the passed multixact must be within the known valid 
 * range, that is, greater to or equal than oldestMultiXactId, and less than 
 * nextMXact.  Otherwise, an error is raised. 
 * 
 * onlyLock must be set to true if caller is certain that the given multi 
 * is used only to lock tuples; can be false without loss of correctness, 
 * but passing a true means we can return quickly without checking for 
 * old updates. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1201"></a><span class='Declare_Function'>GetMultiXactIdMembers</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>members</span><span class='Delimiter'>, 
</span><a name="LN1202"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>from_pgupgrade</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>onlyLock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1204"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN1205"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>prev_pageno</span><span class='Delimiter'>; 
</span><a name="LN1206"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>entryno</span><span class='Delimiter'>; 
</span><a name="LN1207"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span><a name="LN1208"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Local'>offptr</span><span class='Delimiter'>; 
</span><a name="LN1209"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN1210"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>length</span><span class='Delimiter'>; 
</span><a name="LN1211"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>truelength</span><span class='Delimiter'>; 
</span><a name="LN1212"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1213"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMXact</span><span class='Delimiter'>; 
</span><a name="LN1214"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMXact</span><span class='Delimiter'>; 
</span><a name="LN1215"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>tmpMXact</span><span class='Delimiter'>; 
</span><a name="LN1216"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>nextOffset</span><span class='Delimiter'>; 
</span><a name="LN1217"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"GetMembers: asked for %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="multixact.c.html#LN1202"><span class='Ref_to_Parameter'>from_pgupgrade</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See if the MultiXactId is in the local cache */ 
</span>    <a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN348"><span class='Ref_to_Proto'>mXactCacheGetById</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"GetMembers: found %s in the cache"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Set our OldestVisibleMXactId[] entry if we didn't already */ 
</span>    <a href="multixact.c.html#LN340"><span class='Ref_to_Proto'>MultiXactIdSetOldestVisible</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we know the multi is used only for locking and not for updates, then 
     * we can skip checking if the value is older than our oldest visible 
     * multi.  It cannot possibly still be running. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1202"><span class='Ref_to_Parameter'>onlyLock</span></a> <span class='Operator'>&& 
</span>        <a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"GetMembers: a locker-only multi is too old"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>members</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We check known limits on MultiXact before resorting to the SLRU area. 
     * 
     * An ID older than MultiXactState-&GT;oldestMultiXactId cannot possibly be 
     * useful; it has already been removed, or will be removed shortly, by 
     * truncation.  If one is passed, an error is raised. 
     * 
     * Also, an ID &GT;= nextMXact shouldn't ever be seen here; if it is seen, it 
     * implies undetected ID wraparound has occurred.  This raises a hard 
     * error. 
     * 
     * Shared lock is enough here since we aren't modifying any global state. 
     * Acquire it just long enough to grab the current counter values.  We may 
     * need both nextMXact and nextOffset; see below. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1213"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1214"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1216"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1213"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MultiXactId %u does no longer exist -- apparent wraparound"</span><span class='Delimiter'>, 
</span>                <a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1214"><span class='Ref_To_Local'>nextMXact</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MultiXactId %u has not been created yet -- apparent wraparound"</span><span class='Delimiter'>, 
</span>                        <a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find out the offset at which we need to start reading MultiXactMembers 
     * and the number of members in the multixact.  We determine the latter as 
     * the difference between this multixact's starting offset and the next 
     * one's.  However, there are some corner cases to worry about: 
     * 
     * 1. This multixact may be the latest one created, in which case there is 
     * no next one to look at.  In this case the nextOffset value we just 
     * saved is the correct endpoint. 
     * 
     * 2. The next multixact may still be in process of being filled in: that 
     * is, another process may have done GetNewMultiXactId but not yet written 
     * the offset entry for that ID.  In that scenario, it is guaranteed that 
     * the offset entry for that multixact exists (because GetNewMultiXactId 
     * won't release MultiXactGenLock until it does) but contains zero 
     * (because we are careful to pre-zero offset pages). Because 
     * GetNewMultiXactId will never return zero as the starting offset for a 
     * multixact, when we read zero as the next multixact's offset, we know we 
     * have this case.  We sleep for a bit and try again. 
     * 
     * 3. Because GetNewMultiXactId increments offset zero to offset one to 
     * handle case #2, there is an ambiguity near the point of offset 
     * wraparound.  If we see next multixact's offset is one, is that our 
     * multixact's actual endpoint, or did it end at zero with a subsequent 
     * increment?  We handle this using the knowledge that if the zero'th 
     * member slot wasn't filled, it'll contain zero, and zero isn't a valid 
     * transaction ID so it can't be a multixact member.  Therefore, if we 
     * read a zero from the members array, just ignore it. 
     * 
     * This is all pretty messy, but the mess occurs only in infrequent corner 
     * cases, so it seems better than holding the MultiXactGenLock for a long 
     * time on every multixact creation. 
     */ 
</span><a name="LN1320"></a><span class='Label'>retry</span><span class='Operator'>: 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1206"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN112"><span class='Ref_to_Macro'>MultiXactIdToOffsetEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1208"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]; 
</span>    <a href="multixact.c.html#LN1208"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN1206"><span class='Ref_To_Local'>entryno</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= *</span><a href="multixact.c.html#LN1208"><span class='Ref_To_Local'>offptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use the same increment rule as GetNewMultiXactId(), that is, don't 
     * handle wraparound explicitly until needed. 
     */ 
</span>    <a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1214"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Corner case 1: there is no next multixact */ 
</span>        <a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1216"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1346"></a>        <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>nextMXOffset</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* handle wraparound if needed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>            <a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1205"><span class='Ref_To_Local'>prev_pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1206"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN112"><span class='Ref_to_Macro'>MultiXactIdToOffsetEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>!= </span><a href="multixact.c.html#LN1205"><span class='Ref_To_Local'>prev_pageno</span></a><span class='Parentheses'>) 
</span>            <a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1215"><span class='Ref_To_Local'>tmpMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1208"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]; 
</span>        <a href="multixact.c.html#LN1208"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN1206"><span class='Ref_To_Local'>entryno</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1346"><span class='Ref_To_Local'>nextMXOffset</span></a> <span class='Operator'>= *</span><a href="multixact.c.html#LN1208"><span class='Ref_To_Local'>offptr</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1346"><span class='Ref_To_Local'>nextMXOffset</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Corner case 2: next multixact is still being filled in */ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="multixact.c.html#LN1320"><span class='Ref_to_Label'>retry</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1346"><span class='Ref_To_Local'>nextMXOffset</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1217"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>members</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1217"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now get the members themselves. */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1205"><span class='Ref_To_Local'>prev_pageno</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1212"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN1212"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN1210"><span class='Ref_To_Local'>length</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN1212"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1388"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xactptr</span><span class='Delimiter'>; 
</span><a name="LN1389"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>flagsptr</span><span class='Delimiter'>; 
</span><a name="LN1390"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flagsoff</span><span class='Delimiter'>; 
</span><a name="LN1391"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bshift</span><span class='Delimiter'>; 
</span><a name="LN1392"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>memberoff</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1392"><span class='Ref_To_Local'>memberoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN171"><span class='Ref_to_Macro'>MXOffsetToMemberOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>!= </span><a href="multixact.c.html#LN1205"><span class='Ref_To_Local'>prev_pageno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="multixact.c.html#LN1205"><span class='Ref_To_Local'>prev_pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1204"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="multixact.c.html#LN1388"><span class='Ref_To_Local'>xactptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><a href="multixact.c.html#LN1392"><span class='Ref_To_Local'>memberoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="multixact.c.html#LN1388"><span class='Ref_To_Local'>xactptr</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Corner case 3: we must be looking at unused slot zero */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="multixact.c.html#LN1390"><span class='Ref_To_Local'>flagsoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN162"><span class='Ref_to_Macro'>MXOffsetToFlagsOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1391"><span class='Ref_To_Local'>bshift</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN166"><span class='Ref_to_Macro'>MXOffsetToFlagsBitShift</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1209"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1389"><span class='Ref_To_Local'>flagsptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN1207"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><a href="multixact.c.html#LN1390"><span class='Ref_To_Local'>flagsoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1217"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= *</span><a href="multixact.c.html#LN1388"><span class='Ref_To_Local'>xactptr</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1217"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="multixact.c.html#LN1389"><span class='Ref_To_Local'>flagsptr</span></a> <span class='Operator'>&GT;&GT; </span><a href="multixact.c.html#LN1391"><span class='Ref_To_Local'>bshift</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="multixact.c.html#LN131"><span class='Ref_to_Const'>MXACT_MEMBER_XACT_BITMASK</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;length;i++,offs... &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy the result into the local cache. 
     */ 
</span>    <a href="multixact.c.html#LN349"><span class='Ref_to_Proto'>mXactCachePut</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1217"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"GetMembers: no cache for %s"</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1201"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1217"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="multixact.c.html#LN1211"><span class='Ref_To_Local'>truelength</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetMultiXactIdMembers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * mxactMemberComparator 
 *      qsort comparison function for MultiXactMember 
 * 
 * We can't use wraparound comparison for XIDs because that does not respect 
 * the triangle inequality!  Any old sort order will do. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1442"></a><span class='Declare_Function'>mxactMemberComparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1444"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Declare_Local'>member1</span> <span class='Operator'>= *</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN1442"><span class='Ref_to_Parameter'>arg1</span></a><span class='Delimiter'>; 
</span><a name="LN1445"></a>    <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Declare_Local'>member2</span> <span class='Operator'>= *</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN1442"><span class='Ref_to_Parameter'>arg2</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1444"><span class='Ref_To_Local'>member1</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>&GT; </span><a href="multixact.c.html#LN1445"><span class='Ref_To_Local'>member2</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1444"><span class='Ref_To_Local'>member1</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN1445"><span class='Ref_To_Local'>member2</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1444"><span class='Ref_To_Local'>member1</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>&GT; </span><a href="multixact.c.html#LN1445"><span class='Ref_To_Local'>member2</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1444"><span class='Ref_To_Local'>member1</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN1445"><span class='Ref_To_Local'>member2</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * mXactCacheGetBySet 
 *      returns a MultiXactId from the cache based on the set of 
 *      TransactionIds that compose it, or InvalidMultiXactId if 
 *      none matches. 
 * 
 * This is helpful, for example, if two transactions want to lock a huge 
 * table.  By using the cache, the second will use the same MultiXactId 
 * for the majority of tuples, thus keeping MultiXactId usage low (saving 
 * both I/O and wraparound issues). 
 * 
 * NB: the passed members array will be sorted in-place. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN1472"></a><span class='Declare_Function'>mXactCacheGetBySet</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1474"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CacheGet: looking for %s"</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sort the array so comparison is easy */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN346"><span class='Ref_to_Proto'>mxactMemberComparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1474"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1484"></a>        <a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1474"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1484"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN315"><span class='Ref_to_Member'>nmembers</span></a> <span class='Operator'>!= </span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We assume the cache entries are sorted, and that the unused bits in 
         * "status" are zeroed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1484"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN317"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1472"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CacheGet: found %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1484"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN314"><span class='Ref_to_Member'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/lib/ilist.h.html#LN383"><span class='Ref_to_Func'>dlist_move_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1474"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="multixact.c.html#LN1484"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN314"><span class='Ref_to_Member'>multi</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CacheGet: not found :-("</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mXactCacheGetBySet &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * mXactCacheGetById 
 *      returns the composing MultiXactMember set from the cache for a 
 *      given MultiXactId, if present. 
 * 
 * If successful, *xids is set to the address of a palloc'd copy of the 
 * MultiXactMember set.  Return value is number of members, or -1 on failure. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1514"></a><span class='Declare_Function'>mXactCacheGetById</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1516"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CacheGet: looking for %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1514"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1516"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1522"></a>        <a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1516"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1522"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN314"><span class='Ref_to_Member'>multi</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN1514"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1526"></a>            <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN1527"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
            <a href="multixact.c.html#LN1527"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="multixact.c.html#LN1522"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN315"><span class='Ref_to_Member'>nmembers</span></a><span class='Delimiter'>; 
</span>            <a href="multixact.c.html#LN1526"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1527"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="multixact.c.html#LN1514"><span class='Ref_to_Parameter'>members</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1526"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><a href="multixact.c.html#LN1526"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1522"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN317"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1527"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CacheGet: found %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1514"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN1522"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN315"><span class='Ref_to_Member'>nmembers</span></a><span class='Delimiter'>, 
</span>                                       <a href="multixact.c.html#LN1522"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN317"><span class='Ref_to_Member'>members</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Note we modify the list while not using a modifiable iterator. 
             * This is acceptable only because we exit the iteration 
             * immediately afterwards. 
             */ 
</span>            <a href="../../../include/lib/ilist.h.html#LN383"><span class='Ref_to_Func'>dlist_move_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1516"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="multixact.c.html#LN1522"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN315"><span class='Ref_to_Member'>nmembers</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if entry-&GT;multi==multi &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CacheGet: not found"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mXactCacheGetById &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * mXactCachePut 
 *      Add a new MultiXactId and its composing set into the local cache. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1560"></a><span class='Declare_Function'>mXactCachePut</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1562"></a>    <a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CachePut: storing %s"</span><span class='Delimiter'>, 
</span>                <a href="../../../include/access/multixact.h.html#LN156"><span class='Ref_to_Proto'>mxid_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN323"><span class='Ref_to_Global_Var'>MXactContext</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The cache only lives as long as the current transaction */ 
</span>        <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CachePut: initializing memory context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN323"><span class='Ref_to_Global_Var'>MXactContext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                                             <span class='String'>"MultiXact cache context"</span><span class='Delimiter'>, 
</span>                                             <a href="../../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="multixact.c.html#LN1562"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN323"><span class='Ref_to_Global_Var'>MXactContext</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>members</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                           <a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1562"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN314"><span class='Ref_to_Member'>multi</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1562"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN315"><span class='Ref_to_Member'>nmembers</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="multixact.c.html#LN1562"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN317"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* mXactCacheGetBySet assumes the entries are sorted, so sort them */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1562"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN317"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1560"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN346"><span class='Ref_to_Proto'>mxactMemberComparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN1562"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN316"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN322"><span class='Ref_to_Global_Var'>MXactCacheMembers</span></a><span class='Operator'>++ &GT;= </span><a href="multixact.c.html#LN320"><span class='Ref_to_Const'>MAX_CACHE_ENTRIES</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1591"></a>        <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>node</span><span class='Delimiter'>; 
</span><a name="LN1592"></a>        <a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1591"><span class='Ref_To_Local'>node</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN464"><span class='Ref_to_Func'>dlist_tail_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1591"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN322"><span class='Ref_to_Global_Var'>MXactCacheMembers</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN1592"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN312"><span class='Ref_to_Struct'>mXactCacheEnt</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1591"><span class='Ref_To_Local'>node</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1591"><span class='Ref_To_Local'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"CachePut: pruning cached multi %u"</span><span class='Delimiter'>, 
</span>                    <a href="multixact.c.html#LN1592"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN314"><span class='Ref_to_Member'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1592"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end mXactCachePut &raquo; </span> 
 
<span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1607"></a><span class='Declare_Function'>mxstatus_to_string</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN39"><span class='Ref_to_Typedef'>MultiXactStatus</span></a> <span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1607"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN41"><span class='Ref_to_EnumConst'>MultiXactStatusForKeyShare</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"keysh"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN42"><span class='Ref_to_EnumConst'>MultiXactStatusForShare</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"sh"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN43"><span class='Ref_to_EnumConst'>MultiXactStatusForNoKeyUpdate</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"fornokeyupd"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN44"><span class='Ref_to_EnumConst'>MultiXactStatusForUpdate</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"forupd"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN46"><span class='Ref_to_EnumConst'>MultiXactStatusNoKeyUpdate</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"nokeyupd"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/access/multixact.h.html#LN48"><span class='Ref_to_EnumConst'>MultiXactStatusUpdate</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"upd"</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized multixact status %d"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1607"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='String'>""</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end mxstatus_to_string &raquo; </span> 
 
<span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1630"></a><span class='Declare_Function'>mxid_to_string</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1632"></a>    <span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Local'>str</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1633"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1634"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1632"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1632"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN1633"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN1633"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%u %d[%u (%s)"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>multi</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                     <a href="multixact.c.html#LN352"><span class='Ref_to_Proto'>mxstatus_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1634"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN1634"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN1634"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN1633"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>", %u (%s)"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1634"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                         <a href="multixact.c.html#LN352"><span class='Ref_to_Proto'>mxstatus_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1630"><span class='Ref_to_Parameter'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1634"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN1633"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>']'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1632"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1633"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1633"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="multixact.c.html#LN1632"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mxid_to_string &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOXact_MultiXact 
 *      Handle transaction end for MultiXact 
 * 
 * This is called at top transaction commit or abort (we don't care which). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1661"></a><span class='Declare_Function'>AtEOXact_MultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Reset our OldestMemberMXactId and OldestVisibleMXactId values, both of 
     * which should only be valid while within a transaction. 
     * 
     * We assume that storing a MultiXactId is atomic and so we need not take 
     * MultiXactGenLock to do this. 
     */ 
</span>    <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Discard the local MultiXactId cache.  Since MXactContext was created as 
     * a child of TopTransactionContext, we needn't delete it explicitly. 
     */ 
</span>    <a href="multixact.c.html#LN323"><span class='Ref_to_Global_Var'>MXactContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN322"><span class='Ref_to_Global_Var'>MXactCacheMembers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtEOXact_MultiXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtPrepare_MultiXact 
 *      Save multixact state at 2PC transaction prepare 
 * 
 * In this phase, we only store our OldestMemberMXactId value in the two-phase 
 * state file. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1690"></a><span class='Declare_Function'>AtPrepare_MultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1692"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>myOldestMember</span> <span class='Operator'>= </span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1692"><span class='Ref_To_Local'>myOldestMember</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/twophase_rmgr.h.html#LN36"><span class='Ref_to_Proto'>RegisterTwoPhaseRecord</span></a><span class='Parentheses'>(</span><a href="../../../include/access/twophase_rmgr.h.html#LN26"><span class='Ref_to_Const'>TWOPHASE_RM_MULTIXACT_ID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="multixact.c.html#LN1692"><span class='Ref_To_Local'>myOldestMember</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PostPrepare_MultiXact 
 *      Clean up after successful PREPARE TRANSACTION 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1704"></a><span class='Declare_Function'>PostPrepare_MultiXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1706"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>myOldestMember</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Transfer our OldestMemberMXactId value to the slot reserved for the 
     * prepared transaction. 
     */ 
</span>    <a href="multixact.c.html#LN1706"><span class='Ref_To_Local'>myOldestMember</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1706"><span class='Ref_To_Local'>myOldestMember</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1715"></a>        <a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a>   <span class='Declare_Local'>dummyBackendId</span> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN36"><span class='Ref_to_Proto'>TwoPhaseGetDummyBackendId</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1704"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Even though storing MultiXactId is atomic, acquire lock to make 
         * sure others see both changes, not just the reset of the slot of the 
         * current backend. Using a volatile pointer might suffice, but this 
         * isn't a hot spot. 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1715"><span class='Ref_To_Local'>dummyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="multixact.c.html#LN1706"><span class='Ref_To_Local'>myOldestMember</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't need to transfer OldestVisibleMXactId value, because the 
     * transaction is not going to be looking at any more multixacts once it's 
     * prepared. 
     * 
     * We assume that storing a MultiXactId is atomic and so we need not take 
     * MultiXactGenLock to do this. 
     */ 
</span>    <a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a><span class='Delimiter'>[</span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Discard the local MultiXactId cache like in AtEOX_MultiXact 
     */ 
</span>    <a href="multixact.c.html#LN323"><span class='Ref_to_Global_Var'>MXactContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN321"><span class='Ref_to_Global_Var'>MXactCache</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN322"><span class='Ref_to_Global_Var'>MXactCacheMembers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PostPrepare_MultiXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * multixact_twophase_recover 
 *      Recover the state of a prepared transaction at startup 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1754"></a><span class='Declare_Function'>multixact_twophase_recover</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN1755"></a>                           <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1757"></a>    <a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a>   <span class='Declare_Local'>dummyBackendId</span> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN36"><span class='Ref_to_Proto'>TwoPhaseGetDummyBackendId</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1754"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1758"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMember</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the oldest member XID from the state file record, and set it in the 
     * OldestMemberMXactId slot reserved for this prepared transaction. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN1755"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1758"><span class='Ref_To_Local'>oldestMember</span></a> <span class='Operator'>= *</span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN1755"><span class='Ref_to_Parameter'>recdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1757"><span class='Ref_To_Local'>dummyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="multixact.c.html#LN1758"><span class='Ref_To_Local'>oldestMember</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * multixact_twophase_postcommit 
 *      Similar to AtEOX_MultiXact but for COMMIT PREPARED 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1775"></a><span class='Declare_Function'>multixact_twophase_postcommit</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN1776"></a>                              <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1778"></a>    <a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a>   <span class='Declare_Local'>dummyBackendId</span> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN36"><span class='Ref_to_Proto'>TwoPhaseGetDummyBackendId</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1775"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN1776"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN1778"><span class='Ref_To_Local'>dummyBackendId</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * multixact_twophase_postabort 
 *      This is actually just the same as the COMMIT case. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1790"></a><span class='Declare_Function'>multixact_twophase_postabort</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN1791"></a>                             <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/access/multixact.h.html#LN148"><span class='Ref_to_Proto'>multixact_twophase_postcommit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1790"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1790"><span class='Ref_to_Parameter'>info</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1791"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1791"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialization of shared memory for MultiXact.  We use two SLRU areas, 
 * thus double memory.  Also, reserve space for the shared MultiXactState 
 * struct and the per-backend MultiXactId arrays (two of those, too). 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1802"></a><span class='Declare_Function'>MultiXactShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1804"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We need 2*MaxOldestSlot + 1 perBackendXactIds[] entries */ 
</span><a name="LN1807"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SHARED_MULTIXACT_STATE_SIZE</span> <span class='Operator'>\ 
</span>    <a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN199"><span class='Ref_to_Struct'>MultiXactStateData</span></a><span class='Delimiter'>, </span>perBackendXactIds<span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>             <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN287"><span class='Ref_to_Const'>MaxOldestSlot</span></a><span class='Parentheses'>))</span> 
 
    <a href="multixact.c.html#LN1804"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN1807"><span class='Ref_to_Const'>SHARED_MULTIXACT_STATE_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1804"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1804"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="slru.c.html#LN143"><span class='Ref_to_Func'>SimpleLruShmemSize</span></a><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN31"><span class='Ref_to_Const'>NUM_MXACTOFFSET_BUFFERS</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN1804"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1804"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="slru.c.html#LN143"><span class='Ref_to_Func'>SimpleLruShmemSize</span></a><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN32"><span class='Ref_to_Const'>NUM_MXACTMEMBER_BUFFERS</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN1804"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN1819"></a><span class='Declare_Function'>MultiXactShmemInit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1821"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN326"><span class='Ref_to_Macro'>debug_elog2</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Shared Memory Init for MultiXact"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>PagePrecedes <span class='Operator'>= </span><a href="multixact.c.html#LN357"><span class='Ref_to_Proto'>MultiXactOffsetPagePrecedes</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>PagePrecedes <span class='Operator'>= </span><a href="multixact.c.html#LN358"><span class='Ref_to_Proto'>MultiXactMemberPagePrecedes</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/slru.h.html#LN144"><span class='Ref_to_Proto'>SimpleLruInit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, 
</span>                  <span class='String'>"multixact_offset"</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN31"><span class='Ref_to_Const'>NUM_MXACTOFFSET_BUFFERS</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                  MultiXactOffsetControlLock<span class='Delimiter'>, </span><span class='String'>"pg_multixact/offsets"</span><span class='Delimiter'>, 
</span>                  <a href="../../../include/storage/lwlock.h.html#LN200"><span class='Ref_to_EnumConst'>LWTRANCHE_MXACTOFFSET_BUFFERS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/slru.h.html#LN144"><span class='Ref_to_Proto'>SimpleLruInit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, 
</span>                  <span class='String'>"multixact_member"</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN32"><span class='Ref_to_Const'>NUM_MXACTMEMBER_BUFFERS</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                  MultiXactMemberControlLock<span class='Delimiter'>, </span><span class='String'>"pg_multixact/members"</span><span class='Delimiter'>, 
</span>                  <a href="../../../include/storage/lwlock.h.html#LN201"><span class='Ref_to_EnumConst'>LWTRANCHE_MXACTMEMBER_BUFFERS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize our shared state struct */ 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Shared MultiXact State"</span><span class='Delimiter'>, 
</span>                                     <a href="multixact.c.html#LN1807"><span class='Ref_to_Const'>SHARED_MULTIXACT_STATE_SIZE</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="multixact.c.html#LN1821"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN1821"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Make sure we zero out the per-backend state */ 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN1807"><span class='Ref_to_Const'>SHARED_MULTIXACT_STATE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN1821"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up array pointers.  Note that perBackendXactIds[0] is wasted space 
     * since we only use indexes 1..MaxOldestSlot in each array. 
     */ 
</span>    <a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN280"><span class='Ref_to_Member'>perBackendXactIds</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN287"><span class='Ref_to_Const'>MaxOldestSlot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactShmemInit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * This func must be called ONCE on system install.  It creates the initial 
 * MultiXact segments.  (The MultiXacts directories are assumed to have been 
 * created by initdb, and MultiXactShmemInit must have been called already.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1865"></a><span class='Declare_Function'>BootStrapMultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1867"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create and zero the first page of the offsets log */ 
</span>    <a href="multixact.c.html#LN1867"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN355"><span class='Ref_to_Proto'>ZeroMultiXactOffsetPage</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure it's written out */ 
</span>    <a href="../../../include/access/slru.h.html#LN151"><span class='Ref_to_Proto'>SimpleLruWritePage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1867"><span class='Ref_To_Local'>slotno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN1867"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create and zero the first page of the members log */ 
</span>    <a href="multixact.c.html#LN1867"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN356"><span class='Ref_to_Proto'>ZeroMultiXactMemberPage</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure it's written out */ 
</span>    <a href="../../../include/access/slru.h.html#LN151"><span class='Ref_to_Proto'>SimpleLruWritePage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1867"><span class='Ref_To_Local'>slotno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN1867"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BootStrapMultiXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize (or reinitialize) a page of MultiXactOffset to zeroes. 
 * If writeXlog is TRUE, also emit an XLOG record saying we did this. 
 * 
 * The page is not actually written, just set up in shared memory. 
 * The slot number of the new page is returned. 
 * 
 * Control lock must be held at entry, and will be held at exit. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1902"></a><span class='Declare_Function'>ZeroMultiXactOffsetPage</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pageno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>writeXlog</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1904"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1904"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN146"><span class='Ref_to_Proto'>SimpleLruZeroPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1902"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1902"><span class='Ref_to_Parameter'>writeXlog</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN367"><span class='Ref_to_Proto'>WriteMZeroPageXlogRec</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1902"><span class='Ref_to_Parameter'>pageno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN70"><span class='Ref_to_Const'>XLOG_MULTIXACT_ZERO_OFF_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN1904"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Ditto, for MultiXactMember 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1918"></a><span class='Declare_Function'>ZeroMultiXactMemberPage</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pageno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>writeXlog</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1920"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1920"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN146"><span class='Ref_to_Proto'>SimpleLruZeroPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1918"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN1918"><span class='Ref_to_Parameter'>writeXlog</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN367"><span class='Ref_to_Proto'>WriteMZeroPageXlogRec</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1918"><span class='Ref_to_Parameter'>pageno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN71"><span class='Ref_to_Const'>XLOG_MULTIXACT_ZERO_MEM_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN1920"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * MaybeExtendOffsetSlru 
 *      Extend the offsets SLRU area, if necessary 
 * 
 * After a binary upgrade from &LT;= 9.2, the pg_multixact/offset SLRU area might 
 * contain files that are shorter than necessary; this would occur if the old 
 * installation had used multixacts beyond the first page (files cannot be 
 * copied, because the on-disk representation is different).  pg_upgrade would 
 * update pg_control to set the next offset value to be at that position, so 
 * that tuples marked as locked by such MultiXacts would be seen as visible 
 * without having to consult multixact.  However, trying to create and use a 
 * new MultiXactId would result in an error because the page on which the new 
 * value would reside does not exist.  This routine is in charge of creating 
 * such pages. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1946"></a><span class='Declare_Function'>MaybeExtendOffsetSlru</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1948"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN1948"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/slru.h.html#LN154"><span class='Ref_to_Proto'>SimpleLruDoesPhysicalPageExist</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1948"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1956"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fortunately for us, SimpleLruWritePage is already prepared to deal 
         * with creating a new segment file even if the page we're writing is 
         * not the first in it, so this is enough. 
         */ 
</span>        <a href="multixact.c.html#LN1956"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN355"><span class='Ref_to_Proto'>ZeroMultiXactOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1948"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/slru.h.html#LN151"><span class='Ref_to_Proto'>SimpleLruWritePage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN1956"><span class='Ref_To_Local'>slotno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MaybeExtendOffsetSlru &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * This must be called ONCE during postmaster or standalone-backend startup. 
 * 
 * StartupXLOG has already established nextMXact/nextOffset by calling 
 * MultiXactSetNextMXact and/or MultiXactAdvanceNextMXact, and the oldestMulti 
 * info from pg_control and/or MultiXactAdvanceOldest, but we haven't yet 
 * replayed WAL. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1979"></a><span class='Declare_Function'>StartupMultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1981"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multi</span> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span><a name="LN1982"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset</span> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span><a name="LN1983"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize offset's idea of the latest page number. 
     */ 
</span>    <a href="multixact.c.html#LN1983"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1981"><span class='Ref_To_Local'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>latest_page_number <span class='Operator'>= </span><a href="multixact.c.html#LN1983"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize member's idea of the latest page number. 
     */ 
</span>    <a href="multixact.c.html#LN1983"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN1982"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>latest_page_number <span class='Operator'>= </span><a href="multixact.c.html#LN1983"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This must be called ONCE at the end of startup/recovery. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2002"></a><span class='Declare_Function'>TrimMultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2004"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMXact</span><span class='Delimiter'>; 
</span><a name="LN2005"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN2006"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMXact</span><span class='Delimiter'>; 
</span><a name="LN2007"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>oldestMXactDB</span><span class='Delimiter'>; 
</span><a name="LN2008"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN2009"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>entryno</span><span class='Delimiter'>; 
</span><a name="LN2010"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>flagsoff</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2004"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2005"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2006"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2007"><span class='Ref_To_Local'>oldestMXactDB</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up offsets state */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * (Re-)Initialize our idea of the latest page number for offsets. 
     */ 
</span>    <a href="multixact.c.html#LN2008"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2004"><span class='Ref_To_Local'>nextMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>latest_page_number <span class='Operator'>= </span><a href="multixact.c.html#LN2008"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Zero out the remainder of the current offsets page.  See notes in 
     * TrimCLOG() for background.  Unlike CLOG, some WAL record covers every 
     * pg_multixact SLRU mutation.  Since, also unlike CLOG, we ignore the WAL 
     * rule "write xlog before data," nextMXact successors may carry obsolete, 
     * nonzero offset values.  Zero those so case 2 of GetMultiXactIdMembers() 
     * operates normally. 
     */ 
</span>    <a href="multixact.c.html#LN2009"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN112"><span class='Ref_to_Macro'>MultiXactIdToOffsetEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2004"><span class='Ref_To_Local'>nextMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2009"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2039"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span><a name="LN2040"></a>        <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Local'>offptr</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN2039"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2008"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN2004"><span class='Ref_To_Local'>nextMXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2040"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN2039"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]; 
</span>        <a href="multixact.c.html#LN2040"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN2009"><span class='Ref_To_Local'>entryno</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2040"><span class='Ref_To_Local'>offptr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>BLCKSZ <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN2009"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN2039"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And the same for members */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * (Re-)Initialize our idea of the latest page number for members. 
     */ 
</span>    <a href="multixact.c.html#LN2008"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2005"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>latest_page_number <span class='Operator'>= </span><a href="multixact.c.html#LN2008"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Zero out the remainder of the current members page.  See notes in 
     * TrimCLOG() for motivation. 
     */ 
</span>    <a href="multixact.c.html#LN2010"><span class='Ref_To_Local'>flagsoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN162"><span class='Ref_to_Macro'>MXOffsetToFlagsOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2005"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2010"><span class='Ref_To_Local'>flagsoff</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2069"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span><a name="LN2070"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xidptr</span><span class='Delimiter'>; 
</span><a name="LN2071"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>memberoff</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN2071"><span class='Ref_To_Local'>memberoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN171"><span class='Ref_to_Macro'>MXOffsetToMemberOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2005"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2069"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN147"><span class='Ref_to_Proto'>SimpleLruReadPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2008"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN2005"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2070"><span class='Ref_To_Local'>xidptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN2069"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><a href="multixact.c.html#LN2071"><span class='Ref_To_Local'>memberoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2070"><span class='Ref_To_Local'>xidptr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>BLCKSZ <span class='Operator'>- </span><a href="multixact.c.html#LN2071"><span class='Ref_To_Local'>memberoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note: we don't need to zero out the flag bits in the remaining 
         * members of the current group, because they are always reset before 
         * writing. 
         */ 
</span> 
        <a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN2069"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if flagsoff!=0 &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* signal that we're officially up */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN208"><span class='Ref_to_Member'>finishedStartup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now compute how far away the next members wraparound is. */ 
</span>    <a href="../../../include/access/multixact.h.html#LN128"><span class='Ref_to_Proto'>SetMultiXactIdLimit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2006"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2007"><span class='Ref_To_Local'>oldestMXactDB</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TrimMultiXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * This must be called ONCE during postmaster or standalone-backend shutdown 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2104"></a><span class='Declare_Function'>ShutdownMultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Flush dirty MultiXact pages to disk */ 
</span>    TRACE_POSTGRESQL_MULTIXACT_CHECKPOINT_START<span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/slru.h.html#LN152"><span class='Ref_to_Proto'>SimpleLruFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/slru.h.html#LN152"><span class='Ref_to_Proto'>SimpleLruFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    TRACE_POSTGRESQL_MULTIXACT_CHECKPOINT_DONE<span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get the MultiXact data to save in a checkpoint record 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2117"></a><span class='Declare_Function'>MultiXactGetCheckptMulti</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_shutdown</span><span class='Delimiter'>, 
</span><a name="LN2118"></a>                         <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nextMulti</span><span class='Delimiter'>, 
</span><a name="LN2119"></a>                         <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nextMultiOffset</span><span class='Delimiter'>, 
</span><a name="LN2120"></a>                         <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>oldestMulti</span><span class='Delimiter'>, 
</span><a name="LN2121"></a>                         <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>oldestMultiDB</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="multixact.c.html#LN2118"><span class='Ref_to_Parameter'>nextMulti</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="multixact.c.html#LN2119"><span class='Ref_to_Parameter'>nextMultiOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="multixact.c.html#LN2120"><span class='Ref_to_Parameter'>oldestMulti</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="multixact.c.html#LN2121"><span class='Ref_to_Parameter'>oldestMultiDB</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN330"><span class='Ref_to_Macro'>debug_elog6</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='String'>"MultiXact: checkpoint is nextMulti %u, nextOffset %u, oldestMulti %u in DB %u"</span><span class='Delimiter'>, 
</span>                <span class='Operator'>*</span><a href="multixact.c.html#LN2118"><span class='Ref_to_Parameter'>nextMulti</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="multixact.c.html#LN2119"><span class='Ref_to_Parameter'>nextMultiOffset</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="multixact.c.html#LN2120"><span class='Ref_to_Parameter'>oldestMulti</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="multixact.c.html#LN2121"><span class='Ref_to_Parameter'>oldestMultiDB</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Perform a checkpoint --- either during shutdown, or on-the-fly 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2139"></a><span class='Declare_Function'>CheckPointMultiXact</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    TRACE_POSTGRESQL_MULTIXACT_CHECKPOINT_START<span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Flush dirty MultiXact pages to disk */ 
</span>    <a href="../../../include/access/slru.h.html#LN152"><span class='Ref_to_Proto'>SimpleLruFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/slru.h.html#LN152"><span class='Ref_to_Proto'>SimpleLruFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_MULTIXACT_CHECKPOINT_DONE<span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set the next-to-be-assigned MultiXactId and offset 
 * 
 * This is used when we can determine the correct next ID/offset exactly 
 * from a checkpoint record.  Although this is only called during bootstrap 
 * and XLog replay, we take the lock in case any hot-standby backends are 
 * examining the values. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2159"></a><span class='Declare_Function'>MultiXactSetNextMXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>nextMulti</span><span class='Delimiter'>, 
</span><a name="LN2160"></a>                      <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>nextMultiOffset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="multixact.c.html#LN328"><span class='Ref_to_Macro'>debug_elog4</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"MultiXact: setting next multi to %u offset %u"</span><span class='Delimiter'>, 
</span>                <a href="multixact.c.html#LN2159"><span class='Ref_to_Parameter'>nextMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2160"><span class='Ref_to_Parameter'>nextMultiOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2159"><span class='Ref_to_Parameter'>nextMulti</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2160"><span class='Ref_to_Parameter'>nextMultiOffset</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * During a binary upgrade, make sure that the offsets SLRU is large 
     * enough to contain the next value that would be created. 
     * 
     * We need to do this pretty early during the first startup in binary 
     * upgrade mode: before StartupMultiXact() in fact, because this routine 
     * is called even before that by StartupXLOG().  And we can't do it 
     * earlier than at this point, because during that first call of this 
     * routine we determine the MultiXactState-&GT;nextMXact value that 
     * MaybeExtendOffsetSlru needs. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN1945"><span class='Ref_to_Func'>MaybeExtendOffsetSlru</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactSetNextMXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine the last safe MultiXactId to allocate given the currently oldest 
 * datminmxid (ie, the oldest MultiXactId that might exist in any database 
 * of our cluster), and the OID of the (or a) database with that value. 
 * 
 * is_startup is true when we are just starting the cluster, false when we 
 * are updating state in a running cluster.  This only affects log messages. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2193"></a><span class='Declare_Function'>SetMultiXactIdLimit</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>oldest_datminmxid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldest_datoid</span><span class='Delimiter'>, 
</span><a name="LN2194"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_startup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2196"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiVacLimit</span><span class='Delimiter'>; 
</span><a name="LN2197"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiWarnLimit</span><span class='Delimiter'>; 
</span><a name="LN2198"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiStopLimit</span><span class='Delimiter'>; 
</span><a name="LN2199"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiWrapLimit</span><span class='Delimiter'>; 
</span><a name="LN2200"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>curMulti</span><span class='Delimiter'>; 
</span><a name="LN2201"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needs_offset_vacuum</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datminmxid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We pretend that a wrap will happen halfway through the multixact ID 
     * space, but that's not really true, because multixacts wrap differently 
     * from transaction IDs.  Note that, separately from any concern about 
     * multixact IDs wrapping, we must ensure that multixact members do not 
     * wrap.  Limits for that are set in DetermineSafeOldestOffset, not here. 
     */ 
</span>    <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datminmxid</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN24"><span class='Ref_to_Const'>MaxMultiXactId</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>+= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We'll refuse to continue assigning MultiXactIds once we get within 100 
     * multi of data loss. 
     * 
     * Note: This differs from the magic number used in 
     * SetTransactionIdLimit() since vacuum itself will never generate new 
     * multis.  XXX actually it does, if it needs to freeze old multis. 
     */ 
</span>    <a href="multixact.c.html#LN2198"><span class='Ref_To_Local'>multiStopLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2198"><span class='Ref_To_Local'>multiStopLimit</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2198"><span class='Ref_To_Local'>multiStopLimit</span></a> <span class='Operator'>-= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We'll start complaining loudly when we get within 10M multis of the 
     * stop point.   This is kind of arbitrary, but if you let your gas gauge 
     * get down to 1% of full, would you be looking for the next gas station? 
     * We need to be fairly liberal about this number because there are lots 
     * of scenarios where most transactions are done by automatic clients that 
     * won't pay attention to warnings. (No, we're not gonna make this 
     * configurable.  If you know enough to configure it, you know enough to 
     * not get in this kind of trouble in the first place.) 
     */ 
</span>    <a href="multixact.c.html#LN2197"><span class='Ref_To_Local'>multiWarnLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2198"><span class='Ref_To_Local'>multiStopLimit</span></a> <span class='Operator'>- </span><span class='Number'>10000000</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2197"><span class='Ref_To_Local'>multiWarnLimit</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2197"><span class='Ref_To_Local'>multiWarnLimit</span></a> <span class='Operator'>-= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We'll start trying to force autovacuums when oldest_datminmxid gets to 
     * be more than autovacuum_multixact_freeze_max_age mxids old. 
     * 
     * Note: autovacuum_multixact_freeze_max_age is a PGC_POSTMASTER parameter 
     * so that we don't have to worry about dealing with on-the-fly changes in 
     * its value.  See SetTransactionIdLimit. 
     */ 
</span>    <a href="multixact.c.html#LN2196"><span class='Ref_To_Local'>multiVacLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datminmxid</span></a> <span class='Operator'>+ </span><a href="../../postmaster/autovacuum.c.html#LN120"><span class='Ref_to_Global_Var'>autovacuum_multixact_freeze_max_age</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2196"><span class='Ref_To_Local'>multiVacLimit</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2196"><span class='Ref_To_Local'>multiVacLimit</span></a> <span class='Operator'>+= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Grab lock for just long enough to set the new limit values */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datminmxid</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datoid</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN227"><span class='Ref_to_Member'>multiVacLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2196"><span class='Ref_To_Local'>multiVacLimit</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN228"><span class='Ref_to_Member'>multiWarnLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2197"><span class='Ref_To_Local'>multiWarnLimit</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN229"><span class='Ref_to_Member'>multiStopLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2198"><span class='Ref_To_Local'>multiStopLimit</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN230"><span class='Ref_to_Member'>multiWrapLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Log the info */ 
</span>    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>     <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MultiXactId wrap limit is %u, limited by database with OID %u"</span><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datoid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Computing the actual limits is only possible once the data directory is 
     * in a consistent state. There's no need to compute the limits while 
     * still replaying WAL - no decisions about new multis are made even 
     * though multixact creations might be replayed. So we'll only do further 
     * checks after TrimMultiXact() has been called. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN208"><span class='Ref_to_Member'>finishedStartup</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set limits for offset vacuum. */ 
</span>    <a href="multixact.c.html#LN2201"><span class='Ref_To_Local'>needs_offset_vacuum</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN365"><span class='Ref_to_Proto'>SetOffsetVacuumLimit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2194"><span class='Ref_to_Parameter'>is_startup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If past the autovacuum force point, immediately signal an autovac 
     * request.  The reason for this is that autovac only processes one 
     * database per invocation.  Once it's finished cleaning up the oldest 
     * database, it'll call here, and we'll signal the postmaster to start 
     * another iteration immediately if there are still any old databases. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2196"><span class='Ref_To_Local'>multiVacLimit</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>         <a href="multixact.c.html#LN2201"><span class='Ref_To_Local'>needs_offset_vacuum</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& </span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/pmsignal.h.html#LN28"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_LAUNCHER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Give an immediate warning if past the wrap warn point */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2197"><span class='Ref_To_Local'>multiWarnLimit</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2299"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>oldest_datname</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can be called when not inside a transaction, for example during 
         * StartupXLOG().  In such a case we cannot do database access, so we 
         * must just report the oldest DB's OID. 
         * 
         * Note: it's also possible that get_database_name fails and returns 
         * NULL, for example because the database just got dropped.  We'll 
         * still warn, even though the warning might now be unnecessary. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
            <a href="multixact.c.html#LN2299"><span class='Ref_To_Local'>oldest_datname</span></a> <span class='Operator'>= </span><a href="../../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="multixact.c.html#LN2299"><span class='Ref_To_Local'>oldest_datname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2299"><span class='Ref_To_Local'>oldest_datname</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" must be vacuumed before %u more MultiXactId is used"</span><span class='Delimiter'>, 
</span>                                   <span class='String'>"database \"%s\" must be vacuumed before %u more MultiXactIds are used"</span><span class='Delimiter'>, 
</span>                                   <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a><span class='Delimiter'>, 
</span>                                   <a href="multixact.c.html#LN2299"><span class='Ref_To_Local'>oldest_datname</span></a><span class='Delimiter'>, 
</span>                                   <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"To avoid a database shutdown, execute a database-wide VACUUM in that database.\n"</span> 
                             <span class='String'>"You might also need to commit or roll back old prepared transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"database with OID %u must be vacuumed before %u more MultiXactId is used"</span><span class='Delimiter'>, 
</span>                                   <span class='String'>"database with OID %u must be vacuumed before %u more MultiXactIds are used"</span><span class='Delimiter'>, 
</span>                                   <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a><span class='Delimiter'>, 
</span>                                   <a href="multixact.c.html#LN2193"><span class='Ref_to_Parameter'>oldest_datoid</span></a><span class='Delimiter'>, 
</span>                                   <a href="multixact.c.html#LN2199"><span class='Ref_To_Local'>multiWrapLimit</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2200"><span class='Ref_To_Local'>curMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"To avoid a database shutdown, execute a database-wide VACUUM in that database.\n"</span> 
                             <span class='String'>"You might also need to commit or roll back old prepared transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if MultiXactIdPrecedes(m... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SetMultiXactIdLimit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Ensure the next-to-be-assigned MultiXactId is at least minMulti, 
 * and similarly nextOffset is at least minMultiOffset. 
 * 
 * This is used when we can determine minimum safe values from an XLog 
 * record (either an on-line checkpoint or an mxact creation log entry). 
 * Although this is only called during XLog replay, we take the lock in case 
 * any hot-standby backends are examining the values. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2346"></a><span class='Declare_Function'>MultiXactAdvanceNextMXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>minMulti</span><span class='Delimiter'>, 
</span><a name="LN2347"></a>                          <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>minMultiOffset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2346"><span class='Ref_to_Parameter'>minMulti</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"MultiXact: setting next multi to %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN2346"><span class='Ref_to_Parameter'>minMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2346"><span class='Ref_to_Parameter'>minMulti</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN359"><span class='Ref_to_Proto'>MultiXactOffsetPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2347"><span class='Ref_to_Parameter'>minMultiOffset</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN327"><span class='Ref_to_Macro'>debug_elog3</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"MultiXact: setting next offset to %u"</span><span class='Delimiter'>, 
</span>                    <a href="multixact.c.html#LN2347"><span class='Ref_to_Parameter'>minMultiOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2347"><span class='Ref_to_Parameter'>minMultiOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Update our oldestMultiXactId value, but only if it's more recent than what 
 * we had. 
 * 
 * This may only be called during WAL replay. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2371"></a><span class='Declare_Function'>MultiXactAdvanceOldest</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>oldestMulti</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldestMultiDB</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2371"><span class='Ref_to_Parameter'>oldestMulti</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/multixact.h.html#LN128"><span class='Ref_to_Proto'>SetMultiXactIdLimit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2371"><span class='Ref_to_Parameter'>oldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2371"><span class='Ref_to_Parameter'>oldestMultiDB</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Make sure that MultiXactOffset has room for a newly-allocated MultiXactId. 
 * 
 * NB: this is called while holding MultiXactGenLock.  We want it to be very 
 * fast most of the time; even when it's not so fast, no actual I/O need 
 * happen unless we're forced to write out a dirty log or xlog page to make 
 * room in shared memory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2388"></a><span class='Declare_Function'>ExtendMultiXactOffset</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2390"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No work except at first MultiXactId of a page.  But beware: just after 
     * wraparound, the first MultiXactId of page zero is FirstMultiXactId. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN112"><span class='Ref_to_Macro'>MultiXactIdToOffsetEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2388"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <a href="multixact.c.html#LN2388"><span class='Ref_to_Parameter'>multi</span></a> <span class='Operator'>!= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN2390"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2388"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Zero the page and make an XLOG entry about it */ 
</span>    <a href="multixact.c.html#LN355"><span class='Ref_to_Proto'>ZeroMultiXactOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2390"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExtendMultiXactOffset &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Make sure that MultiXactMember has room for the members of a newly- 
 * allocated MultiXactId. 
 * 
 * Like the above routine, this is called while holding MultiXactGenLock; 
 * same comments apply. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2418"></a><span class='Declare_Function'>ExtendMultiXactMember</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmembers</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * It's possible that the members span more than one page of the members 
     * file, so we loop to ensure we consider each page.  The coding is not 
     * optimal if the members span several pages, but that seems unusual 
     * enough to not worry much about. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2428"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flagsoff</span><span class='Delimiter'>; 
</span><a name="LN2429"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flagsbit</span><span class='Delimiter'>; 
</span><a name="LN2430"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>difference</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Only zero when at first entry of a page. 
         */ 
</span>        <a href="multixact.c.html#LN2428"><span class='Ref_To_Local'>flagsoff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN162"><span class='Ref_to_Macro'>MXOffsetToFlagsOffset</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2429"><span class='Ref_To_Local'>flagsbit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN166"><span class='Ref_to_Macro'>MXOffsetToFlagsBitShift</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2428"><span class='Ref_To_Local'>flagsoff</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="multixact.c.html#LN2429"><span class='Ref_To_Local'>flagsbit</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2439"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span> 
            <a href="multixact.c.html#LN2439"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN158"><span class='Ref_to_Macro'>MXOffsetToMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Zero the page and make an XLOG entry about it */ 
</span>            <a href="multixact.c.html#LN356"><span class='Ref_to_Proto'>ZeroMultiXactMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2439"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Compute the number of items till end of current page.  Careful: if 
         * addition of unsigned ints wraps around, we're at the last page of 
         * the last segment; since that page holds a different number of items 
         * than other pages, we need to do it differently. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN154"><span class='Ref_to_Const'>MAX_MEMBERS_IN_LAST_MEMBERS_PAGE</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This is the last page of the last segment; we can compute the 
             * number of items left to allocate in it without modulo 
             * arithmetic. 
             */ 
</span>            <a href="multixact.c.html#LN2430"><span class='Ref_To_Local'>difference</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN28"><span class='Ref_to_Const'>MaxMultiXactOffset</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="multixact.c.html#LN2430"><span class='Ref_To_Local'>difference</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>% </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Advance to next page, taking care to properly handle the wraparound 
         * case.  OK if nmembers goes negative. 
         */ 
</span>        <a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>nmembers</span></a> <span class='Operator'>-= </span><a href="multixact.c.html#LN2430"><span class='Ref_To_Local'>difference</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2418"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN2430"><span class='Ref_To_Local'>difference</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while nmembers&GT;0 &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ExtendMultiXactMember &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetOldestMultiXactId 
 * 
 * Return the oldest MultiXactId that's still possibly still seen as live by 
 * any running transaction.  Older ones might still exist on disk, but they no 
 * longer have any running member transaction. 
 * 
 * It's not safe to truncate MultiXact SLRU segments on the value returned by 
 * this function; however, it can be used by a full-table vacuum to set the 
 * point at which it will be possible to truncate SLRU for that table. 
 */ 
</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> 
<a name="LN2490"></a><span class='Declare_Function'>GetOldestMultiXactId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2492"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMXact</span><span class='Delimiter'>; 
</span><a name="LN2493"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMXact</span><span class='Delimiter'>; 
</span><a name="LN2494"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is the oldest valid value among all the OldestMemberMXactId[] and 
     * OldestVisibleMXactId[] entries, or nextMXact if none are valid. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have to beware of the possibility that nextMXact is in the 
     * wrapped-around state.  We don't fix the counter itself here, but we 
     * must be sure to use a valid value in our calculation. 
     */ 
</span>    <a href="multixact.c.html#LN2493"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2493"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2493"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN2492"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2493"><span class='Ref_To_Local'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2494"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN2494"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="multixact.c.html#LN287"><span class='Ref_to_Const'>MaxOldestSlot</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN2494"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2514"></a>        <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>thisoldest</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN291"><span class='Ref_to_Global_Var'>OldestMemberMXactId</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN2494"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2492"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Parentheses'>))</span> 
            <a href="multixact.c.html#LN2492"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN292"><span class='Ref_to_Global_Var'>OldestVisibleMXactId</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN2494"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2492"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Parentheses'>))</span> 
            <a href="multixact.c.html#LN2492"><span class='Ref_To_Local'>oldestMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2514"><span class='Ref_To_Local'>thisoldest</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN2492"><span class='Ref_To_Local'>oldestMXact</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetOldestMultiXactId &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine how aggressively we need to vacuum in order to prevent member 
 * wraparound. 
 * 
 * To do so determine what's the oldest member offset and install the limit 
 * info in MultiXactState, where it can be used to prevent overrun of old data 
 * in the members SLRU area. 
 * 
 * The return value is true if emergency autovacuum is required and false 
 * otherwise. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2543"></a><span class='Declare_Function'>SetOffsetVacuumLimit</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_startup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2545"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMultiXactId</span><span class='Delimiter'>; 
</span><a name="LN2546"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMXact</span><span class='Delimiter'>; 
</span><a name="LN2547"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>oldestOffset</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* placate compiler */ 
</span><a name="LN2548"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>prevOldestOffset</span><span class='Delimiter'>; 
</span><a name="LN2549"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>nextOffset</span><span class='Delimiter'>; 
</span><a name="LN2550"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>oldestOffsetKnown</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN2551"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>prevOldestOffsetKnown</span><span class='Delimiter'>; 
</span><a name="LN2552"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offsetStopLimit</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2553"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>prevOffsetStopLimit</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * NB: Have to prevent concurrent truncation, we might otherwise try to 
     * lookup a oldestMulti that's concurrently getting truncated away. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read relevant fields from shared memory. */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2545"><span class='Ref_To_Local'>oldestMultiXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2546"><span class='Ref_To_Local'>nextMXact</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2549"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2551"><span class='Ref_To_Local'>prevOldestOffsetKnown</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN224"><span class='Ref_to_Member'>oldestOffsetKnown</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2548"><span class='Ref_To_Local'>prevOldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN223"><span class='Ref_to_Member'>oldestOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2553"><span class='Ref_To_Local'>prevOffsetStopLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN208"><span class='Ref_to_Member'>finishedStartup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine the offset of the oldest multixact.  Normally, we can read 
     * the offset from the multixact itself, but there's an important special 
     * case: if there are no multixacts in existence at all, oldestMXact 
     * obviously can't point to one.  It will instead point to the multixact 
     * ID that will be assigned the next time one is needed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2545"><span class='Ref_To_Local'>oldestMultiXactId</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN2546"><span class='Ref_To_Local'>nextMXact</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * When the next multixact gets created, it will be stored at the next 
         * offset. 
         */ 
</span>        <a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2549"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Figure out where the oldest existing multixact's offsets are 
         * stored. Due to bugs in early release of PostgreSQL 9.3.X and 9.4.X, 
         * the supposedly-earliest multixact might not really exist.  We are 
         * careful not to fail in that case. 
         */ 
</span>        <a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a> <span class='Operator'>= 
</span>            <a href="multixact.c.html#LN366"><span class='Ref_to_Proto'>find_multixact_start</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2545"><span class='Ref_To_Local'>oldestMultiXactId</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"oldest MultiXactId member is at offset %u"</span><span class='Delimiter'>, 
</span>                            <a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MultiXact member wraparound protections are disabled because oldest checkpointed MultiXact %u does not exist on disk"</span><span class='Delimiter'>, 
</span>                            <a href="multixact.c.html#LN2545"><span class='Ref_To_Local'>oldestMultiXactId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we can, compute limits (and install them MultiXactState) to prevent 
     * overrun of old data in the members SLRU area. We can only do so if the 
     * oldest offset is known though. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* move back to start of the corresponding segment */ 
</span>        <a href="multixact.c.html#LN2552"><span class='Ref_To_Local'>offsetStopLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>% 
</span>                      <span class='Parentheses'>(</span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a> <span class='Operator'>* </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* always leave one segment before the wraparound point */ 
</span>        <a href="multixact.c.html#LN2552"><span class='Ref_To_Local'>offsetStopLimit</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a> <span class='Operator'>* </span><a href="../../../include/access/slru.h.html#LN36"><span class='Ref_to_Const'>SLRU_PAGES_PER_SEGMENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN2551"><span class='Ref_To_Local'>prevOldestOffsetKnown</span></a> <span class='Operator'>&& !</span><a href="multixact.c.html#LN2543"><span class='Ref_to_Parameter'>is_startup</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MultiXact member wraparound protections are now enabled"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>        <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MultiXact member stop limit is now %u based on MultiXact %u"</span><span class='Delimiter'>, 
</span>                <a href="multixact.c.html#LN2552"><span class='Ref_To_Local'>offsetStopLimit</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2545"><span class='Ref_To_Local'>oldestMultiXactId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2551"><span class='Ref_To_Local'>prevOldestOffsetKnown</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we failed to get the oldest offset this time, but we have a 
         * value from a previous pass through this function, use the old 
         * values rather than automatically forcing an emergency autovacuum 
         * cycle again. 
         */ 
</span>        <a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2548"><span class='Ref_To_Local'>prevOldestOffset</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2552"><span class='Ref_To_Local'>offsetStopLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2553"><span class='Ref_To_Local'>prevOffsetStopLimit</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Install the computed values */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN223"><span class='Ref_to_Member'>oldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN224"><span class='Ref_to_Member'>oldestOffsetKnown</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN233"><span class='Ref_to_Member'>offsetStopLimit</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2552"><span class='Ref_To_Local'>offsetStopLimit</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do we need an emergency autovacuum?  If we're not sure, assume yes. 
     */ 
</span>    <span class='Control'>return</span> <span class='Operator'>!</span><a href="multixact.c.html#LN2550"><span class='Ref_To_Local'>oldestOffsetKnown</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="multixact.c.html#LN2549"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2547"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>&GT; </span><a href="multixact.c.html#LN176"><span class='Ref_to_Const'>MULTIXACT_MEMBER_SAFE_THRESHOLD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetOffsetVacuumLimit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return whether adding "distance" to "start" would move past "boundary". 
 * 
 * We use this to determine whether the addition is "wrapping around" the 
 * boundary point, hence the name.  The reason we don't want to use the regular 
 * 2^31-modulo arithmetic here is that we want to be able to use the whole of 
 * the 2^32-1 space here, allowing for more multixacts that would fit 
 * otherwise. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2670"></a><span class='Declare_Function'>MultiXactOffsetWouldWrap</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>boundary</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>start</span><span class='Delimiter'>, 
</span><a name="LN2671"></a>                         <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>distance</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2673"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>finish</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that offset number 0 is not used (see GetMultiXactIdMembers), so 
     * if the addition wraps around the UINT_MAX boundary, skip that value. 
     */ 
</span>    <a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>start</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN2671"><span class='Ref_to_Parameter'>distance</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>start</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*----------------------------------------------------------------------- 
     * When the boundary is numerically greater than the starting point, any 
     * value numerically between the two is not wrapped: 
     * 
     *  &LT;----S----B----&GT; 
     *  [---)            = F wrapped past B (and UINT_MAX) 
     *       [---)       = F not wrapped 
     *            [----] = F wrapped past B 
     * 
     * When the boundary is numerically less than the starting point (i.e. the 
     * UINT_MAX wraparound occurs somewhere in between) then all values in 
     * between are wrapped: 
     * 
     *  &LT;----B----S----&GT; 
     *  [---)            = F not wrapped past B (but wrapped past UINT_MAX) 
     *       [---)       = F wrapped past B (and UINT_MAX) 
     *            [----] = F not wrapped 
     *----------------------------------------------------------------------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>start</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>boundary</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a> <span class='Operator'>&GT;= </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>boundary</span></a> <span class='Operator'>|| </span><a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>start</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a> <span class='Operator'>&GT;= </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>boundary</span></a> <span class='Operator'>&& </span><a href="multixact.c.html#LN2673"><span class='Ref_To_Local'>finish</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN2670"><span class='Ref_to_Parameter'>start</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactOffsetWouldWrap &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find the starting offset of the given MultiXactId. 
 * 
 * Returns false if the file containing the multi does not exist on disk. 
 * Otherwise, returns true and sets *result to the starting member offset. 
 * 
 * This function does not prevent concurrent truncation, so if that's 
 * required, the caller has to protect against that. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2718"></a><span class='Declare_Function'>find_multixact_start</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2720"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN2721"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN2722"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>entryno</span><span class='Delimiter'>; 
</span><a name="LN2723"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span><a name="LN2724"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Local'>offptr</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN208"><span class='Ref_to_Member'>finishedStartup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN2721"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2718"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2722"><span class='Ref_To_Local'>entryno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN112"><span class='Ref_to_Macro'>MultiXactIdToOffsetEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2718"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flush out dirty data, so PhysicalPageExists can work correctly. 
     * SimpleLruFlush() is a pretty big hammer for that.  Alternatively we 
     * could add a in-memory version of page exists, but find_multixact_start 
     * is called infrequently, and it doesn't seem bad to flush buffers to 
     * disk before truncation. 
     */ 
</span>    <a href="../../../include/access/slru.h.html#LN152"><span class='Ref_to_Proto'>SimpleLruFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/slru.h.html#LN152"><span class='Ref_to_Proto'>SimpleLruFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/slru.h.html#LN154"><span class='Ref_to_Proto'>SimpleLruDoesPhysicalPageExist</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2721"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* lock is acquired by SimpleLruReadPage_ReadOnly */ 
</span>    <a href="multixact.c.html#LN2723"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="../../../include/access/slru.h.html#LN149"><span class='Ref_to_Proto'>SimpleLruReadPage_ReadOnly</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2721"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2718"><span class='Ref_to_Parameter'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2724"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_buffer<span class='Delimiter'>[</span><a href="multixact.c.html#LN2723"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]; 
</span>    <a href="multixact.c.html#LN2724"><span class='Ref_To_Local'>offptr</span></a> <span class='Operator'>+= </span><a href="multixact.c.html#LN2722"><span class='Ref_To_Local'>entryno</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2720"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= *</span><a href="multixact.c.html#LN2724"><span class='Ref_To_Local'>offptr</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="multixact.c.html#LN2718"><span class='Ref_to_Parameter'>result</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2720"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end find_multixact_start &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine how many multixacts, and how many multixact members, currently 
 * exist.  Return false if unable to determine. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2760"></a><span class='Declare_Function'>ReadMultiXactCounts</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>multixacts</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>members</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2762"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>nextOffset</span><span class='Delimiter'>; 
</span><a name="LN2763"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>oldestOffset</span><span class='Delimiter'>; 
</span><a name="LN2764"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMultiXactId</span><span class='Delimiter'>; 
</span><a name="LN2765"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMultiXactId</span><span class='Delimiter'>; 
</span><a name="LN2766"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>oldestOffsetKnown</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2762"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2764"><span class='Ref_To_Local'>oldestMultiXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2765"><span class='Ref_To_Local'>nextMultiXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2763"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN223"><span class='Ref_to_Member'>oldestOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2766"><span class='Ref_To_Local'>oldestOffsetKnown</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN224"><span class='Ref_to_Member'>oldestOffsetKnown</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN2766"><span class='Ref_To_Local'>oldestOffsetKnown</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="multixact.c.html#LN2760"><span class='Ref_to_Parameter'>members</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2762"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2763"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="multixact.c.html#LN2760"><span class='Ref_to_Parameter'>multixacts</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2765"><span class='Ref_To_Local'>nextMultiXactId</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2764"><span class='Ref_To_Local'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReadMultiXactCounts &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Multixact members can be removed once the multixacts that refer to them 
 * are older than every datminxmid.  autovacuum_multixact_freeze_max_age and 
 * vacuum_multixact_freeze_table_age work together to make sure we never have 
 * too many multixacts; we hope that, at least under normal circumstances, 
 * this will also be sufficient to keep us from using too many offsets. 
 * However, if the average multixact has many members, we might exhaust the 
 * members space while still using few enough members that these limits fail 
 * to trigger full table scans for relminmxid advancement.  At that point, 
 * we'd have no choice but to start failing multixact-creating operations 
 * with an error. 
 * 
 * To prevent that, if more than a threshold portion of the members space is 
 * used, we effectively reduce autovacuum_multixact_freeze_max_age and 
 * to a value just less than the number of multixacts in use.  We hope that 
 * this will quickly trigger autovacuuming on the table or tables with the 
 * oldest relminmxid, thus allowing datminmxid values to advance and removing 
 * some members. 
 * 
 * As the fraction of the member space currently in use grows, we become 
 * more aggressive in clamping this value.  That not only causes autovacuum 
 * to ramp up, but also makes any manual vacuums the user issues more 
 * aggressive.  This happens because vacuum_set_xid_limits() clamps the 
 * freeze table and the minimum freeze age based on the effective 
 * autovacuum_multixact_freeze_max_age this function returns.  In the worst 
 * case, we'll claim the freeze_max_age to zero, and every vacuum of any 
 * table will try to freeze every multixact. 
 * 
 * It's possible that these thresholds should be user-tunable, but for now 
 * we keep it simple. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2816"></a><span class='Declare_Function'>MultiXactMemberFreezeThreshold</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2818"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>members</span><span class='Delimiter'>; 
</span><a name="LN2819"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>multixacts</span><span class='Delimiter'>; 
</span><a name="LN2820"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>victim_multixacts</span><span class='Delimiter'>; 
</span><a name="LN2821"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>fraction</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we can't determine member space utilization, assume the worst. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN2759"><span class='Ref_to_Func'>ReadMultiXactCounts</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN2819"><span class='Ref_To_Local'>multixacts</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN2818"><span class='Ref_To_Local'>members</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If member space utilization is low, no special action is required. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2818"><span class='Ref_To_Local'>members</span></a> <span class='Operator'>&LT;= </span><a href="multixact.c.html#LN176"><span class='Ref_to_Const'>MULTIXACT_MEMBER_SAFE_THRESHOLD</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../postmaster/autovacuum.c.html#LN120"><span class='Ref_to_Global_Var'>autovacuum_multixact_freeze_max_age</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute a target for relminmxid advancement.  The number of multixacts 
     * we try to eliminate from the system is based on how far we are past 
     * MULTIXACT_MEMBER_SAFE_THRESHOLD. 
     */ 
</span>    <a href="multixact.c.html#LN2821"><span class='Ref_To_Local'>fraction</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) (</span><a href="multixact.c.html#LN2818"><span class='Ref_To_Local'>members</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN176"><span class='Ref_to_Const'>MULTIXACT_MEMBER_SAFE_THRESHOLD</span></a><span class='Parentheses'>) </span><span class='Operator'>/ 
</span>        <span class='Parentheses'>(</span><a href="multixact.c.html#LN177"><span class='Ref_to_Const'>MULTIXACT_MEMBER_DANGER_THRESHOLD</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN176"><span class='Ref_to_Const'>MULTIXACT_MEMBER_SAFE_THRESHOLD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2820"><span class='Ref_To_Local'>victim_multixacts</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2819"><span class='Ref_To_Local'>multixacts</span></a> <span class='Operator'>* </span><a href="multixact.c.html#LN2821"><span class='Ref_To_Local'>fraction</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fraction could be &GT; 1.0, but lowest possible freeze age is zero */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2820"><span class='Ref_To_Local'>victim_multixacts</span></a> <span class='Operator'>&GT; </span><a href="multixact.c.html#LN2819"><span class='Ref_To_Local'>multixacts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="multixact.c.html#LN2819"><span class='Ref_To_Local'>multixacts</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN2820"><span class='Ref_To_Local'>victim_multixacts</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiXactMemberFreezeThreshold &raquo; </span> 
 
<a name="LN2846"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>mxtruncinfo</span> 
<span class='Delimiter'>{ 
</span><a name="LN2848"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>earliestExistingPage</span><span class='Delimiter'>; 
</span><a name="LN2849"></a>} <span class='Declare_Typedef'>mxtruncinfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SlruScanDirectory callback 
 *      This callback determines the earliest existing page number. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2856"></a><span class='Declare_Function'>SlruScanDirCbFindEarliest</span><span class='Parentheses'>(</span><a href="../../../include/access/slru.h.html#LN140"><span class='Ref_to_Typedef'>SlruCtl</span></a> <span class='Declare_Parameter'>ctl</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>segpage</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2858"></a>    <a href="multixact.c.html#LN2846"><span class='Ref_to_Struct'>mxtruncinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trunc</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN2846"><span class='Ref_to_Struct'>mxtruncinfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN2856"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2858"><span class='Ref_To_Local'>trunc</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN2848"><span class='Ref_to_Member'>earliestExistingPage</span></a> <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="multixact.c.html#LN2856"><span class='Ref_to_Parameter'>ctl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/slru.h.html#LN131"><span class='Ref_to_Member'>PagePrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2856"><span class='Ref_to_Parameter'>segpage</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2858"><span class='Ref_To_Local'>trunc</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN2848"><span class='Ref_to_Member'>earliestExistingPage</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="multixact.c.html#LN2858"><span class='Ref_To_Local'>trunc</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN2848"><span class='Ref_to_Member'>earliestExistingPage</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2856"><span class='Ref_to_Parameter'>segpage</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* keep going */ 
</span><span class='Delimiter'>} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete members segments [oldest, newOldest) 
 * 
 * The members SLRU can, in contrast to the offsets one, be filled to almost 
 * the full range at once. This means SimpleLruTruncate() can't trivially be 
 * used - instead the to-be-deleted range is computed using the offsets 
 * SLRU. C.f. TruncateMultiXact(). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2879"></a><span class='Declare_Function'>PerformMembersTruncation</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>oldestOffset</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>newOldestOffset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2881"></a>    <span class='Keyword'>const int</span>   <span class='Declare_Local'>maxsegment</span> <span class='Operator'>= </span><a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN28"><span class='Ref_to_Const'>MaxMultiXactOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2882"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>startsegment</span> <span class='Operator'>= </span><a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2879"><span class='Ref_to_Parameter'>oldestOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2883"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>endsegment</span> <span class='Operator'>= </span><a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2879"><span class='Ref_to_Parameter'>newOldestOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2884"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segment</span> <span class='Operator'>= </span><a href="multixact.c.html#LN2882"><span class='Ref_To_Local'>startsegment</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete all the segments but the last one. The last segment can still 
     * contain, possibly partially, valid data. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2884"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>!= </span><a href="multixact.c.html#LN2883"><span class='Ref_To_Local'>endsegment</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"truncating multixact members segment %x"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN2884"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/slru.h.html#LN159"><span class='Ref_to_Proto'>SlruDeleteSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2884"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* move to next segment, handling wraparound correctly */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2884"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN2881"><span class='Ref_To_Local'>maxsegment</span></a><span class='Parentheses'>) 
</span>            <a href="multixact.c.html#LN2884"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="multixact.c.html#LN2884"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PerformMembersTruncation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete offsets segments [oldest, newOldest) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2907"></a><span class='Declare_Function'>PerformOffsetsTruncation</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>oldestMulti</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>newOldestMulti</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We step back one multixact to avoid passing a cutoff page that hasn't 
     * been created yet in the rare case that oldestMulti would be the first 
     * item on a page and oldestMulti == nextMulti.  In that case, if we 
     * didn't subtract one, we'd trigger SimpleLruTruncate's wraparound 
     * detection. 
     */ 
</span>    <a href="../../../include/access/slru.h.html#LN153"><span class='Ref_to_Proto'>SimpleLruTruncate</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, 
</span>               <a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN180"><span class='Ref_to_Macro'>PreviousMultiXactId</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2907"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Remove all MultiXactOffset and MultiXactMember segments before the oldest 
 * ones still of interest. 
 * 
 * This is only called on a primary as part of vacuum (via 
 * vac_truncate_clog()). During recovery truncation is done by replaying 
 * truncation WAL records logged here. 
 * 
 * newOldestMulti is the oldest currently required multixact, newOldestMultiDB 
 * is one of the databases preventing newOldestMulti from increasing. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2932"></a><span class='Declare_Function'>TruncateMultiXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>newOldestMulti</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newOldestMultiDB</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2934"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>oldestMulti</span><span class='Delimiter'>; 
</span><a name="LN2935"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>nextMulti</span><span class='Delimiter'>; 
</span><a name="LN2936"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>newOldestOffset</span><span class='Delimiter'>; 
</span><a name="LN2937"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>oldestOffset</span><span class='Delimiter'>; 
</span><a name="LN2938"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>nextOffset</span><span class='Delimiter'>; 
</span><a name="LN2939"></a>    <a href="multixact.c.html#LN2846"><span class='Ref_to_Struct'>mxtruncinfo</span></a> <span class='Declare_Local'>trunc</span><span class='Delimiter'>; 
</span><a name="LN2940"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>earliest</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN208"><span class='Ref_to_Member'>finishedStartup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can only allow one truncation to happen at once. Otherwise parts of 
     * members might vanish while we're doing lookups or similar. There's no 
     * need to have an interlock with creating new multis or such, since those 
     * are constrained by the limits (which only grow, never shrink). 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2935"><span class='Ref_To_Local'>nextMulti</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN202"><span class='Ref_to_Member'>nextMXact</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2938"><span class='Ref_To_Local'>nextOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN205"><span class='Ref_to_Member'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN26"><span class='Ref_to_Macro'>MultiXactIdIsValid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure to only attempt truncation if there's values to truncate 
     * away. In normal processing values shouldn't go backwards, but there's 
     * some corner cases (due to bugs) where that's possible. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN115"><span class='Ref_to_Proto'>MultiXactIdPrecedesOrEquals</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note we can't just plow ahead with the truncation; it's possible that 
     * there are no segments to truncate, which is a problem because we are 
     * going to attempt to read the offsets page to determine where to 
     * truncate the members SLRU.  So we first scan the directory to determine 
     * the earliest offsets page number that we can read without error. 
     * 
     * NB: It's also possible that the page that oldestMulti is on has already 
     * been truncated away, and we crashed before updating oldestMulti. 
     */ 
</span>    <a href="multixact.c.html#LN2939"><span class='Ref_To_Local'>trunc</span></a><span class='Operator'>.</span><a href="multixact.c.html#LN2848"><span class='Ref_to_Member'>earliestExistingPage</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/slru.h.html#LN158"><span class='Ref_to_Proto'>SlruScanDirectory</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2855"><span class='Ref_to_Func'>SlruScanDirCbFindEarliest</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN2939"><span class='Ref_To_Local'>trunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN2940"><span class='Ref_To_Local'>earliest</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2939"><span class='Ref_To_Local'>trunc</span></a><span class='Operator'>.</span><a href="multixact.c.html#LN2848"><span class='Ref_to_Member'>earliestExistingPage</span></a> <span class='Operator'>* </span><a href="multixact.c.html#LN108"><span class='Ref_to_Const'>MULTIXACT_OFFSETS_PER_PAGE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2940"><span class='Ref_To_Local'>earliest</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="multixact.c.html#LN2940"><span class='Ref_To_Local'>earliest</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there's nothing to remove, we can bail out early. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2940"><span class='Ref_To_Local'>earliest</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, compute the safe truncation point for MultiXactMember. This is 
     * the starting offset of the oldest multixact. 
     * 
     * Hopefully, find_multixact_start will always work here, because we've 
     * already checked that it doesn't precede the earliest MultiXact on disk. 
     * But if it fails, don't truncate anything, and log a message. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN2935"><span class='Ref_To_Local'>nextMulti</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* there are NO MultiXacts */ 
</span>        <a href="multixact.c.html#LN2937"><span class='Ref_To_Local'>oldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2938"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN366"><span class='Ref_to_Proto'>find_multixact_start</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN2937"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"oldest MultiXact %u not found, earliest MultiXact %u, skipping truncation"</span><span class='Delimiter'>, 
</span>                        <a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2940"><span class='Ref_To_Local'>earliest</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Secondly compute up to where to truncate. Lookup the corresponding 
     * member offset for newOldestMulti for that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a> <span class='Operator'>== </span><a href="multixact.c.html#LN2935"><span class='Ref_To_Local'>nextMulti</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* there are NO MultiXacts */ 
</span>        <a href="multixact.c.html#LN2936"><span class='Ref_To_Local'>newOldestOffset</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2938"><span class='Ref_To_Local'>nextOffset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN366"><span class='Ref_to_Proto'>find_multixact_start</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN2936"><span class='Ref_To_Local'>newOldestOffset</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot truncate up to MultiXact %u because it does not exist on disk, skipping truncation"</span><span class='Delimiter'>, 
</span>                        <a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"performing multixact truncation: "</span> 
         <span class='String'>"offsets [%u, %u), offsets segments [%x, %x), "</span> 
         <span class='String'>"members [%u, %u), members segments [%x, %x)"</span><span class='Delimiter'>, 
</span>         <a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Delimiter'>, 
</span>         <a href="multixact.c.html#LN114"><span class='Ref_to_Macro'>MultiXactIdToOffsetSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="multixact.c.html#LN114"><span class='Ref_to_Macro'>MultiXactIdToOffsetSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="multixact.c.html#LN2937"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2936"><span class='Ref_To_Local'>newOldestOffset</span></a><span class='Delimiter'>, 
</span>         <a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2937"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2936"><span class='Ref_To_Local'>newOldestOffset</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do truncation, and the WAL logging of the truncation, in a critical 
     * section. That way offsets/members cannot get out of sync anymore, i.e. 
     * once consistent the newOldestMulti will always exist in members, even 
     * if we crashed in the wrong moment. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prevent checkpoints from being scheduled concurrently. This is critical 
     * because otherwise a truncation record might not be replayed after a 
     * crash/basebackup, even though the state of the data directory would 
     * require it. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* WAL log truncation */ 
</span>    <a href="multixact.c.html#LN368"><span class='Ref_to_Proto'>WriteMTruncateXlogRec</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMultiDB</span></a><span class='Delimiter'>, 
</span>                          <a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Delimiter'>, 
</span>                          <a href="multixact.c.html#LN2937"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2936"><span class='Ref_To_Local'>newOldestOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update in-memory limits before performing the truncation, while inside 
     * the critical section: Have to do it before truncation, to prevent 
     * concurrent lookups of those values. Has to be inside the critical 
     * section as otherwise a future call to this function would error out, 
     * while looking up the oldest member in offsets, if our caller crashes 
     * before updating the limits. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN215"><span class='Ref_to_Member'>oldestMultiXactId</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN290"><span class='Ref_to_Global_Var'>MultiXactState</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN216"><span class='Ref_to_Member'>oldestMultiXactDB</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMultiDB</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First truncate members */ 
</span>    <a href="multixact.c.html#LN2878"><span class='Ref_to_Func'>PerformMembersTruncation</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2937"><span class='Ref_To_Local'>oldestOffset</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2936"><span class='Ref_To_Local'>newOldestOffset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Then offsets */ 
</span>    <a href="multixact.c.html#LN2906"><span class='Ref_to_Func'>PerformOffsetsTruncation</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN2934"><span class='Ref_To_Local'>oldestMulti</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN2932"><span class='Ref_to_Parameter'>newOldestMulti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TruncateMultiXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Decide which of two MultiXactOffset page numbers is "older" for truncation 
 * purposes. 
 * 
 * We need to use comparison of MultiXactId here in order to do the right 
 * thing with wraparound.  However, if we are asked about page number zero, we 
 * don't want to hand InvalidMultiXactId to MultiXactIdPrecedes: it'll get 
 * weird.  So, offset both multis by FirstMultiXactId to avoid that. 
 * (Actually, the current implementation doesn't do anything weird with 
 * InvalidMultiXactId, but there's no harm in leaving this code like this.) 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3103"></a><span class='Declare_Function'>MultiXactOffsetPagePrecedes</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>page1</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>page2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3105"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multi1</span><span class='Delimiter'>; 
</span><a name="LN3106"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multi2</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN3105"><span class='Ref_To_Local'>multi1</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN3103"><span class='Ref_to_Parameter'>page1</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="multixact.c.html#LN108"><span class='Ref_to_Const'>MULTIXACT_OFFSETS_PER_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3105"><span class='Ref_To_Local'>multi1</span></a> <span class='Operator'>+= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3106"><span class='Ref_To_Local'>multi2</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN3103"><span class='Ref_to_Parameter'>page2</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="multixact.c.html#LN108"><span class='Ref_to_Const'>MULTIXACT_OFFSETS_PER_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3106"><span class='Ref_To_Local'>multi2</span></a> <span class='Operator'>+= </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3105"><span class='Ref_To_Local'>multi1</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3106"><span class='Ref_To_Local'>multi2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Decide which of two MultiXactMember page numbers is "older" for truncation 
 * purposes.  There is no "invalid offset number" so use the numbers verbatim. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3121"></a><span class='Declare_Function'>MultiXactMemberPagePrecedes</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>page1</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>page2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3123"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset1</span><span class='Delimiter'>; 
</span><a name="LN3124"></a>    <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Local'>offset2</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN3123"><span class='Ref_To_Local'>offset1</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN3121"><span class='Ref_to_Parameter'>page1</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3124"><span class='Ref_To_Local'>offset2</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a><span class='Parentheses'>) </span><a href="multixact.c.html#LN3121"><span class='Ref_to_Parameter'>page2</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="multixact.c.html#LN141"><span class='Ref_to_Const'>MULTIXACT_MEMBERS_PER_PAGE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="multixact.c.html#LN359"><span class='Ref_to_Proto'>MultiXactOffsetPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3123"><span class='Ref_To_Local'>offset1</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3124"><span class='Ref_To_Local'>offset2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Decide which of two MultiXactIds is earlier. 
 * 
 * XXX do we need to do something special for InvalidMultiXactId? 
 * (Doesn't look like it.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3139"></a><span class='Declare_Function'>MultiXactIdPrecedes</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi1</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3141"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>diff</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) (</span><a href="multixact.c.html#LN3139"><span class='Ref_to_Parameter'>multi1</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN3139"><span class='Ref_to_Parameter'>multi2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3141"><span class='Ref_To_Local'>diff</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * MultiXactIdPrecedesOrEquals -- is multi1 logically &LT;= multi2? 
 * 
 * XXX do we need to do something special for InvalidMultiXactId? 
 * (Doesn't look like it.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3153"></a><span class='Declare_Function'>MultiXactIdPrecedesOrEquals</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi1</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>multi2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3155"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>diff</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) (</span><a href="multixact.c.html#LN3153"><span class='Ref_to_Parameter'>multi1</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN3153"><span class='Ref_to_Parameter'>multi2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3155"><span class='Ref_To_Local'>diff</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Decide which of two offsets is earlier. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3165"></a><span class='Declare_Function'>MultiXactOffsetPrecedes</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset1</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>offset2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3167"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>diff</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) (</span><a href="multixact.c.html#LN3165"><span class='Ref_to_Parameter'>offset1</span></a> <span class='Operator'>- </span><a href="multixact.c.html#LN3165"><span class='Ref_to_Parameter'>offset2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3167"><span class='Ref_To_Local'>diff</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write an xlog record reflecting the zeroing of either a MEMBERs or 
 * OFFSETs page (info shows which) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3177"></a><span class='Declare_Function'>WriteMZeroPageXlogRec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pageno</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="multixact.c.html#LN3177"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_MULTIXACT_ID<span class='Delimiter'>, </span><a href="multixact.c.html#LN3177"><span class='Ref_to_Parameter'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write a TRUNCATE xlog record 
 * 
 * We must flush the xlog record to disk before returning --- see notes in 
 * TruncateCLOG(). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3191"></a><span class='Declare_Function'>WriteMTruncateXlogRec</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldestMultiDB</span><span class='Delimiter'>, 
</span><a name="LN3192"></a>                      <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>startTruncOff</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Parameter'>endTruncOff</span><span class='Delimiter'>, 
</span><a name="LN3193"></a>                <a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>startTruncMemb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN408"><span class='Ref_to_Typedef'>MultiXactOffset</span></a> <span class='Declare_Parameter'>endTruncMemb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3195"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN3196"></a>    <a href="../../../include/access/multixact.h.html#LN85"><span class='Ref_to_Struct'>xl_multixact_truncate</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN3196"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN87"><span class='Ref_to_Member'>oldestMultiDB</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3191"><span class='Ref_to_Parameter'>oldestMultiDB</span></a><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN3196"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN90"><span class='Ref_to_Member'>startTruncOff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3192"><span class='Ref_to_Parameter'>startTruncOff</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3196"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN91"><span class='Ref_to_Member'>endTruncOff</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3192"><span class='Ref_to_Parameter'>endTruncOff</span></a><span class='Delimiter'>; 
</span> 
    <a href="multixact.c.html#LN3196"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN94"><span class='Ref_to_Member'>startTruncMemb</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3193"><span class='Ref_to_Parameter'>startTruncMemb</span></a><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3196"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN95"><span class='Ref_to_Member'>endTruncMemb</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3193"><span class='Ref_to_Parameter'>endTruncMemb</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="multixact.c.html#LN3196"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN98"><span class='Ref_to_Const'>SizeOfMultiXactTruncate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3195"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_MULTIXACT_ID<span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN73"><span class='Ref_to_Const'>XLOG_MULTIXACT_TRUNCATE_ID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3195"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WriteMTruncateXlogRec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MULTIXACT resource manager's routines 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3216"></a><span class='Declare_Function'>multixact_redo</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3218"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& ~</span><a href="../../../include/access/xlogrecord.h.html#LN61"><span class='Ref_to_Const'>XLR_INFO_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Backup blocks are not used in multixact records */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlogreader.h.html#LN221"><span class='Ref_to_Macro'>XLogRecHasAnyBlockRefs</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3218"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/multixact.h.html#LN70"><span class='Ref_to_Const'>XLOG_MULTIXACT_ZERO_OFF_PAGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3225"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN3226"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN3225"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3226"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN355"><span class='Ref_to_Proto'>ZeroMultiXactOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3225"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/slru.h.html#LN151"><span class='Ref_to_Proto'>SimpleLruWritePage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3226"><span class='Ref_To_Local'>slotno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN3226"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactOffsetControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3218"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/multixact.h.html#LN71"><span class='Ref_to_Const'>XLOG_MULTIXACT_ZERO_MEM_PAGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3240"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN3241"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>slotno</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN3240"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3241"><span class='Ref_To_Local'>slotno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN356"><span class='Ref_to_Proto'>ZeroMultiXactMemberPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3240"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/slru.h.html#LN151"><span class='Ref_to_Proto'>SimpleLruWritePage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3241"><span class='Ref_To_Local'>slotno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="multixact.c.html#LN190"><span class='Ref_to_Const'>MultiXactMemberCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>page_dirty<span class='Delimiter'>[</span><a href="multixact.c.html#LN3241"><span class='Ref_To_Local'>slotno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactMemberControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3218"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/multixact.h.html#LN72"><span class='Ref_to_Const'>XLOG_MULTIXACT_CREATE_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3255"></a>        <a href="../../../include/access/multixact.h.html#LN75"><span class='Ref_to_Struct'>xl_multixact_create</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="../../../include/access/multixact.h.html#LN75"><span class='Ref_to_Struct'>xl_multixact_create</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3257"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>max_xid</span><span class='Delimiter'>; 
</span><a name="LN3258"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Store the data back into the SLRU files */ 
</span>        <a href="multixact.c.html#LN341"><span class='Ref_to_Proto'>RecordNewMultiXact</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN77"><span class='Ref_to_Member'>mid</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN78"><span class='Ref_to_Member'>moff</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN79"><span class='Ref_to_Member'>nmembers</span></a><span class='Delimiter'>, 
</span>                           <a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN80"><span class='Ref_to_Member'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Make sure nextMXact/nextOffset are beyond what this record has */ 
</span>        <a href="../../../include/access/multixact.h.html#LN141"><span class='Ref_to_Proto'>MultiXactAdvanceNextMXact</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN77"><span class='Ref_to_Member'>mid</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                  <a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN78"><span class='Ref_to_Member'>moff</span></a> <span class='Operator'>+ </span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN79"><span class='Ref_to_Member'>nmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make sure nextXid is beyond any XID mentioned in the record. This 
         * should be unnecessary, since any XID found here ought to have other 
         * evidence in the XLOG, but let's be safe. 
         */ 
</span>        <a href="multixact.c.html#LN3257"><span class='Ref_To_Local'>max_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3258"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="multixact.c.html#LN3258"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN79"><span class='Ref_to_Member'>nmembers</span></a><span class='Delimiter'>; </span><a href="multixact.c.html#LN3258"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3257"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN80"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN3258"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span> 
                <a href="multixact.c.html#LN3257"><span class='Ref_To_Local'>max_xid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3255"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/multixact.h.html#LN80"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN3258"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't expect anyone else to modify nextXid, hence startup 
         * process doesn't need to hold a lock while checking this. We still 
         * acquire the lock to modify it, though. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3257"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>, 
</span>                                         <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3257"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/access/transam.h.html#LN47"><span class='Ref_to_Macro'>TransactionIdAdvance</span></a><span class='Parentheses'>(</span><a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_MULTIXACT_... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3218"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/multixact.h.html#LN73"><span class='Ref_to_Const'>XLOG_MULTIXACT_TRUNCATE_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3296"></a>        <a href="../../../include/access/multixact.h.html#LN85"><span class='Ref_to_Struct'>xl_multixact_truncate</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN3297"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3216"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../../../include/access/multixact.h.html#LN98"><span class='Ref_to_Const'>SizeOfMultiXactTruncate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"replaying multixact truncation: "</span> 
             <span class='String'>"offsets [%u, %u), offsets segments [%x, %x), "</span> 
             <span class='String'>"members [%u, %u), members segments [%x, %x)"</span><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN90"><span class='Ref_to_Member'>startTruncOff</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN91"><span class='Ref_to_Member'>endTruncOff</span></a><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN114"><span class='Ref_to_Macro'>MultiXactIdToOffsetSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN90"><span class='Ref_to_Member'>startTruncOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN114"><span class='Ref_to_Macro'>MultiXactIdToOffsetSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN91"><span class='Ref_to_Member'>endTruncOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN94"><span class='Ref_to_Member'>startTruncMemb</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN95"><span class='Ref_to_Member'>endTruncMemb</span></a><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN94"><span class='Ref_to_Member'>startTruncMemb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="multixact.c.html#LN159"><span class='Ref_to_Macro'>MXOffsetToMemberSegment</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN95"><span class='Ref_to_Member'>endTruncMemb</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* should not be required, but more than cheap enough */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Advance the horizon values, so they're current at the end of 
         * recovery. 
         */ 
</span>        <a href="../../../include/access/multixact.h.html#LN128"><span class='Ref_to_Proto'>SetMultiXactIdLimit</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN91"><span class='Ref_to_Member'>endTruncOff</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN87"><span class='Ref_to_Member'>oldestMultiDB</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN2878"><span class='Ref_to_Func'>PerformMembersTruncation</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN94"><span class='Ref_to_Member'>startTruncMemb</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN95"><span class='Ref_to_Member'>endTruncMemb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * During XLOG replay, latest_page_number isn't necessarily set up 
         * yet; insert a suitable value to bypass the sanity test in 
         * SimpleLruTruncate. 
         */ 
</span>        <a href="multixact.c.html#LN3297"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN110"><span class='Ref_to_Macro'>MultiXactIdToOffsetPage</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN91"><span class='Ref_to_Member'>endTruncOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN189"><span class='Ref_to_Const'>MultiXactOffsetCtl</span></a><span class='Operator'>-&GT;</span>shared<span class='Operator'>-&GT;</span>latest_page_number <span class='Operator'>= </span><a href="multixact.c.html#LN3297"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN2906"><span class='Ref_to_Func'>PerformOffsetsTruncation</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN90"><span class='Ref_to_Member'>startTruncOff</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3296"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN91"><span class='Ref_to_Member'>endTruncOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>MultiXactTruncationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_MULTIXACT_... &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"multixact_redo: unknown op code %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN3218"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end multixact_redo &raquo; </span> 
 
<a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN3339"></a><span class='Declare_Function'>pg_get_multixact_members</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>typedef</span> <span class='Control'>struct</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3343"></a>        <a href="../../../include/access/multixact.h.html#LN58"><span class='Ref_to_Struct'>MultiXactMember</span></a> <span class='Operator'>*</span><span class='Declare_Member'>members</span><span class='Delimiter'>; 
</span><a name="LN3344"></a>        <span class='Keyword'>int</span>         <span class='Declare_Member'>nmembers</span><span class='Delimiter'>; 
</span><a name="LN3345"></a>        <span class='Keyword'>int</span>         <span class='Declare_Member'>iter</span><span class='Delimiter'>; 
</span><a name="LN3346"></a>    <span class='Delimiter'>} </span><span class='Declare_Local'>mxact</span><span class='Delimiter'>; 
</span><a name="LN3347"></a>    <a href="../../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>mxid</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN234"><span class='Ref_to_Macro'>PG_GETARG_UINT32</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3348"></a>    <a href="multixact.c.html#LN3346"><span class='Ref_to_Typedef'>mxact</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>multi</span><span class='Delimiter'>; 
</span><a name="LN3349"></a>    <a href="../../../include/funcapi.h.html#LN56"><span class='Ref_to_Struct'>FuncCallContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funccxt</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3347"><span class='Ref_To_Local'>mxid</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid MultiXactId: %u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN3347"><span class='Ref_To_Local'>mxid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/funcapi.h.html#LN284"><span class='Ref_to_Macro'>SRF_IS_FIRSTCALL</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3358"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN3359"></a>        <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN286"><span class='Ref_to_Macro'>SRF_FIRSTCALL_INIT</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN3358"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="multixact.c.html#LN3346"><span class='Ref_to_Typedef'>mxact</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* no need to allow for old values here */ 
</span>        <a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3344"><span class='Ref_to_Member'>nmembers</span></a> <span class='Operator'>= </span><a href="../../../include/access/multixact.h.html#LN112"><span class='Ref_to_Proto'>GetMultiXactIdMembers</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3347"><span class='Ref_To_Local'>mxid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3343"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3345"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3359"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3359"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"xid"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN29"><span class='Ref_to_Const'>XIDOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3359"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='String'>"mode"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN98"><span class='Ref_to_Member'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3359"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a> <span class='Operator'>= </span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3358"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SRF_IS_FIRSTCALL() &raquo; </span> 
 
    <a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN288"><span class='Ref_to_Macro'>SRF_PERCALL_SETUP</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="multixact.c.html#LN3346"><span class='Ref_to_Typedef'>mxact</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3345"><span class='Ref_to_Member'>iter</span></a> <span class='Operator'>&LT; </span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3344"><span class='Ref_to_Member'>nmembers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3387"></a>        <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN3388"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
        <a href="multixact.c.html#LN3388"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%u"</span><span class='Delimiter'>, </span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3343"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3345"><span class='Ref_to_Member'>iter</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN60"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="multixact.c.html#LN3388"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="multixact.c.html#LN352"><span class='Ref_to_Proto'>mxstatus_to_string</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3343"><span class='Ref_to_Member'>members</span></a><span class='Delimiter'>[</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3345"><span class='Ref_to_Member'>iter</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/multixact.h.html#LN61"><span class='Ref_to_Member'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3387"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN98"><span class='Ref_to_Member'>attinmeta</span></a><span class='Delimiter'>, </span><a href="multixact.c.html#LN3388"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3345"><span class='Ref_to_Member'>iter</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3388"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/funcapi.h.html#LN290"><span class='Ref_to_Macro'>SRF_RETURN_NEXT</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Delimiter'>, </span><a href="../../../include/funcapi.h.html#LN221"><span class='Ref_to_Macro'>HeapTupleGetDatum</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3387"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3344"><span class='Ref_to_Member'>nmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Operator'>-&GT;</span><a href="multixact.c.html#LN3343"><span class='Ref_to_Member'>members</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3348"><span class='Ref_To_Local'>multi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="multixact.c.html#LN3349"><span class='Ref_To_Local'>funccxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_get_multixact_members &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>