<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\transam\parallel.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\transam\parallel.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:30 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * parallel.c 
 *    Infrastructure for launching parallel workers 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/access/transam/parallel.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/parallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/async.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/execParallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqformat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqmq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/planmain.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/combocid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * We don't want to waste a lot of memory on an error queue which, most of 
 * the time, will process only a handful of small messages.  However, it is 
 * desirable to make it large enough that a typical ErrorResponse can be sent 
 * without blocking.  That way, a worker that errors out can write the whole 
 * message into the queue and terminate without waiting for the user backend. 
 */ 
</span><a name="LN47"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_ERROR_QUEUE_SIZE</span>           <span class='Number'>16384</span> 
 
<span class='Comment_Multi_Line'>/* Magic number for parallel context TOC. */ 
</span><a name="LN50"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_MAGIC</span>                      <span class='Number'>0x50477c7c</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Magic numbers for parallel state sharing.  Higher-level code should use 
 * smaller values, leaving these very large ones for use by this module. 
 */ 
</span><a name="LN56"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_FIXED</span>                  <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0001</span><span class='Parentheses'>) 
</span><a name="LN57"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_ERROR_QUEUE</span>            <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0002</span><span class='Parentheses'>) 
</span><a name="LN58"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_LIBRARY</span>                <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0003</span><span class='Parentheses'>) 
</span><a name="LN59"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_GUC</span>                    <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0004</span><span class='Parentheses'>) 
</span><a name="LN60"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_COMBO_CID</span>              <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0005</span><span class='Parentheses'>) 
</span><a name="LN61"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_TRANSACTION_SNAPSHOT</span>   <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0006</span><span class='Parentheses'>) 
</span><a name="LN62"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_ACTIVE_SNAPSHOT</span>        <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0007</span><span class='Parentheses'>) 
</span><a name="LN63"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_TRANSACTION_STATE</span>      <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0008</span><span class='Parentheses'>) 
</span><a name="LN64"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PARALLEL_KEY_ENTRYPOINT</span>             <a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>0xFFFFFFFFFFFF0009</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Fixed-size parallel state. */ 
</span><a name="LN67"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>FixedParallelState</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Fixed-size state that workers must restore. */ 
</span><a name="LN70"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>database_id</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>authenticated_user_id</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>current_user_id</span><span class='Delimiter'>; 
</span><a name="LN73"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>temp_namespace_id</span><span class='Delimiter'>; 
</span><a name="LN74"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>temp_toast_namespace_id</span><span class='Delimiter'>; 
</span><a name="LN75"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>sec_context</span><span class='Delimiter'>; 
</span><a name="LN76"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>parallel_master_pgproc</span><span class='Delimiter'>; 
</span><a name="LN77"></a>    <a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Member'>parallel_master_pid</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a>   <span class='Declare_Member'>parallel_master_backend_id</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mutex protects remaining fields. */ 
</span><a name="LN81"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mutex</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Maximum XactLastRecEnd of any worker. */ 
</span><a name="LN84"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>last_xlog_end</span><span class='Delimiter'>; 
</span><a name="LN85"></a>} <span class='Declare_Typedef'>FixedParallelState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Our parallel worker number.  We initialize this to -1, meaning that we are 
 * not a parallel worker.  In parallel workers, it will be set to a value &GT;= 0 
 * and &LT; the number of workers before any user code is invoked; each parallel 
 * worker will get a different parallel worker number. 
 */ 
</span><a name="LN93"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>ParallelWorkerNumber</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Is there a parallel message pending which we need to receive? */ 
</span><a name="LN96"></a><span class='Keyword'>volatile bool </span><span class='Declare_Var'>ParallelMessagePending</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Are we initializing a parallel worker? */ 
</span><a name="LN99"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>InitializingParallelWorker</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Pointer to our fixed parallel state. */ 
</span><a name="LN102"></a><span class='Keyword'>static </span><a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Var'>MyFixedParallelState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* List of active parallel contexts. */ 
</span><a name="LN105"></a><span class='Keyword'>static </span><a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a> <span class='Declare_Var'>pcxt_list</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN247"><span class='Ref_to_Macro'>DLIST_STATIC_INIT</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of internal parallel worker entry points.  We need this for 
 * reasons explained in LookupParallelWorkerFunction(), below. 
 */ 
</span><span class='Keyword'>static const </span><span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN113"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Member'>fn_name</span><span class='Delimiter'>; 
</span><a name="LN114"></a>    <a href="../../../include/access/parallel.h.html#LN22"><span class='Ref_to_Typedef'>parallel_worker_main_type</span></a> <span class='Declare_Member'>fn_addr</span><span class='Delimiter'>; 
</span><a name="LN115"></a>}   <span class='Declare_Var'>InternalParallelWorkers</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span> 
<span class='Delimiter'>{ 
</span>    <span class='Delimiter'>{ 
</span>        <span class='String'>"ParallelQueryMain"</span><span class='Delimiter'>, </span><a href="../../../include/executor/execParallel.h.html#LN40"><span class='Ref_to_Proto'>ParallelQueryMain</span></a> 
    <span class='Delimiter'>} 
}; 
</span> 
<span class='Comment_Multi_Line'>/* Private functions. */ 
</span><a name="LN124"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>HandleParallelMessage</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>i</span><span class='Delimiter'>, </span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>msg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN125"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitForParallelWorkersToExit</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN126"></a><span class='Keyword'>static </span><a href="../../../include/access/parallel.h.html#LN22"><span class='Ref_to_Typedef'>parallel_worker_main_type</span></a> <span class='Declare_Prototype'>LookupParallelWorkerFunction</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libraryname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>funcname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Establish a new parallel context.  This should be done after entering 
 * parallel mode, and (unless there is an error) the context should be 
 * destroyed before exiting the current subtransaction. 
 */ 
</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>* 
</span><a name="LN135"></a><span class='Declare_Function'>CreateParallelContext</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>library_name</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>function_name</span><span class='Delimiter'>, 
</span><a name="LN136"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>nworkers</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN138"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN139"></a>    <a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* It is unsafe to create a parallel context if not in parallel mode. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Number of workers should be non-negative. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN136"><span class='Ref_to_Parameter'>nworkers</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If dynamic shared memory is not available, we won't be able to use 
     * background workers. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../storage/ipc/dsm_impl.c.html#LN111"><span class='Ref_to_Global_Var'>dynamic_shared_memory_type</span></a> <span class='Operator'>== </span><a href="../../../include/storage/dsm_impl.h.html#LN16"><span class='Ref_to_Const'>DSM_IMPL_NONE</span></a><span class='Parentheses'>) 
</span>        <a href="parallel.c.html#LN136"><span class='Ref_to_Parameter'>nworkers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are running under serializable isolation, we can't use parallel 
     * workers, at least not until somebody enhances that mechanism to be 
     * parallel-aware. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN43"><span class='Ref_to_Macro'>IsolationIsSerializable</span></a><span class='Parentheses'>())</span> 
        <a href="parallel.c.html#LN136"><span class='Ref_to_Parameter'>nworkers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We might be running in a short-lived memory context. */ 
</span>    <a href="parallel.c.html#LN138"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize a new ParallelContext. */ 
</span>    <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN34"><span class='Ref_to_Member'>subid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN136"><span class='Ref_to_Parameter'>nworkers</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN37"><span class='Ref_to_Member'>library_name</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN135"><span class='Ref_to_Parameter'>library_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN38"><span class='Ref_to_Member'>function_name</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN135"><span class='Ref_to_Parameter'>function_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN39"><span class='Ref_to_Member'>error_context_stack</span></a> <span class='Operator'>= </span><a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/shm_toc.h.html#LN48"><span class='Ref_to_Macro'>shm_toc_initialize_estimator</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN33"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore previous memory context. */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN138"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="parallel.c.html#LN139"><span class='Ref_To_Local'>pcxt</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateParallelContext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Establish the dynamic shared memory segment for a parallel context and 
 * copy state and other bookkeeping information that will be needed by 
 * parallel workers into it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN187"></a><span class='Declare_Function'>InitializeParallelDSM</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN189"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN190"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>library_len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN191"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>guc_len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN192"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>combocidlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN193"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>tsnaplen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN194"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>asnaplen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN195"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>tstatelen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN196"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>segsize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN197"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN198"></a>    <a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fps</span><span class='Delimiter'>; 
</span><a name="LN199"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>transaction_snapshot</span> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN200"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>active_snapshot</span> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN77"><span class='Ref_to_Proto'>GetActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We might be running in a very short-lived memory context. */ 
</span>    <a href="parallel.c.html#LN189"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allow space to store the fixed-size parallel state. */ 
</span>    <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/shm_toc.h.html#LN52"><span class='Ref_to_Macro'>shm_toc_estimate_keys</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normally, the user will have requested at least one worker process, but 
     * if by chance they have not, we can skip a bunch of things here. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Estimate space for various kinds of state sharing. */ 
</span>        <a href="parallel.c.html#LN190"><span class='Ref_To_Local'>library_len</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN680"><span class='Ref_to_Proto'>EstimateLibraryStateSpace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN190"><span class='Ref_To_Local'>library_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN191"><span class='Ref_To_Local'>guc_len</span></a> <span class='Operator'>= </span><a href="../../../include/utils/guc.h.html#LN390"><span class='Ref_to_Proto'>EstimateGUCStateSpace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN191"><span class='Ref_To_Local'>guc_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN192"><span class='Ref_To_Local'>combocidlen</span></a> <span class='Operator'>= </span><a href="../../../include/utils/combocid.h.html#LN25"><span class='Ref_to_Proto'>EstimateComboCIDStateSpace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN192"><span class='Ref_To_Local'>combocidlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN193"><span class='Ref_To_Local'>tsnaplen</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN107"><span class='Ref_to_Proto'>EstimateSnapshotSpace</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN199"><span class='Ref_To_Local'>transaction_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN193"><span class='Ref_To_Local'>tsnaplen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN194"><span class='Ref_To_Local'>asnaplen</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN107"><span class='Ref_to_Proto'>EstimateSnapshotSpace</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN200"><span class='Ref_To_Local'>active_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN194"><span class='Ref_To_Local'>asnaplen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN195"><span class='Ref_To_Local'>tstatelen</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN362"><span class='Ref_to_Proto'>EstimateTransactionStateSpace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN195"><span class='Ref_To_Local'>tstatelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* If you add more chunks here, you probably need to add keys. */ 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN52"><span class='Ref_to_Macro'>shm_toc_estimate_keys</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><span class='Number'>6</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Estimate space need for error queues. */ 
</span>        <a href="../../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN589"><span class='Ref_to_Macro'>BUFFERALIGN</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Parentheses'>) </span><span class='Operator'>== 
</span>                         <a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"parallel error queue size not buffer-aligned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Delimiter'>, 
</span>                                        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN52"><span class='Ref_to_Macro'>shm_toc_estimate_keys</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Estimate how much we'll need for the entrypoint info. */ 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN50"><span class='Ref_to_Macro'>shm_toc_estimate_chunk</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN37"><span class='Ref_to_Member'>library_name</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                               strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN38"><span class='Ref_to_Member'>function_name</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN52"><span class='Ref_to_Macro'>shm_toc_estimate_keys</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pcxt-&GT;nworkers&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Create DSM and initialize with new table of contents.  But if the user 
     * didn't request any workers, then don't bother creating a dynamic shared 
     * memory segment; instead, just use backend-private memory. 
     * 
     * Also, if we can't create a dynamic shared memory segment because the 
     * maximum number of segments have already been created, then fall back to 
     * backend-private memory, and plan not to use any workers.  We hope this 
     * won't happen very often, but it's better to abandon the use of 
     * parallelism than to fail outright. 
     */ 
</span>    <a href="parallel.c.html#LN196"><span class='Ref_To_Local'>segsize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN55"><span class='Ref_to_Proto'>shm_toc_estimate</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN40"><span class='Ref_to_Member'>estimator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN36"><span class='Ref_to_Proto'>dsm_create</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN196"><span class='Ref_To_Local'>segsize</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/dsm.h.html#LN19"><span class='Ref_to_Const'>DSM_CREATE_NULL_IF_MAXSEGMENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN29"><span class='Ref_to_Proto'>shm_toc_create</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN50"><span class='Ref_to_Const'>PARALLEL_MAGIC</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="parallel.c.html#LN196"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN42"><span class='Ref_to_Member'>private_memory</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN196"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN29"><span class='Ref_to_Proto'>shm_toc_create</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN50"><span class='Ref_to_Const'>PARALLEL_MAGIC</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN42"><span class='Ref_to_Member'>private_memory</span></a><span class='Delimiter'>, 
</span>                                   <a href="parallel.c.html#LN196"><span class='Ref_To_Local'>segsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize fixed-size state in shared memory. */ 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN70"><span class='Ref_to_Member'>database_id</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN71"><span class='Ref_to_Member'>authenticated_user_id</span></a> <span class='Operator'>= </span><a href="../../../include/miscadmin.h.html#LN311"><span class='Ref_to_Proto'>GetAuthenticatedUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN312"><span class='Ref_to_Proto'>GetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN72"><span class='Ref_to_Member'>current_user_id</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN75"><span class='Ref_to_Member'>sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/namespace.h.html#LN130"><span class='Ref_to_Proto'>GetTempNamespaceState</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN73"><span class='Ref_to_Member'>temp_namespace_id</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN74"><span class='Ref_to_Member'>temp_toast_namespace_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN76"><span class='Ref_to_Member'>parallel_master_pgproc</span></a> <span class='Operator'>= </span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN77"><span class='Ref_to_Member'>parallel_master_pid</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN78"><span class='Ref_to_Member'>parallel_master_backend_id</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN81"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN84"><span class='Ref_to_Member'>last_xlog_end</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN56"><span class='Ref_to_Const'>PARALLEL_KEY_FIXED</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN198"><span class='Ref_To_Local'>fps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We can skip the rest of this if we're not budgeting for any workers. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN290"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>libraryspace</span><span class='Delimiter'>; 
</span><a name="LN291"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>gucspace</span><span class='Delimiter'>; 
</span><a name="LN292"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>combocidspace</span><span class='Delimiter'>; 
</span><a name="LN293"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tsnapspace</span><span class='Delimiter'>; 
</span><a name="LN294"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>asnapspace</span><span class='Delimiter'>; 
</span><a name="LN295"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tstatespace</span><span class='Delimiter'>; 
</span><a name="LN296"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>error_queue_space</span><span class='Delimiter'>; 
</span><a name="LN297"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>entrypointstate</span><span class='Delimiter'>; 
</span><a name="LN298"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>lnamelen</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Serialize shared libraries we have loaded. */ 
</span>        <a href="parallel.c.html#LN290"><span class='Ref_To_Local'>libraryspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN190"><span class='Ref_To_Local'>library_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN681"><span class='Ref_to_Proto'>SerializeLibraryState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN190"><span class='Ref_To_Local'>library_len</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN290"><span class='Ref_To_Local'>libraryspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN58"><span class='Ref_to_Const'>PARALLEL_KEY_LIBRARY</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN290"><span class='Ref_To_Local'>libraryspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Serialize GUC settings. */ 
</span>        <a href="parallel.c.html#LN291"><span class='Ref_To_Local'>gucspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN191"><span class='Ref_To_Local'>guc_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/guc.h.html#LN391"><span class='Ref_to_Proto'>SerializeGUCState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN191"><span class='Ref_To_Local'>guc_len</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN291"><span class='Ref_To_Local'>gucspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN59"><span class='Ref_to_Const'>PARALLEL_KEY_GUC</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN291"><span class='Ref_To_Local'>gucspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Serialize combo CID state. */ 
</span>        <a href="parallel.c.html#LN292"><span class='Ref_To_Local'>combocidspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN192"><span class='Ref_To_Local'>combocidlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/combocid.h.html#LN24"><span class='Ref_to_Proto'>SerializeComboCIDState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN192"><span class='Ref_To_Local'>combocidlen</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN292"><span class='Ref_To_Local'>combocidspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN60"><span class='Ref_to_Const'>PARALLEL_KEY_COMBO_CID</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN292"><span class='Ref_To_Local'>combocidspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Serialize transaction snapshot and active snapshot. */ 
</span>        <a href="parallel.c.html#LN293"><span class='Ref_To_Local'>tsnapspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN193"><span class='Ref_To_Local'>tsnaplen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN108"><span class='Ref_to_Proto'>SerializeSnapshot</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN199"><span class='Ref_To_Local'>transaction_snapshot</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN293"><span class='Ref_To_Local'>tsnapspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN61"><span class='Ref_to_Const'>PARALLEL_KEY_TRANSACTION_SNAPSHOT</span></a><span class='Delimiter'>, 
</span>                       <a href="parallel.c.html#LN293"><span class='Ref_To_Local'>tsnapspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN294"><span class='Ref_To_Local'>asnapspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN194"><span class='Ref_To_Local'>asnaplen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN108"><span class='Ref_to_Proto'>SerializeSnapshot</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN200"><span class='Ref_To_Local'>active_snapshot</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN294"><span class='Ref_To_Local'>asnapspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN62"><span class='Ref_to_Const'>PARALLEL_KEY_ACTIVE_SNAPSHOT</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN294"><span class='Ref_To_Local'>asnapspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Serialize transaction state. */ 
</span>        <a href="parallel.c.html#LN295"><span class='Ref_To_Local'>tstatespace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN195"><span class='Ref_To_Local'>tstatelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xact.h.html#LN363"><span class='Ref_to_Proto'>SerializeTransactionState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN195"><span class='Ref_To_Local'>tstatelen</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN295"><span class='Ref_To_Local'>tstatespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN63"><span class='Ref_to_Const'>PARALLEL_KEY_TRANSACTION_STATE</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN295"><span class='Ref_To_Local'>tstatespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Allocate space for worker information. */ 
</span>        <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN24"><span class='Ref_to_Struct'>ParallelWorkerInfo</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Establish error queues in dynamic shared memory. 
         * 
         * These queues should be used only for transmitting ErrorResponse, 
         * NoticeResponse, and NotifyResponse protocol messages.  Tuple data 
         * should be transmitted via separate (possibly larger?) queues. 
         */ 
</span>        <a href="parallel.c.html#LN296"><span class='Ref_To_Local'>error_queue_space</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Delimiter'>, 
</span>                                      <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN197"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN345"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>start</span><span class='Delimiter'>; 
</span><a name="LN346"></a>            <a href="../../storage/ipc/shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span><span class='Delimiter'>; 
</span> 
            <a href="parallel.c.html#LN345"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN296"><span class='Ref_To_Local'>error_queue_space</span></a> <span class='Operator'>+ </span><a href="parallel.c.html#LN197"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>* </span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN346"><span class='Ref_To_Local'>mq</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_mq.h.html#LN49"><span class='Ref_to_Proto'>shm_mq_create</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN345"><span class='Ref_To_Local'>start</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/shm_mq.h.html#LN50"><span class='Ref_to_Proto'>shm_mq_set_receiver</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN346"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN197"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_mq.h.html#LN58"><span class='Ref_to_Proto'>shm_mq_attach</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN346"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN57"><span class='Ref_to_Const'>PARALLEL_KEY_ERROR_QUEUE</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN296"><span class='Ref_To_Local'>error_queue_space</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Serialize entrypoint information.  It's unsafe to pass function 
         * pointers across processes, as the function pointer may be different 
         * in each process in EXEC_BACKEND builds, so we always pass library 
         * and function name.  (We use library name "postgres" for functions 
         * in the core backend.) 
         */ 
</span>        <a href="parallel.c.html#LN298"><span class='Ref_To_Local'>lnamelen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN37"><span class='Ref_to_Member'>library_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN297"><span class='Ref_To_Local'>entrypointstate</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN31"><span class='Ref_to_Proto'>shm_toc_allocate</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN298"><span class='Ref_To_Local'>lnamelen</span></a> <span class='Operator'>+ 
</span>                                           strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN38"><span class='Ref_to_Member'>function_name</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN297"><span class='Ref_To_Local'>entrypointstate</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN37"><span class='Ref_to_Member'>library_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN297"><span class='Ref_To_Local'>entrypointstate</span></a> <span class='Operator'>+ </span><a href="parallel.c.html#LN298"><span class='Ref_To_Local'>lnamelen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN38"><span class='Ref_to_Member'>function_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN33"><span class='Ref_to_Proto'>shm_toc_insert</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN187"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN64"><span class='Ref_to_Const'>PARALLEL_KEY_ENTRYPOINT</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN297"><span class='Ref_To_Local'>entrypointstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pcxt-&GT;nworkers&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Restore previous memory context. */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN189"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitializeParallelDSM &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Reinitialize the dynamic shared memory segment for a parallel context such 
 * that we could launch workers for it again. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN379"></a><span class='Declare_Function'>ReinitializeParallelDSM</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN381"></a>    <a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fps</span><span class='Delimiter'>; 
</span><a name="LN382"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>error_queue_space</span><span class='Delimiter'>; 
</span><a name="LN383"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Wait for any old workers to exit. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/parallel.h.html#LN57"><span class='Ref_to_Proto'>WaitForParallelWorkersToFinish</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN125"><span class='Ref_to_Proto'>WaitForParallelWorkersToExit</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Reset a few bits of fixed parallel state to a clean state. */ 
</span>    <a href="parallel.c.html#LN381"><span class='Ref_To_Local'>fps</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN56"><span class='Ref_to_Const'>PARALLEL_KEY_FIXED</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN381"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN84"><span class='Ref_to_Member'>last_xlog_end</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Recreate error queues. */ 
</span>    <a href="parallel.c.html#LN382"><span class='Ref_To_Local'>error_queue_space</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN57"><span class='Ref_to_Const'>PARALLEL_KEY_ERROR_QUEUE</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN383"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN402"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>start</span><span class='Delimiter'>; 
</span><a name="LN403"></a>        <a href="../../storage/ipc/shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN402"><span class='Ref_To_Local'>start</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN382"><span class='Ref_To_Local'>error_queue_space</span></a> <span class='Operator'>+ </span><a href="parallel.c.html#LN383"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>* </span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN403"><span class='Ref_To_Local'>mq</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_mq.h.html#LN49"><span class='Ref_to_Proto'>shm_mq_create</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN402"><span class='Ref_To_Local'>start</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shm_mq.h.html#LN50"><span class='Ref_to_Proto'>shm_mq_set_receiver</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN403"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN383"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_mq.h.html#LN58"><span class='Ref_to_Proto'>shm_mq_attach</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN403"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN379"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReinitializeParallelDSM &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Launch parallel workers. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN416"></a><span class='Declare_Function'>LaunchParallelWorkers</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN418"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN419"></a>    <a href="../../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a> <span class='Declare_Local'>worker</span><span class='Delimiter'>; 
</span><a name="LN420"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN421"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>any_registrations_failed</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Skip this if we have no workers. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We need to be a lock group leader. */ 
</span>    <a href="../../../include/storage/proc.h.html#LN312"><span class='Ref_to_Proto'>BecomeLockGroupLeader</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we do have workers, we'd better have a DSM segment. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We might be running in a short-lived memory context. */ 
</span>    <a href="parallel.c.html#LN418"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Configure a worker. */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN89"><span class='Ref_to_Member'>bgw_name</span></a><span class='Delimiter'>, </span><a href="../../../include/postmaster/bgworker.h.html#LN84"><span class='Ref_to_Const'>BGW_MAXLEN</span></a><span class='Delimiter'>, </span><span class='String'>"parallel worker for PID %d"</span><span class='Delimiter'>, 
</span>             <a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN90"><span class='Ref_to_Member'>bgw_flags</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/postmaster/bgworker.h.html#LN51"><span class='Ref_to_Const'>BGWORKER_SHMEM_ACCESS</span></a> <span class='Operator'>| </span><a href="../../../include/postmaster/bgworker.h.html#LN58"><span class='Ref_to_Const'>BGWORKER_BACKEND_DATABASE_CONNECTION</span></a> 
        <span class='Operator'>| </span><a href="../../../include/postmaster/bgworker.h.html#LN66"><span class='Ref_to_Const'>BGWORKER_CLASS_PARALLEL</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN91"><span class='Ref_to_Member'>bgw_start_time</span></a> <span class='Operator'>= </span><a href="../../../include/postmaster/bgworker.h.html#LN78"><span class='Ref_to_EnumConst'>BgWorkerStart_ConsistentState</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN92"><span class='Ref_to_Member'>bgw_restart_time</span></a> <span class='Operator'>= </span><a href="../../../include/postmaster/bgworker.h.html#LN83"><span class='Ref_to_Const'>BGW_NEVER_RESTART</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN93"><span class='Ref_to_Member'>bgw_library_name</span></a><span class='Delimiter'>, </span><span class='String'>"postgres"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN94"><span class='Ref_to_Member'>bgw_function_name</span></a><span class='Delimiter'>, </span><span class='String'>"ParallelWorkerMain"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN95"><span class='Ref_to_Member'>bgw_main_arg</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN498"><span class='Ref_to_Macro'>UInt32GetDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/dsm.h.html#LN52"><span class='Ref_to_Proto'>dsm_segment_handle</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN97"><span class='Ref_to_Member'>bgw_notify_pid</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start workers. 
     * 
     * The caller must be able to tolerate ending up with fewer workers than 
     * expected, so there is no need to throw an error here if registration 
     * fails.  It wouldn't help much anyway, because registering the worker in 
     * no way guarantees that it will start up and initialize successfully. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN35"><span class='Ref_to_Member'>nworkers</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>.</span><a href="../../../include/postmaster/bgworker.h.html#LN96"><span class='Ref_to_Member'>bgw_extra</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN421"><span class='Ref_To_Local'>any_registrations_failed</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/postmaster/bgworker.h.html#LN115"><span class='Ref_to_Proto'>RegisterDynamicBackgroundWorker</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN419"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>, 
</span>                                            <span class='Operator'>&</span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/shm_mq.h.html#LN62"><span class='Ref_to_Proto'>shm_mq_set_handle</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a><span class='Delimiter'>, 
</span>                              <a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we weren't able to register the worker, then we've bumped up 
             * against the max_worker_processes limit, and future 
             * registrations will probably fail too, so arrange to skip them. 
             * But we still have to execute this code for the remaining slots 
             * to make sure that we forget about the error queues we budgeted 
             * for those workers.  Otherwise, we'll wait for them to start, 
             * but they never will. 
             */ 
</span>            <a href="parallel.c.html#LN421"><span class='Ref_To_Local'>any_registrations_failed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="parallel.c.html#LN416"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN420"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;pcxt-&GT;nworkers;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Restore previous memory context. */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN418"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LaunchParallelWorkers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait for all workers to finish computing. 
 * 
 * Even if the parallel operation seems to have completed successfully, it's 
 * important to call this function afterwards.  We must not miss any errors 
 * the workers may have thrown during the parallel operation, or any that they 
 * may yet throw while shutting down. 
 * 
 * Also, we want to update our notion of XactLastRecEnd based on worker 
 * feedback. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN503"></a><span class='Declare_Function'>WaitForParallelWorkersToFinish</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN507"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>anyone_alive</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN508"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This will process any parallel messages that are pending, which may 
         * change the outcome of the loop that follows.  It may also throw an 
         * error propagated from a worker. 
         */ 
</span>        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN508"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN508"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN503"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN508"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN503"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN508"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="parallel.c.html#LN507"><span class='Ref_To_Local'>anyone_alive</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="parallel.c.html#LN507"><span class='Ref_To_Local'>anyone_alive</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                  <a href="../../../include/pgstat.h.html#LN808"><span class='Ref_to_EnumConst'>WAIT_EVENT_PARALLEL_FINISH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN503"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN536"></a>        <a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fps</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN536"><span class='Ref_To_Local'>fps</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN503"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN43"><span class='Ref_to_Member'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN56"><span class='Ref_to_Const'>PARALLEL_KEY_FIXED</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN536"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN84"><span class='Ref_to_Member'>last_xlog_end</span></a> <span class='Operator'>&GT; </span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>) 
</span>            <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN536"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN84"><span class='Ref_to_Member'>last_xlog_end</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end WaitForParallelWorkersToFinish &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait for all workers to exit. 
 * 
 * This function ensures that workers have been completely shutdown.  The 
 * difference between WaitForParallelWorkersToFinish and this function is 
 * that former just ensures that last message sent by worker backend is 
 * received by master backend whereas this ensures the complete shutdown. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN553"></a><span class='Declare_Function'>WaitForParallelWorkersToExit</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN555"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Wait until the workers actually die. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN553"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN560"></a>        <a href="../../../include/postmaster/bgworker.h.html#LN100"><span class='Ref_to_Enum'>BgwHandleStatus</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN553"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="parallel.c.html#LN553"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN560"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/postmaster/bgworker.h.html#LN124"><span class='Ref_to_Proto'>WaitForBackgroundWorkerShutdown</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN553"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the postmaster kicked the bucket, we have no chance of cleaning 
         * up safely -- we won't be able to tell when our workers are actually 
         * dead.  This doesn't necessitate a PANIC since they will all abort 
         * eventually, but we can't safely continue this session. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN560"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../../include/postmaster/bgworker.h.html#LN105"><span class='Ref_to_EnumConst'>BGWH_POSTMASTER_DIED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ADMIN_SHUTDOWN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"postmaster exited during a parallel transaction"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release memory. */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN553"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN553"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN555"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;pcxt-&GT;nworkers_... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WaitForParallelWorkersToExit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Destroy a parallel context. 
 * 
 * If expecting a clean exit, you should use WaitForParallelWorkersToFinish() 
 * first, before calling this function.  When this function is invoked, any 
 * remaining workers are forcibly killed; the dynamic shared memory segment 
 * is unmapped; and we then wait (uninterruptibly) for the workers to exit. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN593"></a><span class='Declare_Function'>DestroyParallelContext</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN595"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Be careful about order of operations here!  We remove the parallel 
     * context from the list before we do anything else; otherwise, if an 
     * error occurs during a subsequent step, we might try to nuke it again 
     * from AtEOXact_Parallel or AtEOSubXact_Parallel. 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN33"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Kill each worker in turn, and forget their error queues. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/postmaster/bgworker.h.html#LN128"><span class='Ref_to_Proto'>TerminateBackgroundWorker</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN26"><span class='Ref_to_Member'>bgwhandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN595"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we have allocated a shared memory segment, detach it.  This will 
     * implicitly detach the error queues, and any other shared memory queues, 
     * stored there. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/dsm.h.html#LN40"><span class='Ref_to_Proto'>dsm_detach</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN41"><span class='Ref_to_Member'>seg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this parallel context is actually in backend-private memory rather 
     * than shared memory, free that memory instead. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN42"><span class='Ref_to_Member'>private_memory</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN42"><span class='Ref_to_Member'>private_memory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN42"><span class='Ref_to_Member'>private_memory</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can't finish transaction commit or abort until all of the workers 
     * have exited.  This means, in particular, that we can't respond to 
     * interrupts at this stage. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN125"><span class='Ref_to_Proto'>WaitForParallelWorkersToExit</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Free the worker array itself. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Free memory. */ 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN37"><span class='Ref_to_Member'>library_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN38"><span class='Ref_to_Member'>function_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN593"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DestroyParallelContext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Are there any parallel contexts currently active? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN667"></a><span class='Declare_Function'>ParallelContextActive</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle receipt of an interrupt indicating a parallel worker message. 
 * 
 * Note: this is called within a signal handler!  All we can do is set 
 * a flag that will cause the next CHECK_FOR_INTERRUPTS() to invoke 
 * HandleParallelMessages(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN680"></a><span class='Declare_Function'>HandleParallelMessageInterrupt</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../utils/init/globals.c.html#LN28"><span class='Ref_to_Global_Var'>InterruptPending</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN96"><span class='Ref_to_Global_Var'>ParallelMessagePending</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle any queued protocol messages received from parallel workers. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN691"></a><span class='Declare_Function'>HandleParallelMessages</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN693"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN694"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
<a name="LN696"></a>    <span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>hpm_context</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is invoked from ProcessInterrupts(), and since some of the 
     * functions it calls contain CHECK_FOR_INTERRUPTS(), there is a potential 
     * for recursive calls if more signals are received while this runs.  It's 
     * unclear that recursive entry would be safe, and it doesn't seem useful 
     * even if it is safe, so let's block interrupts until done. 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Moreover, CurrentMemoryContext might be pointing almost anywhere.  We 
     * don't want to risk leaking data into long-lived contexts, so let's do 
     * our work here in a private context that we can reset on each use. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN696"><span class='Ref_To_Local'>hpm_context</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* first time through? */ 
</span>        <a href="parallel.c.html#LN696"><span class='Ref_To_Local'>hpm_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                            <span class='String'>"HandleParallelMessages"</span><span class='Delimiter'>, 
</span>                                            <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN696"><span class='Ref_To_Local'>hpm_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN694"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN696"><span class='Ref_To_Local'>hpm_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK to process messages.  Reset the flag saying there are more to do. */ 
</span>    <a href="parallel.c.html#LN96"><span class='Ref_to_Global_Var'>ParallelMessagePending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN693"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN726"></a>        <a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pcxt</span><span class='Delimiter'>; 
</span><a name="LN727"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN726"><span class='Ref_To_Local'>pcxt</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN693"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN726"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN727"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN727"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN726"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN36"><span class='Ref_to_Member'>nworkers_launched</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="parallel.c.html#LN727"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Read as many messages as we can from each worker, but stop when 
             * either (1) the worker's error queue goes away, which can happen 
             * if we receive a Terminate message from the worker; or (2) no 
             * more messages can be read from the worker without blocking. 
             */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN726"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN727"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN743"></a>                <a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN744"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span><a name="LN745"></a>                <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span> 
                <a href="parallel.c.html#LN743"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_mq.h.html#LN75"><span class='Ref_to_Proto'>shm_mq_receive</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN726"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN727"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN744"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="parallel.c.html#LN745"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN743"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/shm_mq.h.html#LN38"><span class='Ref_to_EnumConst'>SHM_MQ_WOULD_BLOCK</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN743"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN753"></a>                    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
                    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN753"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN753"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN745"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN744"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="parallel.c.html#LN124"><span class='Ref_to_Proto'>HandleParallelMessage</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN726"><span class='Ref_To_Local'>pcxt</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN727"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN753"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN753"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"lost connection to parallel worker"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while pcxt-&GT;worker[i].error... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;pcxt-&GT;nworkers_... &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN694"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Might as well clear the context on our way out */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN696"><span class='Ref_To_Local'>hpm_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end HandleParallelMessages &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle a single protocol message received from a single parallel worker. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN780"></a><span class='Declare_Function'>HandleParallelMessage</span><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pcxt</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>i</span><span class='Delimiter'>, </span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN782"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>msgtype</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN782"><span class='Ref_To_Local'>msgtype</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN37"><span class='Ref_to_Proto'>pq_getmsgbyte</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN782"><span class='Ref_To_Local'>msgtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='String'>'K'</span><span class='Operator'>:</span>               <span class='Comment_Single_Line'>/* BackendKeyData */ 
</span>            <span class='Delimiter'>{ 
</span><a name="LN790"></a>                <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pid</span> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN38"><span class='Ref_to_Proto'>pq_getmsgint</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/libpq/pqformat.h.html#LN38"><span class='Ref_to_Proto'>pq_getmsgint</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* discard cancel key */ 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/libpq/pqformat.h.html#LN47"><span class='Ref_to_Proto'>pq_getmsgend</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN28"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN790"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>case</span> <span class='String'>'E'</span><span class='Operator'>:</span>               <span class='Comment_Single_Line'>/* ErrorResponse */ 
</span>        <span class='Control'>case</span> <span class='String'>'N'</span><span class='Operator'>:</span>               <span class='Comment_Single_Line'>/* NoticeResponse */ 
</span>            <span class='Delimiter'>{ 
</span><a name="LN801"></a>                <a href="../../../include/utils/elog.h.html#LN328"><span class='Ref_to_Struct'>ErrorData</span></a>   <span class='Declare_Local'>edata</span><span class='Delimiter'>; 
</span><a name="LN802"></a>                ErrorContextCallback <span class='Operator'>*</span><span class='Declare_Local'>save_error_context_stack</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Parse ErrorResponse or NoticeResponse. */ 
</span>                <a href="../../../include/libpq/pqmq.h.html#LN21"><span class='Ref_to_Proto'>pq_parse_errornotice</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Death of a worker isn't enough justification for suicide. */ 
</span>                <a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>.</span><a href="../../../include/utils/elog.h.html#LN330"><span class='Ref_to_Member'>elevel</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>.</span><a href="../../../include/utils/elog.h.html#LN330"><span class='Ref_to_Member'>elevel</span></a><span class='Delimiter'>, </span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If desired, add a context line to show that this is a 
                 * message propagated from a parallel worker.  Otherwise, it 
                 * can sometimes be confusing to understand what actually 
                 * happened.  (We don't do this in FORCE_PARALLEL_REGRESS mode 
                 * because it causes test-result instability depending on 
                 * whether a parallel worker is actually used or not.) 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../optimizer/plan/planner.c.html#LN62"><span class='Ref_to_Global_Var'>force_parallel_mode</span></a> <span class='Operator'>!= </span><a href="../../../include/optimizer/planmain.h.html#LN24"><span class='Ref_to_EnumConst'>FORCE_PARALLEL_REGRESS</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>.</span><a href="../../../include/utils/elog.h.html#LN346"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>) 
</span>                        <a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>.</span><a href="../../../include/utils/elog.h.html#LN346"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s\n%s"</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>.</span><a href="../../../include/utils/elog.h.html#LN346"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                                                 _<span class='Parentheses'>(</span><span class='String'>"parallel worker"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Operator'>.</span><a href="../../../include/utils/elog.h.html#LN346"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"parallel worker"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Context beyond that should use the error context callbacks 
                 * that were in effect when the ParallelContext was created, 
                 * not the current ones. 
                 */ 
</span>                <a href="parallel.c.html#LN802"><span class='Ref_To_Local'>save_error_context_stack</span></a> <span class='Operator'>= </span><a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>                <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN39"><span class='Ref_to_Member'>error_context_stack</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Rethrow error or print notice. */ 
</span>                <a href="../../utils/error/elog.c.html#LN1610"><span class='Ref_to_Func'>ThrowErrorData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN801"><span class='Ref_To_Local'>edata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Not an error, so restore previous context stack. */ 
</span>                <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN802"><span class='Ref_To_Local'>save_error_context_stack</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>case</span> <span class='String'>'A'</span><span class='Operator'>:</span>               <span class='Comment_Single_Line'>/* NotifyResponse */ 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Propagate NotifyResponse. */ 
</span><a name="LN847"></a>                <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span><a name="LN848"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>channel</span><span class='Delimiter'>; 
</span><a name="LN849"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>payload</span><span class='Delimiter'>; 
</span> 
                <a href="parallel.c.html#LN847"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN38"><span class='Ref_to_Proto'>pq_getmsgint</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN848"><span class='Ref_To_Local'>channel</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN46"><span class='Ref_to_Proto'>pq_getmsgrawstring</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN849"><span class='Ref_To_Local'>payload</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN46"><span class='Ref_to_Proto'>pq_getmsgrawstring</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/commands/async.h.html#LN30"><span class='Ref_to_Proto'>NotifyMyFrontEnd</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN848"><span class='Ref_To_Local'>channel</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN849"><span class='Ref_To_Local'>payload</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN847"><span class='Ref_To_Local'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>case</span> <span class='String'>'X'</span><span class='Operator'>:</span>               <span class='Comment_Single_Line'>/* Terminate, indicating clean exit */ 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN44"><span class='Ref_to_Member'>worker</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/parallel.h.html#LN27"><span class='Ref_to_Member'>error_mqh</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized message type received from parallel worker: %c (message length %d bytes)"</span><span class='Delimiter'>, 
</span>                     <a href="parallel.c.html#LN782"><span class='Ref_To_Local'>msgtype</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN780"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch msgtype &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end HandleParallelMessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * End-of-subtransaction cleanup for parallel contexts. 
 * 
 * Currently, it's forbidden to enter or leave a subtransaction while 
 * parallel mode is in effect, so we could just blow away everything.  But 
 * we may want to relax that restriction in the future, so this code 
 * contemplates that there may be multiple subtransaction IDs in pcxt_list. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN885"></a><span class='Declare_Function'>AtEOSubXact_Parallel</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN889"></a>        <a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pcxt</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN889"><span class='Ref_To_Local'>pcxt</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN486"><span class='Ref_to_Macro'>dlist_head_element</span></a><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN889"><span class='Ref_To_Local'>pcxt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/parallel.h.html#LN34"><span class='Ref_to_Member'>subid</span></a> <span class='Operator'>!= </span><a href="parallel.c.html#LN885"><span class='Ref_to_Parameter'>mySubId</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN885"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"leaked parallel context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/parallel.h.html#LN58"><span class='Ref_to_Proto'>DestroyParallelContext</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN889"><span class='Ref_To_Local'>pcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * End-of-transaction cleanup for parallel contexts. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN904"></a><span class='Declare_Function'>AtEOXact_Parallel</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN908"></a>        <a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pcxt</span><span class='Delimiter'>; 
</span> 
        <a href="parallel.c.html#LN908"><span class='Ref_To_Local'>pcxt</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN486"><span class='Ref_to_Macro'>dlist_head_element</span></a><span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN31"><span class='Ref_to_Struct'>ParallelContext</span></a><span class='Delimiter'>, </span><a href="../../replication/repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="parallel.c.html#LN105"><span class='Ref_to_Global_Var'>pcxt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN904"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"leaked parallel context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/parallel.h.html#LN58"><span class='Ref_to_Proto'>DestroyParallelContext</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN908"><span class='Ref_To_Local'>pcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Main entrypoint for parallel workers. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN921"></a><span class='Declare_Function'>ParallelWorkerMain</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>main_arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN923"></a>    <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seg</span><span class='Delimiter'>; 
</span><a name="LN924"></a>    <a href="../../storage/ipc/shm_toc.c.html#LN25"><span class='Ref_to_Struct'>shm_toc</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>toc</span><span class='Delimiter'>; 
</span><a name="LN925"></a>    <a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fps</span><span class='Delimiter'>; 
</span><a name="LN926"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>error_queue_space</span><span class='Delimiter'>; 
</span><a name="LN927"></a>    <a href="../../storage/ipc/shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span><span class='Delimiter'>; 
</span><a name="LN928"></a>    <a href="../../storage/ipc/shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>mqh</span><span class='Delimiter'>; 
</span><a name="LN929"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>libraryspace</span><span class='Delimiter'>; 
</span><a name="LN930"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>entrypointstate</span><span class='Delimiter'>; 
</span><a name="LN931"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>library_name</span><span class='Delimiter'>; 
</span><a name="LN932"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>function_name</span><span class='Delimiter'>; 
</span><a name="LN933"></a>    <a href="../../../include/access/parallel.h.html#LN22"><span class='Ref_to_Typedef'>parallel_worker_main_type</span></a> <span class='Declare_Local'>entrypt</span><span class='Delimiter'>; 
</span><a name="LN934"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>gucspace</span><span class='Delimiter'>; 
</span><a name="LN935"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>combocidspace</span><span class='Delimiter'>; 
</span><a name="LN936"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tsnapspace</span><span class='Delimiter'>; 
</span><a name="LN937"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>asnapspace</span><span class='Delimiter'>; 
</span><a name="LN938"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tstatespace</span><span class='Delimiter'>; 
</span><a name="LN939"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>msgbuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set flag to indicate that we're initializing a parallel worker. */ 
</span>    <a href="parallel.c.html#LN99"><span class='Ref_to_Global_Var'>InitializingParallelWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Establish signal handlers. */ 
</span>    <a href="../../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="../../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postmaster/bgworker.h.html#LN149"><span class='Ref_to_Proto'>BackgroundWorkerUnblockSignals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Determine and set our parallel worker number. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN93"><span class='Ref_to_Global_Var'>ParallelWorkerNumber</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN93"><span class='Ref_to_Global_Var'>ParallelWorkerNumber</span></a><span class='Delimiter'>, </span><a href="../../postmaster/postmaster.c.html#LN188"><span class='Ref_to_Global_Var'>MyBgworkerEntry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/postmaster/bgworker.h.html#LN96"><span class='Ref_to_Member'>bgw_extra</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up a memory context and resource owner. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="../../../include/utils/resowner.h.html#LN66"><span class='Ref_to_Proto'>ResourceOwnerCreate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"parallel toplevel"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                                 <span class='String'>"Parallel worker"</span><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have a resource owner, we can attach to the dynamic shared 
     * memory segment and read the table of contents. 
     */ 
</span>    <a href="parallel.c.html#LN923"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN37"><span class='Ref_to_Proto'>dsm_attach</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN491"><span class='Ref_to_Macro'>DatumGetUInt32</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN921"><span class='Ref_to_Parameter'>main_arg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN923"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not map dynamic shared memory segment"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN30"><span class='Ref_to_Proto'>shm_toc_attach</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN50"><span class='Ref_to_Const'>PARALLEL_MAGIC</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN923"><span class='Ref_To_Local'>seg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid magic number in dynamic shared memory segment"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up fixed parallel state. */ 
</span>    <a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN56"><span class='Ref_to_Const'>PARALLEL_KEY_FIXED</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN102"><span class='Ref_to_Global_Var'>MyFixedParallelState</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have a worker number, we can find and attach to the error 
     * queue provided for us.  That's good, because until we do that, any 
     * errors that happen here will not be reported back to the process that 
     * requested that this worker be launched. 
     */ 
</span>    <a href="parallel.c.html#LN926"><span class='Ref_To_Local'>error_queue_space</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN57"><span class='Ref_to_Const'>PARALLEL_KEY_ERROR_QUEUE</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN927"><span class='Ref_To_Local'>mq</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../storage/ipc/shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="parallel.c.html#LN926"><span class='Ref_To_Local'>error_queue_space</span></a> <span class='Operator'>+ 
</span>                     <a href="parallel.c.html#LN93"><span class='Ref_to_Global_Var'>ParallelWorkerNumber</span></a> <span class='Operator'>* </span><a href="parallel.c.html#LN47"><span class='Ref_to_Const'>PARALLEL_ERROR_QUEUE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/shm_mq.h.html#LN51"><span class='Ref_to_Proto'>shm_mq_set_sender</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN927"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN928"><span class='Ref_To_Local'>mqh</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_mq.h.html#LN58"><span class='Ref_to_Proto'>shm_mq_attach</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN927"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN923"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqmq.h.html#LN18"><span class='Ref_to_Proto'>pq_redirect_to_shm_mq</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN923"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN928"><span class='Ref_To_Local'>mqh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqmq.h.html#LN19"><span class='Ref_to_Proto'>pq_set_parallel_master</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN77"><span class='Ref_to_Member'>parallel_master_pid</span></a><span class='Delimiter'>, 
</span>                           <a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN78"><span class='Ref_to_Member'>parallel_master_backend_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Send a BackendKeyData message to the process that initiated parallelism 
     * so that it has access to our PID before it receives any other messages 
     * from us.  Our cancel key is sent, too, since that's the way the 
     * protocol message is defined, but it won't actually be used for anything 
     * in this case. 
     */ 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN939"><span class='Ref_To_Local'>msgbuf</span></a><span class='Delimiter'>, </span><span class='String'>'K'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN939"><span class='Ref_To_Local'>msgbuf</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN939"><span class='Ref_To_Local'>msgbuf</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><a href="../../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN939"><span class='Ref_To_Local'>msgbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Hooray! Primary initialization is complete.  Now, we need to set up our 
     * backend-local state to match the original backend. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Join locking group.  We must do this before anything that could try to 
     * acquire a heavyweight lock, because any heavyweight locks acquired to 
     * this point could block either directly against the parallel group 
     * leader or against some process which in turn waits for a lock that 
     * conflicts with the parallel group leader, causing an undetected 
     * deadlock.  (If we can't join the lock group, the leader has gone away, 
     * so just exit quietly.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/proc.h.html#LN313"><span class='Ref_to_Proto'>BecomeLockGroupMember</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN76"><span class='Ref_to_Member'>parallel_master_pgproc</span></a><span class='Delimiter'>, 
</span>                               <a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN77"><span class='Ref_to_Member'>parallel_master_pid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Load libraries that were loaded by original backend.  We want to do 
     * this before restoring GUCs, because the libraries might define custom 
     * variables. 
     */ 
</span>    <a href="parallel.c.html#LN929"><span class='Ref_To_Local'>libraryspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN58"><span class='Ref_to_Const'>PARALLEL_KEY_LIBRARY</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/fmgr.h.html#LN682"><span class='Ref_to_Proto'>RestoreLibraryState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN929"><span class='Ref_To_Local'>libraryspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Identify the entry point to be called.  In theory this could result in 
     * loading an additional library, though most likely the entry point is in 
     * the core backend or in a library we just loaded. 
     */ 
</span>    <a href="parallel.c.html#LN930"><span class='Ref_To_Local'>entrypointstate</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN64"><span class='Ref_to_Const'>PARALLEL_KEY_ENTRYPOINT</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN931"><span class='Ref_To_Local'>library_name</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN930"><span class='Ref_To_Local'>entrypointstate</span></a><span class='Delimiter'>; 
</span>    <a href="parallel.c.html#LN932"><span class='Ref_To_Local'>function_name</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN930"><span class='Ref_To_Local'>entrypointstate</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="parallel.c.html#LN931"><span class='Ref_To_Local'>library_name</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="parallel.c.html#LN933"><span class='Ref_To_Local'>entrypt</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN126"><span class='Ref_to_Proto'>LookupParallelWorkerFunction</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN931"><span class='Ref_To_Local'>library_name</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN932"><span class='Ref_To_Local'>function_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore database connection. */ 
</span>    <a href="../../../include/postmaster/bgworker.h.html#LN145"><span class='Ref_to_Proto'>BackgroundWorkerInitializeConnectionByOid</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN70"><span class='Ref_to_Member'>database_id</span></a><span class='Delimiter'>, 
</span>                                              <a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN71"><span class='Ref_to_Member'>authenticated_user_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the client encoding to the database encoding, since that is what 
     * the leader will expect. 
     */ 
</span>    <a href="../../utils/mb/mbutils.c.html#LN210"><span class='Ref_to_Func'>SetClientEncoding</span></a><span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore GUC values from launching backend. */ 
</span>    <a href="parallel.c.html#LN934"><span class='Ref_To_Local'>gucspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN59"><span class='Ref_to_Const'>PARALLEL_KEY_GUC</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/guc.h.html#LN392"><span class='Ref_to_Proto'>RestoreGUCState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN934"><span class='Ref_To_Local'>gucspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Crank up a transaction state appropriate to a parallel worker. */ 
</span>    <a href="parallel.c.html#LN938"><span class='Ref_To_Local'>tstatespace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN63"><span class='Ref_to_Const'>PARALLEL_KEY_TRANSACTION_STATE</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xact.h.html#LN364"><span class='Ref_to_Proto'>StartParallelWorkerTransaction</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN938"><span class='Ref_To_Local'>tstatespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore combo CID state. */ 
</span>    <a href="parallel.c.html#LN935"><span class='Ref_To_Local'>combocidspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN60"><span class='Ref_to_Const'>PARALLEL_KEY_COMBO_CID</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/combocid.h.html#LN23"><span class='Ref_to_Proto'>RestoreComboCIDState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN935"><span class='Ref_To_Local'>combocidspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore transaction snapshot. */ 
</span>    <a href="parallel.c.html#LN936"><span class='Ref_To_Local'>tsnapspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN61"><span class='Ref_to_Const'>PARALLEL_KEY_TRANSACTION_SNAPSHOT</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN110"><span class='Ref_to_Proto'>RestoreTransactionSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN109"><span class='Ref_to_Proto'>RestoreSnapshot</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN936"><span class='Ref_To_Local'>tsnapspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN76"><span class='Ref_to_Member'>parallel_master_pgproc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore active snapshot. */ 
</span>    <a href="parallel.c.html#LN937"><span class='Ref_To_Local'>asnapspace</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shm_toc.h.html#LN34"><span class='Ref_to_Proto'>shm_toc_lookup</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN62"><span class='Ref_to_Const'>PARALLEL_KEY_ACTIVE_SNAPSHOT</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN109"><span class='Ref_to_Proto'>RestoreSnapshot</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN937"><span class='Ref_To_Local'>asnapspace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We've changed which tuples we can see, and must therefore invalidate 
     * system caches. 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN64"><span class='Ref_to_Proto'>InvalidateSystemCaches</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore user ID and security context. */ 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN72"><span class='Ref_to_Member'>current_user_id</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN75"><span class='Ref_to_Member'>sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore temp-namespace state to ensure search path matches leader's. */ 
</span>    <a href="../../../include/catalog/namespace.h.html#LN132"><span class='Ref_to_Proto'>SetTempNamespaceState</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN73"><span class='Ref_to_Member'>temp_namespace_id</span></a><span class='Delimiter'>, 
</span>                          <a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN74"><span class='Ref_to_Member'>temp_toast_namespace_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set ParallelMasterBackendId so we know how to address temp relations. */ 
</span>    <a href="../../utils/init/globals.c.html#LN74"><span class='Ref_to_Global_Var'>ParallelMasterBackendId</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN925"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN78"><span class='Ref_to_Member'>parallel_master_backend_id</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We've initialized all of our state now; nothing should change 
     * hereafter. 
     */ 
</span>    <a href="parallel.c.html#LN99"><span class='Ref_to_Global_Var'>InitializingParallelWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xact.h.html#LN403"><span class='Ref_to_Proto'>EnterParallelMode</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Time to do the real work: invoke the caller-supplied code. 
     */ 
</span>    <a href="parallel.c.html#LN933"><span class='Ref_To_Local'>entrypt</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN923"><span class='Ref_To_Local'>seg</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN924"><span class='Ref_To_Local'>toc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must exit parallel mode to pop active snapshot. */ 
</span>    <a href="../../../include/access/xact.h.html#LN404"><span class='Ref_to_Proto'>ExitParallelMode</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must pop active snapshot so resowner.c doesn't complain. */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Shut down the parallel-worker transaction. */ 
</span>    <a href="../../../include/access/xact.h.html#LN365"><span class='Ref_to_Proto'>EndParallelWorkerTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report success. */ 
</span>    <a href="../../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'X'</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ParallelWorkerMain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update shared memory with the ending location of the last WAL record we 
 * wrote, if it's greater than the value already stored there. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1121"></a><span class='Declare_Function'>ParallelWorkerReportLastRecEnd</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>last_xlog_end</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1123"></a>    <a href="parallel.c.html#LN67"><span class='Ref_to_Struct'>FixedParallelState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fps</span> <span class='Operator'>= </span><a href="parallel.c.html#LN102"><span class='Ref_to_Global_Var'>MyFixedParallelState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="parallel.c.html#LN1123"><span class='Ref_To_Local'>fps</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN1123"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN81"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1123"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN84"><span class='Ref_to_Member'>last_xlog_end</span></a> <span class='Operator'>&LT; </span><a href="parallel.c.html#LN1121"><span class='Ref_to_Parameter'>last_xlog_end</span></a><span class='Parentheses'>) 
</span>        <a href="parallel.c.html#LN1123"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN84"><span class='Ref_to_Member'>last_xlog_end</span></a> <span class='Operator'>= </span><a href="parallel.c.html#LN1121"><span class='Ref_to_Parameter'>last_xlog_end</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="parallel.c.html#LN1123"><span class='Ref_To_Local'>fps</span></a><span class='Operator'>-&GT;</span><a href="parallel.c.html#LN81"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Look up (and possibly load) a parallel worker entry point function. 
 * 
 * For functions contained in the core code, we use library name "postgres" 
 * and consult the InternalParallelWorkers array.  External functions are 
 * looked up, and loaded if necessary, using load_external_function(). 
 * 
 * The point of this is to pass function names as strings across process 
 * boundaries.  We can't pass actual function addresses because of the 
 * possibility that the function has been loaded at a different address 
 * in a different process.  This is obviously a hazard for functions in 
 * loadable libraries, but it can happen even for functions in the core code 
 * on platforms using EXEC_BACKEND (e.g., Windows). 
 * 
 * At some point it might be worthwhile to get rid of InternalParallelWorkers[] 
 * in favor of applying load_external_function() for core functions too; 
 * but that raises portability issues that are not worth addressing now. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/parallel.h.html#LN22"><span class='Ref_to_Typedef'>parallel_worker_main_type</span></a> 
<a name="LN1151"></a><span class='Declare_Function'>LookupParallelWorkerFunction</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libraryname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>funcname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If the function is to be loaded from postgres itself, search the 
     * InternalParallelWorkers array. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="parallel.c.html#LN1151"><span class='Ref_to_Parameter'>libraryname</span></a><span class='Delimiter'>, </span><span class='String'>"postgres"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1159"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="parallel.c.html#LN1159"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1159"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN115"><span class='Ref_to_Global_Var'>InternalParallelWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="parallel.c.html#LN1159"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="parallel.c.html#LN115"><span class='Ref_to_Global_Var'>InternalParallelWorkers</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1159"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN113"><span class='Ref_to_Member'>fn_name</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1151"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <a href="parallel.c.html#LN115"><span class='Ref_to_Global_Var'>InternalParallelWorkers</span></a><span class='Delimiter'>[</span><a href="parallel.c.html#LN1159"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="parallel.c.html#LN114"><span class='Ref_to_Member'>fn_addr</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* We can only reach this by programming error. */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"internal function \"%s\" not found"</span><span class='Delimiter'>, </span><a href="parallel.c.html#LN1151"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Otherwise load from external library. */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN22"><span class='Ref_to_Typedef'>parallel_worker_main_type</span></a><span class='Parentheses'>) 
</span>        <a href="../../utils/fmgr/dfmgr.c.html#LN92"><span class='Ref_to_Func'>load_external_function</span></a><span class='Parentheses'>(</span><a href="parallel.c.html#LN1151"><span class='Ref_to_Parameter'>libraryname</span></a><span class='Delimiter'>, </span><a href="parallel.c.html#LN1151"><span class='Ref_to_Parameter'>funcname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LookupParallelWorkerFunction &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>