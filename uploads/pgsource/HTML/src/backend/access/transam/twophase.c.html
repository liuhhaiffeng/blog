<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\transam\twophase.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\transam\twophase.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:30 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * twophase.c 
 *      Two-phase commit support functions. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *      src/backend/access/transam/twophase.c 
 * 
 * NOTES 
 *      Each global transaction is associated with a global transaction 
 *      identifier (GID). The client assigns a GID to a postgres 
 *      transaction with the PREPARE TRANSACTION command. 
 * 
 *      We keep all active global transactions in a shared memory array. 
 *      When the PREPARE TRANSACTION command is issued, the GID is 
 *      reserved for the transaction in the array. This is done before 
 *      a WAL entry is made, because the reservation checks for duplicate 
 *      GIDs and aborts the transaction if there already is a global 
 *      transaction in prepared state with the same GID. 
 * 
 *      A global transaction (gxact) also has dummy PGXACT and PGPROC; this is 
 *      what keeps the XID considered running by TransactionIdIsInProgress. 
 *      It is also convenient as a PGPROC to hook the gxact's locks to. 
 * 
 *      Information to recover prepared transactions in case of crash is 
 *      now stored in WAL for the common case. In some cases there will be 
 *      an extended period between preparing a GXACT and commit/abort, in 
 *      which case we need to separately record prepared transaction data 
 *      in permanent storage. This includes locking information, pending 
 *      notifications etc. All that state information is written to the 
 *      per-transaction state file in the pg_twophase directory. 
 *      All prepared transactions will be written prior to shutdown. 
 * 
 *      Life track of state data is following: 
 * 
 *      * On PREPARE TRANSACTION backend writes state data only to the WAL and 
 *        stores pointer to the start of the WAL record in 
 *        gxact-&GT;prepare_start_lsn. 
 *      * If COMMIT occurs before checkpoint then backend reads data from WAL 
 *        using prepare_start_lsn. 
 *      * On checkpoint state data copied to files in pg_twophase directory and 
 *        fsynced 
 *      * If COMMIT happens after checkpoint then backend reads state data from 
 *        files 
 * 
 *      During replay and replication, TwoPhaseState also holds information 
 *      about active prepared transactions that haven't been moved to disk yet. 
 * 
 *      Replay of twophase records happens by the following rules: 
 * 
 *      * At the beginning of recovery, pg_twophase is scanned once, filling 
 *        TwoPhaseState with entries marked with gxact-&GT;inredo and 
 *        gxact-&GT;ondisk.  Two-phase file data older than the XID horizon of 
 *        the redo position are discarded. 
 *      * On PREPARE redo, the transaction is added to TwoPhaseState-&GT;prepXacts. 
 *        gxact-&GT;inredo is set to true for such entries. 
 *      * On Checkpoint we iterate through TwoPhaseState-&GT;prepXacts entries 
 *        that have gxact-&GT;inredo set and are behind the redo_horizon. We 
 *        save them to disk and then switch gxact-&GT;ondisk to true. 
 *      * On COMMIT/ABORT we delete the entry from TwoPhaseState-&GT;prepXacts. 
 *        If gxact-&GT;ondisk is true, the corresponding entry from the disk 
 *        is additionally deleted. 
 *      * RecoverPreparedTransactions(), StandbyRecoverPreparedTransactions() 
 *        and PrescanPreparedTransactions() have been modified to go through 
 *        gxact-&GT;inredo entries that have not made it to disk. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/commit_ts.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/subtrans.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase_rmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogreader.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/storage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/origin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/syncrep.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinvaladt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Directory where Two-phase commit files reside within PGDATA 
 */ 
</span><a name="LN113"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TWOPHASE_DIR</span> <span class='String'>"pg_twophase"</span> 
 
<span class='Comment_Multi_Line'>/* GUC variable, can't be changed after startup */ 
</span><a name="LN116"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>max_prepared_xacts</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This struct describes one global transaction that is in prepared state 
 * or attempting to become prepared. 
 * 
 * The lifecycle of a global transaction is: 
 * 
 * 1. After checking that the requested GID is not in use, set up an entry in 
 * the TwoPhaseState-&GT;prepXacts array with the correct GID and valid = false, 
 * and mark it as locked by my backend. 
 * 
 * 2. After successfully completing prepare, set valid = true and enter the 
 * referenced PGPROC into the global ProcArray. 
 * 
 * 3. To begin COMMIT PREPARED or ROLLBACK PREPARED, check that the entry is 
 * valid and not locked, then mark the entry as locked by storing my current 
 * backend ID into locking_backend.  This prevents concurrent attempts to 
 * commit or rollback the same prepared xact. 
 * 
 * 4. On completion of COMMIT PREPARED or ROLLBACK PREPARED, remove the entry 
 * from the ProcArray and the TwoPhaseState-&GT;prepXacts array and return it to 
 * the freelist. 
 * 
 * Note that if the preparing transaction fails between steps 1 and 2, the 
 * entry must be removed so that the GID and the GlobalTransaction struct 
 * can be reused.  See AtAbort_Twophase(). 
 * 
 * typedef struct GlobalTransactionData *GlobalTransaction appears in 
 * twophase.h 
 * 
 * Note that the max value of GIDSIZE must fit in the uint16 gidlen, 
 * specified in TwoPhaseFileHeader. 
 */ 
</span><a name="LN150"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>GIDSIZE</span> <span class='Number'>200</span> 
 
<a name="LN152"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>GlobalTransactionData</span> 
<span class='Delimiter'>{ 
</span><a name="LN154"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Member'>next</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* list link for free list */ 
</span><a name="LN155"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pgprocno</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* ID of associated dummy PGPROC */ 
</span><a name="LN156"></a>    <a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a>   <span class='Declare_Member'>dummyBackendId</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* similar to backend id for backends */ 
</span><a name="LN157"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>prepared_at</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* time of preparation */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that we need to keep track of two LSNs for each GXACT. We keep 
     * track of the start LSN because this is the address we must use to read 
     * state data back from WAL when committing a prepared GXACT. We keep 
     * track of the end LSN because that is the LSN we need to wait for prior 
     * to commit. 
     */ 
</span><a name="LN166"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>prepare_start_lsn</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* XLOG offset of prepare record start */ 
</span><a name="LN167"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>prepare_end_lsn</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* XLOG offset of prepare record end */ 
</span><a name="LN168"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xid</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* The GXACT id */ 
</span> 
<a name="LN170"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>owner</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* ID of user that executed the xact */ 
</span><a name="LN171"></a>    <a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a>   <span class='Declare_Member'>locking_backend</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* backend currently working on the xact */ 
</span><a name="LN172"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>valid</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* TRUE if PGPROC entry is in proc array */ 
</span><a name="LN173"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>ondisk</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* TRUE if prepare state file is on disk */ 
</span><a name="LN174"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>inredo</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* TRUE if entry was added via xlog_redo */ 
</span><a name="LN175"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>gid</span><span class='Delimiter'>[</span><a href="twophase.c.html#LN150"><span class='Ref_to_Const'>GIDSIZE</span></a><span class='Delimiter'>];</span>   <span class='Comment_Single_Line'>/* The GID assigned to the prepared xact */ 
</span><a name="LN176"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end GlobalTransactionData &raquo; </span>   <span class='Declare_Typedef'>GlobalTransactionData</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Two Phase Commit shared state.  Access to this struct is protected 
 * by TwoPhaseStateLock. 
 */ 
</span><a name="LN182"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TwoPhaseStateData</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Head of linked list of free GlobalTransactionData structs */ 
</span><a name="LN185"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Member'>freeGXacts</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Number of valid prepXacts entries. */ 
</span><a name="LN188"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>numPrepXacts</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* There are max_prepared_xacts items in this array */ 
</span><a name="LN191"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Member'>prepXacts</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN192"></a>} <span class='Declare_Typedef'>TwoPhaseStateData</span><span class='Delimiter'>; 
</span> 
<a name="LN194"></a><span class='Keyword'>static </span><a href="twophase.c.html#LN182"><span class='Ref_to_Struct'>TwoPhaseStateData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>TwoPhaseState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Global transaction entry currently locked by us, if any. 
 */ 
</span><a name="LN199"></a><span class='Keyword'>static </span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Var'>MyLockedGxact</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN201"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>twophaseExitRegistered</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN203"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RecordTransactionCommitPrepared</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN204"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>nchildren</span><span class='Delimiter'>, 
</span><a name="LN205"></a>                                <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>children</span><span class='Delimiter'>, 
</span><a name="LN206"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>nrels</span><span class='Delimiter'>, 
</span><a name="LN207"></a>                                <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rels</span><span class='Delimiter'>, 
</span><a name="LN208"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>ninvalmsgs</span><span class='Delimiter'>, 
</span><a name="LN209"></a>                                <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>invalmsgs</span><span class='Delimiter'>, 
</span><a name="LN210"></a>                                <span class='Keyword'>bool </span><span class='Declare_Parameter'>initfileinval</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN211"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RecordTransactionAbortPrepared</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN212"></a>                               <span class='Keyword'>int </span><span class='Declare_Parameter'>nchildren</span><span class='Delimiter'>, 
</span><a name="LN213"></a>                               <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>children</span><span class='Delimiter'>, 
</span><a name="LN214"></a>                               <span class='Keyword'>int </span><span class='Declare_Parameter'>nrels</span><span class='Delimiter'>, 
</span><a name="LN215"></a>                               <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rels</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN216"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ProcessRecords</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>bufptr</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN217"></a>               <span class='Keyword'>const </span><a href="../../../include/access/twophase_rmgr.h.html#LN16"><span class='Ref_to_Typedef'>TwoPhaseCallback</span></a> <span class='Declare_Parameter'>callbacks</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN218"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RemoveGXact</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN220"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>XlogReadTwoPhaseData</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN221"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>ProcessTwoPhaseBuffer</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN222"></a>                      <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>prepare_start_lsn</span><span class='Delimiter'>, 
</span><a name="LN223"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>fromdisk</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>setParent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>setNextXid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN224"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>MarkAsPreparingGuts</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN225"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gid</span><span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>prepared_at</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>owner</span><span class='Delimiter'>, 
</span><a name="LN226"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN227"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RemoveTwoPhaseFile</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>giveWarning</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN228"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RecreateTwoPhaseFile</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>content</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialization of shared memory 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN234"></a><span class='Declare_Function'>TwoPhaseShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN236"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Need the fixed struct, the array of pointers, and the GTD structs */ 
</span>    <a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN182"><span class='Ref_to_Struct'>TwoPhaseStateData</span></a><span class='Delimiter'>, </span>prepXacts<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN152"><span class='Ref_to_Struct'>GlobalTransactionData</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN236"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN250"></a><span class='Declare_Function'>TwoPhaseShmemInit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN252"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Prepared Transaction Table"</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/access/twophase.h.html#LN29"><span class='Ref_to_Proto'>TwoPhaseShmemSize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="twophase.c.html#LN252"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN259"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxacts</span><span class='Delimiter'>; 
</span><a name="LN260"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN252"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Initialize the linked list of free GlobalTransactionData structs 
         */ 
</span>        <a href="twophase.c.html#LN259"><span class='Ref_To_Local'>gxacts</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a><span class='Parentheses'>) 
</span>            <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a> <span class='Operator'>+ 
</span>             <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN182"><span class='Ref_to_Struct'>TwoPhaseStateData</span></a><span class='Delimiter'>, </span>prepXacts<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                      <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* insert into linked list */ 
</span>            <a href="twophase.c.html#LN259"><span class='Ref_To_Local'>gxacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="twophase.c.html#LN154"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>= &</span><a href="twophase.c.html#LN259"><span class='Ref_To_Local'>gxacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* associate it with a PGPROC assigned by InitProcGlobal */ 
</span>            <a href="twophase.c.html#LN259"><span class='Ref_To_Local'>gxacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a> <span class='Operator'>= </span><a href="../../storage/lmgr/proc.c.html#LN81"><span class='Ref_to_Global_Var'>PreparedXactProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/proc.h.html#LN108"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Assign a unique ID for each dummy proc, so that the range of 
             * dummy backend IDs immediately follows the range of normal 
             * backend IDs. We don't dare to assign a real backend ID to dummy 
             * procs, because prepared transactions don't take part in cache 
             * invalidation like a real backend ID would imply, but having a 
             * unique ID for them is nevertheless handy. This arrangement 
             * allows you to allocate an array of size (MaxBackends + 
             * max_prepared_xacts + 1), and have a slot for every backend and 
             * prepared transaction. Currently multixact.c uses that 
             * technique. 
             */ 
</span>            <a href="twophase.c.html#LN259"><span class='Ref_To_Local'>gxacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="twophase.c.html#LN156"><span class='Ref_to_Member'>dummyBackendId</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="twophase.c.html#LN260"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;max_prepared_xa... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !IsUnderPostmaster &raquo; </span> 
    <span class='Control'>else</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN252"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TwoPhaseShmemInit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Exit hook to unlock the global transaction entry we're working on. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN305"></a><span class='Declare_Function'>AtProcExit_Twophase</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* same logic as abort */ 
</span>    <a href="../../../include/access/twophase.h.html#LN32"><span class='Ref_to_Proto'>AtAbort_Twophase</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Abort hook to unlock the global transaction entry we're working on. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN315"></a><span class='Declare_Function'>AtAbort_Twophase</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * What to do with the locked global transaction entry?  If we were in the 
     * process of preparing the transaction, but haven't written the WAL 
     * record and state file yet, the transaction must not be considered as 
     * prepared.  Likewise, if we are in the process of finishing an 
     * already-prepared transaction, and fail after having already written the 
     * 2nd phase commit or rollback record to the WAL, the transaction should 
     * not be considered as prepared anymore.  In those cases, just remove the 
     * entry from shared memory. 
     * 
     * Otherwise, the entry must be left in place so that the transaction can 
     * be finished later, so just unlock it. 
     * 
     * If we abort during prepare, after having written the WAL record, we 
     * might not have transferred all locks and other state to the prepared 
     * transaction yet.  Likewise, if we abort during commit or rollback, 
     * after having written the WAL record, we might not have released all the 
     * resources held by the transaction yet.  In those cases, the in-memory 
     * state can be wrong, but it's too late to back out. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN218"><span class='Ref_to_Proto'>RemoveGXact</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN171"><span class='Ref_to_Member'>locking_backend</span></a> <span class='Operator'>= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtAbort_Twophase &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * This is called after we have finished transferring state to the prepared 
 * PGXACT entry. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN360"></a><span class='Declare_Function'>PostPrepare_Twophase</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN171"><span class='Ref_to_Member'>locking_backend</span></a> <span class='Operator'>= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * MarkAsPreparing 
 *      Reserve the GID for the given transaction. 
 */ 
</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> 
<a name="LN375"></a><span class='Declare_Function'>MarkAsPreparing</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gid</span><span class='Delimiter'>, 
</span><a name="LN376"></a>                <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>prepared_at</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>owner</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN378"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span><span class='Delimiter'>; 
</span><a name="LN379"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="twophase.c.html#LN375"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="twophase.c.html#LN150"><span class='Ref_to_Const'>GIDSIZE</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"transaction identifier \"%s\" is too long"</span><span class='Delimiter'>, 
</span>                        <a href="twophase.c.html#LN375"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fail immediately if feature is disabled */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"prepared transactions are disabled"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Set max_prepared_transactions to a nonzero value."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* on first call, register the exit hook */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN201"><span class='Ref_to_Global_Var'>twophaseExitRegistered</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/ipc.h.html#LN70"><span class='Ref_to_Proto'>before_shmem_exit</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN304"><span class='Ref_to_Func'>AtProcExit_Twophase</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN201"><span class='Ref_to_Global_Var'>twophaseExitRegistered</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for conflicting GID */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN379"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN379"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN379"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN379"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN375"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"transaction identifier \"%s\" is already in use"</span><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN375"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Get a free gxact from the freelist */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"maximum number of prepared transactions reached"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Increase max_prepared_transactions (currently %d)."</span><span class='Delimiter'>, 
</span>                         <a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN154"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN224"><span class='Ref_to_Proto'>MarkAsPreparingGuts</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN375"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN375"><span class='Ref_to_Parameter'>gid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN376"><span class='Ref_to_Parameter'>prepared_at</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN376"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN376"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And insert it into the active array */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN378"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MarkAsPreparing &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MarkAsPreparingGuts 
 * 
 * This uses a gxact struct and puts it into the active array. 
 * NOTE: this is also used when reloading a gxact after a crash; so avoid 
 * assuming that we can use very much backend context. 
 * 
 * Note: This function should be called with appropriate locks held. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN449"></a><span class='Declare_Function'>MarkAsPreparingGuts</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gid</span><span class='Delimiter'>, 
</span><a name="LN450"></a>                    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>prepared_at</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>owner</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN452"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN453"></a>    <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span><span class='Delimiter'>; 
</span><a name="LN454"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the PGPROC entry */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN108"><span class='Ref_to_Member'>pgprocno</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>; 
</span>    <a href="../../storage/ipc/shmqueue.c.html#LN55"><span class='Ref_to_Func'>SHMQueueElemInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN100"><span class='Ref_to_Member'>waitStatus</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We set up the gxact's VXID as InvalidBackendId/XID */ 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN398"><span class='Ref_to_Typedef'>LocalTransactionId</span></a><span class='Parentheses'>) </span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN208"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN217"><span class='Ref_to_Member'>vacuumFlags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN450"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN113"><span class='Ref_to_Member'>roleId</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN450"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN115"><span class='Ref_to_Member'>isBackgroundWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN125"><span class='Ref_to_Member'>lwWaiting</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN126"><span class='Ref_to_Member'>lwWaitMode</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN135"><span class='Ref_to_Member'>waitProcLock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN454"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN454"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN454"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../storage/ipc/shmqueue.c.html#LN34"><span class='Ref_to_Func'>SHMQueueInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN452"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN454"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* subxid data must be filled later by GXactLoadSubxactData */ 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN218"><span class='Ref_to_Member'>overflowed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN453"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN222"><span class='Ref_to_Member'>nxids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN157"><span class='Ref_to_Member'>prepared_at</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN450"><span class='Ref_to_Parameter'>prepared_at</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN170"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN450"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN171"><span class='Ref_to_Member'>locking_backend</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remember that we have this GlobalTransaction entry locked for us. If we 
     * abort after this, we must release it. 
     */ 
</span>    <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN449"><span class='Ref_to_Parameter'>gxact</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MarkAsPreparingGuts &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GXactLoadSubxactData 
 * 
 * If the transaction being persisted had any subtransactions, this must 
 * be called before MarkAsPrepared() to load information into the dummy 
 * PGPROC. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN509"></a><span class='Declare_Function'>GXactLoadSubxactData</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nsubxacts</span><span class='Delimiter'>, 
</span><a name="LN510"></a>                     <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>children</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN512"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span><a name="LN513"></a>    <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* We need no extra lock since the GXACT isn't valid yet */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/proc.h.html#LN34"><span class='Ref_to_Const'>PGPROC_MAX_CACHED_SUBXIDS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN513"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN218"><span class='Ref_to_Member'>overflowed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>= </span><a href="../../../include/storage/proc.h.html#LN34"><span class='Ref_to_Const'>PGPROC_MAX_CACHED_SUBXIDS</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="twophase.c.html#LN512"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN157"><span class='Ref_to_Member'>subxids</span></a><span class='Operator'>.</span><a href="../../../include/storage/proc.h.html#LN38"><span class='Ref_to_Member'>xids</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN510"><span class='Ref_to_Parameter'>children</span></a><span class='Delimiter'>, 
</span>               <a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN513"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN222"><span class='Ref_to_Member'>nxids</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN509"><span class='Ref_to_Parameter'>nsubxacts</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end GXactLoadSubxactData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MarkAsPrepared 
 *      Mark the GXACT as fully valid, and enter it into the global ProcArray. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN534"></a><span class='Declare_Function'>MarkAsPrepared</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Lock here may be overkill, but I'm not convinced of that ... */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN534"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN534"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Put it into the global ProcArray so TransactionIdIsInProgress considers 
     * the XID as still running. 
     */ 
</span>    <a href="../../../include/storage/procarray.h.html#LN60"><span class='Ref_to_Proto'>ProcArrayAdd</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN534"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * LockGXact 
 *      Locate the prepared transaction and mark it busy for COMMIT or PREPARE. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> 
<a name="LN554"></a><span class='Declare_Function'>LockGXact</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>user</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN556"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* on first call, register the exit hook */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN201"><span class='Ref_to_Global_Var'>twophaseExitRegistered</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/ipc.h.html#LN70"><span class='Ref_to_Proto'>before_shmem_exit</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN304"><span class='Ref_to_Func'>AtProcExit_Twophase</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN201"><span class='Ref_to_Global_Var'>twophaseExitRegistered</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN556"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN556"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN556"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN569"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN556"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN570"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore not-yet-valid GIDs */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN554"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Found it, but has someone else got it locked? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN171"><span class='Ref_to_Member'>locking_backend</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"prepared transaction with identifier \"%s\" is busy"</span><span class='Delimiter'>, 
</span>                       <a href="twophase.c.html#LN554"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN554"><span class='Ref_to_Parameter'>user</span></a> <span class='Operator'>!= </span><a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN170"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>&& !</span><a href="../../utils/misc/superuser.c.html#LN55"><span class='Ref_to_Func'>superuser_arg</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN554"><span class='Ref_to_Parameter'>user</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to finish prepared transaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Must be superuser or the user that prepared the transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note: it probably would be possible to allow committing from 
         * another database; but at the moment NOTIFY is known not to work and 
         * there may be some other issues as well.  Hence disallow until 
         * someone gets motivated to make it work. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>!= </span><a href="twophase.c.html#LN570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"prepared transaction belongs to another database"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Connect to the database where the transaction was prepared to finish it."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* OK for me to lock it */ 
</span>        <a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN171"><span class='Ref_to_Member'>locking_backend</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="twophase.c.html#LN569"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;TwoPhaseState-&GT;... &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"prepared transaction with identifier \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                <a href="twophase.c.html#LN554"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NOTREACHED */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockGXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RemoveGXact 
 *      Remove the prepared transaction from the shared memory array. 
 * 
 * NB: caller should have already removed it from ProcArray 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN630"></a><span class='Declare_Function'>RemoveGXact</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN632"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN632"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN632"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN630"><span class='Ref_to_Parameter'>gxact</span></a> <span class='Operator'>== </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN632"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* remove from the active array */ 
</span>            <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN632"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* and put it back in the freelist */ 
</span>            <a href="twophase.c.html#LN630"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN154"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN630"><span class='Ref_to_Parameter'>gxact</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to find %p in GlobalTransaction array"</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN630"><span class='Ref_to_Parameter'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveGXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns an array of all prepared transactions for the user-level 
 * function pg_prepared_xact. 
 * 
 * The returned array and all its elements are copies of internal data 
 * structures, to minimize the time we need to hold the TwoPhaseStateLock. 
 * 
 * WARNING -- we return even those transactions that are not fully prepared 
 * yet.  The caller should filter them out if he doesn't want them. 
 * 
 * The returned array is palloc'd. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN672"></a><span class='Declare_Function'>GetPreparedTransactionList</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>gxacts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN674"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>array</span><span class='Delimiter'>; 
</span><a name="LN675"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num</span><span class='Delimiter'>; 
</span><a name="LN676"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>*</span><a href="twophase.c.html#LN672"><span class='Ref_to_Parameter'>gxacts</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="twophase.c.html#LN675"><span class='Ref_To_Local'>num</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN674"><span class='Ref_To_Local'>array</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN152"><span class='Ref_to_Struct'>GlobalTransactionData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="twophase.c.html#LN675"><span class='Ref_To_Local'>num</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="twophase.c.html#LN672"><span class='Ref_to_Parameter'>gxacts</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN674"><span class='Ref_To_Local'>array</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN676"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN676"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN675"><span class='Ref_To_Local'>num</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><a href="twophase.c.html#LN674"><span class='Ref_To_Local'>array</span></a> <span class='Operator'>+ </span><a href="twophase.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN676"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN152"><span class='Ref_to_Struct'>GlobalTransactionData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN675"><span class='Ref_To_Local'>num</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetPreparedTransactionList &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* Working status for pg_prepared_xact */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN704"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Member'>array</span><span class='Delimiter'>; 
</span><a name="LN705"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>ngxacts</span><span class='Delimiter'>; 
</span><a name="LN706"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>currIdx</span><span class='Delimiter'>; 
</span><a name="LN707"></a>} <span class='Declare_Typedef'>Working_State</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pg_prepared_xact 
 *      Produce a view with one row per prepared transaction. 
 * 
 * This function is here so we don't have to export the 
 * GlobalTransactionData struct definition. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN717"></a><span class='Declare_Function'>pg_prepared_xact</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN719"></a>    <a href="../../../include/funcapi.h.html#LN56"><span class='Ref_to_Struct'>FuncCallContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcctx</span><span class='Delimiter'>; 
</span><a name="LN720"></a>    <a href="twophase.c.html#LN702"><span class='Ref_to_Typedef'>Working_State</span></a> <span class='Operator'>*</span><span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/funcapi.h.html#LN284"><span class='Ref_to_Macro'>SRF_IS_FIRSTCALL</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN724"></a>        <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN725"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* create a function context for cross-call persistence */ 
</span>        <a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN286"><span class='Ref_to_Macro'>SRF_FIRSTCALL_INIT</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Switch to memory context appropriate for multiple function calls 
         */ 
</span>        <a href="twophase.c.html#LN725"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN108"><span class='Ref_to_Member'>multi_call_memory_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* build tupdesc for result tuples */ 
</span>        <span class='Comment_Multi_Line'>/* this had better match pg_prepared_xacts view in system_views.sql */ 
</span>        <a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"transaction"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN29"><span class='Ref_to_Const'>XIDOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='String'>"gid"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='String'>"prepared"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN53"><span class='Ref_to_Const'>TIMESTAMPTZOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='String'>"ownerid"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='String'>"dbid"</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN119"><span class='Ref_to_Member'>tuple_desc</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN229"><span class='Ref_to_Proto'>BlessTupleDesc</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN724"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Collect all the 2PC status information that we will format and send 
         * out as a result set. 
         */ 
</span>        <a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN702"><span class='Ref_to_Typedef'>Working_State</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN702"><span class='Ref_to_Typedef'>Working_State</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN705"><span class='Ref_to_Member'>ngxacts</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN671"><span class='Ref_to_Func'>GetPreparedTransactionList</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN704"><span class='Ref_to_Member'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN706"><span class='Ref_to_Member'>currIdx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN725"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SRF_IS_FIRSTCALL() &raquo; </span> 
 
    <a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN288"><span class='Ref_to_Macro'>SRF_PERCALL_SETUP</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN702"><span class='Ref_to_Typedef'>Working_State</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN89"><span class='Ref_to_Member'>user_fctx</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN704"><span class='Ref_to_Member'>array</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN706"><span class='Ref_to_Member'>currIdx</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN705"><span class='Ref_to_Member'>ngxacts</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN769"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= &</span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN704"><span class='Ref_to_Member'>array</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN720"><span class='Ref_To_Local'>status</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN706"><span class='Ref_to_Member'>currIdx</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span><a name="LN770"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN769"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span><a name="LN771"></a>        <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN769"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span><a name="LN772"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>]; 
</span><a name="LN773"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>]; 
</span><a name="LN774"></a>        <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN775"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN769"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form tuple with appropriate data. 
         */ 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN773"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN773"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN526"><span class='Ref_to_Macro'>TransactionIdGetDatum</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN771"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN208"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN769"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN31"><span class='Ref_to_Macro'>TimestampTzGetDatum</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN769"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN157"><span class='Ref_to_Member'>prepared_at</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN769"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN170"><span class='Ref_to_Member'>owner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN770"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN774"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Operator'>-&GT;</span><a href="../../../include/funcapi.h.html#LN119"><span class='Ref_to_Member'>tuple_desc</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN772"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN773"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN775"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN221"><span class='Ref_to_Macro'>HeapTupleGetDatum</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN774"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/funcapi.h.html#LN290"><span class='Ref_to_Macro'>SRF_RETURN_NEXT</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN775"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while status-&GT;array!=NULL&&... &raquo; </span> 
 
    <a href="../../../include/funcapi.h.html#LN308"><span class='Ref_to_Macro'>SRF_RETURN_DONE</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN719"><span class='Ref_To_Local'>funcctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_prepared_xact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * TwoPhaseGetGXact 
 *      Get the GlobalTransaction struct for a prepared transaction 
 *      specified by XID 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> 
<a name="LN806"></a><span class='Declare_Function'>TwoPhaseGetGXact</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN808"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN809"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
<a name="LN811"></a>    <span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>cached_xid</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN812"></a>    <span class='Keyword'>static </span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>cached_gxact</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * During a recovery, COMMIT PREPARED, or ABORT PREPARED, we'll be called 
     * repeatedly for the same XID.  We can save work with a simple cache. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN806"><span class='Ref_to_Parameter'>xid</span></a> <span class='Operator'>== </span><a href="twophase.c.html#LN811"><span class='Ref_To_Local'>cached_xid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="twophase.c.html#LN812"><span class='Ref_To_Local'>cached_gxact</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN809"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN809"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN809"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN825"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN809"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN826"></a>        <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN825"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN826"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN208"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>== </span><a href="twophase.c.html#LN806"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="twophase.c.html#LN808"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN825"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN808"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>         <span class='Comment_Single_Line'>/* should not happen */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to find GlobalTransaction for xid %u"</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN806"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN811"><span class='Ref_To_Local'>cached_xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN806"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN812"><span class='Ref_To_Local'>cached_gxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN808"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN808"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TwoPhaseGetGXact &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * TwoPhaseGetDummyProc 
 *      Get the dummy backend ID for prepared transaction specified by XID 
 * 
 * Dummy backend IDs are similar to real backend IDs of real backends. 
 * They start at MaxBackends + 1, and are unique across all currently active 
 * real backends and prepared transactions. 
 */ 
</span><a href="../../../include/storage/backendid.h.html#LN20"><span class='Ref_to_Typedef'>BackendId</span></a> 
<a name="LN855"></a><span class='Declare_Function'>TwoPhaseGetDummyBackendId</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN857"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN805"><span class='Ref_to_Func'>TwoPhaseGetGXact</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN855"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN857"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN156"><span class='Ref_to_Member'>dummyBackendId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * TwoPhaseGetDummyProc 
 *      Get the PGPROC that represents a prepared transaction specified by XID 
 */ 
</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>* 
</span><a name="LN867"></a><span class='Declare_Function'>TwoPhaseGetDummyProc</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN869"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN805"><span class='Ref_to_Func'>TwoPhaseGetGXact</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN867"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN869"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/************************************************************************/ 
/* State file support                                                   */ 
/************************************************************************/ 
</span> 
<a name="LN878"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TwoPhaseFilePath</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>xid</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN878"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN113"><span class='Ref_to_Const'>TWOPHASE_DIR</span></a> <span class='String'>"/%08X"</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN878"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * 2PC state file format: 
 * 
 *  1. TwoPhaseFileHeader 
 *  2. TransactionId[] (subtransactions) 
 *  3. RelFileNode[] (files to be deleted at commit) 
 *  4. RelFileNode[] (files to be deleted at abort) 
 *  5. SharedInvalidationMessage[] (inval messages to be sent at commit) 
 *  6. TwoPhaseRecordOnDisk 
 *  7. ... 
 *  8. TwoPhaseRecordOnDisk (end sentinel, rmid == TWOPHASE_RM_END_ID) 
 *  9. checksum (CRC-32C) 
 * 
 * Each segment except the final checksum is MAXALIGN'd. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Header for a 2PC state file 
 */ 
</span><a name="LN900"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TWOPHASE_MAGIC</span>  <span class='Number'>0x57F94533</span>      <span class='Comment_Single_Line'>/* format identifier */ 
</span> 
<a name="LN902"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TwoPhaseFileHeader</span> 
<span class='Delimiter'>{ 
</span><a name="LN904"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>magic</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* format identifier */ 
</span><a name="LN905"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>total_len</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* actual file length */ 
</span><a name="LN906"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xid</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* original transaction XID */ 
</span><a name="LN907"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>database</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* OID of database it was in */ 
</span><a name="LN908"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>prepared_at</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* time of preparation */ 
</span><a name="LN909"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>owner</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* user running the transaction */ 
</span><a name="LN910"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>nsubxacts</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* number of following subxact XIDs */ 
</span><a name="LN911"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>ncommitrels</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* number of delete-on-commit rels */ 
</span><a name="LN912"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>nabortrels</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* number of delete-on-abort rels */ 
</span><a name="LN913"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>ninvalmsgs</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* number of cache invalidation messages */ 
</span><a name="LN914"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>initfileinval</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* does relcache init file need invalidation? */ 
</span><a name="LN915"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>gidlen</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* length of the GID - GID follows the header */ 
</span><a name="LN916"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TwoPhaseFileHeader</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Header for each record in a state file 
 * 
 * NOTE: len counts only the rmgr data, not the TwoPhaseRecordOnDisk header. 
 * The rmgr data will be stored starting on a MAXALIGN boundary. 
 */ 
</span><a name="LN924"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TwoPhaseRecordOnDisk</span> 
<span class='Delimiter'>{ 
</span><a name="LN926"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>len</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* length of rmgr data */ 
</span><a name="LN927"></a>    <a href="../../../include/access/twophase_rmgr.h.html#LN18"><span class='Ref_to_Typedef'>TwoPhaseRmgrId</span></a> <span class='Declare_Member'>rmid</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* resource manager for this record */ 
</span><a name="LN928"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>info</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* flag bits for use by rmgr */ 
</span><a name="LN929"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TwoPhaseRecordOnDisk</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * During prepare, the state file is assembled in memory before writing it 
 * to WAL and the actual state file.  We use a chain of StateFileChunk blocks 
 * for that. 
 */ 
</span><a name="LN936"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>StateFileChunk</span> 
<span class='Delimiter'>{ 
</span><a name="LN938"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>data</span><span class='Delimiter'>; 
</span><a name="LN939"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>len</span><span class='Delimiter'>; 
</span><a name="LN940"></a>    <span class='Control'>struct</span> <a href="twophase.c.html#LN936"><span class='Ref_to_Struct'>StateFileChunk</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span><a name="LN941"></a>} <span class='Declare_Typedef'>StateFileChunk</span><span class='Delimiter'>; 
</span> 
<a name="LN943"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <span class='Declare_Struct'>xllist</span> 
<span class='Delimiter'>{ 
</span><a name="LN945"></a>    <a href="twophase.c.html#LN936"><span class='Ref_to_Struct'>StateFileChunk</span></a> <span class='Operator'>*</span><span class='Declare_Member'>head</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* first data block in the chain */ 
</span><a name="LN946"></a>    <a href="twophase.c.html#LN936"><span class='Ref_to_Struct'>StateFileChunk</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tail</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* last block in chain */ 
</span><a name="LN947"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>num_chunks</span><span class='Delimiter'>; 
</span><a name="LN948"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>bytes_free</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* free bytes left in tail block */ 
</span><a name="LN949"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>total_len</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* total data bytes in chain */ 
</span><a name="LN950"></a><span class='Delimiter'>}</span>   <span class='Declare_Var'>records</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Append a block of data to records data structure. 
 * 
 * NB: each block is padded to a MAXALIGN multiple.  This must be 
 * accounted for when the file is later read! 
 * 
 * The data is copied, so the caller is free to modify it afterwards. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN962"></a><span class='Declare_Function'>save_state_data</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN964"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>padlen</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN962"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN964"><span class='Ref_To_Local'>padlen</span></a> <span class='Operator'>&GT; </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN948"><span class='Ref_to_Member'>bytes_free</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN940"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN936"><span class='Ref_to_Struct'>StateFileChunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN940"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN939"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN940"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN947"><span class='Ref_to_Member'>num_chunks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN948"><span class='Ref_to_Member'>bytes_free</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN964"><span class='Ref_To_Local'>padlen</span></a><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN938"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN948"><span class='Ref_to_Member'>bytes_free</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    memcpy<span class='Parentheses'>(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN938"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN939"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN962"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN962"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN939"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>+= </span><a href="twophase.c.html#LN964"><span class='Ref_To_Local'>padlen</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN948"><span class='Ref_to_Member'>bytes_free</span></a> <span class='Operator'>-= </span><a href="twophase.c.html#LN964"><span class='Ref_To_Local'>padlen</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN949"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>+= </span><a href="twophase.c.html#LN964"><span class='Ref_To_Local'>padlen</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end save_state_data &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Start preparing a state file. 
 * 
 * Initializes data structure and inserts the 2PC file header record. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN990"></a><span class='Declare_Function'>StartPrepare</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN992"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span><a name="LN993"></a>    <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span><a name="LN994"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="twophase.c.html#LN993"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN208"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span><a name="LN995"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN996"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>children</span><span class='Delimiter'>; 
</span><a name="LN997"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>commitrels</span><span class='Delimiter'>; 
</span><a name="LN998"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>abortrels</span><span class='Delimiter'>; 
</span><a name="LN999"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Local'>invalmsgs</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize linked list */ 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN936"><span class='Ref_to_Struct'>StateFileChunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN939"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN940"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN948"><span class='Ref_to_Member'>bytes_free</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN938"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN948"><span class='Ref_to_Member'>bytes_free</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN947"><span class='Ref_to_Member'>num_chunks</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN949"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create header */ 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN904"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN900"><span class='Ref_to_Const'>TWOPHASE_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN905"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* EndPrepare will fill this in */ 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN906"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN994"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN907"><span class='Ref_to_Member'>database</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN992"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN908"><span class='Ref_to_Member'>prepared_at</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN157"><span class='Ref_to_Member'>prepared_at</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN909"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN170"><span class='Ref_to_Member'>owner</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN379"><span class='Ref_to_Proto'>xactGetCommittedChildren</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="twophase.c.html#LN996"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/storage.h.html#LN30"><span class='Ref_to_Proto'>smgrGetPendingDeletes</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN997"><span class='Ref_To_Local'>commitrels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/storage.h.html#LN30"><span class='Ref_to_Proto'>smgrGetPendingDeletes</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN998"><span class='Ref_To_Local'>abortrels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN145"><span class='Ref_to_Proto'>xactGetCommittedInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="twophase.c.html#LN999"><span class='Ref_To_Local'>invalmsgs</span></a><span class='Delimiter'>, 
</span>                                                          <span class='Operator'>&</span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN914"><span class='Ref_to_Member'>initfileinval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN915"><span class='Ref_to_Member'>gidlen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Include '\0' */ 
</span> 
    <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN915"><span class='Ref_to_Member'>gidlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add the additional info about subxacts, deletable files and cache 
     * invalidation messages. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN996"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* While we have the child-xact data, stuff it in the gxact too */ 
</span>        <a href="twophase.c.html#LN508"><span class='Ref_to_Func'>GXactLoadSubxactData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN990"><span class='Ref_to_Parameter'>gxact</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN996"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN997"><span class='Ref_To_Local'>commitrels</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN997"><span class='Ref_To_Local'>commitrels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN998"><span class='Ref_To_Local'>abortrels</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN998"><span class='Ref_To_Local'>abortrels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN999"><span class='Ref_To_Local'>invalmsgs</span></a><span class='Delimiter'>, 
</span>                        <a href="twophase.c.html#LN995"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN999"><span class='Ref_To_Local'>invalmsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end StartPrepare &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Finish preparing state data and writing it to WAL. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1063"></a><span class='Declare_Function'>EndPrepare</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Parameter'>gxact</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1065"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN1066"></a>    <a href="twophase.c.html#LN936"><span class='Ref_to_Struct'>StateFileChunk</span></a> <span class='Operator'>*</span><span class='Declare_Local'>record</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add the end sentinel to the list of 2PC records */ 
</span>    <a href="../../../include/access/twophase_rmgr.h.html#LN36"><span class='Ref_to_Proto'>RegisterTwoPhaseRecord</span></a><span class='Parentheses'>(</span><a href="../../../include/access/twophase_rmgr.h.html#LN23"><span class='Ref_to_Const'>TWOPHASE_RM_END_ID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                           <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Go back and fill in total_len in the file header record */ 
</span>    <a href="twophase.c.html#LN1065"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN938"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN1065"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN904"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="twophase.c.html#LN900"><span class='Ref_to_Const'>TWOPHASE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1065"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN905"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN949"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the data size exceeds MaxAllocSize, we won't be able to read it in 
     * ReadTwoPhaseFile. Check for that now, rather than fail in the case 
     * where we write data to file and then re-read at commit time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1065"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN905"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>&GT; </span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"two-phase state file maximum length exceeded"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now writing 2PC state data to WAL. We let the WAL's CRC protection 
     * cover us, so no need to calculate a separate CRC. 
     * 
     * We have to set delayChkpt here, too; otherwise a checkpoint starting 
     * immediately after the WAL record is inserted could complete without 
     * fsync'ing our state file.  (This is essentially the same kind of race 
     * condition as the COMMIT-to-clog-write case that RecordTransactionCommit 
     * uses delayChkpt for; see notes there.) 
     * 
     * We save the PREPARE record's location in the gxact for later use by 
     * CheckPointTwoPhase. 
     */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN44"><span class='Ref_to_Proto'>XLogEnsureRecordSpace</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN947"><span class='Ref_to_Member'>num_chunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1066"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN1066"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN1066"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1066"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN940"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1066"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN938"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1066"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN939"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1063"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN167"><span class='Ref_to_Member'>prepare_end_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_XACT_ID<span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN134"><span class='Ref_to_Const'>XLOG_XACT_PREPARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1063"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN167"><span class='Ref_to_Member'>prepare_end_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we crash now, we have prepared: WAL replay will fix things */ 
</span> 
    <span class='Comment_Multi_Line'>/* Store record's start location to read that later on Commit */ 
</span>    <a href="twophase.c.html#LN1063"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a> <span class='Operator'>= </span><a href="xlog.c.html#LN335"><span class='Ref_to_Global_Var'>ProcLastRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the prepared transaction as valid.  As soon as xact.c marks 
     * MyPgXact as not running our XID (which it will do immediately after 
     * this function returns), others can commit/rollback the xact. 
     * 
     * NB: a side effect of this is to make a dummy ProcArray entry for the 
     * prepared XID.  This must happen before we clear the XID from MyPgXact, 
     * else there is a window where the XID is not running according to 
     * TransactionIdIsInProgress, and onlookers would be entitled to assume 
     * the xact crashed.  Instead we have a window where the same XID appears 
     * twice in ProcArray, which is OK. 
     */ 
</span>    <a href="twophase.c.html#LN533"><span class='Ref_to_Func'>MarkAsPrepared</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1063"><span class='Ref_to_Parameter'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we can mark ourselves as out of the commit critical section: a 
     * checkpoint starting after this will certainly see the gxact as a 
     * candidate for fsyncing. 
     */ 
</span>    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remember that we have this GlobalTransaction entry locked for us.  If 
     * we crash after this point, it's too late to abort, but we must unlock 
     * it so that the prepared transaction can be committed or rolled back. 
     */ 
</span>    <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1063"><span class='Ref_to_Parameter'>gxact</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Wait for synchronous replication, if required. 
     * 
     * Note that at this stage we have marked the prepare, but still show as 
     * running in the procarray (twice!) and continue to hold locks. 
     */ 
</span>    <a href="../../../include/replication/syncrep.h.html#LN66"><span class='Ref_to_Proto'>SyncRepWaitForLSN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1063"><span class='Ref_to_Parameter'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN167"><span class='Ref_to_Member'>prepare_end_lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN946"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN945"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN950"><span class='Ref_to_Global_Var'>records</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN947"><span class='Ref_to_Member'>num_chunks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end EndPrepare &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Register a 2PC record to be written to state file. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1163"></a><span class='Declare_Function'>RegisterTwoPhaseRecord</span><span class='Parentheses'>(</span><a href="../../../include/access/twophase_rmgr.h.html#LN18"><span class='Ref_to_Typedef'>TwoPhaseRmgrId</span></a> <span class='Declare_Parameter'>rmid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN1164"></a>                       <span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1166"></a>    <a href="twophase.c.html#LN924"><span class='Ref_to_Struct'>TwoPhaseRecordOnDisk</span></a> <span class='Declare_Local'>record</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1166"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN927"><span class='Ref_to_Member'>rmid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1163"><span class='Ref_to_Parameter'>rmid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1166"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN928"><span class='Ref_to_Member'>info</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1163"><span class='Ref_to_Parameter'>info</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1166"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="twophase.c.html#LN926"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1164"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="twophase.c.html#LN1166"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN924"><span class='Ref_to_Struct'>TwoPhaseRecordOnDisk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1164"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="twophase.c.html#LN961"><span class='Ref_to_Func'>save_state_data</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1164"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1164"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read and validate the state file for xid. 
 * 
 * If it looks OK (has a valid magic number and CRC), return the palloc'd 
 * contents of the file.  Otherwise return NULL. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1184"></a><span class='Declare_Function'>ReadTwoPhaseFile</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>give_warnings</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1186"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1187"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1188"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN1189"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1190"></a>    <span class='Control'>struct</span> <a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a> <span class='Declare_Local'>stat</span><span class='Delimiter'>; 
</span><a name="LN1191"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>crc_offset</span><span class='Delimiter'>; 
</span><a name="LN1192"></a>    <a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Local'>calc_crc</span><span class='Delimiter'>, 
</span><a name="LN1193"></a>                <span class='Declare_Local'>file_crc</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN878"><span class='Ref_to_Macro'>TwoPhaseFilePath</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1186"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1184"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1186"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1184"><span class='Ref_to_Parameter'>give_warnings</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open two-phase state file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN1186"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check file length.  We can determine a lower bound pretty easily. We 
     * set an upper bound to avoid palloc() failure on a corrupt file, though 
     * we can't guarantee that we won't get an out of memory error anyway, 
     * even on a valid file. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fstat<span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1184"><span class='Ref_to_Parameter'>give_warnings</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat two-phase state file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN1186"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>                        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN924"><span class='Ref_to_Struct'>TwoPhaseRecordOnDisk</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>                        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>        <a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size <span class='Operator'>&GT; </span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="twophase.c.html#LN1191"><span class='Ref_To_Local'>crc_offset</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1191"><span class='Ref_To_Local'>crc_offset</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1191"><span class='Ref_To_Local'>crc_offset</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * OK, slurp in the file. 
     */ 
</span>    <a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN891"><span class='Ref_to_EnumConst'>WAIT_EVENT_TWOPHASE_FILE_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1184"><span class='Ref_to_Parameter'>give_warnings</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read two-phase state file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN1186"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1189"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1188"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1188"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN904"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>!= </span><a href="twophase.c.html#LN900"><span class='Ref_to_Const'>TWOPHASE_MAGIC</span></a> <span class='Operator'>|| </span><a href="twophase.c.html#LN1188"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN905"><span class='Ref_to_Member'>total_len</span></a> <span class='Operator'>!= </span><a href="twophase.c.html#LN1190"><span class='Ref_To_Local'>stat</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1192"><span class='Ref_To_Local'>calc_crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1192"><span class='Ref_To_Local'>calc_crc</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1191"><span class='Ref_To_Local'>crc_offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1192"><span class='Ref_To_Local'>calc_crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1193"><span class='Ref_To_Local'>file_crc</span></a> <span class='Operator'>= *</span><span class='Parentheses'>((</span><a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><a href="twophase.c.html#LN1191"><span class='Ref_To_Local'>crc_offset</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port/pg_crc32c.h.html#LN41"><span class='Ref_to_Macro'>EQ_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1192"><span class='Ref_To_Local'>calc_crc</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1193"><span class='Ref_To_Local'>file_crc</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN1187"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReadTwoPhaseFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Reads 2PC data from xlog. During checkpoint this data will be moved to 
 * twophase files and ReadTwoPhaseFile should be used instead. 
 * 
 * Note clearly that this function can access WAL during normal operation, 
 * similarly to the way WALSender or Logical Decoding would do. 
 * 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1295"></a><span class='Declare_Function'>XlogReadTwoPhaseData</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1297"></a>    <a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>record</span><span class='Delimiter'>; 
</span><a name="LN1298"></a>    <a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlogreader</span><span class='Delimiter'>; 
</span><a name="LN1299"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>errormsg</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN65"><span class='Ref_to_Func'>XLogReaderAllocate</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../../../include/access/xlogutils.h.html#LN49"><span class='Ref_to_Proto'>read_local_xlog_page</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed while allocating a WAL reading processor."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1297"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN191"><span class='Ref_to_Func'>XLogReadRecord</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN1299"><span class='Ref_To_Local'>errormsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1297"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read two-phase state from WAL at %X/%X"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN216"><span class='Ref_to_Macro'>XLogRecGetRmid</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span>RM_XACT_ID <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN143"><span class='Ref_to_Const'>XLOG_XACT_OPMASK</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="../../../include/access/xact.h.html#LN134"><span class='Ref_to_Const'>XLOG_XACT_PREPARE</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"expected two-phase state data is not present in WAL at %X/%X"</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN220"><span class='Ref_to_Macro'>XLogRecGetDataLen</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/access/xlogreader.h.html#LN220"><span class='Ref_to_Macro'>XLogRecGetDataLen</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="twophase.c.html#LN1295"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/access/xlogreader.h.html#LN220"><span class='Ref_to_Macro'>XLogRecGetDataLen</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN123"><span class='Ref_to_Func'>XLogReaderFree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1298"><span class='Ref_To_Local'>xlogreader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XlogReadTwoPhaseData &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Confirms an xid is prepared, during recovery 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1338"></a><span class='Declare_Function'>StandbyTransactionIdIsPrepared</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1340"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1341"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN1342"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1338"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    <span class='Comment_Multi_Line'>/* Read and validate file */ 
</span>    <a href="twophase.c.html#LN1340"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1183"><span class='Ref_to_Func'>ReadTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1338"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1340"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check header also */ 
</span>    <a href="twophase.c.html#LN1341"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1340"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1342"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1341"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN906"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1338"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1340"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN1342"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StandbyTransactionIdIsPrepared &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FinishPreparedTransaction: execute COMMIT PREPARED or ROLLBACK PREPARED 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1366"></a><span class='Declare_Function'>FinishPreparedTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1368"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span><span class='Delimiter'>; 
</span><a name="LN1369"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN1370"></a>    <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span><span class='Delimiter'>; 
</span><a name="LN1371"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN1372"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1373"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bufptr</span><span class='Delimiter'>; 
</span><a name="LN1374"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN1375"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latestXid</span><span class='Delimiter'>; 
</span><a name="LN1376"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>children</span><span class='Delimiter'>; 
</span><a name="LN1377"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>commitrels</span><span class='Delimiter'>; 
</span><a name="LN1378"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>abortrels</span><span class='Delimiter'>; 
</span><a name="LN1379"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>delrels</span><span class='Delimiter'>; 
</span><a name="LN1380"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndelrels</span><span class='Delimiter'>; 
</span><a name="LN1381"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Local'>invalmsgs</span><span class='Delimiter'>; 
</span><a name="LN1382"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Validate the GID, and lock the GXACT to ensure that two backends do not 
     * try to commit the same GID at once. 
     */ 
</span>    <a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN553"><span class='Ref_to_Func'>LockGXact</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1366"><span class='Ref_to_Parameter'>gid</span></a><span class='Delimiter'>, </span><a href="../../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1369"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span>    <a href="twophase.c.html#LN1370"><span class='Ref_To_Local'>pgxact</span></a> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN155"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span>    <a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1370"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN208"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read and validate 2PC state data. State data will typically be stored 
     * in WAL files if the LSN is after the last checkpoint record, or moved 
     * to disk if for some reason they have lived for a long time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a><span class='Parentheses'>) 
</span>        <a href="twophase.c.html#LN1372"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1183"><span class='Ref_to_Func'>ReadTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="twophase.c.html#LN220"><span class='Ref_to_Proto'>XlogReadTwoPhaseData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN1372"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Disassemble the header area 
     */ 
</span>    <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1372"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN906"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1372"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN915"><span class='Ref_to_Member'>gidlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1376"><span class='Ref_To_Local'>children</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1377"><span class='Ref_To_Local'>commitrels</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1378"><span class='Ref_To_Local'>abortrels</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1381"><span class='Ref_To_Local'>invalmsgs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* compute latestXid among all children */ 
</span>    <a href="twophase.c.html#LN1375"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN172"><span class='Ref_to_Proto'>TransactionIdLatest</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1376"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The order of operations here is critical: make the XLOG entry for 
     * commit or abort, then mark the transaction committed or aborted in 
     * pg_xact, then remove its PGPROC from the global ProcArray (which means 
     * TransactionIdIsInProgress will stop saying the prepared xact is in 
     * progress), then run the post-commit or post-abort callbacks. The 
     * callbacks will release the locks the transaction held. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1366"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>        <a href="twophase.c.html#LN203"><span class='Ref_to_Proto'>RecordTransactionCommitPrepared</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, 
</span>                                        <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1376"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, 
</span>                                        <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1377"><span class='Ref_To_Local'>commitrels</span></a><span class='Delimiter'>, 
</span>                                        <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1381"><span class='Ref_To_Local'>invalmsgs</span></a><span class='Delimiter'>, 
</span>                                        <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN914"><span class='Ref_to_Member'>initfileinval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="twophase.c.html#LN211"><span class='Ref_to_Proto'>RecordTransactionAbortPrepared</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, 
</span>                                       <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1376"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, 
</span>                                       <a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1378"><span class='Ref_To_Local'>abortrels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/procarray.h.html#LN61"><span class='Ref_to_Proto'>ProcArrayRemove</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1369"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1375"><span class='Ref_To_Local'>latestXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In case we fail while running the callbacks, mark the gxact invalid so 
     * no one else will try to commit/rollback, and so it will be recycled if 
     * we fail after this point.  It is still locked by our backend so it 
     * won't go away yet. 
     * 
     * (We assume it's safe to do this without taking TwoPhaseStateLock.) 
     */ 
</span>    <a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have to remove any files that were supposed to be dropped. For 
     * consistency with the regular xact.c code paths, must do this before 
     * releasing locks, so do it before running the callbacks. 
     * 
     * NB: this code knows that we couldn't be dropping any temp rels ... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1366"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN1379"><span class='Ref_To_Local'>delrels</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1377"><span class='Ref_To_Local'>commitrels</span></a><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1380"><span class='Ref_To_Local'>ndelrels</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN1379"><span class='Ref_To_Local'>delrels</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1378"><span class='Ref_To_Local'>abortrels</span></a><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1380"><span class='Ref_To_Local'>ndelrels</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1382"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN1382"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN1380"><span class='Ref_To_Local'>ndelrels</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN1382"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1473"></a>        <a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Local'>srel</span> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN83"><span class='Ref_to_Proto'>smgropen</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1379"><span class='Ref_To_Local'>delrels</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1382"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/smgr.h.html#LN91"><span class='Ref_to_Proto'>smgrdounlink</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1473"><span class='Ref_To_Local'>srel</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN87"><span class='Ref_to_Proto'>smgrclose</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1473"><span class='Ref_To_Local'>srel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Handle cache invalidation messages. 
     * 
     * Relcache init file invalidation requires processing both before and 
     * after we send the SI messages. See AtEOXact_Inval() 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN914"><span class='Ref_to_Member'>initfileinval</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relcache.h.html#LN127"><span class='Ref_to_Proto'>RelationCacheInitFilePreInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../storage/ipc/sinval.c.html#LN47"><span class='Ref_to_Func'>SendSharedInvalidMessages</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1381"><span class='Ref_To_Local'>invalmsgs</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1374"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN914"><span class='Ref_to_Member'>initfileinval</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relcache.h.html#LN128"><span class='Ref_to_Proto'>RelationCacheInitFilePostInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And now do the callbacks */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1366"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>        <a href="twophase.c.html#LN216"><span class='Ref_to_Proto'>ProcessRecords</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase_rmgr.c.html#LN32"><span class='Ref_to_Global_Var'>twophase_postcommit_callbacks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="twophase.c.html#LN216"><span class='Ref_to_Proto'>ProcessRecords</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1373"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase_rmgr.c.html#LN41"><span class='Ref_to_Global_Var'>twophase_postabort_callbacks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/predicate.h.html#LN70"><span class='Ref_to_Proto'>PredicateLockTwoPhaseFinish</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1366"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Count the prepared xact as committed or aborted */ 
</span>    <a href="../../../include/pgstat.h.html#LN1298"><span class='Ref_to_Proto'>AtEOXact_PgStat</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1366"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And now we can clean up any files we may have left. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a><span class='Parentheses'>) 
</span>        <a href="twophase.c.html#LN227"><span class='Ref_to_Proto'>RemoveTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1371"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN218"><span class='Ref_to_Proto'>RemoveGXact</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1368"><span class='Ref_To_Local'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN199"><span class='Ref_to_Global_Var'>MyLockedGxact</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1372"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FinishPreparedTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Scan 2PC state data in memory and call the indicated callbacks for each 2PC record. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1518"></a><span class='Declare_Function'>ProcessRecords</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>bufptr</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1519"></a>               <span class='Keyword'>const </span><a href="../../../include/access/twophase_rmgr.h.html#LN16"><span class='Ref_to_Typedef'>TwoPhaseCallback</span></a> <span class='Declare_Parameter'>callbacks</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1523"></a>        <a href="twophase.c.html#LN924"><span class='Ref_to_Struct'>TwoPhaseRecordOnDisk</span></a> <span class='Operator'>*</span><span class='Declare_Local'>record</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN924"><span class='Ref_to_Struct'>TwoPhaseRecordOnDisk</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1518"><span class='Ref_to_Parameter'>bufptr</span></a><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN927"><span class='Ref_to_Member'>rmid</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/twophase_rmgr.h.html#LN28"><span class='Ref_to_Const'>TWOPHASE_RM_MAX_ID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN927"><span class='Ref_to_Member'>rmid</span></a> <span class='Operator'>== </span><a href="../../../include/access/twophase_rmgr.h.html#LN23"><span class='Ref_to_Const'>TWOPHASE_RM_END_ID</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1518"><span class='Ref_to_Parameter'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN924"><span class='Ref_to_Struct'>TwoPhaseRecordOnDisk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1519"><span class='Ref_to_Parameter'>callbacks</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN927"><span class='Ref_to_Member'>rmid</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="twophase.c.html#LN1519"><span class='Ref_to_Parameter'>callbacks</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN927"><span class='Ref_to_Member'>rmid</span></a><span class='Delimiter'>] </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN1518"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN928"><span class='Ref_to_Member'>info</span></a><span class='Delimiter'>, 
</span>                                     <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1518"><span class='Ref_to_Parameter'>bufptr</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN926"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1518"><span class='Ref_to_Parameter'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1523"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN926"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ProcessRecords &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove the 2PC file for the specified XID. 
 * 
 * If giveWarning is false, do not complain about file-not-present; 
 * this is an expected case during WAL replay. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1546"></a><span class='Declare_Function'>RemoveTwoPhaseFile</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>giveWarning</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1548"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="twophase.c.html#LN878"><span class='Ref_to_Macro'>TwoPhaseFilePath</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1548"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1546"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1548"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT <span class='Operator'>|| </span><a href="twophase.c.html#LN1546"><span class='Ref_to_Parameter'>giveWarning</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                   <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove two-phase state file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                          <a href="twophase.c.html#LN1548"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Recreates a state file. This is used in WAL replay and during 
 * checkpoint creation. 
 * 
 * Note: content and len don't include CRC. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1566"></a><span class='Declare_Function'>RecreateTwoPhaseFile</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>content</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1568"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1569"></a>    <a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Local'>statefile_crc</span><span class='Delimiter'>; 
</span><a name="LN1570"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Recompute CRC */ 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1569"><span class='Ref_To_Local'>statefile_crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1569"><span class='Ref_To_Local'>statefile_crc</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1566"><span class='Ref_to_Parameter'>content</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1566"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1569"><span class='Ref_To_Local'>statefile_crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN878"><span class='Ref_to_Macro'>TwoPhaseFilePath</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1568"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1566"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1568"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, 
</span>                           O_CREAT <span class='Operator'>| </span>O_TRUNC <span class='Operator'>| </span>O_WRONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not recreate two-phase state file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="twophase.c.html#LN1568"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Write content and CRC */ 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN893"><span class='Ref_to_EnumConst'>WAIT_EVENT_TWOPHASE_FILE_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1566"><span class='Ref_to_Parameter'>content</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1566"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="twophase.c.html#LN1566"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write two-phase state file: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN1569"><span class='Ref_To_Local'>statefile_crc</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write two-phase state file: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must fsync the file because the end-of-replay checkpoint will not do 
     * so, there being no GXACT in shared memory yet to tell it to. 
     */ 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN892"><span class='Ref_to_EnumConst'>WAIT_EVENT_TWOPHASE_FILE_SYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync two-phase state file: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1570"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not close two-phase state file: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecreateTwoPhaseFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CheckPointTwoPhase -- handle 2PC component of checkpointing. 
 * 
 * We must fsync the state file of any GXACT that is valid or has been 
 * generated during redo and has a PREPARE LSN &LT;= the checkpoint's redo 
 * horizon.  (If the gxact isn't valid yet, has not been generated in 
 * redo, or has a later LSN, this checkpoint is not responsible for 
 * fsyncing it.) 
 * 
 * This is deliberately run as late as possible in the checkpoint sequence, 
 * because GXACTs ordinarily have short lifespans, and so it is quite 
 * possible that GXACTs that were valid at checkpoint start will no longer 
 * exist if we wait a little bit. With typical checkpoint settings this 
 * will be about 3 minutes for an online checkpoint, so as a result we 
 * we expect that there will be no GXACTs that need to be copied to disk. 
 * 
 * If a GXACT remains valid across multiple checkpoints, it will already 
 * be on disk so we don't bother to repeat that write. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1648"></a><span class='Declare_Function'>CheckPointTwoPhase</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>redo_horizon</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1650"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1651"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>serialized_xacts</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    TRACE_POSTGRESQL_TWOPHASE_CHECKPOINT_START<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We are expecting there to be zero GXACTs that need to be copied to 
     * disk, so we perform all I/O while holding TwoPhaseStateLock for 
     * simplicity. This prevents any new xacts from preparing while this 
     * occurs, which shouldn't be a problem since the presence of long-lived 
     * prepared xacts indicates the transaction manager isn't active. 
     * 
     * It's also possible to move I/O out of the lock, but on every error we 
     * should check whether somebody committed our transaction in different 
     * backend. Let's leave this optimization for future, if somebody will 
     * spot that this place cause bottleneck. 
     * 
     * Note that it isn't possible for there to be a GXACT with a 
     * prepare_end_lsn set prior to the last checkpoint yet is marked invalid, 
     * because of the efforts with delayChkpt. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1650"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN1650"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN1650"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Note that we are using gxact not pgxact so this works in recovery 
         * also 
         */ 
</span><a name="LN1681"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1650"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>|| </span><a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a> <span class='Operator'>&& 
</span>            <a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN167"><span class='Ref_to_Member'>prepare_end_lsn</span></a> <span class='Operator'>&LT;= </span><a href="twophase.c.html#LN1648"><span class='Ref_to_Parameter'>redo_horizon</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1687"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1688"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
            <a href="twophase.c.html#LN220"><span class='Ref_to_Proto'>XlogReadTwoPhaseData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN1687"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN1688"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN228"><span class='Ref_to_Proto'>RecreateTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1687"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1688"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN1681"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN167"><span class='Ref_to_Member'>prepare_end_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1687"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN1651"><span class='Ref_To_Local'>serialized_xacts</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;TwoPhaseState-&GT;... &raquo; </span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flush unconditionally the parent directory to make any information 
     * durable on disk.  Two-phase files could have been removed and those 
     * removals need to be made persistent as well as any files newly created 
     * previously since the last checkpoint. 
     */ 
</span>    <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN113"><span class='Ref_to_Const'>TWOPHASE_DIR</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_TWOPHASE_CHECKPOINT_DONE<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlog.c.html#LN101"><span class='Ref_to_Global_Var'>log_checkpoints</span></a> <span class='Operator'>&& </span><a href="twophase.c.html#LN1651"><span class='Ref_To_Local'>serialized_xacts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"%u two-phase state file was written "</span> 
                               <span class='String'>"for a long-running prepared transaction"</span><span class='Delimiter'>, 
</span>                               <span class='String'>"%u two-phase state files were written "</span> 
                               <span class='String'>"for long-running prepared transactions"</span><span class='Delimiter'>, 
</span>                               <a href="twophase.c.html#LN1651"><span class='Ref_To_Local'>serialized_xacts</span></a><span class='Delimiter'>, 
</span>                               <a href="twophase.c.html#LN1651"><span class='Ref_To_Local'>serialized_xacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckPointTwoPhase &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * restoreTwoPhaseData 
 * 
 * Scan pg_twophase and fill TwoPhaseState depending on the on-disk data. 
 * This is called once at the beginning of recovery, saving any extra 
 * lookups in the future.  Two-phase files that are newer than the 
 * minimum XID horizon are discarded on the way. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1730"></a><span class='Declare_Function'>restoreTwoPhaseData</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1732"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>cldir</span><span class='Delimiter'>; 
</span><a name="LN1733"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>clde</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN1732"><span class='Ref_To_Local'>cldir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN113"><span class='Ref_to_Const'>TWOPHASE_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="twophase.c.html#LN1733"><span class='Ref_To_Local'>clde</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1732"><span class='Ref_To_Local'>cldir</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN113"><span class='Ref_to_Const'>TWOPHASE_DIR</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="twophase.c.html#LN1733"><span class='Ref_To_Local'>clde</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>8</span> <span class='Operator'>&& 
</span>            strspn<span class='Parentheses'>(</span><a href="twophase.c.html#LN1733"><span class='Ref_To_Local'>clde</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"0123456789ABCDEF"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>8</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1741"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN1742"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
            <a href="twophase.c.html#LN1741"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span>strtoul<span class='Parentheses'>(</span><a href="twophase.c.html#LN1733"><span class='Ref_To_Local'>clde</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="twophase.c.html#LN1742"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN221"><span class='Ref_to_Proto'>ProcessTwoPhaseBuffer</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1741"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                        <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1742"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/twophase.h.html#LN55"><span class='Ref_to_Proto'>PrepareRedoAdd</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1742"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1732"><span class='Ref_To_Local'>cldir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end restoreTwoPhaseData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PrescanPreparedTransactions 
 * 
 * Scan the shared memory entries of TwoPhaseState and determine the range 
 * of valid XIDs present.  This is run during database startup, after we 
 * have completed reading WAL.  ShmemVariableCache-&GT;nextXid has been set to 
 * one more than the highest XID for which evidence exists in WAL. 
 * 
 * We throw away any prepared xacts with main XID beyond nextXid --- if any 
 * are present, it suggests that the DBA has done a PITR recovery to an 
 * earlier point in time without cleaning out pg_twophase.  We dare not 
 * try to recover such prepared xacts since they likely depend on database 
 * state that doesn't exist now. 
 * 
 * However, we will advance nextXid beyond any subxact XIDs belonging to 
 * valid prepared xacts.  We need to do this since subxact commit doesn't 
 * write a WAL entry, and so there might be no evidence in WAL of those 
 * subxact XIDs. 
 * 
 * Our other responsibility is to determine and return the oldest valid XID 
 * among the prepared xacts (if none, return ShmemVariableCache-&GT;nextXid). 
 * This is needed to synchronize pg_subtrans startup properly. 
 * 
 * If xids_p and nxids_p are not NULL, pointer to a palloc'd array of all 
 * top-level xids is stored in *xids_p. The number of entries in the array 
 * is returned in *nxids_p. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN1785"></a><span class='Declare_Function'>PrescanPreparedTransactions</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>xids_p</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nxids_p</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1787"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>origNextXid</span> <span class='Operator'>= </span><a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Delimiter'>; 
</span><a name="LN1788"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="twophase.c.html#LN1787"><span class='Ref_To_Local'>origNextXid</span></a><span class='Delimiter'>; 
</span><a name="LN1789"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xids</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1790"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nxids</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1791"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>allocsize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1792"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN1792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1797"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN1798"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1799"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN1799"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1797"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1799"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1798"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN221"><span class='Ref_to_Proto'>ProcessTwoPhaseBuffer</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1797"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, 
</span>                                    <a href="twophase.c.html#LN1799"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a><span class='Delimiter'>, 
</span>                                    <a href="twophase.c.html#LN1799"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1798"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * OK, we think this file is valid.  Incorporate xid into the 
         * running-minimum result. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1797"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1788"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span> 
            <a href="twophase.c.html#LN1788"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1797"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1785"><span class='Ref_to_Parameter'>xids_p</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1790"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>== </span><a href="twophase.c.html#LN1791"><span class='Ref_To_Local'>allocsize</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1790"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="twophase.c.html#LN1791"><span class='Ref_To_Local'>allocsize</span></a> <span class='Operator'>= </span><span class='Number'>10</span><span class='Delimiter'>; 
</span>                    <a href="twophase.c.html#LN1789"><span class='Ref_To_Local'>xids</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1791"><span class='Ref_To_Local'>allocsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="twophase.c.html#LN1791"><span class='Ref_To_Local'>allocsize</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1791"><span class='Ref_To_Local'>allocsize</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>                    <a href="twophase.c.html#LN1789"><span class='Ref_To_Local'>xids</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1789"><span class='Ref_To_Local'>xids</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1791"><span class='Ref_To_Local'>allocsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <a href="twophase.c.html#LN1789"><span class='Ref_To_Local'>xids</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1790"><span class='Ref_To_Local'>nxids</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="twophase.c.html#LN1797"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1798"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;TwoPhaseState-&GT;... &raquo; </span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1785"><span class='Ref_to_Parameter'>xids_p</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="twophase.c.html#LN1785"><span class='Ref_to_Parameter'>xids_p</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1789"><span class='Ref_To_Local'>xids</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="twophase.c.html#LN1785"><span class='Ref_to_Parameter'>nxids_p</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1790"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="twophase.c.html#LN1788"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrescanPreparedTransactions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * StandbyRecoverPreparedTransactions 
 * 
 * Scan the shared memory entries of TwoPhaseState and setup all the required 
 * information to allow standby queries to treat prepared transactions as still 
 * active. 
 * 
 * This is never called at the end of recovery - we use 
 * RecoverPreparedTransactions() at that point. 
 * 
 * The lack of calls to SubTransSetParent() calls here is by design; 
 * those calls are made by RecoverPreparedTransactions() at the end of recovery 
 * for those xacts that need this. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1865"></a><span class='Declare_Function'>StandbyRecoverPreparedTransactions</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1867"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1867"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN1867"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN1867"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1872"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN1873"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1874"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1867"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN1874"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1872"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1874"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1873"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN221"><span class='Ref_to_Proto'>ProcessTwoPhaseBuffer</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1872"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, 
</span>                                    <a href="twophase.c.html#LN1874"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a><span class='Delimiter'>, 
</span>                                    <a href="twophase.c.html#LN1874"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1873"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1873"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StandbyRecoverPreparedTransactions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RecoverPreparedTransactions 
 * 
 * Scan the shared memory entries of TwoPhaseState and reload the state for 
 * each prepared transaction (reacquire locks, etc). 
 * 
 * This is run during database startup. 
 * 
 * At the end of recovery the way we take snapshots will change. We now need 
 * to mark all running transactions with their full SubTransSetParent() info 
 * to allow normal snapshots to work correctly if snapshots overflow. 
 * We do this here because by definition prepared transactions are the only 
 * type of write transaction still running, so this is necessary and 
 * complete. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1905"></a><span class='Declare_Function'>RecoverPreparedTransactions</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1907"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't need a lock in the recovery phase. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1907"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN1907"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN1907"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1914"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN1915"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1916"></a>        <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN1907"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1917"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bufptr</span><span class='Delimiter'>; 
</span><a name="LN1918"></a>        <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN1919"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subxids</span><span class='Delimiter'>; 
</span><a name="LN1920"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>gid</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Reconstruct subtrans state for the transaction --- needed because 
         * pg_subtrans is not preserved over a restart.  Note that we are 
         * linking all the subtransactions directly to the top-level XID; 
         * there may originally have been a more complex hierarchy, but 
         * there's no need to restore that exactly. It's possible that 
         * SubTransSetParent has been set before, if the prepared transaction 
         * generated xid assignment records. 
         */ 
</span>        <a href="twophase.c.html#LN1915"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN221"><span class='Ref_to_Proto'>ProcessTwoPhaseBuffer</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, 
</span>                                    <a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a><span class='Delimiter'>, 
</span>                                    <a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN1915"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"recovering prepared transaction %u from shared memory"</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1915"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN906"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1915"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1920"><span class='Ref_To_Local'>gid</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN915"><span class='Ref_to_Member'>gidlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1919"><span class='Ref_To_Local'>subxids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN911"><span class='Ref_to_Member'>ncommitrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN912"><span class='Ref_to_Member'>nabortrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN913"><span class='Ref_to_Member'>ninvalmsgs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Recreate its GXACT and dummy PGPROC. But, check whether it was 
         * added in redo and already has a shmem entry for it. 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN224"><span class='Ref_to_Proto'>MarkAsPreparingGuts</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1920"><span class='Ref_To_Local'>gid</span></a><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN908"><span class='Ref_to_Member'>prepared_at</span></a><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN909"><span class='Ref_to_Member'>owner</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN907"><span class='Ref_to_Member'>database</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* recovered, so reset the flag for entries generated by redo */ 
</span>        <a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="twophase.c.html#LN508"><span class='Ref_to_Func'>GXactLoadSubxactData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1919"><span class='Ref_To_Local'>subxids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="twophase.c.html#LN533"><span class='Ref_to_Func'>MarkAsPrepared</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1916"><span class='Ref_To_Local'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Recover other state (notably locks) using resource managers 
         */ 
</span>        <a href="twophase.c.html#LN216"><span class='Ref_to_Proto'>ProcessRecords</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1917"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase_rmgr.c.html#LN23"><span class='Ref_to_Global_Var'>twophase_recover_callbacks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Release locks held by the standby process after we process each 
         * prepared transaction. As a result, we don't need too many 
         * additional locks at any one time. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/standby.h.html#LN49"><span class='Ref_to_Proto'>StandbyReleaseLockTree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1914"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1918"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN1919"><span class='Ref_To_Local'>subxids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We're done with recovering this transaction. Clear MyLockedGxact, 
         * like we do in PrepareTransaction() during normal operation. 
         */ 
</span>        <a href="../../../include/access/twophase.h.html#LN33"><span class='Ref_to_Proto'>PostPrepare_Twophase</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN1915"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;TwoPhaseState-&GT;... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end RecoverPreparedTransactions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ProcessTwoPhaseBuffer 
 * 
 * Given a transaction id, read it either from disk or read it directly 
 * via shmem xlog record pointer using the provided "prepare_start_lsn". 
 * 
 * If setParent is true, set up subtransaction parent linkages. 
 * 
 * If setNextXid is true, set ShmemVariableCache-&GT;nextXid to the newest 
 * value scanned. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN2005"></a><span class='Declare_Function'>ProcessTwoPhaseBuffer</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN2006"></a>                      <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>prepare_start_lsn</span><span class='Delimiter'>, 
</span><a name="LN2007"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>fromdisk</span><span class='Delimiter'>, 
</span><a name="LN2008"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>setParent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>setNextXid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2010"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>origNextXid</span> <span class='Operator'>= </span><a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Delimiter'>; 
</span><a name="LN2011"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subxids</span><span class='Delimiter'>; 
</span><a name="LN2012"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN2013"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN2014"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN2007"><span class='Ref_to_Parameter'>fromdisk</span></a><span class='Parentheses'>) 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN2006"><span class='Ref_to_Parameter'>prepare_start_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Already processed? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/access/transam.h.html#LN162"><span class='Ref_to_Proto'>TransactionIdDidAbort</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2007"><span class='Ref_to_Parameter'>fromdisk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing stale two-phase state file for \"%u\""</span><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN227"><span class='Ref_to_Proto'>RemoveTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing stale two-phase state from"</span> 
                            <span class='String'>" shared memory for \"%u\""</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/twophase.h.html#LN57"><span class='Ref_to_Proto'>PrepareRedoRemove</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Reject XID if too new */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2010"><span class='Ref_To_Local'>origNextXid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2007"><span class='Ref_to_Parameter'>fromdisk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing future two-phase state file for \"%u\""</span><span class='Delimiter'>, 
</span>                            <a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN227"><span class='Ref_to_Proto'>RemoveTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing future two-phase state from memory for \"%u\""</span><span class='Delimiter'>, 
</span>                    <a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/twophase.h.html#LN57"><span class='Ref_to_Proto'>PrepareRedoRemove</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2007"><span class='Ref_to_Parameter'>fromdisk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Read and validate file */ 
</span>        <a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN1183"><span class='Ref_to_Func'>ReadTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing corrupt two-phase state file for \"%u\""</span><span class='Delimiter'>, 
</span>                          <a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN227"><span class='Ref_to_Proto'>RemoveTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Read xlog data */ 
</span>        <a href="twophase.c.html#LN220"><span class='Ref_to_Proto'>XlogReadTwoPhaseData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2006"><span class='Ref_to_Parameter'>prepare_start_lsn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Deconstruct header */ 
</span>    <a href="twophase.c.html#LN2013"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2013"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN906"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2007"><span class='Ref_to_Parameter'>fromdisk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing corrupt two-phase state file for \"%u\""</span><span class='Delimiter'>, 
</span>                          <a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN227"><span class='Ref_to_Proto'>RemoveTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"removing corrupt two-phase state from memory for \"%u\""</span><span class='Delimiter'>, 
</span>                    <a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/twophase.h.html#LN57"><span class='Ref_to_Proto'>PrepareRedoRemove</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Examine subtransaction XIDs ... they should all follow main XID, and 
     * they may force us to advance nextXid. 
     */ 
</span>    <a href="twophase.c.html#LN2011"><span class='Ref_To_Local'>subxids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ 
</span>                                 <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>                                 <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2013"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN915"><span class='Ref_to_Member'>gidlen</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2014"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN2014"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN2013"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN910"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN2014"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2109"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>subxid</span> <span class='Operator'>= </span><a href="twophase.c.html#LN2011"><span class='Ref_To_Local'>subxids</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN2014"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2109"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* update nextXid if needed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2008"><span class='Ref_to_Parameter'>setNextXid</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2109"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>, 
</span>                                         <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We don't expect anyone else to modify nextXid, hence we don't 
             * need to hold a lock while examining it.  We still acquire the 
             * lock to modify it, though, so we recheck. 
             */ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2109"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>, 
</span>                                             <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2109"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>; 
</span>                <a href="../../../include/access/transam.h.html#LN47"><span class='Ref_to_Macro'>TransactionIdAdvance</span></a><span class='Parentheses'>(</span><a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2008"><span class='Ref_to_Parameter'>setParent</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/subtrans.h.html#LN16"><span class='Ref_to_Proto'>SubTransSetParent</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2109"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2005"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;hdr-&GT;nsubxacts;... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="twophase.c.html#LN2012"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ProcessTwoPhaseBuffer &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  RecordTransactionCommitPrepared 
 * 
 * This is basically the same as RecordTransactionCommit (q.v. if you change 
 * this function): in particular, we must set the delayChkpt flag to avoid a 
 * race condition. 
 * 
 * We know the transaction made at least one XLOG entry (its PREPARE), 
 * so it is never possible to optimize out the commit record. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2152"></a><span class='Declare_Function'>RecordTransactionCommitPrepared</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN2153"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>nchildren</span><span class='Delimiter'>, 
</span><a name="LN2154"></a>                                <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>children</span><span class='Delimiter'>, 
</span><a name="LN2155"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>nrels</span><span class='Delimiter'>, 
</span><a name="LN2156"></a>                                <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rels</span><span class='Delimiter'>, 
</span><a name="LN2157"></a>                                <span class='Keyword'>int </span><span class='Declare_Parameter'>ninvalmsgs</span><span class='Delimiter'>, 
</span><a name="LN2158"></a>                                <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>invalmsgs</span><span class='Delimiter'>, 
</span><a name="LN2159"></a>                                <span class='Keyword'>bool </span><span class='Declare_Parameter'>initfileinval</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2161"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN2162"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>committs</span> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN2163"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replorigin</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Are we using the replication origins feature?  Or, in other words, are 
     * we replaying remote actions? 
     */ 
</span>    <a href="twophase.c.html#LN2163"><span class='Ref_To_Local'>replorigin</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a> <span class='Operator'>!= </span><a href="../../../include/replication/origin.h.html#LN33"><span class='Ref_to_Const'>InvalidRepOriginId</span></a> <span class='Operator'>&& 
</span>                  <a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a> <span class='Operator'>!= </span><a href="../../../include/replication/origin.h.html#LN34"><span class='Ref_to_Const'>DoNotReplicateId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See notes in RecordTransactionCommit */ 
</span>    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Emit the XLOG commit record. Note that we mark 2PC commits as 
     * potentially having AccessExclusiveLocks since we don't know whether or 
     * not they do. 
     */ 
</span>    <a href="twophase.c.html#LN2161"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN381"><span class='Ref_to_Proto'>XactLogCommitRecord</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2162"><span class='Ref_To_Local'>committs</span></a><span class='Delimiter'>, 
</span>                                 <a href="twophase.c.html#LN2153"><span class='Ref_to_Parameter'>nchildren</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2154"><span class='Ref_to_Parameter'>children</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2155"><span class='Ref_to_Parameter'>nrels</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2156"><span class='Ref_to_Parameter'>rels</span></a><span class='Delimiter'>, 
</span>                                 <a href="twophase.c.html#LN2157"><span class='Ref_to_Parameter'>ninvalmsgs</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2158"><span class='Ref_to_Parameter'>invalmsgs</span></a><span class='Delimiter'>, 
</span>                                 <a href="twophase.c.html#LN2159"><span class='Ref_to_Parameter'>initfileinval</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a> <span class='Operator'>| </span><a href="../../../include/access/xact.h.html#LN92"><span class='Ref_to_Const'>XACT_FLAGS_ACQUIREDACCESSEXCLUSIVELOCK</span></a><span class='Delimiter'>, 
</span>                                 <a href="twophase.c.html#LN2152"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2163"><span class='Ref_To_Local'>replorigin</span></a><span class='Parentheses'>) 
</span>        <span class='Comment_Multi_Line'>/* Move LSNs forward for this replication origin */ 
</span>        <a href="../../../include/replication/origin.h.html#LN54"><span class='Ref_to_Proto'>replorigin_session_advance</span></a><span class='Parentheses'>(</span><a href="../../replication/logical/origin.c.html#LN150"><span class='Ref_to_Global_Var'>replorigin_session_origin_lsn</span></a><span class='Delimiter'>, 
</span>                                   <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Record commit timestamp.  The value comes from plain commit timestamp 
     * if replorigin is not enabled, or replorigin already set a value for us 
     * in replorigin_session_origin_timestamp otherwise. 
     * 
     * We don't need to WAL-log anything here, as the commit record written 
     * above already contains the data. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN2163"><span class='Ref_To_Local'>replorigin</span></a> <span class='Operator'>|| </span><a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2162"><span class='Ref_To_Local'>committs</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/commit_ts.h.html#LN24"><span class='Ref_to_Proto'>TransactionTreeSetCommitTsData</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2152"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2153"><span class='Ref_to_Parameter'>nchildren</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2154"><span class='Ref_to_Parameter'>children</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't currently try to sleep before flush here ... nor is there any 
     * support for async commit of a prepared xact (the very idea is probably 
     * a contradiction) 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Flush XLOG to disk */ 
</span>    <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2161"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mark the transaction committed in pg_xact */ 
</span>    <a href="../../../include/access/transam.h.html#LN165"><span class='Ref_to_Proto'>TransactionIdCommitTree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2152"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2153"><span class='Ref_to_Parameter'>nchildren</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2154"><span class='Ref_to_Parameter'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Checkpoint can proceed now */ 
</span>    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Wait for synchronous replication, if required. 
     * 
     * Note that at this stage we have marked clog, but still show as running 
     * in the procarray and continue to hold locks. 
     */ 
</span>    <a href="../../../include/replication/syncrep.h.html#LN66"><span class='Ref_to_Proto'>SyncRepWaitForLSN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2161"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecordTransactionCommitPrepared &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  RecordTransactionAbortPrepared 
 * 
 * This is basically the same as RecordTransactionAbort. 
 * 
 * We know the transaction made at least one XLOG entry (its PREPARE), 
 * so it is never possible to optimize out the abort record. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2245"></a><span class='Declare_Function'>RecordTransactionAbortPrepared</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN2246"></a>                               <span class='Keyword'>int </span><span class='Declare_Parameter'>nchildren</span><span class='Delimiter'>, 
</span><a name="LN2247"></a>                               <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>children</span><span class='Delimiter'>, 
</span><a name="LN2248"></a>                               <span class='Keyword'>int </span><span class='Declare_Parameter'>nrels</span><span class='Delimiter'>, 
</span><a name="LN2249"></a>                               <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rels</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2251"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Catch the scenario where we aborted partway through 
     * RecordTransactionCommitPrepared ... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2245"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"cannot abort transaction %u, it was already committed"</span><span class='Delimiter'>, 
</span>             <a href="twophase.c.html#LN2245"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Emit the XLOG commit record. Note that we mark 2PC aborts as 
     * potentially having AccessExclusiveLocks since we don't know whether or 
     * not they do. 
     */ 
</span>    <a href="twophase.c.html#LN2251"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN389"><span class='Ref_to_Proto'>XactLogAbortRecord</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                <a href="twophase.c.html#LN2246"><span class='Ref_to_Parameter'>nchildren</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2247"><span class='Ref_to_Parameter'>children</span></a><span class='Delimiter'>, 
</span>                                <a href="twophase.c.html#LN2248"><span class='Ref_to_Parameter'>nrels</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2249"><span class='Ref_to_Parameter'>rels</span></a><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a> <span class='Operator'>| </span><a href="../../../include/access/xact.h.html#LN92"><span class='Ref_to_Const'>XACT_FLAGS_ACQUIREDACCESSEXCLUSIVELOCK</span></a><span class='Delimiter'>, 
</span>                                <a href="twophase.c.html#LN2245"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Always flush, since we're about to remove the 2PC state file */ 
</span>    <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2251"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the transaction aborted in clog.  This is not absolutely necessary 
     * but we may as well do it while we are here. 
     */ 
</span>    <a href="../../../include/access/transam.h.html#LN167"><span class='Ref_to_Proto'>TransactionIdAbortTree</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2245"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2246"><span class='Ref_to_Parameter'>nchildren</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2247"><span class='Ref_to_Parameter'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Wait for synchronous replication, if required. 
     * 
     * Note that at this stage we have marked clog, but still show as running 
     * in the procarray and continue to hold locks. 
     */ 
</span>    <a href="../../../include/replication/syncrep.h.html#LN66"><span class='Ref_to_Proto'>SyncRepWaitForLSN</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2251"><span class='Ref_To_Local'>recptr</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecordTransactionAbortPrepared &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PrepareRedoAdd 
 * 
 * Store pointers to the start/end of the WAL record along with the xid in 
 * a gxact entry in shared memory TwoPhaseState structure.  If caller 
 * specifies InvalidXLogRecPtr as WAL location to fetch the two-phase 
 * data, the entry is marked as located on disk. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2303"></a><span class='Declare_Function'>PrepareRedoAdd</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>start_lsn</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>end_lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2305"></a>    <a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN2303"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>; 
</span><a name="LN2306"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bufptr</span><span class='Delimiter'>; 
</span><a name="LN2307"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>gid</span><span class='Delimiter'>; 
</span><a name="LN2308"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN2306"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2303"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN902"><span class='Ref_to_Struct'>TwoPhaseFileHeader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2307"><span class='Ref_To_Local'>gid</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="twophase.c.html#LN2306"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reserve the GID for the given transaction in the redo code path. 
     * 
     * This creates a gxact struct and puts it into the active array. 
     * 
     * In redo, this struct is mainly used to track PREPARE/COMMIT entries in 
     * shared memory. Hence, we only fill up the bare minimum contents here. 
     * The gxact also gets marked with gxact-&GT;inredo set to true to indicate 
     * that it got added in the redo phase 
     */ 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Get a free gxact from the freelist */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"maximum number of prepared transactions reached"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Increase max_prepared_transactions (currently %d)."</span><span class='Delimiter'>, 
</span>                         <a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN185"><span class='Ref_to_Member'>freeGXacts</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN154"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN157"><span class='Ref_to_Member'>prepared_at</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2305"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN908"><span class='Ref_to_Member'>prepared_at</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN166"><span class='Ref_to_Member'>prepare_start_lsn</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2303"><span class='Ref_to_Parameter'>start_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN167"><span class='Ref_to_Member'>prepare_end_lsn</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2303"><span class='Ref_to_Parameter'>end_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2305"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN906"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN170"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN2305"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN909"><span class='Ref_to_Member'>owner</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN171"><span class='Ref_to_Member'>locking_backend</span></a> <span class='Operator'>= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN172"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2303"><span class='Ref_to_Parameter'>start_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* yes, added in redo */ 
</span>    <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN175"><span class='Ref_to_Member'>gid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2307"><span class='Ref_To_Local'>gid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And insert it into the active array */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Adding 2PC data to shared memory %u"</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN2308"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrepareRedoAdd &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PrepareRedoRemove 
 * 
 * Remove the corresponding gxact entry from TwoPhaseState. Also 
 * remove the 2PC file if a prepared transaction was saved via 
 * an earlier checkpoint. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2365"></a><span class='Declare_Function'>PrepareRedoRemove</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>giveWarning</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2367"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2368"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2369"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="twophase.c.html#LN2368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN188"><span class='Ref_to_Member'>numPrepXacts</span></a><span class='Delimiter'>; </span><a href="twophase.c.html#LN2368"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="twophase.c.html#LN2367"><span class='Ref_To_Local'>gxact</span></a> <span class='Operator'>= </span><a href="twophase.c.html#LN194"><span class='Ref_to_Global_Var'>TwoPhaseState</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN191"><span class='Ref_to_Member'>prepXacts</span></a><span class='Delimiter'>[</span><a href="twophase.c.html#LN2368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2367"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN168"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>== </span><a href="twophase.c.html#LN2365"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="twophase.c.html#LN2367"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN174"><span class='Ref_to_Member'>inredo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="twophase.c.html#LN2369"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TwoPhaseStateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Just leave if there is nothing, this is expected during WAL replay. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="twophase.c.html#LN2369"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And now we can clean up any files we may have left. 
     */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"Removing 2PC data from shared memory %u"</span><span class='Delimiter'>, </span><a href="twophase.c.html#LN2365"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="twophase.c.html#LN2367"><span class='Ref_To_Local'>gxact</span></a><span class='Operator'>-&GT;</span><a href="twophase.c.html#LN173"><span class='Ref_to_Member'>ondisk</span></a><span class='Parentheses'>) 
</span>        <a href="twophase.c.html#LN227"><span class='Ref_to_Proto'>RemoveTwoPhaseFile</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2365"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="twophase.c.html#LN2365"><span class='Ref_to_Parameter'>giveWarning</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="twophase.c.html#LN218"><span class='Ref_to_Proto'>RemoveGXact</span></a><span class='Parentheses'>(</span><a href="twophase.c.html#LN2367"><span class='Ref_To_Local'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrepareRedoRemove &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>